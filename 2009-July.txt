From vafa at mail.berlios.de  Fri Jul  3 06:42:21 2009
From: vafa at mail.berlios.de (vafa at mail.berlios.de)
Date: Fri, 3 Jul 2009 06:42:21 +0200
Subject: [Xepersian-development] r78 - trunk
Message-ID: <200907030442.n634gLaF014050@sheep.berlios.de>

Author: vafa
Date: 2009-07-03 06:41:39 +0200 (Fri, 03 Jul 2009)
New Revision: 78

Added:
   trunk/ftxe-0.9.py
Removed:
   trunk/ftxe-0.8.py
Log:
new version of farsitex-unicode Per Mostafa

Deleted: trunk/ftxe-0.8.py
===================================================================
--- trunk/ftxe-0.8.py	2009-06-27 01:36:36 UTC (rev 77)
+++ trunk/ftxe-0.8.py	2009-07-03 04:41:39 UTC (rev 78)
@@ -1,980 +0,0 @@
-?#########################################
-#       General Public License          #
-#       Author:  Mostafa Vahedi         #
-#       Date:    26 June 2009           #
-#       Version  0.8                    #
-#########################################
-
-import codecs
-
-import sys
-import os
-
-ft_numerical = [
-chr(0xB9),	# 	Arabic Thoushads Seperator
-chr(0xBC)	#	ARABIC DECIMAL SEPARATOR
-]
-
-
-ft_vowels = [
-chr(0xB0),	#	ARABIC FATHA
-chr(0xB1),	#	ARABIC KASRA
-chr(0xB2),	#	ARABIC DAMMA
-chr(0xB3),	#	ARABIC FATHATAN
-chr(0xB4),	#	ARABIC SHADDA
-chr(0xBA),	#	ARABIC LETTER SUPERSCRIPT ALEF
-chr(0xBB),	#	ARABIC HAMZA ABOVE
-chr(0xC4) 	#	ARABIC SUKUN
-]
-
-ft_non_joiners = [
-chr(0x8F)	#	ARABIC LETTER HAMZA
-]
-
-ft_bidi_joiners_initial = [
-chr(0xE4),	#	ARABIC LETTER AIN, initial form
-chr(0xE8),	#	ARABIC LETTER GHAIN, initial form
-chr(0xFB) 	#	ARABIC LETTER HEH, initial form
-]
-
-ft_bidi_joiners_medial = [
-chr(0xE3),	#	ARABIC LETTER AIN, medial form
-chr(0xE7),	#	ARABIC LETTER GHAIN, medial form
-chr(0xFA) 	#	ARABIC LETTER HEH, medial form
-]
-
-ft_bidi_joiners_final = [
-chr(0xE2),	#	ARABIC LETTER AIN, final form
-chr(0xE6),	#	ARABIC LETTER GHAIN, final form
-chr(0xFC) 	#	ARABIC LETTER FARSI YEH, final form
-]
-
-ft_bidi_joiners_isolated = [
-chr(0xE1),	#	ARABIC LETTER AIN, isolated form
-chr(0xE5),	#	ARABIC LETTER GHAIN, isolated form
-chr(0xFD) 	#	ARABIC LETTER FARSI YEH, isolated form
-]
-
-ft_bidi_joiners_initial_medial = [
-chr(0x8B),	#	ARABIC TATWEEL
-chr(0x8E),	#	ARABIC LETTER YEH WITH HAMZA ABOVE, initial-medial form
-chr(0x93),	#	ARABIC LETTER BEH, initial-medial form
-chr(0x95),	#	ARABIC LETTER PEH, initial-medial form
-chr(0x97),	#	ARABIC LETTER TEH, initial-medial form
-chr(0x99),	#	ARABIC LETTER THEH, initial-medial form
-chr(0x9B),	#	ARABIC LETTER JEEM, initial-medial form
-chr(0x9D),	#	ARABIC LETTER TCHEH, initial-medial form
-chr(0x9F),	#	ARABIC LETTER HAH, initial-medial form
-chr(0xA1),	#	ARABIC LETTER KHAH, initial-medial form
-chr(0xA8),	#	ARABIC LETTER SEEN, initial-medial form
-chr(0xAA),	#	ARABIC LETTER SHEEN, initial-medial form
-chr(0xAC),	#	ARABIC LETTER SAD, initial-medial form
-chr(0xAE),	#	ARABIC LETTER DAD, initial-medial form
-chr(0xAF),	#	ARABIC LETTER TAH, initial-medial form
-chr(0xE0),	#	ARABIC LETTER ZAH, initial-medial form
-chr(0xEA),	#	ARABIC LETTER FEH, initial-medial form
-chr(0xEC),	#	ARABIC LETTER QAF, initial-medial form
-chr(0xEE),	#	ARABIC LETTER KEHEH, initial-medial form
-chr(0xF0),	#	ARABIC LETTER GAF, initial-medial form
-chr(0xF3),	#	ARABIC LETTER LAM, initial-medial form
-chr(0xF5),	#	ARABIC LETTER MEEM, initial-medial form
-chr(0xF7),	#	ARABIC LETTER NOON, initial-medial form
-chr(0xFE)	#	ARABIC LETTER FARSI YEH, initial-medial form
-]
-
-ft_bidi_joiners_final_isolated = [
-chr(0x92),	#	ARABIC LETTER BEH, final-isolated form
-chr(0x94),	#	ARABIC LETTER PEH, final-isolated form
-chr(0x96),	#	ARABIC LETTER TEH, final-isolated form
-chr(0x98),	#	ARABIC LETTER THEH, final-isolated form
-chr(0x9A),	#	ARABIC LETTER JEEM, final-isolated form
-chr(0x9C),	#	ARABIC LETTER TCHEH, final-isolated form
-chr(0x9E),	#	ARABIC LETTER HAH, final-isolated form
-chr(0xA0),	#	ARABIC LETTER KHAH, final-isolated form
-chr(0xA7),	#	ARABIC LETTER SEEN, final-isolated form
-chr(0xA9),	#	ARABIC LETTER SHEEN, final-isolated form
-chr(0xAB),	#	ARABIC LETTER SAD, final-isolated form
-chr(0xAD),	#	ARABIC LETTER DAD, final-isolated form
-chr(0xC1),	#	ARABIC LETTER TAH, final-isolated form
-chr(0xC2),	#	ARABIC LETTER ZAH, final-isolated form
-chr(0xE9),	#	ARABIC LETTER FEH, final-isolated form
-chr(0xEB),	#	ARABIC LETTER QAF, final-isolated form
-chr(0xED),	#	ARABIC LETTER KEHEH, final-isolated form
-chr(0xEF),	#	ARABIC LETTER GAF, final-isolated form
-chr(0xF1),	#	ARABIC LETTER LAM, final-isolated form
-chr(0xF4),	#	ARABIC LETTER MEEM, final-isolated form
-chr(0xF6),	#	ARABIC LETTER NOON, final-isolated form
-chr(0xF9) 	#	ARABIC LETTER HEH, final-isolated form
-]
-
-ft_right_joiners_final = [
-chr(0x91)	#	ARABIC LETTER ALEF, final form
-]
-
-ft_right_joiners_isolated = [
-chr(0x8D),	#	ARABIC LETTER ALEF WITH MADDA ABOVE, isolated form
-chr(0x90)	#	ARABIC LETTER ALEF, isolated form
-]
-
-ft_right_joiners_final_isolated = [
-chr(0xA2),	#	ARABIC LETTER DAL
-chr(0xA3),	#	ARABIC LETTER THAL
-chr(0xA4),	#	ARABIC LETTER REH
-chr(0xA5),	#	ARABIC LETTER ZAIN
-chr(0xA6),	#	ARABIC LETTER JEH
-chr(0xBF),	#	ARABIC LETTER TEH MARBUTAH
-chr(0xF2),	#	ARABIC LIGATURE LAM WITH ALEF
-chr(0xF8)	#	ARABIC LETTER WAW
-]
-
-
-table_FT_UN = {
-chr(0x80) : [u'\u06F0'],	#	EXTENDED ARABIC-INDIC DIGIT ZERO
-chr(0x81) : [u'\u06F1'],	#	EXTENDED ARABIC-INDIC DIGIT ONE
-chr(0x82) : [u'\u06F2'],	#	EXTENDED ARABIC-INDIC DIGIT TWO
-chr(0x83) : [u'\u06F3'],	#	EXTENDED ARABIC-INDIC DIGIT THREE
-chr(0x84) : [u'\u06F4'],	#	EXTENDED ARABIC-INDIC DIGIT FOUR
-chr(0x85) : [u'\u06F5'],	#	EXTENDED ARABIC-INDIC DIGIT FIVE
-chr(0x86) : [u'\u06F6'],	#	EXTENDED ARABIC-INDIC DIGIT SIX
-chr(0x87) : [u'\u06F7'],	#	EXTENDED ARABIC-INDIC DIGIT SEVEN
-chr(0x88) : [u'\u06F8'],	#	EXTENDED ARABIC-INDIC DIGIT EIGHT
-chr(0x89) : [u'\u06F9'],	#	EXTENDED ARABIC-INDIC DIGIT NINE
-chr(0x8A) : [u'\u060C'],	#	ARABIC COMMA
-chr(0x8B) : [u'\u0640'],	#	ARABIC TATWEEL
-chr(0x8C) : [u'\u061F'],	#	ARABIC QUESTION MARK
-chr(0x8D) : [u'\u0622'],	#	ARABIC LETTER ALEF WITH MADDA ABOVE, isolated form
-chr(0x8E) : [u'\u0626'],	#	ARABIC LETTER YEH WITH HAMZA ABOVE, initial-medial form
-chr(0x8F) : [u'\u0621'],	#	ARABIC LETTER HAMZA
-chr(0x90) : [u'\u0627'],	#	ARABIC LETTER ALEF, isolated form
-chr(0x91) : [u'\u0627'],	#	ARABIC LETTER ALEF, final form
-chr(0x92) : [u'\u0628'],	#	ARABIC LETTER BEH, final-isolated form
-chr(0x93) : [u'\u0628'],	#	ARABIC LETTER BEH, initial-medial form
-chr(0x94) : [u'\u067E'],	#	ARABIC LETTER PEH, final-isolated form
-chr(0x95) : [u'\u067E'],	#	ARABIC LETTER PEH, initial-medial form
-chr(0x96) : [u'\u062A'],	#	ARABIC LETTER TEH, final-isolated form
-chr(0x97) : [u'\u062A'],	#	ARABIC LETTER TEH, initial-medial form
-chr(0x98) : [u'\u062B'],	#	ARABIC LETTER THEH, final-isolated form
-chr(0x99) : [u'\u062B'],	#	ARABIC LETTER THEH, initial-medial form
-chr(0x9A) : [u'\u062C'],	#	ARABIC LETTER JEEM, final-isolated form
-chr(0x9B) : [u'\u062C'],	#	ARABIC LETTER JEEM, initial-medial form
-chr(0x9C) : [u'\u0686'],	#	ARABIC LETTER TCHEH, final-isolated form
-chr(0x9D) : [u'\u0686'],	#	ARABIC LETTER TCHEH, initial-medial form
-chr(0x9E) : [u'\u062D'],	#	ARABIC LETTER HAH, final-isolated form
-chr(0x9F) : [u'\u062D'],	#	ARABIC LETTER HAH, initial-medial form
-chr(0xA0) : [u'\u062E'],	#	ARABIC LETTER KHAH, final-isolated form
-chr(0xA1) : [u'\u062E'],	#	ARABIC LETTER KHAH, initial-medial form
-chr(0xA2) : [u'\u062F'],	#	ARABIC LETTER DAL
-chr(0xA3) : [u'\u0630'],	#	ARABIC LETTER THAL
-chr(0xA4) : [u'\u0631'],	#	ARABIC LETTER REH
-chr(0xA5) : [u'\u0632'],	#	ARABIC LETTER ZAIN
-chr(0xA6) : [u'\u0698'],	#	ARABIC LETTER JEH
-chr(0xA7) : [u'\u0633'],	#	ARABIC LETTER SEEN, final-isolated form
-chr(0xA8) : [u'\u0633'],	#	ARABIC LETTER SEEN, initial-medial form
-chr(0xA9) : [u'\u0634'],	#	ARABIC LETTER SHEEN, final-isolated form
-chr(0xAA) : [u'\u0634'],	#	ARABIC LETTER SHEEN, initial-medial form
-chr(0xAB) : [u'\u0635'],	#	ARABIC LETTER SAD, final-isolated form
-chr(0xAC) : [u'\u0635'],	#	ARABIC LETTER SAD, initial-medial form
-chr(0xAD) : [u'\u0636'],	#	ARABIC LETTER DAD, final-isolated form
-chr(0xAE) : [u'\u0636'],	#	ARABIC LETTER DAD, initial-medial form
-chr(0xAF) : [u'\u0637'],	#	ARABIC LETTER TAH, initial-medial form
-chr(0xB0) : [u'\u064E'],	#	ARABIC FATHA
-chr(0xB1) : [u'\u0650'],	#	ARABIC KASRA
-chr(0xB2) : [u'\u064F'],	#	ARABIC DAMMA
-chr(0xB3) : [u'\u064B'],	#	ARABIC FATHATAN
-chr(0xB4) : [u'\u0651'],	#	ARABIC SHADDA
-chr(0xB5) : [u'\u0023'],	# * #
-chr(0xB6) : [u'\u0024'],	# * $
-chr(0xB7) : [u'\u0025'],	# * %
-chr(0xB8) : [u'\u0026'],	# * &
-chr(0xB9) : [u'\u066C'],	# 	Arabic Thoushads Seperator
-chr(0xBA) : [u'\u0670'],	#	ARABIC LETTER SUPERSCRIPT ALEF
-chr(0xBB) : [u'\u0654'],	#	ARABIC HAMZA ABOVE
-chr(0xBC) : [u'\u066B'],	#	ARABIC DECIMAL SEPARATOR
-chr(0xBD) : [u'\u0029'],	# * RIGHT PARENTHESIS
-chr(0xBE) : [u'\u0028'],	# * LEFT PARENTHESIS
-chr(0xBF) : [u'\u0629'],	#	ARABIC LETTER TEH MARBUTAH
-chr(0xC0) : [u'\u00BB'],	#	RIGHT-POINTING DOUBLE ANGLE QUOTATION MARK
-chr(0xC1) : [u'\u0637'],	#	ARABIC LETTER TAH, final-isolated form
-chr(0xC2) : [u'\u0638'],	#	ARABIC LETTER ZAH, final-isolated form
-chr(0xC3) : [u'\u00AB'],	#	LEFT-POINTING DOUBLE ANGLE QUOTATION MARK
-chr(0xC4) : [u'\u0652'],	#	ARABIC SUKUN
-chr(0xC5) : [u'\u002D'],	# * -
-chr(0xC6) : [u'\u002E'],	# * FULL STOP
-chr(0xC7) : [u'\u002F'],	# * /
-chr(0xC8) : [u'\u002A'],	# * *
-chr(0xC9) : [u'\u007E'],	# * ~
-chr(0xCA) : [u'\u003A'],	# * COLON
-chr(0xCB) : [u'\u061B'],	# 	ARABIC SEMICOLON
-chr(0xCC) : [u'\u003E'],	# * GREATER-THAN SIGN
-chr(0xCD) : [u'\u002B'],	# * +
-chr(0xCE) : [u'\u003D'],	# * =
-chr(0xCF) : [u'\u003C'],	# * LESS-THAN SIGN
-# chr(0xD0) : [u'\u0040'],	# * @
-chr(0xD0) : [u''],	        # * @
-chr(0xD1) : [u'\u005D'],	# * [
-chr(0xD2) : [u'\u005C'],	# * \
-chr(0xD3) : [u'\u005B'],	# * ]
-chr(0xD4) : [u'\u005E'],	# * ^
-chr(0xD5) : [u'\u005F'],	# * _
-chr(0xD6) : [u'\u0060'],	# * `
-chr(0xD7) : [u'\u007D'],	# * {
-chr(0xD8) : [u'\u007C'],	# * |
-chr(0xDA) : [u'\u0020'],	# * SPACE
-chr(0xDD) : [u'\u0021'],	# * EXCLAMATION MARK
-chr(0xDE) : [u'\u007B'],	# * }
-chr(0xE0) : [u'\u0638'],	#	ARABIC LETTER ZAH, initial-medial form
-chr(0xE1) : [u'\u0639'],	#	ARABIC LETTER AIN, isolated form
-chr(0xE2) : [u'\u0639'],	#	ARABIC LETTER AIN, final form
-chr(0xE3) : [u'\u0639'],	#	ARABIC LETTER AIN, medial form
-chr(0xE4) : [u'\u0639'],	#	ARABIC LETTER AIN, initial form
-chr(0xE5) : [u'\u063A'],	#	ARABIC LETTER GHAIN, isolated form
-chr(0xE6) : [u'\u063A'],	#	ARABIC LETTER GHAIN, final form
-chr(0xE7) : [u'\u063A'],	#	ARABIC LETTER GHAIN, medial form
-chr(0xE8) : [u'\u063A'],	#	ARABIC LETTER GHAIN, initial form
-chr(0xE9) : [u'\u0641'],	#	ARABIC LETTER FEH, final-isolated form
-chr(0xEA) : [u'\u0641'],	#	ARABIC LETTER FEH, initial-medial form
-chr(0xEB) : [u'\u0642'],	#	ARABIC LETTER QAF, final-isolated form
-chr(0xEC) : [u'\u0642'],	#	ARABIC LETTER QAF, initial-medial form
-chr(0xED) : [u'\u06A9'],	#	ARABIC LETTER KEHEH, final-isolated form
-chr(0xEE) : [u'\u06A9'],	#	ARABIC LETTER KEHEH, initial-medial form
-chr(0xEF) : [u'\u06AF'],	#	ARABIC LETTER GAF, final-isolated form
-chr(0xF0) : [u'\u06AF'],	#	ARABIC LETTER GAF, initial-medial form
-chr(0xF1) : [u'\u0644'],	#	ARABIC LETTER LAM, final-isolated form
-chr(0xF2) : [u'\u0644\u0627'],	#	ARABIC LIGATURE LAM WITH ALEF
-chr(0xF3) : [u'\u0644'],	#	ARABIC LETTER LAM, initial-medial form
-chr(0xF4) : [u'\u0645'],	#	ARABIC LETTER MEEM, final-isolated form
-chr(0xF5) : [u'\u0645'],	#	ARABIC LETTER MEEM, initial-medial form
-chr(0xF6) : [u'\u0646'],	#	ARABIC LETTER NOON, final-isolated form
-chr(0xF7) : [u'\u0646'],	#	ARABIC LETTER NOON, initial-medial form
-chr(0xF8) : [u'\u0648'],	#	ARABIC LETTER WAW
-chr(0xF9) : [u'\u0647'],	#	ARABIC LETTER HEH, final-isolated form
-chr(0xFA) : [u'\u0647'],	#	ARABIC LETTER HEH, medial form
-chr(0xFB) : [u'\u0647'],	#	ARABIC LETTER HEH, initial form
-chr(0xFC) : [u'\u06CC'],	#	ARABIC LETTER FARSI YEH, final form
-chr(0xFD) : [u'\u06CC'],	#	ARABIC LETTER FARSI YEH, isolated form
-chr(0xFE) : [u'\u06CC']		#	ARABIC LETTER FARSI YEH, initial-medial form
-}
-
-F_SLASH = chr(0xD2)
-F_PRNT_OPEN = chr(0xDE)
-F_PRNT_CLOSE = chr(0xD7)
-F_AT_SIGN = chr(0xD0)
-F_PERCENT_SIGN = chr(0xB7)
-
-# latex and farsitex commands whose first parameter does not need \lr{...}
-commands = [ "begin", 
-"end",
-"input", "include", "includeonly",
-"hspace", "vspace", "hspace*", "vspace*",
-"label", "ref", "cite", "bibitem",
-"bibliographystyle",
-"parbox",
-"newenvironment", "newtheorem",
-"persianmathdigitsfamily",
-"fontfamily", "fontseries", "fontshape",
-"rmdefault", "sfdefault", "ttdefault",
-"bfdefault", "itdefault", "sldefault", "scdefault",
-"pagenumbering", "pagestyle", "thispagestyle",
-"setcounter", "stepcounter", "setlength", "addtolength"
-]
-
-
-def ft_is_numeric(ch):
-	if ((ch in ft_numerical) or 
-	    ((ch >= chr(0x80)) and (ch <= chr(0x89))) ):
-		return 1
-	return 0
-
-def ft_can_join_left(ch):
-	if ((ch in ft_bidi_joiners_initial) or
-	    (ch in ft_bidi_joiners_medial) or
-	    (ch in ft_bidi_joiners_final) or
-	    (ch in ft_bidi_joiners_isolated) or
-	    (ch in ft_bidi_joiners_initial_medial) or
-	    (ch in ft_bidi_joiners_final_isolated)):
-    		return 1
-	return 0
-
-def ft_can_join_right(ch):
-	if (ft_can_join_left(ch) or 
-	    (ch in ft_right_joiners_final) or
-	    (ch in ft_right_joiners_isolated) or
-	    (ch in ft_right_joiners_final_isolated)):
-		return 1
-	return 0
-
-def ft_joining_left(ch):
-	if ((ch in ft_bidi_joiners_initial) or 
-	    (ch in ft_bidi_joiners_medial) or
-	    (ch in ft_bidi_joiners_initial_medial)):
-		return 1
-	return 0
-
-
-def ft_joining_right(ch):
-	if ((ch in ft_right_joiners_final) or
-	    (ch in ft_bidi_joiners_medial) or 
-	    (ch in ft_bidi_joiners_final)):
-		return 1
-	return 0
-
-def ft_not_right_joined(ch):
-	if ((ch in ft_bidi_joiners_initial) or
-	    (ch in ft_right_joiners_isolated) or
-	    (ch in ft_bidi_joiners_isolated)):
-		return 1
-	return 0
-
-def ft_adjust_shaping(text, i):
-	current = text[i]
-	u = u''
-	try:
-		u = table_FT_UN[current][0]
-	except KeyError:
-		return u''
-
-	#if you don't want shaping remove the following comment
-	#return u
-
-	if ((current in ft_vowels) or (ft_is_numeric(current))):
-		return u
-
-	#find next non-vowel character on the left
-	text_len = len(text)
-	next_index = i+1
-	while ((next_index < text_len) and (text[next_index] in ft_vowels)):
-		next_index += 1
-
-	if (next_index == text_len):
-		next = ''
-	else:
-		next = text[next_index]
-
-	# if current letter is joining from left but next letter is or can not joining
-	if (ft_joining_left(current)):
-		if (not ft_can_join_right(next)):
-			u += u'\u200D' #ZWJ
-		elif (ft_not_right_joined(next)):
-			u += u'\u200D\u200C' #ZWJ+ZWNJ
-	# if current letter can join but next letter is joining from right
-	elif (ft_can_join_left(current)):
-		if (ft_joining_right(next)):
-			u += u'\u200C\u200D' #ZWNJ+ZWJ
-		elif (ft_can_join_right(next)):
-			u += u'\u200C' #ZWNJ
-	return u
-
-def ft_adjust_number(text):
-	result = u''
-	i = len(text)-1
-	while (i >= 0):
-		result += ft_adjust_shaping(text, i)
-		i -= 1
-	return result
-
-
-def map_ft_unicode(text):
-	mapped_text = u''
-
-	i = 0
-	while (i < len(text)):
-		if (ft_is_numeric(text[i])):
-			next_index = i
-			while ((next_index+1 < len(text)) and
-			       (ft_is_numeric(text[next_index+1]))):
-				next_index += 1
-			mapped_text += ft_adjust_number(text[i:next_index+1])
-			i = next_index+1
-			continue
-
-		mapped_text += ft_adjust_shaping(text, i)
-		i += 1
-	return mapped_text
-
-# Finds next token all of the same language
-def ft_next_part(line, i, line_len):
-	global global_state
-	global recursive
-	global filenames
-	
-	j = i
-	language_flag = (line[j]<chr(0x80))
-	while ((j<line_len) and ((line[j]<chr(0x80)) == language_flag) ):
-		if ( (global_state == 0) and ( (line[j] == '%') or (line[j] == F_PERCENT_SIGN) ) and (line[j-1] != '\\') and (line[j-1] != F_SLASH) ):
-			global_state = 1
-		elif ((global_state == 0) and ((line[j:j+16] == '\\begin{verbatim}') or (line[j:j+17] == '\\begin{verbatim*}'))):
-			global_state = 2
-		elif ((global_state == 2) and ((line[j:j+14] == '\\end{verbatim}') or (line[j:j+15] == '\\end{verbatim*}'))):
-			global_state = 0
-		elif ((global_state == 0) and (line[j:j+6] == '\\verb*')):
-			next_index = line.find(line[j+6], j+7)
-			j = next_index
-		elif ((global_state == 0) and (line[j:j+5] == '\\verb')):
-			next_index = line.find(line[j+5], j+6)
-			j = next_index
-		elif (recursive == 1):
-			if ((global_state == 0) and (line[j:j+9] == '\\include{')):
-				next_index = line.find('}', j+9)
-				filename = line[j+10:next_index-1] + '.ftx'
-				if (os.path.exists(filename) and not filename in filenames):
-					filenames.append(filename)
-			elif ((global_state == 0) and (line[j:j+7] == '\\input{')):
-				next_index = line.find('}', j+7)
-				filename = line[j+8:next_index-1] + '.ftx'
-				if (os.path.exists(filename) and not filename in filenames):
-					filenames.append(filename)
-			elif ((global_state == 0) and (line[j:j+9] == F_SLASH + 'include' + F_PRNT_OPEN)):
-				next_index = line.find(F_PRNT_CLOSE, j+9)
-				if (line[j+9]!=F_AT_SIGN):
-					filename = line[j+9:next_index] + '.ftx'
-				else:
-					filename = line[j+10:next_index-1] + '.ftx'
-				if (os.path.exists(filename) and not filename in filenames):
-					filenames.append(filename)
-			elif ((global_state == 0) and (line[j:j+7] == F_SLASH + 'input' + F_PRNT_OPEN)):
-				next_index = line.find(F_PRNT_CLOSE, j+7)
-				if (line[j+7]!=F_AT_SIGN):
-					filename = line[j+7:next_index] + '.ftx'
-				else:
-					filename = line[j+8:next_index-1] + '.ftx'
-				if (os.path.exists(filename) and not filename in filenames):
-					filenames.append(filename)
-		j += 1
-	return j
-
-###############################################
-# from here all functions are used to translate
-# farsitex commands to xepersian commands
-###############################################
-
-def read_size(input,index,last_index):
-	dim_index = -1 
-	inch_index = input.find(u'in', index)
-	if (inch_index != -1):
-		dim_index = inch_index
-	mm_index = input.find(u'mm', index)
-	if (mm_index != -1):
-		if (dim_index == -1 or mm_index < index):
-			dim_index = mm_index
-	cm_index = input.find(u'cm', index)
-	if (cm_index != -1):
-		if (dim_index == -1 or cm_index < dim_index):
-			dim_index = cm_index
-	pt_index = input.find(u'pt', index)
-	if (pt_index != -1):
-		if (dim_index == -1 or pt_index < dim_index):
-			dim_index = pt_index
-	next_cmd = input.find(u'\\', index)
-	if (next_cmd == -1 and dim_index == -1):
-		print "Error in parsing \epsfxsize command at " + str(line_number) + "\n"
-		return -1
-	elif (next_cmd == -1 or (dim_index != -1 and next_cmd > dim_index)):
-		epsfxsize = input[index:dim_index+2]
-		return dim_index+2
-	elif (next_cmd != -1):
-		end_cmd = next_cmd+1
-		while (end_cmd < last_index and input[end_cmd].isalpha()):
-			end_cmd += 1
-		return end_cmd
-	else:
-		print "Error in parsing \epsfxsize command at " + str(line_number) + "\n"
-		return -1
-
-
-latex_options=[u'a4paper', u'a5paper', u'b5paper', 
-			   u'letterpaper', u'legalpaper', u'executivepaper', 
-			   u'landscape', u'10pt', u'11pt', u'12pt', 
-			   u'oneside', u'twoside', u'draft', 
-			   u'final', u'titlepage', u'notitlepage',
-			   u'onecolumn', u'twocolumn',
-			   u'leqno', u'fleqn']
-
-table_eq_packages = {
-u'poem'     : u'persianpoem',
-u'fmakeidx' : u'makeidx',
-u'ffancyhe' : u'fancyhdr',
-u'fmultico' : u'multicol'
-}
-
-farsitex_ignore_options = [u'persian', u'farsi', u'epsf', u'fgraphix', u'lotusfont']
-
-xepersian_packages = u'\n\\usepackage{url}\n\\usepackage{fancyvrb}\n\\usepackage{setspace}\\doublespace\n\\usepackage{graphicx}\n\\usepackage{amssymb}\n'
-xepersian_preamble = u'\\settextfont[Scale=1.2]{XB Zar}\n\\setlatintextfont[Scale=1.1]{Times New Roman}\n\\setdigitfont{XB Zar}\n\\let\\iranic\\it\n\\let\\siah\\bf\n\\let\\khabide\\sl\n\\def\\siahir{\\siah\\iranic}\n\\def\\siahkh{\\siah\\khabide}\n\\setpookfont{XB Kayhan Pook}\\let\\tookhali\\pookfamily\n\\setsayehfont{XB Kayhan Sayeh}\\let\\sayedar\\sayehfamily\n\\let\\farsi\\Persian\n\\let\\english\\Latin \n\\let\\farmbox\\mbox\n\\newcommand{\\ftxepmatrix}[1]{\\begin{pmatrix}#1\\end{pmatrix}}\n\\def\\FarsiTeX{\\lr{FarsiTeX}}\n\\def\\????????{\\rl{?????????}} \n\\let\\englishtitle\\latintitle\n\\let\\englishauthor\\latinauthor\n\\let\\englishdegree\\latindegree\n\\let\\englishthesisdate\\latinthesisdate \n\\let\\englishsupervisor\\latinsupervisor\n\\let\\englishdepartment\\latindepartment\n\\let\\makeenglishtitle\\makelatintitle \n\\let\\englishkeywords\\latinkeywords\n\\newenvironment{englishabstract}{\\begin{latinabstract}}{\\end{latinabstract}}\n \\u!
 niversity{\lr{University Name}} \n\\city{\lr{City Name}}\n\\latinuniversity{University Name}\n\\latincity{City Name}\n'
-
-def is_alpha_numeric_space(input):
-	input_len = len(input)
-	i = 0
-	while (i<input_len):
-		if (not (input[i].isalpha() or input[i].isdigit() or input[i]==u'.' or input[i]==u' ') ):
-			return 0
-		i+=1
-	return 1
-
-def is_alpha_numeric(input):
-	input_len = len(input)
-	i = 0
-	while (i<input_len):
-		if (not (input[i].isalpha() or input[i].isdigit() or input[i]=='.') ):
-			return 0
-		i+=1
-	return 1
-			
-def find_eq_cmd(keyword):
-	try:
-		eq_cmd = table_eq_packages[keyword]
-	except KeyError:
-		eq_cmd = u''
-	return eq_cmd
-
-def convert_persian_to_english(num):
-	result = u''
-	num_len = len(num)
-	index = 0
-	while (index < num_len):
-		if (ord(num[index]) >= ord(u'?') and ord(num[index]) <= ord(u'?')):
-			result += unichr(ord(num[index]) - ord(u'?') + ord(u'0'))
-		else:
-			result += num[index]
-		index += 1
-	return result
-
-def generate_farsitex_cmds_file(helper_filename,preamble):
-	try:
-		of = codecs.open(helper_filename, encoding='utf-8', mode='w')
-	except IOError:
-		print "Can not open the output file: " + helper_filename
-		exit(0)
-	of.write(preamble)
-	of.close
-
-
-# \verb|| -> \item[\verb||] or \section{\verb||}
-# \kasre{} \alef{} ...
-def translate_cmds(output_line):
-	global last_epsfxsize
-	global last_epsfxsize_line
-	global last_epsfysize
-	global last_epsfysize_line
-	global state
-	global filename
-
-	result = u''
-	line_len = len(output_line)
-	index = 0
-	if (state == 1): #\begin{verbatim}
-		end_verbatim = output_line.find('\\end{verbatim}')
-		if (end_verbatim == -1):
-			return output_line
-		result += output_line[0:end_verbatim+14]
-		index = end_verbatim+14
-		state = 0
-	elif (state == 2): #\begin{verbatim*}
-		end_verbatim = output_line.find('\\end{verbatim*}')
-		if (end_verbatim == -1):
-			return output_line
-		result += output_line[0:end_verbatim+15]
-		index = end_verbatim+15
-		state = 0
-	elif (output_line[0:14] == "\\documentstyle"):
-		result += u'\\documentclass'
-		#process options
-		last_index = output_line.find(u']')
-		index = 15
-		first_option = 1
-		preamble = xepersian_preamble
-		packages = xepersian_packages
-		document_class = u''
-		while (index < last_index):
-			next_comma = output_line.find(u',',index,last_index)
-			if (next_comma == -1):
-				next_comma = last_index
-			first_of_option = index
-			while (output_line[first_of_option] == u' '):
-				first_of_option += 1
-			end_of_option = next_comma
-			while (output_line[end_of_option-1] == u' '):
-				end_of_option -= 1
-			option = output_line[first_of_option:end_of_option]
-			index = next_comma+1
-			eq_cmd = find_eq_cmd(option)
-			if (eq_cmd != u''):
-				packages += u'\\usepackage{' + eq_cmd + u'}\n'
-				continue
-			elif (option in farsitex_ignore_options):
-				continue
-			elif (option == u'sharifth'):
-				document_class = u'xepersian-thesis'
-				continue
-			elif (not option in latex_options):
-				packages += u'\\usepackage{' + option + u'}\n'
-				continue
-	
-			if (first_option):
-				result += u'['
-			else:
-				result += u','
-			result += option
-			first_option = 0
-		#end while
-		if (not first_option):
-			result += u']'
-		index = output_line.find(u'}',last_index)
-		if (document_class == u''):
-			result += output_line[last_index+1:index+1]
-		else:
-			result += u'{' + document_class + u'}'
-		# I assume that nothing important is after
-		# \documentstyle[]{}, otherwise it may conflict
-		# with our preamble
-		if (index != -1):
-			result += output_line[index+1:]
-		result += packages + u'\\usepackage{xepersian}\n'
-		helper_filename = filename + '_farsitex_cmds_xepersian.tex'
-		generate_farsitex_cmds_file(helper_filename,preamble)
-		result += '\\input{' + helper_filename + '}\n'
-		return result
-	#end elif "documentstyle"
-
-	while (index < line_len):
-		next_index = output_line.find(u'\\', index)
-		comment_index = output_line.find(u'%', index)
-		if (next_index == -1):
-			result += output_line[index:]
-			break
-		elif (state == 1):
-			if (output_line[next_index:next_index+14] == u'\\end{verbatim}'):
-				result += output_line[index:next_index+14]
-				index = next_index+14
-				state = 0
-			else:
-				result += output_line[index:next_index+1]
-				index = next_index+1
-		elif (state == 2):
-			if (output_line[next_index:next_index+15] == u'\\end{verbatim*}'):
-				result += output_line[index:next_index+15]
-				index = next_index+15
-				state = 0
-			else:
-				result += output_line[index:next_index+1]
-				index = next_index+1
-		elif (comment_index != -1 and comment_index < next_index):
-			result += output_line[index:]
-			break
-		elif (output_line[next_index:next_index+14] == u"\\input{amssym}"):
-			result += u'\\usepackage{amssymb}'
-			index = next_index+14
-		elif (output_line[next_index:next_index+12] == u"\\input{epsf}"):
-			index = next_index+12
-		elif (output_line[next_index:next_index+15] == u"\\includeepspdf{"):
-			result += u'\\includegraphics{'
-			index = next_index+15
-		elif (output_line[next_index:next_index+16] == u"\\begin{verbatim}"):
-			result += output_line[index:next_index+16]
-			index = next_index+16
-			state = 1
-		elif (output_line[next_index:next_index+17] == u"\\begin{verbatim*}"):
-			result += output_line[index:next_index+17]
-			index = next_index+17
-			state = 2
-		elif (output_line[next_index:next_index+26] == u'\\setlength{\\headrulewidth}'):
-			end_cmd = output_line.find('}', next_index+26)
-			result += u'\\renewcommand{\\headrulewidth}' + output_line[next_index+26:end_cmd+1]
-			index = end_cmd+1
-		elif (output_line[next_index:next_index+26] == u'\\setlength{\\footrulewidth}'):
-			end_cmd = output_line.find('}', next_index+26)
-			result += u'\\renewcommand{\\footrulewidth}' + output_line[next_index+26:end_cmd+1]
-			index = end_cmd+1
-		elif (output_line[next_index:next_index+10] == u"\\epsffile{"):
-			result += output_line[index:next_index]
-			result += u'\\includegraphics'
-			size_options = u''
-			if (line_number - last_epsfxsize_line <= 3):
-				size_options = u'width=' + last_epsfxsize
-			if (line_number - last_epsfysize_line <= 3):
-				if (size_options != u''):
-					size_options += u','
-				size_options += u'height=' + last_epsfysize
-			if (size_options != u''):
-				result += u'[' + size_options + u']'
-			end_prn = output_line.find(u'.eps}', next_index+9)
-
-			if (end_prn != -1):
-				result += output_line[next_index+9:end_prn] + u'}'
-				index = end_prn+5
-			else:
-				end_prn = output_line.find(u'.ps}', next_index+9)
-				if (end_prn != -1):
-					result += output_line[next_index+9:end_prn] + u'}'
-					index = end_prn+4
-				else:
-					end_prn = output_line.find(u'}', next_index+9)
-					result += output_line[next_index+9:end_prn+1]
-					index = end_prn+1
-		# I assume all the parameter of \epsfxsize comes in one line
-		elif (output_line[next_index:next_index+11] == u"\\epsfxsize="):
-			end_size = read_size(output_line, next_index+11, line_len)
-			if (end_size != -1):
-				last_epsfxsize = output_line[next_index+11:end_size]
-				index = end_size
-			else:
-				index = next_index+11
-			last_epsfxsize_line = line_number
-		# I assume all the parameter of \epsfysize comes in one line
-		elif (output_line[next_index:next_index+11] == u"\\epsfysize="):
-			end_size = read_size(output_line, next_index+11, line_len)
-			if (end_size != -1):
-				last_epsfysize = output_line[next_index+11:end_size]
-				index = end_size
-			else:
-				index = next_index+11
-			last_epsfysize_line = line_number
-		elif (output_line[next_index:next_index+10] == u"\\LR{\\verb*"):
-			end_verb = output_line.find(output_line[next_index+10], next_index+11)
-			verb_param = output_line[next_index+11:end_verb]
-			if (is_alpha_numeric(verb_param)):
-				result += output_line[index:next_index]
-				result += u'\\lr{\\tt{}' + verb_param
-			else:
-				result += output_line[index:end_verb+1]
-			index = end_verb+1
-		elif (output_line[next_index:next_index+9] == u"\\LR{\\verb"):
-			end_verb = output_line.find(output_line[next_index+9], next_index+10)
-			verb_param = output_line[next_index+10:end_verb]
-			if (is_alpha_numeric_space(verb_param)):
-				result += output_line[index:next_index]
-				result += u'\\lr{\\tt{}' + verb_param
-			else:
-				result += output_line[index:end_verb+1]
-			index = end_verb+1
-		elif (output_line[next_index:next_index+6] == u"\\verb*"):
-			end_verb = output_line.find(output_line[next_index+6], next_index+7)
-			result += output_line[index:end_verb+1]
-			index = end_verb+1
-		elif (output_line[next_index:next_index+5] == u"\\verb"):
-			end_verb = output_line.find(output_line[next_index+5], next_index+6)
-			result += output_line[index:end_verb+1]
-			index = end_verb+1
-		elif (output_line[next_index:next_index+9] == u"\\pmatrix{"):
-			result += u'\\ftxepmatrix{'
-			index = next_index+9
-		elif (output_line[next_index:next_index+16] == u"\\begin{document}"):
-			result += u'\\begin{document}\n\\VerbatimFootnotes'
-			index = next_index+16
-		elif (output_line[next_index:next_index+12] == u'\\setcounter{'):
-			begin_num = output_line.find(u'{', next_index+12)
-			end_num = output_line.find(u'}', begin_num)
-			num = convert_persian_to_english(output_line[begin_num+1:end_num])
-			result += output_line[index:begin_num+1]
-			result += num + u'}'
-			index = end_num+1
-		elif (output_line[next_index:next_index+14] == u'\\addtocounter{'):
-			begin_num = output_line.find(u'{', next_index+14)
-			end_num = output_line.find(u'}', begin_num)
-			num = convert_persian_to_english(output_line[begin_num+1:end_num])
-			print 'HI:'
-			print num
-			result += output_line[index:begin_num+1]
-			result += num + u'}'
-			index = end_num+1
-		elif (output_line[next_index:next_index+13] == u'\\multicolumn{'):
-			begin_num = next_index+13
-			end_num = output_line.find(u'}', begin_num)
-			num = convert_persian_to_english(output_line[begin_num:end_num])
-			result += output_line[index:begin_num]
-			result += num + u'}'
-			index = end_num+1
-		else:
-			result += output_line[index:next_index+2]
-			index = next_index+2
-	#end while
-	return result
-
-###############################################
-# from here all functions are mainly used to
-# convert farsitex format to unicode
-###############################################
-
-def convert_file(f, of, convert_cmds):
-	global state
-	global line_number
-	global last_epsfysize_line
-	global last_epsfxsize_line
-	global last_epsfxsize
-	global last_epsfysize
-	global global_state
-
-	state = 0
-	line_number = 0
-	last_epsfysize_line = 0
-	last_epsfxsize_line = 0
-	last_epsfxsize = u''
-	last_epsfysize = u''
-
-	for line in f:
-		line_number += 1
-		print line_number,
-		output_line = u''
-		line_len = len(line)
-		
-		# remove new-line characters from end of line
-		if (line_len>1 and line[line_len-1] == '\n'):
-			line_len-=1
-		if (line_len>1 and line[line_len-1] == '\r'):
-			line_len-=1
-		
-		# check line-direction character
-		line_direction_rtl = (line[0] == '<')
-		if (line[0] != '>') and (line[0] != '<'):
-			print "FORMAT ERROR AT LINE: " + str(line_number)
-			exit(0)
-	
-		i = 1
-	
-		while (i<line_len):
-			next_part_index = ft_next_part(line, i, line_len)
-			next_part = line[i:next_part_index]
-			next_part_latin = (line[i]<chr(0x80))
-			
-			# see if we should put \lr{...} for the current english expression
-			if (global_state == 0):
-				if line_direction_rtl and next_part_latin:
-					is_command_rtl = (next_part_latin and (i>1) and (line[i-1]==F_SLASH) )
-					is_parameter_rtl = (next_part_latin and (i>1) and (next_part_index<line_len) and (line[i-1]==F_AT_SIGN) and (line[next_part_index]==F_AT_SIGN) )
-					is_math_rtl = (next_part_latin and (line[i]=="$") and (line[next_part_index-1]=="$") )
-					is_verb_parameter = ( (line[i-6:i] == F_SLASH+"verb") and not isalpha(line[i]))
-					is_verb = (next_part_latin and (line[i:i+5]=='\\verb' or line[i:i+6]==' \\verb'))
-					is_english = (next_part_latin and (line[i:i+8]=='\\english'))
-				
-					cmd_index = 0
-					while cmd_index < len(commands):
-						len_cmd = len(commands[cmd_index])+2
-						if ( (i > len_cmd) and (line[i-len_cmd:i] == F_SLASH+commands[cmd_index]+F_PRNT_OPEN) ):
-							break
-						cmd_index += 1
-					is_commands_group = cmd_index < len(commands)
-					is_documentstyle_cmd = (line_len > 15) and (line[1:15] == F_SLASH+"documentstyle")
-	
-			if next_part_latin:
-				if (global_state == 0):
-					# whether we should put a \lr{ command
-					if ( line_direction_rtl and not (is_command_rtl or is_parameter_rtl or is_math_rtl or is_commands_group or is_documentstyle_cmd or is_verb_parameter or is_verb or is_english) ):
-						output_line += u'\\lr{'
-					if ( line_direction_rtl and is_verb):
-						output_line += u'\\LR{'
-				
-				# here is the main place that converting happens
-				output_line += next_part.encode( 'utf-8' )
-				
-				if (global_state == 0):
-					# check whether we already used a \lr command: then end it
-					if ( line_direction_rtl and not (is_command_rtl or is_parameter_rtl or is_math_rtl or is_commands_group or is_documentstyle_cmd or is_verb_parameter or is_verb or is_english) ):
-						output_line += u'}'
-					if ( line_direction_rtl and is_verb):
-						output_line += u'}'
-			else:
-				if (global_state == 0):
-					# whether we should put a \rl{} command
-					if ( not line_direction_rtl):
-						output_line += u'\\rl{'
-					
-				# here is the main place that converting happens
-				output_line += map_ft_unicode(next_part)
-				
-				if (global_state == 0):
-					# check whether we already used a \rl command: then end it
-					if (not line_direction_rtl):
-						output_line += u'}'
-					
-			i = next_part_index
-		# end of while			
-
-		#if there was a % commenting then we can return to normal situation
-		if (global_state == 1):
-			global_state = 0
-		
-		# convert some of the FarsiTeX commands to XePersian commands
-		# only if it is requested
-		if (convert_cmds):
-			result = translate_cmds(output_line) 
-		else:
-			result = output_line
-		output_line = result + u'\n'
-		# write the processed line
-		of.write(output_line)
-		# end of line processing
-	# end of file processing
-
-def print_usage():
-	print 'usage: python ftxe-0.6 [-r] [-s] [-x] [-u] in_filename1 in_filename2'
-	print '-r: (DEFAULT) recursively consider files included in the given files'
-	print '-s: do not recursively consider files'
-	print '-x: (DEFAULT) insert xepersian related commands'
-	print '-u: only convert to unicode'
-
-###################################
-# Begin of main body of the program
-###################################
-
-# global variables
-line_number = 0
-last_epsfxsize = u''
-last_epsfxsize_line = 0
-last_epsfysize = u''
-last_epsfysize_line = 0
-state = 0
-global_state = 0
-recursive = 1
-convert_xepersian = 1
-filename = ''
-
-if len(sys.argv) <= 1:
-	print_usage()
-	exit(0)
-
-#find options
-options_index = 1
-while (options_index < len(sys.argv) and sys.argv[options_index][0]=='-'):
-	if (sys.argv[options_index]=='-s'):
-		recursive = 0
-	elif (sys.argv[options_index]=='-u'):
-		convert_xepersian = 0
-	options_index += 1
-
-filenames = []
-while (options_index < len(sys.argv)):
-	filenames.append(sys.argv[options_index])
-	options_index += 1
-
-if (len(filenames) == 0):
-	print 'error: no input filename is specified!'
-	print_usage()
-	exit(0)
-	
-index = 0
-while (index < len(filenames)):
-	filename = filenames[index]
-	index += 1
-
-	outfile = ''
-	if (filename[-4:] != '.tex'):
-		outfile = filename[0:-3] + 'tex'
-	else: 
-		outfile = filename + '.tex'
-
-	print '\n\nConverting "' + filename + '" into "' + outfile + '"'
-	try:
-		f = open(filename, 'r')
-	except IOError:
-		print "Can not open the input file: " + filename
-		exit(0)
-
-	try:
-		of = codecs.open(outfile, encoding='utf-8', mode='w')
-	except IOError:
-		print "Can not open the output file: " + outfile
-		exit(0)
-
-	convert_file(f, of, convert_xepersian)
-
-	of.close()
-	f.close()	

Added: trunk/ftxe-0.9.py
===================================================================
--- trunk/ftxe-0.9.py	2009-06-27 01:36:36 UTC (rev 77)
+++ trunk/ftxe-0.9.py	2009-07-03 04:41:39 UTC (rev 78)
@@ -0,0 +1,1019 @@
+?#########################################
+#       General Public License          #
+#       Author:  Mostafa Vahedi         #
+#       Date:    30 June 2009           #
+#       Version  0.9                    #
+#########################################
+
+import codecs
+
+import sys
+import os
+
+ft_numerical = [
+chr(0xB9),	# 	Arabic Thoushads Seperator
+chr(0xBC)	#	ARABIC DECIMAL SEPARATOR
+]
+
+
+ft_vowels = [
+chr(0xB0),	#	ARABIC FATHA
+chr(0xB1),	#	ARABIC KASRA
+chr(0xB2),	#	ARABIC DAMMA
+chr(0xB3),	#	ARABIC FATHATAN
+chr(0xB4),	#	ARABIC SHADDA
+chr(0xBA),	#	ARABIC LETTER SUPERSCRIPT ALEF
+chr(0xBB),	#	ARABIC HAMZA ABOVE
+chr(0xC4) 	#	ARABIC SUKUN
+]
+
+ft_non_joiners = [
+chr(0x8F)	#	ARABIC LETTER HAMZA
+]
+
+ft_bidi_joiners_initial = [
+chr(0xE4),	#	ARABIC LETTER AIN, initial form
+chr(0xE8),	#	ARABIC LETTER GHAIN, initial form
+chr(0xFB) 	#	ARABIC LETTER HEH, initial form
+]
+
+ft_bidi_joiners_medial = [
+chr(0xE3),	#	ARABIC LETTER AIN, medial form
+chr(0xE7),	#	ARABIC LETTER GHAIN, medial form
+chr(0xFA) 	#	ARABIC LETTER HEH, medial form
+]
+
+ft_bidi_joiners_final = [
+chr(0xE2),	#	ARABIC LETTER AIN, final form
+chr(0xE6),	#	ARABIC LETTER GHAIN, final form
+chr(0xFC) 	#	ARABIC LETTER FARSI YEH, final form
+]
+
+ft_bidi_joiners_isolated = [
+chr(0xE1),	#	ARABIC LETTER AIN, isolated form
+chr(0xE5),	#	ARABIC LETTER GHAIN, isolated form
+chr(0xFD) 	#	ARABIC LETTER FARSI YEH, isolated form
+]
+
+ft_bidi_joiners_initial_medial = [
+chr(0x8B),	#	ARABIC TATWEEL
+chr(0x8E),	#	ARABIC LETTER YEH WITH HAMZA ABOVE, initial-medial form
+chr(0x93),	#	ARABIC LETTER BEH, initial-medial form
+chr(0x95),	#	ARABIC LETTER PEH, initial-medial form
+chr(0x97),	#	ARABIC LETTER TEH, initial-medial form
+chr(0x99),	#	ARABIC LETTER THEH, initial-medial form
+chr(0x9B),	#	ARABIC LETTER JEEM, initial-medial form
+chr(0x9D),	#	ARABIC LETTER TCHEH, initial-medial form
+chr(0x9F),	#	ARABIC LETTER HAH, initial-medial form
+chr(0xA1),	#	ARABIC LETTER KHAH, initial-medial form
+chr(0xA8),	#	ARABIC LETTER SEEN, initial-medial form
+chr(0xAA),	#	ARABIC LETTER SHEEN, initial-medial form
+chr(0xAC),	#	ARABIC LETTER SAD, initial-medial form
+chr(0xAE),	#	ARABIC LETTER DAD, initial-medial form
+chr(0xAF),	#	ARABIC LETTER TAH, initial-medial form
+chr(0xE0),	#	ARABIC LETTER ZAH, initial-medial form
+chr(0xEA),	#	ARABIC LETTER FEH, initial-medial form
+chr(0xEC),	#	ARABIC LETTER QAF, initial-medial form
+chr(0xEE),	#	ARABIC LETTER KEHEH, initial-medial form
+chr(0xF0),	#	ARABIC LETTER GAF, initial-medial form
+chr(0xF3),	#	ARABIC LETTER LAM, initial-medial form
+chr(0xF5),	#	ARABIC LETTER MEEM, initial-medial form
+chr(0xF7),	#	ARABIC LETTER NOON, initial-medial form
+chr(0xFE)	#	ARABIC LETTER FARSI YEH, initial-medial form
+]
+
+ft_bidi_joiners_final_isolated = [
+chr(0x92),	#	ARABIC LETTER BEH, final-isolated form
+chr(0x94),	#	ARABIC LETTER PEH, final-isolated form
+chr(0x96),	#	ARABIC LETTER TEH, final-isolated form
+chr(0x98),	#	ARABIC LETTER THEH, final-isolated form
+chr(0x9A),	#	ARABIC LETTER JEEM, final-isolated form
+chr(0x9C),	#	ARABIC LETTER TCHEH, final-isolated form
+chr(0x9E),	#	ARABIC LETTER HAH, final-isolated form
+chr(0xA0),	#	ARABIC LETTER KHAH, final-isolated form
+chr(0xA7),	#	ARABIC LETTER SEEN, final-isolated form
+chr(0xA9),	#	ARABIC LETTER SHEEN, final-isolated form
+chr(0xAB),	#	ARABIC LETTER SAD, final-isolated form
+chr(0xAD),	#	ARABIC LETTER DAD, final-isolated form
+chr(0xC1),	#	ARABIC LETTER TAH, final-isolated form
+chr(0xC2),	#	ARABIC LETTER ZAH, final-isolated form
+chr(0xE9),	#	ARABIC LETTER FEH, final-isolated form
+chr(0xEB),	#	ARABIC LETTER QAF, final-isolated form
+chr(0xED),	#	ARABIC LETTER KEHEH, final-isolated form
+chr(0xEF),	#	ARABIC LETTER GAF, final-isolated form
+chr(0xF1),	#	ARABIC LETTER LAM, final-isolated form
+chr(0xF4),	#	ARABIC LETTER MEEM, final-isolated form
+chr(0xF6),	#	ARABIC LETTER NOON, final-isolated form
+chr(0xF9) 	#	ARABIC LETTER HEH, final-isolated form
+]
+
+ft_right_joiners_final = [
+chr(0x91)	#	ARABIC LETTER ALEF, final form
+]
+
+ft_right_joiners_isolated = [
+chr(0x8D),	#	ARABIC LETTER ALEF WITH MADDA ABOVE, isolated form
+chr(0x90)	#	ARABIC LETTER ALEF, isolated form
+]
+
+ft_right_joiners_final_isolated = [
+chr(0xA2),	#	ARABIC LETTER DAL
+chr(0xA3),	#	ARABIC LETTER THAL
+chr(0xA4),	#	ARABIC LETTER REH
+chr(0xA5),	#	ARABIC LETTER ZAIN
+chr(0xA6),	#	ARABIC LETTER JEH
+chr(0xBF),	#	ARABIC LETTER TEH MARBUTAH
+chr(0xF2),	#	ARABIC LIGATURE LAM WITH ALEF
+chr(0xF8)	#	ARABIC LETTER WAW
+]
+
+
+table_FT_UN = {
+chr(0x80) : [u'\u06F0'],	#	EXTENDED ARABIC-INDIC DIGIT ZERO
+chr(0x81) : [u'\u06F1'],	#	EXTENDED ARABIC-INDIC DIGIT ONE
+chr(0x82) : [u'\u06F2'],	#	EXTENDED ARABIC-INDIC DIGIT TWO
+chr(0x83) : [u'\u06F3'],	#	EXTENDED ARABIC-INDIC DIGIT THREE
+chr(0x84) : [u'\u06F4'],	#	EXTENDED ARABIC-INDIC DIGIT FOUR
+chr(0x85) : [u'\u06F5'],	#	EXTENDED ARABIC-INDIC DIGIT FIVE
+chr(0x86) : [u'\u06F6'],	#	EXTENDED ARABIC-INDIC DIGIT SIX
+chr(0x87) : [u'\u06F7'],	#	EXTENDED ARABIC-INDIC DIGIT SEVEN
+chr(0x88) : [u'\u06F8'],	#	EXTENDED ARABIC-INDIC DIGIT EIGHT
+chr(0x89) : [u'\u06F9'],	#	EXTENDED ARABIC-INDIC DIGIT NINE
+chr(0x8A) : [u'\u060C'],	#	ARABIC COMMA
+chr(0x8B) : [u'\u0640'],	#	ARABIC TATWEEL
+chr(0x8C) : [u'\u061F'],	#	ARABIC QUESTION MARK
+chr(0x8D) : [u'\u0622'],	#	ARABIC LETTER ALEF WITH MADDA ABOVE, isolated form
+chr(0x8E) : [u'\u0626'],	#	ARABIC LETTER YEH WITH HAMZA ABOVE, initial-medial form
+chr(0x8F) : [u'\u0621'],	#	ARABIC LETTER HAMZA
+chr(0x90) : [u'\u0627'],	#	ARABIC LETTER ALEF, isolated form
+chr(0x91) : [u'\u0627'],	#	ARABIC LETTER ALEF, final form
+chr(0x92) : [u'\u0628'],	#	ARABIC LETTER BEH, final-isolated form
+chr(0x93) : [u'\u0628'],	#	ARABIC LETTER BEH, initial-medial form
+chr(0x94) : [u'\u067E'],	#	ARABIC LETTER PEH, final-isolated form
+chr(0x95) : [u'\u067E'],	#	ARABIC LETTER PEH, initial-medial form
+chr(0x96) : [u'\u062A'],	#	ARABIC LETTER TEH, final-isolated form
+chr(0x97) : [u'\u062A'],	#	ARABIC LETTER TEH, initial-medial form
+chr(0x98) : [u'\u062B'],	#	ARABIC LETTER THEH, final-isolated form
+chr(0x99) : [u'\u062B'],	#	ARABIC LETTER THEH, initial-medial form
+chr(0x9A) : [u'\u062C'],	#	ARABIC LETTER JEEM, final-isolated form
+chr(0x9B) : [u'\u062C'],	#	ARABIC LETTER JEEM, initial-medial form
+chr(0x9C) : [u'\u0686'],	#	ARABIC LETTER TCHEH, final-isolated form
+chr(0x9D) : [u'\u0686'],	#	ARABIC LETTER TCHEH, initial-medial form
+chr(0x9E) : [u'\u062D'],	#	ARABIC LETTER HAH, final-isolated form
+chr(0x9F) : [u'\u062D'],	#	ARABIC LETTER HAH, initial-medial form
+chr(0xA0) : [u'\u062E'],	#	ARABIC LETTER KHAH, final-isolated form
+chr(0xA1) : [u'\u062E'],	#	ARABIC LETTER KHAH, initial-medial form
+chr(0xA2) : [u'\u062F'],	#	ARABIC LETTER DAL
+chr(0xA3) : [u'\u0630'],	#	ARABIC LETTER THAL
+chr(0xA4) : [u'\u0631'],	#	ARABIC LETTER REH
+chr(0xA5) : [u'\u0632'],	#	ARABIC LETTER ZAIN
+chr(0xA6) : [u'\u0698'],	#	ARABIC LETTER JEH
+chr(0xA7) : [u'\u0633'],	#	ARABIC LETTER SEEN, final-isolated form
+chr(0xA8) : [u'\u0633'],	#	ARABIC LETTER SEEN, initial-medial form
+chr(0xA9) : [u'\u0634'],	#	ARABIC LETTER SHEEN, final-isolated form
+chr(0xAA) : [u'\u0634'],	#	ARABIC LETTER SHEEN, initial-medial form
+chr(0xAB) : [u'\u0635'],	#	ARABIC LETTER SAD, final-isolated form
+chr(0xAC) : [u'\u0635'],	#	ARABIC LETTER SAD, initial-medial form
+chr(0xAD) : [u'\u0636'],	#	ARABIC LETTER DAD, final-isolated form
+chr(0xAE) : [u'\u0636'],	#	ARABIC LETTER DAD, initial-medial form
+chr(0xAF) : [u'\u0637'],	#	ARABIC LETTER TAH, initial-medial form
+chr(0xB0) : [u'\u064E'],	#	ARABIC FATHA
+chr(0xB1) : [u'\u0650'],	#	ARABIC KASRA
+chr(0xB2) : [u'\u064F'],	#	ARABIC DAMMA
+chr(0xB3) : [u'\u064B'],	#	ARABIC FATHATAN
+chr(0xB4) : [u'\u0651'],	#	ARABIC SHADDA
+chr(0xB5) : [u'\u0023'],	# * #
+chr(0xB6) : [u'\u0024'],	# * $
+chr(0xB7) : [u'\u0025'],	# * %
+chr(0xB8) : [u'\u0026'],	# * &
+chr(0xB9) : [u'\u066C'],	# 	Arabic Thoushads Seperator
+chr(0xBA) : [u'\u0670'],	#	ARABIC LETTER SUPERSCRIPT ALEF
+chr(0xBB) : [u'\u0654'],	#	ARABIC HAMZA ABOVE
+chr(0xBC) : [u'\u066B'],	#	ARABIC DECIMAL SEPARATOR
+chr(0xBD) : [u'\u0029'],	# * RIGHT PARENTHESIS
+chr(0xBE) : [u'\u0028'],	# * LEFT PARENTHESIS
+chr(0xBF) : [u'\u0629'],	#	ARABIC LETTER TEH MARBUTAH
+chr(0xC0) : [u'\u00BB'],	#	RIGHT-POINTING DOUBLE ANGLE QUOTATION MARK
+chr(0xC1) : [u'\u0637'],	#	ARABIC LETTER TAH, final-isolated form
+chr(0xC2) : [u'\u0638'],	#	ARABIC LETTER ZAH, final-isolated form
+chr(0xC3) : [u'\u00AB'],	#	LEFT-POINTING DOUBLE ANGLE QUOTATION MARK
+chr(0xC4) : [u'\u0652'],	#	ARABIC SUKUN
+chr(0xC5) : [u'\u002D'],	# * -
+chr(0xC6) : [u'\u002E'],	# * FULL STOP
+chr(0xC7) : [u'\u002F'],	# * /
+chr(0xC8) : [u'\u002A'],	# * *
+chr(0xC9) : [u'\u007E'],	# * ~
+chr(0xCA) : [u'\u003A'],	# * COLON
+chr(0xCB) : [u'\u061B'],	# 	ARABIC SEMICOLON
+chr(0xCC) : [u'\u003E'],	# * GREATER-THAN SIGN
+chr(0xCD) : [u'\u002B'],	# * +
+chr(0xCE) : [u'\u003D'],	# * =
+chr(0xCF) : [u'\u003C'],	# * LESS-THAN SIGN
+# chr(0xD0) : [u'\u0040'],	# * @
+chr(0xD0) : [u''],	        # * @
+chr(0xD1) : [u'\u005D'],	# * [
+chr(0xD2) : [u'\u005C'],	# * \
+chr(0xD3) : [u'\u005B'],	# * ]
+chr(0xD4) : [u'\u005E'],	# * ^
+chr(0xD5) : [u'\u005F'],	# * _
+chr(0xD6) : [u'\u0060'],	# * `
+chr(0xD7) : [u'\u007D'],	# * {
+chr(0xD8) : [u'\u007C'],	# * |
+chr(0xDA) : [u'\u0020'],	# * SPACE
+chr(0xDD) : [u'\u0021'],	# * EXCLAMATION MARK
+chr(0xDE) : [u'\u007B'],	# * }
+chr(0xE0) : [u'\u0638'],	#	ARABIC LETTER ZAH, initial-medial form
+chr(0xE1) : [u'\u0639'],	#	ARABIC LETTER AIN, isolated form
+chr(0xE2) : [u'\u0639'],	#	ARABIC LETTER AIN, final form
+chr(0xE3) : [u'\u0639'],	#	ARABIC LETTER AIN, medial form
+chr(0xE4) : [u'\u0639'],	#	ARABIC LETTER AIN, initial form
+chr(0xE5) : [u'\u063A'],	#	ARABIC LETTER GHAIN, isolated form
+chr(0xE6) : [u'\u063A'],	#	ARABIC LETTER GHAIN, final form
+chr(0xE7) : [u'\u063A'],	#	ARABIC LETTER GHAIN, medial form
+chr(0xE8) : [u'\u063A'],	#	ARABIC LETTER GHAIN, initial form
+chr(0xE9) : [u'\u0641'],	#	ARABIC LETTER FEH, final-isolated form
+chr(0xEA) : [u'\u0641'],	#	ARABIC LETTER FEH, initial-medial form
+chr(0xEB) : [u'\u0642'],	#	ARABIC LETTER QAF, final-isolated form
+chr(0xEC) : [u'\u0642'],	#	ARABIC LETTER QAF, initial-medial form
+chr(0xED) : [u'\u06A9'],	#	ARABIC LETTER KEHEH, final-isolated form
+chr(0xEE) : [u'\u06A9'],	#	ARABIC LETTER KEHEH, initial-medial form
+chr(0xEF) : [u'\u06AF'],	#	ARABIC LETTER GAF, final-isolated form
+chr(0xF0) : [u'\u06AF'],	#	ARABIC LETTER GAF, initial-medial form
+chr(0xF1) : [u'\u0644'],	#	ARABIC LETTER LAM, final-isolated form
+chr(0xF2) : [u'\u0644\u0627'],	#	ARABIC LIGATURE LAM WITH ALEF
+chr(0xF3) : [u'\u0644'],	#	ARABIC LETTER LAM, initial-medial form
+chr(0xF4) : [u'\u0645'],	#	ARABIC LETTER MEEM, final-isolated form
+chr(0xF5) : [u'\u0645'],	#	ARABIC LETTER MEEM, initial-medial form
+chr(0xF6) : [u'\u0646'],	#	ARABIC LETTER NOON, final-isolated form
+chr(0xF7) : [u'\u0646'],	#	ARABIC LETTER NOON, initial-medial form
+chr(0xF8) : [u'\u0648'],	#	ARABIC LETTER WAW
+chr(0xF9) : [u'\u0647'],	#	ARABIC LETTER HEH, final-isolated form
+chr(0xFA) : [u'\u0647'],	#	ARABIC LETTER HEH, medial form
+chr(0xFB) : [u'\u0647'],	#	ARABIC LETTER HEH, initial form
+chr(0xFC) : [u'\u06CC'],	#	ARABIC LETTER FARSI YEH, final form
+chr(0xFD) : [u'\u06CC'],	#	ARABIC LETTER FARSI YEH, isolated form
+chr(0xFE) : [u'\u06CC']		#	ARABIC LETTER FARSI YEH, initial-medial form
+}
+
+F_PERCENT_SIGN = chr(0xB7)
+F_AT_SIGN = chr(0xD0)
+F_SLASH = chr(0xD2)
+F_SPACE = chr(0xDA)
+F_PRNT_OPEN = chr(0xDE)
+F_PRNT_CLOSE = chr(0xD7)
+
+# latex and farsitex commands whose first parameter does not need \lr{...}
+commands = [ 
+"begin", "end",
+"input", "include", "includeonly",
+"hspace", "vspace", "hspace*", "vspace*",
+"label", "ref", "cite", "bibitem",
+"bibliographystyle",
+"parbox",
+"newenvironment", "newtheorem",
+"persianmathdigitsfamily",
+"fontfamily", "fontseries", "fontshape",
+"rmdefault", "sfdefault", "ttdefault",
+"bfdefault", "itdefault", "sldefault", "scdefault",
+"pagenumbering", "pagestyle", "thispagestyle",
+"setcounter", "stepcounter", "setlength", "addtolength"
+]
+
+def ft_is_all_persian_space(next_part):
+	l = len(next_part)
+	i = 0
+	while (i < l):
+		if (next_part[i] != F_SPACE):
+			return 0
+		i += 1
+	return 1
+
+def ft_is_numeric(ch):
+	if ((ch in ft_numerical) or 
+	    ((ch >= chr(0x80)) and (ch <= chr(0x89))) ):
+		return 1
+	return 0
+
+def ft_can_join_left(ch):
+	if ((ch in ft_bidi_joiners_initial) or
+	    (ch in ft_bidi_joiners_medial) or
+	    (ch in ft_bidi_joiners_final) or
+	    (ch in ft_bidi_joiners_isolated) or
+	    (ch in ft_bidi_joiners_initial_medial) or
+	    (ch in ft_bidi_joiners_final_isolated)):
+    		return 1
+	return 0
+
+def ft_can_join_right(ch):
+	if (ft_can_join_left(ch) or 
+	    (ch in ft_right_joiners_final) or
+	    (ch in ft_right_joiners_isolated) or
+	    (ch in ft_right_joiners_final_isolated)):
+		return 1
+	return 0
+
+def ft_joining_left(ch):
+	if ((ch in ft_bidi_joiners_initial) or 
+	    (ch in ft_bidi_joiners_medial) or
+	    (ch in ft_bidi_joiners_initial_medial)):
+		return 1
+	return 0
+
+
+def ft_joining_right(ch):
+	if ((ch in ft_right_joiners_final) or
+	    (ch in ft_bidi_joiners_medial) or 
+	    (ch in ft_bidi_joiners_final)):
+		return 1
+	return 0
+
+def ft_not_right_joined(ch):
+	if ((ch in ft_bidi_joiners_initial) or
+	    (ch in ft_right_joiners_isolated) or
+	    (ch in ft_bidi_joiners_isolated)):
+		return 1
+	return 0
+
+def ft_adjust_shaping(text, i):
+	current = text[i]
+	u = u''
+	try:
+		u = table_FT_UN[current][0]
+	except KeyError:
+		return u''
+
+	#if you don't want shaping remove the following comment
+	#return u
+
+	if ((current in ft_vowels) or (ft_is_numeric(current))):
+		return u
+
+	#find next non-vowel character on the left
+	text_len = len(text)
+	next_index = i+1
+	while ((next_index < text_len) and (text[next_index] in ft_vowels)):
+		next_index += 1
+
+	if (next_index == text_len):
+		next = ''
+	else:
+		next = text[next_index]
+
+	# if current letter is joining from left but next letter is or can not joining
+	if (ft_joining_left(current)):
+		if (not ft_can_join_right(next)):
+			u += u'\u200D' #ZWJ
+		elif (ft_not_right_joined(next)):
+			u += u'\u200D\u200C' #ZWJ+ZWNJ
+	# if current letter can join but next letter is joining from right
+	elif (ft_can_join_left(current)):
+		if (ft_joining_right(next)):
+			u += u'\u200C\u200D' #ZWNJ+ZWJ
+		elif (ft_can_join_right(next)):
+			u += u'\u200C' #ZWNJ
+	return u
+
+def ft_adjust_number(text):
+	result = u''
+	i = len(text)-1
+	while (i >= 0):
+		result += ft_adjust_shaping(text, i)
+		i -= 1
+	return result
+
+
+def map_ft_unicode(text):
+	mapped_text = u''
+
+	i = 0
+	while (i < len(text)):
+		if (ft_is_numeric(text[i])):
+			next_index = i
+			while ((next_index+1 < len(text)) and
+			       (ft_is_numeric(text[next_index+1]))):
+				next_index += 1
+			mapped_text += ft_adjust_number(text[i:next_index+1])
+			i = next_index+1
+			continue
+
+		mapped_text += ft_adjust_shaping(text, i)
+		i += 1
+	return mapped_text
+
+# Finds next token all of the same language
+def ft_next_part(line, i, line_len):
+	global global_state
+	global recursive
+	global filenames
+	
+	j = i
+	language_flag = (line[j]<chr(0x80))
+	while ((j<line_len) and ((line[j]<chr(0x80)) == language_flag) ):
+		if ( (global_state == 0) and ( (line[j] == '%') or (line[j] == F_PERCENT_SIGN) ) and (line[j-1] != '\\') and (line[j-1] != F_SLASH) ):
+			global_state = 1
+		elif ((global_state == 0) and ((line[j:j+16] == '\\begin{verbatim}') or (line[j:j+17] == '\\begin{verbatim*}'))):
+			global_state = 2
+		elif ((global_state == 2) and ((line[j:j+14] == '\\end{verbatim}') or (line[j:j+15] == '\\end{verbatim*}'))):
+			global_state = 0
+		elif ((global_state == 0) and (line[j:j+6] == '\\verb*')):
+			next_index = line.find(line[j+6], j+7)
+			j = next_index
+		elif ((global_state == 0) and (line[j:j+5] == '\\verb')):
+			next_index = line.find(line[j+5], j+6)
+			j = next_index
+		elif (recursive == 1):
+			if ((global_state == 0) and (line[j:j+9] == '\\include{')):
+				next_index = line.find('}', j+9)
+				filename = line[j+10:next_index-1] + '.ftx'
+				if (os.path.exists(filename) and not filename in filenames):
+					filenames.append(filename)
+			elif ((global_state == 0) and (line[j:j+7] == '\\input{')):
+				next_index = line.find('}', j+7)
+				filename = line[j+8:next_index-1] + '.ftx'
+				if (os.path.exists(filename) and not filename in filenames):
+					filenames.append(filename)
+			elif ((global_state == 0) and (line[j:j+9] == F_SLASH + 'include' + F_PRNT_OPEN)):
+				next_index = line.find(F_PRNT_CLOSE, j+9)
+				if (line[j+9]!=F_AT_SIGN):
+					filename = line[j+9:next_index] + '.ftx'
+				else:
+					filename = line[j+10:next_index-1] + '.ftx'
+				if (os.path.exists(filename) and not filename in filenames):
+					filenames.append(filename)
+			elif ((global_state == 0) and (line[j:j+7] == F_SLASH + 'input' + F_PRNT_OPEN)):
+				next_index = line.find(F_PRNT_CLOSE, j+7)
+				if (line[j+7]!=F_AT_SIGN):
+					filename = line[j+7:next_index] + '.ftx'
+				else:
+					filename = line[j+8:next_index-1] + '.ftx'
+				if (os.path.exists(filename) and not filename in filenames):
+					filenames.append(filename)
+		j += 1
+	return j
+
+###############################################
+# from here all functions are used to translate
+# farsitex commands to xepersian commands
+###############################################
+
+def read_size(input,index,last_index):
+	dim_index = -1 
+	inch_index = input.find(u'in', index)
+	if (inch_index != -1):
+		dim_index = inch_index
+	mm_index = input.find(u'mm', index)
+	if (mm_index != -1):
+		if (dim_index == -1 or mm_index < index):
+			dim_index = mm_index
+	cm_index = input.find(u'cm', index)
+	if (cm_index != -1):
+		if (dim_index == -1 or cm_index < dim_index):
+			dim_index = cm_index
+	pt_index = input.find(u'pt', index)
+	if (pt_index != -1):
+		if (dim_index == -1 or pt_index < dim_index):
+			dim_index = pt_index
+	next_cmd = input.find(u'\\', index)
+	if (next_cmd == -1 and dim_index == -1):
+		print "Error in parsing \epsfxsize command at " + str(line_number) + "\n"
+		return -1
+	elif (next_cmd == -1 or (dim_index != -1 and next_cmd > dim_index)):
+		epsfxsize = input[index:dim_index+2]
+		return dim_index+2
+	elif (next_cmd != -1):
+		end_cmd = next_cmd+1
+		while (end_cmd < last_index and input[end_cmd].isalpha()):
+			end_cmd += 1
+		return end_cmd
+	else:
+		print "Error in parsing \epsfxsize command at " + str(line_number) + "\n"
+		return -1
+
+
+latex_options=[u'a4paper', u'a5paper', u'b5paper', 
+			   u'letterpaper', u'legalpaper', u'executivepaper', 
+			   u'landscape', u'10pt', u'11pt', u'12pt', 
+			   u'oneside', u'twoside', u'draft', 
+			   u'final', u'titlepage', u'notitlepage',
+			   u'onecolumn', u'twocolumn',
+			   u'leqno', u'fleqn']
+
+table_eq_packages = {
+u'poem'     : u'persianpoem',
+u'fmakeidx' : u'makeidx',
+u'ffancyhe' : u'fancyhdr',
+u'fmultico' : u'multicol'
+}
+
+farsitex_ignore_options = [u'persian', u'farsi', u'epsf', u'fgraphix', u'lotusfont']
+
+xepersian_packages = u'\n\\usepackage{url}\n\\usepackage{fancyvrb}\n\\usepackage{setspace}\\doublespace\n\\usepackage{graphicx}\n\\usepackage{amssymb}\n'
+xepersian_preamble = u'\\settextfont[Scale=1.2]{XB Zar}\n\\setlatintextfont[Scale=1.1]{Times New Roman}\n\\setdigitfont{XB Zar} \n\\SepMark{-}\n\\def\\nazok{\\normalfont\\normalsize} \n\\let\\iranic\\it\n\\let\\siah\\bf\n\\let\\khabide\\sl\n\\def\\siahir{\\siah\\iranic}\n\\def\\siahkh{\\siah\\khabide}\n\\setpookfont{XB Kayhan Pook} \n\\let\\tookhali\\pookfamily\n\\setsayehfont{XB Kayhan Sayeh}\\let\\sayedar\\sayehfamily\n\\let\\farsi\\Persian\n\\let\\english\\Latin \n\\let\\farmbox\\mbox\n\\newcommand{\\ftxepmatrix}[1]{\\begin{pmatrix}#1\\end{pmatrix}}\n\\def\\FarsiTeX{\\lr{FarsiTeX}}\n\\def\\????????{\\rl{?????????}}\n'
+thesis_preamble = u'\\university{\\lr{UniversityName}}\n\\city{\\lr{CityName}}\n\\latinuniversity{UniversityName}\n\\latincity{CityName} \n\\let\\englishtitle\\latintitle\n\\let\\englishauthor\\latinauthor\n\\let\\englishdegree\\latindegree\n\\let\\englishthesisdate\\latinthesisdate \n\\let\\englishsupervisor\\latinsupervisor\n\\let\\englishdepartment\\latindepartment\n\\let\\makeenglishtitle\\makelatintitle \n\\let\\englishkeywords\\latinkeywords\n\\newenvironment{englishabstract}{\\begin{latinabstract}}{\\end{latinabstract}}\n'
+
+def is_alpha_numeric_space(input):
+	input_len = len(input)
+	i = 0
+	while (i<input_len):
+		if (not (input[i].isalpha() or input[i].isdigit() or input[i]==u'.' or input[i]==u' ') ):
+			return 0
+		i+=1
+	return 1
+
+def is_alpha_numeric(input):
+	input_len = len(input)
+	i = 0
+	while (i<input_len):
+		if (not (input[i].isalpha() or input[i].isdigit() or input[i]=='.') ):
+			return 0
+		i+=1
+	return 1
+			
+def find_eq_cmd(keyword):
+	try:
+		eq_cmd = table_eq_packages[keyword]
+	except KeyError:
+		eq_cmd = u''
+	return eq_cmd
+
+def convert_persian_to_english(num):
+	result = u''
+	num_len = len(num)
+	index = 0
+	while (index < num_len):
+		if (ord(num[index]) >= ord(u'?') and ord(num[index]) <= ord(u'?')):
+			result += unichr(ord(num[index]) - ord(u'?') + ord(u'0'))
+		else:
+			result += num[index]
+		index += 1
+	return result
+
+def generate_farsitex_cmds_file(helper_filename,preamble):
+	try:
+		of = codecs.open(helper_filename, encoding='utf-8', mode='w')
+	except IOError:
+		print "Can not open the output file: " + helper_filename
+		exit(0)
+	of.write(preamble)
+	of.close
+
+
+# \verb|| -> \item[\verb||] or \section{\verb||}
+# \kasre{} \alef{} ...
+def translate_cmds(output_line):
+	global last_epsfxsize
+	global last_epsfxsize_line
+	global last_epsfysize
+	global last_epsfysize_line
+	global state
+	global filename
+
+	result = u''
+	line_len = len(output_line)
+	index = 0
+	if (state == 1): #\begin{verbatim}
+		end_verbatim = output_line.find('\\end{verbatim}')
+		if (end_verbatim == -1):
+			return output_line
+		result += output_line[0:end_verbatim+14]
+		index = end_verbatim+14
+		state = 0
+	elif (state == 2): #\begin{verbatim*}
+		end_verbatim = output_line.find('\\end{verbatim*}')
+		if (end_verbatim == -1):
+			return output_line
+		result += output_line[0:end_verbatim+15]
+		index = end_verbatim+15
+		state = 0
+	elif (output_line[0:14] == "\\documentstyle"):
+		result += u'\\documentclass'
+		#process options
+		last_index = output_line.find(u']')
+		index = 15
+		first_option = 1
+		preamble = xepersian_preamble
+		packages = xepersian_packages
+		document_class = u''
+		while (index < last_index):
+			next_comma = output_line.find(u',',index,last_index)
+			if (next_comma == -1):
+				next_comma = last_index
+			first_of_option = index
+			while (output_line[first_of_option] == u' '):
+				first_of_option += 1
+			end_of_option = next_comma
+			while (output_line[end_of_option-1] == u' '):
+				end_of_option -= 1
+			option = output_line[first_of_option:end_of_option]
+			index = next_comma+1
+			eq_cmd = find_eq_cmd(option)
+			if (eq_cmd != u''):
+				packages += u'\\usepackage{' + eq_cmd + u'}\n'
+				continue
+			elif (option in farsitex_ignore_options):
+				continue
+			elif (option == u'sharifth'):
+				document_class = u'xepersian-thesis'
+				preamble += thesis_preamble
+				continue
+			elif (not option in latex_options):
+				packages += u'\\usepackage{' + option + u'}\n'
+				continue
+	
+			if (first_option):
+				result += u'['
+			else:
+				result += u','
+			result += option
+			first_option = 0
+		#end while
+		if (not first_option):
+			result += u']'
+		index = output_line.find(u'}',last_index)
+		if (document_class == u''):
+			result += output_line[last_index+1:index+1]
+		else:
+			result += u'{' + document_class + u'}'
+		# I assume that nothing important is after
+		# \documentstyle[]{}, otherwise it may conflict
+		# with our preamble
+		if (index != -1):
+			result += output_line[index+1:]
+		result += packages + u'\\usepackage{xepersian}\n'
+		helper_filename = filename + '_farsitex_cmds_xepersian.tex'
+		generate_farsitex_cmds_file(helper_filename,preamble)
+		result += '\\input{' + helper_filename + '}\n'
+		return result
+	#end elif "documentstyle"
+
+	while (index < line_len):
+		next_index = output_line.find(u'\\', index)
+		comment_index = output_line.find(u'%', index)
+		if (next_index == -1):
+			result += output_line[index:]
+			break
+		elif (state == 1):
+			if (output_line[next_index:next_index+14] == u'\\end{verbatim}'):
+				result += output_line[index:next_index+14]
+				index = next_index+14
+				state = 0
+			else:
+				result += output_line[index:next_index+1]
+				index = next_index+1
+		elif (state == 2):
+			if (output_line[next_index:next_index+15] == u'\\end{verbatim*}'):
+				result += output_line[index:next_index+15]
+				index = next_index+15
+				state = 0
+			else:
+				result += output_line[index:next_index+1]
+				index = next_index+1
+		elif (comment_index != -1 and comment_index < next_index):
+			result += output_line[index:]
+			break
+		elif (output_line[next_index:next_index+14] == u"\\input{amssym}"):
+			result += u'\\usepackage{amssymb}'
+			index = next_index+14
+		elif (output_line[next_index:next_index+12] == u"\\input{epsf}"):
+			index = next_index+12
+		elif (output_line[next_index:next_index+15] == u"\\includeepspdf{"):
+			result += u'\\includegraphics{'
+			index = next_index+15
+		elif (output_line[next_index:next_index+16] == u"\\begin{verbatim}"):
+			result += output_line[index:next_index+16]
+			index = next_index+16
+			state = 1
+		elif (output_line[next_index:next_index+17] == u"\\begin{verbatim*}"):
+			result += output_line[index:next_index+17]
+			index = next_index+17
+			state = 2
+		elif (output_line[next_index:next_index+26] == u'\\setlength{\\headrulewidth}'):
+			end_cmd = output_line.find('}', next_index+26)
+			result += u'\\renewcommand{\\headrulewidth}' + output_line[next_index+26:end_cmd+1]
+			index = end_cmd+1
+		elif (output_line[next_index:next_index+26] == u'\\setlength{\\footrulewidth}'):
+			end_cmd = output_line.find('}', next_index+26)
+			result += u'\\renewcommand{\\footrulewidth}' + output_line[next_index+26:end_cmd+1]
+			index = end_cmd+1
+		elif (output_line[next_index:next_index+10] == u"\\epsffile{"):
+			result += output_line[index:next_index]
+			result += u'\\includegraphics'
+			size_options = u''
+			if (line_number - last_epsfxsize_line <= 3):
+				size_options = u'width=' + last_epsfxsize
+			if (line_number - last_epsfysize_line <= 3):
+				if (size_options != u''):
+					size_options += u','
+				size_options += u'height=' + last_epsfysize
+			if (size_options != u''):
+				result += u'[' + size_options + u']'
+			end_prn = output_line.find(u'.eps}', next_index+9)
+
+			if (end_prn != -1):
+				result += output_line[next_index+9:end_prn] + u'}'
+				index = end_prn+5
+			else:
+				end_prn = output_line.find(u'.ps}', next_index+9)
+				if (end_prn != -1):
+					result += output_line[next_index+9:end_prn] + u'}'
+					index = end_prn+4
+				else:
+					end_prn = output_line.find(u'}', next_index+9)
+					result += output_line[next_index+9:end_prn+1]
+					index = end_prn+1
+		# I assume all the parameter of \epsfxsize comes in one line
+		elif (output_line[next_index:next_index+11] == u"\\epsfxsize="):
+			end_size = read_size(output_line, next_index+11, line_len)
+			if (end_size != -1):
+				last_epsfxsize = output_line[next_index+11:end_size]
+				index = end_size
+			else:
+				index = next_index+11
+			last_epsfxsize_line = line_number
+		# I assume all the parameter of \epsfysize comes in one line
+		elif (output_line[next_index:next_index+11] == u"\\epsfysize="):
+			end_size = read_size(output_line, next_index+11, line_len)
+			if (end_size != -1):
+				last_epsfysize = output_line[next_index+11:end_size]
+				index = end_size
+			else:
+				index = next_index+11
+			last_epsfysize_line = line_number
+		elif (output_line[next_index:next_index+10] == u"\\LR{\\verb*"):
+			end_verb = output_line.find(output_line[next_index+10], next_index+11)
+			verb_param = output_line[next_index+11:end_verb]
+			if (is_alpha_numeric(verb_param)):
+				result += output_line[index:next_index]
+				result += u'\\lr{\\tt{}' + verb_param
+			else:
+				result += output_line[index:end_verb+1]
+			index = end_verb+1
+		elif (output_line[next_index:next_index+9] == u"\\LR{\\verb"):
+			end_verb = output_line.find(output_line[next_index+9], next_index+10)
+			verb_param = output_line[next_index+10:end_verb]
+			if (is_alpha_numeric_space(verb_param)):
+				result += output_line[index:next_index]
+				result += u'\\lr{\\tt{}' + verb_param
+			else:
+				result += output_line[index:end_verb+1]
+			index = end_verb+1
+		elif (output_line[next_index:next_index+6] == u"\\verb*"):
+			end_verb = output_line.find(output_line[next_index+6], next_index+7)
+			result += output_line[index:end_verb+1]
+			index = end_verb+1
+		elif (output_line[next_index:next_index+5] == u"\\verb"):
+			end_verb = output_line.find(output_line[next_index+5], next_index+6)
+			result += output_line[index:end_verb+1]
+			index = end_verb+1
+		elif (output_line[next_index:next_index+9] == u"\\pmatrix{"):
+			result += u'\\ftxepmatrix{'
+			index = next_index+9
+		elif (output_line[next_index:next_index+16] == u"\\begin{document}"):
+			result += u'\\begin{document}\n\\VerbatimFootnotes'
+			index = next_index+16
+		elif (output_line[next_index:next_index+8] == u'\\label {'):
+			begin_param = next_index+8
+			end_param = output_line.find(u'}', begin_param)
+			param = convert_persian_to_english(output_line[begin_param:end_param])
+			result += output_line[index:begin_param-2]
+			result += u'{' + param + u'}'
+			index = end_param+1
+		elif (output_line[next_index:next_index+6] == u'\\ref {'):
+			begin_param = next_index+6
+			end_param = output_line.find(u'}', begin_param)
+			param = convert_persian_to_english(output_line[begin_param:end_param])
+			result += output_line[index:begin_param-2]
+			result += u'{' + param + u'}'
+			index = end_param+1
+		elif (output_line[next_index:next_index+7] == u'\\label{'):
+			begin_param = next_index+7
+			end_param = output_line.find(u'}', begin_param)
+			param = convert_persian_to_english(output_line[begin_param:end_param])
+			result += output_line[index:begin_param]
+			result += param + u'}'
+			index = end_param+1
+		elif (output_line[next_index:next_index+5] == u'\\ref{'):
+			begin_param = next_index+5
+			end_param = output_line.find(u'}', begin_param)
+			param = convert_persian_to_english(output_line[begin_param:end_param])
+			result += output_line[index:begin_param]
+			result += param + u'}'
+			index = end_param+1
+		elif (output_line[next_index:next_index+13] == u'\\multicolumn{'):
+			begin_param = next_index+13
+			end_param = output_line.find(u'}', begin_param)
+			param = convert_persian_to_english(output_line[begin_param:end_param])
+			result += output_line[index:begin_param]
+			result += param + u'}'
+			index = end_param+1
+		elif (output_line[next_index:next_index+12] == u'\\setcounter{'):
+			begin_num = output_line.find(u'{', next_index+12)
+			end_num = output_line.find(u'}', begin_num)
+			num = convert_persian_to_english(output_line[begin_num+1:end_num])
+			result += output_line[index:begin_num+1]
+			result += num + u'}'
+			index = end_num+1
+		elif (output_line[next_index:next_index+14] == u'\\addtocounter{'):
+			begin_num = output_line.find(u'{', next_index+14)
+			end_num = output_line.find(u'}', begin_num)
+			num = convert_persian_to_english(output_line[begin_num+1:end_num])
+			result += output_line[index:begin_num+1]
+			result += num + u'}'
+			index = end_num+1
+		else:
+			result += output_line[index:next_index+2]
+			index = next_index+2
+	#end while
+	return result
+
+###############################################
+# from here all functions are mainly used to
+# convert farsitex format to unicode
+###############################################
+
+def convert_file(f, of, convert_cmds):
+	global state
+	global line_number
+	global last_epsfysize_line
+	global last_epsfxsize_line
+	global last_epsfxsize
+	global last_epsfysize
+	global global_state
+
+	state = 0
+	line_number = 0
+	last_epsfysize_line = 0
+	last_epsfxsize_line = 0
+	last_epsfxsize = u''
+	last_epsfysize = u''
+
+	for line in f:
+		line_number += 1
+		print line_number,
+		output_line = u''
+		line_len = len(line)
+		
+		# remove new-line characters from end of line
+		if (line_len>1 and line[line_len-1] == '\n'):
+			line_len-=1
+		if (line_len>1 and line[line_len-1] == '\r'):
+			line_len-=1
+		
+		# check line-direction character
+		line_direction_rtl = (line[0] == '<')
+		if (line[0] != '>') and (line[0] != '<'):
+			print "FORMAT ERROR AT LINE: " + str(line_number)
+			exit(0)
+	
+		i = 1
+	
+		while (i<line_len):
+			next_part_index = ft_next_part(line, i, line_len)
+			next_part = line[i:next_part_index]
+			next_part_latin = (line[i]<chr(0x80))
+			
+			# see if we should put \lr{...} for the current english expression
+			if (global_state == 0):
+				if line_direction_rtl and next_part_latin:
+					is_command_rtl = (next_part_latin and (i>1) and (line[i-1]==F_SLASH) )
+					is_parameter_rtl = (next_part_latin and (i>1) and (next_part_index<line_len) and (line[i-1]==F_AT_SIGN) and (line[next_part_index]==F_AT_SIGN) )
+					is_math_rtl = (next_part_latin and (line[i]=="$") and (line[next_part_index-1]=="$") )
+					is_verb_parameter = ( (line[i-6:i] == F_SLASH+"verb") and not isalpha(line[i]))
+					is_verb = (next_part_latin and (line[i:i+5]=='\\verb' or line[i:i+6]==' \\verb'))
+					is_english = (next_part_latin and (line[i:i+8]=='\\english'))
+				
+					cmd_index = 0
+					while cmd_index < len(commands):
+						len_cmd = len(commands[cmd_index])+2
+						if ( (i > len_cmd) and (line[i-len_cmd:i] == F_SLASH+commands[cmd_index]+F_PRNT_OPEN) ):
+							break
+						elif ( (i > len_cmd+1) and (line[i-len_cmd-1:i] == F_SLASH+commands[cmd_index]+F_SPACE+F_PRNT_OPEN) ):
+							break
+						cmd_index += 1
+					is_commands_group = cmd_index < len(commands)
+					is_documentstyle_cmd = (line_len > 15) and (line[1:15] == F_SLASH+"documentstyle")
+	
+			if next_part_latin:
+				if (global_state == 0):
+					# whether we should put a \lr{ command
+					if ( line_direction_rtl and not (is_command_rtl or is_parameter_rtl or is_math_rtl or is_commands_group or is_documentstyle_cmd or is_verb_parameter or is_verb or is_english) ):
+						output_line += u'\\lr{'
+					if ( line_direction_rtl and is_verb):
+						output_line += u'\\LR{'
+				
+				# here is the main place that converting happens
+				output_line += next_part.encode( 'utf-8' )
+				
+				if (global_state == 0):
+					# check whether we already used a \lr command: then end it
+					if ( line_direction_rtl and not (is_command_rtl or is_parameter_rtl or is_math_rtl or is_commands_group or is_documentstyle_cmd or is_verb_parameter or is_verb or is_english) ):
+						output_line += u'}'
+					if ( line_direction_rtl and is_verb):
+						output_line += u'}'
+			else:
+				if (global_state == 0):
+					# whether we should put a \rl{} command
+					if ( not line_direction_rtl and not ft_is_all_persian_space(next_part)):
+						output_line += u'\\rl{'
+					
+				# here is the main place that converting happens
+				output_line += map_ft_unicode(next_part)
+				
+				if (global_state == 0):
+					# check whether we already used a \rl command: then end it
+					if (not line_direction_rtl and not ft_is_all_persian_space(next_part)):
+						output_line += u'}'
+					
+			i = next_part_index
+		# end of while			
+
+		#if there was a % commenting then we can return to normal situation
+		if (global_state == 1):
+			global_state = 0
+		
+		# convert some of the FarsiTeX commands to XePersian commands
+		# only if it is requested
+		if (convert_cmds):
+			result = translate_cmds(output_line) 
+		else:
+			result = output_line
+		output_line = result + u'\n'
+		# write the processed line
+		of.write(output_line)
+		# end of line processing
+	# end of file processing
+
+def print_usage():
+	print 'usage: python ftxe-0.9 [-r] [-s] [-x] [-u] in_filename1 in_filename2'
+	print '-r: (DEFAULT) recursively consider files included in the given files'
+	print '-s: do not recursively consider files'
+	print '-x: (DEFAULT) insert xepersian related commands'
+	print '-u: only convert to unicode'
+
+###################################
+# Begin of main body of the program
+###################################
+
+# global variables
+line_number = 0
+last_epsfxsize = u''
+last_epsfxsize_line = 0
+last_epsfysize = u''
+last_epsfysize_line = 0
+state = 0
+global_state = 0
+recursive = 1
+convert_xepersian = 1
+filename = ''
+
+if len(sys.argv) <= 1:
+	print_usage()
+	exit(0)
+
+#find options
+options_index = 1
+while (options_index < len(sys.argv) and sys.argv[options_index][0]=='-'):
+	if (sys.argv[options_index]=='-s'):
+		recursive = 0
+	elif (sys.argv[options_index]=='-u'):
+		convert_xepersian = 0
+	options_index += 1
+
+filenames = []
+while (options_index < len(sys.argv)):
+	filenames.append(sys.argv[options_index])
+	options_index += 1
+
+if (len(filenames) == 0):
+	print 'error: no input filename is specified!'
+	print_usage()
+	exit(0)
+	
+index = 0
+while (index < len(filenames)):
+	filename = filenames[index]
+	index += 1
+
+	outfile = ''
+	if (filename[-4:] != '.tex'):
+		outfile = filename[0:-3] + 'tex'
+	else: 
+		outfile = filename + '.tex'
+
+	print '\n\nConverting "' + filename + '" into "' + outfile + '"'
+	try:
+		f = open(filename, 'r')
+	except IOError:
+		print "Can not open the input file: " + filename
+		exit(0)
+
+	try:
+		of = codecs.open(outfile, encoding='utf-8', mode='w')
+	except IOError:
+		print "Can not open the output file: " + outfile
+		exit(0)
+
+	convert_file(f, of, convert_xepersian)
+
+	of.close()
+	f.close()	



From vafa at mail.berlios.de  Sat Jul  4 07:04:10 2009
From: vafa at mail.berlios.de (vafa at mail.berlios.de)
Date: Sat, 4 Jul 2009 07:04:10 +0200
Subject: [Xepersian-development] r79 - trunk
Message-ID: <200907040504.n6454AJI023307@sheep.berlios.de>

Author: vafa
Date: 2009-07-04 07:03:54 +0200 (Sat, 04 Jul 2009)
New Revision: 79

Modified:
   trunk/xepersian.dtx
Log:
few changes in xepersian-thesis.cls

Modified: trunk/xepersian.dtx
===================================================================
--- trunk/xepersian.dtx	2009-07-03 04:41:39 UTC (rev 78)
+++ trunk/xepersian.dtx	2009-07-04 05:03:54 UTC (rev 79)
@@ -163,8 +163,8 @@
 %    \begin{macrocode}
 \NeedsTeXFormat{LaTeX2e}
 \def\xepersianversion{v1.0.1}
-\def\xepersianrevision{revision 75}
-\def\xepersiandate{2009/06/01}
+\def\xepersianrevision{revision 79}
+\def\xepersiandate{2009/07/15}
 \ProvidesPackage{xepersian}[\xepersiandate\space \xepersianversion\space <\xepersianrevision>
 	Persian typesetting in XeLaTeX]
 \DeclareOption{Kashida}{\input{kashida-xepersian.def}}
@@ -3241,28 +3241,28 @@
 \def\maketitle{\begin{titlepage}
 {\includegraphics{logo}}
 \vskip 1.5cm
-{\Huge\bf \@title}\par
+{\Huge\bfseries \@title}\par
 \vskip 1cm
 {\large%
   \by}\par
-{\Large\bf \@author}\par
+{\Large\bfseries \@author}\par
 \vskip 5mm
-{\large\bf\writtenfor
+{\large\bfseries\writtenfor
 \par
 \@degree}
 \par
 \vskip 1cm
 {\large
   \undersupervision\par
-\Large\bf \@supervisor}
+\Large\bfseries \@supervisor}
 \par
 \vskip 1cm
 {\large \@thesisdate}
 \par
 \vskip 1cm
-{\large\bf\departmentof\space\@department}
+{\large\bfseries\departmentof\space\@department}
 \par
-{\large\bf\universityof\space\@university \par\@city}
+{\large\bfseries\universityof\space\@university \par\@city}
 \vfill
 \end{titlepage}%
 }
@@ -3270,7 +3270,7 @@
 \def\abstractpage{\newpage
 \thispagestyle{empty}
 \vskip 15mm
-\begin{center}{\large{\bf \@title} \\}
+\begin{center}{\large{\bfseries \@title} \\}
 \end{center}
 \par
 \begin{abstract}}
@@ -3290,7 +3290,7 @@
 
 \def\acknowledgementpage{\newpage
 \thispagestyle{empty}
-\centerline{\Large \bf\acknowledgementname} 
+\centerline{\Large \bfseries\acknowledgementname} 
 \vspace{1cm}
 \par\noindent}
 \def\endacknowledgementpage{\newpage}



From vafa at mail.berlios.de  Mon Jul  6 04:14:10 2009
From: vafa at mail.berlios.de (vafa at mail.berlios.de)
Date: Mon, 6 Jul 2009 04:14:10 +0200
Subject: [Xepersian-development] r80 - trunk
Message-ID: <200907060214.n662EAKc019553@sheep.berlios.de>

Author: vafa
Date: 2009-07-06 04:13:50 +0200 (Mon, 06 Jul 2009)
New Revision: 80

Added:
   trunk/ftxe-0.10.py
Removed:
   trunk/ftxe-0.9.py
Log:
new version of ftxe per Mostafa

Added: trunk/ftxe-0.10.py
===================================================================
--- trunk/ftxe-0.10.py	2009-07-04 05:03:54 UTC (rev 79)
+++ trunk/ftxe-0.10.py	2009-07-06 02:13:50 UTC (rev 80)
@@ -0,0 +1,1040 @@
+?#  This program is free software: you can redistribute it and/or modify
+#  it under the terms of the GNU General Public License as published by
+#  the Free Software Foundation, either version 3 of the License, or
+#  (at your option) any later version.
+#
+#  This program is distributed in the hope that it will be useful,
+#  but WITHOUT ANY WARRANTY; without even the implied warranty of
+#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+#  GNU General Public License for more details.
+#
+#  You should have received a copy of the GNU General Public License
+#  along with this program. If not, see <http://www.gnu.org/licenses>
+
+##################################################
+#  Author:      Mostafa Vahedi                   #
+#  Date:        05 July 2009                     #
+#  Version:     0.10                             # 
+#  Application: FarsiTeX to XePersian converter  #
+##################################################
+
+import codecs
+
+import sys
+import os
+
+ft_numerical = [
+chr(0xB9),	# 	Arabic Thoushads Seperator
+chr(0xBC)	#	ARABIC DECIMAL SEPARATOR
+]
+
+
+ft_vowels = [
+chr(0xB0),	#	ARABIC FATHA
+chr(0xB1),	#	ARABIC KASRA
+chr(0xB2),	#	ARABIC DAMMA
+chr(0xB3),	#	ARABIC FATHATAN
+chr(0xB4),	#	ARABIC SHADDA
+chr(0xBA),	#	ARABIC LETTER SUPERSCRIPT ALEF
+chr(0xBB),	#	ARABIC HAMZA ABOVE
+chr(0xC4) 	#	ARABIC SUKUN
+]
+
+ft_non_joiners = [
+chr(0x8F)	#	ARABIC LETTER HAMZA
+]
+
+ft_bidi_joiners_initial = [
+chr(0xE4),	#	ARABIC LETTER AIN, initial form
+chr(0xE8),	#	ARABIC LETTER GHAIN, initial form
+chr(0xFB) 	#	ARABIC LETTER HEH, initial form
+]
+
+ft_bidi_joiners_medial = [
+chr(0xE3),	#	ARABIC LETTER AIN, medial form
+chr(0xE7),	#	ARABIC LETTER GHAIN, medial form
+chr(0xFA) 	#	ARABIC LETTER HEH, medial form
+]
+
+ft_bidi_joiners_final = [
+chr(0xE2),	#	ARABIC LETTER AIN, final form
+chr(0xE6),	#	ARABIC LETTER GHAIN, final form
+chr(0xFC) 	#	ARABIC LETTER FARSI YEH, final form
+]
+
+ft_bidi_joiners_isolated = [
+chr(0xE1),	#	ARABIC LETTER AIN, isolated form
+chr(0xE5),	#	ARABIC LETTER GHAIN, isolated form
+chr(0xFD) 	#	ARABIC LETTER FARSI YEH, isolated form
+]
+
+ft_bidi_joiners_initial_medial = [
+chr(0x8B),	#	ARABIC TATWEEL
+chr(0x8E),	#	ARABIC LETTER YEH WITH HAMZA ABOVE, initial-medial form
+chr(0x93),	#	ARABIC LETTER BEH, initial-medial form
+chr(0x95),	#	ARABIC LETTER PEH, initial-medial form
+chr(0x97),	#	ARABIC LETTER TEH, initial-medial form
+chr(0x99),	#	ARABIC LETTER THEH, initial-medial form
+chr(0x9B),	#	ARABIC LETTER JEEM, initial-medial form
+chr(0x9D),	#	ARABIC LETTER TCHEH, initial-medial form
+chr(0x9F),	#	ARABIC LETTER HAH, initial-medial form
+chr(0xA1),	#	ARABIC LETTER KHAH, initial-medial form
+chr(0xA8),	#	ARABIC LETTER SEEN, initial-medial form
+chr(0xAA),	#	ARABIC LETTER SHEEN, initial-medial form
+chr(0xAC),	#	ARABIC LETTER SAD, initial-medial form
+chr(0xAE),	#	ARABIC LETTER DAD, initial-medial form
+chr(0xAF),	#	ARABIC LETTER TAH, initial-medial form
+chr(0xE0),	#	ARABIC LETTER ZAH, initial-medial form
+chr(0xEA),	#	ARABIC LETTER FEH, initial-medial form
+chr(0xEC),	#	ARABIC LETTER QAF, initial-medial form
+chr(0xEE),	#	ARABIC LETTER KEHEH, initial-medial form
+chr(0xF0),	#	ARABIC LETTER GAF, initial-medial form
+chr(0xF3),	#	ARABIC LETTER LAM, initial-medial form
+chr(0xF5),	#	ARABIC LETTER MEEM, initial-medial form
+chr(0xF7),	#	ARABIC LETTER NOON, initial-medial form
+chr(0xFE)	#	ARABIC LETTER FARSI YEH, initial-medial form
+]
+
+ft_bidi_joiners_final_isolated = [
+chr(0x92),	#	ARABIC LETTER BEH, final-isolated form
+chr(0x94),	#	ARABIC LETTER PEH, final-isolated form
+chr(0x96),	#	ARABIC LETTER TEH, final-isolated form
+chr(0x98),	#	ARABIC LETTER THEH, final-isolated form
+chr(0x9A),	#	ARABIC LETTER JEEM, final-isolated form
+chr(0x9C),	#	ARABIC LETTER TCHEH, final-isolated form
+chr(0x9E),	#	ARABIC LETTER HAH, final-isolated form
+chr(0xA0),	#	ARABIC LETTER KHAH, final-isolated form
+chr(0xA7),	#	ARABIC LETTER SEEN, final-isolated form
+chr(0xA9),	#	ARABIC LETTER SHEEN, final-isolated form
+chr(0xAB),	#	ARABIC LETTER SAD, final-isolated form
+chr(0xAD),	#	ARABIC LETTER DAD, final-isolated form
+chr(0xC1),	#	ARABIC LETTER TAH, final-isolated form
+chr(0xC2),	#	ARABIC LETTER ZAH, final-isolated form
+chr(0xE9),	#	ARABIC LETTER FEH, final-isolated form
+chr(0xEB),	#	ARABIC LETTER QAF, final-isolated form
+chr(0xED),	#	ARABIC LETTER KEHEH, final-isolated form
+chr(0xEF),	#	ARABIC LETTER GAF, final-isolated form
+chr(0xF1),	#	ARABIC LETTER LAM, final-isolated form
+chr(0xF4),	#	ARABIC LETTER MEEM, final-isolated form
+chr(0xF6),	#	ARABIC LETTER NOON, final-isolated form
+chr(0xF9) 	#	ARABIC LETTER HEH, final-isolated form
+]
+
+ft_right_joiners_final = [
+chr(0x91)	#	ARABIC LETTER ALEF, final form
+]
+
+ft_right_joiners_isolated = [
+chr(0x8D),	#	ARABIC LETTER ALEF WITH MADDA ABOVE, isolated form
+chr(0x90)	#	ARABIC LETTER ALEF, isolated form
+]
+
+ft_right_joiners_final_isolated = [
+chr(0xA2),	#	ARABIC LETTER DAL
+chr(0xA3),	#	ARABIC LETTER THAL
+chr(0xA4),	#	ARABIC LETTER REH
+chr(0xA5),	#	ARABIC LETTER ZAIN
+chr(0xA6),	#	ARABIC LETTER JEH
+chr(0xBF),	#	ARABIC LETTER TEH MARBUTAH
+chr(0xF2),	#	ARABIC LIGATURE LAM WITH ALEF
+chr(0xF8)	#	ARABIC LETTER WAW
+]
+
+
+table_FT_UN = {
+chr(0x80) : [u'\u06F0'],	#	EXTENDED ARABIC-INDIC DIGIT ZERO
+chr(0x81) : [u'\u06F1'],	#	EXTENDED ARABIC-INDIC DIGIT ONE
+chr(0x82) : [u'\u06F2'],	#	EXTENDED ARABIC-INDIC DIGIT TWO
+chr(0x83) : [u'\u06F3'],	#	EXTENDED ARABIC-INDIC DIGIT THREE
+chr(0x84) : [u'\u06F4'],	#	EXTENDED ARABIC-INDIC DIGIT FOUR
+chr(0x85) : [u'\u06F5'],	#	EXTENDED ARABIC-INDIC DIGIT FIVE
+chr(0x86) : [u'\u06F6'],	#	EXTENDED ARABIC-INDIC DIGIT SIX
+chr(0x87) : [u'\u06F7'],	#	EXTENDED ARABIC-INDIC DIGIT SEVEN
+chr(0x88) : [u'\u06F8'],	#	EXTENDED ARABIC-INDIC DIGIT EIGHT
+chr(0x89) : [u'\u06F9'],	#	EXTENDED ARABIC-INDIC DIGIT NINE
+chr(0x8A) : [u'\u060C'],	#	ARABIC COMMA
+chr(0x8B) : [u'\u0640'],	#	ARABIC TATWEEL
+chr(0x8C) : [u'\u061F'],	#	ARABIC QUESTION MARK
+chr(0x8D) : [u'\u0622'],	#	ARABIC LETTER ALEF WITH MADDA ABOVE, isolated form
+chr(0x8E) : [u'\u0626'],	#	ARABIC LETTER YEH WITH HAMZA ABOVE, initial-medial form
+chr(0x8F) : [u'\u0621'],	#	ARABIC LETTER HAMZA
+chr(0x90) : [u'\u0627'],	#	ARABIC LETTER ALEF, isolated form
+chr(0x91) : [u'\u0627'],	#	ARABIC LETTER ALEF, final form
+chr(0x92) : [u'\u0628'],	#	ARABIC LETTER BEH, final-isolated form
+chr(0x93) : [u'\u0628'],	#	ARABIC LETTER BEH, initial-medial form
+chr(0x94) : [u'\u067E'],	#	ARABIC LETTER PEH, final-isolated form
+chr(0x95) : [u'\u067E'],	#	ARABIC LETTER PEH, initial-medial form
+chr(0x96) : [u'\u062A'],	#	ARABIC LETTER TEH, final-isolated form
+chr(0x97) : [u'\u062A'],	#	ARABIC LETTER TEH, initial-medial form
+chr(0x98) : [u'\u062B'],	#	ARABIC LETTER THEH, final-isolated form
+chr(0x99) : [u'\u062B'],	#	ARABIC LETTER THEH, initial-medial form
+chr(0x9A) : [u'\u062C'],	#	ARABIC LETTER JEEM, final-isolated form
+chr(0x9B) : [u'\u062C'],	#	ARABIC LETTER JEEM, initial-medial form
+chr(0x9C) : [u'\u0686'],	#	ARABIC LETTER TCHEH, final-isolated form
+chr(0x9D) : [u'\u0686'],	#	ARABIC LETTER TCHEH, initial-medial form
+chr(0x9E) : [u'\u062D'],	#	ARABIC LETTER HAH, final-isolated form
+chr(0x9F) : [u'\u062D'],	#	ARABIC LETTER HAH, initial-medial form
+chr(0xA0) : [u'\u062E'],	#	ARABIC LETTER KHAH, final-isolated form
+chr(0xA1) : [u'\u062E'],	#	ARABIC LETTER KHAH, initial-medial form
+chr(0xA2) : [u'\u062F'],	#	ARABIC LETTER DAL
+chr(0xA3) : [u'\u0630'],	#	ARABIC LETTER THAL
+chr(0xA4) : [u'\u0631'],	#	ARABIC LETTER REH
+chr(0xA5) : [u'\u0632'],	#	ARABIC LETTER ZAIN
+chr(0xA6) : [u'\u0698'],	#	ARABIC LETTER JEH
+chr(0xA7) : [u'\u0633'],	#	ARABIC LETTER SEEN, final-isolated form
+chr(0xA8) : [u'\u0633'],	#	ARABIC LETTER SEEN, initial-medial form
+chr(0xA9) : [u'\u0634'],	#	ARABIC LETTER SHEEN, final-isolated form
+chr(0xAA) : [u'\u0634'],	#	ARABIC LETTER SHEEN, initial-medial form
+chr(0xAB) : [u'\u0635'],	#	ARABIC LETTER SAD, final-isolated form
+chr(0xAC) : [u'\u0635'],	#	ARABIC LETTER SAD, initial-medial form
+chr(0xAD) : [u'\u0636'],	#	ARABIC LETTER DAD, final-isolated form
+chr(0xAE) : [u'\u0636'],	#	ARABIC LETTER DAD, initial-medial form
+chr(0xAF) : [u'\u0637'],	#	ARABIC LETTER TAH, initial-medial form
+chr(0xB0) : [u'\u064E'],	#	ARABIC FATHA
+chr(0xB1) : [u'\u0650'],	#	ARABIC KASRA
+chr(0xB2) : [u'\u064F'],	#	ARABIC DAMMA
+chr(0xB3) : [u'\u064B'],	#	ARABIC FATHATAN
+chr(0xB4) : [u'\u0651'],	#	ARABIC SHADDA
+chr(0xB5) : [u'\u0023'],	# * #
+chr(0xB6) : [u'\u0024'],	# * $
+chr(0xB7) : [u'\u0025'],	# * %
+chr(0xB8) : [u'\u0026'],	# * &
+chr(0xB9) : [u'\u066C'],	# 	Arabic Thoushads Seperator
+chr(0xBA) : [u'\u0670'],	#	ARABIC LETTER SUPERSCRIPT ALEF
+chr(0xBB) : [u'\u0654'],	#	ARABIC HAMZA ABOVE
+chr(0xBC) : [u'\u066B'],	#	ARABIC DECIMAL SEPARATOR
+chr(0xBD) : [u'\u0029'],	# * RIGHT PARENTHESIS
+chr(0xBE) : [u'\u0028'],	# * LEFT PARENTHESIS
+chr(0xBF) : [u'\u0629'],	#	ARABIC LETTER TEH MARBUTAH
+chr(0xC0) : [u'\u00BB'],	#	RIGHT-POINTING DOUBLE ANGLE QUOTATION MARK
+chr(0xC1) : [u'\u0637'],	#	ARABIC LETTER TAH, final-isolated form
+chr(0xC2) : [u'\u0638'],	#	ARABIC LETTER ZAH, final-isolated form
+chr(0xC3) : [u'\u00AB'],	#	LEFT-POINTING DOUBLE ANGLE QUOTATION MARK
+chr(0xC4) : [u'\u0652'],	#	ARABIC SUKUN
+chr(0xC5) : [u'\u002D'],	# * -
+chr(0xC6) : [u'\u002E'],	# * FULL STOP
+chr(0xC7) : [u'\u002F'],	# * /
+chr(0xC8) : [u'\u002A'],	# * *
+chr(0xC9) : [u'\u007E'],	# * ~
+chr(0xCA) : [u'\u003A'],	# * COLON
+chr(0xCB) : [u'\u061B'],	# 	ARABIC SEMICOLON
+chr(0xCC) : [u'\u003E'],	# * GREATER-THAN SIGN
+chr(0xCD) : [u'\u002B'],	# * +
+chr(0xCE) : [u'\u003D'],	# * =
+chr(0xCF) : [u'\u003C'],	# * LESS-THAN SIGN
+# chr(0xD0) : [u'\u0040'],	# * @
+chr(0xD0) : [u''],	        # * @
+chr(0xD1) : [u'\u005D'],	# * [
+chr(0xD2) : [u'\u005C'],	# * \
+chr(0xD3) : [u'\u005B'],	# * ]
+chr(0xD4) : [u'\u005E'],	# * ^
+chr(0xD5) : [u'\u005F'],	# * _
+chr(0xD6) : [u'\u0060'],	# * `
+chr(0xD7) : [u'\u007D'],	# * {
+chr(0xD8) : [u'\u007C'],	# * |
+chr(0xDA) : [u'\u0020'],	# * SPACE
+chr(0xDD) : [u'\u0021'],	# * EXCLAMATION MARK
+chr(0xDE) : [u'\u007B'],	# * }
+chr(0xE0) : [u'\u0638'],	#	ARABIC LETTER ZAH, initial-medial form
+chr(0xE1) : [u'\u0639'],	#	ARABIC LETTER AIN, isolated form
+chr(0xE2) : [u'\u0639'],	#	ARABIC LETTER AIN, final form
+chr(0xE3) : [u'\u0639'],	#	ARABIC LETTER AIN, medial form
+chr(0xE4) : [u'\u0639'],	#	ARABIC LETTER AIN, initial form
+chr(0xE5) : [u'\u063A'],	#	ARABIC LETTER GHAIN, isolated form
+chr(0xE6) : [u'\u063A'],	#	ARABIC LETTER GHAIN, final form
+chr(0xE7) : [u'\u063A'],	#	ARABIC LETTER GHAIN, medial form
+chr(0xE8) : [u'\u063A'],	#	ARABIC LETTER GHAIN, initial form
+chr(0xE9) : [u'\u0641'],	#	ARABIC LETTER FEH, final-isolated form
+chr(0xEA) : [u'\u0641'],	#	ARABIC LETTER FEH, initial-medial form
+chr(0xEB) : [u'\u0642'],	#	ARABIC LETTER QAF, final-isolated form
+chr(0xEC) : [u'\u0642'],	#	ARABIC LETTER QAF, initial-medial form
+chr(0xED) : [u'\u06A9'],	#	ARABIC LETTER KEHEH, final-isolated form
+chr(0xEE) : [u'\u06A9'],	#	ARABIC LETTER KEHEH, initial-medial form
+chr(0xEF) : [u'\u06AF'],	#	ARABIC LETTER GAF, final-isolated form
+chr(0xF0) : [u'\u06AF'],	#	ARABIC LETTER GAF, initial-medial form
+chr(0xF1) : [u'\u0644'],	#	ARABIC LETTER LAM, final-isolated form
+chr(0xF2) : [u'\u0644\u0627'],	#	ARABIC LIGATURE LAM WITH ALEF
+chr(0xF3) : [u'\u0644'],	#	ARABIC LETTER LAM, initial-medial form
+chr(0xF4) : [u'\u0645'],	#	ARABIC LETTER MEEM, final-isolated form
+chr(0xF5) : [u'\u0645'],	#	ARABIC LETTER MEEM, initial-medial form
+chr(0xF6) : [u'\u0646'],	#	ARABIC LETTER NOON, final-isolated form
+chr(0xF7) : [u'\u0646'],	#	ARABIC LETTER NOON, initial-medial form
+chr(0xF8) : [u'\u0648'],	#	ARABIC LETTER WAW
+chr(0xF9) : [u'\u0647'],	#	ARABIC LETTER HEH, final-isolated form
+chr(0xFA) : [u'\u0647'],	#	ARABIC LETTER HEH, medial form
+chr(0xFB) : [u'\u0647'],	#	ARABIC LETTER HEH, initial form
+chr(0xFC) : [u'\u06CC'],	#	ARABIC LETTER FARSI YEH, final form
+chr(0xFD) : [u'\u06CC'],	#	ARABIC LETTER FARSI YEH, isolated form
+chr(0xFE) : [u'\u06CC']		#	ARABIC LETTER FARSI YEH, initial-medial form
+}
+
+F_PERCENT_SIGN = chr(0xB7)
+F_AT_SIGN = chr(0xD0)
+F_SLASH = chr(0xD2)
+F_SPACE = chr(0xDA)
+F_PRNT_OPEN = chr(0xDE)
+F_PRNT_CLOSE = chr(0xD7)
+
+# latex and farsitex commands whose first parameter does not need \lr{...}
+commands = [ 
+"begin", "end",
+"input", "include", "includeonly",
+"hspace", "vspace", "hspace*", "vspace*",
+"label", "ref", "cite", "bibitem",
+"bibliographystyle",
+"parbox",
+"newenvironment", "newtheorem",
+"persianmathdigitsfamily",
+"fontfamily", "fontseries", "fontshape",
+"rmdefault", "sfdefault", "ttdefault",
+"bfdefault", "itdefault", "sldefault", "scdefault",
+"pagenumbering", "pagestyle", "thispagestyle",
+"setcounter", "stepcounter", "setlength", "addtolength"
+]
+
+def ft_is_all_persian_space(next_part):
+	l = len(next_part)
+	i = 0
+	while (i < l):
+		if (next_part[i] != F_SPACE):
+			return 0
+		i += 1
+	return 1
+
+def ft_is_numeric(ch):
+	if ((ch in ft_numerical) or 
+	    ((ch >= chr(0x80)) and (ch <= chr(0x89))) ):
+		return 1
+	return 0
+
+def ft_can_join_left(ch):
+	if ((ch in ft_bidi_joiners_initial) or
+	    (ch in ft_bidi_joiners_medial) or
+	    (ch in ft_bidi_joiners_final) or
+	    (ch in ft_bidi_joiners_isolated) or
+	    (ch in ft_bidi_joiners_initial_medial) or
+	    (ch in ft_bidi_joiners_final_isolated)):
+    		return 1
+	return 0
+
+def ft_can_join_right(ch):
+	if (ft_can_join_left(ch) or 
+	    (ch in ft_right_joiners_final) or
+	    (ch in ft_right_joiners_isolated) or
+	    (ch in ft_right_joiners_final_isolated)):
+		return 1
+	return 0
+
+def ft_joining_left(ch):
+	if ((ch in ft_bidi_joiners_initial) or 
+	    (ch in ft_bidi_joiners_medial) or
+	    (ch in ft_bidi_joiners_initial_medial)):
+		return 1
+	return 0
+
+
+def ft_joining_right(ch):
+	if ((ch in ft_right_joiners_final) or
+	    (ch in ft_bidi_joiners_medial) or 
+	    (ch in ft_bidi_joiners_final)):
+		return 1
+	return 0
+
+def ft_not_right_joined(ch):
+	if ((ch in ft_bidi_joiners_initial) or
+	    (ch in ft_right_joiners_isolated) or
+	    (ch in ft_bidi_joiners_isolated)):
+		return 1
+	return 0
+
+def ft_adjust_shaping(text, i):
+	current = text[i]
+	u = u''
+	try:
+		u = table_FT_UN[current][0]
+	except KeyError:
+		return u''
+
+	#if you don't want shaping remove the following comment
+	#return u
+
+	if ((current in ft_vowels) or (ft_is_numeric(current))):
+		return u
+
+	#find next non-vowel character on the left
+	text_len = len(text)
+	next_index = i+1
+	while ((next_index < text_len) and (text[next_index] in ft_vowels)):
+		next_index += 1
+
+	if (next_index == text_len):
+		next = ''
+	else:
+		next = text[next_index]
+
+	# if current letter is joining from left but next letter is or can not joining
+	if (ft_joining_left(current)):
+		if (not ft_can_join_right(next)):
+			u += u'\u200D' #ZWJ
+		elif (ft_not_right_joined(next)):
+			u += u'\u200D\u200C' #ZWJ+ZWNJ
+	# if current letter can join but next letter is joining from right
+	elif (ft_can_join_left(current)):
+		if (ft_joining_right(next)):
+			u += u'\u200C\u200D' #ZWNJ+ZWJ
+		elif (ft_can_join_right(next)):
+			u += u'\u200C' #ZWNJ
+	return u
+
+def ft_adjust_number(text):
+	result = u''
+	i = len(text)-1
+	while (i >= 0):
+		result += ft_adjust_shaping(text, i)
+		i -= 1
+	return result
+
+
+def map_ft_unicode(text):
+	mapped_text = u''
+
+	i = 0
+	while (i < len(text)):
+		if (ft_is_numeric(text[i])):
+			next_index = i
+			while ((next_index+1 < len(text)) and
+			       (ft_is_numeric(text[next_index+1]))):
+				next_index += 1
+			mapped_text += ft_adjust_number(text[i:next_index+1])
+			i = next_index+1
+			continue
+
+		mapped_text += ft_adjust_shaping(text, i)
+		i += 1
+	return mapped_text
+
+# Finds next token all of the same language
+def ft_next_part(line, i, line_len):
+	global global_state
+	global recursive
+	global filenames
+	
+	j = i
+	language_flag = (line[j]<chr(0x80))
+	while ((j<line_len) and ((line[j]<chr(0x80)) == language_flag) ):
+		if ( (global_state == 0) and ( (line[j] == '%') or (line[j] == F_PERCENT_SIGN) ) and (line[j-1] != '\\') and (line[j-1] != F_SLASH) ):
+			global_state = 1
+		elif ((global_state == 0) and ((line[j:j+16] == '\\begin{verbatim}') or (line[j:j+17] == '\\begin{verbatim*}'))):
+			global_state = 2
+		elif ((global_state == 2) and ((line[j:j+14] == '\\end{verbatim}') or (line[j:j+15] == '\\end{verbatim*}'))):
+			global_state = 0
+		elif ((global_state == 0) and (line[j:j+6] == '\\verb*')):
+			next_index = line.find(line[j+6], j+7)
+			j = next_index
+		elif ((global_state == 0) and (line[j:j+5] == '\\verb')):
+			next_index = line.find(line[j+5], j+6)
+			j = next_index
+		elif (recursive == 1):
+			if ((global_state == 0) and (line[j:j+9] == '\\include{')):
+				next_index = line.find('}', j+9)
+				filename = line[j+10:next_index-1] + '.ftx'
+				if (os.path.exists(filename) and not filename in filenames):
+					filenames.append(filename)
+			elif ((global_state == 0) and (line[j:j+7] == '\\input{')):
+				next_index = line.find('}', j+7)
+				filename = line[j+8:next_index-1] + '.ftx'
+				if (os.path.exists(filename) and not filename in filenames):
+					filenames.append(filename)
+			elif ((global_state == 0) and (line[j:j+9] == F_SLASH + 'include' + F_PRNT_OPEN)):
+				next_index = line.find(F_PRNT_CLOSE, j+9)
+				if (line[j+9]!=F_AT_SIGN):
+					filename = line[j+9:next_index] + '.ftx'
+				else:
+					filename = line[j+10:next_index-1] + '.ftx'
+				if (os.path.exists(filename) and not filename in filenames):
+					filenames.append(filename)
+			elif ((global_state == 0) and (line[j:j+7] == F_SLASH + 'input' + F_PRNT_OPEN)):
+				next_index = line.find(F_PRNT_CLOSE, j+7)
+				if (line[j+7]!=F_AT_SIGN):
+					filename = line[j+7:next_index] + '.ftx'
+				else:
+					filename = line[j+8:next_index-1] + '.ftx'
+				if (os.path.exists(filename) and not filename in filenames):
+					filenames.append(filename)
+		j += 1
+	return j
+
+###############################################
+# from here all functions are used to translate
+# farsitex commands to xepersian commands
+###############################################
+
+def read_size(input,index,last_index):
+	dim_index = -1 
+	inch_index = input.find(u'in', index)
+	if (inch_index != -1):
+		dim_index = inch_index
+	mm_index = input.find(u'mm', index)
+	if (mm_index != -1):
+		if (dim_index == -1 or mm_index < index):
+			dim_index = mm_index
+	cm_index = input.find(u'cm', index)
+	if (cm_index != -1):
+		if (dim_index == -1 or cm_index < dim_index):
+			dim_index = cm_index
+	pt_index = input.find(u'pt', index)
+	if (pt_index != -1):
+		if (dim_index == -1 or pt_index < dim_index):
+			dim_index = pt_index
+	next_cmd = input.find(u'\\', index)
+	if (next_cmd == -1 and dim_index == -1):
+		print "Error in parsing \epsfxsize command at " + str(line_number) + "\n"
+		return -1
+	elif (next_cmd == -1 or (dim_index != -1 and next_cmd > dim_index)):
+		epsfxsize = input[index:dim_index+2]
+		return dim_index+2
+	elif (next_cmd != -1):
+		end_cmd = next_cmd+1
+		while (end_cmd < last_index and input[end_cmd].isalpha()):
+			end_cmd += 1
+		return end_cmd
+	else:
+		print "Error in parsing \epsfxsize command at " + str(line_number) + "\n"
+		return -1
+
+
+latex_options=[u'a4paper', u'a5paper', u'b5paper', 
+			   u'letterpaper', u'legalpaper', u'executivepaper', 
+			   u'landscape', u'10pt', u'11pt', u'12pt', 
+			   u'oneside', u'twoside', u'draft', 
+			   u'final', u'titlepage', u'notitlepage',
+			   u'onecolumn', u'twocolumn',
+			   u'leqno', u'fleqn']
+
+table_eq_packages = {
+u'poem'     : u'persianpoem',
+u'fmakeidx' : u'makeidx',
+u'ffancyhe' : u'fancyhdr',
+u'fmultico' : u'multicol'
+}
+
+farsitex_ignore_options = [u'persian', u'farsi', u'epsf', u'fgraphix', u'lotusfont']
+
+xepersian_packages = u'\n\\usepackage{url}\n%\\usepackage{fancyvrb}\n\\usepackage{setspace}\\doublespacing\n\\usepackage{graphicx} \n\\usepackage{amssymb}\n'
+xepersian_preamble = u'\\settextfont[Scale=1.2]{XB Zar}\n\\setlatintextfont[Scale=1.1]{Times New Roman}\n\\setdigitfont{XB Zar} \n\\SepMark{-}\n\\def\\nazok{\\normalfont\\normalsize} \n\\let\\iranic\\it\n\\let\\siah\\bf\n\\let\\khabide\\sl\n\\def\\siahir{\\siah\\iranic}\n\\def\\siahkh{\\siah\\khabide}\n\\setpookfont{XB Kayhan Pook} \n\\let\\tookhali\\pookfamily\n\\setsayehfont{XB Kayhan Sayeh}\\let\\sayedar\\sayehfamily\n\\let\\farsi\\Persian\n\\let\\english\\Latin \n\\let\\farmbox\\mbox\n\\newcommand{\\ftxepmatrix}[1]{\\begin{pmatrix}#1\\end{pmatrix}}\n\\def\\FarsiTeX{\\lr{FarsiTeX}}\n\\def\\????????{\\rl{?????????}}\n'
+thesis_preamble = u'\\university{\\lr{UniversityName}}\n\\city{\\lr{CityName}}\n\\latinuniversity{UniversityName}\n\\latincity{CityName} \n\\let\\englishtitle\\latintitle\n\\let\\englishauthor\\latinauthor\n\\let\\englishdegree\\latindegree\n\\let\\englishthesisdate\\latinthesisdate \n\\let\\englishsupervisor\\latinsupervisor\n\\let\\englishdepartment\\latindepartment\n\\let\\makeenglishtitle\\makelatintitle \n\\let\\englishkeywords\\latinkeywords\n\\newenvironment{englishabstract}{\\begin{latinabstract}}{\\end{latinabstract}}\n'
+
+def is_alpha_numeric_space(input):
+	input_len = len(input)
+	i = 0
+	while (i<input_len):
+		if (not (input[i].isalpha() or input[i].isdigit() or input[i]==u'.' or input[i]==u' ') ):
+			return 0
+		i+=1
+	return 1
+
+def is_alpha_numeric(input):
+	input_len = len(input)
+	i = 0
+	while (i<input_len):
+		if (not (input[i].isalpha() or input[i].isdigit() or input[i]=='.') ):
+			return 0
+		i+=1
+	return 1
+			
+def find_eq_cmd(keyword):
+	try:
+		eq_cmd = table_eq_packages[keyword]
+	except KeyError:
+		eq_cmd = u''
+	return eq_cmd
+
+def convert_persian_to_english(num):
+	result = u''
+	num_len = len(num)
+	index = 0
+	while (index < num_len):
+		if (ord(num[index]) >= ord(u'?') and ord(num[index]) <= ord(u'?')):
+			result += unichr(ord(num[index]) - ord(u'?') + ord(u'0'))
+		else:
+			result += num[index]
+		index += 1
+	return result
+
+def generate_farsitex_cmds_file(helper_filename,preamble):
+	try:
+		of = codecs.open(helper_filename, encoding='utf-8', mode='w')
+	except IOError:
+		print "Can not open the output file: " + helper_filename
+		exit(0)
+	of.write(preamble)
+	of.close
+
+
+# \verb|| -> \item[\verb||] or \section{\verb||}
+# \kasre{} \alef{} ...
+def translate_cmds(output_line):
+	global last_epsfxsize
+	global last_epsfxsize_line
+	global last_epsfysize
+	global last_epsfysize_line
+	global state
+	global filename
+
+	result = u''
+	line_len = len(output_line)
+	index = 0
+	if (state == 1): #\begin{verbatim}
+		end_verbatim = output_line.find('\\end{verbatim}')
+		if (end_verbatim == -1):
+			return output_line
+		result += output_line[0:end_verbatim+14]
+		index = end_verbatim+14
+		state = 0
+	elif (state == 2): #\begin{verbatim*}
+		end_verbatim = output_line.find('\\end{verbatim*}')
+		if (end_verbatim == -1):
+			return output_line
+		result += output_line[0:end_verbatim+15]
+		index = end_verbatim+15
+		state = 0
+	elif (output_line[0:14] == "\\documentstyle"):
+		result += u'\\documentclass'
+		#process options
+		last_index = output_line.find(u']')
+		index = 15
+		first_option = 1
+		preamble = xepersian_preamble
+		packages = xepersian_packages
+		xe_document_class = u''
+		while (index < last_index):
+			next_comma = output_line.find(u',',index,last_index)
+			if (next_comma == -1):
+				next_comma = last_index
+			first_of_option = index
+			while (output_line[first_of_option] == u' '):
+				first_of_option += 1
+			end_of_option = next_comma
+			while (output_line[end_of_option-1] == u' '):
+				end_of_option -= 1
+			option = output_line[first_of_option:end_of_option]
+			index = next_comma+1
+			eq_cmd = find_eq_cmd(option)
+			if (eq_cmd != u''):
+				packages += u'\\usepackage{' + eq_cmd + u'}\n'
+				continue
+			elif (option in farsitex_ignore_options):
+				continue
+			elif (option == u'sharifth'):
+				xe_document_class = u'xepersian-thesis'
+				preamble += thesis_preamble
+				continue
+			elif (not option in latex_options):
+				packages += u'\\usepackage{' + option + u'}\n'
+				continue
+	
+			if (first_option):
+				result += u'['
+			else:
+				result += u','
+			result += option
+			first_option = 0
+		#end while
+		if (not first_option):
+			result += u']'
+		# process document style into document class
+		index = output_line.find(u'}',last_index)
+		document_class = output_line[last_index+2:index]
+		if (xe_document_class != u''):
+			result += u'{' + xe_document_class + u'}'
+		elif (document_class == u'oldarticle'):
+			result += u'{article}'
+		elif (document_class == u'oldbook'):
+			result += u'{book}'
+		elif (document_class == u'oldreport'):
+			result += u'{report}'
+		else:
+			result += u'{' + document_class + u'}'
+		# I assume that nothing important is after
+		# \documentstyle[...]{...}, otherwise it may conflict
+		# with our preamble
+		if (index != -1):
+			result += output_line[index+1:]
+		result += packages + u'\\usepackage{xepersian}\n'
+		helper_filename = filename + '_farsitex_cmds_xepersian.tex'
+		generate_farsitex_cmds_file(helper_filename,preamble)
+		result += '\\input{' + helper_filename + '}\n'
+		return result
+	#end elif "documentstyle"
+
+	while (index < line_len):
+		next_index = output_line.find(u'\\', index)
+		comment_index = output_line.find(u'%', index)
+		if (next_index == -1):
+			result += output_line[index:]
+			break
+		elif (state == 1):
+			if (output_line[next_index:next_index+14] == u'\\end{verbatim}'):
+				result += output_line[index:next_index+14]
+				index = next_index+14
+				state = 0
+			else:
+				result += output_line[index:next_index+1]
+				index = next_index+1
+		elif (state == 2):
+			if (output_line[next_index:next_index+15] == u'\\end{verbatim*}'):
+				result += output_line[index:next_index+15]
+				index = next_index+15
+				state = 0
+			else:
+				result += output_line[index:next_index+1]
+				index = next_index+1
+		elif (comment_index != -1 and comment_index < next_index):
+			result += output_line[index:]
+			break
+		elif (output_line[next_index:next_index+14] == u"\\input{amssym}"):
+			result += u'\\usepackage{amssymb}'
+			index = next_index+14
+		elif (output_line[next_index:next_index+12] == u"\\input{epsf}"):
+			index = next_index+12
+		elif (output_line[next_index:next_index+15] == u"\\includeepspdf{"):
+			result += u'\\includegraphics{'
+			index = next_index+15
+		elif (output_line[next_index:next_index+16] == u"\\begin{verbatim}"):
+			result += output_line[index:next_index+16]
+			index = next_index+16
+			state = 1
+		elif (output_line[next_index:next_index+17] == u"\\begin{verbatim*}"):
+			result += output_line[index:next_index+17]
+			index = next_index+17
+			state = 2
+		elif (output_line[next_index:next_index+26] == u'\\setlength{\\headrulewidth}'):
+			end_cmd = output_line.find('}', next_index+26)
+			result += u'\\renewcommand{\\headrulewidth}' + output_line[next_index+26:end_cmd+1]
+			index = end_cmd+1
+		elif (output_line[next_index:next_index+26] == u'\\setlength{\\footrulewidth}'):
+			end_cmd = output_line.find('}', next_index+26)
+			result += u'\\renewcommand{\\footrulewidth}' + output_line[next_index+26:end_cmd+1]
+			index = end_cmd+1
+		elif (output_line[next_index:next_index+10] == u"\\epsffile{"):
+			result += output_line[index:next_index]
+			result += u'\\includegraphics'
+			size_options = u''
+			if (line_number - last_epsfxsize_line <= 3):
+				size_options = u'width=' + last_epsfxsize
+			if (line_number - last_epsfysize_line <= 3):
+				if (size_options != u''):
+					size_options += u','
+				size_options += u'height=' + last_epsfysize
+			if (size_options != u''):
+				result += u'[' + size_options + u']'
+			end_prn = output_line.find(u'.eps}', next_index+9)
+
+			if (end_prn != -1):
+				result += output_line[next_index+9:end_prn] + u'}'
+				index = end_prn+5
+			else:
+				end_prn = output_line.find(u'.ps}', next_index+9)
+				if (end_prn != -1):
+					result += output_line[next_index+9:end_prn] + u'}'
+					index = end_prn+4
+				else:
+					end_prn = output_line.find(u'}', next_index+9)
+					result += output_line[next_index+9:end_prn+1]
+					index = end_prn+1
+		# I assume all the parameter of \epsfxsize comes in one line
+		elif (output_line[next_index:next_index+11] == u"\\epsfxsize="):
+			end_size = read_size(output_line, next_index+11, line_len)
+			if (end_size != -1):
+				last_epsfxsize = output_line[next_index+11:end_size]
+				index = end_size
+			else:
+				index = next_index+11
+			last_epsfxsize_line = line_number
+		# I assume all the parameter of \epsfysize comes in one line
+		elif (output_line[next_index:next_index+11] == u"\\epsfysize="):
+			end_size = read_size(output_line, next_index+11, line_len)
+			if (end_size != -1):
+				last_epsfysize = output_line[next_index+11:end_size]
+				index = end_size
+			else:
+				index = next_index+11
+			last_epsfysize_line = line_number
+		elif (output_line[next_index:next_index+10] == u"\\LR{\\verb*"):
+			end_verb = output_line.find(output_line[next_index+10], next_index+11)
+			verb_param = output_line[next_index+11:end_verb]
+			if (is_alpha_numeric(verb_param)):
+				result += output_line[index:next_index]
+				result += u'\\lr{\\tt{}' + verb_param
+			else:
+				result += output_line[index:end_verb+1]
+			index = end_verb+1
+		elif (output_line[next_index:next_index+9] == u"\\LR{\\verb"):
+			end_verb = output_line.find(output_line[next_index+9], next_index+10)
+			verb_param = output_line[next_index+10:end_verb]
+			if (is_alpha_numeric_space(verb_param)):
+				result += output_line[index:next_index]
+				result += u'\\lr{\\tt{}' + verb_param
+			else:
+				result += output_line[index:end_verb+1]
+			index = end_verb+1
+		elif (output_line[next_index:next_index+6] == u"\\verb*"):
+			end_verb = output_line.find(output_line[next_index+6], next_index+7)
+			result += output_line[index:end_verb+1]
+			index = end_verb+1
+		elif (output_line[next_index:next_index+5] == u"\\verb"):
+			end_verb = output_line.find(output_line[next_index+5], next_index+6)
+			result += output_line[index:end_verb+1]
+			index = end_verb+1
+		elif (output_line[next_index:next_index+9] == u"\\pmatrix{"):
+			result += u'\\ftxepmatrix{'
+			index = next_index+9
+		elif (output_line[next_index:next_index+16] == u"\\begin{document}"):
+			result += u'\\begin{document}\n%\\VerbatimFootnotes'
+			index = next_index+16
+		elif (output_line[next_index:next_index+8] == u'\\label {'):
+			begin_param = next_index+8
+			end_param = output_line.find(u'}', begin_param)
+			param = convert_persian_to_english(output_line[begin_param:end_param])
+			result += output_line[index:begin_param-2]
+			result += u'{' + param + u'}'
+			index = end_param+1
+		elif (output_line[next_index:next_index+6] == u'\\ref {'):
+			begin_param = next_index+6
+			end_param = output_line.find(u'}', begin_param)
+			param = convert_persian_to_english(output_line[begin_param:end_param])
+			result += output_line[index:begin_param-2]
+			result += u'{' + param + u'}'
+			index = end_param+1
+		elif (output_line[next_index:next_index+7] == u'\\label{'):
+			begin_param = next_index+7
+			end_param = output_line.find(u'}', begin_param)
+			param = convert_persian_to_english(output_line[begin_param:end_param])
+			result += output_line[index:begin_param]
+			result += param + u'}'
+			index = end_param+1
+		elif (output_line[next_index:next_index+5] == u'\\ref{'):
+			begin_param = next_index+5
+			end_param = output_line.find(u'}', begin_param)
+			param = convert_persian_to_english(output_line[begin_param:end_param])
+			result += output_line[index:begin_param]
+			result += param + u'}'
+			index = end_param+1
+		elif (output_line[next_index:next_index+13] == u'\\multicolumn{'):
+			begin_param = next_index+13
+			end_param = output_line.find(u'}', begin_param)
+			param = convert_persian_to_english(output_line[begin_param:end_param])
+			result += output_line[index:begin_param]
+			result += param + u'}'
+			index = end_param+1
+		elif (output_line[next_index:next_index+12] == u'\\setcounter{'):
+			begin_num = output_line.find(u'{', next_index+12)
+			end_num = output_line.find(u'}', begin_num)
+			num = convert_persian_to_english(output_line[begin_num+1:end_num])
+			result += output_line[index:begin_num+1]
+			result += num + u'}'
+			index = end_num+1
+		elif (output_line[next_index:next_index+14] == u'\\addtocounter{'):
+			begin_num = output_line.find(u'{', next_index+14)
+			end_num = output_line.find(u'}', begin_num)
+			num = convert_persian_to_english(output_line[begin_num+1:end_num])
+			result += output_line[index:begin_num+1]
+			result += num + u'}'
+			index = end_num+1
+		else:
+			result += output_line[index:next_index+2]
+			index = next_index+2
+	#end while
+	return result
+
+###############################################
+# from here all functions are mainly used to
+# convert farsitex format to unicode
+###############################################
+
+def convert_file(f, of, convert_cmds):
+	global state
+	global line_number
+	global last_epsfysize_line
+	global last_epsfxsize_line
+	global last_epsfxsize
+	global last_epsfysize
+	global global_state
+
+	state = 0
+	line_number = 0
+	last_epsfysize_line = 0
+	last_epsfxsize_line = 0
+	last_epsfxsize = u''
+	last_epsfysize = u''
+
+	for line in f:
+		line_number += 1
+		print line_number,
+		output_line = u''
+		line_len = len(line)
+		
+		# remove new-line characters from end of line
+		if (line_len>1 and line[line_len-1] == '\n'):
+			line_len-=1
+		if (line_len>1 and line[line_len-1] == '\r'):
+			line_len-=1
+		
+		# check line-direction character
+		line_direction_rtl = (line[0] == '<')
+		if (line[0] != '>') and (line[0] != '<'):
+			print "FORMAT ERROR AT LINE: " + str(line_number)
+			exit(0)
+	
+		i = 1
+	
+		while (i<line_len):
+			next_part_index = ft_next_part(line, i, line_len)
+			next_part = line[i:next_part_index]
+			next_part_latin = (line[i]<chr(0x80))
+			
+			# see if we should put \lr{...} for the current english expression
+			if (global_state == 0):
+				if line_direction_rtl and next_part_latin:
+					is_command_rtl = (next_part_latin and (i>1) and (line[i-1]==F_SLASH) )
+					is_parameter_rtl = (next_part_latin and (i>1) and (next_part_index<line_len) and (line[i-1]==F_AT_SIGN) and (line[next_part_index]==F_AT_SIGN) )
+					is_math_rtl = (next_part_latin and (line[i]=="$") and (line[next_part_index-1]=="$") )
+					is_verb_parameter = ( (line[i-6:i] == F_SLASH+"verb") and not isalpha(line[i]))
+					is_verb = (next_part_latin and (line[i:i+5]=='\\verb' or line[i:i+6]==' \\verb'))
+					is_english = (next_part_latin and (line[i:i+8]=='\\english'))
+				
+					cmd_index = 0
+					while cmd_index < len(commands):
+						len_cmd = len(commands[cmd_index])+2
+						if ( (i > len_cmd) and (line[i-len_cmd:i] == F_SLASH+commands[cmd_index]+F_PRNT_OPEN) ):
+							break
+						elif ( (i > len_cmd+1) and (line[i-len_cmd-1:i] == F_SLASH+commands[cmd_index]+F_SPACE+F_PRNT_OPEN) ):
+							break
+						cmd_index += 1
+					is_commands_group = cmd_index < len(commands)
+					is_documentstyle_cmd = (line_len > 15) and (line[1:15] == F_SLASH+"documentstyle")
+	
+			if next_part_latin:
+				if (global_state == 0):
+					# whether we should put a \lr{ command
+					if ( line_direction_rtl and not (is_command_rtl or is_parameter_rtl or is_math_rtl or is_commands_group or is_documentstyle_cmd or is_verb_parameter or is_verb or is_english) ):
+						output_line += u'\\lr{'
+					if ( line_direction_rtl and is_verb):
+						output_line += u'\\LR{'
+				
+				# here is the main place that converting happens
+				output_line += next_part.encode( 'utf-8' )
+				
+				if (global_state == 0):
+					# check whether we already used a \lr command: then end it
+					if ( line_direction_rtl and not (is_command_rtl or is_parameter_rtl or is_math_rtl or is_commands_group or is_documentstyle_cmd or is_verb_parameter or is_verb or is_english) ):
+						output_line += u'}'
+					if ( line_direction_rtl and is_verb):
+						output_line += u'}'
+			else:
+				if (global_state == 0):
+					# whether we should put a \rl{} command
+					if ( not line_direction_rtl and not ft_is_all_persian_space(next_part)):
+						output_line += u'\\rl{'
+					
+				# here is the main place that converting happens
+				output_line += map_ft_unicode(next_part)
+				
+				if (global_state == 0):
+					# check whether we already used a \rl command: then end it
+					if (not line_direction_rtl and not ft_is_all_persian_space(next_part)):
+						output_line += u'}'
+					
+			i = next_part_index
+		# end of while			
+
+		#if there was a % commenting then we can return to normal situation
+		if (global_state == 1):
+			global_state = 0
+		
+		# convert some of the FarsiTeX commands to XePersian commands
+		# only if it is requested
+		if (convert_cmds):
+			result = translate_cmds(output_line) 
+		else:
+			result = output_line
+		output_line = result + u'\n'
+		# write the processed line
+		of.write(output_line)
+		# end of line processing
+	# end of file processing
+
+def print_usage():
+	print 'usage: python ftxe-0.9 [-r] [-s] [-x] [-u] in_filename1 in_filename2'
+	print '-r: (DEFAULT) recursively consider files included in the given files'
+	print '-s: do not recursively consider files'
+	print '-x: (DEFAULT) insert xepersian related commands'
+	print '-u: only convert to unicode'
+
+###################################
+# Begin of main body of the program
+###################################
+
+# global variables
+line_number = 0
+last_epsfxsize = u''
+last_epsfxsize_line = 0
+last_epsfysize = u''
+last_epsfysize_line = 0
+state = 0
+global_state = 0
+recursive = 1
+convert_xepersian = 1
+filename = ''
+
+if len(sys.argv) <= 1:
+	print_usage()
+	exit(0)
+
+#find options
+options_index = 1
+while (options_index < len(sys.argv) and sys.argv[options_index][0]=='-'):
+	if (sys.argv[options_index]=='-s'):
+		recursive = 0
+	elif (sys.argv[options_index]=='-u'):
+		convert_xepersian = 0
+	options_index += 1
+
+filenames = []
+while (options_index < len(sys.argv)):
+	filenames.append(sys.argv[options_index])
+	options_index += 1
+
+if (len(filenames) == 0):
+	print 'error: no input filename is specified!'
+	print_usage()
+	exit(0)
+	
+index = 0
+while (index < len(filenames)):
+	filename = filenames[index]
+	index += 1
+
+	outfile = ''
+	if (filename[-4:] != '.tex'):
+		outfile = filename[0:-3] + 'tex'
+	else: 
+		outfile = filename + '.tex'
+
+	print '\n\nConverting "' + filename + '" into "' + outfile + '"'
+	try:
+		f = open(filename, 'r')
+	except IOError:
+		print "Can not open the input file: " + filename
+		exit(0)
+
+	try:
+		of = codecs.open(outfile, encoding='utf-8', mode='w')
+	except IOError:
+		print "Can not open the output file: " + outfile
+		exit(0)
+
+	convert_file(f, of, convert_xepersian)
+
+	of.close()
+	f.close()	

Deleted: trunk/ftxe-0.9.py
===================================================================
--- trunk/ftxe-0.9.py	2009-07-04 05:03:54 UTC (rev 79)
+++ trunk/ftxe-0.9.py	2009-07-06 02:13:50 UTC (rev 80)
@@ -1,1019 +0,0 @@
-?#########################################
-#       General Public License          #
-#       Author:  Mostafa Vahedi         #
-#       Date:    30 June 2009           #
-#       Version  0.9                    #
-#########################################
-
-import codecs
-
-import sys
-import os
-
-ft_numerical = [
-chr(0xB9),	# 	Arabic Thoushads Seperator
-chr(0xBC)	#	ARABIC DECIMAL SEPARATOR
-]
-
-
-ft_vowels = [
-chr(0xB0),	#	ARABIC FATHA
-chr(0xB1),	#	ARABIC KASRA
-chr(0xB2),	#	ARABIC DAMMA
-chr(0xB3),	#	ARABIC FATHATAN
-chr(0xB4),	#	ARABIC SHADDA
-chr(0xBA),	#	ARABIC LETTER SUPERSCRIPT ALEF
-chr(0xBB),	#	ARABIC HAMZA ABOVE
-chr(0xC4) 	#	ARABIC SUKUN
-]
-
-ft_non_joiners = [
-chr(0x8F)	#	ARABIC LETTER HAMZA
-]
-
-ft_bidi_joiners_initial = [
-chr(0xE4),	#	ARABIC LETTER AIN, initial form
-chr(0xE8),	#	ARABIC LETTER GHAIN, initial form
-chr(0xFB) 	#	ARABIC LETTER HEH, initial form
-]
-
-ft_bidi_joiners_medial = [
-chr(0xE3),	#	ARABIC LETTER AIN, medial form
-chr(0xE7),	#	ARABIC LETTER GHAIN, medial form
-chr(0xFA) 	#	ARABIC LETTER HEH, medial form
-]
-
-ft_bidi_joiners_final = [
-chr(0xE2),	#	ARABIC LETTER AIN, final form
-chr(0xE6),	#	ARABIC LETTER GHAIN, final form
-chr(0xFC) 	#	ARABIC LETTER FARSI YEH, final form
-]
-
-ft_bidi_joiners_isolated = [
-chr(0xE1),	#	ARABIC LETTER AIN, isolated form
-chr(0xE5),	#	ARABIC LETTER GHAIN, isolated form
-chr(0xFD) 	#	ARABIC LETTER FARSI YEH, isolated form
-]
-
-ft_bidi_joiners_initial_medial = [
-chr(0x8B),	#	ARABIC TATWEEL
-chr(0x8E),	#	ARABIC LETTER YEH WITH HAMZA ABOVE, initial-medial form
-chr(0x93),	#	ARABIC LETTER BEH, initial-medial form
-chr(0x95),	#	ARABIC LETTER PEH, initial-medial form
-chr(0x97),	#	ARABIC LETTER TEH, initial-medial form
-chr(0x99),	#	ARABIC LETTER THEH, initial-medial form
-chr(0x9B),	#	ARABIC LETTER JEEM, initial-medial form
-chr(0x9D),	#	ARABIC LETTER TCHEH, initial-medial form
-chr(0x9F),	#	ARABIC LETTER HAH, initial-medial form
-chr(0xA1),	#	ARABIC LETTER KHAH, initial-medial form
-chr(0xA8),	#	ARABIC LETTER SEEN, initial-medial form
-chr(0xAA),	#	ARABIC LETTER SHEEN, initial-medial form
-chr(0xAC),	#	ARABIC LETTER SAD, initial-medial form
-chr(0xAE),	#	ARABIC LETTER DAD, initial-medial form
-chr(0xAF),	#	ARABIC LETTER TAH, initial-medial form
-chr(0xE0),	#	ARABIC LETTER ZAH, initial-medial form
-chr(0xEA),	#	ARABIC LETTER FEH, initial-medial form
-chr(0xEC),	#	ARABIC LETTER QAF, initial-medial form
-chr(0xEE),	#	ARABIC LETTER KEHEH, initial-medial form
-chr(0xF0),	#	ARABIC LETTER GAF, initial-medial form
-chr(0xF3),	#	ARABIC LETTER LAM, initial-medial form
-chr(0xF5),	#	ARABIC LETTER MEEM, initial-medial form
-chr(0xF7),	#	ARABIC LETTER NOON, initial-medial form
-chr(0xFE)	#	ARABIC LETTER FARSI YEH, initial-medial form
-]
-
-ft_bidi_joiners_final_isolated = [
-chr(0x92),	#	ARABIC LETTER BEH, final-isolated form
-chr(0x94),	#	ARABIC LETTER PEH, final-isolated form
-chr(0x96),	#	ARABIC LETTER TEH, final-isolated form
-chr(0x98),	#	ARABIC LETTER THEH, final-isolated form
-chr(0x9A),	#	ARABIC LETTER JEEM, final-isolated form
-chr(0x9C),	#	ARABIC LETTER TCHEH, final-isolated form
-chr(0x9E),	#	ARABIC LETTER HAH, final-isolated form
-chr(0xA0),	#	ARABIC LETTER KHAH, final-isolated form
-chr(0xA7),	#	ARABIC LETTER SEEN, final-isolated form
-chr(0xA9),	#	ARABIC LETTER SHEEN, final-isolated form
-chr(0xAB),	#	ARABIC LETTER SAD, final-isolated form
-chr(0xAD),	#	ARABIC LETTER DAD, final-isolated form
-chr(0xC1),	#	ARABIC LETTER TAH, final-isolated form
-chr(0xC2),	#	ARABIC LETTER ZAH, final-isolated form
-chr(0xE9),	#	ARABIC LETTER FEH, final-isolated form
-chr(0xEB),	#	ARABIC LETTER QAF, final-isolated form
-chr(0xED),	#	ARABIC LETTER KEHEH, final-isolated form
-chr(0xEF),	#	ARABIC LETTER GAF, final-isolated form
-chr(0xF1),	#	ARABIC LETTER LAM, final-isolated form
-chr(0xF4),	#	ARABIC LETTER MEEM, final-isolated form
-chr(0xF6),	#	ARABIC LETTER NOON, final-isolated form
-chr(0xF9) 	#	ARABIC LETTER HEH, final-isolated form
-]
-
-ft_right_joiners_final = [
-chr(0x91)	#	ARABIC LETTER ALEF, final form
-]
-
-ft_right_joiners_isolated = [
-chr(0x8D),	#	ARABIC LETTER ALEF WITH MADDA ABOVE, isolated form
-chr(0x90)	#	ARABIC LETTER ALEF, isolated form
-]
-
-ft_right_joiners_final_isolated = [
-chr(0xA2),	#	ARABIC LETTER DAL
-chr(0xA3),	#	ARABIC LETTER THAL
-chr(0xA4),	#	ARABIC LETTER REH
-chr(0xA5),	#	ARABIC LETTER ZAIN
-chr(0xA6),	#	ARABIC LETTER JEH
-chr(0xBF),	#	ARABIC LETTER TEH MARBUTAH
-chr(0xF2),	#	ARABIC LIGATURE LAM WITH ALEF
-chr(0xF8)	#	ARABIC LETTER WAW
-]
-
-
-table_FT_UN = {
-chr(0x80) : [u'\u06F0'],	#	EXTENDED ARABIC-INDIC DIGIT ZERO
-chr(0x81) : [u'\u06F1'],	#	EXTENDED ARABIC-INDIC DIGIT ONE
-chr(0x82) : [u'\u06F2'],	#	EXTENDED ARABIC-INDIC DIGIT TWO
-chr(0x83) : [u'\u06F3'],	#	EXTENDED ARABIC-INDIC DIGIT THREE
-chr(0x84) : [u'\u06F4'],	#	EXTENDED ARABIC-INDIC DIGIT FOUR
-chr(0x85) : [u'\u06F5'],	#	EXTENDED ARABIC-INDIC DIGIT FIVE
-chr(0x86) : [u'\u06F6'],	#	EXTENDED ARABIC-INDIC DIGIT SIX
-chr(0x87) : [u'\u06F7'],	#	EXTENDED ARABIC-INDIC DIGIT SEVEN
-chr(0x88) : [u'\u06F8'],	#	EXTENDED ARABIC-INDIC DIGIT EIGHT
-chr(0x89) : [u'\u06F9'],	#	EXTENDED ARABIC-INDIC DIGIT NINE
-chr(0x8A) : [u'\u060C'],	#	ARABIC COMMA
-chr(0x8B) : [u'\u0640'],	#	ARABIC TATWEEL
-chr(0x8C) : [u'\u061F'],	#	ARABIC QUESTION MARK
-chr(0x8D) : [u'\u0622'],	#	ARABIC LETTER ALEF WITH MADDA ABOVE, isolated form
-chr(0x8E) : [u'\u0626'],	#	ARABIC LETTER YEH WITH HAMZA ABOVE, initial-medial form
-chr(0x8F) : [u'\u0621'],	#	ARABIC LETTER HAMZA
-chr(0x90) : [u'\u0627'],	#	ARABIC LETTER ALEF, isolated form
-chr(0x91) : [u'\u0627'],	#	ARABIC LETTER ALEF, final form
-chr(0x92) : [u'\u0628'],	#	ARABIC LETTER BEH, final-isolated form
-chr(0x93) : [u'\u0628'],	#	ARABIC LETTER BEH, initial-medial form
-chr(0x94) : [u'\u067E'],	#	ARABIC LETTER PEH, final-isolated form
-chr(0x95) : [u'\u067E'],	#	ARABIC LETTER PEH, initial-medial form
-chr(0x96) : [u'\u062A'],	#	ARABIC LETTER TEH, final-isolated form
-chr(0x97) : [u'\u062A'],	#	ARABIC LETTER TEH, initial-medial form
-chr(0x98) : [u'\u062B'],	#	ARABIC LETTER THEH, final-isolated form
-chr(0x99) : [u'\u062B'],	#	ARABIC LETTER THEH, initial-medial form
-chr(0x9A) : [u'\u062C'],	#	ARABIC LETTER JEEM, final-isolated form
-chr(0x9B) : [u'\u062C'],	#	ARABIC LETTER JEEM, initial-medial form
-chr(0x9C) : [u'\u0686'],	#	ARABIC LETTER TCHEH, final-isolated form
-chr(0x9D) : [u'\u0686'],	#	ARABIC LETTER TCHEH, initial-medial form
-chr(0x9E) : [u'\u062D'],	#	ARABIC LETTER HAH, final-isolated form
-chr(0x9F) : [u'\u062D'],	#	ARABIC LETTER HAH, initial-medial form
-chr(0xA0) : [u'\u062E'],	#	ARABIC LETTER KHAH, final-isolated form
-chr(0xA1) : [u'\u062E'],	#	ARABIC LETTER KHAH, initial-medial form
-chr(0xA2) : [u'\u062F'],	#	ARABIC LETTER DAL
-chr(0xA3) : [u'\u0630'],	#	ARABIC LETTER THAL
-chr(0xA4) : [u'\u0631'],	#	ARABIC LETTER REH
-chr(0xA5) : [u'\u0632'],	#	ARABIC LETTER ZAIN
-chr(0xA6) : [u'\u0698'],	#	ARABIC LETTER JEH
-chr(0xA7) : [u'\u0633'],	#	ARABIC LETTER SEEN, final-isolated form
-chr(0xA8) : [u'\u0633'],	#	ARABIC LETTER SEEN, initial-medial form
-chr(0xA9) : [u'\u0634'],	#	ARABIC LETTER SHEEN, final-isolated form
-chr(0xAA) : [u'\u0634'],	#	ARABIC LETTER SHEEN, initial-medial form
-chr(0xAB) : [u'\u0635'],	#	ARABIC LETTER SAD, final-isolated form
-chr(0xAC) : [u'\u0635'],	#	ARABIC LETTER SAD, initial-medial form
-chr(0xAD) : [u'\u0636'],	#	ARABIC LETTER DAD, final-isolated form
-chr(0xAE) : [u'\u0636'],	#	ARABIC LETTER DAD, initial-medial form
-chr(0xAF) : [u'\u0637'],	#	ARABIC LETTER TAH, initial-medial form
-chr(0xB0) : [u'\u064E'],	#	ARABIC FATHA
-chr(0xB1) : [u'\u0650'],	#	ARABIC KASRA
-chr(0xB2) : [u'\u064F'],	#	ARABIC DAMMA
-chr(0xB3) : [u'\u064B'],	#	ARABIC FATHATAN
-chr(0xB4) : [u'\u0651'],	#	ARABIC SHADDA
-chr(0xB5) : [u'\u0023'],	# * #
-chr(0xB6) : [u'\u0024'],	# * $
-chr(0xB7) : [u'\u0025'],	# * %
-chr(0xB8) : [u'\u0026'],	# * &
-chr(0xB9) : [u'\u066C'],	# 	Arabic Thoushads Seperator
-chr(0xBA) : [u'\u0670'],	#	ARABIC LETTER SUPERSCRIPT ALEF
-chr(0xBB) : [u'\u0654'],	#	ARABIC HAMZA ABOVE
-chr(0xBC) : [u'\u066B'],	#	ARABIC DECIMAL SEPARATOR
-chr(0xBD) : [u'\u0029'],	# * RIGHT PARENTHESIS
-chr(0xBE) : [u'\u0028'],	# * LEFT PARENTHESIS
-chr(0xBF) : [u'\u0629'],	#	ARABIC LETTER TEH MARBUTAH
-chr(0xC0) : [u'\u00BB'],	#	RIGHT-POINTING DOUBLE ANGLE QUOTATION MARK
-chr(0xC1) : [u'\u0637'],	#	ARABIC LETTER TAH, final-isolated form
-chr(0xC2) : [u'\u0638'],	#	ARABIC LETTER ZAH, final-isolated form
-chr(0xC3) : [u'\u00AB'],	#	LEFT-POINTING DOUBLE ANGLE QUOTATION MARK
-chr(0xC4) : [u'\u0652'],	#	ARABIC SUKUN
-chr(0xC5) : [u'\u002D'],	# * -
-chr(0xC6) : [u'\u002E'],	# * FULL STOP
-chr(0xC7) : [u'\u002F'],	# * /
-chr(0xC8) : [u'\u002A'],	# * *
-chr(0xC9) : [u'\u007E'],	# * ~
-chr(0xCA) : [u'\u003A'],	# * COLON
-chr(0xCB) : [u'\u061B'],	# 	ARABIC SEMICOLON
-chr(0xCC) : [u'\u003E'],	# * GREATER-THAN SIGN
-chr(0xCD) : [u'\u002B'],	# * +
-chr(0xCE) : [u'\u003D'],	# * =
-chr(0xCF) : [u'\u003C'],	# * LESS-THAN SIGN
-# chr(0xD0) : [u'\u0040'],	# * @
-chr(0xD0) : [u''],	        # * @
-chr(0xD1) : [u'\u005D'],	# * [
-chr(0xD2) : [u'\u005C'],	# * \
-chr(0xD3) : [u'\u005B'],	# * ]
-chr(0xD4) : [u'\u005E'],	# * ^
-chr(0xD5) : [u'\u005F'],	# * _
-chr(0xD6) : [u'\u0060'],	# * `
-chr(0xD7) : [u'\u007D'],	# * {
-chr(0xD8) : [u'\u007C'],	# * |
-chr(0xDA) : [u'\u0020'],	# * SPACE
-chr(0xDD) : [u'\u0021'],	# * EXCLAMATION MARK
-chr(0xDE) : [u'\u007B'],	# * }
-chr(0xE0) : [u'\u0638'],	#	ARABIC LETTER ZAH, initial-medial form
-chr(0xE1) : [u'\u0639'],	#	ARABIC LETTER AIN, isolated form
-chr(0xE2) : [u'\u0639'],	#	ARABIC LETTER AIN, final form
-chr(0xE3) : [u'\u0639'],	#	ARABIC LETTER AIN, medial form
-chr(0xE4) : [u'\u0639'],	#	ARABIC LETTER AIN, initial form
-chr(0xE5) : [u'\u063A'],	#	ARABIC LETTER GHAIN, isolated form
-chr(0xE6) : [u'\u063A'],	#	ARABIC LETTER GHAIN, final form
-chr(0xE7) : [u'\u063A'],	#	ARABIC LETTER GHAIN, medial form
-chr(0xE8) : [u'\u063A'],	#	ARABIC LETTER GHAIN, initial form
-chr(0xE9) : [u'\u0641'],	#	ARABIC LETTER FEH, final-isolated form
-chr(0xEA) : [u'\u0641'],	#	ARABIC LETTER FEH, initial-medial form
-chr(0xEB) : [u'\u0642'],	#	ARABIC LETTER QAF, final-isolated form
-chr(0xEC) : [u'\u0642'],	#	ARABIC LETTER QAF, initial-medial form
-chr(0xED) : [u'\u06A9'],	#	ARABIC LETTER KEHEH, final-isolated form
-chr(0xEE) : [u'\u06A9'],	#	ARABIC LETTER KEHEH, initial-medial form
-chr(0xEF) : [u'\u06AF'],	#	ARABIC LETTER GAF, final-isolated form
-chr(0xF0) : [u'\u06AF'],	#	ARABIC LETTER GAF, initial-medial form
-chr(0xF1) : [u'\u0644'],	#	ARABIC LETTER LAM, final-isolated form
-chr(0xF2) : [u'\u0644\u0627'],	#	ARABIC LIGATURE LAM WITH ALEF
-chr(0xF3) : [u'\u0644'],	#	ARABIC LETTER LAM, initial-medial form
-chr(0xF4) : [u'\u0645'],	#	ARABIC LETTER MEEM, final-isolated form
-chr(0xF5) : [u'\u0645'],	#	ARABIC LETTER MEEM, initial-medial form
-chr(0xF6) : [u'\u0646'],	#	ARABIC LETTER NOON, final-isolated form
-chr(0xF7) : [u'\u0646'],	#	ARABIC LETTER NOON, initial-medial form
-chr(0xF8) : [u'\u0648'],	#	ARABIC LETTER WAW
-chr(0xF9) : [u'\u0647'],	#	ARABIC LETTER HEH, final-isolated form
-chr(0xFA) : [u'\u0647'],	#	ARABIC LETTER HEH, medial form
-chr(0xFB) : [u'\u0647'],	#	ARABIC LETTER HEH, initial form
-chr(0xFC) : [u'\u06CC'],	#	ARABIC LETTER FARSI YEH, final form
-chr(0xFD) : [u'\u06CC'],	#	ARABIC LETTER FARSI YEH, isolated form
-chr(0xFE) : [u'\u06CC']		#	ARABIC LETTER FARSI YEH, initial-medial form
-}
-
-F_PERCENT_SIGN = chr(0xB7)
-F_AT_SIGN = chr(0xD0)
-F_SLASH = chr(0xD2)
-F_SPACE = chr(0xDA)
-F_PRNT_OPEN = chr(0xDE)
-F_PRNT_CLOSE = chr(0xD7)
-
-# latex and farsitex commands whose first parameter does not need \lr{...}
-commands = [ 
-"begin", "end",
-"input", "include", "includeonly",
-"hspace", "vspace", "hspace*", "vspace*",
-"label", "ref", "cite", "bibitem",
-"bibliographystyle",
-"parbox",
-"newenvironment", "newtheorem",
-"persianmathdigitsfamily",
-"fontfamily", "fontseries", "fontshape",
-"rmdefault", "sfdefault", "ttdefault",
-"bfdefault", "itdefault", "sldefault", "scdefault",
-"pagenumbering", "pagestyle", "thispagestyle",
-"setcounter", "stepcounter", "setlength", "addtolength"
-]
-
-def ft_is_all_persian_space(next_part):
-	l = len(next_part)
-	i = 0
-	while (i < l):
-		if (next_part[i] != F_SPACE):
-			return 0
-		i += 1
-	return 1
-
-def ft_is_numeric(ch):
-	if ((ch in ft_numerical) or 
-	    ((ch >= chr(0x80)) and (ch <= chr(0x89))) ):
-		return 1
-	return 0
-
-def ft_can_join_left(ch):
-	if ((ch in ft_bidi_joiners_initial) or
-	    (ch in ft_bidi_joiners_medial) or
-	    (ch in ft_bidi_joiners_final) or
-	    (ch in ft_bidi_joiners_isolated) or
-	    (ch in ft_bidi_joiners_initial_medial) or
-	    (ch in ft_bidi_joiners_final_isolated)):
-    		return 1
-	return 0
-
-def ft_can_join_right(ch):
-	if (ft_can_join_left(ch) or 
-	    (ch in ft_right_joiners_final) or
-	    (ch in ft_right_joiners_isolated) or
-	    (ch in ft_right_joiners_final_isolated)):
-		return 1
-	return 0
-
-def ft_joining_left(ch):
-	if ((ch in ft_bidi_joiners_initial) or 
-	    (ch in ft_bidi_joiners_medial) or
-	    (ch in ft_bidi_joiners_initial_medial)):
-		return 1
-	return 0
-
-
-def ft_joining_right(ch):
-	if ((ch in ft_right_joiners_final) or
-	    (ch in ft_bidi_joiners_medial) or 
-	    (ch in ft_bidi_joiners_final)):
-		return 1
-	return 0
-
-def ft_not_right_joined(ch):
-	if ((ch in ft_bidi_joiners_initial) or
-	    (ch in ft_right_joiners_isolated) or
-	    (ch in ft_bidi_joiners_isolated)):
-		return 1
-	return 0
-
-def ft_adjust_shaping(text, i):
-	current = text[i]
-	u = u''
-	try:
-		u = table_FT_UN[current][0]
-	except KeyError:
-		return u''
-
-	#if you don't want shaping remove the following comment
-	#return u
-
-	if ((current in ft_vowels) or (ft_is_numeric(current))):
-		return u
-
-	#find next non-vowel character on the left
-	text_len = len(text)
-	next_index = i+1
-	while ((next_index < text_len) and (text[next_index] in ft_vowels)):
-		next_index += 1
-
-	if (next_index == text_len):
-		next = ''
-	else:
-		next = text[next_index]
-
-	# if current letter is joining from left but next letter is or can not joining
-	if (ft_joining_left(current)):
-		if (not ft_can_join_right(next)):
-			u += u'\u200D' #ZWJ
-		elif (ft_not_right_joined(next)):
-			u += u'\u200D\u200C' #ZWJ+ZWNJ
-	# if current letter can join but next letter is joining from right
-	elif (ft_can_join_left(current)):
-		if (ft_joining_right(next)):
-			u += u'\u200C\u200D' #ZWNJ+ZWJ
-		elif (ft_can_join_right(next)):
-			u += u'\u200C' #ZWNJ
-	return u
-
-def ft_adjust_number(text):
-	result = u''
-	i = len(text)-1
-	while (i >= 0):
-		result += ft_adjust_shaping(text, i)
-		i -= 1
-	return result
-
-
-def map_ft_unicode(text):
-	mapped_text = u''
-
-	i = 0
-	while (i < len(text)):
-		if (ft_is_numeric(text[i])):
-			next_index = i
-			while ((next_index+1 < len(text)) and
-			       (ft_is_numeric(text[next_index+1]))):
-				next_index += 1
-			mapped_text += ft_adjust_number(text[i:next_index+1])
-			i = next_index+1
-			continue
-
-		mapped_text += ft_adjust_shaping(text, i)
-		i += 1
-	return mapped_text
-
-# Finds next token all of the same language
-def ft_next_part(line, i, line_len):
-	global global_state
-	global recursive
-	global filenames
-	
-	j = i
-	language_flag = (line[j]<chr(0x80))
-	while ((j<line_len) and ((line[j]<chr(0x80)) == language_flag) ):
-		if ( (global_state == 0) and ( (line[j] == '%') or (line[j] == F_PERCENT_SIGN) ) and (line[j-1] != '\\') and (line[j-1] != F_SLASH) ):
-			global_state = 1
-		elif ((global_state == 0) and ((line[j:j+16] == '\\begin{verbatim}') or (line[j:j+17] == '\\begin{verbatim*}'))):
-			global_state = 2
-		elif ((global_state == 2) and ((line[j:j+14] == '\\end{verbatim}') or (line[j:j+15] == '\\end{verbatim*}'))):
-			global_state = 0
-		elif ((global_state == 0) and (line[j:j+6] == '\\verb*')):
-			next_index = line.find(line[j+6], j+7)
-			j = next_index
-		elif ((global_state == 0) and (line[j:j+5] == '\\verb')):
-			next_index = line.find(line[j+5], j+6)
-			j = next_index
-		elif (recursive == 1):
-			if ((global_state == 0) and (line[j:j+9] == '\\include{')):
-				next_index = line.find('}', j+9)
-				filename = line[j+10:next_index-1] + '.ftx'
-				if (os.path.exists(filename) and not filename in filenames):
-					filenames.append(filename)
-			elif ((global_state == 0) and (line[j:j+7] == '\\input{')):
-				next_index = line.find('}', j+7)
-				filename = line[j+8:next_index-1] + '.ftx'
-				if (os.path.exists(filename) and not filename in filenames):
-					filenames.append(filename)
-			elif ((global_state == 0) and (line[j:j+9] == F_SLASH + 'include' + F_PRNT_OPEN)):
-				next_index = line.find(F_PRNT_CLOSE, j+9)
-				if (line[j+9]!=F_AT_SIGN):
-					filename = line[j+9:next_index] + '.ftx'
-				else:
-					filename = line[j+10:next_index-1] + '.ftx'
-				if (os.path.exists(filename) and not filename in filenames):
-					filenames.append(filename)
-			elif ((global_state == 0) and (line[j:j+7] == F_SLASH + 'input' + F_PRNT_OPEN)):
-				next_index = line.find(F_PRNT_CLOSE, j+7)
-				if (line[j+7]!=F_AT_SIGN):
-					filename = line[j+7:next_index] + '.ftx'
-				else:
-					filename = line[j+8:next_index-1] + '.ftx'
-				if (os.path.exists(filename) and not filename in filenames):
-					filenames.append(filename)
-		j += 1
-	return j
-
-###############################################
-# from here all functions are used to translate
-# farsitex commands to xepersian commands
-###############################################
-
-def read_size(input,index,last_index):
-	dim_index = -1 
-	inch_index = input.find(u'in', index)
-	if (inch_index != -1):
-		dim_index = inch_index
-	mm_index = input.find(u'mm', index)
-	if (mm_index != -1):
-		if (dim_index == -1 or mm_index < index):
-			dim_index = mm_index
-	cm_index = input.find(u'cm', index)
-	if (cm_index != -1):
-		if (dim_index == -1 or cm_index < dim_index):
-			dim_index = cm_index
-	pt_index = input.find(u'pt', index)
-	if (pt_index != -1):
-		if (dim_index == -1 or pt_index < dim_index):
-			dim_index = pt_index
-	next_cmd = input.find(u'\\', index)
-	if (next_cmd == -1 and dim_index == -1):
-		print "Error in parsing \epsfxsize command at " + str(line_number) + "\n"
-		return -1
-	elif (next_cmd == -1 or (dim_index != -1 and next_cmd > dim_index)):
-		epsfxsize = input[index:dim_index+2]
-		return dim_index+2
-	elif (next_cmd != -1):
-		end_cmd = next_cmd+1
-		while (end_cmd < last_index and input[end_cmd].isalpha()):
-			end_cmd += 1
-		return end_cmd
-	else:
-		print "Error in parsing \epsfxsize command at " + str(line_number) + "\n"
-		return -1
-
-
-latex_options=[u'a4paper', u'a5paper', u'b5paper', 
-			   u'letterpaper', u'legalpaper', u'executivepaper', 
-			   u'landscape', u'10pt', u'11pt', u'12pt', 
-			   u'oneside', u'twoside', u'draft', 
-			   u'final', u'titlepage', u'notitlepage',
-			   u'onecolumn', u'twocolumn',
-			   u'leqno', u'fleqn']
-
-table_eq_packages = {
-u'poem'     : u'persianpoem',
-u'fmakeidx' : u'makeidx',
-u'ffancyhe' : u'fancyhdr',
-u'fmultico' : u'multicol'
-}
-
-farsitex_ignore_options = [u'persian', u'farsi', u'epsf', u'fgraphix', u'lotusfont']
-
-xepersian_packages = u'\n\\usepackage{url}\n\\usepackage{fancyvrb}\n\\usepackage{setspace}\\doublespace\n\\usepackage{graphicx}\n\\usepackage{amssymb}\n'
-xepersian_preamble = u'\\settextfont[Scale=1.2]{XB Zar}\n\\setlatintextfont[Scale=1.1]{Times New Roman}\n\\setdigitfont{XB Zar} \n\\SepMark{-}\n\\def\\nazok{\\normalfont\\normalsize} \n\\let\\iranic\\it\n\\let\\siah\\bf\n\\let\\khabide\\sl\n\\def\\siahir{\\siah\\iranic}\n\\def\\siahkh{\\siah\\khabide}\n\\setpookfont{XB Kayhan Pook} \n\\let\\tookhali\\pookfamily\n\\setsayehfont{XB Kayhan Sayeh}\\let\\sayedar\\sayehfamily\n\\let\\farsi\\Persian\n\\let\\english\\Latin \n\\let\\farmbox\\mbox\n\\newcommand{\\ftxepmatrix}[1]{\\begin{pmatrix}#1\\end{pmatrix}}\n\\def\\FarsiTeX{\\lr{FarsiTeX}}\n\\def\\????????{\\rl{?????????}}\n'
-thesis_preamble = u'\\university{\\lr{UniversityName}}\n\\city{\\lr{CityName}}\n\\latinuniversity{UniversityName}\n\\latincity{CityName} \n\\let\\englishtitle\\latintitle\n\\let\\englishauthor\\latinauthor\n\\let\\englishdegree\\latindegree\n\\let\\englishthesisdate\\latinthesisdate \n\\let\\englishsupervisor\\latinsupervisor\n\\let\\englishdepartment\\latindepartment\n\\let\\makeenglishtitle\\makelatintitle \n\\let\\englishkeywords\\latinkeywords\n\\newenvironment{englishabstract}{\\begin{latinabstract}}{\\end{latinabstract}}\n'
-
-def is_alpha_numeric_space(input):
-	input_len = len(input)
-	i = 0
-	while (i<input_len):
-		if (not (input[i].isalpha() or input[i].isdigit() or input[i]==u'.' or input[i]==u' ') ):
-			return 0
-		i+=1
-	return 1
-
-def is_alpha_numeric(input):
-	input_len = len(input)
-	i = 0
-	while (i<input_len):
-		if (not (input[i].isalpha() or input[i].isdigit() or input[i]=='.') ):
-			return 0
-		i+=1
-	return 1
-			
-def find_eq_cmd(keyword):
-	try:
-		eq_cmd = table_eq_packages[keyword]
-	except KeyError:
-		eq_cmd = u''
-	return eq_cmd
-
-def convert_persian_to_english(num):
-	result = u''
-	num_len = len(num)
-	index = 0
-	while (index < num_len):
-		if (ord(num[index]) >= ord(u'?') and ord(num[index]) <= ord(u'?')):
-			result += unichr(ord(num[index]) - ord(u'?') + ord(u'0'))
-		else:
-			result += num[index]
-		index += 1
-	return result
-
-def generate_farsitex_cmds_file(helper_filename,preamble):
-	try:
-		of = codecs.open(helper_filename, encoding='utf-8', mode='w')
-	except IOError:
-		print "Can not open the output file: " + helper_filename
-		exit(0)
-	of.write(preamble)
-	of.close
-
-
-# \verb|| -> \item[\verb||] or \section{\verb||}
-# \kasre{} \alef{} ...
-def translate_cmds(output_line):
-	global last_epsfxsize
-	global last_epsfxsize_line
-	global last_epsfysize
-	global last_epsfysize_line
-	global state
-	global filename
-
-	result = u''
-	line_len = len(output_line)
-	index = 0
-	if (state == 1): #\begin{verbatim}
-		end_verbatim = output_line.find('\\end{verbatim}')
-		if (end_verbatim == -1):
-			return output_line
-		result += output_line[0:end_verbatim+14]
-		index = end_verbatim+14
-		state = 0
-	elif (state == 2): #\begin{verbatim*}
-		end_verbatim = output_line.find('\\end{verbatim*}')
-		if (end_verbatim == -1):
-			return output_line
-		result += output_line[0:end_verbatim+15]
-		index = end_verbatim+15
-		state = 0
-	elif (output_line[0:14] == "\\documentstyle"):
-		result += u'\\documentclass'
-		#process options
-		last_index = output_line.find(u']')
-		index = 15
-		first_option = 1
-		preamble = xepersian_preamble
-		packages = xepersian_packages
-		document_class = u''
-		while (index < last_index):
-			next_comma = output_line.find(u',',index,last_index)
-			if (next_comma == -1):
-				next_comma = last_index
-			first_of_option = index
-			while (output_line[first_of_option] == u' '):
-				first_of_option += 1
-			end_of_option = next_comma
-			while (output_line[end_of_option-1] == u' '):
-				end_of_option -= 1
-			option = output_line[first_of_option:end_of_option]
-			index = next_comma+1
-			eq_cmd = find_eq_cmd(option)
-			if (eq_cmd != u''):
-				packages += u'\\usepackage{' + eq_cmd + u'}\n'
-				continue
-			elif (option in farsitex_ignore_options):
-				continue
-			elif (option == u'sharifth'):
-				document_class = u'xepersian-thesis'
-				preamble += thesis_preamble
-				continue
-			elif (not option in latex_options):
-				packages += u'\\usepackage{' + option + u'}\n'
-				continue
-	
-			if (first_option):
-				result += u'['
-			else:
-				result += u','
-			result += option
-			first_option = 0
-		#end while
-		if (not first_option):
-			result += u']'
-		index = output_line.find(u'}',last_index)
-		if (document_class == u''):
-			result += output_line[last_index+1:index+1]
-		else:
-			result += u'{' + document_class + u'}'
-		# I assume that nothing important is after
-		# \documentstyle[]{}, otherwise it may conflict
-		# with our preamble
-		if (index != -1):
-			result += output_line[index+1:]
-		result += packages + u'\\usepackage{xepersian}\n'
-		helper_filename = filename + '_farsitex_cmds_xepersian.tex'
-		generate_farsitex_cmds_file(helper_filename,preamble)
-		result += '\\input{' + helper_filename + '}\n'
-		return result
-	#end elif "documentstyle"
-
-	while (index < line_len):
-		next_index = output_line.find(u'\\', index)
-		comment_index = output_line.find(u'%', index)
-		if (next_index == -1):
-			result += output_line[index:]
-			break
-		elif (state == 1):
-			if (output_line[next_index:next_index+14] == u'\\end{verbatim}'):
-				result += output_line[index:next_index+14]
-				index = next_index+14
-				state = 0
-			else:
-				result += output_line[index:next_index+1]
-				index = next_index+1
-		elif (state == 2):
-			if (output_line[next_index:next_index+15] == u'\\end{verbatim*}'):
-				result += output_line[index:next_index+15]
-				index = next_index+15
-				state = 0
-			else:
-				result += output_line[index:next_index+1]
-				index = next_index+1
-		elif (comment_index != -1 and comment_index < next_index):
-			result += output_line[index:]
-			break
-		elif (output_line[next_index:next_index+14] == u"\\input{amssym}"):
-			result += u'\\usepackage{amssymb}'
-			index = next_index+14
-		elif (output_line[next_index:next_index+12] == u"\\input{epsf}"):
-			index = next_index+12
-		elif (output_line[next_index:next_index+15] == u"\\includeepspdf{"):
-			result += u'\\includegraphics{'
-			index = next_index+15
-		elif (output_line[next_index:next_index+16] == u"\\begin{verbatim}"):
-			result += output_line[index:next_index+16]
-			index = next_index+16
-			state = 1
-		elif (output_line[next_index:next_index+17] == u"\\begin{verbatim*}"):
-			result += output_line[index:next_index+17]
-			index = next_index+17
-			state = 2
-		elif (output_line[next_index:next_index+26] == u'\\setlength{\\headrulewidth}'):
-			end_cmd = output_line.find('}', next_index+26)
-			result += u'\\renewcommand{\\headrulewidth}' + output_line[next_index+26:end_cmd+1]
-			index = end_cmd+1
-		elif (output_line[next_index:next_index+26] == u'\\setlength{\\footrulewidth}'):
-			end_cmd = output_line.find('}', next_index+26)
-			result += u'\\renewcommand{\\footrulewidth}' + output_line[next_index+26:end_cmd+1]
-			index = end_cmd+1
-		elif (output_line[next_index:next_index+10] == u"\\epsffile{"):
-			result += output_line[index:next_index]
-			result += u'\\includegraphics'
-			size_options = u''
-			if (line_number - last_epsfxsize_line <= 3):
-				size_options = u'width=' + last_epsfxsize
-			if (line_number - last_epsfysize_line <= 3):
-				if (size_options != u''):
-					size_options += u','
-				size_options += u'height=' + last_epsfysize
-			if (size_options != u''):
-				result += u'[' + size_options + u']'
-			end_prn = output_line.find(u'.eps}', next_index+9)
-
-			if (end_prn != -1):
-				result += output_line[next_index+9:end_prn] + u'}'
-				index = end_prn+5
-			else:
-				end_prn = output_line.find(u'.ps}', next_index+9)
-				if (end_prn != -1):
-					result += output_line[next_index+9:end_prn] + u'}'
-					index = end_prn+4
-				else:
-					end_prn = output_line.find(u'}', next_index+9)
-					result += output_line[next_index+9:end_prn+1]
-					index = end_prn+1
-		# I assume all the parameter of \epsfxsize comes in one line
-		elif (output_line[next_index:next_index+11] == u"\\epsfxsize="):
-			end_size = read_size(output_line, next_index+11, line_len)
-			if (end_size != -1):
-				last_epsfxsize = output_line[next_index+11:end_size]
-				index = end_size
-			else:
-				index = next_index+11
-			last_epsfxsize_line = line_number
-		# I assume all the parameter of \epsfysize comes in one line
-		elif (output_line[next_index:next_index+11] == u"\\epsfysize="):
-			end_size = read_size(output_line, next_index+11, line_len)
-			if (end_size != -1):
-				last_epsfysize = output_line[next_index+11:end_size]
-				index = end_size
-			else:
-				index = next_index+11
-			last_epsfysize_line = line_number
-		elif (output_line[next_index:next_index+10] == u"\\LR{\\verb*"):
-			end_verb = output_line.find(output_line[next_index+10], next_index+11)
-			verb_param = output_line[next_index+11:end_verb]
-			if (is_alpha_numeric(verb_param)):
-				result += output_line[index:next_index]
-				result += u'\\lr{\\tt{}' + verb_param
-			else:
-				result += output_line[index:end_verb+1]
-			index = end_verb+1
-		elif (output_line[next_index:next_index+9] == u"\\LR{\\verb"):
-			end_verb = output_line.find(output_line[next_index+9], next_index+10)
-			verb_param = output_line[next_index+10:end_verb]
-			if (is_alpha_numeric_space(verb_param)):
-				result += output_line[index:next_index]
-				result += u'\\lr{\\tt{}' + verb_param
-			else:
-				result += output_line[index:end_verb+1]
-			index = end_verb+1
-		elif (output_line[next_index:next_index+6] == u"\\verb*"):
-			end_verb = output_line.find(output_line[next_index+6], next_index+7)
-			result += output_line[index:end_verb+1]
-			index = end_verb+1
-		elif (output_line[next_index:next_index+5] == u"\\verb"):
-			end_verb = output_line.find(output_line[next_index+5], next_index+6)
-			result += output_line[index:end_verb+1]
-			index = end_verb+1
-		elif (output_line[next_index:next_index+9] == u"\\pmatrix{"):
-			result += u'\\ftxepmatrix{'
-			index = next_index+9
-		elif (output_line[next_index:next_index+16] == u"\\begin{document}"):
-			result += u'\\begin{document}\n\\VerbatimFootnotes'
-			index = next_index+16
-		elif (output_line[next_index:next_index+8] == u'\\label {'):
-			begin_param = next_index+8
-			end_param = output_line.find(u'}', begin_param)
-			param = convert_persian_to_english(output_line[begin_param:end_param])
-			result += output_line[index:begin_param-2]
-			result += u'{' + param + u'}'
-			index = end_param+1
-		elif (output_line[next_index:next_index+6] == u'\\ref {'):
-			begin_param = next_index+6
-			end_param = output_line.find(u'}', begin_param)
-			param = convert_persian_to_english(output_line[begin_param:end_param])
-			result += output_line[index:begin_param-2]
-			result += u'{' + param + u'}'
-			index = end_param+1
-		elif (output_line[next_index:next_index+7] == u'\\label{'):
-			begin_param = next_index+7
-			end_param = output_line.find(u'}', begin_param)
-			param = convert_persian_to_english(output_line[begin_param:end_param])
-			result += output_line[index:begin_param]
-			result += param + u'}'
-			index = end_param+1
-		elif (output_line[next_index:next_index+5] == u'\\ref{'):
-			begin_param = next_index+5
-			end_param = output_line.find(u'}', begin_param)
-			param = convert_persian_to_english(output_line[begin_param:end_param])
-			result += output_line[index:begin_param]
-			result += param + u'}'
-			index = end_param+1
-		elif (output_line[next_index:next_index+13] == u'\\multicolumn{'):
-			begin_param = next_index+13
-			end_param = output_line.find(u'}', begin_param)
-			param = convert_persian_to_english(output_line[begin_param:end_param])
-			result += output_line[index:begin_param]
-			result += param + u'}'
-			index = end_param+1
-		elif (output_line[next_index:next_index+12] == u'\\setcounter{'):
-			begin_num = output_line.find(u'{', next_index+12)
-			end_num = output_line.find(u'}', begin_num)
-			num = convert_persian_to_english(output_line[begin_num+1:end_num])
-			result += output_line[index:begin_num+1]
-			result += num + u'}'
-			index = end_num+1
-		elif (output_line[next_index:next_index+14] == u'\\addtocounter{'):
-			begin_num = output_line.find(u'{', next_index+14)
-			end_num = output_line.find(u'}', begin_num)
-			num = convert_persian_to_english(output_line[begin_num+1:end_num])
-			result += output_line[index:begin_num+1]
-			result += num + u'}'
-			index = end_num+1
-		else:
-			result += output_line[index:next_index+2]
-			index = next_index+2
-	#end while
-	return result
-
-###############################################
-# from here all functions are mainly used to
-# convert farsitex format to unicode
-###############################################
-
-def convert_file(f, of, convert_cmds):
-	global state
-	global line_number
-	global last_epsfysize_line
-	global last_epsfxsize_line
-	global last_epsfxsize
-	global last_epsfysize
-	global global_state
-
-	state = 0
-	line_number = 0
-	last_epsfysize_line = 0
-	last_epsfxsize_line = 0
-	last_epsfxsize = u''
-	last_epsfysize = u''
-
-	for line in f:
-		line_number += 1
-		print line_number,
-		output_line = u''
-		line_len = len(line)
-		
-		# remove new-line characters from end of line
-		if (line_len>1 and line[line_len-1] == '\n'):
-			line_len-=1
-		if (line_len>1 and line[line_len-1] == '\r'):
-			line_len-=1
-		
-		# check line-direction character
-		line_direction_rtl = (line[0] == '<')
-		if (line[0] != '>') and (line[0] != '<'):
-			print "FORMAT ERROR AT LINE: " + str(line_number)
-			exit(0)
-	
-		i = 1
-	
-		while (i<line_len):
-			next_part_index = ft_next_part(line, i, line_len)
-			next_part = line[i:next_part_index]
-			next_part_latin = (line[i]<chr(0x80))
-			
-			# see if we should put \lr{...} for the current english expression
-			if (global_state == 0):
-				if line_direction_rtl and next_part_latin:
-					is_command_rtl = (next_part_latin and (i>1) and (line[i-1]==F_SLASH) )
-					is_parameter_rtl = (next_part_latin and (i>1) and (next_part_index<line_len) and (line[i-1]==F_AT_SIGN) and (line[next_part_index]==F_AT_SIGN) )
-					is_math_rtl = (next_part_latin and (line[i]=="$") and (line[next_part_index-1]=="$") )
-					is_verb_parameter = ( (line[i-6:i] == F_SLASH+"verb") and not isalpha(line[i]))
-					is_verb = (next_part_latin and (line[i:i+5]=='\\verb' or line[i:i+6]==' \\verb'))
-					is_english = (next_part_latin and (line[i:i+8]=='\\english'))
-				
-					cmd_index = 0
-					while cmd_index < len(commands):
-						len_cmd = len(commands[cmd_index])+2
-						if ( (i > len_cmd) and (line[i-len_cmd:i] == F_SLASH+commands[cmd_index]+F_PRNT_OPEN) ):
-							break
-						elif ( (i > len_cmd+1) and (line[i-len_cmd-1:i] == F_SLASH+commands[cmd_index]+F_SPACE+F_PRNT_OPEN) ):
-							break
-						cmd_index += 1
-					is_commands_group = cmd_index < len(commands)
-					is_documentstyle_cmd = (line_len > 15) and (line[1:15] == F_SLASH+"documentstyle")
-	
-			if next_part_latin:
-				if (global_state == 0):
-					# whether we should put a \lr{ command
-					if ( line_direction_rtl and not (is_command_rtl or is_parameter_rtl or is_math_rtl or is_commands_group or is_documentstyle_cmd or is_verb_parameter or is_verb or is_english) ):
-						output_line += u'\\lr{'
-					if ( line_direction_rtl and is_verb):
-						output_line += u'\\LR{'
-				
-				# here is the main place that converting happens
-				output_line += next_part.encode( 'utf-8' )
-				
-				if (global_state == 0):
-					# check whether we already used a \lr command: then end it
-					if ( line_direction_rtl and not (is_command_rtl or is_parameter_rtl or is_math_rtl or is_commands_group or is_documentstyle_cmd or is_verb_parameter or is_verb or is_english) ):
-						output_line += u'}'
-					if ( line_direction_rtl and is_verb):
-						output_line += u'}'
-			else:
-				if (global_state == 0):
-					# whether we should put a \rl{} command
-					if ( not line_direction_rtl and not ft_is_all_persian_space(next_part)):
-						output_line += u'\\rl{'
-					
-				# here is the main place that converting happens
-				output_line += map_ft_unicode(next_part)
-				
-				if (global_state == 0):
-					# check whether we already used a \rl command: then end it
-					if (not line_direction_rtl and not ft_is_all_persian_space(next_part)):
-						output_line += u'}'
-					
-			i = next_part_index
-		# end of while			
-
-		#if there was a % commenting then we can return to normal situation
-		if (global_state == 1):
-			global_state = 0
-		
-		# convert some of the FarsiTeX commands to XePersian commands
-		# only if it is requested
-		if (convert_cmds):
-			result = translate_cmds(output_line) 
-		else:
-			result = output_line
-		output_line = result + u'\n'
-		# write the processed line
-		of.write(output_line)
-		# end of line processing
-	# end of file processing
-
-def print_usage():
-	print 'usage: python ftxe-0.9 [-r] [-s] [-x] [-u] in_filename1 in_filename2'
-	print '-r: (DEFAULT) recursively consider files included in the given files'
-	print '-s: do not recursively consider files'
-	print '-x: (DEFAULT) insert xepersian related commands'
-	print '-u: only convert to unicode'
-
-###################################
-# Begin of main body of the program
-###################################
-
-# global variables
-line_number = 0
-last_epsfxsize = u''
-last_epsfxsize_line = 0
-last_epsfysize = u''
-last_epsfysize_line = 0
-state = 0
-global_state = 0
-recursive = 1
-convert_xepersian = 1
-filename = ''
-
-if len(sys.argv) <= 1:
-	print_usage()
-	exit(0)
-
-#find options
-options_index = 1
-while (options_index < len(sys.argv) and sys.argv[options_index][0]=='-'):
-	if (sys.argv[options_index]=='-s'):
-		recursive = 0
-	elif (sys.argv[options_index]=='-u'):
-		convert_xepersian = 0
-	options_index += 1
-
-filenames = []
-while (options_index < len(sys.argv)):
-	filenames.append(sys.argv[options_index])
-	options_index += 1
-
-if (len(filenames) == 0):
-	print 'error: no input filename is specified!'
-	print_usage()
-	exit(0)
-	
-index = 0
-while (index < len(filenames)):
-	filename = filenames[index]
-	index += 1
-
-	outfile = ''
-	if (filename[-4:] != '.tex'):
-		outfile = filename[0:-3] + 'tex'
-	else: 
-		outfile = filename + '.tex'
-
-	print '\n\nConverting "' + filename + '" into "' + outfile + '"'
-	try:
-		f = open(filename, 'r')
-	except IOError:
-		print "Can not open the input file: " + filename
-		exit(0)
-
-	try:
-		of = codecs.open(outfile, encoding='utf-8', mode='w')
-	except IOError:
-		print "Can not open the output file: " + outfile
-		exit(0)
-
-	convert_file(f, of, convert_xepersian)
-
-	of.close()
-	f.close()	



From vafa at mail.berlios.de  Mon Jul  6 15:46:16 2009
From: vafa at mail.berlios.de (vafa at mail.berlios.de)
Date: Mon, 6 Jul 2009 15:46:16 +0200
Subject: [Xepersian-development] r81 - / tags tags/texmf tags/texmf/bibtex
	tags/texmf/bibtex/bst tags/texmf/bibtex/bst/xepersian
	tags/texmf/doc tags/texmf/doc/bidi
	tags/texmf/doc/bidi/examples tags/texmf/doc/xepersian
	tags/texmf/doc/xepersian/Index tags/texmf/doc/xepersian/examples
	tags/texmf/doc/xepersian/examples/bibtex
	tags/texmf/doc/xepersian/farsitex2xepersian tags/texmf/fonts
	tags/texmf/fonts/misc tags/texmf/fonts/misc/xetex
	tags/texmf/fonts/misc/xetex/fontmapping
	tags/texmf/fonts/misc/xetex/fontmapping/xepersian
	tags/texmf/tex tags/texmf/tex/xelatex
	tags/texmf/tex/xelatex/bidi tags/texmf/tex/xelatex/xepersian
	tags/texmf/tex/xelatex/xepersian/img
	tags/texmf/tex/xelatex/xepersian/img/weather
Message-ID: <200907061346.n66DkGEH000557@sheep.berlios.de>

Author: vafa
Date: 2009-07-06 15:43:59 +0200 (Mon, 06 Jul 2009)
New Revision: 81

Added:
   tags/
   tags/texmf-TDS.zip
   tags/texmf/
   tags/texmf/bibtex/
   tags/texmf/bibtex/bst/
   tags/texmf/bibtex/bst/xepersian/
   tags/texmf/bibtex/bst/xepersian/acm-fa.bst
   tags/texmf/bibtex/bst/xepersian/ieeetr-fa.bst
   tags/texmf/bibtex/bst/xepersian/plain-fa.bst
   tags/texmf/bibtex/bst/xepersian/unsrt-fa.bst
   tags/texmf/doc/
   tags/texmf/doc/bidi/
   tags/texmf/doc/bidi/README.txt
   tags/texmf/doc/bidi/bidi.pdf
   tags/texmf/doc/bidi/examples/
   tags/texmf/doc/bidi/examples/beamer-sample.tex
   tags/texmf/doc/bidi/examples/bidicasual-samplecv.tex
   tags/texmf/doc/bidi/examples/bidiclassic-samplecv.tex
   tags/texmf/doc/bidi/examples/bidisample2e.tex
   tags/texmf/doc/bidi/examples/bidismall2e.tex
   tags/texmf/doc/bidi/examples/gull.jpg
   tags/texmf/doc/bidi/examples/presentation-sample.tex
   tags/texmf/doc/bidi/examples/test-bidi.tex
   tags/texmf/doc/bidi/examples/test-supertabular.tex
   tags/texmf/doc/bidi/examples/test-tabular.tex
   tags/texmf/doc/bidi/examples/test-tabularx.tex
   tags/texmf/doc/bidi/examples/test-tabulary.tex
   tags/texmf/doc/bidi/examples/test1-wrapfig.tex
   tags/texmf/doc/bidi/examples/test2-wrapfig.tex
   tags/texmf/doc/bidi/examples/test3-wrapfig.tex
   tags/texmf/doc/xepersian/
   tags/texmf/doc/xepersian/Index/
   tags/texmf/doc/xepersian/Index/persian.xdy
   tags/texmf/doc/xepersian/README.txt
   tags/texmf/doc/xepersian/examples/
   tags/texmf/doc/xepersian/examples/bibtex/
   tags/texmf/doc/xepersian/examples/bibtex/MyReferences.bib
   tags/texmf/doc/xepersian/examples/bibtex/acm-fa-output.tex
   tags/texmf/doc/xepersian/examples/bibtex/bibtex-example.tex
   tags/texmf/doc/xepersian/examples/bibtex/ieeetr-fa-output.tex
   tags/texmf/doc/xepersian/examples/bibtex/plain-fa-output.tex
   tags/texmf/doc/xepersian/examples/logo.pdf
   tags/texmf/doc/xepersian/examples/magazine-sample.tex
   tags/texmf/doc/xepersian/examples/test-correction.tex
   tags/texmf/doc/xepersian/examples/test-empty-form.tex
   tags/texmf/doc/xepersian/examples/test-question-only.tex
   tags/texmf/doc/xepersian/examples/test-solution-form.tex
   tags/texmf/doc/xepersian/examples/thesis-sample.tex
   tags/texmf/doc/xepersian/farsitex2xepersian/
   tags/texmf/doc/xepersian/farsitex2xepersian/ftxe-0.10.py
   tags/texmf/doc/xepersian/xepersian.pdf
   tags/texmf/fonts/
   tags/texmf/fonts/misc/
   tags/texmf/fonts/misc/xetex/
   tags/texmf/fonts/misc/xetex/fontmapping/
   tags/texmf/fonts/misc/xetex/fontmapping/xepersian/
   tags/texmf/fonts/misc/xetex/fontmapping/xepersian/parsidigits.map
   tags/texmf/fonts/misc/xetex/fontmapping/xepersian/parsidigits.tec
   tags/texmf/fonts/misc/xetex/fontmapping/xepersian/txt2maths.map
   tags/texmf/fonts/misc/xetex/fontmapping/xepersian/txt2maths.tec
   tags/texmf/tex/
   tags/texmf/tex/xelatex/
   tags/texmf/tex/xelatex/bidi/
   tags/texmf/tex/xelatex/bidi/amsart-bidi.def
   tags/texmf/tex/xelatex/bidi/amsbook-bidi.def
   tags/texmf/tex/xelatex/bidi/amsthm-bidi.def
   tags/texmf/tex/xelatex/bidi/array-bidi.def
   tags/texmf/tex/xelatex/bidi/article-bidi.def
   tags/texmf/tex/xelatex/bidi/beamer-bidi.def
   tags/texmf/tex/xelatex/bidi/beamerthemebidiJLTree.sty
   tags/texmf/tex/xelatex/bidi/bibitem.pdf
   tags/texmf/tex/xelatex/bidi/bidi.sty
   tags/texmf/tex/xelatex/bidi/bidi2in1.sty
   tags/texmf/tex/xelatex/bidi/bidicode.sty
   tags/texmf/tex/xelatex/bidi/bidimemoir.cls
   tags/texmf/tex/xelatex/bidi/bidimoderncv.cls
   tags/texmf/tex/xelatex/bidi/bidipresentation.cls
   tags/texmf/tex/xelatex/bidi/book-bidi.def
   tags/texmf/tex/xelatex/bidi/bookest-bidi.def
   tags/texmf/tex/xelatex/bidi/cvthemebidicasual.sty
   tags/texmf/tex/xelatex/bidi/cvthemebidiclassic.sty
   tags/texmf/tex/xelatex/bidi/draftwatermark-bidi.def
   tags/texmf/tex/xelatex/bidi/extbook-bidi.def
   tags/texmf/tex/xelatex/bidi/fancyhdr-bidi.def
   tags/texmf/tex/xelatex/bidi/footnote-bidi.def
   tags/texmf/tex/xelatex/bidi/graphicx-bidi.def
   tags/texmf/tex/xelatex/bidi/listings-bidi.def
   tags/texmf/tex/xelatex/bidi/longtable-bidi.def
   tags/texmf/tex/xelatex/bidi/minitoc-bidi.def
   tags/texmf/tex/xelatex/bidi/pdfpages-bidi.def
   tags/texmf/tex/xelatex/bidi/picture.jpg
   tags/texmf/tex/xelatex/bidi/pstricks-bidi.def
   tags/texmf/tex/xelatex/bidi/ragged2e-bidi.def
   tags/texmf/tex/xelatex/bidi/rapport3-bidi.def
   tags/texmf/tex/xelatex/bidi/refrep-bidi.def
   tags/texmf/tex/xelatex/bidi/report-bidi.def
   tags/texmf/tex/xelatex/bidi/scrartcl-bidi.def
   tags/texmf/tex/xelatex/bidi/scrbook-bidi.def
   tags/texmf/tex/xelatex/bidi/scrreprt-bidi.def
   tags/texmf/tex/xelatex/bidi/stabular-bidi.def
   tags/texmf/tex/xelatex/bidi/tabls-bidi.def
   tags/texmf/tex/xelatex/bidi/tikz-bidi.def
   tags/texmf/tex/xelatex/bidi/tocloft-bidi.def
   tags/texmf/tex/xelatex/bidi/tocstyle-bidi.def
   tags/texmf/tex/xelatex/bidi/wrapfig-bidi.def
   tags/texmf/tex/xelatex/bidi/xltxtra-bidi.def
   tags/texmf/tex/xelatex/xepersian/
   tags/texmf/tex/xelatex/xepersian/algorithm-xepersian.def
   tags/texmf/tex/xelatex/xepersian/algorithmic-xepersian.def
   tags/texmf/tex/xelatex/xepersian/amsart-xepersian.def
   tags/texmf/tex/xelatex/xepersian/amsbook-xepersian.def
   tags/texmf/tex/xelatex/xepersian/article-xepersian.def
   tags/texmf/tex/xelatex/xepersian/backref-xepersian.def
   tags/texmf/tex/xelatex/xepersian/beamer-xepersian.def
   tags/texmf/tex/xelatex/xepersian/bidimemoir-xepersian.def
   tags/texmf/tex/xelatex/xepersian/bidimoderncv-xepersian.def
   tags/texmf/tex/xelatex/xepersian/book-xepersian.def
   tags/texmf/tex/xelatex/xepersian/bookest-xepersian.def
   tags/texmf/tex/xelatex/xepersian/commands-ltx.def
   tags/texmf/tex/xelatex/xepersian/commands-xepersian.def
   tags/texmf/tex/xelatex/xepersian/enumerate-xepersian.def
   tags/texmf/tex/xelatex/xepersian/environments-ltx.def
   tags/texmf/tex/xelatex/xepersian/environments-xepersian.def
   tags/texmf/tex/xelatex/xepersian/extbook-xepersian.def
   tags/texmf/tex/xelatex/xepersian/footnote-bidi-xepersian.def
   tags/texmf/tex/xelatex/xepersian/img/
   tags/texmf/tex/xelatex/xepersian/img/ireland.jpg
   tags/texmf/tex/xelatex/xepersian/img/weather/
   tags/texmf/tex/xelatex/xepersian/img/weather/clouds.jpg
   tags/texmf/tex/xelatex/xepersian/img/weather/rain.jpg
   tags/texmf/tex/xelatex/xepersian/img/weather/sun.jpg
   tags/texmf/tex/xelatex/xepersian/kashida-xepersian.def
   tags/texmf/tex/xelatex/xepersian/listings-xepersian.def
   tags/texmf/tex/xelatex/xepersian/localise-xepersian.def
   tags/texmf/tex/xelatex/xepersian/minitoc-xepersian.def
   tags/texmf/tex/xelatex/xepersian/misccommandsenvironments-ltx.def
   tags/texmf/tex/xelatex/xepersian/rapport3-xepersian.def
   tags/texmf/tex/xelatex/xepersian/refrep-xepersian.def
   tags/texmf/tex/xelatex/xepersian/report-xepersian.def
   tags/texmf/tex/xelatex/xepersian/scrartcl-xepersian.def
   tags/texmf/tex/xelatex/xepersian/scrbook-xepersian.def
   tags/texmf/tex/xelatex/xepersian/scrreprt-xepersian.def
   tags/texmf/tex/xelatex/xepersian/tocloft-xepersian.def
   tags/texmf/tex/xelatex/xepersian/xepersian-magazine.cls
   tags/texmf/tex/xelatex/xepersian/xepersian-mathsdigitspec.sty
   tags/texmf/tex/xelatex/xepersian/xepersian-multiplechoice.sty
   tags/texmf/tex/xelatex/xepersian/xepersian-persiancal.sty
   tags/texmf/tex/xelatex/xepersian/xepersian-thesis-xepersian.def
   tags/texmf/tex/xelatex/xepersian/xepersian-thesis.cls
   tags/texmf/tex/xelatex/xepersian/xepersian.sty
Log:
addind TDS for non-technical users

Added: tags/texmf/bibtex/bst/xepersian/acm-fa.bst
===================================================================
--- tags/texmf/bibtex/bst/xepersian/acm-fa.bst	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/bibtex/bst/xepersian/acm-fa.bst	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,1357 @@
+%%
+%% This is file `acm-fa.bst',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% xepersian.dtx  (with options: `acm-fa.bst')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2008-2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
+%% Bib. style "acm-fa", Persian (farsi)  version of acm.bst
+%%
+%% by: Mahmood Amintoosi and Mostafa Vahedi
+%% For XePersian, a Persian Typsetting Package in XeTeX, Developed by:
+%% Vafa Khalighi, Mehdi Omidali and Mostafa Vahedi
+%% 2009/02/12
+%% It may be distributed and/or modified under the
+%% conditions of the LaTeX Project Public License, either this version
+%% of this license or (at your option) any later version.
+%%
+%% NOTE: Its output for English references may has a bit difference with acm.bst, for pure English texts please use acm.bst
+%%
+%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
+%% Original Copyright of acm.bst
+
+
+ENTRY
+  { address
+    author
+    booktitle
+    chapter
+    edition
+    editor
+    howpublished
+    institution
+    journal
+    key
+language
+    month
+    note
+    number
+    organization
+    pages
+    publisher
+    school
+    series
+    title
+translator
+    type
+    volume
+    year
+  }
+  {}
+  { label }
+
+INTEGERS { output.state before.all mid.sentence after.sentence after.block }
+STRINGS {bbl.and bbl.etal bbl.editors bbl.editor bbl.edition bbl.volume bbl.of bbl.number
+ bbl.in bbl.pages bbl.page bbl.chapter bbl.series bbl.techrep bbl.mthesis bbl.phdthesis
+ bbl.translator}% bbl.formatnames}
+FUNCTION {is.print.banners.to.terminal} { #1 }
+%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
+%% FILE VERSION AND BANNER %%
+%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
+
+FUNCTION{bst.file.version} { "0.3" }
+FUNCTION{bst.file.date} { "2009/02/12" }
+FUNCTION{bst.file.website} { "http://developer.berlios.de/projects/xepersian" }
+FUNCTION{bst.file.authors} {"M.Amintoosi and M.Vahedi" }
+
+FUNCTION {banner.message}
+{ is.print.banners.to.terminal
+     { "-- acm-fa.bst version" " " * bst.file.version *
+       " (" * bst.file.date * ") " * %"by " * bst.file.authors *
+       top$
+       "-- This is a BibTeX style for XePersian: " bst.file.website *
+       %top$
+       %"-- See the " quote$ * "xepersian_bibtex_userguide.pdf" * quote$ * " manual for usage information." *
+       top$
+     }
+     { skip$ }
+   if$
+}
+
+FUNCTION {completed.message}
+{ is.print.banners.to.terminal
+     { ""
+       top$
+       "Done."
+       top$
+     }
+     { skip$ }
+   if$
+}
+
+%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
+%% Persian Functions    %%
+%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
+
+FUNCTION {fa.isPersianLanguage}
+{
+  language missing$
+    {#0}
+    {language "l" change.case$ "persian" =}
+  if$
+}
+
+FUNCTION {keywords.fa}
+{
+  " ?? "  'bbl.and  :=
+  " ?? ????????????"  'bbl.etal  :=
+  " ???????????????????? "  'bbl.editors  :=
+  " ??????????????????? "  'bbl.editor  :=
+  " ???????????? "  'bbl.edition    :=
+  " ?????? "  'bbl.volume :=
+  " ???? "  'bbl.of :=
+  " ?????????? "  'bbl.number :=
+  " ???? "  'bbl.in  :=
+  " ?????????? "  'bbl.pages  :=
+  " ??."  'bbl.page  :=
+  " ?????? "  'bbl.chapter :=
+  " ?????? " 'bbl.series :=
+  " ?????????? ?????? ????????????" 'bbl.techrep :=
+  " ????????????????????? ???????????????????????????" 'bbl.mthesis  :=
+  " ????????????????????? ??????????"  'bbl.phdthesis :=
+  " ??????????????? " 'bbl.translator :=
+}
+
+FUNCTION {keywords.en}
+{
+  " and "  'bbl.and  :=
+  " et~al."  'bbl.etal  :=
+  " Eds."  'bbl.editors  :=
+  " Ed."  'bbl.editor  :=
+  " Ed."  'bbl.edition    :=
+  " Vol."  'bbl.volume :=
+  " of "  'bbl.of :=
+  " No."  'bbl.number :=
+  " In "  'bbl.in  :=
+  " pp."  'bbl.pages  :=
+  " p."  'bbl.page  :=
+  " Ch."  'bbl.chapter :=
+  " Ser." 'bbl.series :=
+  " Tech. Rep." 'bbl.techrep :=
+  " Master's thesis" 'bbl.mthesis  :=
+  " Ph.D. thesis"  'bbl.phdthesis :=
+  " Translator " 'bbl.translator :=
+  %"{vv~}{ll}{, jj}{, f.}"   'bbl.formatnames :=
+}
+
+%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
+%% End of Persian Functions %%
+%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
+
+FUNCTION {init.state.consts}
+{ #0 'before.all :=
+  #1 'mid.sentence :=
+  #2 'after.sentence :=
+  #3 'after.block :=
+}
+
+STRINGS { s t }
+
+FUNCTION {output.nonnull}
+{ 's :=
+  output.state mid.sentence =
+    { ", " * write$ }
+    { output.state after.block =
+{ add.period$ write$
+  newline$
+  "\newblock " write$
+}
+{ output.state before.all =
+    'write$
+    { add.period$ " " * write$ }
+  if$
+}
+      if$
+      mid.sentence 'output.state :=
+    }
+  if$
+  s
+}
+
+FUNCTION {output}
+{ duplicate$ empty$
+    'pop$
+    'output.nonnull
+  if$
+}
+
+FUNCTION {output.check}
+{ 't :=
+  duplicate$ empty$
+    { pop$ "empty " t * " in " * cite$ * warning$ }
+    'output.nonnull
+  if$
+}
+
+FUNCTION {output.bibitem}
+{
+  newline$
+  fa.isPersianLanguage
+    { keywords.fa
+  "\Persian" write$
+      newline$ }
+    { keywords.en
+  "\Latin" write$
+      newline$ }
+  if$
+  "\bibitem{" write$
+  cite$ write$
+  "}" write$
+  newline$
+  ""
+  before.all 'output.state :=
+}
+
+FUNCTION {fin.entry}
+{ add.period$
+  write$
+  newline$
+}
+
+FUNCTION {new.block}
+{ output.state before.all =
+    'skip$
+    { after.block 'output.state := }
+  if$
+}
+
+FUNCTION {new.sentence}
+{ output.state after.block =
+    'skip$
+    { output.state before.all =
+'skip$
+{ after.sentence 'output.state := }
+      if$
+    }
+  if$
+}
+
+FUNCTION {not}
+{   { #0 }
+    { #1 }
+  if$
+}
+
+FUNCTION {and}
+{   'skip$
+    { pop$ #0 }
+  if$
+}
+
+FUNCTION {or}
+{   { pop$ #1 }
+    'skip$
+  if$
+}
+
+FUNCTION {new.block.checka}
+{ empty$
+    'skip$
+    'new.block
+  if$
+}
+
+FUNCTION {new.block.checkb}
+{ empty$
+  swap$ empty$
+  and
+    'skip$
+    'new.block
+  if$
+}
+
+FUNCTION {new.sentence.checka}
+{ empty$
+    'skip$
+    'new.sentence
+  if$
+}
+
+FUNCTION {new.sentence.checkb}
+{ empty$
+  swap$ empty$
+  and
+    'skip$
+    'new.sentence
+  if$
+}
+
+FUNCTION {field.or.null}
+{ duplicate$ empty$
+    { pop$ "" }
+    'skip$
+  if$
+}
+
+FUNCTION {emphasize}
+{ duplicate$ empty$
+    { pop$ "" }
+    { "{\em " swap$ * "}" * }
+  if$
+}
+
+FUNCTION {emphasizeic}
+{ duplicate$ empty$
+    { pop$ "" }
+    { "{\em " swap$ * "\/}" * }
+  if$
+}
+
+FUNCTION {scapify}
+{ duplicate$ empty$
+    { pop$ "" }
+    { "\textsc{ " swap$ * "}" * }
+  if$
+}
+
+INTEGERS { nameptr namesleft numnames }
+
+FUNCTION {format.names}
+{ 's :=
+  #1 'nameptr :=
+  s num.names$ 'numnames :=
+  numnames 'namesleft :=
+    { namesleft #0 > }
+    {fa.isPersianLanguage
+        { s nameptr "{vv~}{ll}{, jj}{, ff}" format.name$ 't :=}
+        { s nameptr "{vv~}{ll}{, jj}{, f.}" format.name$ 't :=}
+      if$
+     nameptr #1 >
+{ namesleft #1 >
+    { ", " * t * }
+    { t "others" =
+{ ","  bbl.etal * * }
+{ ","  bbl.and  * * t * }
+      if$
+    }
+  if$
+}
+'t
+      if$
+      nameptr #1 + 'nameptr :=
+      namesleft #1 - 'namesleft :=
+    }
+  while$
+}
+
+FUNCTION {format.innames}
+{ 's :=
+  #1 'nameptr :=
+  s num.names$ 'numnames :=
+  numnames 'namesleft :=
+    { namesleft #0 > }
+    {fa.isPersianLanguage
+        {s nameptr "{ff}{vv~}{ll}{, jj}" format.name$ 't :=}
+        {s nameptr "{f.~}{vv~}{ll}{, jj}" format.name$ 't :=}
+      if$
+       nameptr #1 >
+{ namesleft #1 >
+    { ", " * t * }
+    { numnames #2 >
+{ "," * }
+'skip$
+      if$
+      t "others" =
+{ bbl.etal * }
+{ bbl.and * t * }
+      if$
+    }
+  if$
+}
+'t
+      if$
+      nameptr #1 + 'nameptr :=
+      namesleft #1 - 'namesleft :=
+    }
+  while$
+}
+
+FUNCTION {format.authors}
+{ author empty$
+    { "" }
+    { author format.names  scapify}
+  if$
+}
+
+FUNCTION {format.editors}
+{ editor empty$
+    { "" }
+    { fa.isPersianLanguage
+    {
+editor num.names$ #1 >
+{bbl.editors editor format.names * }
+{bbl.editor editor format.names * }
+if$
+}
+{
+  editor format.names scapify
+editor num.names$ #1 >
+{ ", " bbl.editors * *}
+{ ", " bbl.editor * *}
+if$
+}
+  if$
+    }
+  if$
+}
+
+FUNCTION {format.ineditors}
+{ editor empty$
+    { "" }
+    { editor format.innames
+      editor num.names$ #1 >
+{ ", " * bbl.editors *}
+{ ", " * bbl.editor *}
+      if$
+    }
+  if$
+}
+
+FUNCTION {format.translators}
+{ translator empty$
+    { "" }
+    { fa.isPersianLanguage
+    {
+bbl.translator translator format.names *
+}
+{
+  translator format.names
+", " bbl.translator * *
+}
+  if$
+    }
+  if$
+}
+
+FUNCTION {format.title}
+{ title empty$
+    { "" }
+    { title "t" change.case$ }
+  if$
+}
+
+FUNCTION {n.dashify}
+{ 't :=
+  ""
+    { t empty$ not }
+    { t #1 #1 substring$ "-" =
+{ t #1 #2 substring$ "--" = not
+    { "--" *
+      t #2 global.max$ substring$ 't :=
+    }
+    {   { t #1 #1 substring$ "-" = }
+{ "-" *
+  t #2 global.max$ substring$ 't :=
+}
+      while$
+    }
+  if$
+}
+{ t #1 #1 substring$ *
+  t #2 global.max$ substring$ 't :=
+}
+      if$
+    }
+  while$
+}
+
+FUNCTION {format.date}
+{ year empty$
+    { month empty$
+{ "" }
+{ "there's a month but no year in " cite$ * warning$
+  month
+}
+      if$
+    }
+    { month empty$
+'year
+{ month " " * year * }
+      if$
+    }
+  if$
+}
+
+FUNCTION {format.btitle}
+{ title emphasize
+}
+
+FUNCTION {tie.or.space.connect}
+{ duplicate$ text.length$ #3 <
+    { "~" }
+    { " " }
+  if$
+  swap$ * *
+}
+
+FUNCTION {either.or.check}
+{ empty$
+    'pop$
+    { "can't use both " swap$ * " fields in " * cite$ * warning$ }
+  if$
+}
+
+FUNCTION {format.bvolume}
+{ volume empty$
+    { "" }
+    { "volume" volume tie.or.space.connect
+      series empty$
+'skip$
+{ " of " * series emphasize * }
+      if$
+      "volume and number" number either.or.check
+    }
+  if$
+}
+
+FUNCTION {format.number.series}
+{ volume empty$
+    { number empty$
+{ series field.or.null }
+{ output.state mid.sentence =
+    { bbl.number }
+    { bbl.number "t" change.case$ }
+  if$
+  number tie.or.space.connect
+  series empty$
+    { "there's a number but no series in " cite$ * warning$ }
+    { bbl.in * series * }
+  if$
+}
+      if$
+    }
+    { "" }
+  if$
+}
+
+FUNCTION {format.edition}
+{ edition empty$
+    { "" }
+    { fa.isPersianLanguage
+    {
+   bbl.edition edition *
+}
+{
+      output.state mid.sentence =
+       { edition "l" change.case$ bbl.edition * }
+       { edition "t" change.case$ bbl.edition * }
+          if$
+}
+  if$
+    }
+  if$
+}
+
+FUNCTION {format.pages}
+{ pages empty$
+    { "" }
+    { pages n.dashify }
+  if$
+}
+
+INTEGERS { multiresult }
+
+FUNCTION {multi.page.check}
+{ 't :=
+  #0 'multiresult :=
+    { multiresult not
+      t empty$ not
+      and
+    }
+    { t #1 #1 substring$
+      duplicate$ "-" =
+      swap$ duplicate$ "," =
+      swap$ "+" =
+      or or
+{ #1 'multiresult := }
+{ t #2 global.max$ substring$ 't := }
+      if$
+    }
+  while$
+  multiresult
+}
+
+FUNCTION {format.pp.pages}
+{ pages empty$
+    { "" }
+    { pages multi.page.check
+   { bbl.pages pages n.dashify tie.or.space.connect }
+   { bbl.page pages tie.or.space.connect }
+      if$
+    }
+  if$
+}
+
+FUNCTION {format.journal.vol.num.date}
+{ journal empty$
+    { "empty journal in " cite$ * warning$
+      ""
+    }
+    { journal
+      volume empty$
+'skip$
+{ " " * volume * }
+      if$
+      number empty$
+'emphasizeic
+{ emphasize ", " * number * }
+      if$
+      year empty$
+{ "empty year in " cite$ * warning$ }
+{ " (" * format.date * ")" * }
+      if$
+    }
+  if$
+}
+
+FUNCTION {format.chapter.pages}
+{ chapter empty$
+    'format.pp.pages
+    { type empty$
+{ bbl.chapter }
+{ type "l" change.case$ }
+      if$
+      chapter tie.or.space.connect
+      pages empty$
+'skip$
+{ ", " * format.pp.pages * }
+      if$
+    }
+  if$
+}
+
+FUNCTION {format.in.ed.booktitle}
+{
+  booktitle empty$
+    { "" }
+    {bbl.in booktitle emphasize *
+      editor empty$
+'skip$
+{ ", " * format.ineditors * }
+      if$
+    }
+  if$
+}
+
+FUNCTION {format.proc.date}
+{ duplicate$ empty$
+    { pop$ "" }
+    { year empty$
+{ "empty year in " cite$ * warning$
+  address empty$
+    'emphasize
+    { emphasizeic
+      " (" * address * ")" *
+    }
+  if$
+}
+{ emphasizeic
+  " (" *
+  address empty$
+    'skip$
+    { address * ", " * }
+  if$
+  format.date *
+  ")" *
+}
+      if$
+    }
+  if$
+}
+
+FUNCTION {format.in.proc.date}
+{ booktitle empty$
+    { "" }
+    { bbl.in booktitle format.proc.date * }
+  if$
+}
+FUNCTION {empty.misc.check}
+{ author empty$ title empty$ howpublished empty$
+  month empty$ year empty$ note empty$
+  and and and and and
+  key empty$ not and
+    { "all relevant fields are empty in " cite$ * warning$ }
+    'skip$
+  if$
+}
+
+FUNCTION {format.thesis.type}
+{ type empty$
+    'skip$
+    { pop$
+      type "t" change.case$
+    }
+  if$
+}
+
+FUNCTION {format.tr.number}
+{ type empty$
+    { bbl.techrep }
+    'type
+  if$
+  number empty$
+    { "t" change.case$ }
+    { number tie.or.space.connect }
+  if$
+}
+
+FUNCTION {format.article.crossref}
+{ key empty$
+    { journal empty$
+{ "need key or journal for " cite$ * " to crossref " * crossref *
+  warning$
+  ""
+}
+{ bbl.in "{\em "  * journal * "\/}" * }
+      if$
+    }
+    { bbl.in key * }
+  if$
+  " \cite{" * crossref * "}" *
+}
+
+FUNCTION {format.crossref.editor}
+{ editor #1 "{vv~}{ll}" format.name$
+  editor num.names$ duplicate$  #2 >
+    { pop$ bbl.etal * }
+    { #2 < 'skip$
+    { editor #2 "{ff }{vv }{ll}{ jj}" format.name$ "others" =
+      { bbl.etal * }
+      { bbl.and * editor #2 "{vv~}{ll}" format.name$ * }
+    if$
+    }
+    if$
+    }
+  if$
+}
+
+FUNCTION {format.book.crossref}
+{ volume empty$
+    { "empty volume in " cite$ * "'s crossref of " * crossref * warning$
+      bbl.in
+    }
+    { bbl.volume volume tie.or.space.connect
+      bbl.of *
+    }
+  if$
+  editor empty$
+  editor field.or.null author field.or.null =
+  or
+    { key empty$
+{ series empty$
+    { "need editor, key, or series for " cite$ * " to crossref " *
+      crossref * warning$
+      "" *
+    }
+    { "{\em " * series * "\/}" * }
+  if$
+}
+{ key * }
+      if$
+    }
+    { format.crossref.editor * }
+  if$
+  " \cite{" * crossref * "}" *
+}
+
+FUNCTION {format.incoll.inproc.crossref}
+{ editor empty$
+  editor field.or.null author field.or.null =
+  or
+    { key empty$
+{ booktitle empty$
+    { "need editor, key, or booktitle for " cite$ * " to crossref " *
+      crossref * warning$
+      ""
+    }
+    { bbl.in " {\em " * booktitle * "\/}" * }
+  if$
+}
+{ bbl.in key * }
+      if$
+    }
+    { bbl.in format.crossref.editor * }
+  if$
+  " \cite{" * crossref * "}" *
+}
+
+FUNCTION {article}
+{ output.bibitem
+  format.authors "author" output.check
+  new.block
+  format.title "title" output.check
+  new.block
+  crossref missing$
+    { format.journal.vol.num.date output
+      format.pages output
+    }
+    { format.article.crossref output.nonnull
+      format.pp.pages output
+    }
+  if$
+  new.block
+  note output
+  fin.entry
+}
+
+FUNCTION {book}
+{ output.bibitem
+  fa.isPersianLanguage
+  {
+format.authors  output
+    new.block
+    format.btitle "title" output.check
+    format.edition output
+new.block
+    format.translators output
+format.editors  output
+  }
+  { author empty$
+      { format.editors "author and editor" output.check }
+      { format.authors output.nonnull
+        crossref missing$
+      { "author and editor" editor either.or.check }
+      'skip$
+        if$
+      }
+    if$
+    new.block
+    format.btitle "title" output.check
+    format.edition output
+  }
+  if$
+  crossref missing$
+    { format.bvolume output
+      new.block
+      format.number.series output
+      new.sentence
+      publisher "publisher" output.check
+      address output
+    }
+    { new.block
+      format.book.crossref output.nonnull
+    }
+  if$
+  format.date "year" output.check
+  new.block
+  note output
+  fin.entry
+}
+
+FUNCTION {booklet}
+{ output.bibitem
+  format.authors output
+  new.block
+  format.title "title" output.check
+  howpublished address new.block.checkb
+  howpublished output
+  address output
+  format.date output
+  new.block
+  note output
+  fin.entry
+}
+
+FUNCTION {inbook}
+{ output.bibitem
+  author empty$
+    { format.editors "author and editor" output.check }
+    { format.authors output.nonnull
+      crossref missing$
+{ "author and editor" editor either.or.check }
+'skip$
+      if$
+    }
+  if$
+  new.block
+  format.btitle "title" output.check
+  format.edition output
+  crossref missing$
+    { format.bvolume output
+      new.block
+      format.number.series output
+      new.sentence
+      publisher "publisher" output.check
+      address output
+    }
+    {
+      new.block
+      format.book.crossref output.nonnull
+    }
+  if$
+  format.date "year" output.check
+  format.chapter.pages "chapter and pages" output.check
+  new.block
+  note output
+  fin.entry
+}
+
+FUNCTION {incollection}
+{ output.bibitem
+  format.authors "author" output.check
+  new.block
+  format.title "title" output.check
+  new.block
+  crossref missing$
+    { format.in.ed.booktitle "booktitle" output.check
+      format.edition output
+      format.bvolume output
+      format.number.series output
+      new.sentence
+      publisher "publisher" output.check
+      address output
+      format.date "year" output.check
+    }
+    { format.incoll.inproc.crossref output.nonnull
+    }
+  if$
+  format.chapter.pages output
+  new.block
+  note output
+  fin.entry
+}
+
+FUNCTION {inproceedings}
+{ output.bibitem
+  format.authors "author" output.check
+  new.block
+  format.title "title" output.check
+  new.block
+  crossref missing$
+    { format.in.proc.date "booktitle" output.check
+      format.ineditors output
+      format.bvolume output
+      format.number.series output
+  organization output
+  publisher output
+}
+    { format.incoll.inproc.crossref output.nonnull  }
+  if$
+  format.pp.pages output
+  new.block
+  note output
+  fin.entry
+}
+
+FUNCTION {conference} { inproceedings }
+
+FUNCTION {manual}
+{ output.bibitem
+  author empty$
+    { organization scapify output }
+    { format.authors output.nonnull }
+  if$
+  new.block
+  format.btitle "title" output.check
+  format.edition output
+  author empty$
+{ address new.block.checka }
+    { organization address new.block.checkb
+      organization output
+    }
+  if$
+  address output
+  format.date output
+  new.block
+  note output
+  fin.entry
+}
+
+FUNCTION {mastersthesis}
+{ output.bibitem
+  format.authors "author" output.check
+  new.block
+  format.title "title" output.check
+  new.block
+  bbl.mthesis
+  format.thesis.type output.nonnull
+  school "school" output.check
+  address output
+  format.date "year" output.check
+  new.block
+  note output
+  fin.entry
+}
+
+FUNCTION {misc}
+{ output.bibitem
+  format.authors output
+  title howpublished new.block.checkb
+  format.title output
+  howpublished new.block.checka
+  howpublished output
+  format.date output
+  new.block
+  note output
+  fin.entry
+  empty.misc.check
+}
+
+FUNCTION {phdthesis}
+{ output.bibitem
+  format.authors "author" output.check
+  new.block
+  format.btitle "title" output.check
+  new.block
+  bbl.phdthesis
+  format.thesis.type output.nonnull
+  school "school" output.check
+  address output
+  format.date "year" output.check
+  new.block
+  note output
+  fin.entry
+}
+
+FUNCTION {proceedings}
+{ output.bibitem
+  editor empty$
+    { organization scapify output }
+    { format.editors output.nonnull }
+  if$
+  new.block
+  title format.proc.date "title" output.check
+  format.bvolume output
+  format.number.series output
+  editor empty$
+'skip$
+{ organization output }
+  if$
+  publisher output
+  new.block
+  note output
+  fin.entry
+}
+
+FUNCTION {techreport}
+{ output.bibitem
+  format.authors "author" output.check
+  new.block
+  format.title "title" output.check
+  new.block
+  format.tr.number output.nonnull
+  institution "institution" output.check
+  address output
+  format.date "year" output.check
+  new.block
+  note output
+  fin.entry
+}
+
+FUNCTION {unpublished}
+{ output.bibitem
+  format.authors "author" output.check
+  new.block
+  format.title "title" output.check
+  new.block
+  note "note" output.check
+  format.date output
+  fin.entry
+}
+
+FUNCTION {default.type} { misc }
+
+MACRO {jan} {"Jan."}
+
+MACRO {feb} {"Feb."}
+
+MACRO {mar} {"Mar."}
+
+MACRO {apr} {"Apr."}
+
+MACRO {may} {"May"}
+
+MACRO {jun} {"June"}
+
+MACRO {jul} {"July"}
+
+MACRO {aug} {"Aug."}
+
+MACRO {sep} {"Sept."}
+
+MACRO {oct} {"Oct."}
+
+MACRO {nov} {"Nov."}
+
+MACRO {dec} {"Dec."}
+
+MACRO {acmcs} {"ACM Comput. Surv."}
+
+MACRO {acta} {"Acta Inf."}
+
+MACRO {cacm} {"Commun. ACM"}
+
+MACRO {ibmjrd} {"IBM J. Res. Dev."}
+
+MACRO {ibmsj} {"IBM Syst.~J."}
+
+MACRO {ieeese} {"IEEE Trans. Softw. Eng."}
+
+MACRO {ieeetc} {"IEEE Trans. Comput."}
+
+MACRO {ieeetcad}
+ {"IEEE Trans. Comput.-Aided Design Integrated Circuits"}
+
+MACRO {ipl} {"Inf. Process. Lett."}
+
+MACRO {jacm} {"J.~ACM"}
+
+MACRO {jcss} {"J.~Comput. Syst. Sci."}
+
+MACRO {scp} {"Sci. Comput. Programming"}
+
+MACRO {sicomp} {"SIAM J. Comput."}
+
+MACRO {tocs} {"ACM Trans. Comput. Syst."}
+
+MACRO {tods} {"ACM Trans. Database Syst."}
+
+MACRO {tog} {"ACM Trans. Gr."}
+
+MACRO {toms} {"ACM Trans. Math. Softw."}
+
+MACRO {toois} {"ACM Trans. Office Inf. Syst."}
+
+MACRO {toplas} {"ACM Trans. Program. Lang. Syst."}
+
+MACRO {tcs} {"Theoretical Comput. Sci."}
+
+READ
+
+FUNCTION {sortify}
+{
+  fa.isPersianLanguage
+    { "l" change.case$}
+    {purify$ "l" change.case$}
+  if$
+  %duplicate$ write$
+}
+
+INTEGERS { len }
+
+FUNCTION {chop.word}
+{ 's :=
+  'len :=
+  s #1 len substring$ =
+    { s len #1 + global.max$ substring$ }
+    's
+  if$
+}
+
+FUNCTION {sort.format.names}
+{ 's :=
+  #1 'nameptr :=
+  ""
+  s num.names$ 'numnames :=
+  numnames 'namesleft :=
+    { namesleft #0 > }
+      { nameptr #1 >
+    { "   " * }
+    'skip$
+      if$
+      s nameptr "{vv{ } }{ll{ }}{  ff{ }}{  jj{ }}" format.name$ 't :=
+      nameptr numnames = t "others" = and
+   { bbl.etal * }
+   { t sortify * }
+      if$
+  nameptr #1 + 'nameptr :=
+      namesleft #1 - 'namesleft :=
+    }
+  while$
+}
+
+FUNCTION {sort.format.title}
+{ 't :=
+  "A " #2
+    "An " #3
+      "The " #4 t chop.word
+    chop.word
+  chop.word
+  sortify
+  #1 global.max$ substring$
+}
+
+FUNCTION {author.sort}
+{ author empty$
+    { key empty$
+    { "to sort, need author or key in " cite$ * warning$
+     ""
+    }
+    { key sortify }
+      if$
+    }
+    { author sort.format.names }
+  if$
+}
+
+FUNCTION {author.editor.sort}
+{ author empty$
+    { editor empty$
+{ key empty$
+    { "to sort, need author, editor, or key in " cite$ * warning$
+      ""
+    }
+    { key sortify }
+  if$
+}
+{ editor sort.format.names }
+      if$
+    }
+    { author sort.format.names }
+  if$
+}
+
+FUNCTION {author.organization.sort}
+{ author empty$
+    { organization empty$
+{ key empty$
+    { "to sort, need author, organization, or key in " cite$ * warning$
+      ""
+    }
+    { key sortify }
+  if$
+}
+{ "The " #4 organization chop.word sortify }
+      if$
+    }
+    { author sort.format.names }
+  if$
+}
+
+FUNCTION {editor.organization.sort}
+{ editor empty$
+    { organization empty$
+{ key empty$
+    { "to sort, need editor, organization, or key in " cite$ * warning$
+      ""
+    }
+    { key sortify }
+  if$
+}
+{ "The " #4 organization chop.word sortify }
+      if$
+    }
+    { editor sort.format.names }
+  if$
+}
+
+FUNCTION {presort}
+{ type$ "book" =
+  type$ "inbook" =
+  or
+    'author.editor.sort
+    { type$ "proceedings" =
+'editor.organization.sort
+{ type$ "manual" =
+    'author.organization.sort
+    'author.sort
+  if$
+}
+      if$
+    }
+  if$
+  "    "
+  *
+  year field.or.null sortify
+  *
+  "    "
+  *
+  title field.or.null
+  sort.format.title
+  *
+  #1 entry.max$ substring$
+  'sort.key$ :=
+}
+
+ITERATE {presort}
+
+SORT
+
+STRINGS { longest.label }
+
+INTEGERS { number.label longest.label.width }
+
+FUNCTION {initialize.longest.label}
+{ "" 'longest.label :=
+  #1 'number.label :=
+  #0 'longest.label.width :=
+}
+
+FUNCTION {longest.label.pass}
+{ number.label int.to.str$ 'label :=
+  number.label #1 + 'number.label :=
+  label width$ longest.label.width >
+    { label 'longest.label :=
+      label width$ 'longest.label.width :=
+    }
+    'skip$
+  if$
+}
+
+EXECUTE {banner.message}
+EXECUTE {initialize.longest.label}
+
+ITERATE {longest.label.pass}
+
+FUNCTION {begin.bib}
+{
+  "% Generated by plain-fa.bst,  version: " bst.file.version * " (" * bst.file.date * "), for XePersian Package" *
+  write$ newline$
+  "% Authors: " bst.file.authors *
+  write$ newline$
+  "\providecommand{\noopsort}[1]{}"
+  write$ newline$
+  preamble$ empty$
+    'skip$
+    { preamble$ write$ newline$ }
+  if$
+  "\begin{thebibliography}{"  longest.label  * "}" * write$ newline$
+}
+
+EXECUTE {begin.bib}
+
+EXECUTE {init.state.consts}
+
+ITERATE {call.type$}
+
+FUNCTION {end.bib}
+{ newline$
+  "\end{thebibliography}" write$ newline$
+  "\Persian" write$ newline$
+}
+
+EXECUTE {end.bib}
+EXECUTE{completed.message}
+%% 
+%% Copyright ?? 2008-2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `acm-fa.bst'.

Added: tags/texmf/bibtex/bst/xepersian/ieeetr-fa.bst
===================================================================
--- tags/texmf/bibtex/bst/xepersian/ieeetr-fa.bst	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/bibtex/bst/xepersian/ieeetr-fa.bst	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,1178 @@
+%%
+%% This is file `ieeetr-fa.bst',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% xepersian.dtx  (with options: `ieeetr-fa.bst')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2008-2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
+%% Bib. style "ieeetr-fa", Persian (farsi)  version of ieeetr.bst
+%%
+%% by: Mahmood Amintoosi and Mostafa Vahedi
+%% For XePersian, a Persian Typsetting Package in XeTeX, Developed by:
+%% Vafa Khalighi, Mehdi Omidali and Mostafa Vahedi
+%% 2009/02/12
+%% It may be distributed and/or modified under the
+%% conditions of the LaTeX Project Public License, either this version
+%% of this license or (at your option) any later version.
+%%
+%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
+%% Original Copyright
+
+ENTRY
+  { address
+    author
+    booktitle
+    chapter
+    edition
+    editor
+    howpublished
+    institution
+    journal
+    key
+language
+    month
+    note
+    number
+    organization
+    pages
+    publisher
+    school
+    series
+    title
+translator
+    type
+    volume
+    year
+  }
+  {}
+  { label }
+
+INTEGERS { output.state before.all mid.sentence after.quote after.sentence
+after.quoted.block after.block }
+STRINGS {bbl.and bbl.etal bbl.editors bbl.editor bbl.edition bbl.volume bbl.of bbl.number
+ bbl.in bbl.pages bbl.page bbl.chapter bbl.series bbl.techrep bbl.mthesis bbl.phdthesis
+ bbl.translator}% bbl.formatnames}
+FUNCTION {is.print.banners.to.terminal} { #1 }
+%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
+%% FILE VERSION AND BANNER %%
+%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
+
+FUNCTION{bst.file.version} { "0.3" }
+FUNCTION{bst.file.date} { "2009/02/12" }
+FUNCTION{bst.file.website} { "http://developer.berlios.de/projects/xepersian" }
+FUNCTION{bst.file.authors} {"M.Amintoosi and M.Vahedi" }
+
+FUNCTION {banner.message}
+{ is.print.banners.to.terminal
+     { "-- ieeetr-fa.bst version" " " * bst.file.version *
+       " (" * bst.file.date * ") " * %"by " * bst.file.authors *
+       top$
+       "-- This is a BibTeX style for XePersian: " bst.file.website *
+       %top$
+       %"-- See the " quote$ * "xepersian_bibtex_userguide.pdf" * quote$ * " manual for usage information." *
+       top$
+     }
+     { skip$ }
+   if$
+}
+
+FUNCTION {completed.message}
+{ is.print.banners.to.terminal
+     { ""
+       top$
+       "Done."
+       top$
+     }
+     { skip$ }
+   if$
+}
+
+%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
+%% Persian Functions    %%
+%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
+
+FUNCTION {fa.isPersianLanguage}
+{
+  language missing$
+    {#0}
+    {language "l" change.case$ "persian" =}
+  if$
+}
+
+FUNCTION {keywords.fa}
+{
+  " ?? "  'bbl.and  :=
+  " ?? ????????????"  'bbl.etal  :=
+  " ???????????????????? "  'bbl.editors  :=
+  " ??????????????????? "  'bbl.editor  :=
+  " ???????????? "  'bbl.edition    :=
+  " ?????? "  'bbl.volume :=
+  " ???? "  'bbl.of :=
+  " ?????????? "  'bbl.number :=
+  " ???? "  'bbl.in  :=
+  " ?????????? "  'bbl.pages  :=
+  " ??."  'bbl.page  :=
+  " ?????? "  'bbl.chapter :=
+  " ?????? " 'bbl.series :=
+  " ?????????? ?????? ????????????" 'bbl.techrep :=
+  " ????????????????????? ???????????????????????????" 'bbl.mthesis  :=
+  " ????????????????????? ??????????"  'bbl.phdthesis :=
+  " ??????????????? " 'bbl.translator :=
+}
+
+FUNCTION {keywords.en}
+{
+  " and "  'bbl.and  :=
+  " et~al."  'bbl.etal  :=
+  " Eds."  'bbl.editors  :=
+  " Ed."  'bbl.editor  :=
+  " Ed."  'bbl.edition    :=
+  " Vol."  'bbl.volume :=
+  " of "  'bbl.of :=
+  " No."  'bbl.number :=
+  " In "  'bbl.in  :=
+  " pp."  'bbl.pages  :=
+  " p."  'bbl.page  :=
+  " Ch."  'bbl.chapter :=
+  " Ser." 'bbl.series :=
+  " Tech. Rep." 'bbl.techrep :=
+  " Master's thesis" 'bbl.mthesis  :=
+  " Ph.D. disseration"  'bbl.phdthesis :=
+  " Translator " 'bbl.translator :=
+}
+
+%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
+%% End of Persian Functions %%
+%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
+
+FUNCTION {init.state.consts}
+{ #0 'before.all :=
+  #1 'mid.sentence :=
+  #2 'after.quote :=
+  #3 'after.sentence :=
+  #4 'after.quoted.block :=
+  #5 'after.block :=
+}
+
+STRINGS { s t }
+
+FUNCTION {output.nonnull}
+{ 's :=
+  output.state mid.sentence =
+    { ", " * write$ }
+    { output.state after.quote =
+{ " " * write$ }
+{ output.state after.block =
+    { add.period$ write$
+      newline$
+      "\newblock " write$
+    }
+    { output.state before.all =
+'write$
+{ output.state after.quoted.block =
+    { write$
+      newline$
+      "\newblock " write$
+    }
+    { add.period$ " " * write$ }
+  if$
+}
+      if$
+    }
+  if$
+}
+      if$
+      mid.sentence 'output.state :=
+    }
+  if$
+  s
+}
+
+FUNCTION {output}
+{ duplicate$ empty$
+    'pop$
+    'output.nonnull
+  if$
+}
+
+FUNCTION {output.check}
+{ 't :=
+  duplicate$ empty$
+    { pop$ "empty " t * " in " * cite$ * warning$ }
+    'output.nonnull
+  if$
+}
+
+FUNCTION {output.bibitem}
+{ newline$
+  fa.isPersianLanguage
+    { keywords.fa
+  "\Persian" write$
+      newline$ }
+    { keywords.en
+  "\Latin" write$
+      newline$ }
+  if$
+  "\bibitem{" write$
+  cite$ write$
+  "}" write$
+  newline$
+  ""
+  before.all 'output.state :=
+}
+
+FUNCTION {blank.sep}
+{ after.quote 'output.state :=
+}
+
+FUNCTION {fin.entry}
+{ output.state after.quoted.block =
+    'skip$
+    'add.period$
+  if$
+  write$
+  newline$
+}
+
+FUNCTION {new.block}
+{ output.state before.all =
+    'skip$
+    { output.state after.quote =
+{ after.quoted.block 'output.state := }
+{ after.block 'output.state := }
+      if$
+    }
+  if$
+}
+
+FUNCTION {new.sentence}
+{ output.state after.block =
+    'skip$
+    { output.state before.all =
+'skip$
+{ after.sentence 'output.state := }
+      if$
+    }
+  if$
+}
+
+FUNCTION {not}
+{   { #0 }
+    { #1 }
+  if$
+}
+
+FUNCTION {and}
+{   'skip$
+    { pop$ #0 }
+  if$
+}
+
+FUNCTION {or}
+{   { pop$ #1 }
+    'skip$
+  if$
+}
+
+FUNCTION {new.block.checka}
+{ empty$
+    'skip$
+    'new.block
+  if$
+}
+
+FUNCTION {new.block.checkb}
+{ empty$
+  swap$ empty$
+  and
+    'skip$
+    'new.block
+  if$
+}
+
+FUNCTION {new.sentence.checka}
+{ empty$
+    'skip$
+    'new.sentence
+  if$
+}
+
+FUNCTION {field.or.null}
+{ duplicate$ empty$
+    { pop$ "" }
+    'skip$
+  if$
+}
+
+FUNCTION {emphasize}
+{ duplicate$ empty$
+    { pop$ "" }
+    { "{\em " swap$ * "}" * }
+  if$
+}
+
+INTEGERS { nameptr namesleft numnames }
+
+FUNCTION {format.names}
+{ 's :=
+  #1 'nameptr :=
+  s num.names$ 'numnames :=
+  numnames 'namesleft :=
+    { namesleft #0 > }
+    { %s nameptr "{f.~}{vv~}{ll}{, jj}" format.name$ 't :=
+      fa.isPersianLanguage
+        { s nameptr "{vv~}{ll}{, jj}{, ff}" format.name$ 't :=}
+        { s nameptr "{vv~}{ll}{, jj}{, f.}" format.name$ 't :=}
+      if$
+  nameptr #1 >
+{ namesleft #1 >
+    { ", " * t * }
+    { numnames #2 >
+{ "," * }
+'skip$
+      if$
+      t "others" =
+{ " {\em" * bbl.etal * "}" * }
+{ bbl.and * t * }
+      if$
+    }
+  if$
+}
+'t
+      if$
+      nameptr #1 + 'nameptr :=
+      namesleft #1 - 'namesleft :=
+    }
+  while$
+}
+
+FUNCTION {format.authors}
+{ author empty$
+    { "" }
+    { author format.names }
+  if$
+}
+
+FUNCTION {format.editors}
+{ editor empty$
+    { "" }
+    { fa.isPersianLanguage
+    {
+editor num.names$ #1 >
+{bbl.editors editor format.names * }
+{bbl.editor editor format.names * }
+if$
+}
+{
+  editor format.names
+editor num.names$ #1 >
+{ ", " bbl.editors * *}
+{ ", " bbl.editor * *}
+if$
+}
+  if$
+    }
+  if$
+}
+
+FUNCTION {format.translators}
+{ translator empty$
+    { "" }
+    { fa.isPersianLanguage
+    {
+bbl.translator translator format.names *
+}
+{
+  translator format.names
+", " bbl.translator * *
+}
+  if$
+    }
+  if$
+}
+
+FUNCTION {format.title}
+{ title empty$
+    { "" }
+{ fa.isPersianLanguage
+        { "''" title * ",``" * }
+    { "``" title "t" change.case$ * ",''" * }
+  if$
+}
+  if$
+}
+
+FUNCTION {format.title.p}
+{ title empty$
+    { "" }
+{ fa.isPersianLanguage
+        { "''" title * ",``" * }
+    { "``" title "t" change.case$ * ",''" * }
+  if$
+}
+  if$
+}
+
+FUNCTION {n.dashify}
+{ 't :=
+  ""
+    { t empty$ not }
+    { t #1 #1 substring$ "-" =
+{ t #1 #2 substring$ "--" = not
+    { "--" *
+      t #2 global.max$ substring$ 't :=
+    }
+    {   { t #1 #1 substring$ "-" = }
+{ "-" *
+  t #2 global.max$ substring$ 't :=
+}
+      while$
+    }
+  if$
+}
+{ t #1 #1 substring$ *
+  t #2 global.max$ substring$ 't :=
+}
+      if$
+    }
+  while$
+}
+
+FUNCTION {format.date}
+{ year empty$
+    { month empty$
+{ "" }
+{ "there's a month but no year in " cite$ * warning$
+  month
+}
+      if$
+    }
+    { month empty$
+'year
+{ month " " * year * }
+      if$
+    }
+  if$
+}
+
+FUNCTION {format.btitle}
+{ title emphasize
+}
+
+FUNCTION {tie.or.space.connect}
+{ duplicate$ text.length$ #3 <
+    { "~" }
+    { " " }
+  if$
+  swap$ * *
+}
+
+FUNCTION {either.or.check}
+{ empty$
+    'pop$
+    { "can't use both " swap$ * " fields in " * cite$ * warning$ }
+  if$
+}
+
+FUNCTION {format.bvolume}
+{ volume empty$
+    { "" }
+    { bbl.volume volume *
+      series empty$
+'skip$
+{ bbl.of * series emphasize * }
+      if$
+      "volume and number" number either.or.check
+    }
+  if$
+}
+
+FUNCTION {format.number.series}
+{ volume empty$
+    { number empty$
+{ series field.or.null }
+{ output.state mid.sentence =
+    { bbl.number }
+    { bbl.number "t" change.case$ }
+  if$
+  number tie.or.space.connect
+  series empty$
+    { "there's a number but no series in " cite$ * warning$ }
+    { bbl.in * series * }
+  if$
+}
+      if$
+    }
+    { "" }
+  if$
+}
+
+FUNCTION {format.edition}
+{ edition empty$
+    { "" }
+    { fa.isPersianLanguage
+    {
+   bbl.edition edition *
+}
+{
+      output.state mid.sentence =
+       { edition "l" change.case$ bbl.edition * }
+       { edition "t" change.case$ bbl.edition * }
+          if$
+}
+  if$
+    }
+  if$
+}
+
+INTEGERS { multiresult }
+
+FUNCTION {multi.page.check}
+{ 't :=
+  #0 'multiresult :=
+    { multiresult not
+      t empty$ not
+      and
+    }
+    { t #1 #1 substring$
+      duplicate$ "-" =
+      swap$ duplicate$ "," =
+      swap$ "+" =
+      or or
+{ #1 'multiresult := }
+{ t #2 global.max$ substring$ 't := }
+      if$
+    }
+  while$
+  multiresult
+}
+
+FUNCTION {format.pages}
+{ pages empty$
+    { "" }
+    { pages multi.page.check
+{ bbl.pages pages n.dashify * }
+{ bbl.page pages * }
+      if$
+    }
+  if$
+}
+
+FUNCTION {format.volume}
+{ volume empty$
+    { "" }
+    { bbl.volume volume * }%M.Amintoosi "vol.~"
+  if$
+}
+
+FUNCTION {format.number}
+{ number empty$
+    { "" }
+    { bbl.number number * }%M.Amintoosi "no.~"
+  if$
+}
+
+FUNCTION {format.chapter.pages}
+{ chapter empty$
+    'format.pages
+    { type empty$
+{ bbl.chapter }
+{ type "l" change.case$ }
+      if$
+      chapter tie.or.space.connect
+      pages empty$
+'skip$
+{ ", " * format.pages * }
+      if$
+    }
+  if$
+}
+
+FUNCTION {format.in.ed.booktitle}
+{ booktitle empty$
+    { "" }
+    { bbl.in booktitle emphasize *
+      editor empty$
+   'skip$
+   { " (" * format.editors * ")" * }
+      if$
+    }
+  if$
+}
+
+FUNCTION {format.thesis.type}
+{ type empty$
+    'skip$
+    { pop$
+      output.state after.block =
+{ type "t" change.case$ }
+{ type "l" change.case$ }
+      if$
+    }
+  if$
+}
+
+FUNCTION {empty.misc.check}
+{ author empty$ title empty$ howpublished empty$
+  month empty$ year empty$ note empty$
+  and and and and and
+    { "all relevant fields are empty in " cite$ * warning$ }
+    'skip$
+  if$
+}
+
+FUNCTION {format.tr.number}
+{ type empty$
+    { bbl.techrep }
+    'type
+  if$
+  number empty$
+    { "l" change.case$ }
+    { number tie.or.space.connect }
+  if$
+}
+
+FUNCTION {format.addr.pub}
+{ publisher empty$
+    { "" }
+    { address empty$
+{ "" }
+{ address ": " * }
+      if$
+      publisher *
+    }
+  if$
+}
+
+FUNCTION {format.paddress}
+{ address empty$
+    { "" }
+    { "(" address * ")" * }
+  if$
+}
+
+FUNCTION {format.article.crossref}
+{ key empty$
+    { journal empty$
+{ "need key or journal for " cite$ * " to crossref " * crossref *
+  warning$
+  ""
+}
+{ bbl.in "{\em " * journal * "\/}" * }
+      if$
+    }
+    { bbl.in  key * }
+  if$
+  " \cite{" * crossref * "}" *
+}
+
+FUNCTION {format.crossref.editor}
+{ editor #1 "{vv~}{ll}" format.name$
+  editor num.names$ duplicate$
+  #2 >
+    { pop$ " {\em" * bbl.etal * "}" * }
+    { #2 <
+'skip$
+{ editor #2 "{ff }{vv }{ll}{ jj}" format.name$ "others" =
+    { " {\em"  bbl.etal * "}" * }
+    { bbl.and * editor #2 "{vv~}{ll}" format.name$ * }
+  if$
+}
+      if$
+    }
+  if$
+}
+
+FUNCTION {format.book.crossref}
+{ volume empty$
+    { "empty volume in " cite$ * "'s crossref of " * crossref * warning$
+      bbl.in
+    }
+    { bbl.volume volume tie.or.space.connect
+      bbl.of  *
+    }
+  if$
+  editor empty$
+  editor field.or.null author field.or.null =
+  or
+    { key empty$
+{ series empty$
+    { "need editor, key, or series for " cite$ * " to crossref " *
+      crossref * warning$
+      "" *
+    }
+    { "{\em " * series * "\/}" * }
+  if$
+}
+{ key * }
+      if$
+    }
+    { format.crossref.editor * }
+  if$
+  " \cite{" * crossref * "}" *
+}
+
+FUNCTION {format.incoll.inproc.crossref}
+{ editor empty$
+  editor field.or.null author field.or.null =
+  or
+    { key empty$
+{ booktitle empty$
+    { "need editor, key, or booktitle for " cite$ * " to crossref " *
+      crossref * warning$
+      ""
+    }
+    { bbl.in "{\em " * booktitle * "\/}" * }
+  if$
+}
+{ bbl.in key * }
+      if$
+    }
+    { bbl.in format.crossref.editor * }
+  if$
+  " \cite{" * crossref * "}" *
+}
+
+FUNCTION {article}
+{ output.bibitem
+  format.authors "author" output.check
+  format.title "title" output.check
+  blank.sep
+  crossref missing$
+    { journal emphasize "journal" output.check
+      format.volume output
+      month empty$
+{ format.number output }
+'skip$
+      if$
+      format.pages output
+      format.date "year" output.check
+    }
+    { format.article.crossref output.nonnull
+      format.pages output
+    }
+  if$
+  new.block
+  note output
+  fin.entry
+}
+
+FUNCTION {book}
+{ output.bibitem
+  fa.isPersianLanguage
+  {
+format.authors  output
+    new.block
+    format.btitle "title" output.check
+new.block
+    format.translators output
+format.editors  output
+  }
+  { author empty$
+      { format.editors "author and editor" output.check }
+      { format.authors output.nonnull
+        crossref missing$
+      { "author and editor" editor either.or.check }
+      'skip$
+        if$
+      }
+    if$
+    new.block
+    format.btitle "title" output.check
+  }
+  if$
+  crossref missing$
+    { format.bvolume output
+      new.block
+      format.number.series output
+      format.addr.pub "publisher" output.check
+    }
+    { new.block
+      format.book.crossref output.nonnull
+    }
+  if$
+  format.edition output
+  format.date "year" output.check
+  new.block
+  note output
+  fin.entry
+}
+
+FUNCTION {booklet}
+{ output.bibitem
+  format.authors output
+  title empty$
+    { "empty title in " cite$ * warning$
+      howpublished new.sentence.checka
+    }
+    { howpublished empty$ not
+      address empty$ month empty$ year empty$ and and
+      or
+{ format.title.p output.nonnull }
+{ format.title output.nonnull }
+      if$
+      blank.sep
+    }
+  if$
+  howpublished output
+  address output
+  format.date output
+  new.block
+  note output
+  fin.entry
+}
+
+FUNCTION {inbook}
+{ output.bibitem
+  author empty$
+    { format.editors "author and editor" output.check }
+    { format.authors output.nonnull
+      crossref missing$
+{ "author and editor" editor either.or.check }
+'skip$
+      if$
+    }
+  if$
+  format.btitle "title" output.check
+  crossref missing$
+    { format.bvolume output
+      format.chapter.pages "chapter and pages" output.check
+      new.block
+      format.number.series output
+      format.addr.pub "publisher" output.check
+    }
+    { format.chapter.pages "chapter and pages" output.check
+      new.block
+      format.book.crossref output.nonnull
+    }
+  if$
+  format.edition output
+  format.date "year" output.check
+  new.block
+  note output
+  fin.entry
+}
+
+FUNCTION {incollection}
+{ output.bibitem
+  format.authors "author" output.check
+  format.title "title" output.check
+  blank.sep
+  crossref missing$
+    { format.in.ed.booktitle "booktitle" output.check
+      format.bvolume output
+      format.number.series output
+      format.chapter.pages output
+      format.addr.pub "publisher" output.check
+      format.edition output
+      format.date "year" output.check
+    }
+    { format.incoll.inproc.crossref output.nonnull
+      format.chapter.pages output
+    }
+  if$
+  new.block
+  note output
+  fin.entry
+}
+
+FUNCTION {inproceedings}
+{ output.bibitem
+  format.authors "author" output.check
+  format.title "title" output.check
+  blank.sep
+  crossref missing$
+    { format.in.ed.booktitle "booktitle" output.check
+      format.bvolume output
+      format.number.series output
+      format.paddress output
+      format.pages output
+      organization output
+      publisher output
+      format.date "year" output.check
+    }
+    { format.incoll.inproc.crossref output.nonnull
+      format.pages output
+    }
+  if$
+  new.block
+  note output
+  fin.entry
+}
+
+FUNCTION {conference} { inproceedings }
+
+FUNCTION {manual}
+{ output.bibitem
+  author empty$
+    { organization empty$
+'skip$
+{ organization output.nonnull
+  address output
+}
+      if$
+    }
+    { format.authors output.nonnull }
+  if$
+  format.btitle "title" output.check
+  author empty$
+    { organization empty$
+{ address new.block.checka
+  address output
+}
+'skip$
+      if$
+    }
+    { organization address new.block.checkb
+      organization output
+      address output
+    }
+  if$
+  format.edition output
+  format.date output
+  new.block
+  note output
+  fin.entry
+}
+
+FUNCTION {mastersthesis}
+{ output.bibitem
+  format.authors "author" output.check
+  format.title "title" output.check
+  blank.sep
+  bbl.mthesis format.thesis.type output.nonnull
+  school "school" output.check
+  address output
+  format.date "year" output.check
+  new.block
+  note output
+  fin.entry
+}
+
+FUNCTION {misc}
+{ output.bibitem
+  format.authors output
+  title empty$
+    { howpublished new.sentence.checka }
+    { howpublished empty$ not
+      month empty$ year empty$ and
+      or
+{ format.title.p output.nonnull }
+{ format.title output.nonnull }
+      if$
+      blank.sep
+    }
+  if$
+  howpublished output
+  format.date output
+  new.block
+  note output
+  fin.entry
+  empty.misc.check
+}
+
+FUNCTION {phdthesis}
+{ output.bibitem
+  format.authors "author" output.check
+  format.btitle "title" output.check
+  new.block
+  bbl.phdthesis format.thesis.type output.nonnull
+  school "school" output.check
+  address output
+  format.date "year" output.check
+  new.block
+  note output
+  fin.entry
+}
+
+FUNCTION {proceedings}
+{ output.bibitem
+  editor empty$
+    { organization output }
+    { format.editors output.nonnull }
+  if$
+  format.btitle "title" output.check
+  format.bvolume output
+  format.number.series output
+  format.paddress output
+  editor empty$
+    'skip$
+    { organization output }
+  if$
+  publisher output
+  format.date "year" output.check
+  new.block
+  note output
+  fin.entry
+}
+
+FUNCTION {techreport}
+{ output.bibitem
+  format.authors "author" output.check
+  format.title "title" output.check
+  blank.sep
+  format.tr.number output.nonnull
+  institution "institution" output.check
+  address output
+  format.date "year" output.check
+  new.block
+  note output
+  fin.entry
+}
+
+FUNCTION {unpublished}
+{ output.bibitem
+  format.authors "author" output.check
+  format.title.p "title" output.check
+  blank.sep
+  note "note" output.check
+  format.date output
+  fin.entry
+}
+
+FUNCTION {default.type} { misc }
+
+MACRO {jan} {"Jan."}
+
+MACRO {feb} {"Feb."}
+
+MACRO {mar} {"Mar."}
+
+MACRO {apr} {"Apr."}
+
+MACRO {may} {"May"}
+
+MACRO {jun} {"June"}
+
+MACRO {jul} {"July"}
+
+MACRO {aug} {"Aug."}
+
+MACRO {sep} {"Sept."}
+
+MACRO {oct} {"Oct."}
+
+MACRO {nov} {"Nov."}
+
+MACRO {dec} {"Dec."}
+
+MACRO {acmcs} {"ACM Computing Surveys"}
+
+MACRO {acta} {"Acta Informatica"}
+
+MACRO {cacm} {"Communications ACM"}
+
+MACRO {ibmjrd} {"IBM J. Research and Development"}
+
+MACRO {ibmsj} {"IBM Systems~J."}
+
+MACRO {ieeese} {"IEEE Trans. Software Engineering"}
+
+MACRO {ieeetc} {"IEEE Trans. Computers"}
+
+MACRO {ieeetcad}
+ {"IEEE Trans. Computer-Aided Design"}
+
+MACRO {ipl} {"Information Processing Letters"}
+
+MACRO {jacm} {"J.~ACM"}
+
+MACRO {jcss} {"J.~Computer and System Sciences"}
+
+MACRO {scp} {"Science of Computer Programming"}
+
+MACRO {sicomp} {"SIAM J. Computing"}
+
+MACRO {tocs} {"ACM Trans. Computer Systems"}
+
+MACRO {tods} {"ACM Trans. Database Systems"}
+
+MACRO {tog} {"ACM Trans. Graphics"}
+
+MACRO {toms} {"ACM Trans. Mathematical Software"}
+
+MACRO {toois} {"ACM Trans. Office Information Systems"}
+
+MACRO {toplas} {"ACM Trans. Programming Languages and Systems"}
+
+MACRO {tcs} {"Theoretical Computer Science"}
+
+READ
+
+STRINGS { longest.label }
+
+INTEGERS { number.label longest.label.width }
+
+FUNCTION {initialize.longest.label}
+{ "" 'longest.label :=
+  #1 'number.label :=
+  #0 'longest.label.width :=
+}
+
+FUNCTION {longest.label.pass}
+{ number.label int.to.str$ 'label :=
+  number.label #1 + 'number.label :=
+  label width$ longest.label.width >
+    { label 'longest.label :=
+      label width$ 'longest.label.width :=
+    }
+    'skip$
+  if$
+}
+
+EXECUTE {banner.message}
+EXECUTE {initialize.longest.label}
+
+ITERATE {longest.label.pass}
+FUNCTION {begin.bib}
+{
+  "% Generated by plain-fa.bst,  version: " bst.file.version * " (" * bst.file.date * "), for XePersian Package" *
+  write$ newline$
+  "% Authors: " bst.file.authors *
+  write$ newline$
+  "\providecommand{\noopsort}[1]{}"
+  write$ newline$
+  preamble$ empty$
+    'skip$
+    { preamble$ write$ newline$ }
+  if$
+  "\begin{thebibliography}{"  longest.label  * "}" * write$ newline$
+}
+
+EXECUTE {begin.bib}
+
+EXECUTE {init.state.consts}
+
+ITERATE {call.type$}
+
+FUNCTION {end.bib}
+{ newline$
+  "\end{thebibliography}" write$ newline$
+  "\Persian" write$ newline$
+}
+
+EXECUTE {end.bib}
+EXECUTE{completed.message}
+%% 
+%% Copyright ?? 2008-2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `ieeetr-fa.bst'.

Added: tags/texmf/bibtex/bst/xepersian/plain-fa.bst
===================================================================
--- tags/texmf/bibtex/bst/xepersian/plain-fa.bst	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/bibtex/bst/xepersian/plain-fa.bst	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,1304 @@
+%%
+%% This is file `plain-fa.bst',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% xepersian.dtx  (with options: `plain-fa.bst')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2008-2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
+%% Bib. style "plain-fa", Persian (farsi)  version of plain.bst
+%%
+%% by: Mahmood Amintoosi and Mostafa Vahedi
+%% For XePersian, a Persian Typsetting Package in XeTeX, Developed by:
+%% Vafa Khalighi, Mehdi Omidali and Mostafa Vahedi
+%% 2009/02/09
+%% It may be distributed and/or modified under the
+%% conditions of the LaTeX Project Public License, either this version
+%% of this license or (at your option) any later version.
+%%
+%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
+%% Original Copyright
+
+
+ENTRY
+  { address
+    author
+    booktitle
+    chapter
+    edition
+    editor
+    howpublished
+    institution
+    journal
+    key
+language
+    month
+    note
+    number
+    organization
+    pages
+    publisher
+    school
+    series
+    title
+translator
+    type
+    volume
+    year
+  }
+  {}
+  { label }
+
+INTEGERS { output.state before.all mid.sentence after.sentence after.block }
+STRINGS {bbl.and bbl.etal bbl.editors bbl.editor bbl.edition bbl.volume bbl.of bbl.number
+ bbl.in bbl.pages bbl.page bbl.chapter bbl.series bbl.techrep bbl.mthesis bbl.phdthesis
+ bbl.translator}% bbl.formatnames}
+FUNCTION {is.print.banners.to.terminal} { #1 }
+%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
+%% FILE VERSION AND BANNER %%
+%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
+
+FUNCTION{bst.file.version} { "0.2" }
+FUNCTION{bst.file.date} { "2009/02/09" }
+FUNCTION{bst.file.website} { "http://developer.berlios.de/projects/xepersian" }
+FUNCTION{bst.file.authors} {"M.Amintoosi and M.Vahedi" }
+
+FUNCTION {banner.message}
+{ is.print.banners.to.terminal
+     { "-- plain-fa.bst version" " " * bst.file.version *
+       " (" * bst.file.date * ") " * %"by " * bst.file.authors *
+       top$
+       "-- This is a BibTeX style for XePersian: " bst.file.website *
+       %top$
+       %"-- See the " quote$ * "xepersian_bibtex_userguide.pdf" * quote$ * " manual for usage information." *
+       top$
+     }
+     { skip$ }
+   if$
+}
+
+FUNCTION {completed.message}
+{ is.print.banners.to.terminal
+     { ""
+       top$
+       "Done."
+       top$
+     }
+     { skip$ }
+   if$
+}
+
+%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
+%% Persian Functions    %%
+%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
+
+FUNCTION {fa.isPersianLanguage}
+{
+  language missing$
+    {#0}
+    {language "l" change.case$ "persian" =}
+  if$
+}
+
+FUNCTION {keywords.fa}
+{
+  " ?? "  'bbl.and  :=
+  " ?? ????????????"  'bbl.etal  :=
+  " ???????????????????? "  'bbl.editors  :=
+  " ??????????????????? "  'bbl.editor  :=
+  " ???????????? "  'bbl.edition    :=
+  " ?????? "  'bbl.volume :=
+  " ???? "  'bbl.of :=
+  " ?????????? "  'bbl.number :=
+  " ???? "  'bbl.in  :=
+  " ?????????? "  'bbl.pages  :=
+  " ??."  'bbl.page  :=
+  " ?????? "  'bbl.chapter :=
+  " ?????? " 'bbl.series :=
+  " ?????????? ?????? ????????????" 'bbl.techrep :=
+  " ????????????????????? ???????????????????????????" 'bbl.mthesis  :=
+  " ????????????????????? ??????????"  'bbl.phdthesis :=
+  " ??????????????? " 'bbl.translator :=
+}
+
+FUNCTION {keywords.en}
+{
+  " and "  'bbl.and  :=
+  " et~al."  'bbl.etal  :=
+  " Eds."  'bbl.editors  :=
+  " Ed."  'bbl.editor  :=
+  " Ed."  'bbl.edition    :=
+  " Vol."  'bbl.volume :=
+  " of "  'bbl.of :=
+  " No."  'bbl.number :=
+  " In "  'bbl.in  :=
+  " pp."  'bbl.pages  :=
+  " p."  'bbl.page  :=
+  " Ch."  'bbl.chapter :=
+  " Ser." 'bbl.series :=
+  " Tech. Rep." 'bbl.techrep :=
+  " Master's thesis" 'bbl.mthesis  :=
+  " Ph.D. disseration"  'bbl.phdthesis :=
+  " Translator " 'bbl.translator :=
+  %"{vv~}{ll}{, jj}{, f.}"   'bbl.formatnames :=
+}
+
+%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
+%% End of Persian Functions %%
+%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
+
+FUNCTION {init.state.consts}
+{ #0 'before.all :=
+  #1 'mid.sentence :=
+  #2 'after.sentence :=
+  #3 'after.block :=
+}
+
+STRINGS { s t }
+
+FUNCTION {output.nonnull}
+{ 's :=
+  output.state mid.sentence =
+    { ", " * write$ }
+    { output.state after.block =
+{ add.period$ write$
+  newline$
+  "\newblock " write$
+}
+{ output.state before.all =
+    'write$
+    { add.period$ " " * write$ }
+  if$
+}
+      if$
+      mid.sentence 'output.state :=
+    }
+  if$
+  s
+}
+
+FUNCTION {output}
+{ duplicate$ empty$
+    'pop$
+    'output.nonnull
+  if$
+}
+
+FUNCTION {output.check}
+{ 't :=
+  duplicate$ empty$
+    { pop$ "empty " t * " in " * cite$ * warning$ }
+    'output.nonnull
+  if$
+}
+
+FUNCTION {output.bibitem}
+{
+  newline$
+  fa.isPersianLanguage
+    { keywords.fa
+  "\Persian" write$
+      newline$ }
+    { keywords.en
+  "\Latin" write$
+      newline$ }
+  if$
+  "\bibitem{" write$
+  cite$ write$
+  "}" write$
+  newline$
+  ""
+  before.all 'output.state :=
+}
+
+FUNCTION {fin.entry}
+{ add.period$
+  write$
+  newline$
+}
+
+FUNCTION {new.block}
+{ output.state before.all =
+    'skip$
+    { after.block 'output.state := }
+  if$
+}
+
+FUNCTION {new.sentence}
+{ output.state after.block =
+    'skip$
+    { output.state before.all =
+'skip$
+{ after.sentence 'output.state := }
+      if$
+    }
+  if$
+}
+
+FUNCTION {not}
+{   { #0 }
+    { #1 }
+  if$
+}
+
+FUNCTION {and}
+{   'skip$
+    { pop$ #0 }
+  if$
+}
+
+FUNCTION {or}
+{   { pop$ #1 }
+    'skip$
+  if$
+}
+
+FUNCTION {new.block.checka}
+{ empty$
+    'skip$
+    'new.block
+  if$
+}
+
+FUNCTION {new.block.checkb}
+{ empty$
+  swap$ empty$
+  and
+    'skip$
+    'new.block
+  if$
+}
+
+FUNCTION {new.sentence.checka}
+{ empty$
+    'skip$
+    'new.sentence
+  if$
+}
+
+FUNCTION {new.sentence.checkb}
+{ empty$
+  swap$ empty$
+  and
+    'skip$
+    'new.sentence
+  if$
+}
+
+FUNCTION {field.or.null}
+{ duplicate$ empty$
+    { pop$ "" }
+    'skip$
+  if$
+}
+
+FUNCTION {emphasize}
+{ duplicate$ empty$
+    { pop$ "" }
+    { "{\em " swap$ * "}" * }
+  if$
+}
+
+INTEGERS { nameptr namesleft numnames }
+
+FUNCTION {format.names}
+{ 's :=
+  #1 'nameptr :=
+  s num.names$ 'numnames :=
+  numnames 'namesleft :=
+ { namesleft #0 > }
+    {
+      s nameptr "{vv~}{ll}{, jj}{, ff}"  format.name$ 't :=   %{ff~}{vv~}{ll}{, jj}
+  %fa.isPersianLanguage
+  %  {s nameptr "{vv~}{ll}{, jj}{, ff}"  format.name$ 't :=   %{ff~}{vv~}{ll}{, jj}
+  %  }
+  %  {s nameptr "{vv~}{ll}{, jj}{, f.}"  format.name$ 't :=
+  %if$
+    nameptr #1 >
+{ namesleft #1 >
+    { ", " * t * }
+    { numnames #2 >
+   { "," * }
+   'skip$
+      if$
+      t "others" =
+    { bbl.etal * }
+    { bbl.and * t * }
+      if$
+    }
+  if$
+}
+'t
+    if$
+      nameptr #1 + 'nameptr :=
+      namesleft #1 - 'namesleft :=
+    }
+  while$
+}
+
+FUNCTION {format.authors}
+{ author empty$
+    { "" }
+    { author format.names }
+  if$
+}
+
+FUNCTION {format.editors}
+{ editor empty$
+    { "" }
+    { fa.isPersianLanguage
+    {
+editor num.names$ #1 >
+{bbl.editors editor format.names * }
+{bbl.editor editor format.names * }
+if$
+}
+{
+  editor format.names
+editor num.names$ #1 >
+{ ", " bbl.editors * *}
+{ ", " bbl.editor * *}
+if$
+}
+  if$
+    }
+  if$
+}
+
+FUNCTION {format.translators}
+{ translator empty$
+    { "" }
+    { fa.isPersianLanguage
+    {
+bbl.translator translator format.names *
+}
+{
+  translator format.names
+", " bbl.translator * *
+}
+  if$
+    }
+  if$
+}
+
+FUNCTION {format.title}
+{ title empty$
+    { "" }
+    { title "t" change.case$ }
+  if$
+}
+
+FUNCTION {n.dashify}
+{ 't :=
+  ""
+    { t empty$ not }
+    { t #1 #1 substring$ "-" =
+{ t #1 #2 substring$ "--" = not
+    { "--" *
+      t #2 global.max$ substring$ 't :=
+    }
+    {   { t #1 #1 substring$ "-" = }
+{ "-" *
+  t #2 global.max$ substring$ 't :=
+}
+      while$
+    }
+  if$
+}
+{ t #1 #1 substring$ *
+  t #2 global.max$ substring$ 't :=
+}
+      if$
+    }
+  while$
+}
+
+FUNCTION {format.date}
+{ year empty$
+    { month empty$
+{ "" }
+{ "there's a month but no year in " cite$ * warning$
+  month
+}
+      if$
+    }
+    { month empty$
+'year
+{ month " " * year * }
+      if$
+    }
+  if$
+}
+
+FUNCTION {format.btitle}
+{ title emphasize
+}
+
+FUNCTION {tie.or.space.connect}
+{ duplicate$ text.length$ #3 <
+    { "~" }
+    { " " }
+  if$
+  swap$ * *
+}
+
+FUNCTION {either.or.check}
+{ empty$
+    'pop$
+    { "can't use both " swap$ * " fields in " * cite$ * warning$ }
+  if$
+}
+
+FUNCTION {format.bvolume}
+{ volume empty$
+    { "" }
+    { bbl.volume volume tie.or.space.connect
+      series empty$
+'skip$
+{ bbl.of * series emphasize * }
+      if$
+      "volume and number" number either.or.check
+    }
+  if$
+}
+
+FUNCTION {format.number.series}
+{ volume empty$
+    { number empty$
+{ series field.or.null }
+{ output.state mid.sentence =
+    { bbl.number }
+    { bbl.number "t" change.case$ }
+  if$
+  number tie.or.space.connect
+  series empty$
+    { "there's a number but no series in " cite$ * warning$ }
+    { bbl.in * series * }
+  if$
+}
+      if$
+    }
+    { "" }
+  if$
+}
+
+FUNCTION {format.edition}
+{ edition empty$
+    { "" }
+    { fa.isPersianLanguage
+    {
+   bbl.edition edition *
+}
+{
+      output.state mid.sentence =
+       { edition "l" change.case$ bbl.edition * }
+       { edition "t" change.case$ bbl.edition * }
+          if$
+}
+  if$
+    }
+  if$
+}
+
+INTEGERS { multiresult }
+
+FUNCTION {multi.page.check}
+{ 't :=
+  #0 'multiresult :=
+    { multiresult not
+      t empty$ not
+      and
+    }
+    { t #1 #1 substring$
+      duplicate$ "-" =
+      swap$ duplicate$ "," =
+      swap$ "+" =
+      or or
+{ #1 'multiresult := }
+{ t #2 global.max$ substring$ 't := }
+      if$
+    }
+  while$
+  multiresult
+}
+
+FUNCTION {format.pages}
+{ pages empty$
+    { "" }
+    { pages multi.page.check
+   { bbl.pages pages n.dashify tie.or.space.connect }
+   { bbl.page pages tie.or.space.connect }
+      if$
+    }
+  if$
+}
+
+FUNCTION {format.vol.num.pages}
+{ volume field.or.null
+  number empty$
+    'skip$
+    { "(" number * ")" * *
+      volume empty$
+{ "there's a number but no volume in " cite$ * warning$ }
+'skip$
+      if$
+    }
+  if$
+  pages empty$
+    'skip$
+    { duplicate$ empty$
+{ pop$ format.pages }
+{ ":" * pages n.dashify * }
+      if$
+    }
+  if$
+}
+
+FUNCTION {format.chapter.pages}
+{ chapter empty$
+    'format.pages
+    { type empty$
+{ bbl.chapter }
+{ type "l" change.case$ }
+      if$
+      chapter tie.or.space.connect
+      pages empty$
+'skip$
+{ ", " * format.pages * }
+      if$
+    }
+  if$
+}
+
+FUNCTION {format.in.ed.booktitle}
+{
+  booktitle empty$
+    { "" }
+    { editor empty$
+    { bbl.in booktitle emphasize * }
+    { bbl.in format.editors * ", " * booktitle emphasize * }
+  if$
+}
+  if$
+}
+
+FUNCTION {empty.misc.check}
+{ author empty$ title empty$ howpublished empty$
+  month empty$ year empty$ note empty$
+  and and and and and
+  key empty$ not and
+    { "all relevant fields are empty in " cite$ * warning$ }
+    'skip$
+  if$
+}
+
+FUNCTION {format.thesis.type}
+{ type empty$
+    'skip$
+    { pop$
+      type "t" change.case$
+    }
+  if$
+}
+
+FUNCTION {format.tr.number}
+{ type empty$
+    { bbl.techrep }
+    'type
+  if$
+  number empty$
+    { "t" change.case$ }
+    { number tie.or.space.connect }
+  if$
+}
+
+FUNCTION {format.article.crossref}
+{ key empty$
+    { journal empty$
+{ "need key or journal for " cite$ * " to crossref " * crossref *
+  warning$
+  ""
+}
+{ bbl.in "{\em "  * journal * "\/}" * }
+      if$
+    }
+    { bbl.in key * }
+  if$
+  " \cite{" * crossref * "}" *
+}
+
+FUNCTION {format.crossref.editor}
+{ editor #1 "{vv~}{ll}" format.name$
+  editor num.names$ duplicate$  #2 >
+    { pop$ bbl.etal * }
+    { #2 < 'skip$
+    { editor #2 "{ff }{vv }{ll}{ jj}" format.name$ "others" =%"{ff }{vv }{ll}{ jj}"
+      { bbl.etal * }
+      { bbl.and * editor #2 "{vv~}{ll}" format.name$ * }
+    if$
+    }
+    if$
+    }
+  if$
+}
+
+FUNCTION {format.book.crossref}
+{ volume empty$
+    { "empty volume in " cite$ * "'s crossref of " * crossref * warning$
+      bbl.in
+    }
+    { bbl.volume volume tie.or.space.connect
+      bbl.of *
+    }
+  if$
+  editor empty$
+  editor field.or.null author field.or.null =
+  or
+    { key empty$
+{ series empty$
+    { "need editor, key, or series for " cite$ * " to crossref " *
+      crossref * warning$
+      "" *
+    }
+    { "{\em " * series * "\/}" * }
+  if$
+}
+{ key * }
+      if$
+    }
+    { format.crossref.editor * }
+  if$
+  " \cite{" * crossref * "}" *
+}
+
+FUNCTION {format.incoll.inproc.crossref}
+{ editor empty$
+  editor field.or.null author field.or.null =
+  or
+    { key empty$
+{ booktitle empty$
+    { "need editor, key, or booktitle for " cite$ * " to crossref " *
+      crossref * warning$
+      ""
+    }
+    { bbl.in " {\em " * booktitle * "\/}" * }
+  if$
+}
+{ bbl.in key * }
+      if$
+    }
+    { bbl.in format.crossref.editor * }
+  if$
+  " \cite{" * crossref * "}" *
+}
+
+FUNCTION {article}
+{ output.bibitem
+  format.authors "author" output.check
+  new.block
+  format.title "title" output.check
+  new.block
+  crossref missing$
+    { journal emphasize "journal" output.check
+      format.vol.num.pages output
+      format.date "year" output.check
+    }
+    { format.article.crossref output.nonnull
+      format.pages output
+    }
+  if$
+  new.block
+  note output
+  fin.entry
+}
+
+FUNCTION {book}
+{ output.bibitem
+  fa.isPersianLanguage
+  {
+format.authors  output
+    new.block
+    format.btitle "title" output.check
+new.block
+    format.translators output
+format.editors  output
+  }
+  { author empty$
+      { format.editors "author and editor" output.check }
+      { format.authors output.nonnull
+        crossref missing$
+      { "author and editor" editor either.or.check }
+      'skip$
+        if$
+      }
+    if$
+    new.block
+    format.btitle "title" output.check
+  }
+  if$
+  crossref missing$
+    { format.bvolume output
+      new.block
+      format.number.series output
+      new.sentence
+      publisher "publisher" output.check
+      address output
+    }
+    { new.block
+      format.book.crossref output.nonnull
+    }
+  if$
+  format.edition output
+  format.date "year" output.check
+  new.block
+  note output
+  fin.entry
+}
+
+FUNCTION {booklet}
+{ output.bibitem
+  format.authors output
+  new.block
+  format.title "title" output.check
+  howpublished address new.block.checkb
+  howpublished output
+  address output
+  format.date output
+  new.block
+  note output
+  fin.entry
+}
+
+FUNCTION {inbook}
+{ output.bibitem
+  author empty$
+    { format.editors "author and editor" output.check }
+    { format.authors output.nonnull
+      crossref missing$
+{ "author and editor" editor either.or.check }
+'skip$
+      if$
+    }
+  if$
+  new.block
+  format.btitle "title" output.check
+  crossref missing$
+    { format.bvolume output
+      format.chapter.pages "chapter and pages" output.check
+      new.block
+      format.number.series output
+      new.sentence
+      publisher "publisher" output.check
+      address output
+    }
+    { format.chapter.pages "chapter and pages" output.check
+      new.block
+      format.book.crossref output.nonnull
+    }
+  if$
+  format.edition output
+  format.date "year" output.check
+  new.block
+  note output
+  fin.entry
+}
+
+FUNCTION {incollection}
+{ output.bibitem
+  format.authors "author" output.check
+  new.block
+  format.title "title" output.check
+  new.block
+  crossref missing$
+    { format.in.ed.booktitle "booktitle" output.check
+      format.bvolume output
+      format.number.series output
+      format.chapter.pages output
+      new.sentence
+      publisher "publisher" output.check
+      address output
+      format.edition output
+      format.date "year" output.check
+    }
+    { format.incoll.inproc.crossref output.nonnull
+      format.chapter.pages output
+    }
+  if$
+  new.block
+  note output
+  fin.entry
+}
+
+FUNCTION {inproceedings}
+{ output.bibitem
+  format.authors "author" output.check
+  new.block
+  format.title "title" output.check
+  new.block
+  crossref missing$
+    { format.in.ed.booktitle "booktitle" output.check
+      format.bvolume output
+      format.number.series output
+      format.pages output
+      address empty$
+{ organization publisher new.sentence.checkb
+  organization output
+  publisher output
+  format.date "year" output.check
+}
+{ address output.nonnull
+  format.date "year" output.check
+  new.sentence
+  organization output
+  publisher output
+}
+      if$
+    }
+    { format.incoll.inproc.crossref output.nonnull
+      format.pages output
+    }
+  if$
+  new.block
+  note output
+  fin.entry
+}
+
+FUNCTION {conference} { inproceedings }
+
+FUNCTION {manual}
+{ output.bibitem
+  author empty$
+    { organization empty$
+'skip$
+{ organization output.nonnull
+  address output
+}
+      if$
+    }
+    { format.authors output.nonnull }
+  if$
+  new.block
+  format.btitle "title" output.check
+  author empty$
+    { organization empty$
+{ address new.block.checka
+  address output
+}
+'skip$
+      if$
+    }
+    { organization address new.block.checkb
+      organization output
+      address output
+    }
+  if$
+  format.edition output
+  format.date output
+  new.block
+  note output
+  fin.entry
+}
+
+FUNCTION {mastersthesis}
+{ output.bibitem
+  format.authors "author" output.check
+  new.block
+  format.title "title" output.check
+  new.block
+  bbl.mthesis
+  format.thesis.type output.nonnull
+  school "school" output.check
+  address output
+  format.date "year" output.check
+  new.block
+  note output
+  fin.entry
+}
+
+FUNCTION {misc}
+{ output.bibitem
+  format.authors output
+  title howpublished new.block.checkb
+  format.title output
+  howpublished new.block.checka
+  howpublished output
+  format.date output
+  new.block
+  note output
+  fin.entry
+  empty.misc.check
+}
+
+FUNCTION {phdthesis}
+{ output.bibitem
+  format.authors "author" output.check
+  new.block
+  format.btitle "title" output.check
+  new.block
+  bbl.phdthesis
+  format.thesis.type output.nonnull
+  school "school" output.check
+  address output
+  format.date "year" output.check
+  new.block
+  note output
+  fin.entry
+}
+
+FUNCTION {proceedings}
+{ output.bibitem
+  editor empty$
+    { organization output }
+    { format.editors output.nonnull }
+  if$
+  new.block
+  format.btitle "title" output.check
+  format.bvolume output
+  format.number.series output
+  address empty$
+    { editor empty$
+{ publisher new.sentence.checka }
+{ organization publisher new.sentence.checkb
+  organization output
+}
+      if$
+      publisher output
+      format.date "year" output.check
+    }
+    { address output.nonnull
+      format.date "year" output.check
+      new.sentence
+      editor empty$
+'skip$
+{ organization output }
+      if$
+      publisher output
+    }
+  if$
+  new.block
+  note output
+  fin.entry
+}
+
+FUNCTION {techreport}
+{ output.bibitem
+  format.authors "author" output.check
+  new.block
+  format.title "title" output.check
+  new.block
+  format.tr.number output.nonnull
+  institution "institution" output.check
+  address output
+  format.date "year" output.check
+  new.block
+  note output
+  fin.entry
+}
+
+FUNCTION {unpublished}
+{ output.bibitem
+  format.authors "author" output.check
+  new.block
+  format.title "title" output.check
+  new.block
+  note "note" output.check
+  format.date output
+  fin.entry
+}
+
+FUNCTION {default.type} { misc }
+
+MACRO {jan} {"January"}
+
+MACRO {feb} {"February"}
+
+MACRO {mar} {"March"}
+
+MACRO {apr} {"April"}
+
+MACRO {may} {"May"}
+
+MACRO {jun} {"June"}
+
+MACRO {jul} {"July"}
+
+MACRO {aug} {"August"}
+
+MACRO {sep} {"September"}
+
+MACRO {oct} {"October"}
+
+MACRO {nov} {"November"}
+
+MACRO {dec} {"December"}
+
+MACRO {acmcs} {"ACM Computing Surveys"}
+
+MACRO {acta} {"Acta Informatica"}
+
+MACRO {cacm} {"Communications of the ACM"}
+
+MACRO {ibmjrd} {"IBM Journal of Research and Development"}
+
+MACRO {ibmsj} {"IBM Systems Journal"}
+
+MACRO {ieeese} {"IEEE Transactions on Software Engineering"}
+
+MACRO {ieeetc} {"IEEE Transactions on Computers"}
+
+MACRO {ieeetcad}
+ {"IEEE Transactions on Computer-Aided Design of Integrated Circuits"}
+
+MACRO {ipl} {"Information Processing Letters"}
+
+MACRO {jacm} {"Journal of the ACM"}
+
+MACRO {jcss} {"Journal of Computer and System Sciences"}
+
+MACRO {scp} {"Science of Computer Programming"}
+
+MACRO {sicomp} {"SIAM Journal on Computing"}
+
+MACRO {tocs} {"ACM Transactions on Computer Systems"}
+
+MACRO {tods} {"ACM Transactions on Database Systems"}
+
+MACRO {tog} {"ACM Transactions on Graphics"}
+
+MACRO {toms} {"ACM Transactions on Mathematical Software"}
+
+MACRO {toois} {"ACM Transactions on Office Information Systems"}
+
+MACRO {toplas} {"ACM Transactions on Programming Languages and Systems"}
+
+MACRO {tcs} {"Theoretical Computer Science"}
+
+READ
+
+FUNCTION {sortify}
+{
+  fa.isPersianLanguage
+    { "l" change.case$}
+    {purify$ "l" change.case$}
+  if$
+  %duplicate$ write$
+}
+
+INTEGERS { len }
+
+FUNCTION {chop.word}
+{ 's :=
+  'len :=
+  s #1 len substring$ =
+    { s len #1 + global.max$ substring$ }
+    's
+  if$
+}
+
+FUNCTION {sort.format.names}
+{ 's :=
+  #1 'nameptr :=
+  ""
+  s num.names$ 'numnames :=
+  numnames 'namesleft :=
+    { namesleft #0 > }
+      { nameptr #1 >
+    { "   " * }
+    'skip$
+      if$
+      s nameptr "{vv{ } }{ll{ }}{  ff{ }}{  jj{ }}" format.name$ 't :=
+      nameptr numnames = t "others" = and
+   { bbl.etal * }
+   %{ t write$ t sortify * t write$    }
+   { t sortify * }
+      if$
+  nameptr #1 + 'nameptr :=
+      namesleft #1 - 'namesleft :=
+    }
+  while$
+}
+
+FUNCTION {sort.format.title}
+{ 't :=
+  "A " #2
+    "An " #3
+      "The " #4 t chop.word
+    chop.word
+  chop.word
+  sortify
+  #1 global.max$ substring$
+}
+
+FUNCTION {author.sort}
+{ author empty$
+    { key empty$
+    { "to sort, need author or key in " cite$ * warning$
+     ""
+    }
+    { key sortify }
+      if$
+    }
+    { author sort.format.names }
+  if$
+}
+
+FUNCTION {author.editor.sort}
+{ author empty$
+    { editor empty$
+{ key empty$
+    { "to sort, need author, editor, or key in " cite$ * warning$
+      ""
+    }
+    { key sortify }
+  if$
+}
+{ editor sort.format.names }
+      if$
+    }
+    { author sort.format.names }
+  if$
+}
+
+FUNCTION {author.organization.sort}
+{ author empty$
+    { organization empty$
+{ key empty$
+    { "to sort, need author, organization, or key in " cite$ * warning$
+      ""
+    }
+    { key sortify }
+  if$
+}
+{ "The " #4 organization chop.word sortify }
+      if$
+    }
+    { author sort.format.names }
+  if$
+}
+
+FUNCTION {editor.organization.sort}
+{ editor empty$
+    { organization empty$
+{ key empty$
+    { "to sort, need editor, organization, or key in " cite$ * warning$
+      ""
+    }
+    { key sortify }
+  if$
+}
+{ "The " #4 organization chop.word sortify }
+      if$
+    }
+    { editor sort.format.names }
+  if$
+}
+
+FUNCTION {presort}
+{ type$ "book" =
+  type$ "inbook" =
+  or
+    'author.editor.sort
+    { type$ "proceedings" =
+'editor.organization.sort
+{ type$ "manual" =
+    'author.organization.sort
+    'author.sort
+  if$
+}
+      if$
+    }
+  if$
+  "    "
+  *
+  year field.or.null sortify
+  *
+  "    "
+  *
+  title field.or.null
+  sort.format.title
+  *
+  #1 entry.max$ substring$
+  'sort.key$ :=
+}
+
+ITERATE {presort}
+
+SORT
+
+STRINGS { longest.label }
+
+INTEGERS { number.label longest.label.width }
+
+FUNCTION {initialize.longest.label}
+{ "" 'longest.label :=
+  #1 'number.label :=
+  #0 'longest.label.width :=
+}
+
+FUNCTION {longest.label.pass}
+{ number.label int.to.str$ 'label :=
+  number.label #1 + 'number.label :=
+  label width$ longest.label.width >
+    { label 'longest.label :=
+      label width$ 'longest.label.width :=
+    }
+    'skip$
+  if$
+}
+
+EXECUTE {banner.message}
+EXECUTE {initialize.longest.label}
+
+ITERATE {longest.label.pass}
+
+FUNCTION {begin.bib}
+{
+  "% Generated by plain-fa.bst,  version: " bst.file.version * " (" * bst.file.date * "), for XePersian Package" *
+  write$ newline$
+  "% Authors: " bst.file.authors *
+  write$ newline$
+  "\providecommand{\noopsort}[1]{}"
+  write$ newline$
+  preamble$ empty$
+    'skip$
+    { preamble$ write$ newline$ }
+  if$
+  "\begin{thebibliography}{"  longest.label  * "}" * write$ newline$
+}
+
+EXECUTE {begin.bib}
+
+EXECUTE {init.state.consts}
+
+ITERATE {call.type$}
+
+FUNCTION {end.bib}
+{ newline$
+  "\end{thebibliography}" write$ newline$
+  "\Persian" write$ newline$
+}
+
+EXECUTE {end.bib}
+EXECUTE{completed.message}
+%% 
+%% Copyright ?? 2008-2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `plain-fa.bst'.

Added: tags/texmf/bibtex/bst/xepersian/unsrt-fa.bst
===================================================================
--- tags/texmf/bibtex/bst/xepersian/unsrt-fa.bst	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/bibtex/bst/xepersian/unsrt-fa.bst	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,1146 @@
+%%
+%% This is file `unsrt-fa.bst',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% xepersian.dtx  (with options: `unsrt-fa.bst')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2008-2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
+%% Bib. style "usrt-fa", Persian (farsi)  version of unsrt.bst
+%%
+%% by: Mahmood Amintoosi and Mostafa Vahedi
+%% For XePersian, a Persian Typsetting Package in XeTeX, Developed by:
+%% Vafa Khalighi, Mehdi Omidali and Mostafa Vahedi
+%% 2009/02/09
+%% It may be distributed and/or modified under the
+%% conditions of the LaTeX Project Public License, either this version
+%% of this license or (at your option) any later version.
+%%
+%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
+%% Original Copyright
+
+%%%%%%%%%%% History:
+
+ENTRY
+  { address
+    author
+    booktitle
+    chapter
+    edition
+    editor
+    howpublished
+    institution
+    journal
+    key
+language
+    month
+    note
+    number
+    organization
+    pages
+    publisher
+    school
+    series
+    title
+translator
+    type
+    volume
+    year
+  }
+  {}
+  { label }
+
+INTEGERS { output.state before.all mid.sentence after.sentence after.block }
+STRINGS {bbl.and bbl.etal bbl.editors bbl.editor bbl.edition bbl.volume bbl.of bbl.number
+ bbl.in bbl.pages bbl.page bbl.chapter bbl.series bbl.techrep bbl.mthesis bbl.phdthesis
+ bbl.translator }
+FUNCTION {is.print.banners.to.terminal} { #1 }
+%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
+%% FILE VERSION AND BANNER %%
+%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
+
+FUNCTION{bst.file.version} { "0.22" }
+FUNCTION{bst.file.date} { "2009/02/09" }
+FUNCTION{bst.file.website} { "http://developer.berlios.de/projects/xepersian" }
+FUNCTION{bst.file.authors} {"M.Amintoosi and M.Vahedi" }
+
+FUNCTION {banner.message}
+{ is.print.banners.to.terminal
+     { "-- unsrt-fa.bst version" " " * bst.file.version *
+       " (" * bst.file.date * ") " * %"by " * bst.file.authors *
+       top$
+       "-- This is a BibTeX style for XePersian: " bst.file.website *
+       %top$
+       %"-- See the " quote$ * "xepersian_bibtex_userguide.pdf" * quote$ * " manual for usage information." *
+       top$
+     }
+     { skip$ }
+   if$
+}
+
+FUNCTION {completed.message}
+{ is.print.banners.to.terminal
+     { ""
+       top$
+       "Done."
+       top$
+     }
+     { skip$ }
+   if$
+}
+
+%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
+%% Persian Functions    %%
+%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
+
+FUNCTION {fa.isPersianLanguage}
+{
+  language missing$
+    {#0}
+    {language "l" change.case$ "persian" =}
+  if$
+}
+
+FUNCTION {keywords.fa}
+{
+  " ?? "  'bbl.and  :=
+  " ?? ????????????"  'bbl.etal  :=
+  " ???????????????????? "  'bbl.editors  :=
+  " ??????????????????? "  'bbl.editor  :=
+  " ???????????? "  'bbl.edition    :=
+  " ?????? "  'bbl.volume :=
+  " ???? "  'bbl.of :=
+  " ?????????? "  'bbl.number :=
+  " ???? "  'bbl.in  :=
+  " ?????????? "  'bbl.pages  :=
+  " ??."  'bbl.page  :=
+  " ?????? "  'bbl.chapter :=
+  " ?????? " 'bbl.series :=
+  " ?????????? ?????? ????????????" 'bbl.techrep :=
+  " ????????????????????? ???????????????????????????" 'bbl.mthesis  :=
+  " ????????????????????? ??????????"  'bbl.phdthesis :=
+  " ??????????????? " 'bbl.translator :=
+}
+
+FUNCTION {keywords.en}
+{
+  " and "  'bbl.and  :=
+  " et~al."  'bbl.etal  :=
+  " eds."  'bbl.editors  :=
+  " ed."  'bbl.editor  :=
+  " ed."  'bbl.edition    :=
+  " Vol."  'bbl.volume :=
+  " of "  'bbl.of :=
+  " No."  'bbl.number :=
+  " In "  'bbl.in  :=
+  " pp."  'bbl.pages  :=
+  " p."  'bbl.page  :=
+  " Ch."  'bbl.chapter :=
+  " Ser." 'bbl.series :=
+  " Tech. Rep." 'bbl.techrep :=
+  " Master's thesis" 'bbl.mthesis  :=
+  " Ph.D. disseration"  'bbl.phdthesis :=
+  " Translator " 'bbl.translator :=
+}
+
+%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
+%% End of Persian Functions %%
+%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
+
+FUNCTION {init.state.consts}
+{ #0 'before.all :=
+  #1 'mid.sentence :=
+  #2 'after.sentence :=
+  #3 'after.block :=
+}
+
+STRINGS { s t }
+
+FUNCTION {output.nonnull}
+{ 's :=
+  output.state mid.sentence =
+    { ", " * write$ }
+    { output.state after.block =
+{ add.period$ write$
+  newline$
+  "\newblock " write$
+}
+{ output.state before.all =
+    'write$
+    { add.period$ " " * write$ }
+  if$
+}
+      if$
+      mid.sentence 'output.state :=
+    }
+  if$
+  s
+}
+
+FUNCTION {output}
+{ duplicate$ empty$
+    'pop$
+    'output.nonnull
+  if$
+}
+
+FUNCTION {output.check}
+{ 't :=
+  duplicate$ empty$
+    { pop$ "empty " t * " in " * cite$ * warning$ }
+    'output.nonnull
+  if$
+}
+
+FUNCTION {output.bibitem}
+{ newline$
+  fa.isPersianLanguage
+    { keywords.fa
+  "\Persian" write$
+      newline$ }
+    { keywords.en
+  "\Latin" write$
+      newline$ }
+  if$
+  "\bibitem{" write$
+  cite$ write$
+  "}" write$
+  newline$
+  ""
+  before.all 'output.state :=
+}
+
+FUNCTION {fin.entry}
+{ add.period$
+  write$
+  newline$
+}
+
+FUNCTION {new.block}
+{ output.state before.all =
+    'skip$
+    { after.block 'output.state := }
+  if$
+}
+
+FUNCTION {new.sentence}
+{ output.state after.block =
+    'skip$
+    { output.state before.all =
+'skip$
+{ after.sentence 'output.state := }
+      if$
+    }
+  if$
+}
+
+FUNCTION {not}
+{   { #0 }
+    { #1 }
+  if$
+}
+
+FUNCTION {and}
+{   'skip$
+    { pop$ #0 }
+  if$
+}
+
+FUNCTION {or}
+{   { pop$ #1 }
+    'skip$
+  if$
+}
+
+FUNCTION {new.block.checka}
+{ empty$
+    'skip$
+    'new.block
+  if$
+}
+
+FUNCTION {new.block.checkb}
+{ empty$
+  swap$ empty$
+  and
+    'skip$
+    'new.block
+  if$
+}
+
+FUNCTION {new.sentence.checka}
+{ empty$
+    'skip$
+    'new.sentence
+  if$
+}
+
+FUNCTION {new.sentence.checkb}
+{ empty$
+  swap$ empty$
+  and
+    'skip$
+    'new.sentence
+  if$
+}
+
+FUNCTION {field.or.null}
+{ duplicate$ empty$
+    { pop$ "" }
+    'skip$
+  if$
+}
+
+FUNCTION {emphasize}
+{ duplicate$ empty$
+    { pop$ "" }
+    { "{\em " swap$ * "}" * }
+  if$
+}
+
+INTEGERS { nameptr namesleft numnames }
+
+FUNCTION {format.names}
+{ 's :=
+  #1 'nameptr :=
+  s num.names$ 'numnames :=
+  numnames 'namesleft :=
+    { namesleft #0 > }
+    { s nameptr "{vv~}{ll}{, jj}{, ff}" format.name$ 't := %{ff}{vv~}{ll}{, jj}
+      nameptr #1 >
+{ namesleft #1 >
+    { ", " * t * }
+    { numnames #2 >
+{ "," * }
+'skip$
+      if$
+  t "others" =
+     { bbl.etal * }
+     { bbl.and * t * }
+      if$
+}
+  if$
+}
+'t
+      if$
+      nameptr #1 + 'nameptr :=
+      namesleft #1 - 'namesleft :=
+    }
+  while$
+}
+
+FUNCTION {format.authors}
+{ author empty$
+    { "" }
+    { author format.names }
+  if$
+}
+
+FUNCTION {format.editors}
+{ editor empty$
+    { "" }
+    { fa.isPersianLanguage
+    {
+editor num.names$ #1 >
+{bbl.editors editor format.names * }
+{bbl.editor editor format.names * }
+if$
+}
+{
+  editor format.names
+editor num.names$ #1 >
+{ ", " bbl.editors * *}
+{ ", " bbl.editor * *}
+if$
+}
+  if$
+    }
+  if$
+}
+
+FUNCTION {format.translators}
+{ translator empty$
+    { "" }
+    { fa.isPersianLanguage
+    {
+bbl.translator translator format.names *
+}
+{
+  translator format.names
+", " bbl.translator * *
+}
+  if$
+    }
+  if$
+}
+
+FUNCTION {format.title}
+{ title empty$
+    { "" }
+    { title "t" change.case$ }
+  if$
+}
+
+FUNCTION {n.dashify}
+{ 't :=
+  ""
+    { t empty$ not }
+    { t #1 #1 substring$ "-" =
+{ t #1 #2 substring$ "--" = not
+    { "--" *
+      t #2 global.max$ substring$ 't :=
+    }
+    {   { t #1 #1 substring$ "-" = }
+{ "-" *
+  t #2 global.max$ substring$ 't :=
+}
+      while$
+    }
+  if$
+}
+{ t #1 #1 substring$ *
+  t #2 global.max$ substring$ 't :=
+}
+      if$
+    }
+  while$
+}
+
+FUNCTION {format.date}
+{ year empty$
+    { month empty$
+{ "" }
+{ "there's a month but no year in " cite$ * warning$
+  month
+}
+      if$
+    }
+    { month empty$
+'year
+{ month " " * year * }
+      if$
+    }
+  if$
+}
+
+FUNCTION {format.btitle}
+{ title emphasize
+}
+
+FUNCTION {tie.or.space.connect}
+{ duplicate$ text.length$ #3 <
+    { "~" }
+    { " " }
+  if$
+  swap$ * *
+}
+
+FUNCTION {either.or.check}
+{ empty$
+    'pop$
+    { "can't use both " swap$ * " fields in " * cite$ * warning$ }
+  if$
+}
+
+FUNCTION {format.bvolume}
+{ volume empty$
+    { "" }
+    { bbl.volume volume tie.or.space.connect
+      series empty$
+'skip$
+{ bbl.of * series emphasize * }
+      if$
+      "volume and number" number either.or.check
+    }
+  if$
+}
+
+FUNCTION {format.number.series}
+{ volume empty$
+    { number empty$
+{ series field.or.null }
+{ output.state mid.sentence =
+    { bbl.number }
+    { bbl.number "t" change.case$ }
+  if$
+  number tie.or.space.connect
+  series empty$
+    { "there's a number but no series in " cite$ * warning$ }
+    { bbl.in * series * }
+  if$
+}
+      if$
+    }
+    { "" }
+  if$
+}
+
+FUNCTION {format.edition}
+{ edition empty$
+    { "" }
+    { fa.isPersianLanguage
+    {
+   bbl.edition edition *
+}
+{
+      output.state mid.sentence =
+       { edition "l" change.case$ bbl.edition * }
+       { edition "t" change.case$ bbl.edition * }
+          if$
+}
+  if$
+    }
+  if$
+}
+
+INTEGERS { multiresult }
+
+FUNCTION {multi.page.check}
+{ 't :=
+  #0 'multiresult :=
+    { multiresult not
+      t empty$ not
+      and
+    }
+    { t #1 #1 substring$
+      duplicate$ "-" =
+      swap$ duplicate$ "," =
+      swap$ "+" =
+      or or
+{ #1 'multiresult := }
+{ t #2 global.max$ substring$ 't := }
+      if$
+    }
+  while$
+  multiresult
+}
+
+FUNCTION {format.pages}
+{ pages empty$
+    { "" }
+{  pages multi.page.check
+    { bbl.pages pages n.dashify tie.or.space.connect }
+    { bbl.page pages tie.or.space.connect }
+       if$
+    }
+  if$
+}
+
+FUNCTION {format.vol.num.pages}
+{ volume field.or.null
+  number empty$
+    'skip$
+    { "(" number * ")" * *
+      volume empty$
+{ "there's a number but no volume in " cite$ * warning$ }
+'skip$
+      if$
+    }
+  if$
+  pages empty$
+    'skip$
+    { duplicate$ empty$
+{ pop$ format.pages }
+{ ":" * pages n.dashify * }
+      if$
+    }
+  if$
+}
+
+FUNCTION {format.chapter.pages}
+{ chapter empty$
+    'format.pages
+    { type empty$
+{ bbl.chapter }
+{ type "l" change.case$ }
+      if$
+      chapter tie.or.space.connect
+      pages empty$
+'skip$
+{ ", " * format.pages * }
+      if$
+    }
+  if$
+}
+
+FUNCTION {format.in.ed.booktitle}
+{
+  booktitle empty$
+    { "" }
+    { editor empty$
+    { bbl.in booktitle emphasize * }
+    { bbl.in format.editors * ", " * booktitle emphasize * }
+  if$
+}
+  if$
+}
+
+FUNCTION {empty.misc.check}
+{ author empty$ title empty$ howpublished empty$
+  month empty$ year empty$ note empty$
+  and and and and and
+    { "all relevant fields are empty in " cite$ * warning$ }
+    'skip$
+  if$
+}
+
+FUNCTION {format.thesis.type}
+{ type empty$
+    'skip$
+    { pop$
+      type "t" change.case$
+    }
+  if$
+}
+
+FUNCTION {format.tr.number}
+{ type empty$
+    { bbl.techrep }
+    'type
+  if$
+  number empty$
+    { "t" change.case$ }
+    { number tie.or.space.connect }
+  if$
+}
+
+FUNCTION {format.article.crossref}
+{ key empty$
+    { journal empty$
+{ "need key or journal for " cite$ * " to crossref " * crossref *
+  warning$
+  ""
+}
+{ bbl.in "{\em " * journal * "\/}" * }
+      if$
+    }
+    { bbl.in key * }
+  if$
+  " \cite{" * crossref * "}" *
+}
+
+FUNCTION {format.crossref.editor}
+{ editor #1 "{vv~}{ll}" format.name$
+  editor num.names$ duplicate$  #2 >
+    { pop$ bbl.etal * }
+    { #2 < 'skip$
+    { editor #2 "{ff }{vv }{ll}{ jj}" format.name$ "others" =
+      { bbl.etal * }
+      { bbl.and * editor #2 "{vv~}{ll}" format.name$ * }
+    if$
+    }
+    if$
+    }
+  if$
+}
+
+FUNCTION {format.book.crossref}
+{ volume empty$
+    { "empty volume in " cite$ * "'s crossref of " * crossref * warning$
+      bbl.in
+    }
+    { bbl.volume volume tie.or.space.connect
+      bbl.of *
+    }
+  if$
+  editor empty$
+  editor field.or.null author field.or.null =
+  or
+    { key empty$
+{ series empty$
+    { "need editor, key, or series for " cite$ * " to crossref " *
+      crossref * warning$
+      "" *
+    }
+    { "{\em " * series * "\/}" * }
+  if$
+}
+{ key * }
+      if$
+    }
+    { format.crossref.editor * }
+  if$
+  " \cite{" * crossref * "}" *
+}
+
+FUNCTION {format.incoll.inproc.crossref}
+{ editor empty$
+  editor field.or.null author field.or.null =
+  or
+    { key empty$
+{ booktitle empty$
+    { "need editor, key, or booktitle for " cite$ * " to crossref " *
+      crossref * warning$
+      ""
+    }
+    { bbl.in " {\em " * booktitle * "\/}" * }
+  if$
+}
+{ bbl.in key * }
+      if$
+    }
+    { bbl.in format.crossref.editor * }
+  if$
+  " \cite{" * crossref * "}" *
+}
+
+FUNCTION {article}
+{ output.bibitem
+  format.authors "author" output.check
+  new.block
+  format.title "title" output.check
+  new.block
+  crossref missing$
+    { journal emphasize "journal" output.check
+      format.vol.num.pages output
+      format.date "year" output.check
+    }
+    { format.article.crossref output.nonnull
+      format.pages output
+    }
+  if$
+  new.block
+  note output
+  fin.entry
+}
+
+FUNCTION {book}
+{ output.bibitem
+  fa.isPersianLanguage
+  {
+format.authors  output
+    new.block
+    format.btitle "title" output.check
+new.block
+    format.translators output
+format.editors  output
+  }
+  { author empty$
+      { format.editors "author and editor" output.check }
+      { format.authors output.nonnull
+        crossref missing$
+      { "author and editor" editor either.or.check }
+      'skip$
+        if$
+      }
+    if$
+    new.block
+    format.btitle "title" output.check
+  }
+  if$
+  crossref missing$
+    { format.bvolume output
+      new.block
+      format.number.series output
+      new.sentence
+      publisher "publisher" output.check
+      address output
+    }
+    { new.block
+      format.book.crossref output.nonnull
+    }
+  if$
+  format.edition output
+  format.date "year" output.check
+  new.block
+  note output
+  fin.entry
+}
+
+FUNCTION {booklet}
+{ output.bibitem
+  format.authors output
+  new.block
+  format.title "title" output.check
+  howpublished address new.block.checkb
+  howpublished output
+  address output
+  format.date output
+  new.block
+  note output
+  fin.entry
+}
+
+FUNCTION {inbook}
+{ output.bibitem
+  author empty$
+    { format.editors "author and editor" output.check }
+    { format.authors output.nonnull
+      crossref missing$
+{ "author and editor" editor either.or.check }
+'skip$
+      if$
+    }
+  if$
+  new.block
+  format.btitle "title" output.check
+  crossref missing$
+    { format.bvolume output
+      format.chapter.pages "chapter and pages" output.check
+      new.block
+      format.number.series output
+      new.sentence
+      publisher "publisher" output.check
+      address output
+    }
+    { format.chapter.pages "chapter and pages" output.check
+      new.block
+      format.book.crossref output.nonnull
+    }
+  if$
+  format.edition output
+  format.date "year" output.check
+  new.block
+  note output
+  fin.entry
+}
+
+FUNCTION {incollection}
+{ output.bibitem
+  format.authors "author" output.check
+  new.block
+  format.title "title" output.check
+  new.block
+  crossref missing$
+    { format.in.ed.booktitle "booktitle" output.check
+      format.bvolume output
+      format.number.series output
+      format.chapter.pages output
+      new.sentence
+      publisher "publisher" output.check
+      address output
+      format.edition output
+      format.date "year" output.check
+    }
+    { format.incoll.inproc.crossref output.nonnull
+      format.chapter.pages output
+    }
+  if$
+  new.block
+  note output
+  fin.entry
+}
+
+FUNCTION {inproceedings}
+{ output.bibitem
+  format.authors "author" output.check
+  new.block
+  format.title "title" output.check
+  new.block
+  crossref missing$
+    { format.in.ed.booktitle "booktitle" output.check
+      format.bvolume output
+      format.number.series output
+      format.pages output
+      address empty$
+{ organization publisher new.sentence.checkb
+  organization output
+  publisher output
+  format.date "year" output.check
+}
+{ address output.nonnull
+  format.date "year" output.check
+  new.sentence
+  organization output
+  publisher output
+}
+      if$
+    }
+    { format.incoll.inproc.crossref output.nonnull
+      format.pages output
+    }
+  if$
+  new.block
+  note output
+  fin.entry
+}
+
+FUNCTION {conference} { inproceedings }
+
+FUNCTION {manual}
+{ output.bibitem
+  author empty$
+    { organization empty$
+'skip$
+{ organization output.nonnull
+  address output
+}
+      if$
+    }
+    { format.authors output.nonnull }
+  if$
+  new.block
+  format.btitle "title" output.check
+  author empty$
+    { organization empty$
+{ address new.block.checka
+  address output
+}
+'skip$
+      if$
+    }
+    { organization address new.block.checkb
+      organization output
+      address output
+    }
+  if$
+  format.edition output
+  format.date output
+  new.block
+  note output
+  fin.entry
+}
+
+FUNCTION {mastersthesis}
+{ output.bibitem
+  format.authors "author" output.check
+  new.block
+  format.title "title" output.check
+  new.block
+  bbl.mthesis
+  format.thesis.type output.nonnull
+  school "school" output.check
+  address output
+  format.date "year" output.check
+  new.block
+  note output
+  fin.entry
+}
+
+FUNCTION {misc}
+{ output.bibitem
+  format.authors output
+  title howpublished new.block.checkb
+  format.title output
+  howpublished new.block.checka
+  howpublished output
+  format.date output
+  new.block
+  note output
+  fin.entry
+  empty.misc.check
+}
+
+FUNCTION {phdthesis}
+{ output.bibitem
+  format.authors "author" output.check
+  new.block
+  format.btitle "title" output.check
+  new.block
+  bbl.phdthesis
+  format.thesis.type output.nonnull
+  school "school" output.check
+  address output
+  format.date "year" output.check
+  new.block
+  note output
+  fin.entry
+}
+
+FUNCTION {proceedings}
+{ output.bibitem
+  editor empty$
+    { organization output }
+    { format.editors output.nonnull }
+  if$
+  new.block
+  format.btitle "title" output.check
+  format.bvolume output
+  format.number.series output
+  address empty$
+    { editor empty$
+{ publisher new.sentence.checka }
+{ organization publisher new.sentence.checkb
+  organization output
+}
+      if$
+      publisher output
+      format.date "year" output.check
+    }
+    { address output.nonnull
+      format.date "year" output.check
+      new.sentence
+      editor empty$
+'skip$
+{ organization output }
+      if$
+      publisher output
+    }
+  if$
+  new.block
+  note output
+  fin.entry
+}
+
+FUNCTION {techreport}
+{ output.bibitem
+  format.authors "author" output.check
+  new.block
+  format.title "title" output.check
+  new.block
+  format.tr.number output.nonnull
+  institution "institution" output.check
+  address output
+  format.date "year" output.check
+  new.block
+  note output
+  fin.entry
+}
+
+FUNCTION {unpublished}
+{ output.bibitem
+  format.authors "author" output.check
+  new.block
+  format.title "title" output.check
+  new.block
+  note "note" output.check
+  format.date output
+  fin.entry
+}
+
+FUNCTION {default.type} { misc }
+
+MACRO {jan} {"January"}
+
+MACRO {feb} {"February"}
+
+MACRO {mar} {"March"}
+
+MACRO {apr} {"April"}
+
+MACRO {may} {"May"}
+
+MACRO {jun} {"June"}
+
+MACRO {jul} {"July"}
+
+MACRO {aug} {"August"}
+
+MACRO {sep} {"September"}
+
+MACRO {oct} {"October"}
+
+MACRO {nov} {"November"}
+
+MACRO {dec} {"December"}
+
+MACRO {acmcs} {"ACM Computing Surveys"}
+
+MACRO {acta} {"Acta Informatica"}
+
+MACRO {cacm} {"Communications of the ACM"}
+
+MACRO {ibmjrd} {"IBM Journal of Research and Development"}
+
+MACRO {ibmsj} {"IBM Systems Journal"}
+
+MACRO {ieeese} {"IEEE Transactions on Software Engineering"}
+
+MACRO {ieeetc} {"IEEE Transactions on Computers"}
+
+MACRO {ieeetcad}
+ {"IEEE Transactions on Computer-Aided Design of Integrated Circuits"}
+
+MACRO {ipl} {"Information Processing Letters"}
+
+MACRO {jacm} {"Journal of the ACM"}
+
+MACRO {jcss} {"Journal of Computer and System Sciences"}
+
+MACRO {scp} {"Science of Computer Programming"}
+
+MACRO {sicomp} {"SIAM Journal on Computing"}
+
+MACRO {tocs} {"ACM Transactions on Computer Systems"}
+
+MACRO {tods} {"ACM Transactions on Database Systems"}
+
+MACRO {tog} {"ACM Transactions on Graphics"}
+
+MACRO {toms} {"ACM Transactions on Mathematical Software"}
+
+MACRO {toois} {"ACM Transactions on Office Information Systems"}
+
+MACRO {toplas} {"ACM Transactions on Programming Languages and Systems"}
+
+MACRO {tcs} {"Theoretical Computer Science"}
+
+READ
+
+STRINGS { longest.label }
+
+INTEGERS { number.label longest.label.width }
+
+FUNCTION {initialize.longest.label}
+{ "" 'longest.label :=
+  #1 'number.label :=
+  #0 'longest.label.width :=
+}
+
+FUNCTION {longest.label.pass}
+{ number.label int.to.str$ 'label :=
+  number.label #1 + 'number.label :=
+  label width$ longest.label.width >
+    { label 'longest.label :=
+      label width$ 'longest.label.width :=
+    }
+    'skip$
+  if$
+}
+
+EXECUTE {banner.message}
+EXECUTE {initialize.longest.label}
+
+ITERATE {longest.label.pass}
+
+FUNCTION {begin.bib}
+{
+  "% Generated by unsrt-fa.bst,  version: " bst.file.version * " (" * bst.file.date * "), for XePersian Package" *
+  write$ newline$
+  "% Authors: " bst.file.authors *
+  write$ newline$
+  "\providecommand{\noopsort}[1]{}"
+  write$ newline$
+  preamble$ empty$
+    'skip$
+    { preamble$ write$ newline$ }
+  if$
+  "\begin{thebibliography}{"  longest.label  * "}" * write$ newline$
+}
+
+EXECUTE {begin.bib}
+
+EXECUTE {init.state.consts}
+
+ITERATE {call.type$}
+
+FUNCTION {end.bib}
+{ newline$
+  "\end{thebibliography}" write$ newline$
+  "\Persian" write$ newline$
+}
+
+EXECUTE {end.bib}
+EXECUTE{completed.message}
+%% 
+%% Copyright ?? 2008-2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `unsrt-fa.bst'.

Added: tags/texmf/doc/bidi/README.txt
===================================================================
--- tags/texmf/doc/bidi/README.txt	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/doc/bidi/README.txt	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,15 @@
+_________________
+The bidi package
+v1.0.1
+
+This package provides a convenient interface for typesetting
+bidirectional texts with XeLaTeX.
+
+This version fixes all known bugs and adds heaps of new things.
+
+______________
+Vafa Khalighi
+vafa at users.berlios.de
+
+Copyright 2007-2009
+Distributed under the LaTeX Project Public License

Added: tags/texmf/doc/bidi/bidi.pdf
===================================================================
(Binary files differ)


Property changes on: tags/texmf/doc/bidi/bidi.pdf
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: tags/texmf/doc/bidi/examples/beamer-sample.tex
===================================================================
--- tags/texmf/doc/bidi/examples/beamer-sample.tex	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/doc/bidi/examples/beamer-sample.tex	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,94 @@
+\documentclass{beamer}
+\usetheme{Warsaw}
+\usepackage{fontspec}
+\setmainfont[Script=Arabic,Mapping=farsidigits]{XB Niloofar}
+\def\familydefault{\rmdefault}
+\newfontfamily\rmfamily[Mapping=tex-text]{Linux Libertine}
+\usepackage{bidi}
+\newenvironment{latin}{\begin{LTR}\rmfamily}{\end{LTR}}
+\def\biditheoremname{????????}
+\def\bidicorollaryname{??????????}
+\def\bidifactname{??????????}
+\def\bidilemmaname{????}
+\def\bidiproblemname{??????????}
+\def\bidisolutionname{????????}
+\def\bididefinitionname{??????????}
+\def\bididefinitionsname{?????????????????}
+\def\bidiexamplename{????????}
+\def\bidiexamplesname{???????????????}
+\def\bidiproofname{??????????}
+\title{?????????? ????????????}
+\subtitle{?????? ???? ???????????????? ??????}
+\author{?????? ??????????}
+\institute{?????????????? ??????????}
+\begin{document}
+\begin{frame}
+\titlepage
+\end{frame}
+
+\begin{frame}{?????? ???? ?????????? ??????}
+\framesubtitle{?????? ???????????????? ??????}
+\begin{bidiexample}
+???? ?????? ???????? ???? ???????? ???????????? ???????????? ???????????? ???? ???????? ???? ???????? ?????????????? ??????????:
+\begin{equation}
+(x-y)^2=x^2-2xy+y^2
+\end{equation}
+\end{bidiexample}
+\begin{bidisolution}
+?????? ???? ???????? ??????
+\end{bidisolution}
+\begin{bidiproblem}
+?????? ???? ?????????? ??????.
+\end{bidiproblem}
+\end{frame}
+\begin{frame}{???????????? ?????????? ????????}
+\framesubtitle{???????????? ???????????????? ????????}
+\begin{biditheorem}
+?????? ???? ???????? ??????.
+\end{biditheorem}
+\begin{bidiproof}
+?????? ???? ?????????? ??????
+\end{bidiproof}
+\begin{bidicorollary}
+?????? ???? ?????????? ??????
+\end{bidicorollary}
+\begin{bidifact}
+?????? ???? ?????????? ??????
+\end{bidifact}
+\end{frame}
+\begin{frame}{???????????? ?????????? ????????}
+\framesubtitle{???????????? ???????????????? ????????}
+\begin{bidilemma}
+?????? ???? ???? ??????
+\end{bidilemma}
+\begin{bididefinition}
+?????? ???? ?????????? ??????
+\end{bididefinition}
+\begin{bididefinitions}
+?????? ???????? ?????????? ?????????? ???? ???? ?????????? ??????
+\end{bididefinitions}
+\begin{bidiexamples}
+?????? ???????? ?????????? ?????????? ???? ???? ???????? ??????.
+\end{bidiexamples}
+\end{frame}
+\begin{frame}{???????????? ?????????? ????????}
+\framesubtitle{???????????? ???????????????? ????????}
+\begin{bidiblock}{???????? ????????}
+?????? ???????? ???????? ??????
+\end{bidiblock}
+\begin{bidiexampleblock}{???????? ???????? ????????}
+?????? ???????? ???????? ???????? ??????
+\end{bidiexampleblock}
+\begin{bidialertblock}{???????? ???????? ??????????}
+?????? ???????? ???????? ?????????? ??????.
+\end{bidialertblock}
+\end{frame}
+\begin{frame}{???????????? ?????????? ????????}
+\framesubtitle{???????????? ???????????????? ????????}
+?????? ???? ???????????? ?????? ???????????? ????????????????? ???? ???????????? ???? ???? ???????? ???????? ?? ?????????? ???? ?????? ???????????? \lr{beamer} ?????? ???? ?????????? ??????????????????? ???? ????
+\begin{latin}
+This is an English paragraph that I am writing here to see what happens after this, will I get a new bug or I am lucky enough?
+\end{latin}
+?????? ???????????? ???????? ?????? ?????????? ???? ???? ???? ???? ????????????????? ?? ???????? ???? ?????? ???????????? ???????? ???? ???????????? ???? ???? ???????? ???????? ?? ?????????? ???? ???????????? ??????.
+\end{frame}
+\end{document}

Added: tags/texmf/doc/bidi/examples/bidicasual-samplecv.tex
===================================================================
--- tags/texmf/doc/bidi/examples/bidicasual-samplecv.tex	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/doc/bidi/examples/bidicasual-samplecv.tex	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,71 @@
+\documentclass[11pt,a4paper]{bidimoderncv}
+\cvtheme[red]{bidicasual} % you can use orange, red, green and blue as options
+\usepackage[scale=0.8]{geometry}
+\usepackage{fontspec}
+\usepackage[RTLdocument]{bidi}
+\def\refname{??????????????}
+\setmainfont[Script=Arabic,Mapping=parsidigits]{XB Niloofar}
+\newfontfamily\rmfamily[Mapping=tex-text]{Linux Libertine}
+\AtBeginDocument{\recomputelengths}
+\resumename{??????????}
+\firstname{?????? ????????}
+\familyname{???????? ??????????????}
+\title{???????????? ????}
+\address{???????????? ???????????? ?????????? ???????? ??}
+\mobile{????????????????????}
+\phone{????????????????}
+\fax{????????????????}
+\email{vafa at users.berlios.de}
+\extrainfo{?????????????? ??????????}
+\photo[64pt]{picture}
+\quote{?????? ??????}
+\begin{document}
+\maketitle
+\section{??????????????}
+\cventry{??????--??????}{????????}{??????????????}{??????}{\textit{????????}}{??????????}   % arguments 3 to 6 are optional
+\cventry{??????--??????}{????????}{??????????????}{??????}{\textit{????????}}{??????????}  % arguments 3 to 6 are optional
+
+\section{??????????????????????? ???????????????? ????????}
+\cvline{??????????}{\emph{??????????}}
+\cvline{?????????? ????????????}{?????????? ????????????}
+\cvline{??????????}{\small ?????????? ???????? ?????????????????????}
+
+\section{??????????????}
+\subsection{??????????}
+\cventry{??????--??????}{?????? ??????}{???????? ??????}{??????}{}{??????????}                % arguments 3 to 6 are optional
+\cventry{??????--??????}{?????? ??????}{???????? ??????}{??????}{}{??????????}                % arguments 3 to 6 are optional
+\subsection{????????????}
+\cventry{??????--??????}{?????? ??????}{???????? ??????}{??????}{}{?????????? ???? ??\newline{}?????????? ???? ??}% arguments 3 to 6 are optional
+
+\section{????????????}
+\cvlanguage{???????? ??}{???????? ??????????}{??????}
+\cvlanguage{???????? ??}{???????? ??????????}{??????}
+\cvlanguage{???????? ??}{???????? ??????????}{??????}
+
+\section{???????????????? ???????????????????}
+\cvcomputer{???????? ??}{?????? ?????? ????}{???????? ??}{?????? ?????? ????}
+\cvcomputer{???????? ??}{?????? ?????? ????}{???????? ??}{?????? ?????? ????}
+\cvcomputer{???????? ??}{?????? ?????? ????}{???????? ??}{?????? ?????? ????}
+
+\section{?????????????????}
+\cvline{?????????? ??}{\small ??????????}
+\cvline{?????????? ??}{\small ??????????}
+\cvline{?????????? ??}{\small ??????????}
+
+\renewcommand{\listitemsymbol}{-} % change the symbol for lists
+
+\section{???????? ??}
+\cvlistitem{?????????? ??}
+\cvlistitem{?????????? ??}
+\cvlistitem[+]{?????????? ??}            % optional other symbol
+
+\section{???????? ??}
+\cvlistdoubleitem[\Neutral]{?????????? ??}{?????????? ??}
+\cvlistdoubleitem[\Neutral]{?????????? ??}{?????????? ??}
+\cvlistdoubleitem[\Neutral]{?????????? ??}{}
+
+\nocite{*}
+\bibliographystyle{plain}
+\bibliography{publications}       % 'publications' is the name of a BibTeX file
+
+\end{document}

Added: tags/texmf/doc/bidi/examples/bidiclassic-samplecv.tex
===================================================================
--- tags/texmf/doc/bidi/examples/bidiclassic-samplecv.tex	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/doc/bidi/examples/bidiclassic-samplecv.tex	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,71 @@
+\documentclass[11pt,a4paper]{bidimoderncv}
+\cvtheme[orange]{bidiclassic} % you can use orange, red, green, grey and blue as options
+\usepackage[scale=0.8]{geometry}
+\usepackage{fontspec}
+\setmainfont[Script=Arabic,Mapping=parsidigits]{XB Zar}
+\newfontfamily\rmfamily[Mapping=tex-text]{Linux Libertine}
+\def\refname{??????????????}
+\usepackage[RTLdocument]{bidi}
+\AtBeginDocument{\recomputelengths}
+\resumename{??????????}
+\firstname{??????}
+\familyname{??????????}
+\title{???????????? ????}
+\address{???????????? ???????????? ?????????? ???????? ??}
+\mobile{????????????????????}
+\phone{????????????????}
+\fax{????????????????}
+\email{me at you.com}
+\extrainfo{?????????????? ??????????}
+\photo[64pt]{picture}
+\quote{?????? ??????}
+\begin{document}
+\maketitle
+\section{??????????????}
+\cventry{??????--??????}{????????}{??????????????}{??????}{\textit{????????}}{??????????}   % arguments 3 to 6 are optional
+\cventry{??????--??????}{????????}{??????????????}{??????}{\textit{????????}}{??????????}  % arguments 3 to 6 are optional
+
+\section{??????????????????????? ???????????????? ????????}
+\cvline{??????????}{\emph{??????????}}
+\cvline{?????????? ????????????}{?????????? ????????????}
+\cvline{??????????}{\small ?????????? ???????? ?????????????????????}
+
+\section{??????????????}
+\subsection{??????????}
+\cventry{??????--??????}{?????? ??????}{???????? ??????}{??????}{}{??????????}                % arguments 3 to 6 are optional
+\cventry{??????--??????}{?????? ??????}{???????? ??????}{??????}{}{??????????}                % arguments 3 to 6 are optional
+\subsection{????????????}
+\cventry{??????--??????}{?????? ??????}{???????? ??????}{??????}{}{?????????? ???? ??\newline{}?????????? ???? ??}% arguments 3 to 6 are optional
+
+\section{????????????}
+\cvlanguage{???????? ??}{???????? ??????????}{??????}
+\cvlanguage{???????? ??}{???????? ??????????}{??????}
+\cvlanguage{???????? ??}{???????? ??????????}{??????}
+
+\section{???????????????? ???????????????????}
+\cvcomputer{???????? ??}{?????? ?????? ????}{???????? ??}{?????? ?????? ????}
+\cvcomputer{???????? ??}{?????? ?????? ????}{???????? ??}{?????? ?????? ????}
+\cvcomputer{???????? ??}{?????? ?????? ????}{???????? ??}{?????? ?????? ????}
+
+\section{?????????????????}
+\cvline{?????????? ??}{\small ??????????}
+\cvline{?????????? ??}{\small ??????????}
+\cvline{?????????? ??}{\small ??????????}
+
+\renewcommand{\listitemsymbol}{-} % change the symbol for lists
+
+\section{???????? ??}
+\cvlistitem{?????????? ??}
+\cvlistitem{?????????? ??}
+\cvlistitem[+]{?????????? ??}            % optional other symbol
+
+\section{???????? ??}
+\cvlistdoubleitem[\Neutral]{?????????? ??}{?????????? ??}
+\cvlistdoubleitem[\Neutral]{?????????? ??}{?????????? ??}
+\cvlistdoubleitem[\Neutral]{?????????? ??}{}
+
+\nocite{*}
+\bibliographystyle{plain}
+\bibliography{publications}       % 'publications' is the name of a BibTeX file
+
+\end{document}

Added: tags/texmf/doc/bidi/examples/bidisample2e.tex
===================================================================
--- tags/texmf/doc/bidi/examples/bidisample2e.tex	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/doc/bidi/examples/bidisample2e.tex	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,199 @@
+
+\documentclass{article}      % Specifies the document class
+\usepackage[RTLdocument]{bidi}
+                             % The preamble begins here.
+\title{An Example Document}  % Declares the document's title.
+\author{Leslie Lamport}      % Declares the author's name.
+\date{January 21, 1994}      % Deleting this command produces today's date.
+
+\newcommand{\ip}[2]{(#1, #2)}
+                             % Defines \ip{arg1}{arg2} to mean
+                             % (arg1, arg2).
+
+                             % This is an alternative definition of
+                             % \ip that is commented out.
+
+\begin{document}             % End of preamble and beginning of text.
+
+\maketitle                   % Produces the title.
+
+This is an example input file.  Comparing it with
+the output it generates can show you how to
+produce a simple document of your own.
+
+\section{Ordinary Text}      % Produces section heading.  Lower-level
+                             % sections are begun with similar
+                             % \subsection and \subsubsection commands.
+
+The ends  of words and sentences are marked
+  by   spaces. It  doesn't matter how many
+spaces    you type; one is as good as 100.  The
+end of   a line counts as a space.
+
+One   or more   blank lines denote the  end
+of  a paragraph.
+
+Since any number of consecutive spaces are treated
+like a single one, the formatting of the input
+file makes no difference to
+      \LaTeX,                % The \LaTeX command generates the LaTeX logo.
+but it makes a difference to you.  When you use
+\LaTeX, making your input file as easy to read
+as possible will be a great help as you write
+your document and when you change it.  This sample
+file shows how you can add comments to your own input
+file.
+
+Because printing is different from typewriting,
+there are a number of things that you have to do
+differently when preparing an input file than if
+you were just typing the document directly.
+Quotation marks like
+       ``this''
+have to be handled specially, as do quotes within
+quotes:
+       ``\,`this'            % \, separates the double and single quote.
+        is what I just
+        wrote, not  `that'\,''.
+
+Dashes come in three sizes: an
+       intra-word
+dash, a medium dash for number ranges like
+       1--2,
+and a punctuation
+       dash---like
+this.
+
+A sentence-ending space should be larger than the
+space between words within a sentence.  You
+sometimes have to type special commands in
+conjunction with punctuation characters to get
+this right, as in the following sentence.
+       Gnats, gnus, etc.\ all  % `\ ' makes an inter-word space.
+       begin with G\@.         % \@ marks end-of-sentence punctuation.
+You should check the spaces after periods when
+reading your output to make sure you haven't
+forgotten any special cases.  Generating an
+ellipsis
+       \ldots\               % `\ ' is needed after `\ldots' because TeX
+                             % ignores spaces after command names like \ldots
+                             % made from \ + letters.
+                             %
+                             % Note how a `%' character causes TeX to ignore
+                             % the end of the input line, so these blank lines
+                             % do not start a new paragraph.
+                             %
+with the right spacing around the periods requires
+a special command.
+
+\LaTeX\ interprets some common characters as
+commands, so you must type special commands to
+generate them.  These characters include the
+following:
+       \$ \& \% \# \{ and \}.
+
+In printing, text is usually emphasized with an
+       \emph{italic}
+type style.
+
+\begin{em}
+   A long segment of text can also be emphasized
+   in this way.  Text within such a segment can be
+   given \emph{additional} emphasis.
+\end{em}
+
+It is sometimes necessary to prevent \LaTeX\ from
+breaking a line where it might otherwise do so.
+This may be at a space, as between the ``Mr.''\ and
+``Jones'' in
+       ``Mr.~Jones'',        % ~ produces an unbreakable interword space.
+or within a word---especially when the word is a
+symbol like
+       \mbox{\emph{itemnum}}
+that makes little sense when hyphenated across
+lines.
+
+Footnotes\footnote{This is an example of a footnote.}
+pose no problem.
+
+\LaTeX\ is good at typesetting mathematical formulas
+like
+       \( x-3y + z = 7 \)
+or
+       \( a_{1} > x^{2n} + y^{2n} > x' \)
+or
+       \( \ip{A}{B} = \sum_{i} a_{i} b_{i} \).
+The spaces you type in a formula are
+ignored.  Remember that a letter like
+       $x$                   % $ ... $  and  \( ... \)  are equivalent
+is a formula when it denotes a mathematical
+symbol, and it should be typed as one.
+
+\section{Displayed Text}
+
+Text is displayed by indenting it from the left
+margin.  Quotations are commonly displayed.  There
+are short quotations
+\begin{quote}
+   This is a short quotation.  It consists of a
+   single paragraph of text.  See how it is formatted.
+\end{quote}
+and longer ones.
+\begin{quotation}
+   This is a longer quotation.  It consists of two
+   paragraphs of text, neither of which are
+   particularly interesting.
+
+   This is the second paragraph of the quotation.  It
+   is just as dull as the first paragraph.
+\end{quotation}
+Another frequently-displayed structure is a list.
+The following is an example of an \emph{itemized}
+list.
+\begin{itemize}
+   \item This is the first item of an itemized list.
+         Each item in the list is marked with a ``tick''.
+         You don't have to worry about what kind of tick
+         mark is used.
+
+   \item This is the second item of the list.  It
+         contains another list nested inside it.  The inner
+         list is an \emph{enumerated} list.
+         \begin{enumerate}
+            \item This is the first item of an enumerated
+                  list that is nested within the itemized list.
+
+            \item This is the second item of the inner list.
+                  \LaTeX\ allows you to nest lists deeper than
+                  you really should.
+         \end{enumerate}
+         This is the rest of the second item of the outer
+         list.  It is no more interesting than any other
+         part of the item.
+   \item This is the third item of the list.
+\end{itemize}
+You can even display poetry.
+\begin{verse}
+   There is an environment
+    for verse \\             % The \\ command separates lines
+   Whose features some poets % within a stanza.
+   will curse.
+
+                             % One or more blank lines separate stanzas.
+
+   For instead of making\\
+   Them do \emph{all} line breaking, \\
+   It allows them to put too many words on a line when they'd rather be
+   forced to be terse.
+\end{verse}
+
+Mathematical formulas may also be displayed.  A
+displayed formula
+is
+one-line long; multiline
+formulas require special formatting instructions.
+   \[  \ip{\Gamma}{\psi'} = x'' + y^{2} + z_{i}^{n}\]
+Don't start a paragraph with a displayed equation,
+nor make one a paragraph by itself.
+
+\end{document}               % End of document.

Added: tags/texmf/doc/bidi/examples/bidismall2e.tex
===================================================================
--- tags/texmf/doc/bidi/examples/bidismall2e.tex	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/doc/bidi/examples/bidismall2e.tex	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,33 @@
+
+
+
+\documentclass{article}        % Your input file must contain these two lines
+\usepackage[RTLdocument]{bidi}
+\begin{document}               % plus the \end{document} command at the end.
+
+\section{Simple Text}          % This command makes a section title.
+
+Words are separated by one or more spaces.  Paragraphs are separated by
+one or more blank lines.  The output is not affected by adding extra
+spaces or extra blank lines to the input file.
+
+Double quotes are typed like this: ``quoted text''.
+Single quotes are typed like this: `single-quoted text'.
+
+Long dashes are typed as three dash characters---like this.
+
+Emphasized text is typed like this: \emph{this is emphasized}.
+Bold       text is typed like this: \textbf{this is bold}.
+
+\subsection{A Warning or Two}  % This command makes a subsection title.
+
+If you get too much space after a mid-sentence period---abbreviations
+like etc.\ are the common culprits)---then type a backslash followed by
+a space after the period, as in this sentence.
+
+Remember, don't type the 10 special characters (such as dollar sign and
+backslash) except as directed!  The following seven are printed by
+typing a backslash in front of them:  \$  \&  \#  \%  \_  \{  and  \}.
+The manual tells how to make other symbols.
+
+\end{document}                 % The input file ends with this command.

Added: tags/texmf/doc/bidi/examples/gull.jpg
===================================================================
(Binary files differ)


Property changes on: tags/texmf/doc/bidi/examples/gull.jpg
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: tags/texmf/doc/bidi/examples/presentation-sample.tex
===================================================================
--- tags/texmf/doc/bidi/examples/presentation-sample.tex	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/doc/bidi/examples/presentation-sample.tex	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,53 @@
+\documentclass[12pt,twoside]{bidipresentation}
+\usepackage{eso-pic}
+\usepackage{graphicx}
+\usepackage{fontspec}
+\setmainfont[Script=Arabic,Mapping=farsidigits]{XB Niloofar}
+\newfontfamily\rmfamily[Mapping=tex-text]{XB Niloofar}
+\usepackage[RTLdocument]{bidi}
+\pagestyle{pres}
+\AddToShipoutPicture{
+\includegraphics{gradient.png}
+}
+
+\begin{document}
+\begin{titlepage}
+\distance{1}
+\centering \LARGE
+ \bfseries ?????????? ????????????
+
+\distance{1}
+\large
+?????? ??????????\\[1ex]?????? ??????????????
+\distance{2}
+\end{titlepage}
+
+\begin{plainslide}[?????? ?????????? ???? ???????? ??????.]
+?????? ?????????? ???????? ???????????? ???? ?????? ???? ???? ???? ?????? ?????????? ???? ???????? ?? ?????? ?????????? ????????????????? ???? ???? ???? ???????? ????????
+\footnote{?????? ???? ?????????????? ?????????? ??????.}\LTRfootnote{This is an English footnote.}
+\begin{equation}
+(a+b)^2=a^2+2ab+b^2
+\end{equation}
+\begin{itemize}
+  \item ????
+  \item ????
+\end{itemize}
+
+\begin{enumerate}
+  \item ????
+  \item ????
+\end{enumerate}
+
+\begin{description}
+  \item [????:] ?????????? ??????
+  \item [????:] ?????????? ??????
+\end{description}
+
+\end{plainslide}
+\begin{rawslide}
+?????????? ????????
+
+\end{rawslide}
+
+\end{document}
+

Added: tags/texmf/doc/bidi/examples/test-bidi.tex
===================================================================
--- tags/texmf/doc/bidi/examples/test-bidi.tex	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/doc/bidi/examples/test-bidi.tex	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,43 @@
+\documentclass{article}
+\usepackage{bidi}
+\title{Testing Basic Bidi Direction Change}
+\author{Vafa Khalighi}
+\begin{document}
+\maketitle
+In this document we test bidi direction change in \textsf{RTL} and \textsf{LTR}. These tests includes \texttt{flushleft}, \texttt{flushright} environments and \verb|\centerline{...}|, \verb|\leftline{...}|,\verb|\rightline{...}|,\verb|\raggedleft| and \verb|\raggedright| macros.
+\section{RTL Test}
+\setRTL
+\begin{flushleft}
+This is left in RTL
+\end{flushleft}
+\begin{flushright}
+This is right in RTL
+\end{flushright}
+\centerline{This is center in RTL}
+
+\leftline{This is left in RTL}
+
+\rightline{This is right in RTL}
+
+\raggedleft This is raggedleft in RTL
+
+\raggedright This is raggedright in RTL
+
+\setLTR
+\section{LTR Test}
+\begin{flushleft}
+This is left in LTR
+\end{flushleft}
+\begin{flushright}
+This is right in LTR
+\end{flushright}
+\centerline{This is center in LTR}
+
+\leftline{This is left in LTR}
+
+\rightline{This is right in LTR}
+
+\raggedleft This is raggedleft in LTR
+
+\raggedright This is raggedright in LTR
+\end{document}

Added: tags/texmf/doc/bidi/examples/test-supertabular.tex
===================================================================
--- tags/texmf/doc/bidi/examples/test-supertabular.tex	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/doc/bidi/examples/test-supertabular.tex	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,116 @@
+\documentclass{article}
+\usepackage{supertabular}
+\usepackage{bidi}
+\title{Testing \textsf{supertabular} package in RTL and LTR}
+\author{Vafa Khalighi}
+\begin{document}
+\maketitle
+\section{LTR}
+\tablecaption{The ISOGRK3 entity set}
+\tablehead
+   {\bfseries Entity&\bfseries  Unicode Name&\bfseries Unicode\\ \hline}
+\tabletail
+   {\hline \multicolumn{3}{r}{\emph{Continued on next page}}\\}
+\tablelasttail{\hline}
+\begin{supertabular}{lll}
+alpha              & GREEK SMALL LETTER ALPHA            & 03B1\\
+beta               & GREEK SMALL LETTER BETA             & 03B2\\
+chi                & GREEK SMALL LETTER CHI              & 03C7\\
+Delta              & GREEK CAPITAL LETTER DELTA          & 0394\\
+delta              & GREEK SMALL LETTER DELTA            & 03B4\\
+epsi               & GREEK SMALL LETTER EPSILON          & 03B5\\
+epsis              & GREEK LUNATE EPSILON SYMBOL         & 03F5\\
+\empty
+epsiv              & GREEK SMALL LETTER EPSILON          & 03B5\\
+eta                & GREEK SMALL LETTER ETA              & 03B7\\
+Gamma              & GREEK CAPITAL LETTER GAMMA          & 0393\\
+gamma              & GREEK SMALL LETTER GAMMA            & 03B3\\
+gammad             & GREEK SMALL LETTER DIGAMMA          & 03DD\\
+iota               & GREEK SMALL LETTER IOTA             & 03B9\\
+kappa              & GREEK SMALL LETTER KAPPA            & 03BA\\
+kappav             & GREEK KAPPA SYMBOL                  & 03F0\\
+Lambda             & GREEK CAPITAL LETTER LAMDA          & 039B\\
+lambda             & GREEK SMALL LETTER LAMDA            & 03BB\\
+mu                 & GREEK SMALL LETTER MU               & 03BC\\
+nu                 & GREEK SMALL LETTER NU               & 03BD\\
+Omega              & GREEK CAPITAL LETTER OMEGA          & 03A9\\
+omega              & GREEK SMALL LETTER OMEGA            & 03C9\\
+Phi                & GREEK CAPITAL LETTER PHI            & 03A6\\
+phis               & GREEK PHI SYMBOL                    & 03D5\\
+phiv               & GREEK SMALL LETTER PHI              & 03C6\\
+Pi                 & GREEK CAPITAL LETTER PI             & 03A0\\
+pi                 & GREEK SMALL LETTER PI               & 03C0\\
+piv                & GREEK PI SYMBOL                     & 03D6\\
+Psi                & GREEK CAPITAL LETTER PSI            & 03A8\\
+psi                & GREEK SMALL LETTER PSI              & 03C8\\
+rho                & GREEK SMALL LETTER RHO              & 03C1\\
+rhov               & GREEK RHO SYMBOL                    & 03F1\\
+Sigma              & GREEK CAPITAL LETTER SIGMA          & 03A3\\
+sigma              & GREEK SMALL LETTER SIGMA            & 03C3\\
+sigmav             & GREEK SMALL LETTER FINAL SIGMA      & 03C2\\
+tau                & GREEK SMALL LETTER TAU              & 03C4\\
+Theta              & GREEK CAPITAL LETTER THETA          & 0398\\
+thetas             & GREEK SMALL LETTER THETA            & 03B8\\
+thetav             & GREEK THETA SYMBOL                  & 03D1\\
+Upsi               & GREEK UPSILON WITH HOOK SYMBOL      & 03D2\\
+upsi               & GREEK SMALL LETTER UPSILON          & 03C5\\
+Xi                 & GREEK CAPITAL LETTER XI             & 039E\\
+xi                 & GREEK SMALL LETTER XI               & 03BE\\
+zeta               & GREEK SMALL LETTER ZETA             & 03B6\\
+\end{supertabular}
+\section{RTL}
+
+\setRTL
+\tablecaption{The ISOGRK3 entity set}
+\tablehead
+   {\bfseries Entity&\bfseries  Unicode Name&\bfseries Unicode\\ \hline}
+\tabletail
+   {\hline \multicolumn{3}{r}{\emph{Continued on next page}}\\}
+\tablelasttail{\hline}
+\begin{supertabular}{lll}
+alpha              & GREEK SMALL LETTER ALPHA            & 03B1\\
+beta               & GREEK SMALL LETTER BETA             & 03B2\\
+chi                & GREEK SMALL LETTER CHI              & 03C7\\
+Delta              & GREEK CAPITAL LETTER DELTA          & 0394\\
+delta              & GREEK SMALL LETTER DELTA            & 03B4\\
+epsi               & GREEK SMALL LETTER EPSILON          & 03B5\\
+epsis              & GREEK LUNATE EPSILON SYMBOL         & 03F5\\
+\empty
+epsiv              & GREEK SMALL LETTER EPSILON          & 03B5\\
+eta                & GREEK SMALL LETTER ETA              & 03B7\\
+Gamma              & GREEK CAPITAL LETTER GAMMA          & 0393\\
+gamma              & GREEK SMALL LETTER GAMMA            & 03B3\\
+gammad             & GREEK SMALL LETTER DIGAMMA          & 03DD\\
+iota               & GREEK SMALL LETTER IOTA             & 03B9\\
+kappa              & GREEK SMALL LETTER KAPPA            & 03BA\\
+kappav             & GREEK KAPPA SYMBOL                  & 03F0\\
+Lambda             & GREEK CAPITAL LETTER LAMDA          & 039B\\
+lambda             & GREEK SMALL LETTER LAMDA            & 03BB\\
+mu                 & GREEK SMALL LETTER MU               & 03BC\\
+nu                 & GREEK SMALL LETTER NU               & 03BD\\
+Omega              & GREEK CAPITAL LETTER OMEGA          & 03A9\\
+omega              & GREEK SMALL LETTER OMEGA            & 03C9\\
+Phi                & GREEK CAPITAL LETTER PHI            & 03A6\\
+phis               & GREEK PHI SYMBOL                    & 03D5\\
+phiv               & GREEK SMALL LETTER PHI              & 03C6\\
+Pi                 & GREEK CAPITAL LETTER PI             & 03A0\\
+pi                 & GREEK SMALL LETTER PI               & 03C0\\
+piv                & GREEK PI SYMBOL                     & 03D6\\
+Psi                & GREEK CAPITAL LETTER PSI            & 03A8\\
+psi                & GREEK SMALL LETTER PSI              & 03C8\\
+rho                & GREEK SMALL LETTER RHO              & 03C1\\
+rhov               & GREEK RHO SYMBOL                    & 03F1\\
+Sigma              & GREEK CAPITAL LETTER SIGMA          & 03A3\\
+sigma              & GREEK SMALL LETTER SIGMA            & 03C3\\
+sigmav             & GREEK SMALL LETTER FINAL SIGMA      & 03C2\\
+tau                & GREEK SMALL LETTER TAU              & 03C4\\
+Theta              & GREEK CAPITAL LETTER THETA          & 0398\\
+thetas             & GREEK SMALL LETTER THETA            & 03B8\\
+thetav             & GREEK THETA SYMBOL                  & 03D1\\
+Upsi               & GREEK UPSILON WITH HOOK SYMBOL      & 03D2\\
+upsi               & GREEK SMALL LETTER UPSILON          & 03C5\\
+Xi                 & GREEK CAPITAL LETTER XI             & 039E\\
+xi                 & GREEK SMALL LETTER XI               & 03BE\\
+zeta               & GREEK SMALL LETTER ZETA             & 03B6\\
+\end{supertabular}
+\end{document}

Added: tags/texmf/doc/bidi/examples/test-tabular.tex
===================================================================
--- tags/texmf/doc/bidi/examples/test-tabular.tex	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/doc/bidi/examples/test-tabular.tex	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,63 @@
+\documentclass{article}
+\usepackage{bidi}
+\title{Testing \LaTeX's Default Tabular in \textsf{RTL} and \textsf{LTR}}
+\author{Vafa Khalighi}
+\newcommand{\rb}[1]{\raisebox{1.5ex}[0mm]{#1}}
+\begin{document}
+\maketitle
+In this document we test \LaTeX's default tabular in \textsf{RTL} and \textsf{LTR}.
+\section{LTR}
+\begin{center}\small
+\begin{tabular}{|l||c|l|c|l|c|l|}
+\hline
+& \multicolumn{2}{c|}{6.15--7.15 pm} & \multicolumn{2}{c|}{7.20--8.20 pm}
+& \multicolumn{2}{c|}{8.30--9.30 pm} \\ \cline{2-7}
+&& Teacher && Teacher && Teacher \\ \cline{3-3}\cline{5-5}\cline{7-7}
+\rb{Day} & \rb{Subj.} & Room & \rb{Subj.} & Room & \rb{Subj.} & Room\\
+   \hline\hline
+&& Dr.~Smith && Ms.~Clark && Mr.~Mills\\
+\cline{3-3}\cline{5-5}\cline{7-7}
+\rb{Mon.} & \rb{UNIX} & Comp. Ctr & \rb{Fortran} & Hall A
+  & \rb{Math.} & Hall A \\ \hline
+&& Miss Baker && Ms.~Clark && Mr.~Mill\\
+\cline{3-3}\cline{5-5}\cline{7-7}
+\rb{Tues.} & \rb{\LaTeX} & Conf.~Room & \rb{Fortran} & Conf~Room
+  & \rb{Math.} & Hall A \\ \hline
+&& Dr.~Smith && Dr.~Jones && Dr.~Jones \\
+\cline{3-3}\cline{5-5}\cline{7-7}
+\rb{Wed.} & \rb{UNIX} & Comp. Ctr & \rb{C} & Hall A
+  & \rb{ComSci.} & Hall A \\ \hline
+&& Miss Baker && Ms. Clark & \multicolumn{2}{c|}{} \\
+\cline{3-3}\cline{5-5}
+\rb{Fri.} & \rb{\LaTeX} & Conf.~Room & \rb{C++} & Conf.~Room
+& \multicolumn{2}{c|}{\rb{canceled}}\\ \hline
+\end{tabular}\end{center}
+\section{RTL}
+
+\setRTL
+\begin{center}\small
+\begin{tabular}{|l||c|l|c|l|c|l|}
+\hline
+& \multicolumn{2}{c|}{6.15--7.15 pm} & \multicolumn{2}{c|}{7.20--8.20 pm}
+& \multicolumn{2}{c|}{8.30--9.30 pm} \\ \cline{2-7}
+&& Teacher && Teacher && Teacher \\ \cline{3-3}\cline{5-5}\cline{7-7}
+\rb{Day} & \rb{Subj.} & Room & \rb{Subj.} & Room & \rb{Subj.} & Room\\
+   \hline\hline
+&& Dr.~Smith && Ms.~Clark && Mr.~Mills\\
+\cline{3-3}\cline{5-5}\cline{7-7}
+\rb{Mon.} & \rb{UNIX} & Comp. Ctr & \rb{Fortran} & Hall A
+  & \rb{Math.} & Hall A \\ \hline
+&& Miss Baker && Ms.~Clark && Mr.~Mill\\
+\cline{3-3}\cline{5-5}\cline{7-7}
+\rb{Tues.} & \rb{\LaTeX} & Conf.~Room & \rb{Fortran} & Conf~Room
+  & \rb{Math.} & Hall A \\ \hline
+&& Dr.~Smith && Dr.~Jones && Dr.~Jones \\
+\cline{3-3}\cline{5-5}\cline{7-7}
+\rb{Wed.} & \rb{UNIX} & Comp. Ctr & \rb{C} & Hall A
+  & \rb{ComSci.} & Hall A \\ \hline
+&& Miss Baker && Ms. Clark & \multicolumn{2}{c|}{} \\
+\cline{3-3}\cline{5-5}
+\rb{Fri.} & \rb{\LaTeX} & Conf.~Room & \rb{C++} & Conf.~Room
+& \multicolumn{2}{c|}{\rb{canceled}}\\ \hline
+\end{tabular}\end{center}
+\end{document}

Added: tags/texmf/doc/bidi/examples/test-tabularx.tex
===================================================================
--- tags/texmf/doc/bidi/examples/test-tabularx.tex	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/doc/bidi/examples/test-tabularx.tex	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,40 @@
+\documentclass{article}
+\usepackage{tabularx}
+\usepackage{bidi}
+\title{Testing \textsf{tabularx} Package in RTL and LTR}
+\author{Vafa Khalighi}
+\begin{document}
+\maketitle
+\section{LTR}
+\begin{tabularx}{\linewidth}{|l|p{1.25cm}|p{1.5cm}|X|}\hline
+\multicolumn{1}{|c|}{\textbf{Animal}}
+  & \textbf{Hair Colour}
+  & \multicolumn{2}{c|}{\textbf{Favourite foods}} \\\hline\hline
+Elephant & Gray & Peanuts
+  & Unshelled, prepared in Sea Salt, and warmed over hot stone grill \\\cline{3-4}
+  &  & Cabbage and Greens
+  & Sun dried until lightly browned (2-3 days minimum);
+    seasoned with Hyperchem super feed \\\cline{4-4}
+  & & & Boiled to British standard \\\hline\hline
+Lion & Yellow & Elephants & Tartare \\\cline{4-4}
+& & & Must be served warm, with no trace of
+  buckshot. Gaiminess considered desireable. \\\hline
+\end{tabularx}
+\section{RTL}
+
+\setRTL
+\begin{tabularx}{\linewidth}{|l|p{1.25cm}|p{1.5cm}|X|}\hline
+\multicolumn{1}{|c|}{\textbf{Animal}}
+  & \textbf{Hair Colour}
+  & \multicolumn{2}{c|}{\textbf{Favourite foods}} \\\hline\hline
+Elephant & Gray & Peanuts
+  & Unshelled, prepared in Sea Salt, and warmed over hot stone grill \\\cline{3-4}
+  &  & Cabbage and Greens
+  & Sun dried until lightly browned (2-3 days minimum);
+    seasoned with Hyperchem super feed \\\cline{4-4}
+  & & & Boiled to British standard \\\hline\hline
+Lion & Yellow & Elephants & Tartare \\\cline{4-4}
+& & & Must be served warm, with no trace of
+  buckshot. Gaiminess considered desireable. \\\hline
+\end{tabularx}
+\end{document}

Added: tags/texmf/doc/bidi/examples/test-tabulary.tex
===================================================================
--- tags/texmf/doc/bidi/examples/test-tabulary.tex	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/doc/bidi/examples/test-tabulary.tex	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,30 @@
+\documentclass{article}
+\usepackage{tabulary}
+\setlength\tymin{10pt}
+\setlength\tymax{\maxdimen}
+\usepackage{bidi}
+\title{Testing \textsf{tabulary} package in RTL and LTR}
+\author{Vafa Khalighi}
+\begin{document}
+\maketitle
+\section{LTR}
+\begin{tabulary}{200pt}{|C|C|C|C|}
+ a & b b b b &
+ c c c c c c c c c c c c c c c c c c &
+ d d d d d d d d d d d d d d d d d d
+\empty
+ d d d d d d d d d d d d d d
+ d d d d d d d d d d d d d d d d d d d d d d d d d d d d d d d d
+ \end{tabulary}
+\section{RTL}
+
+\setRTL
+\begin{tabulary}{200pt}{|C|C|C|C|}
+ a & b b b b &
+ c c c c c c c c c c c c c c c c c c &
+ d d d d d d d d d d d d d d d d d d
+\empty
+ d d d d d d d d d d d d d d
+ d d d d d d d d d d d d d d d d d d d d d d d d d d d d d d d d
+ \end{tabulary}
+\end{document}

Added: tags/texmf/doc/bidi/examples/test1-wrapfig.tex
===================================================================
--- tags/texmf/doc/bidi/examples/test1-wrapfig.tex	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/doc/bidi/examples/test1-wrapfig.tex	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,40 @@
+\documentclass{article}
+\usepackage{wrapfig}
+\usepackage{bidi}
+\newcommand\sample{Some text for our page
+  that might get reused over and over again. }
+\begin{document}
+\section{LTR}
+The starting place for the wrapfigure
+environment was manually determined in
+the current ex-
+
+\begin{wrapfigure}[7]{r}[0.2\width]{0pt}
+  \centering
+  \fbox{This is ``wrapfigure''.}
+  \caption{An example of the
+    \texttt{wrapfigure} environment}
+\end{wrapfigure}
+sample by first setting the text without
+the figure to find the linebreaks.
+
+\sample \sample \sample\sample \sample \sample\sample
+
+\section{RTL}
+
+\setRTL
+The starting place for the wrapfigure
+environment was manually determined in
+the current ex-
+
+\begin{wrapfigure}[7]{l}[0.2\width]{0pt}
+  \centering
+  \fbox{This is ``wrapfigure''.}
+  \caption{An example of the
+    \texttt{wrapfigure} environment}
+\end{wrapfigure}
+sample by first setting the text without
+the figure to find the linebreaks.
+
+\sample \sample \sample\sample \sample \sample\sample
+\end{document}

Added: tags/texmf/doc/bidi/examples/test2-wrapfig.tex
===================================================================
--- tags/texmf/doc/bidi/examples/test2-wrapfig.tex	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/doc/bidi/examples/test2-wrapfig.tex	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,28 @@
+\documentclass{article}
+\usepackage{wrapfig}
+\usepackage{bidi}
+\newcommand\sample{Some text for our page
+  that might get reused over and over again. }
+\begin{document}
+\section{LTR}
+\begin{wraptable}[4]{l}{4cm}
+ \centering
+\fbox{This is ``wraptable''.}
+ \caption{The Caption}\label{T1}
+\end{wraptable}
+
+\sample \sample Reference to Table~\ref{T1}.
+\sample
+
+\section{RTL}
+\setRTL
+
+\begin{wraptable}[4]{r}{4cm}
+ \centering
+\fbox{This is ``wraptable''.}
+ \caption{The Caption}\label{T2}
+\end{wraptable}
+
+\sample \sample Reference to Table~\ref{T2}.
+\sample
+\end{document}

Added: tags/texmf/doc/bidi/examples/test3-wrapfig.tex
===================================================================
--- tags/texmf/doc/bidi/examples/test3-wrapfig.tex	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/doc/bidi/examples/test3-wrapfig.tex	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,77 @@
+\documentclass[a4paper,12pt]{article}
+
+\usepackage{graphicx}
+\usepackage{wrapfig}
+\usepackage{bidi}
+\begin{document}
+\section{LTR}
+\subsection*{Wrapfig test}
+
+
+Gulls are birds in the family Laridae. They are most closely
+ related to the terns (family Sternidae), auks and skimmers,
+and more distantly to the waders. Most gulls belong to the
+large genus Larus.
+
+\begin{wrapfigure}{r}{0.5\textwidth}
+  \begin{center}
+    \includegraphics[width=0.48\textwidth]{gull}
+  \end{center}
+  \caption{A gull}
+\end{wrapfigure}
+
+They are in general medium to large birds, typically grey or white,
+often with black markings on the head or wings. They have stout,
+longish bills and webbed feet.
+
+Most gulls, particularly Larus species, are ground nesting carnivores,
+which will take live food or scavenge opportunistically. The live food
+often includes crabs and small fish. Apart from the kittiwakes, gulls
+are typically coastal or inland species, rarely venturing far out to sea.
+The large species take up to four years to attain full adult plumage,
+but two years is typical for small gulls.
+
+Gulls---the larger species in particular---are resourceful and
+highly intelligent birds, demonstrating complex methods of communication
+and a highly developed social structure. Certain species (e.g. the
+Herring Gull) have exhibited tool use behaviour. Many species of gull have
+learned to co-exist successfully with man and have thrived in human habitats.
+Others rely on kleptoparasitism to get their food.
+
+\newpage
+\section{RTL}
+
+\setRTL
+\subsection*{Wrapfig test}
+
+
+Gulls are birds in the family Laridae. They are most closely
+ related to the terns (family Sternidae), auks and skimmers,
+and more distantly to the waders. Most gulls belong to the
+large genus Larus.
+
+\begin{wrapfigure}{l}{0.5\textwidth}
+  \begin{center}
+    \includegraphics[width=0.48\textwidth]{gull}
+  \end{center}
+  \caption{A gull}
+\end{wrapfigure}
+
+They are in general medium to large birds, typically grey or white,
+often with black markings on the head or wings. They have stout,
+longish bills and webbed feet.
+
+Most gulls, particularly Larus species, are ground nesting carnivores,
+which will take live food or scavenge opportunistically. The live food
+often includes crabs and small fish. Apart from the kittiwakes, gulls
+are typically coastal or inland species, rarely venturing far out to sea.
+The large species take up to four years to attain full adult plumage,
+but two years is typical for small gulls.
+
+Gulls---the larger species in particular---are resourceful and
+highly intelligent birds, demonstrating complex methods of communication
+and a highly developed social structure. Certain species (e.g. the
+Herring Gull) have exhibited tool use behaviour. Many species of gull have
+learned to co-exist successfully with man and have thrived in human habitats.
+Others rely on kleptoparasitism to get their food.
+\end{document}

Added: tags/texmf/doc/xepersian/Index/persian.xdy
===================================================================
--- tags/texmf/doc/xepersian/Index/persian.xdy	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/doc/xepersian/Index/persian.xdy	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,118 @@
+;; $Id: makeidx.xdy,v 1.1 1997/02/07 14:17:31 kehr Exp $
+;;
+;; This file implements the Output Style Specifiers for plain
+;; makeindex (see manpage of makeindex 2.x) in conjuction with
+;; TeX/LaTeX.
+;;
+;; The Input Style Specifiers of makeindex cannot de defined in a
+;; `xindy' style file. Use an appropriate version of the program
+;; `tex2xindy' which should be included with this distribution.
+;;
+;; Since `xindy' uses a different specification language than
+;; makeindex and some of the command-line options of makeindex are now
+;; only available as style-file commands, this file can only serve as
+;; a template that produces the default-markup of makeindex. However,
+;; it may be used as a starting point for further modification and
+;; specialization.
+;;
+;; The following values are taken from the source of the makeindex
+;; distribution (see file scanst.h and the manpage) for further
+;; details.
+;;
+
+;; Define all attributes appearing in your document. Your attributes
+;; are all encapsulators you use in your \index commands following the
+;; vertical bar sign `|'. For example `foo' is the attribute in the
+;; command \index{...|foo}. Here you specify the set of attributes
+;; that appear in your document, the order in which they appear in the
+;; index and which one superdes the other.
+;;
+;; Example: a) (define-attibutes (("default") ("bf") ("it")))
+;;          b) (define-attibutes (("bf" "default")))
+;;
+;; The initial command is (change it accordingly):
+
+(define-attributes ("default"))
+
+;; The description of the location-classes.
+;; Add more location classes as needed.
+
+(define-location-class "arabic-page-numbers" ("arabic-numbers"))
+(define-location-class "roman-page-numbers"  ("roman-numbers-lowercase"))
+(define-location-class "Roman-page-numbers"  ("roman-numbers-uppercase"))
+(define-location-class "alpha-page-numbers"  ("alpha"))
+(define-location-class "Alpha-page-numbers"  ("ALPHA"))
+
+;; The most frequently used cross reference class "see". Add more, if
+;; necessary.
+
+(define-crossref-class "see")
+(markup-crossref-list :open "\see{" :close "}{}" :class "see")
+
+;; In makeindex: page_precedence <string>  "rnaRA"
+;; List all location classes appearing in your document.
+
+(define-location-class-order ("roman-page-numbers"
+			      "arabic-page-numbers"
+			      "alpha-page-numbers"
+			      "Roman-page-numbers"
+			      "Alpha-page-numbers"
+			      "see"))
+
+
+;; preamble <string>        "\\begin{theindex}\n"
+;; postamble <string>       "\n\n\\end{theindex}\n"
+
+(markup-index :open  "\begin{theindex}~n"
+	      :close "~n~n\end{theindex}~n"
+	      :tree)
+
+;; These specifiers are not directly supported via a command-line
+;; switch as in makeindex. Add the appropriate markup-commands into
+;; the preamble.
+
+;; setpage_prefix <string>  "~n  \setcounter{page}{"
+;; setpage_suffix <string>  "}~n"
+
+;; group_skip <string>      "~n~n  \indexspace~n"
+
+(markup-letter-group-list :sep "~n~n  \indexspace~n")
+
+;; The indexentries (item_<..> specifiers)
+
+(markup-indexentry :open "~n  \item "           :depth 0)
+(markup-indexentry :open "~n    \subitem "      :depth 1)
+(markup-indexentry :open "~n      \subsubitem " :depth 2)
+
+;; Location-references
+
+;; delim_0 <string>         ", "
+;; delim_1 <string>         ", "
+;; delim_2 <string>         ", "
+
+(markup-locclass-list :open ", " :sep ", ")
+
+;; delim_n <string>         ", "
+
+(markup-locref-list   :sep ", ")
+
+;; delim_r <string>         "--"
+
+(markup-range :sep "--")
+
+;; Here follow all letter-groups. The short-cut notation is used here.
+
+(define-letter-groups
+    ("??" "??" "??" "??" "??" "??" "??" "??" "??" "??" "??" "??" "??" "??"
+     "??" "??" "??" "??" "??" "??" "??" "??" "??" "??" "??" "??" "??" "??" "??" "??" "??" "??" "??"))
+
+;;
+;; The sort-rules map all letters to their lowercase counterpart.
+;;
+
+
+;; End
+
+;; Local Variables:
+;; mode: lisp
+;; End:


Property changes on: tags/texmf/doc/xepersian/Index/persian.xdy
___________________________________________________________________
Name: svn:executable
   + *

Added: tags/texmf/doc/xepersian/README.txt
===================================================================
--- tags/texmf/doc/xepersian/README.txt	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/doc/xepersian/README.txt	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,23 @@
+_________________
+The XePersian package
+v1.0.1
+
+XePersian is a package written for XeLaTeX that allows users to typeset
+Persian easily. The current version is 1.0.1 and it will be developed to
+ meet the needs of Persian typesetting properly.
+
+The XePersian package is independent of any operating system, meaning it
+will work on all operating systems.
+
+There are some  excellent fonts made by IRMUG (Iranian Mac User Group) which you can download
+from http://wiki.irmug.org/index.php/X_Series_2#Download_fonts and
+http://wiki.irmug.org/index.php/XWZar
+
+This version fixes all known bugs and adds heaps of new things.
+
+______________
+Vafa Khalighi
+vafa at users.berlios.de
+
+Copyright 2008-2009
+Distributed under the LaTeX Project Public License

Added: tags/texmf/doc/xepersian/examples/bibtex/MyReferences.bib
===================================================================
--- tags/texmf/doc/xepersian/examples/bibtex/MyReferences.bib	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/doc/xepersian/examples/bibtex/MyReferences.bib	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,113 @@
+???@article{Baker02limits,
+ author = {Baker,, Simon and Kanade,, Takeo},
+ title = {Limits on Super-Resolution and How to Break Them},
+ journal = {IEEE Trans. Pattern Anal. Mach. Intell.},
+ volume = {24},
+ number = {9},
+ year = {2002},
+ issn = {0162-8828},
+ pages = {1167--1183},
+ publisher = {IEEE Computer Society},
+ address = {Washington, DC, USA}
+ }
+
+ at CONFERENCE{Amintoosi87using,
+  AUTHOR =       {\noopsort{???????????????????,??????????}{???????????????????,??????????} and others},
+  TITLE =        {?????????????? ???? ?????????? ???????????? ???? ???????? ????????},
+  BOOKTITLE =    {???????????? ?????????????? ???????????? ??????????},
+  YEAR =         {1387},
+  ORGANIZATION = {?????????????? ??????????},
+  ADDRESS =      {???????????? ??????????},
+  PAGES =   {172-178},
+  LANGUAGE =     {Persian}
+}
+
+ at MASTERSTHESIS{??????????????????????????,
+  AUTHOR =       {\noopsort{????????????????, ??????????????????}{??????????????, ??????????????????}},
+  TITLE =        {???? ?????????? ??????????},
+  SCHOOL =       {?????????????? ???????????? ?????????????? ?????????????????????},
+  YEAR =         {????????},
+  MONTH =        {??????????},
+  NOTE =   {(???? ?????? ??????????)},
+  LANGUAGE =     {Persian}
+}
+
+ at MASTERSTHESIS{Khalighi07MscThesis,
+  AUTHOR =       {Vafa Khalighi},
+  TITLE =        {Category Theory},
+  SCHOOL =       {Sydny Univ.},
+  YEAR =         {2007},
+  MONTH =        {April}
+}
+
+ at PHDTHESIS{??????????????82??????????,
+  AUTHOR =       {\noopsort{??????????????, ????????}{??????????????, ????????}},
+  TITLE =        {???????? ????????????},
+  SCHOOL =       {?????????????? ???????????? ?????????????? ????????????????},
+  YEAR =         {1382},
+  MONTH =        {??????},
+  LANGUAGE =     {Persian}
+}
+
+ at MISC{???????????????????????????????,
+  AUTHOR =       {\noopsort{??????????,??????}{??????????,??????}  and ??????????????, ???????? and  ??????????,??????????.},
+  TITLE =        {????????????????? (\lr{\XePersian}): ???????? ?????????? ???????? ??????????????????? ???? \lr{\LaTeX2e}},
+  HOWPUBLISHED =    {\lr{http://developer.berlios.de/projects/xepersian}},
+  YEAR =         {????????},
+  LANGUAGE =     {Persian}
+  }
+
+ at BOOK{????????????????????????????,
+  AUTHOR =       {\noopsort{????????????????, ????????????}{????????????????, ????????????}},
+  EDITOR =       {??????????????, ??????????},
+  translator =   { ????????????? ??????????????, ???????? and ??????????,???????? },
+  TITLE =        {???????? ?????????? ?? ???????????????? ?????????? ??????????????????? ????????},
+  PUBLISHER =    {?????? ?????? ??????????},
+  YEAR =         {????????},
+  ADDRESS =      {????????????},
+  edition =      {??????},
+  MONTH =        {????????},
+  LANGUAGE =     {Persian}
+}
+
+ at ARTICLE{??????????87,
+  AUTHOR =  {\noopsort{??????????, ??????????}{??????????, ??????????}},
+  TITLE =  {???????????? ???????? ???? ?????????? ????????????????},
+  JOURNAL =  {???????? ?????????? ??????????},
+  VOLUME =  {1},
+  YEAR =  {1387},
+  NUMBER =  {2},
+  MONTH =  {????????},
+  PAGES =  {22-30},
+  LANGUAGE =   {Persian}
+}
+
+ at CONFERENCE{Amintoosi09regional,
+  author =       {Mahmood Amintoosi and Mahmood Fathy and Nasser Mozayani},
+  title =        {Regional Varying Image Super-Resolution},
+  booktitle =    {(CSO 2009) The 2009 IEEE International Joint Conference on Computational Sciences and Optimization},
+  year =         {2009},
+  month =        {24-26 April},
+  organization = {City University},
+  address =      {Sanya, Hainan, China},
+  pages =        {101-105}
+}
+
+ at PHDTHESIS{Farsiu05thesis,
+  AUTHOR =       {Sina Farsiu},
+  TITLE =        {A Fast and Robust Framework for Image Fusion and Enhancement},
+  SCHOOL =       {Electrical Engineeting},
+  YEAR =         {2005},
+  ADDRESS =      {UC Santa Cruz},
+  MONTH =        {December}
+}
+
+ at BOOK{Gonzalez02book,
+  AUTHOR =      {Gonzalez,, Rafael C. and Woods,, Richard E.},
+  TITLE =       {Digital Image Processing},
+  PUBLISHER =   {Prentice-Hall, Inc.},
+  YEAR =        {2006},
+  ISBN =  {013168728X},
+  EDITION =  {3rd},
+  ADDRESS = {Upper Saddle River, NJ, USA},
+}

Added: tags/texmf/doc/xepersian/examples/bibtex/acm-fa-output.tex
===================================================================
--- tags/texmf/doc/xepersian/examples/bibtex/acm-fa-output.tex	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/doc/xepersian/examples/bibtex/acm-fa-output.tex	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,17 @@
+\documentclass[11pt,a4paper]{article}
+
+\usepackage{verbatim}
+\usepackage{xepersian}
+\settextfont[Scale=1]{XB Zar}%{XB Zar}
+\setlatintextfont[Scale=.95]{Linux Libertine}%{Arial}%
+\setdigitfont{Parsi Digits}
+
+\title{?????????? ?????????? ???? ?????? ?????????? \lr{acm-fa} ???? ?????????????????}
+\author{}\date{}
+\begin{document}
+\maketitle
+\nocite{*}
+\bibliographystyle{acm-fa}%{ieeetr-fa}%{persia}%
+\bibliography{MyReferences}
+
+\end{document}

Added: tags/texmf/doc/xepersian/examples/bibtex/bibtex-example.tex
===================================================================
--- tags/texmf/doc/xepersian/examples/bibtex/bibtex-example.tex	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/doc/xepersian/examples/bibtex/bibtex-example.tex	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,27 @@
+\documentclass[11pt,a4paper]{article}
+
+
+\usepackage{verbatim}
+\usepackage{backref}
+\def\backrefpagesname{}
+\usepackage{xepersian}
+\settextfont[Scale=1]{XB Zar}
+\setlatintextfont[Scale=.95]{Linux Libertine}%{Times New latin}
+\setdigitfont{Parsi Digits}
+
+\title{?????????? ?????????? ???? ?????????? ?????????? \lr{unsrt-fa} ???????? \lr{BibTeX} ???? ?????????????????}
+\author{}\date{}
+\begin{document}
+\maketitle
+
+???????? \cite{??????????????82??????????} ???? ?????????? ?????????? ?????????? ?? ????????\cite{??????????87} ???? ?????????? ?????????? ???????? ?????????? ??????.
+???????? \cite{Baker02limits} ???? ?????????? ?????????? ?????????????? ?????? ???? ???? ?????? ?????????? ?????????? ???????? ?????????? ???????? ???????? \cite{Amintoosi87using}  ???? ??????????  ?????????? ?????????????? ?????????? ??
+???????? \cite{????????????????????????????} ???? ?????????? ???????? ?????????? ???? ?????? ?????????????? ?? ???????????????????? ?????????? ??????. ???????? \cite{Khalighi07MscThesis} ???? ?????????? ?????????? ???????????????? ???????? ?????????????? ??
+\cite{???????????????????????????????} ???? ???? ?????????? ????????????  ?????????????????.
+
+{\small
+\bibliographystyle{unsrt-fa}%{plain-fa}%{ieeetr-fa}%{persia}%
+\bibliography{MyReferences}
+}
+
+\end{document}

Added: tags/texmf/doc/xepersian/examples/bibtex/ieeetr-fa-output.tex
===================================================================
--- tags/texmf/doc/xepersian/examples/bibtex/ieeetr-fa-output.tex	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/doc/xepersian/examples/bibtex/ieeetr-fa-output.tex	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,19 @@
+\documentclass[11pt,a4paper]{article}
+
+\usepackage{verbatim}
+\usepackage{xepersian}
+\settextfont[Scale=1]{XB Zar}%{XB Zar}
+\setlatintextfont[Scale=.95]{Linux Libertine}%{Arial}%
+\setdigitfont{Parsi Digits}
+
+\title{?????????? ?????????? ???? ?????? ?????????? \lr{ieeetr-fa} ???? ?????????????????}
+\author{}\date{}
+\begin{document}
+\maketitle
+
+\nocite{*}
+
+\bibliographystyle{ieeetr-fa}%{persia}%
+\bibliography{MyReferences}
+
+\end{document}

Added: tags/texmf/doc/xepersian/examples/bibtex/plain-fa-output.tex
===================================================================
--- tags/texmf/doc/xepersian/examples/bibtex/plain-fa-output.tex	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/doc/xepersian/examples/bibtex/plain-fa-output.tex	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,19 @@
+\documentclass[11pt,a4paper]{article}
+
+\usepackage{verbatim}
+\usepackage{xepersian}
+\settextfont[Scale=1]{XB Zar}%{XB Zar}
+\setlatintextfont[Scale=.95]{Linux Libertine}%{Arial}%
+\setdigitfont{XB Zar}
+
+\title{?????????? ?????????? ???? ?????? ?????????? \lr{plain-fa} ???? ?????????????????}
+\author{}\date{}
+\begin{document}
+\maketitle
+
+\nocite{*}
+
+\bibliographystyle{plain-fa}%{ieeetr-fa}%{persia}%
+\bibliography{MyReferences1}
+
+\end{document}

Added: tags/texmf/doc/xepersian/examples/logo.pdf
===================================================================
(Binary files differ)


Property changes on: tags/texmf/doc/xepersian/examples/logo.pdf
___________________________________________________________________
Name: svn:executable
   + *
Name: svn:mime-type
   + application/octet-stream

Added: tags/texmf/doc/xepersian/examples/magazine-sample.tex
===================================================================
--- tags/texmf/doc/xepersian/examples/magazine-sample.tex	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/doc/xepersian/examples/magazine-sample.tex	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,171 @@
+\documentclass[12pt,twoside]{xepersian-magazine}
+\usepackage{graphicx}
+\usepackage{xepersian}
+\usepackage{xunicode}
+\settextfont[Scale=1]{XB Zar}
+\setlatintextfont[Scale=1]{Junicode}
+\setdigitfont{XB Zar}
+\pagestyle{fancy}
+\title{?????????? ?????????????????}
+\author{?????? ??????????}
+\edition{?????? ??????}
+\customlogo{?????????? ?????????????????}
+\customminilogo{?????????? ?????????????????}
+\custommagazinename{?????????? ?????????????????}
+\customwwwTxt{http://developer.berlios.de/projects/xepersian}
+\begin{document}
+\begin{frontpage}
+\firstimage{img/ireland.jpg}{?????? ?????????????? ?????????? ???????? ???? ?????????? ?????? ??????.}
+\firstarticle{?????? ???????? ???????????? ?????? ??????.}
+{?????? ?????? ???????? ?????????? ???? ???????????? ?????? ?????? ???? ???? ???? ?????? ?????????? ???? ????????. ???????? ???? ?????????? ?????????????? ???? ???????????? ?????? ???????? ???? ?????? ???? ?????????????? ?????? ?????????? ?????????? ??????????. ?????? ???????? ???? ?????????? ?????????????? ?????? ??????????????????? ???????? ???? ???? ?????? ???????? ???? ???? ?????? ???????? ???????? ???????????????.}%
+{????:????}
+\secondarticle{?????? ???? ???? ???????? ???????????? ?????? ??????.}%
+{?????? ???? ?????? ???????? ???????????? ?????? ?????? ???? ???? ???? ???? ?????????? ???????????????????.}%
+{?????? ?????? ???????? ?????????? ???? ???????????? ?????? ?????? ???? ???? ???? ?????? ?????????? ???? ????????. ???????? ???? ?????????? ?????????????? ???? ???????????? ?????? ???????? ???? ?????? ???? ?????????????? ?????? ?????????? ?????????? ??????????. ?????? ???????? ???? ?????????? ?????????????? ?????? ??????????????????? ???????? ???? ???? ?????? ???????? ???? ???? ?????? ???????? ???????? ???????????????.}%
+{???????? ??????}%
+{????:????}
+
+\thirdarticle{?????? ???????????? ???????????? ?????? ??????.}%
+{?????? ???? ?????????????? ???????????? ?????? ?????? ???? ???? ???? ???? ???? ?????????? ???????? ???????????????.}%
+{?????? ?????? ???????? ?????????? ???? ???????????? ?????? ?????? ???? ???? ???? ?????? ?????????? ???? ????????. ???????? ???? ?????????? ?????????????? ???? ???????????? ?????? ???????? ???? ?????? ???? ?????????????? ?????? ?????????? ?????????? ??????????. ?????? ???????? ???? ?????????? ?????????????? ?????? ??????????????????? ???????? ???? ???? ?????? ???????? ???? ???? ?????? ???????? ???????? ???????????????. ?? ?????????????? ???? ????????????????? ???? ?????????? ???????? ???????? ?????????? ?????? ?????? ???????? ????????????????? ???? ?????? ???????? ???? ???? ???????? ????????. ?????? ???? ?????????????? ???????? ???????????? ???? ?????????? ?????????? ?????????? ????????.}%
+
+{???????? ??}%
+{????:????}
+
+\begin{indexblock}{?????????? (?????????? ??????????) ????????}
+\indexitem{??- ?????????? ??????}{1}
+
+\indexitem{??- ?????????? ??????}{3}
+
+\indexitem{??- ?????????? ??????}{3}
+
+\indexitem{??- ?????????? ??????????}{5}
+\end{indexblock}
+
+\begin{weatherblock}{?????? ???? ?? ??????}
+\weatheritem{img/weather/rain.jpg}{??????????}{13}{9}{}
+\weatheritem{img/weather/sun.jpg}{????????}{15}{1}{}
+\weatheritem{img/weather/clouds.jpg}{????????}{12}{6}{}
+\end{weatherblock}
+
+\begin{authorblock}
+\textbf{????????????????????}
+
+?????? ???????????? ???????? ?????????????? ?? ?????????? ??????????
+
+\texttt{vafa at users.berlios.de\\[5pt]
+http://developer.berlios.de/projects/xepersian}\\
+\end{authorblock}
+\end{frontpage}
+\newsection{???????? ??????}
+\begin{article}{2}
+{?????? ???????? ?????? ?????????? ??????.}
+{?????? ???? ?????????????? ?????? ?????????? ??????.}
+{???????? ??????}
+{1}
+\authorandplace{?????? ??????????????}{????????}
+
+\noindent\timestamp{??:????}
+?????????? ???????? ???? ?????? ???????????? ???? ???????????? ???????? ?? ???? ?????????? ?????????????? ??????????? ???? ?????????? ???????????? ???????? ??????????????? ???????? ???????? ???????? ?????????? ?????????? ???????????? ????????????  ?????? ?????????????????????? ?????????? ???????? ???????? ???? ?????????? ?????????????? ?????????????? ???? ?????? ?????? ??????.  ????????? ?????? ?????? ???????????? ???? ???? ???????? ???? ?????????? ?????? ???? ????????  ???????????? ???????????? ?????? ????????????? ??????.  ???? ???????? ???? ?????? ?????? ??????????????? ???????? ???? ???????????? ???????? ?? ?????????? ??????????????? ???????????? ?????????? ???? ?????????? ???????? ???????????? ???? ???? ???????? ???? ????????????? ???????????? ???????? ?????? ?????????? ????????. ???????????????? ???? ?????? ?????? ???????????? ??????????????? ???????????? ???? ?????? ????????????? ???? ?????????? ???????? ????????????????? ????????????? ???????? ?????? ???????????????!
 ???? ???? ???? ???????? ???????? . ???? ?????? ?????? ??????????????? ??????????????? ???????????? ???? ?????? ????????????? ?? ????????????????????? ?????????? ???????? ?????????? ??????????  ???????? ???????? ???? ?????????? ???????????? ???????????? ?????????? ???????? ?? ?????????????? ???????? ?????????????? ????????????????? ?? ??????????????? ???????????? ???? ?????????? ?????????????? ?????????????? ???? ???? ???????? ??????????.
+\footnote{?????? ???? ?????????????? ?????????? ??????.}\LTRfootnote{This is an English footnote.}
+\begin{equation}
+(a+b)^3=a^3+3a^2b+3ab^2+b^3\label{eq-1}
+\end{equation}
+?????? ?????????????? \eqref{eq-1} ??????.
+\columntitle{lines}{?????? ???? ???????? ?????? ???? ???????? ???????? ???????? ?????? ???? ?????? ???????? ?????????? ???????????????.}
+
+?????????? ???????? ???? ?????? ???????????? ???? ???????????? ???????? ?? ???? ?????????? ?????????????? ??????????? ???? ?????????? ???????????? ???????? ??????????????? ???????? ???????? ???????? ?????????? ?????????? ???????????? ????????????  ?????? ?????????????????????? ?????????? ???????? ???????? ???? ?????????? ?????????????? ?????????????? ???? ?????? ?????? ??????.  ????????? ?????? ?????? ???????????? ???? ???? ???????? ???? ?????????? ?????? ???? ????????  ???????????? ???????????? ?????? ????????????? ??????.  ???? ???????? ???? ?????? ?????? ??????????????? ???????? ???? ???????????? ???????? ?? ?????????? ??????????????? ???????????? ?????????? ???? ?????????? ???????? ???????????? ???? ???? ???????? ???? ????????????? ???????????? ???????? ?????? ?????????? ????????. ???????????????? ???? ?????? ?????? ???????????? ??????????????? ???????????? ???? ?????? ????????????? ???? ?????????? ???????? ????????????????? ????????????? ???????? ?????? ???????????????!
 ???? ???? ???? ???????? ???????? . ???? ?????? ?????? ??????????????? ??????????????? ???????????? ???? ?????? ????????????? ?? ????????????????????? ?????????? ???????? ?????????? ??????????  ???????? ???????? ???? ?????????? ???????????? ???????????? ?????????? ???????? ?? ?????????????? ???????? ?????????????? ????????????????? ?? ??????????????? ???????????? ???? ?????????? ?????????????? ?????????????? ???? ???? ???????? ??????????.
+
+?????? ???????????? ??????????????????????? ??????????????????? ?????????? ?????? ???????? ???? ???? ???? ???? ???????? ??????????????????????????? ???????????????? ?? ???? ???????? ??????????????????????????????? ??????????????? ?????????????.  ???? ??????????? ???? ????????????????? ??????????????????????? ???? ???????? ??????????????????????? ?????????????? ?????????????? ??????????????? ???????????? ???? ????????????????????? ???????????? ?????????????? ???????? ?????? ??????????????? ?????????? ????????????????? ???? ?????????? ?????? ????????????????? ???????? ???????? ????????????????????? ????????????????? ??????????/??????????????????? ??????.  ??????????????? ???? ???????? ?????? ?????????? ?????????????? ?????? ?????????? ?????????? ??????????????? ?????????? ??????????????? ?????????? ???? ???????? ??????????????? ???? ???????? ???????????? ???????? ?????? ???????? ??????????????? ???????? ???????????? ?????????? ???????????? ?????? ?????????????. ?????????? ???!
 ? ?????? ???????????? ???????????? ?????? ??????????????? ???? ???????? ?????????????? ?????? ???????? ?????????????? ?????? ?????? ?? ?????? ?????? ???? ?????????? ??????????????????? ??????????????????? ???????????? ?????? ???? ???? ?????? ?????? ??????????????? ?????????? ??????.
+
+???????????? ???????? ??????? ?????? ???? ?????? ???????????????. ???????? ???????? ?????????? ?????? ????  ??????????????????? ?????????? ???? ????????????????? ??????????????????????? ??????????????? ?????? ???? ?????? ???????? ??????????? ???? ???? ??????????????????????? ?????? ??????????????? ?????????????.  ?????? ???????? ???? ???????????? ?????????? ?????????? ???? ?????????? ?????????? ???????????? ???? ???????? ?? ?????????? ?????????? ????  ???????? ???????? ?????????????.  ???? ???? ???????? ?????????? ?? ????????????????? ???????? ?????????????? ???? ??????????????????? ???????? ?????? ??????????????? ?????? ?? ???? ?????? ???????? ???? ?????? ????????????????? ???????? ?????? ??????????????? ????????????  ?????????? ????  ????????????????? ?????????? ?????????? ??????????. ???? ???????? ???????? ?????? ???? ???????????? ???????? ???????????? ?????? ????????????????? ???????????? ????  ?????????????? ??????????????? ?? ?????????? ?????????? ???????? ???? ??????!
 ????  ?????????? ???? ?????????? ???? ????????????????? ??????.
+\end{article}
+
+\articlesep
+
+\begin{article}{2}
+{?????? ???????? ?????? ?????????? ??????.}
+{?????? ???? ?????????????? ?????? ?????????? ??????.}
+{???????? ??????}
+{1}
+\authorandplace{?????? ??????????????}{????????}
+
+\noindent\timestamp{08:25}
+?????????? ???????? ???? ?????? ???????????? ???? ???????????? ???????? ?? ???? ?????????? ?????????????? ??????????? ???? ?????????? ???????????? ???????? ??????????????? ???????? ???????? ???????? ?????????? ?????????? ???????????? ????????????  ?????? ?????????????????????? ?????????? ???????? ???????? ???? ?????????? ?????????????? ?????????????? ???? ?????? ?????? ??????.  ????????? ?????? ?????? ???????????? ???? ???? ???????? ???? ?????????? ?????? ???? ????????  ???????????? ???????????? ?????? ????????????? ??????.  ???? ???????? ???? ?????? ?????? ??????????????? ???????? ???? ???????????? ???????? ?? ?????????? ??????????????? ???????????? ?????????? ???? ?????????? ???????? ???????????? ???? ???? ???????? ???? ????????????? ???????????? ???????? ?????? ?????????? ????????. ???????????????? ???? ?????? ?????? ???????????? ??????????????? ???????????? ???? ?????? ????????????? ???? ?????????? ???????? ????????????????? ????????????? ???????? ?????? ???????????????!
 ???? ???? ???? ???????? ???????? . ???? ?????? ?????? ??????????????? ??????????????? ???????????? ???? ?????? ????????????? ?? ????????????????????? ?????????? ???????? ?????????? ??????????  ???????? ???????? ???? ?????????? ???????????? ???????????? ?????????? ???????? ?? ?????????????? ???????? ?????????????? ????????????????? ?? ??????????????? ???????????? ???? ?????????? ?????????????? ?????????????? ???? ???? ???????? ??????????.
+\LTRfootnote{This is an English footnote.}\footnote{?????? ???? ?????????????? ?????????? ??????.}
+?????? ???????????? ??????????????????????? ??????????????????? ?????????? ?????? ???????? ???? ???? ???? ???? ???????? ??????????????????????????? ???????????????? ?? ???? ???????? ??????????????????????????????? ??????????????? ?????????????.  ???? ??????????? ???? ????????????????? ??????????????????????? ???? ???????? ??????????????????????? ?????????????? ?????????????? ??????????????? ???????????? ???? ????????????????????? ???????????? ?????????????? ???????? ?????? ??????????????? ?????????? ????????????????? ???? ?????????? ?????? ????????????????? ???????? ???????? ????????????????????? ????????????????? ??????????/??????????????????? ??????.  ??????????????? ???? ???????? ?????? ?????????? ?????????????? ?????? ?????????? ?????????? ??????????????? ?????????? ??????????????? ?????????? ???? ???????? ??????????????? ???? ???????? ???????????? ???????? ?????? ???????? ??????????????? ???????? ???????????? ?????????? ???????????? ?????? ?????????????. ?????????? ???!
 ? ?????? ???????????? ???????????? ?????? ??????????????? ???? ???????? ?????????????? ?????? ???????? ?????????????? ?????? ?????? ?? ?????? ?????? ???? ?????????? ??????????????????? ??????????????????? ???????????? ?????? ???? ???? ?????? ?????? ??????????????? ?????????? ??????.
+
+???????????? ???????? ??????? ?????? ???? ?????? ???????????????. ???????? ???????? ?????????? ?????? ????  ??????????????????? ?????????? ???? ????????????????? ??????????????????????? ??????????????? ?????? ???? ?????? ???????? ??????????? ???? ???? ??????????????????????? ?????? ??????????????? ?????????????.  ?????? ???????? ???? ???????????? ?????????? ?????????? ???? ?????????? ?????????? ???????????? ???? ???????? ?? ?????????? ?????????? ????  ???????? ???????? ?????????????.  ???? ???? ???????? ?????????? ?? ????????????????? ???????? ?????????????? ???? ??????????????????? ???????? ?????? ??????????????? ?????? ?? ???? ?????? ???????? ???? ?????? ????????????????? ???????? ?????? ??????????????? ????????????  ?????????? ????  ????????????????? ?????????? ?????????? ??????????. ???? ???????? ???????? ?????? ???? ???????????? ???????? ???????????? ?????? ????????????????? ???????????? ????  ?????????????? ??????????????? ?? ?????????? ?????????? ???????? ???? ??????!
 ????  ?????????? ???? ?????????? ???? ????????????????? ??????.
+
+?????????? ???????? ???? ?????? ???????????? ???? ???????????? ???????? ?? ???? ?????????? ?????????????? ??????????? ???? ?????????? ???????????? ???????? ??????????????? ???????? ???????? ???????? ?????????? ?????????? ???????????? ????????????  ?????? ?????????????????????? ?????????? ???????? ???????? ???? ?????????? ?????????????? ?????????????? ???? ?????? ?????? ??????.  ????????? ?????? ?????? ???????????? ???? ???? ???????? ???? ?????????? ?????? ???? ????????  ???????????? ???????????? ?????? ????????????? ??????.  ???? ???????? ???? ?????? ?????? ??????????????? ???????? ???? ???????????? ???????? ?? ?????????? ??????????????? ???????????? ?????????? ???? ?????????? ???????? ???????????? ???? ???? ???????? ???? ????????????? ???????????? ???????? ?????? ?????????? ????????. ???????????????? ???? ?????? ?????? ???????????? ??????????????? ???????????? ???? ?????? ????????????? ???? ?????????? ???????? ????????????????? ????????????? ???????? ?????? ???????????????!
 ???? ???? ???? ???????? ???????? . ???? ?????? ?????? ??????????????? ??????????????? ???????????? ???? ?????? ????????????? ?? ????????????????????? ?????????? ???????? ?????????? ??????????  ???????? ???????? ???? ?????????? ???????????? ???????????? ?????????? ???????? ?? ?????????????? ???????? ?????????????? ????????????????? ?? ??????????????? ???????????? ???? ?????????? ?????????????? ?????????????? ???? ???? ???????? ??????????.
+
+?????? ???????????? ??????????????????????? ??????????????????? ?????????? ?????? ???????? ???? ???? ???? ???? ???????? ??????????????????????????? ???????????????? ?? ???? ???????? ??????????????????????????????? ??????????????? ?????????????.  ???? ??????????? ???? ????????????????? ??????????????????????? ???? ???????? ??????????????????????? ?????????????? ?????????????? ??????????????? ???????????? ???? ????????????????????? ???????????? ?????????????? ???????? ?????? ??????????????? ?????????? ????????????????? ???? ?????????? ?????? ????????????????? ???????? ???????? ????????????????????? ????????????????? ??????????/??????????????????? ??????.  ??????????????? ???? ???????? ?????? ?????????? ?????????????? ?????? ?????????? ?????????? ??????????????? ?????????? ??????????????? ?????????? ???? ???????? ??????????????? ???? ???????? ???????????? ???????? ?????? ???????? ??????????????? ???????? ???????????? ?????????? ???????????? ?????? ?????????????. ?????????? ???!
 ? ?????? ???????????? ???????????? ?????? ??????????????? ???? ???????? ?????????????? ?????? ???????? ?????????????? ?????? ?????? ?? ?????? ?????? ???? ?????????? ??????????????????? ??????????????????? ???????????? ?????? ???? ???? ?????? ?????? ??????????????? ?????????? ??????.
+
+???????????? ???????? ??????? ?????? ???? ?????? ???????????????. ???????? ???????? ?????????? ?????? ????  ??????????????????? ?????????? ???? ????????????????? ??????????????????????? ??????????????? ?????? ???? ?????? ???????? ??????????? ???? ???? ??????????????????????? ?????? ??????????????? ?????????????.  ?????? ???????? ???? ???????????? ?????????? ?????????? ???? ?????????? ?????????? ???????????? ???? ???????? ?? ?????????? ?????????? ????  ???????? ???????? ?????????????.  ???? ???? ???????? ?????????? ?? ????????????????? ???????? ?????????????? ???? ??????????????????? ???????? ?????? ??????????????? ?????? ?? ???? ?????? ???????? ???? ?????? ????????????????? ???????? ?????? ??????????????? ????????????  ?????????? ????  ????????????????? ?????????? ?????????? ??????????. ???? ???????? ???????? ?????? ???? ???????????? ???????? ???????????? ?????? ????????????????? ???????????? ????  ?????????????? ??????????????? ?? ?????????? ?????????? ???????? ???? ??????!
 ????  ?????????? ???? ?????????? ???? ????????????????? ??????.
+
+\expandedtitle{doublebox}{?????? ???? ???????? ?????? ?????? ???? ???????? ???? ???? ???????????? ?????? ?????????? ???? ?????????? ??????????????? ?? ?????? ???????? ???? ?? ?????????????????? ???????? ?????? ??????.}
+
+?????????? ???????? ???? ?????? ???????????? ???? ???????????? ???????? ?? ???? ?????????? ?????????????? ??????????? ???? ?????????? ???????????? ???????? ??????????????? ???????? ???????? ???????? ?????????? ?????????? ???????????? ????????????  ?????? ?????????????????????? ?????????? ???????? ???????? ???? ?????????? ?????????????? ?????????????? ???? ?????? ?????? ??????.  ????????? ?????? ?????? ???????????? ???? ???? ???????? ???? ?????????? ?????? ???? ????????  ???????????? ???????????? ?????? ????????????? ??????.  ???? ???????? ???? ?????? ?????? ??????????????? ???????? ???? ???????????? ???????? ?? ?????????? ??????????????? ???????????? ?????????? ???? ?????????? ???????? ???????????? ???? ???? ???????? ???? ????????????? ???????????? ???????? ?????? ?????????? ????????. ???????????????? ???? ?????? ?????? ???????????? ??????????????? ???????????? ???? ?????? ????????????? ???? ?????????? ???????? ????????????????? ????????????? ???????? ?????? ???????????????!
 ???? ???? ???? ???????? ???????? . ???? ?????? ?????? ??????????????? ??????????????? ???????????? ???? ?????? ????????????? ?? ????????????????????? ?????????? ???????? ?????????? ??????????  ???????? ???????? ???? ?????????? ???????????? ???????????? ?????????? ???????? ?? ?????????????? ???????? ?????????????? ????????????????? ?? ??????????????? ???????????? ???? ?????????? ?????????????? ?????????????? ???? ???? ???????? ??????????.
+
+?????? ???????????? ??????????????????????? ??????????????????? ?????????? ?????? ???????? ???? ???? ???? ???? ???????? ??????????????????????????? ???????????????? ?? ???? ???????? ??????????????????????????????? ??????????????? ?????????????.  ???? ??????????? ???? ????????????????? ??????????????????????? ???? ???????? ??????????????????????? ?????????????? ?????????????? ??????????????? ???????????? ???? ????????????????????? ???????????? ?????????????? ???????? ?????? ??????????????? ?????????? ????????????????? ???? ?????????? ?????? ????????????????? ???????? ???????? ????????????????????? ????????????????? ??????????/??????????????????? ??????.  ??????????????? ???? ???????? ?????? ?????????? ?????????????? ?????? ?????????? ?????????? ??????????????? ?????????? ??????????????? ?????????? ???? ???????? ??????????????? ???? ???????? ???????????? ???????? ?????? ???????? ??????????????? ???????? ???????????? ?????????? ???????????? ?????? ?????????????. ?????????? ???!
 ? ?????? ???????????? ???????????? ?????? ??????????????? ???? ???????? ?????????????? ?????? ???????? ?????????????? ?????? ?????? ?? ?????? ?????? ???? ?????????? ??????????????????? ??????????????????? ???????????? ?????? ???? ???? ?????? ?????? ??????????????? ?????????? ??????.
+
+???????????? ???????? ??????? ?????? ???? ?????? ???????????????. ???????? ???????? ?????????? ?????? ????  ??????????????????? ?????????? ???? ????????????????? ??????????????????????? ??????????????? ?????? ???? ?????? ???????? ??????????? ???? ???? ??????????????????????? ?????? ??????????????? ?????????????.  ?????? ???????? ???? ???????????? ?????????? ?????????? ???? ?????????? ?????????? ???????????? ???? ???????? ?? ?????????? ?????????? ????  ???????? ???????? ?????????????.  ???? ???? ???????? ?????????? ?? ????????????????? ???????? ?????????????? ???? ??????????????????? ???????? ?????? ??????????????? ?????? ?? ???? ?????? ???????? ???? ?????? ????????????????? ???????? ?????? ??????????????? ????????????  ?????????? ????  ????????????????? ?????????? ?????????? ??????????. ???? ???????? ???????? ?????? ???? ???????????? ???????? ???????????? ?????? ????????????????? ???????????? ????  ?????????????? ??????????????? ?? ?????????? ?????????? ???????? ???? ??????!
 ????  ?????????? ???? ?????????? ???? ????????????????? ??????.
+\end{article}
+
+\articlesep
+
+\newsection{???????? ??}
+
+\begin{article}{2}
+{?????? ???? ???????? ?????????? ??????.?????? ??????????}
+{?????? ???? ?????? ?????????? ?????????????? ?????? ???? ???? ???? ???? ???? ?????????? ???????? ???????????????.}
+{???????? ??}
+{3}
+
+\authorandplace{?????? ??????????????}{????????}
+
+\noindent\timestamp{08:25}  et ?????????? ???????? ???? ?????? ???????????? ???? ???????????? ???????? ?? ???? ?????????? ?????????????? ??????????? ???? ?????????? ???????????? ???????? ??????????????? ???????? ???????? ???????? ?????????? ?????????? ???????????? ????????????  ?????? ?????????????????????? ?????????? ???????? ???????? ???? ?????????? ?????????????? ?????????????? ???? ?????? ?????? ??????.  ????????? ?????? ?????? ???????????? ???? ???? ???????? ???? ?????????? ?????? ???? ????????  ???????????? ???????????? ?????? ????????????? ??????.  ???? ???????? ???? ?????? ?????? ??????????????? ???????? ???? ???????????? ???????? ?? ?????????? ??????????????? ???????????? ?????????? ???? ?????????? ???????? ???????????? ???? ???? ???????? ???? ????????????? ???????????? ???????? ?????? ?????????? ????????. ???????????????? ???? ?????? ?????? ???????????? ??????????????? ???????????? ???? ?????? ????????????? ???? ?????????? ???????? ????????????????? ????????????? !
 ???????? ?????? ??????????????????? ???? ???? ???????? ???????? . ???? ?????? ?????? ??????????????? ??????????????? ???????????? ???? ?????? ????????????? ?? ????????????????????? ?????????? ???????? ?????????? ??????????  ???????? ???????? ???? ?????????? ???????????? ???????????? ?????????? ???????? ?? ?????????????? ???????? ?????????????? ????????????????? ?? ??????????????? ???????????? ???? ?????????? ?????????????? ?????????????? ???? ???? ???????? ??????????.
+
+?????? ???????????? ??????????????????????? ??????????????????? ?????????? ?????? ???????? ???? ???? ???? ???? ???????? ??????????????????????????? ???????????????? ?? ???? ???????? ??????????????????????????????? ??????????????? ?????????????.  ???? ??????????? ???? ????????????????? ??????????????????????? ???? ???????? ??????????????????????? ?????????????? ?????????????? ??????????????? ???????????? ???? ????????????????????? ???????????? ?????????????? ???????? ?????? ??????????????? ?????????? ????????????????? ???? ?????????? ?????? ????????????????? ???????? ???????? ????????????????????? ????????????????? ??????????/??????????????????? ??????.  ??????????????? ???? ???????? ?????? ?????????? ?????????????? ?????? ?????????? ?????????? ??????????????? ?????????? ??????????????? ?????????? ???? ???????? ??????????????? ???? ???????? ???????????? ???????? ?????? ???????? ??????????????? ???????? ???????????? ?????????? ???????????? ?????? ?????????????. ?????????? ???!
 ? ?????? ???????????? ???????????? ?????? ??????????????? ???? ???????? ?????????????? ?????? ???????? ?????????????? ?????? ?????? ?? ?????? ?????? ???? ?????????? ??????????????????? ??????????????????? ???????????? ?????? ???? ???? ?????? ?????? ??????????????? ?????????? ??????.
+
+???????????? ???????? ??????? ?????? ???? ?????? ???????????????. ???????? ???????? ?????????? ?????? ????  ??????????????????? ?????????? ???? ????????????????? ??????????????????????? ??????????????? ?????? ???? ?????? ???????? ??????????? ???? ???? ??????????????????????? ?????? ??????????????? ?????????????.  ?????? ???????? ???? ???????????? ?????????? ?????????? ???? ?????????? ?????????? ???????????? ???? ???????? ?? ?????????? ?????????? ????  ???????? ???????? ?????????????.  ???? ???? ???????? ?????????? ?? ????????????????? ???????? ?????????????? ???? ??????????????????? ???????? ?????? ??????????????? ?????? ?? ???? ?????? ???????? ???? ?????? ????????????????? ???????? ?????? ??????????????? ????????????  ?????????? ????  ????????????????? ?????????? ?????????? ??????????. ???? ???????? ???????? ?????? ???? ???????????? ???????? ???????????? ?????? ????????????????? ???????????? ????  ?????????????? ??????????????? ?? ?????????? ?????????? ???????? ???? ??????!
 ????  ?????????? ???? ?????????? ???? ????????????????? ??????.
+
+?????????? ???????? ???? ?????? ???????????? ???? ???????????? ???????? ?? ???? ?????????? ?????????????? ??????????? ???? ?????????? ???????????? ???????? ??????????????? ???????? ???????? ???????? ?????????? ?????????? ???????????? ????????????  ?????? ?????????????????????? ?????????? ???????? ???????? ???? ?????????? ?????????????? ?????????????? ???? ?????? ?????? ??????.  ????????? ?????? ?????? ???????????? ???? ???? ???????? ???? ?????????? ?????? ???? ????????  ???????????? ???????????? ?????? ????????????? ??????.  ???? ???????? ???? ?????? ?????? ??????????????? ???????? ???? ???????????? ???????? ?? ?????????? ??????????????? ???????????? ?????????? ???? ?????????? ???????? ???????????? ???? ???? ???????? ???? ????????????? ???????????? ???????? ?????? ?????????? ????????. ???????????????? ???? ?????? ?????? ???????????? ??????????????? ???????????? ???? ?????? ????????????? ???? ?????????? ???????? ????????????????? ????????????? ???????? ?????? ???????????????!
 ???? ???? ???? ???????? ???????? . ???? ?????? ?????? ??????????????? ??????????????? ???????????? ???? ?????? ????????????? ?? ????????????????????? ?????????? ???????? ?????????? ??????????  ???????? ???????? ???? ?????????? ???????????? ???????????? ?????????? ???????? ?? ?????????????? ???????? ?????????????? ????????????????? ?? ??????????????? ???????????? ???? ?????????? ?????????????? ?????????????? ???? ???? ???????? ??????????.
+
+?????? ???????????? ??????????????????????? ??????????????????? ?????????? ?????? ???????? ???? ???? ???? ???? ???????? ??????????????????????????? ???????????????? ?? ???? ???????? ??????????????????????????????? ??????????????? ?????????????.  ???? ??????????? ???? ????????????????? ??????????????????????? ???? ???????? ??????????????????????? ?????????????? ?????????????? ??????????????? ???????????? ???? ????????????????????? ???????????? ?????????????? ???????? ?????? ??????????????? ?????????? ????????????????? ???? ?????????? ?????? ????????????????? ???????? ???????? ????????????????????? ????????????????? ??????????/??????????????????? ??????.  ??????????????? ???? ???????? ?????? ?????????? ?????????????? ?????? ?????????? ?????????? ??????????????? ?????????? ??????????????? ?????????? ???? ???????? ??????????????? ???? ???????? ???????????? ???????? ?????? ???????? ??????????????? ???????? ???????????? ?????????? ???????????? ?????? ?????????????. ?????????? ???!
 ? ?????? ???????????? ???????????? ?????? ??????????????? ???? ???????? ?????????????? ?????? ???????? ?????????????? ?????? ?????? ?? ?????? ?????? ???? ?????????? ??????????????????? ??????????????????? ???????????? ?????? ???? ???? ?????? ?????? ??????????????? ?????????? ??????.
+
+???????????? ???????? ??????? ?????? ???? ?????? ???????????????. ???????? ???????? ?????????? ?????? ????  ??????????????????? ?????????? ???? ????????????????? ??????????????????????? ??????????????? ?????? ???? ?????? ???????? ??????????? ???? ???? ??????????????????????? ?????? ??????????????? ?????????????.  ?????? ???????? ???? ???????????? ?????????? ?????????? ???? ?????????? ?????????? ???????????? ???? ???????? ?? ?????????? ?????????? ????  ???????? ???????? ?????????????.  ???? ???? ???????? ?????????? ?? ????????????????? ???????? ?????????????? ???? ??????????????????? ???????? ?????? ??????????????? ?????? ?? ???? ?????? ???????? ???? ?????? ????????????????? ???????? ?????? ??????????????? ????????????  ?????????? ????  ????????????????? ?????????? ?????????? ??????????. ???? ???????? ???????? ?????? ???? ???????????? ???????? ???????????? ?????? ????????????????? ???????????? ????  ?????????????? ??????????????? ?? ?????????? ?????????? ???????? ???? ??????!
 ????  ?????????? ???? ?????????? ???? ????????????????? ??????.
+
+\expandedtitle{lines}{?????? ???? ???????????? ???????? ???????? ?????? ???? ???? ???? ???? ???? ???????????? ?????? ?????????? ???????? ?????????????? ???????? ?????????????????.}
+
+?????????? ???????? ???? ?????? ???????????? ???? ???????????? ???????? ?? ???? ?????????? ?????????????? ??????????? ???? ?????????? ???????????? ???????? ??????????????? ???????? ???????? ???????? ?????????? ?????????? ???????????? ????????????  ?????? ?????????????????????? ?????????? ???????? ???????? ???? ?????????? ?????????????? ?????????????? ???? ?????? ?????? ??????.  ????????? ?????? ?????? ???????????? ???? ???? ???????? ???? ?????????? ?????? ???? ????????  ???????????? ???????????? ?????? ????????????? ??????.  ???? ???????? ???? ?????? ?????? ??????????????? ???????? ???? ???????????? ???????? ?? ?????????? ??????????????? ???????????? ?????????? ???? ?????????? ???????? ???????????? ???? ???? ???????? ???? ????????????? ???????????? ???????? ?????? ?????????? ????????. ???????????????? ???? ?????? ?????? ???????????? ??????????????? ???????????? ???? ?????? ????????????? ???? ?????????? ???????? ????????????????? ????????????? ???????? ?????? ???????????????!
 ???? ???? ???? ???????? ???????? . ???? ?????? ?????? ??????????????? ??????????????? ???????????? ???? ?????? ????????????? ?? ????????????????????? ?????????? ???????? ?????????? ??????????  ???????? ???????? ???? ?????????? ???????????? ???????????? ?????????? ???????? ?? ?????????????? ???????? ?????????????? ????????????????? ?? ??????????????? ???????????? ???? ?????????? ?????????????? ?????????????? ???? ???? ???????? ??????????.
+
+?????? ???????????? ??????????????????????? ??????????????????? ?????????? ?????? ???????? ???? ???? ???? ???? ???????? ??????????????????????????? ???????????????? ?? ???? ???????? ??????????????????????????????? ??????????????? ?????????????.  ???? ??????????? ???? ????????????????? ??????????????????????? ???? ???????? ??????????????????????? ?????????????? ?????????????? ??????????????? ???????????? ???? ????????????????????? ???????????? ?????????????? ???????? ?????? ??????????????? ?????????? ????????????????? ???? ?????????? ?????? ????????????????? ???????? ???????? ????????????????????? ????????????????? ??????????/??????????????????? ??????.  ??????????????? ???? ???????? ?????? ?????????? ?????????????? ?????? ?????????? ?????????? ??????????????? ?????????? ??????????????? ?????????? ???? ???????? ??????????????? ???? ???????? ???????????? ???????? ?????? ???????? ??????????????? ???????? ???????????? ?????????? ???????????? ?????? ?????????????. ?????????? ???!
 ? ?????? ???????????? ???????????? ?????? ??????????????? ???? ???????? ?????????????? ?????? ???????? ?????????????? ?????? ?????? ?? ?????? ?????? ???? ?????????? ??????????????????? ??????????????????? ???????????? ?????? ???? ???? ?????? ?????? ??????????????? ?????????? ??????.
+
+???????????? ???????? ??????? ?????? ???? ?????? ???????????????. ???????? ???????? ?????????? ?????? ????  ??????????????????? ?????????? ???? ????????????????? ??????????????????????? ??????????????? ?????? ???? ?????? ???????? ??????????? ???? ???? ??????????????????????? ?????? ??????????????? ?????????????.  ?????? ???????? ???? ???????????? ?????????? ?????????? ???? ?????????? ?????????? ???????????? ???? ???????? ?? ?????????? ?????????? ????  ???????? ???????? ?????????????.  ???? ???? ???????? ?????????? ?? ????????????????? ???????? ?????????????? ???? ??????????????????? ???????? ?????? ??????????????? ?????? ?? ???? ?????? ???????? ???? ?????? ????????????????? ???????? ?????? ??????????????? ????????????  ?????????? ????  ????????????????? ?????????? ?????????? ??????????. ???? ???????? ???????? ?????? ???? ???????????? ???????? ???????????? ?????? ????????????????? ???????????? ????  ?????????????? ??????????????? ?? ?????????? ?????????? ???????? ???? ??????!
 ????  ?????????? ???? ?????????? ???? ????????????????? ??????.
+\end{article}
+
+\articlesep
+
+\begin{editorial}{1}{?????? ???? ???????? ???? ????????????????? ???? ?????? ???????????????? ??????.}{?????? ?? ?????? ????????????????}{4}
+???????? ???????? ???? ?????? ???????????? ???? ???????????? ???????? ?? ???? ?????????? ?????????????? ??????????? ???? ?????????? ???????????? ???????? ??????????????? ???????? ???????? ???????? ?????????? ?????????? ???????????? ????????????  ?????? ?????????????????????? ?????????? ???????? ???????? ???? ?????????? ?????????????? ?????????????? ???? ?????? ?????? ??????.  ????????? ?????? ?????? ???????????? ???? ???? ???????? ???? ?????????? ?????? ???? ????????  ???????????? ???????????? ?????? ????????????? ??????.  ???? ???????? ???? ?????? ?????? ??????????????? ???????? ???? ???????????? ???????? ?? ?????????? ??????????????? ???????????? ?????????? ???? ?????????? ???????? ???????????? ???? ???? ???????? ???? ????????????? ???????????? ???????? ?????? ?????????? ????????. ???????????????? ???? ?????? ?????? ???????????? ??????????????? ???????????? ???? ?????? ????????????? ???? ?????????? ???????? ????????????????? ????????????? ???????? ?????? ?????????????????!
 ?? ???? ???? ???????? ???????? . ???? ?????? ?????? ??????????????? ??????????????? ???????????? ???? ?????? ????????????? ?? ????????????????????? ?????????? ???????? ?????????? ??????????  ???????? ???????? ???? ?????????? ???????????? ???????????? ?????????? ???????? ?? ?????????????? ???????? ?????????????? ????????????????? ?? ??????????????? ???????????? ???? ?????????? ?????????????? ?????????????? ???? ???? ???????? ??????????.
+
+?????? ???????????? ??????????????????????? ??????????????????? ?????????? ?????? ???????? ???? ???? ???? ???? ???????? ??????????????????????????? ???????????????? ?? ???? ???????? ??????????????????????????????? ??????????????? ?????????????.  ???? ??????????? ???? ????????????????? ??????????????????????? ???? ???????? ??????????????????????? ?????????????? ?????????????? ??????????????? ???????????? ???? ????????????????????? ???????????? ?????????????? ???????? ?????? ??????????????? ?????????? ????????????????? ???? ?????????? ?????? ????????????????? ???????? ???????? ????????????????????? ????????????????? ??????????/??????????????????? ??????.  ??????????????? ???? ???????? ?????? ?????????? ?????????????? ?????? ?????????? ?????????? ??????????????? ?????????? ??????????????? ?????????? ???? ???????? ??????????????? ???? ???????? ???????????? ???????? ?????? ???????? ??????????????? ???????? ???????????? ?????????? ???????????? ?????? ?????????????. ?????????? ???!
 ? ?????? ???????????? ???????????? ?????? ??????????????? ???? ???????? ?????????????? ?????? ???????? ?????????????? ?????? ?????? ?? ?????? ?????? ???? ?????????? ??????????????????? ??????????????????? ???????????? ?????? ???? ???? ?????? ?????? ??????????????? ?????????? ??????.
+
+???????????? ???????? ??????? ?????? ???? ?????? ???????????????. ???????? ???????? ?????????? ?????? ????  ??????????????????? ?????????? ???? ????????????????? ??????????????????????? ??????????????? ?????? ???? ?????? ???????? ??????????? ???? ???? ??????????????????????? ?????? ??????????????? ?????????????.  ?????? ???????? ???? ???????????? ?????????? ?????????? ???? ?????????? ?????????? ???????????? ???? ???????? ?? ?????????? ?????????? ????  ???????? ???????? ?????????????.  ???? ???? ???????? ?????????? ?? ????????????????? ???????? ?????????????? ???? ??????????????????? ???????? ?????? ??????????????? ?????? ?? ???? ?????? ???????? ???? ?????? ????????????????? ???????? ?????? ??????????????? ????????????  ?????????? ????  ????????????????? ?????????? ?????????? ??????????. ???? ???????? ???????? ?????? ???? ???????????? ???????? ???????????? ?????? ????????????????? ???????????? ????  ?????????????? ??????????????? ?? ?????????? ?????????? ???????? ???? ??????!
 ????  ?????????? ???? ?????????? ???? ????????????????? ??????.
+\end{editorial}
+
+\articlesep
+
+\begin{shortarticle}{4}{???????? ???????????? ??????????}{???????? ???????????? ?????????? ???????? ?????????? ?????????????????}{5}
+\shortarticleitem{?????? ???? ???????? ?????????? ??????}{?????????? ???????? ???? ?????? ???????????? ???? ???????????? ???????? ?? ???? ?????????? ?????????????? ??????????? ???? ?????????? ???????????? ???????? ??????????????? ???????? ???????? ???????? ?????????? ?????????? ???????????? ????????????  ?????? ?????????????????????? ?????????? ???????? ???????? ???? ?????????? ?????????????? ?????????????? ???? ?????? ?????? ??????.  ????????? ?????? ?????? ???????????? ???? ???? ???????? ???? ?????????? ?????? ???? ????????  ???????????? ???????????? ?????? ????????????? ??????.  ???? ???????? ???? ?????? ?????? ??????????????? ???????? ???? ???????????? ???????? ?? ?????????? ??????????????? ???????????? ?????????? ???? ?????????? ???????? ???????????? ???? ???? ???????? ???? ????????????? ???????????? ???????? ?????? ?????????? ????????. ???????????????? ???? ?????? ?????? ???????????? ??????????????? ???????????? ???? ?????? ????????????? ???? ?????????? ???????? ?????!
 ???????????? ????????????? ???????? ?????? ??????????????????? ???? ???? ???????? ???????? . ???? ?????? ?????? ??????????????? ??????????????? ???????????? ???? ?????? ????????????? ?? ????????????????????? ?????????? ???????? ?????????? ??????????  ???????? ???????? ???? ?????????? ???????????? ???????????? ?????????? ???????? ?? ?????????????? ???????? ?????????????? ????????????????? ?? ??????????????? ???????????? ???? ?????????? ?????????????? ?????????????? ???? ???? ???????? ??????????.}
+\shortarticleitem{???? ???????? ?????????? ????????}{?????????? ???????? ???? ?????? ???????????? ???? ???????????? ???????? ?? ???? ?????????? ?????????????? ??????????? ???? ?????????? ???????????? ???????? ??????????????? ???????? ???????? ???????? ?????????? ?????????? ???????????? ????????????  ?????? ?????????????????????? ?????????? ???????? ???????? ???? ?????????? ?????????????? ?????????????? ???? ?????? ?????? ??????.  ????????? ?????? ?????? ???????????? ???? ???? ???????? ???? ?????????? ?????? ???? ????????  ???????????? ???????????? ?????? ????????????? ??????.  ???? ???????? ???? ?????? ?????? ??????????????? ???????? ???? ???????????? ???????? ?? ?????????? ??????????????? ???????????? ?????????? ???? ?????????? ???????? ???????????? ???? ???? ???????? ???? ????????????? ???????????? ???????? ?????? ?????????? ????????. ???????????????? ???? ?????? ?????? ???????????? ??????????????? ???????????? ???? ?????? ????????????? ???? ?????????? ???????? ??????????!
 ??????? ????????????? ???????? ?????? ??????????????????? ???? ???? ???????? ???????? . ???? ?????? ?????? ??????????????? ??????????????? ???????????? ???? ?????? ????????????? ?? ????????????????????? ?????????? ???????? ?????????? ??????????  ???????? ???????? ???? ?????????? ???????????? ???????????? ?????????? ???????? ?? ?????????????? ???????? ?????????????? ????????????????? ?? ??????????????? ???????????? ???? ?????????? ?????????????? ?????????????? ???? ???? ???????? ??????????.}
+\shortarticleitem{???? ???????? ?????????? ????????}{?????????? ???????? ???? ?????? ???????????? ???? ???????????? ???????? ?? ???? ?????????? ?????????????? ??????????? ???? ?????????? ???????????? ???????? ??????????????? ???????? ???????? ???????? ?????????? ?????????? ???????????? ????????????  ?????? ?????????????????????? ?????????? ???????? ???????? ???? ?????????? ?????????????? ?????????????? ???? ?????? ?????? ??????.  ????????? ?????? ?????? ???????????? ???? ???? ???????? ???? ?????????? ?????? ???? ????????  ???????????? ???????????? ?????? ????????????? ??????.  ???? ???????? ???? ?????? ?????? ??????????????? ???????? ???? ???????????? ???????? ?? ?????????? ??????????????? ???????????? ?????????? ???? ?????????? ???????? ???????????? ???? ???? ???????? ???? ????????????? ???????????? ???????? ?????? ?????????? ????????. ???????????????? ???? ?????? ?????? ???????????? ??????????????? ???????????? ???? ?????? ????????????? ???? ?????????? ???????? ??????????!
 ??????? ????????????? ???????? ?????? ??????????????????? ???? ???? ???????? ???????? . ???? ?????? ?????? ??????????????? ??????????????? ???????????? ???? ?????? ????????????? ?? ????????????????????? ?????????? ???????? ?????????? ??????????  ???????? ???????? ???? ?????????? ???????????? ???????????? ?????????? ???????? ?? ?????????????? ???????? ?????????????? ????????????????? ?? ??????????????? ???????????? ???? ?????????? ?????????????? ?????????????? ???? ???? ???????? ??????????.}
+\shortarticleitem{???? ???????? ?????????? ????????}{?????????? ???????? ???? ?????? ???????????? ???? ???????????? ???????? ?? ???? ?????????? ?????????????? ??????????? ???? ?????????? ???????????? ???????? ??????????????? ???????? ???????? ???????? ?????????? ?????????? ???????????? ????????????  ?????? ?????????????????????? ?????????? ???????? ???????? ???? ?????????? ?????????????? ?????????????? ???? ?????? ?????? ??????.  ????????? ?????? ?????? ???????????? ???? ???? ???????? ???? ?????????? ?????? ???? ????????  ???????????? ???????????? ?????? ????????????? ??????.  ???? ???????? ???? ?????? ?????? ??????????????? ???????? ???? ???????????? ???????? ?? ?????????? ??????????????? ???????????? ?????????? ???? ?????????? ???????? ???????????? ???? ???? ???????? ???? ????????????? ???????????? ???????? ?????? ?????????? ????????. ???????????????? ???? ?????? ?????? ???????????? ??????????????? ???????????? ???? ?????? ????????????? ???? ?????????? ???????? ??????????!
 ??????? ????????????? ???????? ?????? ??????????????????? ???? ???? ???????? ???????? . ???? ?????? ?????? ??????????????? ??????????????? ???????????? ???? ?????? ????????????? ?? ????????????????????? ?????????? ???????? ?????????? ??????????  ???????? ???????? ???? ?????????? ???????????? ???????????? ?????????? ???????? ?? ?????????????? ???????? ?????????????? ????????????????? ?? ??????????????? ???????????? ???? ?????????? ?????????????? ?????????????? ???? ???? ???????? ??????????.}
+\shortarticleitem{???? ???????? ?????????? ????????}{?????????? ???????? ???? ?????? ???????????? ???? ???????????? ???????? ?? ???? ?????????? ?????????????? ??????????? ???? ?????????? ???????????? ???????? ??????????????? ???????? ???????? ???????? ?????????? ?????????? ???????????? ????????????  ?????? ?????????????????????? ?????????? ???????? ???????? ???? ?????????? ?????????????? ?????????????? ???? ?????? ?????? ??????.  ????????? ?????? ?????? ???????????? ???? ???? ???????? ???? ?????????? ?????? ???? ????????  ???????????? ???????????? ?????? ????????????? ??????.  ???? ???????? ???? ?????? ?????? ??????????????? ???????? ???? ???????????? ???????? ?? ?????????? ??????????????? ???????????? ?????????? ???? ?????????? ???????? ???????????? ???? ???? ???????? ???? ????????????? ???????????? ???????? ?????? ?????????? ????????. ???????????????? ???? ?????? ?????? ???????????? ??????????????? ???????????? ???? ?????? ????????????? ???? ?????????? ???????? ??????????!
 ??????? ????????????? ???????? ?????? ??????????????????? ???? ???? ???????? ???????? . ???? ?????? ?????? ??????????????? ??????????????? ???????????? ???? ?????? ????????????? ?? ????????????????????? ?????????? ???????? ?????????? ??????????  ???????? ???????? ???? ?????????? ???????????? ???????????? ?????????? ???????? ?? ?????????????? ???????? ?????????????? ????????????????? ?? ??????????????? ???????????? ???? ?????????? ?????????????? ?????????????? ???? ???? ???????? ??????????.}
+\shortarticleitem{???? ???????? ?????????? ????????}{?????????? ???????? ???? ?????? ???????????? ???? ???????????? ???????? ?? ???? ?????????? ?????????????? ??????????? ???? ?????????? ???????????? ???????? ??????????????? ???????? ???????? ???????? ?????????? ?????????? ???????????? ????????????  ?????? ?????????????????????? ?????????? ???????? ???????? ???? ?????????? ?????????????? ?????????????? ???? ?????? ?????? ??????.  ????????? ?????? ?????? ???????????? ???? ???? ???????? ???? ?????????? ?????? ???? ????????  ???????????? ???????????? ?????? ????????????? ??????.  ???? ???????? ???? ?????? ?????? ??????????????? ???????? ???? ???????????? ???????? ?? ?????????? ??????????????? ???????????? ?????????? ???? ?????????? ???????? ???????????? ???? ???? ???????? ???? ????????????? ???????????? ???????? ?????? ?????????? ????????. ???????????????? ???? ?????? ?????? ???????????? ??????????????? ???????????? ???? ?????? ????????????? ???? ?????????? ???????? ??????????!
 ??????? ????????????? ???????? ?????? ??????????????????? ???? ???? ???????? ???????? . ???? ?????? ?????? ??????????????? ??????????????? ???????????? ???? ?????? ????????????? ?? ????????????????????? ?????????? ???????? ?????????? ??????????  ???????? ???????? ???? ?????????? ???????????? ???????????? ?????????? ???????? ?? ?????????????? ???????? ?????????????? ????????????????? ?? ??????????????? ???????????? ???? ?????????? ?????????????? ?????????????? ???? ???? ???????? ??????????.}
+\end{shortarticle}
+
+\articlesep
+
+\end{document}

Added: tags/texmf/doc/xepersian/examples/test-correction.tex
===================================================================
--- tags/texmf/doc/xepersian/examples/test-correction.tex	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/doc/xepersian/examples/test-correction.tex	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,39 @@
+\documentclass{article}
+\usepackage[correction]{xepersian-multiplechoice}
+\usepackage{xepersian}
+\settextfont[Scale=1]{XB Zar}
+\setlatintextfont[Scale=1]{Linux Libertine}
+\setdigitfont[Scale=1]{Parsi Digits}
+\begin{document}
+\begin{question}{?????? ???$A=\{ 1,2\} $??? ?? ???$B=\{ 2,3\} $??? ?????????? ???????? $B^2-A\times B$ ???????? ??????.}
+\false $\{(3,2),(3,3)\} $
+\true $\{(2,2),(2,3)\} $
+\false $\{(2,3),(3,3)\} $
+\false $\{(2,2),(3,2)\} $
+\end{question}
+
+\begin{question}{?????? ???$A=\{ 1,2\} $??? ?? ???$B=\{ 2,3\} $??? ?????????? ???????? $B^2-A\times B$ ???????? ??????.}
+\true $x$
+\false $y$
+\false $z$
+\false $t$
+\end{question}
+
+\begin{question}{??????????????? $(B-A^{'})^{'}$ ????????????? ?????? ????:}
+\false $B^{'}\bigcap A$
+\false $B'\bigcup A' $
+\true $A$
+\false ??????????????.
+\end{question}
+
+\begin{question}{???????? ?????????????? ?????? ?????????? ???$\frac{7+i}{1-i}$??? ???????? ??????.}
+\false $4+4i$
+\false $4-3i$
+\false $3+4i$
+\true $3-3i$
+\end{question}
+\begin{correction}
+???????? ???????? ?????? ???? ?????????? ??????.
+\end{correction}
+
+\end{document}

Added: tags/texmf/doc/xepersian/examples/test-empty-form.tex
===================================================================
--- tags/texmf/doc/xepersian/examples/test-empty-form.tex	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/doc/xepersian/examples/test-empty-form.tex	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,43 @@
+\documentclass{article}
+\usepackage{xepersian-multiplechoice}
+\usepackage{xepersian}
+\settextfont[Scale=1]{XB Zar}
+\setlatintextfont[Scale=1]{Linux Libertine}
+\setdigitfont[Scale=1]{Parsi Digits}
+\begin{document}
+\begin{question}{?????? ???$A=\{ 1,2\} $??? ?? ???$B=\{ 2,3\} $??? ?????????? ???????? $B^2-A\times B$ ???????? ??????.}
+\false $\{(3,2),(3,3)\} $
+\true $\{(2,2),(2,3)\} $
+\false $\{(2,3),(3,3)\} $
+\false $\{(2,2),(3,2)\} $
+\end{question}
+
+\begin{question}{?????? ???$A=\{ 1,2\} $??? ?? ???$B=\{ 2,3\} $??? ?????????? ???????? $B^2-A\times B$ ???????? ??????.}
+\true $x$
+\false $y$
+\false $z$
+\false $t$
+\end{question}
+
+\begin{question}{??????????????? $(B-A^{'})^{'}$ ????????????? ?????? ????:}
+\false $B^{'}\bigcap A$
+\false $B'\bigcup A' $
+\true $A$
+\false ??????????????.
+\end{question}
+
+\begin{question}{???????? ?????????????? ?????? ?????????? ???$\frac{7+i}{1-i}$??? ???????? ??????.}
+\false $4+4i$
+\false $4-3i$
+\false $3+4i$
+\true $3-3i$
+\end{question}
+\begin{correction}
+???????? ???????? ?????? ???? ?????????? ??????.
+\end{correction}
+\bigskip
+
+\begin{center}
+\makeform
+\end{center}
+\end{document}

Added: tags/texmf/doc/xepersian/examples/test-question-only.tex
===================================================================
--- tags/texmf/doc/xepersian/examples/test-question-only.tex	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/doc/xepersian/examples/test-question-only.tex	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,39 @@
+\documentclass{article}
+\usepackage{xepersian-multiplechoice}
+\usepackage{xepersian}
+\settextfont[Scale=1]{XB Zar}
+\setlatintextfont[Scale=1]{Linux Libertine}
+\setdigitfont[Scale=1]{Parsi Digits}
+\begin{document}
+\begin{question}{?????? ???$A=\{ 1,2\} $??? ?? ???$B=\{ 2,3\} $??? ?????????? ???????? $B^2-A\times B$ ???????? ??????.}
+\false $\{(3,2),(3,3)\} $
+\true $\{(2,2),(2,3)\} $
+\false $\{(2,3),(3,3)\} $
+\false $\{(2,2),(3,2)\} $
+\end{question}
+
+\begin{question}{?????? ???$A=\{ 1,2\} $??? ?? ???$B=\{ 2,3\} $??? ?????????? ???????? $B^2-A\times B$ ???????? ??????.}
+\true $x$
+\false $y$
+\false $z$
+\false $t$
+\end{question}
+
+\begin{question}{??????????????? $(B-A^{'})^{'}$ ????????????? ?????? ????:}
+\false $B^{'}\bigcap A$
+\false $B'\bigcup A' $
+\true $A$
+\false ??????????????.
+\end{question}
+
+\begin{question}{???????? ?????????????? ?????? ?????????? ???$\frac{7+i}{1-i}$??? ???????? ??????.}
+\false $4+4i$
+\false $4-3i$
+\false $3+4i$
+\true $3-3i$
+\end{question}
+\begin{correction}
+???????? ???????? ?????? ???? ?????????? ??????.
+\end{correction}
+
+\end{document}

Added: tags/texmf/doc/xepersian/examples/test-solution-form.tex
===================================================================
--- tags/texmf/doc/xepersian/examples/test-solution-form.tex	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/doc/xepersian/examples/test-solution-form.tex	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,43 @@
+\documentclass{article}
+\usepackage{xepersian-multiplechoice}
+\usepackage{xepersian}
+\settextfont[Scale=1]{XB Zar}
+\setlatintextfont[Scale=1]{Linux Libertine}
+\setdigitfont[Scale=1]{Parsi Digits}
+\begin{document}
+\begin{question}{?????? ???$A=\{ 1,2\} $??? ?? ???$B=\{ 2,3\} $??? ?????????? ???????? $B^2-A\times B$ ???????? ??????.}
+\false $\{(3,2),(3,3)\} $
+\true $\{(2,2),(2,3)\} $
+\false $\{(2,3),(3,3)\} $
+\false $\{(2,2),(3,2)\} $
+\end{question}
+
+\begin{question}{?????? ???$A=\{ 1,2\} $??? ?? ???$B=\{ 2,3\} $??? ?????????? ???????? $B^2-A\times B$ ???????? ??????.}
+\true $x$
+\false $y$
+\false $z$
+\false $t$
+\end{question}
+
+\begin{question}{??????????????? $(B-A^{'})^{'}$ ????????????? ?????? ????:}
+\false $B^{'}\bigcap A$
+\false $B'\bigcup A' $
+\true $A$
+\false ??????????????.
+\end{question}
+
+\begin{question}{???????? ?????????????? ?????? ?????????? ???$\frac{7+i}{1-i}$??? ???????? ??????.}
+\false $4+4i$
+\false $4-3i$
+\false $3+4i$
+\true $3-3i$
+\end{question}
+\begin{correction}
+???????? ???????? ?????? ???? ?????????? ??????.
+\end{correction}
+
+\bigskip
+\begin{center}
+\makemask
+\end{center}
+\end{document}

Added: tags/texmf/doc/xepersian/examples/thesis-sample.tex
===================================================================
--- tags/texmf/doc/xepersian/examples/thesis-sample.tex	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/doc/xepersian/examples/thesis-sample.tex	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,62 @@
+\documentclass[a4paper,11pt]{xepersian-thesis}
+\usepackage{graphicx}
+\usepackage{xepersian}
+\settextfont[Scale=1]{XB Zar}
+\setlatintextfont[Scale=1]{Linux Libertine}
+\setdigitfont[Scale=1]{XB Zar}
+
+\begin{document}
+\title{?????????? ????????}
+\author{?????? ??????????}
+\degree{???????????????? ?????????????? ??????}
+\supervisor{???????? ????????}
+\department{??????????}
+\university{??????????}
+\city{??????????}
+\thesisdate{\today}
+\maketitle
+\begin{acknowledgementpage}
+???? ?????????? ???????? ???????? ???? ?????? ???????? ??????
+\end{acknowledgementpage}
+\begin{abstractpage}
+?????????? ???? ???????? ?????????? ????????...
+\keywords{?????????? ???????? ?????????? ?? ????????????????}
+\end{abstractpage}
+\tableofcontents
+\listoftables
+\chapter{???????????? ??????????}
+???? ?????????? ???????? ??????????????? ???? ?????????? ?????? ?????????????? ?????????? ?????????????? ???? ?????????? ????????????????? ???? ????????
+\begin{equation}
+(a+b)^2=a^2+2ab+b^3
+\end{equation}
+\newpage
+?????? ?????????? ???????? ?????? ???? ???? ???? ?????? ???????? ???? ?????????? ???????????? ?????????? ?????????? ??????????.
+\section{??????????}
+
+\newpage
+?????? ???? ???? ?????????? ???????? ????????
+\chapter{??????}
+\chapter{??????}
+\appendix
+\chapter{??????}
+\chapter{??????}
+\chapter{??????}
+\bibliographystyle{unsrt}
+\begin{thebibliography}{99}
+\end{thebibliography}
+\begin{latin}
+\latintitle{Pure Mathematics}
+\latinauthor{Vafa Khalighi}
+\latindegree{Bachelor of Pure Mathematics}
+\latinthesisdate{\latintoday}
+\latinsupervisor{Mohammad Ghodsi}
+\latindepartment{Computer Science}
+\latinuniversity{Iran University of Science \& Technology}
+\latincity{Tehran}
+\begin{latinabstract}
+\noindent This is our abstract written in English and This thesis is written very very very carefully so that we can keep  an eye on the beauty of typesetting.
+\latinkeywords{Mathematics, topology, geometry and category theory.}
+\end{latinabstract}
+\makelatintitle
+\end{latin}
+\end{document}

Added: tags/texmf/doc/xepersian/farsitex2xepersian/ftxe-0.10.py
===================================================================
--- tags/texmf/doc/xepersian/farsitex2xepersian/ftxe-0.10.py	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/doc/xepersian/farsitex2xepersian/ftxe-0.10.py	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,1040 @@
+???#  This program is free software: you can redistribute it and/or modify
+#  it under the terms of the GNU General Public License as published by
+#  the Free Software Foundation, either version 3 of the License, or
+#  (at your option) any later version.
+#
+#  This program is distributed in the hope that it will be useful,
+#  but WITHOUT ANY WARRANTY; without even the implied warranty of
+#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+#  GNU General Public License for more details.
+#
+#  You should have received a copy of the GNU General Public License
+#  along with this program. If not, see <http://www.gnu.org/licenses>
+
+##################################################
+#  Author:      Mostafa Vahedi                   #
+#  Date:        05 July 2009                     #
+#  Version:     0.10                             # 
+#  Application: FarsiTeX to XePersian converter  #
+##################################################
+
+import codecs
+
+import sys
+import os
+
+ft_numerical = [
+chr(0xB9),	# 	Arabic Thoushads Seperator
+chr(0xBC)	#	ARABIC DECIMAL SEPARATOR
+]
+
+
+ft_vowels = [
+chr(0xB0),	#	ARABIC FATHA
+chr(0xB1),	#	ARABIC KASRA
+chr(0xB2),	#	ARABIC DAMMA
+chr(0xB3),	#	ARABIC FATHATAN
+chr(0xB4),	#	ARABIC SHADDA
+chr(0xBA),	#	ARABIC LETTER SUPERSCRIPT ALEF
+chr(0xBB),	#	ARABIC HAMZA ABOVE
+chr(0xC4) 	#	ARABIC SUKUN
+]
+
+ft_non_joiners = [
+chr(0x8F)	#	ARABIC LETTER HAMZA
+]
+
+ft_bidi_joiners_initial = [
+chr(0xE4),	#	ARABIC LETTER AIN, initial form
+chr(0xE8),	#	ARABIC LETTER GHAIN, initial form
+chr(0xFB) 	#	ARABIC LETTER HEH, initial form
+]
+
+ft_bidi_joiners_medial = [
+chr(0xE3),	#	ARABIC LETTER AIN, medial form
+chr(0xE7),	#	ARABIC LETTER GHAIN, medial form
+chr(0xFA) 	#	ARABIC LETTER HEH, medial form
+]
+
+ft_bidi_joiners_final = [
+chr(0xE2),	#	ARABIC LETTER AIN, final form
+chr(0xE6),	#	ARABIC LETTER GHAIN, final form
+chr(0xFC) 	#	ARABIC LETTER FARSI YEH, final form
+]
+
+ft_bidi_joiners_isolated = [
+chr(0xE1),	#	ARABIC LETTER AIN, isolated form
+chr(0xE5),	#	ARABIC LETTER GHAIN, isolated form
+chr(0xFD) 	#	ARABIC LETTER FARSI YEH, isolated form
+]
+
+ft_bidi_joiners_initial_medial = [
+chr(0x8B),	#	ARABIC TATWEEL
+chr(0x8E),	#	ARABIC LETTER YEH WITH HAMZA ABOVE, initial-medial form
+chr(0x93),	#	ARABIC LETTER BEH, initial-medial form
+chr(0x95),	#	ARABIC LETTER PEH, initial-medial form
+chr(0x97),	#	ARABIC LETTER TEH, initial-medial form
+chr(0x99),	#	ARABIC LETTER THEH, initial-medial form
+chr(0x9B),	#	ARABIC LETTER JEEM, initial-medial form
+chr(0x9D),	#	ARABIC LETTER TCHEH, initial-medial form
+chr(0x9F),	#	ARABIC LETTER HAH, initial-medial form
+chr(0xA1),	#	ARABIC LETTER KHAH, initial-medial form
+chr(0xA8),	#	ARABIC LETTER SEEN, initial-medial form
+chr(0xAA),	#	ARABIC LETTER SHEEN, initial-medial form
+chr(0xAC),	#	ARABIC LETTER SAD, initial-medial form
+chr(0xAE),	#	ARABIC LETTER DAD, initial-medial form
+chr(0xAF),	#	ARABIC LETTER TAH, initial-medial form
+chr(0xE0),	#	ARABIC LETTER ZAH, initial-medial form
+chr(0xEA),	#	ARABIC LETTER FEH, initial-medial form
+chr(0xEC),	#	ARABIC LETTER QAF, initial-medial form
+chr(0xEE),	#	ARABIC LETTER KEHEH, initial-medial form
+chr(0xF0),	#	ARABIC LETTER GAF, initial-medial form
+chr(0xF3),	#	ARABIC LETTER LAM, initial-medial form
+chr(0xF5),	#	ARABIC LETTER MEEM, initial-medial form
+chr(0xF7),	#	ARABIC LETTER NOON, initial-medial form
+chr(0xFE)	#	ARABIC LETTER FARSI YEH, initial-medial form
+]
+
+ft_bidi_joiners_final_isolated = [
+chr(0x92),	#	ARABIC LETTER BEH, final-isolated form
+chr(0x94),	#	ARABIC LETTER PEH, final-isolated form
+chr(0x96),	#	ARABIC LETTER TEH, final-isolated form
+chr(0x98),	#	ARABIC LETTER THEH, final-isolated form
+chr(0x9A),	#	ARABIC LETTER JEEM, final-isolated form
+chr(0x9C),	#	ARABIC LETTER TCHEH, final-isolated form
+chr(0x9E),	#	ARABIC LETTER HAH, final-isolated form
+chr(0xA0),	#	ARABIC LETTER KHAH, final-isolated form
+chr(0xA7),	#	ARABIC LETTER SEEN, final-isolated form
+chr(0xA9),	#	ARABIC LETTER SHEEN, final-isolated form
+chr(0xAB),	#	ARABIC LETTER SAD, final-isolated form
+chr(0xAD),	#	ARABIC LETTER DAD, final-isolated form
+chr(0xC1),	#	ARABIC LETTER TAH, final-isolated form
+chr(0xC2),	#	ARABIC LETTER ZAH, final-isolated form
+chr(0xE9),	#	ARABIC LETTER FEH, final-isolated form
+chr(0xEB),	#	ARABIC LETTER QAF, final-isolated form
+chr(0xED),	#	ARABIC LETTER KEHEH, final-isolated form
+chr(0xEF),	#	ARABIC LETTER GAF, final-isolated form
+chr(0xF1),	#	ARABIC LETTER LAM, final-isolated form
+chr(0xF4),	#	ARABIC LETTER MEEM, final-isolated form
+chr(0xF6),	#	ARABIC LETTER NOON, final-isolated form
+chr(0xF9) 	#	ARABIC LETTER HEH, final-isolated form
+]
+
+ft_right_joiners_final = [
+chr(0x91)	#	ARABIC LETTER ALEF, final form
+]
+
+ft_right_joiners_isolated = [
+chr(0x8D),	#	ARABIC LETTER ALEF WITH MADDA ABOVE, isolated form
+chr(0x90)	#	ARABIC LETTER ALEF, isolated form
+]
+
+ft_right_joiners_final_isolated = [
+chr(0xA2),	#	ARABIC LETTER DAL
+chr(0xA3),	#	ARABIC LETTER THAL
+chr(0xA4),	#	ARABIC LETTER REH
+chr(0xA5),	#	ARABIC LETTER ZAIN
+chr(0xA6),	#	ARABIC LETTER JEH
+chr(0xBF),	#	ARABIC LETTER TEH MARBUTAH
+chr(0xF2),	#	ARABIC LIGATURE LAM WITH ALEF
+chr(0xF8)	#	ARABIC LETTER WAW
+]
+
+
+table_FT_UN = {
+chr(0x80) : [u'\u06F0'],	#	EXTENDED ARABIC-INDIC DIGIT ZERO
+chr(0x81) : [u'\u06F1'],	#	EXTENDED ARABIC-INDIC DIGIT ONE
+chr(0x82) : [u'\u06F2'],	#	EXTENDED ARABIC-INDIC DIGIT TWO
+chr(0x83) : [u'\u06F3'],	#	EXTENDED ARABIC-INDIC DIGIT THREE
+chr(0x84) : [u'\u06F4'],	#	EXTENDED ARABIC-INDIC DIGIT FOUR
+chr(0x85) : [u'\u06F5'],	#	EXTENDED ARABIC-INDIC DIGIT FIVE
+chr(0x86) : [u'\u06F6'],	#	EXTENDED ARABIC-INDIC DIGIT SIX
+chr(0x87) : [u'\u06F7'],	#	EXTENDED ARABIC-INDIC DIGIT SEVEN
+chr(0x88) : [u'\u06F8'],	#	EXTENDED ARABIC-INDIC DIGIT EIGHT
+chr(0x89) : [u'\u06F9'],	#	EXTENDED ARABIC-INDIC DIGIT NINE
+chr(0x8A) : [u'\u060C'],	#	ARABIC COMMA
+chr(0x8B) : [u'\u0640'],	#	ARABIC TATWEEL
+chr(0x8C) : [u'\u061F'],	#	ARABIC QUESTION MARK
+chr(0x8D) : [u'\u0622'],	#	ARABIC LETTER ALEF WITH MADDA ABOVE, isolated form
+chr(0x8E) : [u'\u0626'],	#	ARABIC LETTER YEH WITH HAMZA ABOVE, initial-medial form
+chr(0x8F) : [u'\u0621'],	#	ARABIC LETTER HAMZA
+chr(0x90) : [u'\u0627'],	#	ARABIC LETTER ALEF, isolated form
+chr(0x91) : [u'\u0627'],	#	ARABIC LETTER ALEF, final form
+chr(0x92) : [u'\u0628'],	#	ARABIC LETTER BEH, final-isolated form
+chr(0x93) : [u'\u0628'],	#	ARABIC LETTER BEH, initial-medial form
+chr(0x94) : [u'\u067E'],	#	ARABIC LETTER PEH, final-isolated form
+chr(0x95) : [u'\u067E'],	#	ARABIC LETTER PEH, initial-medial form
+chr(0x96) : [u'\u062A'],	#	ARABIC LETTER TEH, final-isolated form
+chr(0x97) : [u'\u062A'],	#	ARABIC LETTER TEH, initial-medial form
+chr(0x98) : [u'\u062B'],	#	ARABIC LETTER THEH, final-isolated form
+chr(0x99) : [u'\u062B'],	#	ARABIC LETTER THEH, initial-medial form
+chr(0x9A) : [u'\u062C'],	#	ARABIC LETTER JEEM, final-isolated form
+chr(0x9B) : [u'\u062C'],	#	ARABIC LETTER JEEM, initial-medial form
+chr(0x9C) : [u'\u0686'],	#	ARABIC LETTER TCHEH, final-isolated form
+chr(0x9D) : [u'\u0686'],	#	ARABIC LETTER TCHEH, initial-medial form
+chr(0x9E) : [u'\u062D'],	#	ARABIC LETTER HAH, final-isolated form
+chr(0x9F) : [u'\u062D'],	#	ARABIC LETTER HAH, initial-medial form
+chr(0xA0) : [u'\u062E'],	#	ARABIC LETTER KHAH, final-isolated form
+chr(0xA1) : [u'\u062E'],	#	ARABIC LETTER KHAH, initial-medial form
+chr(0xA2) : [u'\u062F'],	#	ARABIC LETTER DAL
+chr(0xA3) : [u'\u0630'],	#	ARABIC LETTER THAL
+chr(0xA4) : [u'\u0631'],	#	ARABIC LETTER REH
+chr(0xA5) : [u'\u0632'],	#	ARABIC LETTER ZAIN
+chr(0xA6) : [u'\u0698'],	#	ARABIC LETTER JEH
+chr(0xA7) : [u'\u0633'],	#	ARABIC LETTER SEEN, final-isolated form
+chr(0xA8) : [u'\u0633'],	#	ARABIC LETTER SEEN, initial-medial form
+chr(0xA9) : [u'\u0634'],	#	ARABIC LETTER SHEEN, final-isolated form
+chr(0xAA) : [u'\u0634'],	#	ARABIC LETTER SHEEN, initial-medial form
+chr(0xAB) : [u'\u0635'],	#	ARABIC LETTER SAD, final-isolated form
+chr(0xAC) : [u'\u0635'],	#	ARABIC LETTER SAD, initial-medial form
+chr(0xAD) : [u'\u0636'],	#	ARABIC LETTER DAD, final-isolated form
+chr(0xAE) : [u'\u0636'],	#	ARABIC LETTER DAD, initial-medial form
+chr(0xAF) : [u'\u0637'],	#	ARABIC LETTER TAH, initial-medial form
+chr(0xB0) : [u'\u064E'],	#	ARABIC FATHA
+chr(0xB1) : [u'\u0650'],	#	ARABIC KASRA
+chr(0xB2) : [u'\u064F'],	#	ARABIC DAMMA
+chr(0xB3) : [u'\u064B'],	#	ARABIC FATHATAN
+chr(0xB4) : [u'\u0651'],	#	ARABIC SHADDA
+chr(0xB5) : [u'\u0023'],	# * #
+chr(0xB6) : [u'\u0024'],	# * $
+chr(0xB7) : [u'\u0025'],	# * %
+chr(0xB8) : [u'\u0026'],	# * &
+chr(0xB9) : [u'\u066C'],	# 	Arabic Thoushads Seperator
+chr(0xBA) : [u'\u0670'],	#	ARABIC LETTER SUPERSCRIPT ALEF
+chr(0xBB) : [u'\u0654'],	#	ARABIC HAMZA ABOVE
+chr(0xBC) : [u'\u066B'],	#	ARABIC DECIMAL SEPARATOR
+chr(0xBD) : [u'\u0029'],	# * RIGHT PARENTHESIS
+chr(0xBE) : [u'\u0028'],	# * LEFT PARENTHESIS
+chr(0xBF) : [u'\u0629'],	#	ARABIC LETTER TEH MARBUTAH
+chr(0xC0) : [u'\u00BB'],	#	RIGHT-POINTING DOUBLE ANGLE QUOTATION MARK
+chr(0xC1) : [u'\u0637'],	#	ARABIC LETTER TAH, final-isolated form
+chr(0xC2) : [u'\u0638'],	#	ARABIC LETTER ZAH, final-isolated form
+chr(0xC3) : [u'\u00AB'],	#	LEFT-POINTING DOUBLE ANGLE QUOTATION MARK
+chr(0xC4) : [u'\u0652'],	#	ARABIC SUKUN
+chr(0xC5) : [u'\u002D'],	# * -
+chr(0xC6) : [u'\u002E'],	# * FULL STOP
+chr(0xC7) : [u'\u002F'],	# * /
+chr(0xC8) : [u'\u002A'],	# * *
+chr(0xC9) : [u'\u007E'],	# * ~
+chr(0xCA) : [u'\u003A'],	# * COLON
+chr(0xCB) : [u'\u061B'],	# 	ARABIC SEMICOLON
+chr(0xCC) : [u'\u003E'],	# * GREATER-THAN SIGN
+chr(0xCD) : [u'\u002B'],	# * +
+chr(0xCE) : [u'\u003D'],	# * =
+chr(0xCF) : [u'\u003C'],	# * LESS-THAN SIGN
+# chr(0xD0) : [u'\u0040'],	# * @
+chr(0xD0) : [u''],	        # * @
+chr(0xD1) : [u'\u005D'],	# * [
+chr(0xD2) : [u'\u005C'],	# * \
+chr(0xD3) : [u'\u005B'],	# * ]
+chr(0xD4) : [u'\u005E'],	# * ^
+chr(0xD5) : [u'\u005F'],	# * _
+chr(0xD6) : [u'\u0060'],	# * `
+chr(0xD7) : [u'\u007D'],	# * {
+chr(0xD8) : [u'\u007C'],	# * |
+chr(0xDA) : [u'\u0020'],	# * SPACE
+chr(0xDD) : [u'\u0021'],	# * EXCLAMATION MARK
+chr(0xDE) : [u'\u007B'],	# * }
+chr(0xE0) : [u'\u0638'],	#	ARABIC LETTER ZAH, initial-medial form
+chr(0xE1) : [u'\u0639'],	#	ARABIC LETTER AIN, isolated form
+chr(0xE2) : [u'\u0639'],	#	ARABIC LETTER AIN, final form
+chr(0xE3) : [u'\u0639'],	#	ARABIC LETTER AIN, medial form
+chr(0xE4) : [u'\u0639'],	#	ARABIC LETTER AIN, initial form
+chr(0xE5) : [u'\u063A'],	#	ARABIC LETTER GHAIN, isolated form
+chr(0xE6) : [u'\u063A'],	#	ARABIC LETTER GHAIN, final form
+chr(0xE7) : [u'\u063A'],	#	ARABIC LETTER GHAIN, medial form
+chr(0xE8) : [u'\u063A'],	#	ARABIC LETTER GHAIN, initial form
+chr(0xE9) : [u'\u0641'],	#	ARABIC LETTER FEH, final-isolated form
+chr(0xEA) : [u'\u0641'],	#	ARABIC LETTER FEH, initial-medial form
+chr(0xEB) : [u'\u0642'],	#	ARABIC LETTER QAF, final-isolated form
+chr(0xEC) : [u'\u0642'],	#	ARABIC LETTER QAF, initial-medial form
+chr(0xED) : [u'\u06A9'],	#	ARABIC LETTER KEHEH, final-isolated form
+chr(0xEE) : [u'\u06A9'],	#	ARABIC LETTER KEHEH, initial-medial form
+chr(0xEF) : [u'\u06AF'],	#	ARABIC LETTER GAF, final-isolated form
+chr(0xF0) : [u'\u06AF'],	#	ARABIC LETTER GAF, initial-medial form
+chr(0xF1) : [u'\u0644'],	#	ARABIC LETTER LAM, final-isolated form
+chr(0xF2) : [u'\u0644\u0627'],	#	ARABIC LIGATURE LAM WITH ALEF
+chr(0xF3) : [u'\u0644'],	#	ARABIC LETTER LAM, initial-medial form
+chr(0xF4) : [u'\u0645'],	#	ARABIC LETTER MEEM, final-isolated form
+chr(0xF5) : [u'\u0645'],	#	ARABIC LETTER MEEM, initial-medial form
+chr(0xF6) : [u'\u0646'],	#	ARABIC LETTER NOON, final-isolated form
+chr(0xF7) : [u'\u0646'],	#	ARABIC LETTER NOON, initial-medial form
+chr(0xF8) : [u'\u0648'],	#	ARABIC LETTER WAW
+chr(0xF9) : [u'\u0647'],	#	ARABIC LETTER HEH, final-isolated form
+chr(0xFA) : [u'\u0647'],	#	ARABIC LETTER HEH, medial form
+chr(0xFB) : [u'\u0647'],	#	ARABIC LETTER HEH, initial form
+chr(0xFC) : [u'\u06CC'],	#	ARABIC LETTER FARSI YEH, final form
+chr(0xFD) : [u'\u06CC'],	#	ARABIC LETTER FARSI YEH, isolated form
+chr(0xFE) : [u'\u06CC']		#	ARABIC LETTER FARSI YEH, initial-medial form
+}
+
+F_PERCENT_SIGN = chr(0xB7)
+F_AT_SIGN = chr(0xD0)
+F_SLASH = chr(0xD2)
+F_SPACE = chr(0xDA)
+F_PRNT_OPEN = chr(0xDE)
+F_PRNT_CLOSE = chr(0xD7)
+
+# latex and farsitex commands whose first parameter does not need \lr{...}
+commands = [ 
+"begin", "end",
+"input", "include", "includeonly",
+"hspace", "vspace", "hspace*", "vspace*",
+"label", "ref", "cite", "bibitem",
+"bibliographystyle",
+"parbox",
+"newenvironment", "newtheorem",
+"persianmathdigitsfamily",
+"fontfamily", "fontseries", "fontshape",
+"rmdefault", "sfdefault", "ttdefault",
+"bfdefault", "itdefault", "sldefault", "scdefault",
+"pagenumbering", "pagestyle", "thispagestyle",
+"setcounter", "stepcounter", "setlength", "addtolength"
+]
+
+def ft_is_all_persian_space(next_part):
+	l = len(next_part)
+	i = 0
+	while (i < l):
+		if (next_part[i] != F_SPACE):
+			return 0
+		i += 1
+	return 1
+
+def ft_is_numeric(ch):
+	if ((ch in ft_numerical) or 
+	    ((ch >= chr(0x80)) and (ch <= chr(0x89))) ):
+		return 1
+	return 0
+
+def ft_can_join_left(ch):
+	if ((ch in ft_bidi_joiners_initial) or
+	    (ch in ft_bidi_joiners_medial) or
+	    (ch in ft_bidi_joiners_final) or
+	    (ch in ft_bidi_joiners_isolated) or
+	    (ch in ft_bidi_joiners_initial_medial) or
+	    (ch in ft_bidi_joiners_final_isolated)):
+    		return 1
+	return 0
+
+def ft_can_join_right(ch):
+	if (ft_can_join_left(ch) or 
+	    (ch in ft_right_joiners_final) or
+	    (ch in ft_right_joiners_isolated) or
+	    (ch in ft_right_joiners_final_isolated)):
+		return 1
+	return 0
+
+def ft_joining_left(ch):
+	if ((ch in ft_bidi_joiners_initial) or 
+	    (ch in ft_bidi_joiners_medial) or
+	    (ch in ft_bidi_joiners_initial_medial)):
+		return 1
+	return 0
+
+
+def ft_joining_right(ch):
+	if ((ch in ft_right_joiners_final) or
+	    (ch in ft_bidi_joiners_medial) or 
+	    (ch in ft_bidi_joiners_final)):
+		return 1
+	return 0
+
+def ft_not_right_joined(ch):
+	if ((ch in ft_bidi_joiners_initial) or
+	    (ch in ft_right_joiners_isolated) or
+	    (ch in ft_bidi_joiners_isolated)):
+		return 1
+	return 0
+
+def ft_adjust_shaping(text, i):
+	current = text[i]
+	u = u''
+	try:
+		u = table_FT_UN[current][0]
+	except KeyError:
+		return u''
+
+	#if you don't want shaping remove the following comment
+	#return u
+
+	if ((current in ft_vowels) or (ft_is_numeric(current))):
+		return u
+
+	#find next non-vowel character on the left
+	text_len = len(text)
+	next_index = i+1
+	while ((next_index < text_len) and (text[next_index] in ft_vowels)):
+		next_index += 1
+
+	if (next_index == text_len):
+		next = ''
+	else:
+		next = text[next_index]
+
+	# if current letter is joining from left but next letter is or can not joining
+	if (ft_joining_left(current)):
+		if (not ft_can_join_right(next)):
+			u += u'\u200D' #ZWJ
+		elif (ft_not_right_joined(next)):
+			u += u'\u200D\u200C' #ZWJ+ZWNJ
+	# if current letter can join but next letter is joining from right
+	elif (ft_can_join_left(current)):
+		if (ft_joining_right(next)):
+			u += u'\u200C\u200D' #ZWNJ+ZWJ
+		elif (ft_can_join_right(next)):
+			u += u'\u200C' #ZWNJ
+	return u
+
+def ft_adjust_number(text):
+	result = u''
+	i = len(text)-1
+	while (i >= 0):
+		result += ft_adjust_shaping(text, i)
+		i -= 1
+	return result
+
+
+def map_ft_unicode(text):
+	mapped_text = u''
+
+	i = 0
+	while (i < len(text)):
+		if (ft_is_numeric(text[i])):
+			next_index = i
+			while ((next_index+1 < len(text)) and
+			       (ft_is_numeric(text[next_index+1]))):
+				next_index += 1
+			mapped_text += ft_adjust_number(text[i:next_index+1])
+			i = next_index+1
+			continue
+
+		mapped_text += ft_adjust_shaping(text, i)
+		i += 1
+	return mapped_text
+
+# Finds next token all of the same language
+def ft_next_part(line, i, line_len):
+	global global_state
+	global recursive
+	global filenames
+	
+	j = i
+	language_flag = (line[j]<chr(0x80))
+	while ((j<line_len) and ((line[j]<chr(0x80)) == language_flag) ):
+		if ( (global_state == 0) and ( (line[j] == '%') or (line[j] == F_PERCENT_SIGN) ) and (line[j-1] != '\\') and (line[j-1] != F_SLASH) ):
+			global_state = 1
+		elif ((global_state == 0) and ((line[j:j+16] == '\\begin{verbatim}') or (line[j:j+17] == '\\begin{verbatim*}'))):
+			global_state = 2
+		elif ((global_state == 2) and ((line[j:j+14] == '\\end{verbatim}') or (line[j:j+15] == '\\end{verbatim*}'))):
+			global_state = 0
+		elif ((global_state == 0) and (line[j:j+6] == '\\verb*')):
+			next_index = line.find(line[j+6], j+7)
+			j = next_index
+		elif ((global_state == 0) and (line[j:j+5] == '\\verb')):
+			next_index = line.find(line[j+5], j+6)
+			j = next_index
+		elif (recursive == 1):
+			if ((global_state == 0) and (line[j:j+9] == '\\include{')):
+				next_index = line.find('}', j+9)
+				filename = line[j+10:next_index-1] + '.ftx'
+				if (os.path.exists(filename) and not filename in filenames):
+					filenames.append(filename)
+			elif ((global_state == 0) and (line[j:j+7] == '\\input{')):
+				next_index = line.find('}', j+7)
+				filename = line[j+8:next_index-1] + '.ftx'
+				if (os.path.exists(filename) and not filename in filenames):
+					filenames.append(filename)
+			elif ((global_state == 0) and (line[j:j+9] == F_SLASH + 'include' + F_PRNT_OPEN)):
+				next_index = line.find(F_PRNT_CLOSE, j+9)
+				if (line[j+9]!=F_AT_SIGN):
+					filename = line[j+9:next_index] + '.ftx'
+				else:
+					filename = line[j+10:next_index-1] + '.ftx'
+				if (os.path.exists(filename) and not filename in filenames):
+					filenames.append(filename)
+			elif ((global_state == 0) and (line[j:j+7] == F_SLASH + 'input' + F_PRNT_OPEN)):
+				next_index = line.find(F_PRNT_CLOSE, j+7)
+				if (line[j+7]!=F_AT_SIGN):
+					filename = line[j+7:next_index] + '.ftx'
+				else:
+					filename = line[j+8:next_index-1] + '.ftx'
+				if (os.path.exists(filename) and not filename in filenames):
+					filenames.append(filename)
+		j += 1
+	return j
+
+###############################################
+# from here all functions are used to translate
+# farsitex commands to xepersian commands
+###############################################
+
+def read_size(input,index,last_index):
+	dim_index = -1 
+	inch_index = input.find(u'in', index)
+	if (inch_index != -1):
+		dim_index = inch_index
+	mm_index = input.find(u'mm', index)
+	if (mm_index != -1):
+		if (dim_index == -1 or mm_index < index):
+			dim_index = mm_index
+	cm_index = input.find(u'cm', index)
+	if (cm_index != -1):
+		if (dim_index == -1 or cm_index < dim_index):
+			dim_index = cm_index
+	pt_index = input.find(u'pt', index)
+	if (pt_index != -1):
+		if (dim_index == -1 or pt_index < dim_index):
+			dim_index = pt_index
+	next_cmd = input.find(u'\\', index)
+	if (next_cmd == -1 and dim_index == -1):
+		print "Error in parsing \epsfxsize command at " + str(line_number) + "\n"
+		return -1
+	elif (next_cmd == -1 or (dim_index != -1 and next_cmd > dim_index)):
+		epsfxsize = input[index:dim_index+2]
+		return dim_index+2
+	elif (next_cmd != -1):
+		end_cmd = next_cmd+1
+		while (end_cmd < last_index and input[end_cmd].isalpha()):
+			end_cmd += 1
+		return end_cmd
+	else:
+		print "Error in parsing \epsfxsize command at " + str(line_number) + "\n"
+		return -1
+
+
+latex_options=[u'a4paper', u'a5paper', u'b5paper', 
+			   u'letterpaper', u'legalpaper', u'executivepaper', 
+			   u'landscape', u'10pt', u'11pt', u'12pt', 
+			   u'oneside', u'twoside', u'draft', 
+			   u'final', u'titlepage', u'notitlepage',
+			   u'onecolumn', u'twocolumn',
+			   u'leqno', u'fleqn']
+
+table_eq_packages = {
+u'poem'     : u'persianpoem',
+u'fmakeidx' : u'makeidx',
+u'ffancyhe' : u'fancyhdr',
+u'fmultico' : u'multicol'
+}
+
+farsitex_ignore_options = [u'persian', u'farsi', u'epsf', u'fgraphix', u'lotusfont']
+
+xepersian_packages = u'\n\\usepackage{url}\n%\\usepackage{fancyvrb}\n\\usepackage{setspace}\\doublespacing\n\\usepackage{graphicx} \n\\usepackage{amssymb}\n'
+xepersian_preamble = u'\\settextfont[Scale=1.2]{XB Zar}\n\\setlatintextfont[Scale=1.1]{Times New Roman}\n\\setdigitfont{XB Zar} \n\\SepMark{-}\n\\def\\nazok{\\normalfont\\normalsize} \n\\let\\iranic\\it\n\\let\\siah\\bf\n\\let\\khabide\\sl\n\\def\\siahir{\\siah\\iranic}\n\\def\\siahkh{\\siah\\khabide}\n\\setpookfont{XB Kayhan Pook} \n\\let\\tookhali\\pookfamily\n\\setsayehfont{XB Kayhan Sayeh}\\let\\sayedar\\sayehfamily\n\\let\\farsi\\Persian\n\\let\\english\\Latin \n\\let\\farmbox\\mbox\n\\newcommand{\\ftxepmatrix}[1]{\\begin{pmatrix}#1\\end{pmatrix}}\n\\def\\FarsiTeX{\\lr{FarsiTeX}}\n\\def\\?????????????????{\\rl{????????????????????}}\n'
+thesis_preamble = u'\\university{\\lr{UniversityName}}\n\\city{\\lr{CityName}}\n\\latinuniversity{UniversityName}\n\\latincity{CityName} \n\\let\\englishtitle\\latintitle\n\\let\\englishauthor\\latinauthor\n\\let\\englishdegree\\latindegree\n\\let\\englishthesisdate\\latinthesisdate \n\\let\\englishsupervisor\\latinsupervisor\n\\let\\englishdepartment\\latindepartment\n\\let\\makeenglishtitle\\makelatintitle \n\\let\\englishkeywords\\latinkeywords\n\\newenvironment{englishabstract}{\\begin{latinabstract}}{\\end{latinabstract}}\n'
+
+def is_alpha_numeric_space(input):
+	input_len = len(input)
+	i = 0
+	while (i<input_len):
+		if (not (input[i].isalpha() or input[i].isdigit() or input[i]==u'.' or input[i]==u' ') ):
+			return 0
+		i+=1
+	return 1
+
+def is_alpha_numeric(input):
+	input_len = len(input)
+	i = 0
+	while (i<input_len):
+		if (not (input[i].isalpha() or input[i].isdigit() or input[i]=='.') ):
+			return 0
+		i+=1
+	return 1
+			
+def find_eq_cmd(keyword):
+	try:
+		eq_cmd = table_eq_packages[keyword]
+	except KeyError:
+		eq_cmd = u''
+	return eq_cmd
+
+def convert_persian_to_english(num):
+	result = u''
+	num_len = len(num)
+	index = 0
+	while (index < num_len):
+		if (ord(num[index]) >= ord(u'??') and ord(num[index]) <= ord(u'??')):
+			result += unichr(ord(num[index]) - ord(u'??') + ord(u'0'))
+		else:
+			result += num[index]
+		index += 1
+	return result
+
+def generate_farsitex_cmds_file(helper_filename,preamble):
+	try:
+		of = codecs.open(helper_filename, encoding='utf-8', mode='w')
+	except IOError:
+		print "Can not open the output file: " + helper_filename
+		exit(0)
+	of.write(preamble)
+	of.close
+
+
+# \verb|| -> \item[\verb||] or \section{\verb||}
+# \kasre{} \alef{} ...
+def translate_cmds(output_line):
+	global last_epsfxsize
+	global last_epsfxsize_line
+	global last_epsfysize
+	global last_epsfysize_line
+	global state
+	global filename
+
+	result = u''
+	line_len = len(output_line)
+	index = 0
+	if (state == 1): #\begin{verbatim}
+		end_verbatim = output_line.find('\\end{verbatim}')
+		if (end_verbatim == -1):
+			return output_line
+		result += output_line[0:end_verbatim+14]
+		index = end_verbatim+14
+		state = 0
+	elif (state == 2): #\begin{verbatim*}
+		end_verbatim = output_line.find('\\end{verbatim*}')
+		if (end_verbatim == -1):
+			return output_line
+		result += output_line[0:end_verbatim+15]
+		index = end_verbatim+15
+		state = 0
+	elif (output_line[0:14] == "\\documentstyle"):
+		result += u'\\documentclass'
+		#process options
+		last_index = output_line.find(u']')
+		index = 15
+		first_option = 1
+		preamble = xepersian_preamble
+		packages = xepersian_packages
+		xe_document_class = u''
+		while (index < last_index):
+			next_comma = output_line.find(u',',index,last_index)
+			if (next_comma == -1):
+				next_comma = last_index
+			first_of_option = index
+			while (output_line[first_of_option] == u' '):
+				first_of_option += 1
+			end_of_option = next_comma
+			while (output_line[end_of_option-1] == u' '):
+				end_of_option -= 1
+			option = output_line[first_of_option:end_of_option]
+			index = next_comma+1
+			eq_cmd = find_eq_cmd(option)
+			if (eq_cmd != u''):
+				packages += u'\\usepackage{' + eq_cmd + u'}\n'
+				continue
+			elif (option in farsitex_ignore_options):
+				continue
+			elif (option == u'sharifth'):
+				xe_document_class = u'xepersian-thesis'
+				preamble += thesis_preamble
+				continue
+			elif (not option in latex_options):
+				packages += u'\\usepackage{' + option + u'}\n'
+				continue
+	
+			if (first_option):
+				result += u'['
+			else:
+				result += u','
+			result += option
+			first_option = 0
+		#end while
+		if (not first_option):
+			result += u']'
+		# process document style into document class
+		index = output_line.find(u'}',last_index)
+		document_class = output_line[last_index+2:index]
+		if (xe_document_class != u''):
+			result += u'{' + xe_document_class + u'}'
+		elif (document_class == u'oldarticle'):
+			result += u'{article}'
+		elif (document_class == u'oldbook'):
+			result += u'{book}'
+		elif (document_class == u'oldreport'):
+			result += u'{report}'
+		else:
+			result += u'{' + document_class + u'}'
+		# I assume that nothing important is after
+		# \documentstyle[...]{...}, otherwise it may conflict
+		# with our preamble
+		if (index != -1):
+			result += output_line[index+1:]
+		result += packages + u'\\usepackage{xepersian}\n'
+		helper_filename = filename + '_farsitex_cmds_xepersian.tex'
+		generate_farsitex_cmds_file(helper_filename,preamble)
+		result += '\\input{' + helper_filename + '}\n'
+		return result
+	#end elif "documentstyle"
+
+	while (index < line_len):
+		next_index = output_line.find(u'\\', index)
+		comment_index = output_line.find(u'%', index)
+		if (next_index == -1):
+			result += output_line[index:]
+			break
+		elif (state == 1):
+			if (output_line[next_index:next_index+14] == u'\\end{verbatim}'):
+				result += output_line[index:next_index+14]
+				index = next_index+14
+				state = 0
+			else:
+				result += output_line[index:next_index+1]
+				index = next_index+1
+		elif (state == 2):
+			if (output_line[next_index:next_index+15] == u'\\end{verbatim*}'):
+				result += output_line[index:next_index+15]
+				index = next_index+15
+				state = 0
+			else:
+				result += output_line[index:next_index+1]
+				index = next_index+1
+		elif (comment_index != -1 and comment_index < next_index):
+			result += output_line[index:]
+			break
+		elif (output_line[next_index:next_index+14] == u"\\input{amssym}"):
+			result += u'\\usepackage{amssymb}'
+			index = next_index+14
+		elif (output_line[next_index:next_index+12] == u"\\input{epsf}"):
+			index = next_index+12
+		elif (output_line[next_index:next_index+15] == u"\\includeepspdf{"):
+			result += u'\\includegraphics{'
+			index = next_index+15
+		elif (output_line[next_index:next_index+16] == u"\\begin{verbatim}"):
+			result += output_line[index:next_index+16]
+			index = next_index+16
+			state = 1
+		elif (output_line[next_index:next_index+17] == u"\\begin{verbatim*}"):
+			result += output_line[index:next_index+17]
+			index = next_index+17
+			state = 2
+		elif (output_line[next_index:next_index+26] == u'\\setlength{\\headrulewidth}'):
+			end_cmd = output_line.find('}', next_index+26)
+			result += u'\\renewcommand{\\headrulewidth}' + output_line[next_index+26:end_cmd+1]
+			index = end_cmd+1
+		elif (output_line[next_index:next_index+26] == u'\\setlength{\\footrulewidth}'):
+			end_cmd = output_line.find('}', next_index+26)
+			result += u'\\renewcommand{\\footrulewidth}' + output_line[next_index+26:end_cmd+1]
+			index = end_cmd+1
+		elif (output_line[next_index:next_index+10] == u"\\epsffile{"):
+			result += output_line[index:next_index]
+			result += u'\\includegraphics'
+			size_options = u''
+			if (line_number - last_epsfxsize_line <= 3):
+				size_options = u'width=' + last_epsfxsize
+			if (line_number - last_epsfysize_line <= 3):
+				if (size_options != u''):
+					size_options += u','
+				size_options += u'height=' + last_epsfysize
+			if (size_options != u''):
+				result += u'[' + size_options + u']'
+			end_prn = output_line.find(u'.eps}', next_index+9)
+
+			if (end_prn != -1):
+				result += output_line[next_index+9:end_prn] + u'}'
+				index = end_prn+5
+			else:
+				end_prn = output_line.find(u'.ps}', next_index+9)
+				if (end_prn != -1):
+					result += output_line[next_index+9:end_prn] + u'}'
+					index = end_prn+4
+				else:
+					end_prn = output_line.find(u'}', next_index+9)
+					result += output_line[next_index+9:end_prn+1]
+					index = end_prn+1
+		# I assume all the parameter of \epsfxsize comes in one line
+		elif (output_line[next_index:next_index+11] == u"\\epsfxsize="):
+			end_size = read_size(output_line, next_index+11, line_len)
+			if (end_size != -1):
+				last_epsfxsize = output_line[next_index+11:end_size]
+				index = end_size
+			else:
+				index = next_index+11
+			last_epsfxsize_line = line_number
+		# I assume all the parameter of \epsfysize comes in one line
+		elif (output_line[next_index:next_index+11] == u"\\epsfysize="):
+			end_size = read_size(output_line, next_index+11, line_len)
+			if (end_size != -1):
+				last_epsfysize = output_line[next_index+11:end_size]
+				index = end_size
+			else:
+				index = next_index+11
+			last_epsfysize_line = line_number
+		elif (output_line[next_index:next_index+10] == u"\\LR{\\verb*"):
+			end_verb = output_line.find(output_line[next_index+10], next_index+11)
+			verb_param = output_line[next_index+11:end_verb]
+			if (is_alpha_numeric(verb_param)):
+				result += output_line[index:next_index]
+				result += u'\\lr{\\tt{}' + verb_param
+			else:
+				result += output_line[index:end_verb+1]
+			index = end_verb+1
+		elif (output_line[next_index:next_index+9] == u"\\LR{\\verb"):
+			end_verb = output_line.find(output_line[next_index+9], next_index+10)
+			verb_param = output_line[next_index+10:end_verb]
+			if (is_alpha_numeric_space(verb_param)):
+				result += output_line[index:next_index]
+				result += u'\\lr{\\tt{}' + verb_param
+			else:
+				result += output_line[index:end_verb+1]
+			index = end_verb+1
+		elif (output_line[next_index:next_index+6] == u"\\verb*"):
+			end_verb = output_line.find(output_line[next_index+6], next_index+7)
+			result += output_line[index:end_verb+1]
+			index = end_verb+1
+		elif (output_line[next_index:next_index+5] == u"\\verb"):
+			end_verb = output_line.find(output_line[next_index+5], next_index+6)
+			result += output_line[index:end_verb+1]
+			index = end_verb+1
+		elif (output_line[next_index:next_index+9] == u"\\pmatrix{"):
+			result += u'\\ftxepmatrix{'
+			index = next_index+9
+		elif (output_line[next_index:next_index+16] == u"\\begin{document}"):
+			result += u'\\begin{document}\n%\\VerbatimFootnotes'
+			index = next_index+16
+		elif (output_line[next_index:next_index+8] == u'\\label {'):
+			begin_param = next_index+8
+			end_param = output_line.find(u'}', begin_param)
+			param = convert_persian_to_english(output_line[begin_param:end_param])
+			result += output_line[index:begin_param-2]
+			result += u'{' + param + u'}'
+			index = end_param+1
+		elif (output_line[next_index:next_index+6] == u'\\ref {'):
+			begin_param = next_index+6
+			end_param = output_line.find(u'}', begin_param)
+			param = convert_persian_to_english(output_line[begin_param:end_param])
+			result += output_line[index:begin_param-2]
+			result += u'{' + param + u'}'
+			index = end_param+1
+		elif (output_line[next_index:next_index+7] == u'\\label{'):
+			begin_param = next_index+7
+			end_param = output_line.find(u'}', begin_param)
+			param = convert_persian_to_english(output_line[begin_param:end_param])
+			result += output_line[index:begin_param]
+			result += param + u'}'
+			index = end_param+1
+		elif (output_line[next_index:next_index+5] == u'\\ref{'):
+			begin_param = next_index+5
+			end_param = output_line.find(u'}', begin_param)
+			param = convert_persian_to_english(output_line[begin_param:end_param])
+			result += output_line[index:begin_param]
+			result += param + u'}'
+			index = end_param+1
+		elif (output_line[next_index:next_index+13] == u'\\multicolumn{'):
+			begin_param = next_index+13
+			end_param = output_line.find(u'}', begin_param)
+			param = convert_persian_to_english(output_line[begin_param:end_param])
+			result += output_line[index:begin_param]
+			result += param + u'}'
+			index = end_param+1
+		elif (output_line[next_index:next_index+12] == u'\\setcounter{'):
+			begin_num = output_line.find(u'{', next_index+12)
+			end_num = output_line.find(u'}', begin_num)
+			num = convert_persian_to_english(output_line[begin_num+1:end_num])
+			result += output_line[index:begin_num+1]
+			result += num + u'}'
+			index = end_num+1
+		elif (output_line[next_index:next_index+14] == u'\\addtocounter{'):
+			begin_num = output_line.find(u'{', next_index+14)
+			end_num = output_line.find(u'}', begin_num)
+			num = convert_persian_to_english(output_line[begin_num+1:end_num])
+			result += output_line[index:begin_num+1]
+			result += num + u'}'
+			index = end_num+1
+		else:
+			result += output_line[index:next_index+2]
+			index = next_index+2
+	#end while
+	return result
+
+###############################################
+# from here all functions are mainly used to
+# convert farsitex format to unicode
+###############################################
+
+def convert_file(f, of, convert_cmds):
+	global state
+	global line_number
+	global last_epsfysize_line
+	global last_epsfxsize_line
+	global last_epsfxsize
+	global last_epsfysize
+	global global_state
+
+	state = 0
+	line_number = 0
+	last_epsfysize_line = 0
+	last_epsfxsize_line = 0
+	last_epsfxsize = u''
+	last_epsfysize = u''
+
+	for line in f:
+		line_number += 1
+		print line_number,
+		output_line = u''
+		line_len = len(line)
+		
+		# remove new-line characters from end of line
+		if (line_len>1 and line[line_len-1] == '\n'):
+			line_len-=1
+		if (line_len>1 and line[line_len-1] == '\r'):
+			line_len-=1
+		
+		# check line-direction character
+		line_direction_rtl = (line[0] == '<')
+		if (line[0] != '>') and (line[0] != '<'):
+			print "FORMAT ERROR AT LINE: " + str(line_number)
+			exit(0)
+	
+		i = 1
+	
+		while (i<line_len):
+			next_part_index = ft_next_part(line, i, line_len)
+			next_part = line[i:next_part_index]
+			next_part_latin = (line[i]<chr(0x80))
+			
+			# see if we should put \lr{...} for the current english expression
+			if (global_state == 0):
+				if line_direction_rtl and next_part_latin:
+					is_command_rtl = (next_part_latin and (i>1) and (line[i-1]==F_SLASH) )
+					is_parameter_rtl = (next_part_latin and (i>1) and (next_part_index<line_len) and (line[i-1]==F_AT_SIGN) and (line[next_part_index]==F_AT_SIGN) )
+					is_math_rtl = (next_part_latin and (line[i]=="$") and (line[next_part_index-1]=="$") )
+					is_verb_parameter = ( (line[i-6:i] == F_SLASH+"verb") and not isalpha(line[i]))
+					is_verb = (next_part_latin and (line[i:i+5]=='\\verb' or line[i:i+6]==' \\verb'))
+					is_english = (next_part_latin and (line[i:i+8]=='\\english'))
+				
+					cmd_index = 0
+					while cmd_index < len(commands):
+						len_cmd = len(commands[cmd_index])+2
+						if ( (i > len_cmd) and (line[i-len_cmd:i] == F_SLASH+commands[cmd_index]+F_PRNT_OPEN) ):
+							break
+						elif ( (i > len_cmd+1) and (line[i-len_cmd-1:i] == F_SLASH+commands[cmd_index]+F_SPACE+F_PRNT_OPEN) ):
+							break
+						cmd_index += 1
+					is_commands_group = cmd_index < len(commands)
+					is_documentstyle_cmd = (line_len > 15) and (line[1:15] == F_SLASH+"documentstyle")
+	
+			if next_part_latin:
+				if (global_state == 0):
+					# whether we should put a \lr{ command
+					if ( line_direction_rtl and not (is_command_rtl or is_parameter_rtl or is_math_rtl or is_commands_group or is_documentstyle_cmd or is_verb_parameter or is_verb or is_english) ):
+						output_line += u'\\lr{'
+					if ( line_direction_rtl and is_verb):
+						output_line += u'\\LR{'
+				
+				# here is the main place that converting happens
+				output_line += next_part.encode( 'utf-8' )
+				
+				if (global_state == 0):
+					# check whether we already used a \lr command: then end it
+					if ( line_direction_rtl and not (is_command_rtl or is_parameter_rtl or is_math_rtl or is_commands_group or is_documentstyle_cmd or is_verb_parameter or is_verb or is_english) ):
+						output_line += u'}'
+					if ( line_direction_rtl and is_verb):
+						output_line += u'}'
+			else:
+				if (global_state == 0):
+					# whether we should put a \rl{} command
+					if ( not line_direction_rtl and not ft_is_all_persian_space(next_part)):
+						output_line += u'\\rl{'
+					
+				# here is the main place that converting happens
+				output_line += map_ft_unicode(next_part)
+				
+				if (global_state == 0):
+					# check whether we already used a \rl command: then end it
+					if (not line_direction_rtl and not ft_is_all_persian_space(next_part)):
+						output_line += u'}'
+					
+			i = next_part_index
+		# end of while			
+
+		#if there was a % commenting then we can return to normal situation
+		if (global_state == 1):
+			global_state = 0
+		
+		# convert some of the FarsiTeX commands to XePersian commands
+		# only if it is requested
+		if (convert_cmds):
+			result = translate_cmds(output_line) 
+		else:
+			result = output_line
+		output_line = result + u'\n'
+		# write the processed line
+		of.write(output_line)
+		# end of line processing
+	# end of file processing
+
+def print_usage():
+	print 'usage: python ftxe-0.9 [-r] [-s] [-x] [-u] in_filename1 in_filename2'
+	print '-r: (DEFAULT) recursively consider files included in the given files'
+	print '-s: do not recursively consider files'
+	print '-x: (DEFAULT) insert xepersian related commands'
+	print '-u: only convert to unicode'
+
+###################################
+# Begin of main body of the program
+###################################
+
+# global variables
+line_number = 0
+last_epsfxsize = u''
+last_epsfxsize_line = 0
+last_epsfysize = u''
+last_epsfysize_line = 0
+state = 0
+global_state = 0
+recursive = 1
+convert_xepersian = 1
+filename = ''
+
+if len(sys.argv) <= 1:
+	print_usage()
+	exit(0)
+
+#find options
+options_index = 1
+while (options_index < len(sys.argv) and sys.argv[options_index][0]=='-'):
+	if (sys.argv[options_index]=='-s'):
+		recursive = 0
+	elif (sys.argv[options_index]=='-u'):
+		convert_xepersian = 0
+	options_index += 1
+
+filenames = []
+while (options_index < len(sys.argv)):
+	filenames.append(sys.argv[options_index])
+	options_index += 1
+
+if (len(filenames) == 0):
+	print 'error: no input filename is specified!'
+	print_usage()
+	exit(0)
+	
+index = 0
+while (index < len(filenames)):
+	filename = filenames[index]
+	index += 1
+
+	outfile = ''
+	if (filename[-4:] != '.tex'):
+		outfile = filename[0:-3] + 'tex'
+	else: 
+		outfile = filename + '.tex'
+
+	print '\n\nConverting "' + filename + '" into "' + outfile + '"'
+	try:
+		f = open(filename, 'r')
+	except IOError:
+		print "Can not open the input file: " + filename
+		exit(0)
+
+	try:
+		of = codecs.open(outfile, encoding='utf-8', mode='w')
+	except IOError:
+		print "Can not open the output file: " + outfile
+		exit(0)
+
+	convert_file(f, of, convert_xepersian)
+
+	of.close()
+	f.close()	

Added: tags/texmf/doc/xepersian/xepersian.pdf
===================================================================
--- tags/texmf/doc/xepersian/xepersian.pdf	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/doc/xepersian/xepersian.pdf	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,267 @@
+%PDF-1.4
+%????
+8 0 obj
+<<
+/Filter/FlateDecode
+/Length 258
+>>
+stream
+x?m?MK?0????9?`????""??^V"????m?Uq?
+?{c??C	!!y?7??w ?? p?
+6??xpgN??!???;??BE?FK????????"?g?R????M????m???!?fv????:l?C??S?bU?NA????R??PV,uq??q??!??K"1*???QI<????a????v?on???G?Ab?8V????g???c?Nr	v!??4??xA???u-??X?j??vm?$?t??????l
+endstream
+endobj
+9 0 obj
+<<
+/Font<<
+/F2 4 0 R
+/F4 5 0 R
+/F5 6 0 R
+/F3 7 0 R
+>>
+/ProcSet[/PDF/Text/ImageC/ImageB/ImageI]
+>>
+endobj
+3 0 obj
+<<
+/Resources 9 0 R
+/Type/Page
+/Parent 10 0 R
+/Contents[8 0 R]
+>>
+endobj
+10 0 obj
+<<
+/Type/Pages
+/Count 1
+/Kids[3 0 R]
+/MediaBox[0 0 595.27 841.82]
+>>
+endobj
+2 0 obj
+<<
+/Creator( XeTeX output 2009.07.06:2319)
+/Producer(xdvipdfmx \(0.7.3\))
+/CreationDate(D:20090706232003+10'00')
+>>
+endobj
+1 0 obj
+<<
+/Pages 10 0 R
+/Type/Catalog
+>>
+endobj
+11 0 obj
+[250 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 333 726 0 0 0 0 604
+0 0 0 613 0 722 0 0 0 0 0 0 0 0 0 0 500 0 444 0 479 333 556 582 291 0 556 291 0 0
+0 0 0 0 0 0 603 0 0 0 556]
+endobj
+12 0 obj
+<<
+/Subtype/Type1C
+/Filter/FlateDecode
+/Length 2373
+>>
+stream
+x??UP???o7QI????&?v?6?H??$?)?QQ?'xj
+?D?_?y#p?	G???3??2t???J?EE[]??H????0g^??????p??w?v???j[?A:??5N?@????<{!????\^f?D?????RQC??????????#???r???????P????(???p?F????RGI????DP??=???q0p???I6?b(?b?F'e&?????D?(?b?BBL??L?Vm ??W?G??g??????[]??Z/\e??/$?h?0zy?0G??????3)?z??G?B?+?Q??????P???m??????8??W???????(W?B%????+?F\?U
+???Z??~?B????at0????|??e?UB)????R1q?@?????????@ss??A??=S[?F;q??z_???|??}&Tu?????n??$???;?y??I??zR?"w???????	dO?o??Tc?80???l???E???eSDSr?s??]?l?6W??B????$N?&w????G?;?[???n&??5!(&d=O??
+?????9???[a??????k??????(???	x?????0]???+?*1x?5Ds??O??pzW??!??]?(?z~P&?_V?7&r???$@J??????@?+z2??t]jr?8?C3??U??!????<?_???<I?)??????w`??'?{?:}?zj#*Q?????????rw?z:GO???A?)o7w?5]?)|????oF|=-F?????=?r??????x??W??)5?NZ@^r??C$$??uu?7???N?tt???!??.???
+??yqjn0
+??V???S????8oo????????
+?????L???J?U?-?ie?5?i?<???W???5??????5S?@!?v?4{v???????;??_??E|9-W?K?7??J?=Z
+endstream
+endobj
+13 0 obj
+[500 500 500 0 0 0 500 0 0 500]
+endobj
+14 0 obj
+<<
+/Subtype/Type1C
+/Filter/FlateDecode
+/Length 1021
+>>
+stream
+x?URkLW?a)???E??RYn*??A??6Kx4 ?4m??{w?qvf??????6/?m+??"?	??i?Z-??O??T?&m-?4?44i??]???;??sr????}??{x.9??y~S????Zo?~X?%I ?r??mB?t7=?_r??x?Kl??I	?%?H???$#??h??GY?rXH?o???8?K???~i?+??[Qc
+5 ?WS?????R?QTTcPu??V?4CIQ?P6??
+g~~A?w?Q
+?i???^??AI??=*?????}>PA??'?(!??D~(?0H????d E?]?%?@W??K0???	?ja??,H!M?
+8r?VaRB,???.?i?/e???N7>?z???<}D<wz???)???T???u??^?5?Z???????I??%Qp???=??R??x??K?a?i?E?o!v???"?L??O8????WZ??k=r?T??I?/[?.z?~s?"??????WgHF??9?704?????4????????o?Ec#??8|????SD?$?J^??H?iZ?6?A???u????N????tL??_YO+?GRzo??3<??:??f}????y???M_??\?2?@??~?Lq???m???jb?????z{{?{l???????;?_	???
+endstream
+endobj
+15 0 obj
+[600 0 0 0 0 0 0 0 625 0 0 0 0 0 0 0 0 451 0 0 0 418 0 0 0 223 0 0 0 0 484 0 0 0
+320 360]
+endobj
+16 0 obj
+<<
+/Subtype/Type1C
+/Filter/FlateDecode
+/Length 845
+>>
+stream
+x?%PL[e???_?feSy3???Y?4? ?????#E A????9Z(??M?6? ??]A]?\:?4DL??%????EK???&.?????|??????s?=???PJ?J+?eU??%??????????Ru??J:?a????]+?M???)??.???S???n??DO?~??e????!??	???Y?5//W.?)??U/???5????:????(?????N.K)?2?Q	S??????5*??_??	??R?"q?xH=	PB?$??H!)&NRN*??P"hD3???????;??	??t???I?????7ux/?h??
+H???o??x/1????l{??f??#F????zW6_?xWD<?s?'???#?#?mFl?s?kU0?f??8?n>i??	ili?u
+7??t?????N5???\t?*?Z+j???q????3????%???j{?<?^???/u?\xr???0??B???????$?*??/,0?9?E?0-???!-*??????7t?F??0??C?75e=??my2????/e??2
+???A?j??8??Q?:P]??~{??lL??F??n?n????@?????#p?M$t???)??.??V?`??H^???}[???$:???8*?O?s??
+endstream
+endobj
+17 0 obj
+[531 0 0 0 0 0 0 0 0 0 0 0 0 0 531 0 531 0 531 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0
+0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 531 531 0 531 531 531 0 0 531 0 0 531 0 0 531 0 0 531
+531 0 531 531]
+endobj
+18 0 obj
+<<
+/Subtype/Type1C
+/Filter/FlateDecode
+/Length 1524
+>>
+stream
+x?mT{PTe???r?
+???Q3?]'S?????M???????%??
+,K???<dA?8%??B?+???b?`e???M:???^f5???s??????@S????}??~??????h?0#^H^?l?sS?	II?s??D~??#U????h*h?????!????"?d ~('*???0?0???????>So?)?l?h??????=??Ssu?&?eSjJ?.!?j4?R?J??[iN?d?L??fe?V*ru+?????Fo6??Y]?9?`?&?	?N??h???0i?M$?????cI"?H&??DO??"O???HV?$???!*??????e1??????r?>?m?$???1!E!~-?x?q???????fL5gS;????::?q?l??|$?V??x??N\\W???q????B)T?VRN????e???`3?\??mxM9?]V]??tT:?????,??dWi7T^???s???.?5?&??-??
+????Z?
+?=	?(?9r??????Z? ?[k?j-??_4??!??????!?_
+R???pE??????c0?w{????<5?ji??D|#??j????&n{?=o????LX?^??|???c?????/q???0Lbp??P????6?u.i??l?Qg?P????	8????s?0z^?41yjhQ???6h??Ql?I?|?[?fv?O?0)??bp\F??6??S?4????L??&?7???z}M??? Z???'?0v0?`o~?5V`?\???
+??????TE??K#???????Q?????s??etf??Q;?g?Qn?$E???S?E??]?h:???.}?M_??K}?f?LxV/>x?Q~??F.???v??P??V?\???????3?X??b?|?Zd???1Cd??????,a????d?
+-?~?	M?N???3???????*??-?hhO???????[???????6Tg:
+?2[?8e=?b??????4???1{:;a?!??????*vF_???I?jhq??????em?????`??!n?????????\H?`?r_d????,j?W.?<0?^puqZ?SF']????;C???0)<?>B?)0?V>??????4K?
+endstream
+endobj
+4 0 obj
+<<
+/Type/Font
+/Subtype/Type1
+/Widths 11 0 R
+/FirstChar 44
+/LastChar 121
+/Encoding/WinAnsiEncoding
+/BaseFont/GAMVDK+URWPalladioL-Roma
+/FontDescriptor 19 0 R
+>>
+endobj
+19 0 obj
+<<
+/Type/FontDescriptor
+/CapHeight 692
+/Ascent 726
+/Descent -281
+/ItalicAngle 0
+/StemV 84
+/Flags 6
+/FontBBox[-166 -283 1021 943]
+/FontFile3 12 0 R
+/FontName/GAMVDK+URWPalladioL-Roma
+>>
+endobj
+7 0 obj
+<<
+/Type/Font
+/Subtype/Type1
+/Widths 13 0 R
+/FirstChar 48
+/LastChar 57
+/Encoding/WinAnsiEncoding
+/BaseFont/FCJRVS+TeXPalladioL-SC
+/FontDescriptor 20 0 R
+>>
+endobj
+20 0 obj
+<<
+/Type/FontDescriptor
+/CapHeight 698
+/Ascent 487
+/Descent -3
+/ItalicAngle 0
+/StemV 84
+/Flags 6
+/FontBBox[-166 -274 1021 943]
+/FontFile3 14 0 R
+/FontName/FCJRVS+TeXPalladioL-SC
+>>
+endobj
+5 0 obj
+<<
+/Type/Font
+/Subtype/Type1
+/Widths 15 0 R
+/FirstChar 80
+/LastChar 115
+/BaseFont/PWFORY+CMSS17
+/FontDescriptor 21 0 R
+>>
+endobj
+21 0 obj
+<<
+/Type/FontDescriptor
+/CapHeight 694
+/Ascent 694
+/Descent -195
+/ItalicAngle 0
+/StemV 76
+/Flags 6
+/FontBBox[-58 -250 939 758]
+/FontFile3 16 0 R
+/FontName/PWFORY+CMSS17
+>>
+endobj
+6 0 obj
+<<
+/Type/Font
+/Subtype/Type1
+/Widths 17 0 R
+/FirstChar 46
+/LastChar 118
+/BaseFont/QZLLLI+CMTT8
+/FontDescriptor 22 0 R
+>>
+endobj
+22 0 obj
+<<
+/Type/FontDescriptor
+/CapHeight 611
+/Ascent 611
+/Descent -222
+/ItalicAngle 0
+/StemV 76
+/Flags 6
+/FontBBox[-5 -232 545 699]
+/FontFile3 18 0 R
+/FontName/QZLLLI+CMTT8
+>>
+endobj
+xref
+0 23
+0000000000 65535 f 
+0000000754 00000 n 
+0000000623 00000 n 
+0000000457 00000 n 
+0000007479 00000 n 
+0000008222 00000 n 
+0000008547 00000 n 
+0000007854 00000 n 
+0000000015 00000 n 
+0000000344 00000 n 
+0000000538 00000 n 
+0000000803 00000 n 
+0000001011 00000 n 
+0000003473 00000 n 
+0000003521 00000 n 
+0000004631 00000 n 
+0000004737 00000 n 
+0000005670 00000 n 
+0000005866 00000 n 
+0000007653 00000 n 
+0000008025 00000 n 
+0000008359 00000 n 
+0000008683 00000 n 
+trailer
+<<
+/Root 1 0 R
+/Info 2 0 R
+/Size 23
+>>
+startxref
+8869
+%%EOF

Added: tags/texmf/fonts/misc/xetex/fontmapping/xepersian/parsidigits.map
===================================================================
--- tags/texmf/fonts/misc/xetex/fontmapping/xepersian/parsidigits.map	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/fonts/misc/xetex/fontmapping/xepersian/parsidigits.map	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,46 @@
+; Vafa Khalighi ...
+LHSName "Digits"
+RHSName "ParsiDigits"
+
+pass(Unicode)
+U+0030 <> U+06F0 ;
+U+0031 <> U+06F1 ;
+U+0032 <> U+06F2 ;
+U+0033 <> U+06F3 ;
+U+0034 <> U+06F4 ;
+U+0035 <> U+06F5 ;
+U+0036 <> U+06F6 ;
+U+0037 <> U+06F7 ;
+U+0038 <> U+06F8 ;
+U+0039 <> U+06F9 ;
+
+U+0644 U+0651 U+064E U+0627 <> U+0644 U+0627 U+0651 U+064E ; lam shadda fatha alif -> lam alif shadda fatha
+U+0644 U+0651 U+0627 <> U+0644 U+0627 U+0651  ; lam shadda alif -> lam alif shadda
+U+0644 U+0652 U+0622 <> U+0644 U+0622 U+0652  ; lam sukun alifmadda -> lam alifmadda sukun
+U+0644 U+0652 U+0623 <> U+0644 U+0623 U+0652  ; lam sukun alifhamzaabove -> lam alifhamzaabove sukun
+U+0644 U+0652 U+0625 <> U+0644 U+0625 U+0652  ; lam sukun alifhamzabelow -> lam alifhamzabelow sukun
+U+0644 U+0651 U+064B U+0627 <> U+0644 U+0627 U+0651 U+064b ; lam shadda fathatan alif -> lam alif shadda fathatan
+U+0644 U+064B U+0627 <> U+0644 U+0627 U+064B ; lam fathatan alif -> lam alif fathatan
+
+U+002C <> U+060C ; comma ??> arabic comma
+U+003F <> U+061F ; question mark -> arabic qm
+U+003B <> U+061B ; semicolon -> arabic semicolon
+
+; ligatures from Knuth's original CMR fonts
+U+002D U+002D <> U+2013 ; -- -> en dash
+U+002D U+002D U+002D <> U+2014 ; --- -> em dash
+
+U+0027 <> U+2019 ; ' -> right single quote
+U+0027 U+0027 <> U+201D ; '' -> right double quote
+U+0022  > U+201D ; " -> right double quote
+
+U+0060 <> U+2018 ; ` -> left single quote
+U+0060 U+0060 <> U+201C ; `` -> left double quote
+
+U+0021 U+0060 <> U+00A1 ; !` -> inverted exclam
+U+003F U+0060 <> U+00BF ; ?` -> inverted question
+
+; additions supported in T1 encoding
+U+002C U+002C <> U+201E ; ,, -> DOUBLE LOW-9 QUOTATION MARK
+U+003C U+003C <> U+00AB ; << -> LEFT POINTING GUILLEMET
+U+003E U+003E <> U+00BB ; >> -> RIGHT POINTING GUILLEMET

Added: tags/texmf/fonts/misc/xetex/fontmapping/xepersian/parsidigits.tec
===================================================================
(Binary files differ)


Property changes on: tags/texmf/fonts/misc/xetex/fontmapping/xepersian/parsidigits.tec
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: tags/texmf/fonts/misc/xetex/fontmapping/xepersian/txt2maths.map
===================================================================
--- tags/texmf/fonts/misc/xetex/fontmapping/xepersian/txt2maths.map	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/fonts/misc/xetex/fontmapping/xepersian/txt2maths.map	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,48 @@
+; Vafa Khalighi ...
+LHSName "Digits"
+RHSName "txt2maths"
+
+Pass(Unicode)
+U+002E <> U+066B ; convert dot to Persian decimal separator
+U+002D <> U+2212 ; convert hyphen to minus sign
+U+0030 <> U+06F0 ;
+U+0031 <> U+06F1 ;
+U+0032 <> U+06F2 ;
+U+0033 <> U+06F3 ;
+U+0034 <> U+06F4 ;
+U+0035 <> U+06F5 ;
+U+0036 <> U+06F6 ;
+U+0037 <> U+06F7 ;
+U+0038 <> U+06F8 ;
+U+0039 <> U+06F9 ;
+
+U+0644 U+0651 U+064E U+0627 <> U+0644 U+0627 U+0651 U+064E ; lam shadda fatha alif -> lam alif shadda fatha
+U+0644 U+0651 U+0627 <> U+0644 U+0627 U+0651  ; lam shadda alif -> lam alif shadda
+U+0644 U+0652 U+0622 <> U+0644 U+0622 U+0652  ; lam sukun alifmadda -> lam alifmadda sukun
+U+0644 U+0652 U+0623 <> U+0644 U+0623 U+0652  ; lam sukun alifhamzaabove -> lam alifhamzaabove sukun
+U+0644 U+0652 U+0625 <> U+0644 U+0625 U+0652  ; lam sukun alifhamzabelow -> lam alifhamzabelow sukun
+U+0644 U+0651 U+064B U+0627 <> U+0644 U+0627 U+0651 U+064b ; lam shadda fathatan alif -> lam alif shadda fathatan
+U+0644 U+064B U+0627 <> U+0644 U+0627 U+064B ; lam fathatan alif -> lam alif fathatan
+
+U+002C <> U+060C ; comma ??> arabic comma
+U+003F <> U+061F ; question mark -> arabic qm
+U+003B <> U+061B ; semicolon -> arabic semicolon
+
+; ligatures from Knuth's original CMR fonts
+U+002D U+002D <> U+2013 ; -- -> en dash
+U+002D U+002D U+002D <> U+2014 ; --- -> em dash
+
+U+0027 <> U+2019 ; ' -> right single quote
+U+0027 U+0027 <> U+201D ; '' -> right double quote
+U+0022  > U+201D ; " -> right double quote
+
+U+0060 <> U+2018 ; ` -> left single quote
+U+0060 U+0060 <> U+201C ; `` -> left double quote
+
+U+0021 U+0060 <> U+00A1 ; !` -> inverted exclam
+U+003F U+0060 <> U+00BF ; ?` -> inverted question
+
+; additions supported in T1 encoding
+U+002C U+002C <> U+201E ; ,, -> DOUBLE LOW-9 QUOTATION MARK
+U+003C U+003C <> U+00AB ; << -> LEFT POINTING GUILLEMET
+U+003E U+003E <> U+00BB ; >> -> RIGHT POINTING GUILLEMET

Added: tags/texmf/fonts/misc/xetex/fontmapping/xepersian/txt2maths.tec
===================================================================
(Binary files differ)


Property changes on: tags/texmf/fonts/misc/xetex/fontmapping/xepersian/txt2maths.tec
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: tags/texmf/tex/xelatex/bidi/amsart-bidi.def
===================================================================
--- tags/texmf/tex/xelatex/bidi/amsart-bidi.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/bidi/amsart-bidi.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,67 @@
+%%
+%% This is file `amsart-bidi.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% bidi.dtx  (with options: `amsart-bidi.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\def\@tocline#1#2#3#4#5#6#7{\relax
+  \ifnum #1>\c at tocdepth % then omit
+  \else
+    \par \addpenalty\@secpenalty\addvspace{#2}%
+    \begingroup \hyphenpenalty\@M
+    \@ifempty{#4}{%
+      \@tempdima\csname r at tocindent\number#1\endcsname\relax
+    }{%
+      \@tempdima#4\relax
+    }%
+    \parindent\z@ \if at RTL\rightskip\else\leftskip\fi#3\relax \advance\if at RTL\rightskip\else\leftskip\fi\@tempdima\relax
+    \if at RTL\leftskip\else\rightskip\fi\@pnumwidth plus4em \parfillskip-\@pnumwidth
+    #5\leavevmode\hskip-\@tempdima #6\nobreak\relax
+    \hfil\hbox to\@pnumwidth{\@tocpagenum{#7}}\par
+    \nobreak
+    \endgroup
+  \fi}
+\renewcommand\thesubsection    {\thesection\@SepMark\arabic{subsection}}
+\renewcommand\thesubsubsection {\thesubsection \@SepMark\arabic{subsubsection}}
+\renewcommand\theparagraph     {\thesubsubsection\@SepMark\arabic{paragraph}}
+\renewcommand\thesubparagraph  {\theparagraph\@SepMark\arabic{subparagraph}}
+\def\part{\@startsection{part}{0}%
+  \z@{\linespacing\@plus\linespacing}{.5\linespacing}%
+  {\normalfont\bfseries\raggedleft}}
+\renewenvironment{thebibliography}[1]{%
+  \@bibtitlestyle
+  \normalfont\bibliofont\labelsep .5em\relax
+  \renewcommand\theenumiv{\arabic{enumiv}}\let\p at enumiv\@empty
+  \list{\@biblabel{\theenumiv}}{\settowidth\labelwidth{\@biblabel{#1}}%
+    \leftmargin\labelwidth \advance\leftmargin\labelsep
+    \rightmargin\labelwidth \advance\rightmargin\labelsep
+    \usecounter{enumiv}}%
+  \sloppy \clubpenalty\@M \widowpenalty\clubpenalty
+  \sfcode`\.=\@m
+}{%
+  \def\@noitemerr{\@latex at warning{Empty `thebibliography' environment}}%
+  \endlist
+}
+%% 
+%% Copyright ?? 2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `amsart-bidi.def'.

Added: tags/texmf/tex/xelatex/bidi/amsbook-bidi.def
===================================================================
--- tags/texmf/tex/xelatex/bidi/amsbook-bidi.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/bidi/amsbook-bidi.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,77 @@
+%%
+%% This is file `amsbook-bidi.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% bidi.dtx  (with options: `amsbook-bidi.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\def\@tocline#1#2#3#4#5#6#7{\relax
+  \ifnum #1>\c at tocdepth % then omit
+  \else
+    \par \addpenalty\@secpenalty\addvspace{#2}%
+    \begingroup \hyphenpenalty\@M
+    \@ifempty{#4}{%
+      \@tempdima\csname r at tocindent\number#1\endcsname\relax
+    }{%
+      \@tempdima#4\relax
+    }%
+    \parindent\z@ \if at RTL\rightskip\else\leftskip\fi#3\relax \advance\if at RTL\rightskip\else\leftskip\fi\@tempdima\relax
+    \if at RTL\leftskip\else\rightskip\fi\@pnumwidth plus4em \parfillskip-\@pnumwidth
+    #5\leavevmode\hskip-\@tempdima #6\nobreak\relax
+    \hfil\hbox to\@pnumwidth{\@tocpagenum{#7}}\par
+    \nobreak
+    \endgroup
+  \fi}
+\renewcommand\thesubsection    {\thesection\@SepMark\arabic{subsection}}
+\renewcommand\thesubsubsection {\thesubsection \@SepMark\arabic{subsubsection}}
+\renewcommand\theparagraph     {\thesubsubsection\@SepMark\arabic{paragraph}}
+\renewcommand\thesubparagraph  {\theparagraph\@SepMark\arabic{subparagraph}}
+\renewenvironment{thebibliography}[1]{%
+  \@bibtitlestyle
+  \normalfont\bibliofont\labelsep .5em\relax
+  \renewcommand\theenumiv{\arabic{enumiv}}\let\p at enumiv\@empty
+  \list{\@biblabel{\theenumiv}}{\settowidth\labelwidth{\@biblabel{#1}}%
+    \rightmargin\labelwidth \advance\rightmargin\labelsep
+     \leftmargin\labelwidth \advance\leftmargin\labelsep
+    \usecounter{enumiv}}%
+  \sloppy \clubpenalty\@M \widowpenalty\clubpenalty
+  \sfcode`\.=\@m
+}{%
+  \def\@noitemerr{\@latex at warning{Empty `thebibliography' environment}}%
+  \endlist
+}
+\def\theindex{\@restonecoltrue\if at twocolumn\@restonecolfalse\fi
+\columnseprule\z@ \columnsep 35\p@
+\@indextitlestyle
+\thispagestyle{plain}%
+\let\item\@idxitem
+\parindent\z@ \parskip\z@\@plus.3\p@\relax
+\raggedleft
+\hyphenpenalty\@M
+\footnotesize}
+
+\def\@idxitem{\par\hangindent -2em}
+\def\subitem{\par\hangindent -2em\hspace*{1em}}
+\def\subsubitem{\par\hangindent -3em\hspace*{2em}}
+%% 
+%% Copyright ?? 2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `amsbook-bidi.def'.

Added: tags/texmf/tex/xelatex/bidi/amsthm-bidi.def
===================================================================
--- tags/texmf/tex/xelatex/bidi/amsthm-bidi.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/bidi/amsthm-bidi.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,30 @@
+%%
+%% This is file `amsthm-bidi.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% bidi.dtx  (with options: `amsthm-bidi.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\def\@thmcountersep{\@SepMark}
+%% 
+%% Copyright ?? 2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `amsthm-bidi.def'.

Added: tags/texmf/tex/xelatex/bidi/array-bidi.def
===================================================================
--- tags/texmf/tex/xelatex/bidi/array-bidi.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/bidi/array-bidi.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,111 @@
+%%
+%% This is file `array-bidi.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% bidi.dtx  (with options: `array-bidi.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\def\@testpach{\@chclass
+ \ifnum \@lastchclass=6 \@ne \@chnum \@ne \else
+  \ifnum \@lastchclass=7 5 \else
+   \ifnum \@lastchclass=8 \tw@ \else
+    \ifnum \@lastchclass=9 \thr@@
+   \else \z@
+   \ifnum \@lastchclass = 10 \else
+   \edef\@nextchar{\expandafter\string\@nextchar}%
+   \@chnum
+   \if \@nextchar c\z@ \else
+    \if \@nextchar \if at RTLtab r\else l\fi\@ne \else
+     \if \@nextchar \if at RTLtab l\else r\fi\tw@ \else
+   \z@ \@chclass
+   \if\@nextchar |\@ne \else
+    \if \@nextchar !6 \else
+     \if \@nextchar @7 \else
+      \if \@nextchar <8 \else
+       \if \@nextchar >9 \else
+  10
+  \@chnum
+  \if \@nextchar m\thr@@\else
+   \if \@nextchar p4 \else
+    \if \@nextchar b5 \else
+   \z@ \@chclass \z@ \@preamerr \z@ \fi \fi \fi \fi
+   \fi \fi  \fi  \fi  \fi  \fi  \fi \fi \fi \fi \fi \fi}
+\def\tabular{\gdef\@halignto{}\@tabular}
+\def\@tabular{\if at RTL\global\@RTLtabtrue\fi%
+ \leavevmode
+ \hbox\bgroup \if at RTLtab\beginR \fi
+   $%
+   \@tabularinit
+   \@array
+}
+\renewcommand\@array[2][c]{%
+   \@tempdima \ht \strutbox
+   \advance \@tempdima by\extrarowheight
+   \setbox \@arstrutbox \hbox{%
+     \vrule \@height \arraystretch \@tempdima
+            \@depth  \arraystretch \dp \strutbox
+            \@width  \z@
+   }%
+   \begingroup
+     \@mkpream{#2}%
+     \xdef\@preamble{%
+       \noexpand \ialign \@halignto
+       \bgroup \@arstrut \@preamble
+         \tabskip \z@ \cr
+     }%
+   \endgroup
+   \@arrayleft
+   \if #1t\vtop \else \if#1b\vbox \else \vcenter \fi \fi
+   \bgroup
+     \@arrayinit
+     \if at RTLtab\hbox\bgroup\beginR\vbox\bgroup\fi
+       \@preamble
+         % indent
+}
+%% environment body goes here
+\def\endtabular{%
+         \crcr
+       \egroup % \bgroup from \@preamble
+     \if at RTLtab\egroup\endR\egroup\fi % \vbox\hbox
+   \egroup
+   \gdef\@preamble{}%
+   $\if at RTLtab\endR\fi%
+ \egroup % original \hbox
+\global\@RTLtabfalse}
+\def\@tabularinit{%
+   \col at sep\tabcolsep
+   \let \d at llarbegin \begingroup
+   \let \d at llarend \endgroup
+}
+\def\@arrayinit{%
+   \let \@sharp ##
+   \let \protect \relax
+   \lineskip \z@
+   \baselineskip \z@
+   \m at th
+   \let \\ \@arraycr
+   \let \tabularnewline \\%
+   \let \par \@empty
+}
+%% 
+%% Copyright ?? 2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `array-bidi.def'.

Added: tags/texmf/tex/xelatex/bidi/article-bidi.def
===================================================================
--- tags/texmf/tex/xelatex/bidi/article-bidi.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/bidi/article-bidi.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,130 @@
+%%
+%% This is file `article-bidi.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% bidi.dtx  (with options: `article-bidi.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\renewcommand*\l at part[2]{%
+  \ifnum \c at tocdepth >-2\relax
+    \addpenalty\@secpenalty
+    \addvspace{2.25em \@plus\p@}%
+    \setlength\@tempdima{3em}%
+    \begingroup
+      \parindent \z@ \if at RTL\leftskip\else\rightskip\fi \@pnumwidth
+      \parfillskip -\@pnumwidth
+      {\leavevmode
+       \large \bfseries #1\hfil \hb at xt@\@pnumwidth{\hss #2}}\par
+       \nobreak
+       \if at compatibility
+         \global\@nobreaktrue
+         \everypar{\global\@nobreakfalse\everypar{}}%
+      \fi
+    \endgroup
+  \fi}
+\renewcommand\thesubsection   {\thesection\@SepMark\@arabic\c at subsection}
+\renewcommand\thesubsubsection{\thesubsection\@SepMark\@arabic\c at subsubsection}
+\renewcommand\theparagraph    {\thesubsubsection\@SepMark\@arabic\c at paragraph}
+\renewcommand\thesubparagraph {\theparagraph\@SepMark\@arabic\c at subparagraph}
+\def\@part[#1]#2{%
+    \ifnum \c at secnumdepth >\m at ne
+      \refstepcounter{part}%
+      \addcontentsline{toc}{part}{\thepart\hspace{1em}#1}%
+    \else
+      \addcontentsline{toc}{part}{#1}%
+    \fi
+    {\parindent \z@ \raggedleft
+     \interlinepenalty \@M
+     \normalfont
+     \ifnum \c at secnumdepth >\m at ne
+       \Large\bfseries \partname\nobreakspace\thepart
+       \par\nobreak
+     \fi
+     \huge \bfseries #2%
+     \markboth{}{}\par}%
+    \nobreak
+    \vskip 3ex
+    \@afterheading}
+    \def\ps at plain{\ps at empty
+\def\@oddfoot{\hfil\thepage\hfil}%
+\let\@evenfoot\@oddfoot
+}
+\renewenvironment{thebibliography}[1]
+     {\section*{\refname}%
+      \@mkboth{\MakeUppercase\refname}{\MakeUppercase\refname}%
+      \list{\@biblabel{\@arabic\c at enumiv}}%
+           {\settowidth\labelwidth{\@biblabel{#1}}%
+            \rightmargin\labelwidth    \advance\rightmargin\labelsep
+            \@openbib at code
+            \usecounter{enumiv}%
+            \let\p at enumiv\@empty
+            \renewcommand\theenumiv{\@arabic\c at enumiv}}%
+      \sloppy
+      \clubpenalty4000
+      \@clubpenalty \clubpenalty
+      \widowpenalty4000%
+      \sfcode`\.\@m}
+     {\def\@noitemerr
+       {\@latex at warning{Empty `thebibliography' environment}}%
+      \endlist}
+\if at twoside
+  \def\ps at headings{%
+      \let\@oddfoot\@empty\let\@evenfoot\@empty
+      \def\@evenhead{\sl\beginR\leftmark\endR\hfil\thepage}%
+      \def\@oddhead{\sl\thepage\hfil\beginR\rightmark\endR}%
+      \let\@mkboth\markboth
+    \def\sectionmark##1{%
+      \markboth {\MakeUppercase{%
+        \ifnum \c at secnumdepth >\z@
+          \thesection\quad
+        \fi
+        \beginR##1\endR}}{}}%
+    \def\subsectionmark##1{%
+      \markright {%
+        \ifnum \c at secnumdepth >\@ne
+          \beginR\thesubsection\quad\endR
+        \fi
+        \beginR##1\endR}}}
+\else
+  \def\ps at headings{%
+    \let\@oddfoot\@empty
+    \def\@oddhead{\sl\thepage\hfil\beginR\rightmark\endR}%
+    \let\@mkboth\markboth
+    \def\sectionmark##1{%
+      \markright {\MakeUppercase{%
+        \ifnum \c at secnumdepth >\m at ne
+          \beginR\thesection\quad\endR
+        \fi
+        \beginR##1\endR}}}}
+\fi
+\def\ps at myheadings{%
+    \let\@oddfoot\@empty\let\@evenfoot\@empty
+    \def\@evenhead{\sl\thepage\hfil\beginR\leftmark\endR}%
+    \def\@oddhead{\sl\beginR\rightmark\endR\hfil\thepage}%
+    \let\@mkboth\@gobbletwo
+    \let\sectionmark\@gobble
+    \let\subsectionmark\@gobble
+    }
+\pagestyle{plain}
+%% 
+%% Copyright ?? 2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `article-bidi.def'.

Added: tags/texmf/tex/xelatex/bidi/beamer-bidi.def
===================================================================
--- tags/texmf/tex/xelatex/bidi/beamer-bidi.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/bidi/beamer-bidi.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,395 @@
+%%
+%% This is file `beamer-bidi.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% bidi.dtx  (with options: `beamer-bidi.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\raggedleft
+\def\LTR{\bgroup\par\raggedright\@RTLfalse}
+\def\endLTR{\par\egroup}
+\def\RTL{\bgroup\par\raggedleft\@RTLtrue}
+\def\endRTL{\par\egroup}
+\long\def\beamer@@frametitle[#1]#2{%
+  \beamer at ifempty{#2}{}{%
+    \gdef\insertframetitle{\raggedleft\rightskip=2em{\beginR#2\endR\ifnum\beamer at autobreakcount>0\relax{}\space\usebeamertemplate*{frametitle continuation}\fi}}%
+  \gdef\beamer at frametitle{\beginR#2\endR}%
+  \gdef\beamer at shortframetitle{\beginR#1\endR}%
+}%
+}
+\def\@thm#1#2#3{%
+  \ifhmode\unskip\unskip\par\fi
+  \normalfont
+  \let\thmheadnl\relax
+  \let\thm at swap\@gobble
+  \thm at headpunct{.}% add period after heading
+  \thm at space@setup
+  #1% style overrides
+  \def\inserttheoremname{#3}
+  \def\inserttheorempunctuation{\the\thm at headpunct}
+  \def\@tempa{#2}%
+  \ifx\@empty\@tempa
+    \def\inserttheoremnumber{}
+  \else
+    \refstepcounter{#2}%
+    \expandafter\def\expandafter\inserttheoremnumber\expandafter{ \csname the#2\endcsname}
+  \fi
+  \beamer at begintheorem%
+\raggedleft\@RTLtrue
+}
+ \ifbeamer at countsect
+      \newtheorem{biditheorem}{\raggedleft \biditheoremname}[section]
+    \else
+      \newtheorem{biditheorem}{\raggedleft \biditheoremname}
+    \fi
+    \newtheorem{bidicorollary}[theorem]{\raggedleft \bidicorollaryname}
+    \newtheorem{bidifact}[theorem]{\raggedleft \bidifactname}
+    \newtheorem{bidilemma}[theorem]{\raggedleft \bidilemmaname}
+    \newtheorem{bidiproblem}[theorem]{\raggedleft \bidiproblemname}
+    \newtheorem{bidisolution}[theorem]{\raggedleft \bidisolutionname}
+\theoremstyle{definition}
+    \newtheorem{bididefinition}[theorem]{\raggedleft \bididefinitionname}
+    \newtheorem{bididefinitions}[theorem]{\raggedleft \bididefinitionsname}
+\theoremstyle{example}
+    \newtheorem{bidiexample}[theorem]{\raggedleft \bidiexamplename}
+    \newtheorem{bidiexamples}[theorem]{\raggedleft \bidiexamplesname}
+\newenvironment<>{bidiproof}[1][\raggedleft \bidiproofname]{%
+  \par
+  \def\insertproofname{#1\@addpunct{}}%
+  \pushQED{\qed}
+  \usebeamertemplate{proof begin}\@RTLtrue#2}
+{\popQED\usebeamertemplate{proof end}}
+ \newenvironment<>{bidiblock}[1]{%
+    \begin{actionenv}#2%
+      \def\insertblocktitle{\raggedleft#1}%
+      \par%
+      \usebeamertemplate{block begin}\raggedleft\@RTLtrue}
+    {\par%
+      \usebeamertemplate{block end}%
+    \end{actionenv}}
+  \newenvironment<>{bidialertblock}[1]{%
+    \begin{actionenv}#2%
+      \def\insertblocktitle{\raggedleft#1}%
+      \par%
+      \mode<presentation>{%\usebeamerfont{block}%
+        \setbeamercolor{local structure}{parent=alerted text}}%
+      \usebeamertemplate{block alerted begin}\raggedleft\@RTLtrue}
+    {\par%
+      \usebeamertemplate{block alerted end}%
+    \end{actionenv}}
+  \newenvironment<>{bidiexampleblock}[1]{%
+    \begin{actionenv}#2%
+      \def\insertblocktitle{\raggedleft#1}%
+      \par%
+      \mode<presentation>{%\usebeamerfont{block}%
+        \setbeamercolor{local structure}{parent=example text}}%
+      \usebeamertemplate{block example begin}\raggedleft\@RTLtrue}
+    {\par%
+      \usebeamertemplate{block example end}%
+    \end{actionenv}}
+\def\@listi{\if at RTL\rightmargin\leftmargini\else\leftmargin\leftmargini\fi
+            \topsep 3\p@ \@plus2\p@ \@minus2.5\p@
+            \parsep 0\p@
+            \itemsep3\p@ \@plus2\p@ \@minus3\p@}
+\let\@listI\@listi
+\def\@listii{\if at RTL\rightmargin\leftmarginii\else\leftmargin\leftmarginii\fi
+              \topsep    2\p@ \@plus1\p@ \@minus2\p@
+              \parsep    0\p@   \@plus\p@
+              \itemsep   \parsep}
+\def\@listiii{\if at RTL\rightmargin\leftmarginiii\else\leftmargin\leftmarginiii\fi
+              \topsep    2\p@ \@plus1\p@ \@minus2\p@
+              \parsep    0\p@   \@plus\p@
+              \itemsep   \parsep}
+\def\beamer at enum@{%
+  \beamer at computepref\@itemdepth% sets \beameritemnestingprefix
+  \usebeamerfont{itemize/enumerate \beameritemnestingprefix body}%
+  \usebeamercolor[fg]{itemize/enumerate \beameritemnestingprefix body}%
+  \usebeamertemplate{itemize/enumerate \beameritemnestingprefix body begin}%
+  \expandafter
+    \list
+      {\usebeamertemplate{\beamer at enumtempl}}
+      {\usecounter\@enumctr%
+        \def\makelabel##1{{\hss\llap{{%
+                \usebeamerfont*{enumerate \beameritemnestingprefix item}%
+                \usebeamercolor[fg]{enumerate \beameritemnestingprefix item}##1}}}}}%
+  \beamer at cramped%
+  \raggedleft%
+  \beamer at firstlineitemizeunskip%
+}
+\renewcommand{\itemize}[1][]{%
+  \beamer at ifempty{#1}{}{\def\beamer at defaultospec{#1}}%
+  \ifnum \@itemdepth >2\relax\@toodeep\else
+    \advance\@itemdepth\@ne
+    \beamer at computepref\@itemdepth% sets \beameritemnestingprefix
+    \usebeamerfont{itemize/enumerate \beameritemnestingprefix body}%
+    \usebeamercolor[fg]{itemize/enumerate \beameritemnestingprefix body}%
+    \usebeamertemplate{itemize/enumerate \beameritemnestingprefix body begin}%
+    \list
+      {\usebeamertemplate{itemize \beameritemnestingprefix item}}
+      {\def\makelabel##1{%
+          {%
+            \hss\llap{{%
+                \usebeamerfont*{itemize \beameritemnestingprefix item}%
+                \usebeamercolor[fg]{itemize \beameritemnestingprefix item}##1}}%
+          }%
+        }%
+      }
+  \fi%
+  \beamer at cramped%
+  \raggedleft%
+  \beamer at firstlineitemizeunskip%
+}
+\def\@@description{%
+  \advance\beamer at descdefault by \labelsep%
+  \list
+  {}
+  {\labelwidth\beamer at descdefault\leftmargin\beamer at descdefault\let\makelabel\beamer at descriptionitem}%
+  \beamer at cramped%
+  \raggedleft\rightskip=6em
+  \beamer at firstlineitemizeunskip%
+}
+\AtBeginDocument{\@RTLfalse}
+\renewenvironment{beamer at frameslide}{%
+  \ifbeamer at autobreak\else%
+    \ifx\beamer at againname\@empty%
+      {\let\@elt\beamer at restorecounter\beamer at overlaycounterresets}%
+    \else%
+      {\let\@elt\beamer at labelrestorecounter\beamer at overlaycounterresets}%
+    \fi%
+  \fi%
+  \global\c at beamerpauses=1\relax%
+  \expandafter\beamer at ifempty\expandafter{\beamer at framestartpage}{%
+    \refstepcounter{subsectionslide}%
+    \xdef\beamer at framestartpage{\the\c at page}% only first time
+  }{\clearpage\beamer at notesactions}% cleanup from previous slide
+  \hypersetup{pdfpagetransition=R}%
+  \hypersetup{pdfpageduration=}%
+  \xdef\beamer at frameendpage{\the\c at page}% every time
+  \beamer at setuplinks%
+  \beamer at displaybreak%
+  \global\setbox\beamer at zoombox=\box\voidb at x%
+  \def\beamer at zoomer{}%
+  \beamer at slidehaszoomfalse%
+  \gdef\insertframetitle{}%
+  \gdef\insertframesubtitle{}%
+  \gdef\beamer at frametitle{}%
+  \gdef\beamer at shortframetitle{}%
+  \gdef\beamer at framesubtitle{}%
+  \let\beamer at startcomment=\beamer at startcommentinframe%
+  % Start slide:
+  \beamer at framenotesbegin\@RTLtrue%
+    \global\setbox\beamer at framebox=\vbox\bgroup%
+    \beamer at inframetrue%
+    \let\frame=\framelatex% inside frames, use LaTeX's \frame command
+    \begin{beamer at framepauses}%
+      \ifbeamer at shrink%
+        \hsize=\beamer at shrinkfactorinv\hsize%
+        \textwidth=\beamer at shrinkfactorinv\textwidth%
+        \linewidth=\beamer at shrinkfactorinv\linewidth%
+      \fi%
+      % Insert labels if necessary:
+      \ifx\beamer at againname\@empty\else%
+        \nointerlineskip\vbox to0pt{\vss%
+        \label<\the\beamer at slideinframe>{\beamer at againname<\the\beamer at slideinframe>}%
+        \ifnum\beamer at slideinframe=1\relax%
+          \label<1>{\beamer at againname}%
+        \fi%
+        }\nointerlineskip%
+      \fi%
+      \ifx\beamer at framehypertargets\@empty\else%
+        \nointerlineskip\vbox to0pt{\vss%
+          \beamer at framehypertargets%
+          \global\let\beamer at framehypertargets\@empty%
+        }\nointerlineskip%
+      \fi%
+      \vskip-\parskip\vbox{}%
+      \beamer at initfirstlineunskip%
+      \ifbeamer at plainframe\nointerlineskip\fi%
+    \beamer at checkframetitle}%
+    {\end{beamer at framepauses}%
+  \egroup%
+  \ifx\beamer at frametitle\@empty%
+    \setbox\beamer at frametitlebox=\box\voidb at x%
+  \else%
+    \setbox\beamer at frametitlebox=\vbox{%
+      \vbox{}%
+      {\parskip0pt\usebeamertemplate***{frametitle}\vskip0.25em}%
+    }%
+  \fi%
+  \ifbeamer at plainframe%
+    \beamer at frametextheight=\paperheight%
+  \else%
+    \beamer at frametextheight=\textheight%
+  \fi%
+  \advance\beamer at frametextheight by-\ht\beamer at frametitlebox%
+  \advance\beamer at frametextheight by-\dp\beamer at frametitlebox%
+  \advance\beamer at frametextheight by-\beamer at frametopskip%
+  \ifbeamer at shrink%
+    \beamer at shrinkframebox%
+  \fi%
+  \ifx\beamer at zoomer\@empty
+    \setbox\beamer at framebox=\vbox{%
+      \nobreak\vbox{}\nobreak\par\nobreak\beamer at entrycode\nobreak%
+      \nointerlineskip\unvbox\beamer at frametitlebox%
+      \nobreak%
+      \ifbeamer at autobreak%
+        \vskip\beamer at frametopskipautobreak%
+      \else%
+        \vskip\beamer at frametopskip%
+      \fi%
+      \nobreak%
+      \nointerlineskip\box\beamer at zoombox\nointerlineskip%
+      \nobreak%
+      \ifbeamer at slidehaszoom\box\beamer at framebox\else\unvbox\beamer at framebox\fi%
+      % bottom skip is added in autobreakframebox
+    }%
+    \beamer at autobreakframebox%
+  \else%
+    \beamer at zoomer%
+  \fi%
+  \beamer at undolabels%
+  \beamer at framenotesend%
+  \box\beamer at framebox}
+\long\def\beamer at title[#1]#2{%
+  \def\inserttitle{\beginR#2\endR}%
+  \def\beamer at shorttitle{\beginR#1\endR}%
+  }
+\long\def\beamer at subtitle[#1]#2{%
+  \def\insertsubtitle{\beginR#2\endR}%
+  \def\beamer at shortsubtitle{\beginR#1\endR}%
+  }
+\long\def\beamer at date[#1]#2{%
+  \def\insertdate{\beginR#2\endR}%
+  \def\beamer at shortdate{\beginR#1\endR}%
+  }
+\long\def\beamer at author[#1]#2{%
+  \def\insertauthor{\def\inst{\beamer at insttitle}\def\and{\beamer at andtitle}\beginR#2\endR}%
+  \def\beamer at shortauthor{\beginR#1\endR}%
+  \ifbeamer at autopdfinfo%
+    \def\beamer at andstripped{}%
+    \beamer at stripands#2 \and\relax
+    {\let\inst=\@gobble\let\thanks=\@gobble\def\and{, }\hypersetup{pdfauthor={\beamer at andstripped}}}
+  \fi%
+}
+\long\def\beamer at institute[#1]#2{%
+  \def\beamer at temp{\beginR#2\endR}%
+  \ifx\beamer at temp\@empty
+    \def\insertinstitute{}
+  \else
+    \def\insertinstitute{\def\inst{\beamer at instinst}\def\and{\beamer at andinst}\beginR#2\endR}%
+  \fi
+ \def\beamer at shortinstitute{\beginR#1\endR}}
+\renewenvironment{thebibliography}[1]
+{%\leavevmode\unskip%
+  \list{\@biblabel{\@arabic\c at enumiv}}%
+           {\settowidth\labelwidth{\beamer at biblabeltemplate{\@biblabel{#1}}}%
+            \leftmargin\labelwidth
+            \advance\leftmargin\labelsep
+            \itemsep=0pt%
+            \partopsep=0pt%
+            \topsep=0pt%
+            \usecounter{enumiv}%
+            \let\p at enumiv\@empty
+            \renewcommand\theenumiv{\@arabic\c at enumiv}
+            \let\makelabel\beamer at biblabeltemplate}%
+      \sloppy\raggedleft
+      \clubpenalty10000
+      \@clubpenalty \clubpenalty
+      \widowpenalty10000%
+      \sfcode`\.\@m}
+     {\def\@noitemerr
+       {\@latex at warning{Empty `thebibliography' environment}}%
+      \ifhmode\unskip\fi\endlist}
+\long\def\beamer@@@section#1{\beamer at section[\beginR#1\endR]{#1}}
+\def\beamer@@@subsection#1{\beamer at subsection[\beginR#1\endR]{#1}}
+\def\beamer@@@subsubsection#1{\beamer at subsubsection[\beginR#1\endR]{#1}}
+\long\def\beamer at subsectionintoc#1#2#3#4#5#6{%
+  \ifnum\c at tocdepth>1%
+  \ifnum#5=\beamer at showpartnumber%
+  {
+    \beamer at saveanother%
+    \gdef\beamer at todo{}%
+    \beamer at slideinframe=#1\relax%
+    \expandafter\only\beamer at tocsections{\gdef\beamer at todo{%
+      \ifbeamer at pausesubsections\pause\fi%
+      \beamer at tempcount=#6%
+      \advance\beamer at tempcount by\beamer at sectionadjust%
+      \edef\inserttocsectionnumber{\the\beamer at tempcount}%
+      \def\inserttocsubsectionnumber{#2}%
+      \def\inserttocsubsection{\rightskip=1.5em\hyperlink{Navigation#4}{\beginR#3\endR\hfill}}%
+      \beamer at tocifnothide{\ifnum\c at section=#1\beamer at toc@oss\else\beamer at toc@ooss\fi}%
+      {%
+        \def\beamer at breakhere{\\}%
+        \beamer at tocact{\ifnum\c at section=#1\ifnum\c at subsection=#2\beamer at toc@css\else\beamer at toc@oss\fi\else\beamer at toc@ooss\fi}
+        {subsection in toc}%
+      }%
+    }}%
+    \beamer at restoreanother%
+  }
+  \beamer at todo%
+  \fi\fi%
+}
+\long\def\beamer at subsubsectionintoc#1#2#3#4#5#6#7{%
+  \ifnum\c at tocdepth>2%
+  \ifnum#1=\beamer at showpartnumber%
+  {
+    \beamer at saveanother%
+    \gdef\beamer at todo{}%
+    \beamer at slideinframe=#2\relax%
+    \expandafter\only\beamer at tocsections{\gdef\beamer at todo{%
+      \ifbeamer at pausesubsections\pause\fi%
+      \beamer at tempcount=#6%
+      \advance\beamer at tempcount by\beamer at sectionadjust%
+      \edef\inserttocsectionnumber{\the\beamer at tempcount}%
+      \def\inserttocsubsectionnumber{#3}%
+      \def\inserttocsubsubsectionnumber{#4}%
+      \def\inserttocsubsubsection{\rightskip=3em\hyperlink{Navigation#5}{\beginR#7\endR\hfill}}%
+      \beamer at tocifnothide{\ifnum\c at section=#2\beamer at toc@oss\else\beamer at toc@ooss\fi}%
+      {%
+        \def\beamer at breakhere{\\}%
+        \beamer at tocact{\ifnum\c at section=#2\ifnum\c at subsection=#3\beamer at toc@css\else\beamer at toc@oss\fi\else\beamer at toc@ooss\fi}
+        {subsubsection in toc}%
+      }%
+    }}%
+    \beamer at restoreanother%
+  }
+  \beamer at todo%
+  \fi\fi%
+}
+\long\def\beamer at makecaption#1#2{%
+  \def\insertcaptionname{\csname#1name\endcsname}%
+  \def\insertcaptionnumber{\csname the#1\endcsname}%
+  \def\insertcaption{#2}%
+  \nobreak\vskip\abovecaptionskip\nobreak
+  \sbox\@tempboxa{\usebeamertemplate**{caption}}%
+  \ifdim \wd\@tempboxa >\hsize
+    \usebeamertemplate**{caption}\par
+  \else
+    \global \@minipagefalse
+    \hb at xt@\hsize{\if at RTL\beginR\fi\hfil\box\@tempboxa\hfil\if at RTL\endR\fi}%
+  \fi
+  \nobreak\vskip\belowcaptionskip\nobreak}
+\let\origin at alert=\alert
+\def\alert#1{\ifmmode\origin at alert{#1}\else\if at RTL\begingroup\addfontfeature{Color=FF0000}#1\endgroup\else\origin at alert{#1}\fi\fi}
+%% 
+%% Copyright ?? 2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `beamer-bidi.def'.

Added: tags/texmf/tex/xelatex/bidi/beamerthemebidiJLTree.sty
===================================================================
--- tags/texmf/tex/xelatex/bidi/beamerthemebidiJLTree.sty	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/bidi/beamerthemebidiJLTree.sty	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,133 @@
+%%
+%% This is file `beamerthemebidiJLTree.sty',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% bidi.dtx  (with options: `beamerthemebidiJLTree.sty')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\ProvidesPackage{beamerthemebidiJLTree}
+
+\newif\ifbeamer at tree@showhooks
+\beamer at tree@showhookstrue
+
+\DeclareOptionBeamer{hooks}[true]{\csname beamer at tree@showhooks#1\endcsname}
+
+\ProcessOptionsBeamer
+\mode
+<presentation>
+
+\setbeamertemplate{navigation symbols}{}
+\usecolortheme{rose}
+\useinnertheme[shadow=true]{rounded}% les block
+
+\defbeamertemplate*{footline}{bidiJLTree theme}
+{
+  \begin{beamercolorbox}[colsep=1.5pt]{upper separation line foot}
+  \end{beamercolorbox}
+  \hbox{%
+    \begin{beamercolorbox}[wd=.5\paperwidth,ht=2.25ex,dp=1ex,left]{date in head/foot}%
+      \usebeamerfont{date in head/foot}
+      \insertframenumber{} / \inserttotalframenumber\hspace*{2ex}
+    \end{beamercolorbox}%
+    \begin{beamercolorbox}[wd=.5\paperwidth,ht=2.25ex,dp=1ex,right]{title in head/foot}%
+      \usebeamerfont{title in head/foot}\beginR\hspace*{2ex}\insertauthor \hspace*{1ex} (\insertshortinstitute) \hspace*{2ex} \insertdate\endR
+    \end{beamercolorbox}}%
+}
+
+\defbeamertemplate*{sidebar right}{bidiJLTree theme}{}
+
+\usesectionheadtemplate
+{\hfil\insertsectionhead}
+{\hfill\color{fg!50!bg}\insertsectionhead}
+
+\usesubsectionheadtemplate
+{\hfil\insertsubsectionhead}
+{\hfill\color{fg!50!bg}\insertsubsectionhead}
+
+\defbeamertemplate*{headline}{bidiJLTree theme}
+{%
+  \leavevmode%
+  \begin{beamercolorbox}[wd=\paperwidth,colsep=1.5pt]{upper separation line head}
+  \end{beamercolorbox}
+  \@tempdimb=3.625ex% 2.4375ex%
+  \multiply\@tempdimb by\beamer at sectionmax%
+%%  \advance\@tempdimb by 1.125ex%
+  \advance\@tempdimb by -1.125ex%
+  \ifdim\@tempdimb<10.9ex% 3*(2.5+1.125)
+     \@tempdimb=10.9ex%
+  \fi
+  \begin{beamercolorbox}[wd=.45\paperwidth, ht=\@tempdimb]{left block}%
+    \usebeamerfont{section in head/foot}%
+    \vbox to\@tempdimb{\vfill\insertsectionnavigation{.45\paperwidth}\vfill}%
+  \end{beamercolorbox}%
+  \begin{beamercolorbox}[wd=1.125ex,ht=\@tempdimb,dp=1.125ex]{middle separation line head}%
+  \end{beamercolorbox}%
+  \begin{beamercolorbox}[wd=.44\paperwidth]{middle block}%
+    \vbox to\@tempdimb{\vfill%
+    \begin{beamercolorbox}[wd=.44\paperwidth,ht=2.5ex,dp=1.125ex,%
+      leftskip=.3cm,rightskip=.3cm plus1fil]{title in head/foot}%
+      \usebeamerfont{title in head/foot}\insertshorttitle
+    \end{beamercolorbox}
+    \begin{beamercolorbox}[wd=.44\paperwidth,ht=2.5ex,dp=1.125ex,%
+      leftskip=.3cm,rightskip=.3cm plus1fil]{section in head/foot}
+      \usebeamerfont{section in head/foot}%
+      \ifbeamer at tree@showhooks
+      \setbox\beamer at tempbox=\hbox{\insertsectionhead}%
+      \ifdim\wd\beamer at tempbox>1pt%
+      \hskip2pt\raise1.9pt\hbox{\vrule width0.4pt height1.875ex\vrule width 5pt height0.4pt}%
+      \hskip1pt%
+      \fi%
+      \else%
+      \hskip6pt%
+      \fi%
+      \insertsectionhead
+    \end{beamercolorbox}
+    \begin{beamercolorbox}[wd=.44\paperwidth,ht=2.5ex,dp=1.125ex,%
+      leftskip=.3cm,rightskip=.3cm plus1fil]{subsection in head/foot}
+      \usebeamerfont{subsection in head/foot}%
+      \ifbeamer at tree@showhooks
+      \setbox\beamer at tempbox=\hbox{\insertsubsectionhead}%
+      \ifdim\wd\beamer at tempbox>1pt%
+      \hskip9.4pt\raise1.9pt\hbox{\vrule width0.4pt height1.875ex\vrule width 5pt height0.4pt}%
+      \hskip1pt%
+      \fi%
+      \else%
+      \hskip12pt%
+      \fi%
+      \insertsubsectionhead
+    \end{beamercolorbox}%
+    \vfill}%
+  \end{beamercolorbox}%
+  \begin{beamercolorbox}[wd=.1\paperwidth,ht=\@tempdimb,right]{right block}%
+    \vbox to\@tempdimb{\vfill\insertlogo\vfill}
+  \end{beamercolorbox}
+  \vfill
+  \begin{beamercolorbox}[wd=\paperwidth,colsep=1.5pt]{lower separation line head}
+  \end{beamercolorbox}
+}
+\setbeamercolor{separation line}{use=structure,bg=structure.fg!50!bg}
+
+\mode
+<all>
+%% 
+%% Copyright ?? 2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `beamerthemebidiJLTree.sty'.

Added: tags/texmf/tex/xelatex/bidi/bibitem.pdf
===================================================================
(Binary files differ)


Property changes on: tags/texmf/tex/xelatex/bidi/bibitem.pdf
___________________________________________________________________
Name: svn:executable
   + *
Name: svn:mime-type
   + application/octet-stream

Added: tags/texmf/tex/xelatex/bidi/bidi.sty
===================================================================
--- tags/texmf/tex/xelatex/bidi/bidi.sty	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/bidi/bidi.sty	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,364 @@
+%%
+%% This is file `bidi.sty',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% bidi.dtx  (with options: `bidi.sty')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\NeedsTeXFormat{LaTeX2e}
+\def\bididate{2009/06/27}
+\def\bidiversion{v1.0.1}
+\def\bidirevision{revision 54}
+\ProvidesPackage{bidi}[\bididate\space \bidiversion\space <\bidirevision>
+Bidirectional typesetting in XeLaTeX]
+\AtBeginDocument{\special{pdf: docinfo <<
+/Creator (Bidi \bidiversion\space <\bidirevision> Copyright ?? 2009 Vafa Khalighi)
+         >>}}
+\newif\if at RTLmain
+\newif\if at RTL
+\newif\if at RTLtab
+\newif\if at sentdir
+\newif\if at RTL@footnote
+\let\if at rlmain=\if at RTLmain
+\let\@rlmaintrue=\@RTLmaintrue
+\let\@rlmainfalse=\@RTLmainfalse
+\let\if at rl=\if at RTL
+\let\@rltrue=\@RTLtrue
+\let\@rlfalse=\@RTLfalse
+\let\if at rl@footnote=\if at RTL@footnote
+\let\@rl at footnotetrue=\@RTL at footnotetrue
+\let\@rl at footnotefalse=\@RTL at footnotefalse
+\let\if at tab@rl=\if at RTLtab
+\let\@tab at rltrue=\@RTLtabtrue
+\let\@tab at rlfalse=\@RTLtabfalse
+\@RTLmainfalse
+\RequirePackage{amsmath}
+\newcommand\bidi at isloaded[2][]{
+  \expandafter\ifx\csname if at bidi@#2loaded@\endcsname\relax
+    \expandafter\newif\csname if at bidi@#2loaded@\endcsname
+  \fi
+  \@ifpackageloaded{#2}
+    {\csname @bidi@#2loaded at true\endcsname #1}
+    {\csname @bidi@#2loaded at false\endcsname}}
+\bidi at isloaded{xunicode}
+\AtBeginDocument{
+  \if at bidi@xunicodeloaded@
+    \bidi at isloaded[\PackageError{bidi}{Oops! you have loaded package xunicode before bidi package. Please load package xunicode after bidi package, and then try to run xelatex on your document again}{}]{xunicode}
+  \fi%
+}
+\ifx\TeXXeTstate\undefined\else%
+   \TeXXeTstate=1
+\fi
+\ifx\beginR\@undefined%
+   \newlinechar`\^^J
+   \typeout{^^JTo avoid this error message,^^J%
+     run TeX--XeT or e-TeX engine instead of regular TeX.^^J}
+   \errmessage{Right-to-Left Support Error: use TeX--XeT or e-TeX
+     engine}%
+\fi
+\AtBeginDocument{%
+  \if at RTLmain\else
+    \if at RTL\@RTLmaintrue%
+    \else\@RTLmainfalse%
+    \fi%
+  \fi%
+}
+\def\Bidi at RTL@everypar{\if at RTL{\setbox\z@\lastbox\beginR\usebox\z@}\fi}
+   \let\o at everypar=\everypar
+   \newtoks\n at everypar
+   \n at everypar\expandafter{\the\o at everypar}
+   \o at everypar{\Bidi at RTL@everypar\the\n at everypar}
+   \let\everypar=\n at everypar
+\let\n at xt=\
+\def\LRE{\protect\pLRE}%
+\def\pLRE{\protect\afterassignment\moreLRE \let\n at xt= }
+\def\moreLRE{\bracetext \aftergroup\endL \beginL\@RTLfalse}
+\def\RLE{\protect\pRLE}
+\def\pRLE{\protect\afterassignment\moreRLE \let\n at xt= }
+\def\moreRLE{\bracetext \aftergroup\endR \beginR\@RTLtrue}
+\def\bracetext{\ifcat\n at xt{\else\ifcat\n at xt}\fi
+  \errmessage{Missing left brace has been substituted}\fi \bgroup}
+\def\lr#1{\begingroup\beginL\rmfamily#1\endL\endgroup}
+\def\LTR{\bgroup\par\@RTLfalse\@RTL at footnotefalse}
+\def\endLTR{\par\egroup}
+\def\RTL{\bgroup\par\@RTLtrue\@RTL at footnotetrue}
+\def\endRTL{\par\egroup}
+\def\ltr{\if at RTL\par\@RTLfalse\@RTL at footnotefalse\fi}
+\def\rtl{\if at RTL\relax\else\par\@RTLtrue\@RTL at footnotetrue\fi}
+\def\setRTL{\@RTLtrue\@RTL at footnotetrue}
+\def\setLTR{\@RTLfalse\@RTL at footnotefalse}
+\let\unsetRTL=\setLTR
+\let\unsetLTR=\setRTL
+\let\LR=\LRE
+\let\RL=\RLE
+\def\@ensure at RTL#1{\if at RTL#1\else\RLE{#1}\fi}
+\def\@ensure at LTR#1{\if at RTL\LRE{#1}\else#1\fi}
+\let\@ensure at RL=\@ensure at RTL
+\let\@ensure at LR=\@ensure at LTR
+\def\@ensure at dir#1{\if at RTL\RLE{#1}\else{#1}\fi}
+\let\@ensure at maindir=\@ensure at dir
+\def\@@RTL{RTL}
+\def\@@LTR{LTR}
+\def\save at dir{\if at RTL\gdef\saved@@dir{RTL}\else\gdef\saved@@dir{LTR}\fi}
+\def\reset at dir{\ifx\saved@@dir\@@RTL\setRTL\else\ifx\saved@@dir\@@LTR\setLTR\else\relax\fi\fi}
+\let\@@TeX\TeX
+\def\TeX{\@ensure at LTR{\@@TeX}}
+\let\@@LaTeX\LaTeX
+\def\LaTeX{\@ensure at LTR{\@@LaTeX}}
+\let\@@LaTeXe\LaTeXe
+\def\LaTeXe{\@ensure at LTR{\@@LaTeXe}}
+\def\reflect#1{{\setbox0=\hbox{#1}\rlap{\kern0.5\wd0
+  \special{x:gsave}\special{x:scale -1 1}}\box0 \special{x:grestore}}}
+\def\XeTeX{\LR{\leavevmode$\smash{\hbox{X\lower.5ex
+  \hbox{\kern-.125em\reflect{E}}\kern-.1667em \TeX}}$}}
+\def\XeLaTeX{\LR{\leavevmode$\smash{\hbox{X\lower.5ex
+  \hbox{\kern-.125em\reflect{E}}\kern-.1667em \LaTeX}}$}}
+\let\setRL=\setRTL
+\let\setLR=\setLTR
+\let\unsetRL=\setLTR
+\DeclareOption{RTLdocument}{\@RTLtrue\@RTL at footnotetrue\RTLdblcol\autofootnoterule}
+\DeclareOption{rldocument}{\@RTLtrue\@RTL at footnotetrue\RTLdblcol\autofootnoterule}
+\def\rcases#1{\left.\vcenter{\normalbaselines\m at th
+    \ialign{$##\hfil$&\quad{##}\hfil\crcr#1\crcr}}\,\right\}}
+\def\SepMark#1{\gdef\@SepMark{\if at RTL\beginR\fi#1\if at RTL\endR\fi}}
+\SepMark{.}
+\def\list#1#2{%
+  \ifnum \@listdepth >5\relax
+    \@toodeep
+  \else
+    \global\advance\@listdepth\@ne
+  \fi
+  \rightmargin\z@
+  \listparindent\z@
+  \itemindent\z@
+  \csname @list\romannumeral\the\@listdepth\endcsname
+  \def\@itemlabel{#1}%
+  \let\makelabel\@mklab
+  \@nmbrlistfalse
+  #2\relax
+  \@trivlist
+  \parskip\parsep
+  \parindent\listparindent
+  \advance\linewidth -\rightmargin
+  \advance\linewidth -\leftmargin
+  \if at RTL
+    \advance\@totalleftmargin \rightmargin
+  \else
+    \advance\@totalleftmargin \leftmargin
+  \fi
+  \parshape \@ne \@totalleftmargin \linewidth
+  \ignorespaces}
+\def\raggedright{%
+  \let\\\@centercr
+  \leftskip\z at skip\rightskip\@flushglue
+  \parindent\z@\parfillskip\z at skip}
+\let\@@raggedleft=\raggedleft
+\let\@@raggedright=\raggedright
+\renewcommand\raggedleft{\if at RTL\@@raggedright%
+                         \else\@@raggedleft\fi}
+\renewcommand\raggedright{\if at RTL\@@raggedleft%
+                          \else\@@raggedright\fi}
+\def\raggedright{%
+  \let\\\@centercr
+  \rightskip\z at skip\rightskip\@flushglue
+  \parindent\z@\parfillskip\z at skip}
+\renewcommand\raggedleft{\@@raggedleft}
+\renewcommand\raggedright{\@@raggedright}
+\def\centerline#1{%
+\if at RTL\@@line{\hss\beginR#1\endR\hss}
+\else\@@line{\hss#1\hss}\fi}
+\def\leftline#1{%
+\if at RTL\@@line{\beginR#1\endR\hss}
+\else\@@line{#1\hss}\fi}
+\def\rightline#1{%
+\if at RTL\@@line{\hss\beginR#1\endR}
+\else\@@line{\hss#1}\fi}
+\def\narrower{%
+  \advance\if at RTL\rightskip\else\leftskip\fi\parindent
+  \advance\if at RTL\leftskip\else\rightskip\fi\parindent}
+\def\leftmark{\beginR\expandafter\@leftmark\botmark\@empty\@empty\endR}
+\def\rightmark{\beginR\expandafter\@rightmark\firstmark\@empty\@empty\endR}
+\def\underline#1{%
+  \relax
+  \ifmmode\@@underline{#1}%
+  \else
+\if at RTL $\@@underline{\hbox{\beginR#1\endR}}\m at th$\relax
+\else
+$\@@underline{\hbox{#1}}\m at th$\relax\fi\fi}
+\if at compatibility
+   \let\undertext=\underline
+\fi
+\global\@RTLtabfalse
+\def\@tabular{\if at RTL\global\@RTLtabtrue\fi
+   \leavevmode \hbox \bgroup \if at RTLtab\beginR \fi
+   $\let\@acol\@tabacol
+   \let\@classz\@tabclassz
+   \let\@classiv\@tabclassiv \let\\\@tabularcr\@tabarray}
+\def\endtabular{\crcr\egroup\if at RTLtab\egroup\endR\egroup\fi
+                 \egroup $\if at RTLtab\endR\fi\egroup
+                 \global\@RTLtabfalse}
+\expandafter \let \csname endtabular*\endcsname = \endtabular
+\def\@array[#1]#2{%
+  \if #1t\vtop \else \if#1b\vbox \else \vcenter \fi\fi
+  \bgroup
+  \setbox\@arstrutbox\hbox{%
+    \vrule \@height\arraystretch\ht\strutbox
+           \@depth\arraystretch \dp\strutbox
+           \@width\z@}%
+  \@mkpream{#2}%
+  \edef\@preamble{%
+    \ialign \noexpand\@halignto
+      \bgroup \@arstrut \@preamble \tabskip\z at skip \cr}%
+  \let\@startpbox\@@startpbox \let\@endpbox\@@endpbox
+  \let\tabularnewline\\%
+    \let\par\@empty
+    \let\@sharp##%
+    \set at typeset@protect
+    \lineskip\z at skip\baselineskip\z at skip
+    \ifhmode \@preamerr\z@ \@@par\fi
+  \if at RTLtab\hbox\bgroup\beginR\vbox\bgroup\fi
+    \@preamble}
+\def\@testpach#1{\@chclass \ifnum \@lastchclass=\tw@ 4 \else
+    \ifnum \@lastchclass=3 5 \else
+     \z@ \if #1c\@chnum \z@ \else
+                              \if \if at RTLtab#1r\else#1l\fi\@chnum \@ne \else
+                              \if \if at RTLtab#1l\else#1r\fi\@chnum \tw@ \else
+          \@chclass \if #1|\@ne \else
+                    \if #1@\tw@ \else
+                    \if #1p3 \else \z@ \@preamerr 0\fi
+  \fi  \fi  \fi  \fi  \fi  \fi
+\fi}
+\def\@dottedtocline#1#2#3#4#5{%
+  \ifnum #1>\c at tocdepth \else
+    \vskip \z@ \@plus.2\p@
+    {\if at RTL\rightskip\else\leftskip\fi #2\relax \if at RTL\leftskip\else\rightskip\fi \@tocrmarg \parfillskip -\if at RTL\leftskip\else\rightskip\fi
+     \parindent #2\relax\@afterindenttrue
+     \interlinepenalty\@M
+     \leavevmode
+     \@tempdima #3\relax
+     \advance\if at RTL\rightskip\else\leftskip\fi \@tempdima \null\nobreak\hskip -\if at RTL\rightskip\else\leftskip\fi
+     {#4}\nobreak
+     \leaders\hbox{$\m at th
+        \mkern \@dotsep mu\hbox{.}\mkern \@dotsep
+        mu$}\hfill
+     \nobreak
+     \hb at xt@\@pnumwidth{\hfil\normalfont \normalcolor #5}%
+     \par}%
+  \fi}
+\def\RTL at outputdblcol{\if at firstcolumn
+\global\@firstcolumnfalse
+    \global\setbox\@leftcolumn\box\@outputbox
+  \else \global\@firstcolumntrue
+    \setbox\@outputbox\vbox{%
+     \hbox to\textwidth{%
+      \hbox to\columnwidth{\box\@outputbox \hss}%
+      \hfil \vrule width\columnseprule\hfil
+      \hbox to\columnwidth{\box\@leftcolumn \hss}%
+   }}\@combinedblfloats
+\@outputpage \begingroup \@dblfloatplacement
+\@startdblcolumn
+\@whilesw\if at fcolmade \fi
+{\@outputpage\@startdblcolumn}\endgroup
+    \fi}
+\def\LTR at outputdblcol{\if at firstcolumn
+\global\@firstcolumnfalse
+    \global\setbox\@leftcolumn\box\@outputbox
+  \else \global\@firstcolumntrue
+    \setbox\@outputbox\vbox{\hbox to\textwidth{%
+      \hbox to\columnwidth
+      {\box\@leftcolumn \hss}\hfil
+       \vrule width\columnseprule\hfil
+       \hbox to\columnwidth{\box\@outputbox \hss}}}%
+       \@combinedblfloats
+       \@outputpage \begingroup \@dblfloatplacement
+       \@startdblcolumn
+       \@whilesw\if at fcolmade \fi
+       {\@outputpage\@startdblcolumn}\endgroup
+    \fi}
+\newcommand{\RTLdblcol}{\renewcommand{\@outputdblcol}{\RTL at outputdblcol}}
+\newcommand{\LTRdblcol}{\renewcommand{\@outputdblcol}{\LTR at outputdblcol}}
+\long\def\@makecaption#1#2{%
+ \vskip 10pt%
+ \setbox\@tempboxa\hbox{#1: #2}%
+ \ifdim \wd\@tempboxa >\hsize \if at RTL\beginR\fi#1: #2\par%
+ \else \hbox
+to\hsize{\if at RTL\beginR\fi\hfil\box\@tempboxa\hfil%
+\if at RTL\endR\fi}%
+ \fi}
+\renewenvironment{equation}{%
+  \incr at eqnum
+  \mathdisplay at push
+  \st at rredfalse \global\@eqnswtrue
+  \beginL\mathdisplay{equation}%
+}{%
+  \endmathdisplay{equation}\endL%
+  \mathdisplay at pop
+  \ignorespacesafterend
+}
+\renewcommand{\numberwithin}[3][\arabic]{%
+  \@ifundefined{c@#2}{\@nocounterr{#2}}{%
+    \@ifundefined{c@#3}{\@nocnterr{#3}}{%
+      \@addtoreset{#2}{#3}%
+      \@xp\xdef\csname the#2\endcsname{%
+        \@xp\@nx\csname the#3\endcsname \@SepMark\@nx#1{#2}}}}%
+}
+\def\tagform@#1{\maketag@@@{)\ignorespaces\text{#1}\unskip\@@italiccorr(}}
+\renewcommand{\eqref}[1]{\beginL\textup{\tagform@{\ref{#1}}}\endL}
+\let\@@text=\text
+\def\text#1{\@@text{\if at RTL\beginR\fi#1\if at RTL\endR\fi}}
+\@ifpackageloaded{amsthm}{\input{amsthm-bidi.def}}{}
+\@ifpackageloaded{xltxtra}{\input{xltxtra-bidi.def}}{}
+\@ifpackageloaded{wrapfig}{\input{wrapfig-bidi.def}}{}
+\@ifpackageloaded{graphicx}{\input{graphicx-bidi.def}}{}
+\@ifpackageloaded{fancyhdr}{\input{fancyhdr-bidi.def}}{}
+\@ifpackageloaded{draftwatermark}{\input{draftwatermark-bidi.def}}{}
+\@ifpackageloaded{pdfpages}{\input{pdfpages-bidi.def}}{}
+\@ifpackageloaded{listings}{\input{listings-bidi.def}}{}
+\@ifpackageloaded{pstricks}{\input{pstricks-bidi.def}}{}
+\@ifpackageloaded{tikz}{\input{tikz-bidi.def}}{}
+\@ifpackageloaded{array}{\input{array-bidi.def}}{}
+\@ifpackageloaded{stabular}{\input{stabular-bidi.def}}{}
+\@ifpackageloaded{longtable}{\input{longtable-bidi.def}}{}
+\@ifpackageloaded{minitoc}{\input{minitoc-bidi.def}}{}
+\@ifpackageloaded{ragged2e}{\input{ragged2e-bidi.def}}{}
+\@ifpackageloaded{tabls}{\input{tabls-bidi.def}}{}
+\@ifpackageloaded{tocloft}{\input{tocloft-bidi.def}}{}
+\@ifpackageloaded{tocstyle}{\input{tocstyle-bidi.def}}{}
+\@ifclassloaded{article}{\input{article-bidi.def}}{}
+\@ifclassloaded{amsart}{\input{amsart-bidi.def}}{}
+\@ifclassloaded{refrep}{\input{refrep-bidi.def}}{}
+\@ifclassloaded{report}{\input{report-bidi.def}}{}
+\@ifclassloaded{rapport3}{\input{rapport3-bidi.def}}{}
+\@ifclassloaded{scrartcl}{\input{scrartcl-bidi.def}}{}
+\@ifclassloaded{scrbook}{\input{scrbook-bidi.def}}{}
+\@ifclassloaded{scrreprt}{\input{scrreprt-bidi.def}}{}
+\@ifclassloaded{amsbook}{\input{amsbook-bidi.def}}{}
+\@ifclassloaded{bookest}{\input{bookest-bidi.def}}{}
+\@ifclassloaded{extbook}{\input{extbook-bidi.def}}{}
+\@ifclassloaded{book}{\input{book-bidi.def}}{}
+\@ifclassloaded{beamer}{\input{beamer-bidi.def}}{}
+\input{footnote-bidi.def}
+\ProcessOptions
+
+%% 
+%% Copyright ?? 2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `bidi.sty'.

Added: tags/texmf/tex/xelatex/bidi/bidi2in1.sty
===================================================================
--- tags/texmf/tex/xelatex/bidi/bidi2in1.sty	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/bidi/bidi2in1.sty	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,86 @@
+%%
+%% This is file `bidi2in1.sty',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% bidi.dtx  (with options: `bidi2in1.sty')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\NeedsTeXFormat{LaTeX2e}
+\ProvidesPackage{bidi2in1}
+\pagestyle{plain}
+\newcount\evenpage
+\newcount\oddpage
+\twocolumn
+\def\@oddfoot{\evenpage=\thepage%
+\multiply\evenpage by 2%
+\oddpage=\the\evenpage%
+\advance\oddpage by -1%
+\hfil\the\evenpage\hfil\hfil\the\oddpage\hfil}%
+\def\@evenfoot{\evenpage=\thepage%
+\multiply\evenpage by 2%
+\oddpage=\the\evenpage%
+\advance\oddpage by -1%
+\hfil\the\oddpage\hfil\hfil\the\evenpage\hfil}%
+\textwidth 9.49in
+\textheight 6.7in
+\columnsep 0.9in
+\columnseprule 0.125pt
+\headheight 0cm
+\topmargin 0in
+\marginparwidth 0in
+\marginparsep 0in
+\hoffset 0.05in % Corrected
+\voffset -0.5in %top margin space is 1.0in by default
+\oddsidemargin 0in
+\evensidemargin 0in
+\headsep 0cm
+\topskip 0cm
+\parskip 0.15in       %
+\headsep 0pt
+\special{papersize=11.69in,8.26in}
+\renewcommand\maketitle{\par
+\begingroup
+\renewcommand\thefootnote{\@fnsymbol\c at footnote}%
+\def\@makefnmark{\rlap{\@textsuperscript{\normalfont\@thefnmark}}}%
+\long\def\@makefntext##1{\parindent 1em\noindent
+\hb at xt@1.8em{%
+\hss\@textsuperscript{\normalfont\@thefnmark}}##1}%
+\@maketitle
+\@thanks
+\endgroup
+\setcounter{footnote}{0}%
+\global\let\thanks\relax
+\global\let\maketitle\relax
+\global\let\@maketitle\relax
+\global\let\@thanks\@empty
+\global\let\@author\@empty
+\global\let\@date\@empty
+\global\let\@title\@empty
+\global\let\title\relax
+\global\let\author\relax
+\global\let\date\relax
+\global\let\and\relax
+}
+
+%% 
+%% Copyright ?? 2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `bidi2in1.sty'.

Added: tags/texmf/tex/xelatex/bidi/bidicode.sty
===================================================================
--- tags/texmf/tex/xelatex/bidi/bidicode.sty	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/bidi/bidicode.sty	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,166 @@
+%%
+%% This is file `bidicode.sty',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% bidi.dtx  (with options: `bidicode.sty')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\NeedsTeXFormat{LaTeX2e}
+\ProvidesPackage{bidicode}
+\RequirePackage{pstricks}
+\RequirePackage{fvrb-ex}
+\RequirePackage{showexpl}
+\definecolor{Orange}{rgb}{1,.4,.2}
+\definecolor{myblue}{rgb}{0.02,0.04,0.48}
+\definecolor{lightblue}{rgb}{0.61,.8,.8}
+\definecolor{myred}{rgb}{0.65,0.04,0.07}
+\definecolor{mygreen}{rgb}{0,.43,0}
+\definecolor{blendedred}{rgb}{0.9,0.1,0.1}
+\definecolor{blendedgreen}{rgb}{0.2,0.7,0.2}
+\definecolor{darkgray}{gray}{0.3}
+\definecolor{mygray}{gray}{0.6}
+\definecolor{skugga}{gray}{0.7}
+\definecolor{mybackground}{rgb}{1,0.8,0.5}
+\lstset{%
+    language=[LaTeX]TEX,%
+    float=hbp,%
+    basicstyle=\ttfamily\small, %
+    identifierstyle=\color{black}, %
+    keywordstyle=\color{myred}, %
+    stringstyle=\color{blue}, %
+    commentstyle=\color{blue}, %
+    columns=flexible, %
+    tabsize=4, %
+    frame=single, %
+    extendedchars=true, %
+    showspaces=false, %
+    showstringspaces=false, %
+    numbers=left,
+    numbersep=12pt,
+    numberstyle=\tiny, %
+    breaklines=true, %
+    breakautoindent=true,
+    captionpos=b,
+    xleftmargin=1em,
+    breaklines=true,
+    backgroundcolor=\color{mybackground},
+    breakautoindent=true,
+    rframe={},
+    explpreset={numbers=left,numberstyle=\tiny,numbersep=12pt,
+    xleftmargin=1em,columns=flexible,language=[LaTeX]TEX},
+   morekeywords={setLTR,setLR,setRTL,setRL,LRE,LR,RLE,RL,lr}
+}
+\lstdefinestyle{syntax}{backgroundcolor=\color{blue!20},numbers=none,xleftmargin=0pt,xrightmargin=0pt,
+    frame=single}
+\lstdefinestyle{code}{backgroundcolor=\color{red!20},numbers=left,xleftmargin=0pt,xrightmargin=0pt,
+    frame=single}
+
+\newcommand\Larg [1]{{\normalfont\itshape#1\/}}
+\newcommand\Larga[1]{$\langle$\Larg{#1}$\rangle$}
+\newcommand\Largb[1]{\lcb\Larg{#1}\rcb}
+\newcommand\Largs[1]{\lsb\Larg{#1}\rsb}
+\newcommand\Largr[1]{\lrb\Larg{#1}\rrb}
+\newcommand\LBEG[1]{{\normalfont\ttfamily\bs{}begin\lcb#1\rcb}}
+\newcommand\LEND[1]{{\normalfont\ttfamily\bs{}end\lcb#1\rcb}}
+
+\DeclareRobustCommand\bs{{\normalfont\ttfamily\textbackslash}}
+\DeclareRobustCommand\lcb{{\normalfont\ttfamily\textbraceleft}}
+\DeclareRobustCommand\rcb{{\normalfont\ttfamily\textbraceright}}
+\DeclareRobustCommand\lsb{{\normalfont\ttfamily[}}
+\DeclareRobustCommand\rsb{{\normalfont\ttfamily]}}
+\DeclareRobustCommand\lrb{{\normalfont\ttfamily(}}
+\DeclareRobustCommand\rrb{{\normalfont\ttfamily)}}
+
+\def\Lcs#1{\nxLcs{#1}}
+\def\LcsStar#1{\nxLcs{#1}\OptArg*{*}}
+\def\nxLcs#1{\texttt{\textbackslash#1}}
+
+\def\Coordx#1{$x_{#1}$}
+\def\Coordy#1{$y_{#1}$}
+\def\Coordz#1{$z_{#1}$}
+\def\Coord#1{\Coordx{#1},\kern 1pt\Coordy{#1}}
+\def\Coordn{\Coordx{n},\kern 1pt\Coordy{n}}
+\def\CoordIII#1{\Coordx{#1},\kern 1pt\Coordy{#1},\kern 1pt\Coordz{#1}}
+\def\CAny{\Coordx{},\kern 1pt\Coordy{}}
+\def\CIIIAny{\Coordx{},\kern 1pt\Coordy{},\kern 1pt\Coordz{}}
+\def\coord#1{(\Coordx{#1},\kern 1pt\Coordy{#1})}
+\def\coordn{(\Coordx{n},\kern 1pt\Coordy{n})}
+\def\coordiii#1{(\Coordx{#1},\kern 1pt\Coordy{#1},\kern 1pt\Coordz{#1})}
+\def\coordx#1{($x_{#1}$)}
+\def\coordy#1{($y_{#1}$)}
+\def\coordz#1{($z_{#1}$)}
+\def\cAny{(\Coordx{},\kern 1pt\Coordy{})}
+\def\ciiiAny{(\Coordx{},\kern 1pt\Coordy{},\kern 1pt\Coordz{})}
+
+\newsavebox{\boxdef}
+\newenvironment{BDef}
+  {\begin{lrbox}\boxdef
+      \def\arraystretch{1.0}
+      \begin{tabular}{@{}l@{}l@{}l@{}}
+  }
+  {\end{tabular}\end{lrbox}
+
+   {\BCmd\fbox{\usebox\boxdef}\endBCmd}
+   \aftergroup\@afterindentfalse\aftergroup\@afterheading
+  }
+
+\newenvironment{BDef*}
+  {\begin{lrbox}\boxdef
+      \def\arraystretch{1.0}
+      \begin{tabular}{@{}l@{}l@{}l@{}}
+  }
+  {\end{tabular}\end{lrbox}
+   {\begin{BCmd*}\fbox{\usebox\boxdef}\end{BCmd*}}
+   \aftergroup\@afterindentfalse\aftergroup\@afterheading
+  }
+\newenvironment{BCmd}{
+  \@beginparpenalty-\@lowpenalty
+  \topsep\BDefaboveskip
+  \fboxsep3pt
+  \flushleft}
+ {\@endparpenalty\@M
+  \@topsepadd\BDefbelowskip
+  \endflushleft}
+
+\newenvironment{BCmd*}{
+  \@beginparpenalty\@M
+  \topsep\BDefinlineskip
+  \fboxsep3pt
+  \flushleft}
+ {\@endparpenalty5000
+  \endflushleft}
+
+\newskip\BDefaboveskip
+\newskip\BDefbelowskip
+\newskip\BDefinlineskip
+\setlength\BDefaboveskip{10pt plus 4pt}
+\setlength\BDefbelowskip{6pt}
+\setlength\BDefinlineskip{6pt}
+
+\def\OptArgs{\psframebox[framesep=2pt,fillstyle=solid,fillcolor=black!20,linecolor=black!20]{\texttt{[Options]}}\kern1pt}
+\def\OptArg{\@ifnextchar*\OptArg at i{\OptArg at ii*}}
+\def\OptArg at i*#1{\psframebox[framesep=2pt,fillstyle=solid,fillcolor=black!20,linecolor=black!20]{\texttt{#1}}\kern1pt}
+\def\OptArg at ii*#1{\psframebox[framesep=2pt,fillstyle=solid,fillcolor=black!20,linecolor=black!20]{\texttt{[#1]}}\kern1pt}
+
+%% 
+%% Copyright ?? 2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `bidicode.sty'.

Added: tags/texmf/tex/xelatex/bidi/bidimemoir.cls
===================================================================
--- tags/texmf/tex/xelatex/bidi/bidimemoir.cls	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/bidi/bidimemoir.cls	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,11674 @@
+%%
+%% This is file `bidimemoir.cls',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% bidi.dtx  (with options: `bidimemoir.cls')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+%%
+%% This is file `bidimemoir.cls',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% bidimemoir.dtx  (with options: `class')
+%%
+%%   Author: Peter Wilson  (herries dot press at earthlink dot net)
+%%           Herries Press
+%%   Copyright 2001--2008 Peter R. Wilson
+%%
+%%   This work may be distributed and/or modified under the
+%%   conditions of the LaTeX Project Public License, either
+%%   version 1.3 of this license or (at your option) any
+%%   later version.
+%%   The latest version of the license is in
+%%      http://www.latex-project.org/lppl.txt
+%%   and version 1.3 or later is part of all distributions of
+%%   LaTeX version 2003/06/01 or later.
+%%
+%%   This work has the LPPL maintenance status "author-maintained".
+%%
+%%   This work consists of the files listed in the README file.
+%%
+\NeedsTeXFormat{LaTeX2e}
+\ProvidesClass{bidimemoir}%
+  [2009/06/10 modified memoir document class for bidi typesetting in XeLaTeX]
+\newcommand*{\@ptsize}{}
+\newcommand*{\@memptsize}{}
+\newlength{\onelineskip}
+\newlength{\lxvchars}
+\newlength{\xlvchars}
+\newcount\@memcnta
+\newcounter{@memmarkcntra}
+\newif\if at restonecol
+\newif\if at openright
+  \@openrighttrue
+
+\newif\if at openleft
+  \@openleftfalse
+
+\newif\if at mainmatter
+  \@mainmattertrue
+
+\newif\if at memoldfont
+  \@memoldfontfalse
+
+\newif\ifextrafontsizes
+  \extrafontsizesfalse
+
+\newcommand*{\@memerror}{\ClassError{bidimemoir}}
+\newcommand*{\@memwarn}{\ClassWarning{bidimemoir}}
+
+\newif\ifsamename
+\newcommand{\nametest}[2]{%
+  \samenamefalse
+  \begingroup
+  \def\@memtempa{#1} \def\@memtempb{#2}
+  \ifx \@memtempa\@memtempb
+    \endgroup
+    \samenametrue
+  \else
+    \endgroup
+  \fi}
+
+\newif\ifm at m@And
+\newif\ifm at m@Or
+\newif\ifm at m@Xor
+
+\newcommand{\kill at lastcounter}[1]{%
+  \count\count10 \z@
+  \advance\count10 \m at ne
+  \expandafter\let\csname c@#1\endcsname\relax}
+
+\newcommand{\@name at p@xdef}[1]{%
+  \expandafter\protected at xdef\csname #1\endcsname}
+\newcommand{\@name at unresp@xdef}[1]{%
+  \expandafter\unrestored at protected@xdef\csname #1\endcsname}
+\newcommand{\@namelet}[1]{%
+  \expandafter\let\csname #1\endcsname}
+\newcommand{\@namelongdef}[1]{%
+  \long\expandafter\def\csname #1\endcsname}
+\newcommand{\@nameedef}[1]{%
+  \expandafter\protected at edef\csname #1\endcsname}
+
+\newcommand{\memjustarg}[1]{#1}
+\newcommand{\memgobble}[1]{}
+
+\newcommand*{\@memfakeusepackage}[1]{%
+  \@namelet{ver@#1.sty}\@empty}
+
+\providecommand*{\EmulatedPackage}{}
+\renewcommand*{\EmulatedPackage}[1]{%
+  \@ifnextchar[{\@emulated at package{#1}}%
+               {\@emulated at package{#1}[\@empty]}%]
+}
+\providecommand*{\EmulatedPackageWithOptions}{}
+\renewcommand*{\EmulatedPackageWithOptions}[2]{%
+  \PassOptionsToPackage{#1}{#2}%
+  \EmulatedPackage{#2}%
+}
+\def\@emulated at package#1[#2]{%
+  \expandafter\xdef\csname ver@#1.\@pkgextension\endcsname{#2}%
+  \@ifundefined{opt@#1.\@pkgextension}%
+    {\@namedef{opt@#1.\@pkgextension}{}}{}%
+  \wlog{Package #1 \ifx\@empty#2\else[#2] \fi
+        \if,\csname opt@#1.\@pkgextension\endcsname,\else
+        (with options \csname opt@#1.\@pkgextension\endcsname) \fi
+        emulated by \@currname.}%
+}
+\@onlypreamble\EmulatedPackage
+\@onlypreamble\EmulatedPackageWithOptions
+\@onlypreamble\@emulated at package
+
+\newcommand*{\DisemulatePackage}[1]{%
+  \@namelet{ver@#1.\@pkgextension}\relax}
+\@onlypreamble\DisemulatePackage
+
+\renewcommand{\InputIfFileExists}[2]{%
+  \IfFileExists{#1}%
+    {#2\@addtofilelist{#1}\m at matbeginf{#1}%
+     \@@input \@filef at und
+     \m at matendf{#1}%
+     \killm at matf{#1}}}
+
+\newcommand{\m at matbeginf}[1]{\@ifundefined{#1-m at mfb}{}%
+  {\@nameuse{#1-m at mfb}}}
+\newcommand{\m at matendf}[1]{\@ifundefined{#1-m at mfe}{}%
+  {\@nameuse{#1-m at mfe}}}
+
+\newcommand*{\killm at matf}[1]{%
+  \@namelet{#1-m at mfb}\relax
+  \@namelet{#1-m at mfe}\relax}
+
+\newcommand{\AtBeginFile}[2]{\@ifundefined{#1-m at mfb}%
+  {\@namedef{#1-m at mfb}{#2}}%
+  {\expandafter\addtodef\csname #1-m at mfb\endcsname{}{#2}}}
+\newcommand{\AtEndFile}[2]{\@ifundefined{#1-m at mfe}%
+  {\@namedef{#1-m at mfe}{#2}}%
+  {\expandafter\addtodef\csname #1-m at mfe\endcsname{}{#2}}}
+
+\newcommand{\AtBeginPackage}[2]{%
+  \AtBeginFile{#1.\@pkgextension}{#2}}
+\newcommand{\AtEndPackage}[2]{%
+  \AtEndFile{#1.\@pkgextension}{#2}}
+\newcommand{\RequireAtEndPackage}[2]{%
+  \@ifpackageloaded{#1}{#2}%
+  {\AtEndFile{#1.\@pkgextension}{#2}}}
+
+\newcommand{\AtBeginClass}[2]{%
+  \AtBeginFile{#1.\@clsextension}{#2}}
+\newcommand{\AtEndClass}[2]{%
+  \AtEndFile{#1.\@clsextension}{#2}}
+\newcommand{\RequireAtEndClass}[2]{%
+  \@ifclassloaded{#1}{#2}%
+  {\AtEndFile{#1.\@clsextension}{#2}}}
+
+\newcommand{\phantomsection}{}
+
+ \renewcommand*{\nofiles}{%
+   \@fileswfalse%  flag for suppressing \immediate \writes
+   \typeout{No auxiliary output files.^^J}%
+   \long\def\protected at write##1##2##3%
+     {\write\m at ne{}\if at nobreak\ifvmode\nobreak\fi\fi}%
+   }
+
+\newcommand*{\memsetcounter}[2]{\setcounter{#1}{#2}}
+\AtBeginDocument{\immediate\write\@mainaux{%
+  \string\providecommand*{\string\memsetcounter}[2]{}}}
+
+\def\bs{\texttt{\char`\\}}
+\ifx\l at nohyphenation\undefined
+  \newlanguage\l at nohyphenation
+\fi
+\DeclareRobustCommand{\meta}[1]{%
+  \ensuremath\langle
+  \ifmmode \expandafter \nfss at text \fi
+  {%
+    \meta at font@select
+    \edef\meta at hyphen@restore
+      {\hyphenchar\the\font\the\hyphenchar\font}%
+    \hyphenchar\font\m at ne
+    \language\l at nohyphenation
+    #1\/%
+    \meta at hyphen@restore
+  }\ensuremath\rangle
+}
+\def\meta at font@select{\itshape}
+
+\DeclareRobustCommand{\marg}[1]{%
+  {\ttfamily\char`\{}\meta{#1}{\ttfamily\char`\}}}
+\DeclareRobustCommand{\oarg}[1]{%
+  {\ttfamily\char`\[}\meta{#1}{\ttfamily\char`\]}}
+\DeclareRobustCommand{\parg}[1]{%
+  {\ttfamily\char`\(}\meta{#1}{\ttfamily\char`\)}}
+\DeclareRobustCommand{\cs}[1]{\texttt{\char`\\#1}}
+\newcommand{\cmdprint}[1]{\texttt{\string#1}}
+\newcommand{\cmd}[1]{\cmdprint{#1}%
+  \index{\expandafter\@gobble\string#1?\string\cmdprint{\string#1}}}
+
+\newif\ifm at mifpdf
+  \m at mifpdffalse
+\IfFileExists{ifpdf.sty}{\RequirePackage{ifpdf}\relax}{%
+  \ClassWarningNoLine{bidimemoir}{%
+    Package `ifpdf' is not installed.\MessageBreak
+    The package is being emulated}%
+\m at mifpdftrue
+\newif\ifpdf
+  \pdffalse
+\ifx\pdfoutput\undefined
+\else
+  \ifx\pdfoutput\@undefined
+  \else
+    \ifx\pdfoutput\relax
+    \else
+      \ifnum\pdfoutput>0\relax
+        \pdftrue
+      \fi
+    \fi
+  \fi
+\fi
+%%\EmulatedPackage{ifpdf}[2008/07/23]
+}
+
+\newif\ifm at mifetex
+  \m at mifetexfalse
+\IfFileExists{ifetex.sty}{\RequirePackage{ifetex}\relax}{%
+  \ClassInfo{bidimemoir}{%
+    An `ifetex' package is being emulated}%
+\m at mifetextrue
+\newif\ifetex
+  \etexfalse
+\ifx\eTeXversion\undefined
+\else
+  \ifx\eTeXversion\@undefined
+  \else
+    \ifx\eTeXversion\relax
+    \else
+      \ifnum\eTeXversion>0\relax
+        \etextrue
+      \fi
+    \fi
+  \fi
+\fi
+%%\EmulatedPackage{ifetex}[2008/07/23]
+}
+
+\newif\ifm at mifxetex
+  \m at mifxetexfalse
+\IfFileExists{ifxetex.sty}{\RequirePackage{ifxetex}\relax}{%
+  \ClassWarningNoLine{bidimemoir}{%
+    The `ifxetex' package is not installed.\MessageBreak
+    The package is being emulated}%
+\newif\ifxetex
+\@ifundefined{XeTeXrevision}{\xetexfalse}{\xetextrue}
+%%\EmulatedPackage{ifxetex}[2008/07/23]
+}
+\ifm at mifxetex
+\def\RequireXeTeX{%
+  \ifxetex\else
+  \@memerror{XeTeX is required to process this document}%
+            {Try again with xelatex, not (pdf)latex.\MessageBreak
+             Or try removing any XeTeX package(s).}
+  \fi}
+\fi
+
+\newif\ifm at mifluatex
+  \m at mifluatexfalse
+\IfFileExists{ifluatex.sty}{\RequirePackage{ifluatex}\relax}{%
+  \ClassWarningNoLine{bidimemoir}{%
+    The `ifluatex' package is not installed.\MessageBreak
+    The package is being emulated}%
+\m at mifluatextrue
+\newif\ifluatex
+  \luatexfalse
+\ifx\luatexversion\@undefined
+\else
+  \ifx\luatexversion\undefined
+  \else
+    \ifx\luatexversion\relax
+    \else
+      \luatextrue
+    \fi
+  \fi
+\fi
+%%\EmulatedPackage{ifluatex}[2008/07/23]
+}
+
+\edef\wo at dmacro{%
+  \string m\string a\string c\string r\string o\string :%
+}
+
+\def\wo at difmacro@begingroup#1{%
+  \begingroup
+    \edef\x{%
+      \noexpand\wo at dparsemacro\meaning#1\wo at dmacro\string -%
+    }%
+    \x\@nil{#1}%
+}
+
+\begingroup
+  \edef\x{\endgroup
+    \def\noexpand\wo at dparsemacro##1\wo at dmacro##2\string -}%
+\x#3\@nil#4{%
+  \ifx\\#3\\%
+    \endgroup
+    \@memwarn{\string `\string #4\string ' is not a macro}%
+    \expandafter\@gobble
+  \else
+    \expandafter\@firstofone
+  \fi
+}
+
+\def\addtodef{\@star at or@long\wo at daddtodef}
+\long\def\wo at daddtodef#1#2#3{%
+  \wo at difmacro@begingroup{#1}{%
+    \@temptokena{#2}%
+    \toks@\expandafter{#1#3}%
+    \edef\x{\endgroup
+         \l at ngrel@x\def\noexpand#1{\the\@temptokena \the\toks@}}%
+    \x
+  }%
+}
+
+\def\addtoiargdef{\@star at or@long\wo at daddtoiargdef}
+\long\def\wo at daddtoiargdef#1#2#3{%
+  \wo at difmacro@begingroup{#1}{%
+    \@temptokena{#2}%
+    \toks@\expandafter{#1{##1}#3}%
+    \edef\x{\endgroup
+       \l at ngrel@x\def\noexpand#1####1{\the\@temptokena \the\toks@}}%
+    \x
+  }%
+}
+
+%%%%%%%%%%%%%%%% Michael Downes' patchcmd 2000/07/31 v1.03 %%%%%%%%
+\newcommand{\patchcommand}[1]{%
+  \expandafter\patchcmd at a\meaning#1??->@\@nil#1%
+}
+\long\def\patchcmd at a#1#2#3->#4#5\@nil#6{%
+  \ifx @#4\relax \patchcmdError#6#1%
+    \expandafter\@gobbletwo % discard the other two arguments
+  \else
+    \if l#2\toks@{\patchcmd at e{}#6}% l in this position means \long
+    \else \toks@{\patchcmd at e*#6}%   not \long
+    \fi
+    \patchcmd at b #3@#4#5 ? ? ? \@nil#6%
+    \expandafter\the\expandafter\toks@
+  \fi}
+\def\patchcmd at b#1:#2@#3#4 #5#6 #7 #8\@nil#9{%
+  \if \ifx @#7@\expandafter
+      \ifx\csname #6\endcsname#9T\else F\fi\else F\fi T%
+    \toks@\expandafter{\expandafter\patchcommand\csname #6 \endcsname}%
+  \else
+    \ifx @#2@% No arguments
+      \toks@\expandafter{\the\toks@ 0}%
+    \else
+      \patchcmd at c 0#2{\string##}0%
+    \fi
+  \fi}
+\def\patchcmd at c#1#2#3{%
+  \if\string###2%      % yes it's a # token
+    \ifodd 0#31 % and it's followed by a number
+      \if 0#3\patchcmd at d#1\fi % number=0? then we're done
+    \else \patchcmd at d D% # not a number: must be a delimited arg
+    \fi
+  \else \patchcmd at d D% not a # token: must be a delmited arg
+  \fi
+  \patchcmd at c#3}
+\def\patchcmd at d#1{%
+  \if D#1%
+%%%    \PackageError{patchcmd}{Cannot change a macro that has
+%%%      delimited arguments}\@ehd
+    \@memerror{%
+      Cannot change a macro that has delimited arguments}{\@ehd}
+  \else
+    \toks@\expandafter{\the\toks@ #1}%
+  \fi
+  \begingroup
+  \aftergroup\@gobble
+  \let\patchcmd at c\endgroup}
+\def\patchcmd at e#1#2#3#4#5{%
+  \begingroup
+  \edef\@##1{%
+    \@temptokena\noexpand\expandafter{%
+      \noexpand#2%
+        \ifnum#3>0 {####1}\ifnum#3>1 {####2}\ifnum#3>2 {####3}%
+        \ifnum#3>3 {####4}\ifnum#3>4 {####5}\ifnum#3>5 {####6}%
+        \ifnum#3>6 {####7}\ifnum#3>7 {####8}\ifnum#3>8 {####9}%
+        \fi\fi\fi\fi\fi\fi\fi\fi\fi
+      ##1%
+    }%
+  }
+  \@{#5}%
+  \edef\@##1{\endgroup
+    \noexpand\renewcommand#1\noexpand#2\ifcase#3 \else [#3]\fi
+    {##1\the\@temptokena}}%
+  \@{#4}%
+}
+\long\def\patchcmdError#1#2{%
+  \begingroup
+  \toks@{Not redefinable}%
+  \ifcat\relax\noexpand#1% Is it a control sequence?
+    \begingroup
+    \let#1=?\ifx ?\relax % Is it "\relax"?
+      \endgroup % accept current value of \toks@
+    \else \endgroup
+      \if\ifx\relax#1u\else #2\fi u%
+        \toks@{Not defined}%
+      \fi
+    \fi
+  \fi
+  \edef\@{\endgroup
+%%%    \noexpand\PackageError{patchcmd}{%
+%%%      \the\toks@: \string#1}\noexpand\@ehd}%
+    \noexpand\@memerror{%
+      \the\toks@: \string#1}\noexpand\@ehd}%
+  \@}
+
+%%%%%%%%%%%%%%%%%%%%% end of patchcmd code %%%%%%%%%%%%%%%%%%%%%%%%%%%
+
+%%\@memfakeusepackage{patchcmd}
+
+\newlength{\stockheight}
+\newlength{\stockwidth}
+\newlength{\trimtop}
+\newlength{\trimedge}
+
+\newcommand*{\stockdbill}     {\stockheight=7in    \stockwidth=3in}
+\newcommand*{\stockstatement} {\stockheight=8.5in  \stockwidth=5.5in}
+\newcommand*{\stockexecutive} {\stockheight=10.5in \stockwidth=7.25in}
+\newcommand*{\stockletter}    {\stockheight=11in   \stockwidth=8.5in}
+\newcommand*{\stockold}       {\stockheight=12in   \stockwidth=9in}
+\newcommand*{\stocklegal}     {\stockheight=14in   \stockwidth=8.5in}
+\newcommand*{\stockledger}    {\stockheight=17in   \stockwidth=11in}
+\newcommand*{\stockbroadsheet}{\stockheight=22in   \stockwidth=17in}
+
+\newcommand*{\stockpottvo}      {\stockheight=6.25in \stockwidth=4in}
+\newcommand*{\stockfoolscapvo}  {\stockheight=6.75in \stockwidth=4.25in}
+\newcommand*{\stockcrownvo}     {\stockheight=7.5in  \stockwidth=5in}
+\newcommand*{\stockpostvo}      {\stockheight=8in    \stockwidth=5in}
+\newcommand*{\stocklargecrownvo}{\stockheight=8in    \stockwidth=5.25in}
+\newcommand*{\stocklargepostvo} {\stockheight=8.25in \stockwidth=5.25in}
+\newcommand*{\stocksmalldemyvo} {\stockheight=8.5in  \stockwidth=5.675in}
+\newcommand*{\stockdemyvo}      {\stockheight=8.75in  \stockwidth=5.675in}
+\newcommand*{\stockmediumvo}    {\stockheight=9in     \stockwidth=5.75in}
+\newcommand*{\stocksmallroyalvo}{\stockheight=9.25in  \stockwidth=6.175in}
+\newcommand*{\stockroyalvo}     {\stockheight=10in    \stockwidth=6.25in}
+\newcommand*{\stocksuperroyalvo}{\stockheight=10.25in \stockwidth=6.75in}
+\newcommand*{\stockimperialvo}  {\stockheight=11in    \stockwidth=7.5in}
+
+\newcommand*{\stockmcrownvo}      {\stockheight=186mm \stockwidth=123mm}
+\newcommand*{\stockmlargecrownvo} {\stockheight=198mm \stockwidth=129mm}
+\newcommand*{\stockmdemyvo}       {\stockheight=216mm \stockwidth=138mm}
+\newcommand*{\stockmsmallroyalvo} {\stockheight=234mm \stockwidth=156mm}
+
+\newcommand*{\stockao}  {\stockheight=1189mm \stockwidth=841mm}
+\newcommand*{\stockai}  {\stockheight=841mm \stockwidth=594mm}
+\newcommand*{\stockaii} {\stockheight=594mm \stockwidth=420mm}
+\newcommand*{\stockaiii}{\stockheight=420mm \stockwidth=297mm}
+\newcommand*{\stockaiv} {\stockheight=297mm \stockwidth=210mm}
+\newcommand*{\stockav}  {\stockheight=210mm \stockwidth=148mm}
+\newcommand*{\stockavi} {\stockheight=148mm \stockwidth=105mm}
+
+\newcommand*{\stockbo}  {\stockheight=1414mm \stockwidth=1000mm}
+\newcommand*{\stockbi}  {\stockheight=1000mm \stockwidth=707mm}
+\newcommand*{\stockbii} {\stockheight=707mm \stockwidth=500mm}
+\newcommand*{\stockbiii}{\stockheight=500mm \stockwidth=353mm}
+\newcommand*{\stockbiv} {\stockheight=353mm \stockwidth=250mm}
+\newcommand*{\stockbv}  {\stockheight=250mm \stockwidth=176mm}
+\newcommand*{\stockbvi} {\stockheight=176mm \stockwidth=125mm}
+
+\newcommand*{\pagedbill}     {\paperheight=7in    \paperwidth=3in}
+\newcommand*{\pagestatement} {\paperheight=8.5in  \paperwidth=5.5in}
+\newcommand*{\pageexecutive} {\paperheight=10.5in \paperwidth=7.25in}
+\newcommand*{\pageletter}    {\paperheight=11in   \paperwidth=8.5in}
+\newcommand*{\pageold}       {\paperheight=12in   \paperwidth=9in}
+\newcommand*{\pagelegal}     {\paperheight=14in   \paperwidth=8.5in}
+\newcommand*{\pageledger}    {\paperheight=17in   \paperwidth=11in}
+\newcommand*{\pagebroadsheet}{\paperheight=22in   \paperwidth=17in}
+
+\newcommand*{\pagepottvo}      {\paperheight=6.25in \paperwidth=4in}
+\newcommand*{\pagefoolscapvo}  {\paperheight=6.75in \paperwidth=4.25in}
+\newcommand*{\pagecrownvo}     {\paperheight=7.5in  \paperwidth=5in}
+\newcommand*{\pagepostvo}      {\paperheight=8in    \paperwidth=5in}
+\newcommand*{\pagelargecrownvo}{\paperheight=8in    \paperwidth=5.25in}
+\newcommand*{\pagelargepostvo} {\paperheight=8.25in \paperwidth=5.25in}
+\newcommand*{\pagesmalldemyvo} {\paperheight=8.5in  \paperwidth=5.675in}
+\newcommand*{\pagedemyvo}      {\paperheight=8.75in  \paperwidth=5.675in}
+\newcommand*{\pagemediumvo}    {\paperheight=9in     \paperwidth=5.75in}
+\newcommand*{\pagesmallroyalvo}{\paperheight=9.25in  \paperwidth=6.175in}
+\newcommand*{\pageroyalvo}     {\paperheight=10in    \paperwidth=6.25in}
+\newcommand*{\pagesuperroyalvo}{\paperheight=10.25in \paperwidth=6.75in}
+\newcommand*{\pageimperialvo}  {\paperheight=11in    \paperwidth=7.5in}
+
+\newcommand*{\pagemcrownvo}      {\paperheight=186mm \paperwidth=123mm}
+\newcommand*{\pagemlargecrownvo} {\paperheight=198mm \paperwidth=129mm}
+\newcommand*{\pagemdemyvo}       {\paperheight=216mm \paperwidth=138mm}
+\newcommand*{\pagemsmallroyalvo} {\paperheight=234mm \paperwidth=156mm}
+
+\newcommand*{\pageao}  {\paperheight=1189mm \paperwidth=841mm}
+\newcommand*{\pageai}  {\paperheight=841mm \paperwidth=594mm}
+\newcommand*{\pageaii} {\paperheight=594mm \paperwidth=420mm}
+\newcommand*{\pageaiii}{\paperheight=420mm \paperwidth=297mm}
+\newcommand*{\pageaiv} {\paperheight=297mm \paperwidth=210mm}
+\newcommand*{\pageav}  {\paperheight=210mm \paperwidth=148mm}
+\newcommand*{\pageavi} {\paperheight=148mm \paperwidth=105mm}
+
+\newcommand*{\pagebo}  {\paperheight=1414mm \paperwidth=1000mm}
+\newcommand*{\pagebi}  {\paperheight=1000mm \paperwidth=707mm}
+\newcommand*{\pagebii} {\paperheight=707mm \paperwidth=500mm}
+\newcommand*{\pagebiii}{\paperheight=500mm \paperwidth=353mm}
+\newcommand*{\pagebiv} {\paperheight=353mm \paperwidth=250mm}
+\newcommand*{\pagebv}  {\paperheight=250mm \paperwidth=176mm}
+\newcommand*{\pagebvi} {\paperheight=176mm \paperwidth=125mm}
+
+\DeclareOption{a0paper}{\stockao}
+\DeclareOption{a1paper}{\stockai}
+\DeclareOption{a2paper}{\stockaii}
+\DeclareOption{a3paper}{\stockaiii}
+\DeclareOption{a4paper}{\stockaiv}
+\DeclareOption{a5paper}{\stockav}
+\DeclareOption{a6paper}{\stockavi}
+\DeclareOption{b0paper}{\stockbo}
+\DeclareOption{b1paper}{\stockbi}
+\DeclareOption{b2paper}{\stockbii}
+\DeclareOption{b3paper}{\stockbiii}
+\DeclareOption{b4paper}{\stockbiv}
+\DeclareOption{b5paper}{\stockbv}
+\DeclareOption{b6paper}{\stockbvi}
+\DeclareOption{mcrownvopaper}{\stockmcrownvo}
+\DeclareOption{mlargecrownvopaper}{\stockmlargecrownvo}
+\DeclareOption{mdemyvopaper}{\stockmdemyvo}
+\DeclareOption{msmallroyalvopaper}{\stockmsmallroyalvo}
+
+\DeclareOption{dbillpaper}{\stockdbill}
+\DeclareOption{statementpaper}{\stockstatement}
+\DeclareOption{executivepaper}{\stockexecutive}
+\DeclareOption{letterpaper}{\stockletter}
+\DeclareOption{oldpaper}{\stockold}
+\DeclareOption{legalpaper}{\stocklegal}
+\DeclareOption{ledgerpaper}{\stockledger}
+\DeclareOption{broadsheetpaper}{\stockbroadsheet}
+
+\DeclareOption{pottvopaper}{\stockpottvo}
+\DeclareOption{foolscapvopaper}{\stockfoolscapvo}
+\DeclareOption{crownvopaper}{\stockcrownvo}
+\DeclareOption{postvopaper}{\stockpostvo}
+\DeclareOption{largecrownvopaper}{\stocklargecrownvo}
+\DeclareOption{largepostvopaper}{\stocklargepostvo}
+\DeclareOption{smalldemyvopaper}{\stocksmalldemyvo}
+\DeclareOption{demyvopaper}{\stockdemyvo}
+\DeclareOption{mediumvopaper}{\stockmediumvo}
+\DeclareOption{smallroyalvopaper}{\stocksmallroyalvo}
+\DeclareOption{royalvopaper}{\stockroyalvo}
+\DeclareOption{superroyalvopaper}{\stocksuperroyalvo}
+\DeclareOption{imperialvopaper}{\stockimperialvo}
+
+\DeclareOption{ebook}
+   {\setlength\stockheight {9in}%
+    \setlength\stockwidth  {6in}}
+
+\newif\ifmemlandscape
+  \memlandscapefalse
+\DeclareOption{landscape}{\memlandscapetrue}
+\DeclareOption{portrait}{\memlandscapefalse}
+
+\renewcommand*{\@ptsize}{0}
+\renewcommand*{\@memptsize}{10}
+\DeclareOption{9pt}{\renewcommand*{\@ptsize}{9}\renewcommand*{\@memptsize}{9}}
+\DeclareOption{10pt}{\renewcommand*{\@ptsize}{0}\renewcommand*{\@memptsize}{10}}
+\DeclareOption{11pt}{\renewcommand*{\@ptsize}{1}\renewcommand*{\@memptsize}{11}}
+\DeclareOption{12pt}{\renewcommand*{\@ptsize}{2}\renewcommand*{\@memptsize}{12}}
+\DeclareOption{14pt}{\renewcommand*{\@ptsize}{4}\renewcommand*{\@memptsize}{14}}
+\DeclareOption{17pt}{\renewcommand*{\@ptsize}{7}\renewcommand*{\@memptsize}{17}}
+\DeclareOption{20pt}{\renewcommand*{\@ptsize}{20}\renewcommand*{\@memptsize}{20}}
+\DeclareOption{25pt}{\renewcommand*{\@ptsize}{25}\renewcommand*{\@memptsize}{25}}
+\DeclareOption{30pt}{\renewcommand*{\@ptsize}{30}\renewcommand*{\@memptsize}{30}}
+\DeclareOption{36pt}{\renewcommand*{\@ptsize}{36}\renewcommand*{\@memptsize}{36}}
+\DeclareOption{48pt}{\renewcommand*{\@ptsize}{48}\renewcommand*{\@memptsize}{48}}
+\DeclareOption{60pt}{\renewcommand*{\@ptsize}{60}\renewcommand*{\@memptsize}{60}}
+
+\newif\if at nyptsizeopt
+  \@nyptsizeoptfalse
+\providecommand*{\anyptfilebase}{mem}
+\providecommand*{\anyptsize}{10}
+\DeclareOption{*pt}{\@nyptsizeopttrue}
+
+\DeclareOption{twoside}{\@twosidetrue  \@mparswitchtrue}
+\DeclareOption{oneside}{\@twosidefalse \@mparswitchfalse}
+\DeclareOption{onecolumn}{\@twocolumnfalse}
+\DeclareOption{twocolumn}{\@twocolumntrue}
+\newif\ifdraftdoc\draftdocfalse
+\setlength{\overfullrule}{\z@}
+\DeclareOption{final}{\setlength{\overfullrule}{\z@}
+                      \draftdocfalse
+                      \msdocfalse}
+\DeclareOption{draft}{\setlength\overfullrule{5pt}%
+                      \draftdoctrue
+                      \msdocfalse}
+\newif\ifmsdoc
+  \msdocfalse
+\DeclareOption{ms}{%
+  \msdoctrue
+  \draftdocfalse
+  \setlength\overfullrule{\z@}
+}
+
+\newif\ifshowtrims
+  \showtrimsfalse
+\DeclareOption{showtrims}{\showtrimstrue}
+
+\newif\ifartopt
+  \artoptfalse
+\DeclareOption{article}{\artopttrue}
+
+\DeclareOption{openright}{\@openrighttrue}
+\DeclareOption{openany}{\@openrightfalse}
+\DeclareOption{openleft}{\@openlefttrue}
+\newcommand{\openright}{\@openrighttrue\@openleftfalse%
+  \gdef\clearforchapter{\cleartorecto}}
+\newcommand{\openany}{\@openrightfalse\@openleftfalse%
+  \gdef\clearforchapter{\clearpage}}
+\newcommand{\openleft}{\@openlefttrue
+  \gdef\clearforchapter{\cleartoverso}}
+
+\DeclareOption{leqno}{\input{leqno.clo}}
+\DeclareOption{fleqn}{\input{fleqn.clo}}
+\DeclareOption{openbib}{%
+  \AtEndOfClass{%
+    \renewcommand\@openbib at code{%
+      \advance\leftmargin\bibindent
+      \itemindent -\bibindent
+      \listparindent \itemindent
+      \parsep \z@
+     }%
+    \renewcommand\newblock{\par}}}
+
+\DeclareOption{oldfontcommands}{\@memoldfonttrue}
+\DeclareOption{extrafontsizes}{\extrafontsizestrue}
+
+\ExecuteOptions{final,letterpaper,10pt,onecolumn,openright,twoside,
+                portrait}
+\ProcessOptions*
+  \ifmemlandscape
+    \setlength\@tempdima  {\stockheight}
+    \setlength\stockheight{\stockwidth}
+    \setlength\stockwidth {\@tempdima}
+  \fi
+
+\providecommand*{\bidimemoirpostopthook}{}
+  \bidimemoirpostopthook
+
+\def\cleartorecto{\clearpage\if at twoside \ifodd\c at page\else
+  \hbox{}\thispagestyle{cleared}%
+  \newpage\if at twocolumn\hbox{}\newpage\fi\fi\fi}
+
+\def\cleartoverso{\clearpage\if at twoside
+  \ifodd\c at page\hbox{}\thispagestyle{cleared}%
+  \newpage\if at twocolumn\hbox{}\newpage\fi\fi\fi}
+
+\if at openleft
+  \openleft
+\else
+  \if at openright
+    \openright
+  \else
+    \openany
+  \fi
+\fi
+
+\newcommand*{\@ivpt}{4}
+\newcommand*{\@xxxpt}{30}
+\newcommand*{\@xxxvipt}{36}
+\newcommand*{\@xlviiipt}{48}
+\newcommand*{\@lxpt}{60}
+\newcommand*{\@lxxiipt}{72}
+\newcommand*{\@lxxxivpt}{84}
+\newcommand*{\@xcvipt}{96}
+\newcommand*{\@cviiipt}{108}
+\newcommand*{\@cxxpt}{120}
+\newcommand*{\@cxxxiipt}{132}
+
+\providecommand*{\memfontfamily}{lmr}
+\providecommand*{\memfontenc}{T1}
+\providecommand*{\memfontpack}{lmodern}
+
+\if at nyptsizeopt
+  \newcommand*{\@nyptclofile}{\anyptfilebase\anyptsize.clo}
+  \IfFileExists{\@nyptclofile}{\def\@memptsize{\anyptsize}}{%
+    \@memerror{You have used the `*pt' option but \MessageBreak
+               file \@nyptclofile\space can't be found}%
+              {I'll use mem10.clo instead}
+    \renewcommand*{\@nyptclofile}{mem10.clo}%
+    \def\@memptsize{10}%
+  }
+  \renewcommand*{\@ptsize}{\@memptsize}
+  \usefont{\memfontenc}{\memfontfamily}{m}{n}
+  \input{\@nyptclofile}
+  \usepackage{\memfontpack}\usepackage[\memfontenc]{fontenc}
+\else
+  \ifextrafontsizes
+    \usefont{\memfontenc}{\memfontfamily}{m}{n}
+    \input{mem\@memptsize.clo}
+    \usepackage{\memfontpack}\usepackage[\memfontenc]{fontenc}
+  \else
+    \ifnum\@memptsize > 17\relax
+      \@memerror{The `extrafontsizes' option is required to use \MessageBreak
+                 the `\@memptsize pt' option}%
+                {The 17pt option will be used instead}
+      \input{mem17.clo}
+    \else
+      \ifnum\@ptsize = 9\relax
+        \input{mem\@ptsize.clo}
+      \else
+        \input{mem1\@ptsize.clo}
+      \fi
+    \fi
+  \fi
+\fi
+
+\newcommand{\captionsize}{\normalsize}
+\setlength\lineskip{1\p@}
+\setlength\normallineskip{1\p@}
+\renewcommand{\baselinestretch}{}
+\setlength\parskip{0\p@ \@plus \p@}
+\@lowpenalty   51
+\@medpenalty  151
+\@highpenalty 301
+\clubpenalty  1000
+\widowpenalty 1000
+\newcommand*{\setlxvchars}[1][\normalfont]{\begingroup
+  #1
+  \settowidth{\lxvchars}{abcdefghijklmnopqrstuvwxyz}%
+  \setlength{\lxvchars}{2.042\lxvchars}%
+  \addtolength{\lxvchars}{33.41pt}%
+  \global\lxvchars=\lxvchars
+  \endgroup}
+\newcommand*{\setxlvchars}[1][\normalfont]{\begingroup
+  #1
+  \settowidth{\xlvchars}{abcdefghijklmnopqrstuvwxyz}%
+  \setlength{\xlvchars}{1.415\xlvchars}%
+  \addtolength{\xlvchars}{23.03pt}%
+  \global\xlvchars=\xlvchars
+  \endgroup}
+
+\newcommand*{\setrectanglesize}[3]{%
+  \nametest{#1}{*}%
+  \ifsamename                           % H = *
+    \nametest{#2}{*}%
+    \ifsamename                         % W = *
+      \@memerror{%
+        The combination of argument values is ambiguous.\MessageBreak
+        The lengths will be set to zero}{\@ehd}%
+      \setlength{\@tempdima}{0pt}%
+      \setlength{\@tempdimb}{0pt}%
+    \else                               % W
+      \nametest{#3}{*}%
+      \ifsamename                       % r = *
+        \setlength{\@tempdimb}{#2}%
+        \setlength{\@tempdima}{\@tempdimb}%
+      \else                             % r
+        \setlength{\@tempdimb}{#2}%
+        \setlength{\@tempdima}{#3\@tempdimb}%
+      \fi
+    \fi
+  \else                                 % H
+    \nametest{#2}{*}%
+    \ifsamename                         % W = *
+      \nametest{#3}{*}%
+      \ifsamename                       % r = *
+        \setlength{\@tempdima}{#1}%
+        \setlength{\@tempdimb}{\@tempdima}%
+      \else                             % r
+        \setlength{\@tempdima}{#1}%
+        \setlength{\@tempdimb}{#3\@tempdima}%
+      \fi
+    \else                               % W
+      \setlength{\@tempdima}{#1}%
+      \setlength{\@tempdimb}{#2}%
+    \fi
+  \fi}
+
+\newcommand*{\setfillsize}[5]{%
+  \nametest{#2}{*}%
+  \ifsamename                                % C = *
+    \nametest{#3}{*}%
+    \ifsamename                              % L = *
+      \nametest{#4}{*}%
+      \ifsamename                            % R = *
+        \@memerror{%
+          The combination of argument values is ambiguous.\MessageBreak
+          The lengths will be set to zero}{\@ehd}
+        \setlength{\@tempdima}{0pt}%
+        \setlength{\@tempdimb}{0pt}%
+        \setlength{\@tempdimc}{0pt}%
+      \else                                  % R
+        \nametest{#5}{*}%
+        \ifsamename                          % r = *
+          \setlength{\@tempdimb}{#4}%
+          \setlength{\@tempdima}{\@tempdimb}%
+          \setlength{\@tempdimc}{#1}%
+          \advance\@tempdimc -\@tempdima
+          \advance\@tempdimc -\@tempdimb
+        \else                                % r
+          \setlength{\@tempdimb}{#4}%
+          \setlength{\@tempdima}{#5\@tempdimb}%
+          \setlength{\@tempdimc}{#1}%
+          \advance\@tempdimc -\@tempdima
+          \advance\@tempdimc -\@tempdimb
+        \fi
+      \fi
+    \else                                    % L
+      \nametest{#4}{*}%
+      \ifsamename                            % R = *
+        \nametest{#5}{*}%
+        \ifsamename                          % r = *
+          \setlength{\@tempdima}{#3}%
+          \setlength{\@tempdimb}{\@tempdima}
+          \setlength{\@tempdimc}{#1}%
+          \advance\@tempdimc -\@tempdima
+          \advance\@tempdimc -\@tempdimb
+        \else                                % r
+          \setlength{\@tempdima}{#3}%
+          \setlength{\@tempdimb}{#5\@tempdima}
+          \setlength{\@tempdimc}{#1}%
+          \advance\@tempdimc -\@tempdima
+          \advance\@tempdimc -\@tempdimb
+        \fi
+      \else                                  % R
+        \setlength{\@tempdima}{#3}%
+        \setlength{\@tempdimb}{#4}%
+        \setlength{\@tempdimc}{#1}%
+        \advance\@tempdimc -\@tempdima
+        \advance\@tempdimc -\@tempdimb
+      \fi
+    \fi
+  \else                                      % C is valued
+    \nametest{#3}{*}%
+    \ifsamename                              % L = *
+      \nametest{#4}{*}%
+      \ifsamename                            % R = *
+        \nametest{#5}{*}%
+        \ifsamename                          % r = *
+          \setlength{\@tempdimc}{#2}%
+          \setlength{\@tempdima}{#1}%
+          \advance\@tempdima -\@tempdimc
+          \@tempdima = 0.5\@tempdima
+          \@tempdimb = \@tempdima
+        \else                                % r (CODE PERHAPS FIXED)
+          \setlength{\@tempdimc}{#2}         % C
+          \setlength{\@tempdimb}{#1}         % T
+          \advance\@tempdimb -\@tempdimc % T - C
+          \@tempdima = 1000sp
+          \setlength{\@tempdima}{#5\@tempdima}        % 1000r sp
+          \advance\@tempdima by 1000sp   % 1000(1+r)sp
+          \@tempcnta = \@tempdima        % 1000(1+r)
+          \@tempdima = \@tempdimb        % T - C
+          \divide\@tempdima by \@tempcnta  % (T-C)/1000(1+r) pts
+          \@tempdima = 1000\@tempdima      % (T-C)/(1+r)  pts = L
+          \advance\@tempdimb by -\@tempdima % = R
+        \fi
+      \else                                  % R
+        \setlength{\@tempdimc}{#2}%
+        \setlength{\@tempdimb}{#4}%
+        \setlength{\@tempdima}{#1}%
+        \advance\@tempdima -\@tempdimc
+        \advance\@tempdima -\@tempdimb
+      \fi
+    \else                                    % L
+      \nametest{#4}{*}%
+      \ifsamename                            % R = *
+        \setlength{\@tempdimc}{#2}%
+        \setlength{\@tempdima}{#3}%
+        \setlength{\@tempdimb}{#1}%
+        \advance\@tempdimb -\@tempdimc
+        \advance\@tempdimb -\@tempdima
+      \else                                  % R
+        \@memerror{%
+          The combination of argument values is ambiguous.\MessageBreak
+          The lengths will be set to zero}{\@ehd}%
+        \setlength{\@tempdima}{0pt}%
+        \setlength{\@tempdimb}{0pt}%
+        \setlength{\@tempdimc}{#2}%
+      \fi
+    \fi
+  \fi}
+
+\newcommand{\setstocksize}[2]{%
+  \setlength{\stockheight}{#1}%
+  \setlength{\stockwidth}{#2}}
+\newcommand{\settrims}[2]{%
+  \setlength{\trimtop}{#1}%
+  \setlength{\trimedge}{#2}}
+\newcommand{\settrimmedsize}[3]{%
+  \setrectanglesize{#1}{#2}{#3}%
+  \setlength{\paperheight}{\@tempdima}%
+  \setlength{\paperwidth}{\@tempdimb}}
+
+\newcommand{\settypeblocksize}[3]{%
+  \setrectanglesize{#1}{#2}{#3}%
+  \setlength{\textheight}{\@tempdima}%
+  \setlength{\textwidth}{\@tempdimb}}
+
+\newlength{\binding}
+\newcommand*{\setbinding}[1]{\setlength{\binding}{#1}}
+  \setbinding{0pt}
+
+\newlength{\spinemargin}
+\newlength{\foremargin}
+\newcommand{\setlrmargins}[3]{%
+  \advance\paperwidth -\binding
+  \setfillsize{\paperwidth}{\textwidth}{#1}{#2}{#3}%
+  \setlength{\textwidth}{\@tempdimc}%
+  \setlength{\spinemargin}{\@tempdima}%
+  \setlength{\foremargin}{\@tempdimb}%
+  \advance\paperwidth \binding
+  \advance\spinemargin \binding}
+
+\newcommand{\setlrmarginsandblock}[3]{%
+  \advance\paperwidth -\binding
+  \setfillsize{\paperwidth}{*}{#1}{#2}{#3}%
+  \setlength{\textwidth}{\@tempdimc}%
+  \setlength{\spinemargin}{\@tempdima}%
+  \setlength{\foremargin}{\@tempdimb}%
+  \advance\paperwidth \binding
+  \advance\spinemargin \binding}
+
+\newlength{\uppermargin}
+\newlength{\lowermargin}
+\newcommand{\setulmargins}[3]{%
+  \setfillsize{\paperheight}{\textheight}{#1}{#2}{#3}%
+  \setlength{\textheight}{\@tempdimc}%
+  \setlength{\uppermargin}{\@tempdima}%
+  \setlength{\lowermargin}{\@tempdimb}}
+
+\newcommand{\setulmarginsandblock}[3]{%
+  \setfillsize{\paperheight}{*}{#1}{#2}{#3}%
+  \setlength{\textheight}{\@tempdimc}%
+  \setlength{\uppermargin}{\@tempdima}%
+  \setlength{\lowermargin}{\@tempdimb}}
+
+\newlength{\headdrop}
+\newcommand{\setheaderspaces}[3]{%
+  \setfillsize{\uppermargin}{\headheight}{#1}{#2}{#3}%
+  \setlength{\headheight}{\@tempdimc}%
+  \setlength{\headdrop}{\@tempdima}%
+  \setlength{\headsep}{\@tempdimb}}
+
+\newcommand{\setheadfoot}[2]{%
+  \setlength{\headheight}{#1}%
+  \setlength{\footskip}{#2}}
+
+\newcommand{\setcolsepandrule}[2]{%
+  \setlength{\columnsep}{#1}%
+  \setlength{\columnseprule}{#2}}
+
+\newcommand{\setmarginnotes}[3]{%
+  \setlength{\marginparsep}{#1}%
+  \setlength{\marginparwidth}{#2}%
+  \setlength{\marginparpush}{#3}}
+
+\settrimmedsize{\stockheight}{\stockwidth}{*}
+\settrims{\z@}{\z@}
+
+\setlength{\@tempdimb}{1.14\lxvchars}
+\setlength\@tempdima{\paperwidth}
+  \addtolength\@tempdima{-2in}
+\if at twocolumn
+  \ifdim\@tempdima>2\@tempdimb\relax
+    \setlength\textwidth{2\@tempdimb}
+  \else
+    \setlength\textwidth{\@tempdima}
+  \fi
+\else
+  \ifdim\@tempdima>\@tempdimb\relax
+    \setlength\textwidth{\@tempdimb}
+  \else
+    \setlength\textwidth{\@tempdima}
+  \fi
+\fi
+\@settopoint\textwidth
+
+\setlength\@tempdima{\paperheight}
+  \addtolength\@tempdima{-3.5in}
+  \divide\@tempdima\baselineskip
+\@tempcnta=\@tempdima
+\setlength\textheight{\@tempcnta\baselineskip}
+  \addtolength\textheight{\topskip}
+
+\if at twoside
+  \setlength\@tempdima       {\paperwidth}
+  \addtolength\@tempdima     {-\textwidth}
+  \setlength\oddsidemargin   {.4\@tempdima}
+  \addtolength\oddsidemargin {-1in}
+  \setlength\marginparwidth  {.6\@tempdima}
+  \addtolength\marginparwidth{-\marginparsep}
+  \addtolength\marginparwidth{-0.4in}
+\else
+  \setlength\@tempdima       {\paperwidth}
+  \addtolength\@tempdima     {-\textwidth}
+  \setlength\oddsidemargin   {.5\@tempdima}
+  \addtolength\oddsidemargin {-1in}
+  \setlength\marginparwidth  {.5\@tempdima}
+  \addtolength\marginparwidth{-\marginparsep}
+  \addtolength\marginparwidth{-0.8in} % don't know why this isn't .4
+\fi
+\ifdim\marginparwidth>2in
+  \setlength\marginparwidth{2in}%
+\fi
+\@settopoint\oddsidemargin
+\@settopoint\marginparwidth
+\ifdim\marginparwidth<1pt \setlength\marginparwidth{1pt}\fi
+
+\setlength\evensidemargin  {\paperwidth}
+\addtolength\evensidemargin{-2in}
+\addtolength\evensidemargin{-\textwidth}
+\addtolength\evensidemargin{-\oddsidemargin}
+\@settopoint\evensidemargin
+\setlength\topmargin  {\paperheight}
+\addtolength\topmargin{-2in}
+\addtolength\topmargin{-\headheight}
+\addtolength\topmargin{-\headsep}
+\addtolength\topmargin{-\textheight}
+\addtolength\topmargin{-\footskip}
+\addtolength\topmargin{-.5\topmargin}
+\@settopoint\topmargin
+
+\setlength{\spinemargin}{\oddsidemargin}
+\addtolength{\spinemargin}{1in}
+\setlrmargins{\spinemargin}{*}{*}
+
+\setlength{\uppermargin}{\topmargin}
+\addtolength{\uppermargin}{1in}
+\addtolength{\uppermargin}{\headheight}
+\addtolength{\uppermargin}{\headsep}
+\setulmargins{\uppermargin}{*}{*}
+
+\newcommand*{\@memznegtest}[1]{%
+  \ifdim#1>\z@\else
+ %%%%   \@memerror{\protect#1\space is zero or negative}{\@ehd}%
+    \@memwarn{\protect#1\space is zero or negative}%
+  \fi}
+\newcommand*{\@memnegtest}[1]{%
+  \ifdim#1<\z@
+%%%%    \@memerror{\protect#1\space is negative}{\@ehd}%
+    \@memwarn{\protect#1\space is negative}%
+  \fi}
+
+\newcommand*{\m at mclassicht}{%
+  \setlength{\@tempdima}{\textheight}%
+  \divide\@tempdima \baselineskip
+  \@tempcnta=\@tempdima
+  \setlength{\textheight}{\@tempcnta\baselineskip}%
+  \addtolength{\textheight}{\topskip}}
+
+\newcommand*{\m at mlinesht}{%
+  \setlength{\@tempdima}{\textheight}%
+  \advance\@tempdima -\baselineskip
+  \divide\@tempdima \baselineskip
+  \@tempcnta=\@tempdima
+  \setlength{\textheight}{\@tempcnta\baselineskip}%
+  \addtolength{\textheight}{\topskip}}
+
+\newcommand*{\m at mnearestht}{%
+  \setlength{\@tempdima}{\textheight}%
+  \advance\@tempdima -\topskip
+  \advance\@tempdima 0.5\baselineskip
+  \divide\@tempdima \baselineskip
+  \@tempcnta=\@tempdima
+  \setlength{\textheight}{\@tempcnta\baselineskip}%
+  \addtolength{\textheight}{\topskip}}
+
+\newcommand*{\checkthelayout}[1][classic]{%
+  \@memnegtest{\trimedge}
+  \@memnegtest{\trimtop}
+  \@memznegtest{\stockwidth}
+  \@memznegtest{\paperwidth}
+  \@memznegtest{\textwidth}
+%%%  \@memznegtest{\spinemargin}
+  \@memnegtest{\spinemargin}
+%%%  \@memznegtest{\foremargin}
+  \@memnegtest{\foremargin}
+  \@memznegtest{\marginparsep}
+  \@memznegtest{\marginparwidth}
+  \@memznegtest{\stockheight}
+  \@memznegtest{\paperheight}
+  \@memznegtest{\textheight}
+%%%  \@memznegtest{\uppermargin}
+  \@memnegtest{\uppermargin}
+%%%  \@memznegtest{\lowermargin}
+  \@memnegtest{\lowermargin}
+%%%  \@memznegtest{\headheight}
+  \@memnegtest{\headheight}
+%%%  \@memznegtest{\headsep}
+  \@memnegtest{\headsep}
+%%%  \@memznegtest{\footskip}
+  \@memnegtest{\footskip}
+  \nametest{#1}{classic}%
+  \ifsamename
+    \m at mclassicht
+  \else
+    \nametest{#1}{lines}%
+    \ifsamename
+      \m at mlinesht
+    \else
+      \nametest{#1}{nearest}%
+      \ifsamename
+        \m at mnearestht
+      \else
+        \nametest{#1}{fixed}
+        \ifsamename
+        \else%    not classic, lines, nearest, or fixed
+          \@memerror{Optional argument is not one of:\MessageBreak
+                     classic, fixed, lines, or nearest. \MessageBreak
+                     I will assume the default}%
+                    {\@ehc}%
+        \fi
+      \fi
+    \fi
+  \fi
+  \setulmargins{\uppermargin}{*}{*}
+  \@tempdimb = -1pt
+  \@tempdima=\stockwidth
+  \advance\@tempdima -\trimedge
+  \advance\@tempdima -\paperwidth
+  \ifdim\@tempdima<\@tempdimb
+    \@tempdima = -\@tempdima
+    \@memerror{\protect\paperwidth\space (\the\paperwidth) and/or
+                        \protect\trimedge\space (\the\trimedge)
+                        are too large for \protect\stockwidth\space (\the\stockwidth)
+                        by \the\@tempdima}%
+                       {\@ehd}
+  \fi
+  \@tempdima = \paperwidth
+  \advance\@tempdima -\foremargin
+  \advance\@tempdima -\textwidth
+  \advance\@tempdima -\spinemargin
+  \ifdim\@tempdima<\@tempdimb
+    \@tempdima = -\@tempdima
+    \@memerror{\protect\spinemargin\space (\the\spinemargin) and/or
+                        \protect\textwidth\space (\the\textwidth) and/or
+                        \protect\foremargin\space (\the\foremargin)
+                        are too large for \protect\paperwidth\space (\the\paperwidth)
+                        by \the\@tempdima}%
+                       {\@ehd}
+  \fi
+  \@tempdima = \stockheight
+  \advance\@tempdima -\trimtop
+  \advance\@tempdima -\paperheight
+  \ifdim\@tempdima<\@tempdimb
+    \@tempdima = -\@tempdima
+    \@memerror{\protect\paperheight\space (\the\paperheight) and/or
+                        \protect\trimtop\space (\the\trimtop)
+                        are too large for \protect\stockheight\space (\the\stockheight)
+                        by \the\@tempdima}%
+                       {\@ehd}
+  \fi
+  \@tempdima = \paperheight
+  \advance\@tempdima -\uppermargin
+  \advance\@tempdima -\textheight
+  \advance\@tempdima -\lowermargin
+  \ifdim\@tempdima<\@tempdimb
+    \@tempdima = -\@tempdima
+    \@memerror{\protect\uppermargin\space (\the\uppermargin) and/or
+                        \protect\textheight\space (\the\textheight) and/or
+                        \protect\lowermargin\space (\the\lowermargin)
+                        are too large for \protect\paperheight\space (\the\paperheight)
+                        by \the\@tempdima}%
+                       {\@ehd}
+  \fi
+  \@tempdima = \uppermargin
+  \advance\@tempdima -\headheight
+  \advance\@tempdima -\headsep
+  \ifdim\@tempdima<\@tempdimb
+    \@tempdima = -\@tempdima
+    \@memerror{\protect\headheight\space (\the\headheight) and/or
+                        \protect\headsep\space (\the\headsep)
+                        are too large for \protect\uppermargin\space (\the\uppermargin)
+                        by \the\@tempdima}%
+                       {\@ehd}
+  \fi
+  \@tempdima = \lowermargin
+  \advance\@tempdima -\footskip
+  \ifdim\@tempdima<\z@
+    \@tempdima = -\@tempdima
+    \@memerror{\protect\footskip\space (\the\footskip)
+                        is too large for \protect\lowermargin\space (\the\lowermargin)
+                        by \the\@tempdima}%
+                       {\@ehd}
+  \fi}
+
+\newcommand*{\fixthelayout}{%
+  \topmargin = \trimtop
+    \advance\topmargin \uppermargin
+    \advance\topmargin -\headsep
+    \advance\topmargin -\headheight
+    \advance\topmargin -1in\relax
+  \oddsidemargin = \stockwidth
+    \advance\oddsidemargin -\trimedge
+    \advance\oddsidemargin -\paperwidth
+    \advance\oddsidemargin \spinemargin
+    \advance\oddsidemargin -1in\relax
+  \evensidemargin = \trimedge
+    \advance\evensidemargin \foremargin
+    \advance\evensidemargin -1in\relax
+  \@settopoint\textwidth
+  \@settopoint\oddsidemargin
+  \@settopoint\evensidemargin}
+
+\newcommand*{\typeoutlayout}{%
+  \typeout{}
+  \typeout{******************************************************}
+  \typeout{Stock height and width:
+                 \the\stockheight\space by \the\stockwidth}
+  \typeout{Top and edge trims:
+                 \the\trimtop\space and \the\trimedge}
+  \typeout{Page height and width:
+                 \the\paperheight\space by \the\paperwidth}
+  \typeout{Text height and width:
+                 \the\textheight\space by \the\textwidth}
+  \typeout{Spine and edge margins:
+                 \the\spinemargin\space and \the\foremargin}
+  \typeout{Upper and lower margins:
+                 \the\uppermargin\space and \the\lowermargin}
+  \typeout{Headheight and headsep:
+                 \the\headheight\space and \the\headsep}
+  \typeout{Footskip:
+                 \the\footskip}
+  \typeout{Columnsep and columnseprule:
+                 \the\columnsep\space and \the\columnseprule}
+  \typeout{Marginparsep and marginparwidth:
+                 \the\marginparsep\space and \the\marginparwidth}
+  \typeout{Sidecapsep and sidecapwidth:
+                  \the\sidecapsep\space and \the\sidecapwidth}
+  \typeout{Sidebarhsep and sidebarwidth:
+                  \the\sidebarhsep\space and \the\sidebarwidth}
+  \typeout{Sidebarvsep and sidebartopsep:
+                  \the\sidebarvsep\space and \the\sidebartopsep}
+  \typeout{Sidebarheight:
+                  \the\dimen\sideins}
+  \typeout{******************************************************}
+  \typeout{}}
+
+\newcommand*{\checkandfixthelayout}[1][classic]{%
+  \checkthelayout[#1]%
+  \fixthelayout
+  \typeoutlayout}
+
+\newcommand*{\fixpdflayout}{%
+  \pdfpageheight=\the\stockheight
+  \pdfpagewidth=\the\stockwidth
+  \ifdim\pdfvorigin=0pt\pdfvorigin=1in\fi
+  \ifdim\pdfhorigin=0pt\pdfhorigin=1in\fi}
+\newcommand*{\fixdvipslayout}{%
+  \AtBeginDvi{\special{papersize=\the\stockwidth,\the\stockheight}}}
+
+\AtBeginDocument{%
+  \ifpdf
+    \ifnum\pdfoutput<\@ne
+      \fixdvipslayout
+    \else
+      \fixpdflayout
+    \fi
+  \else
+    \fixdvipslayout
+  \fi}
+
+\newcommand{\typeoutstandardlayout}{%
+  \typeout{}
+  \typeout{******************************************************}
+  \typeout{Page height and width:
+                \the\paperheight\space by \the\paperwidth}
+  \typeout{Text height and width:
+               \the\textheight\space by \the\textwidth}
+  \typeout{Oddside and evenside margins:
+                \the\oddsidemargin\space and \the\evensidemargin}
+  \typeout{Topmargin and footskip:
+                \the\topmargin\space and \the\footskip}
+  \typeout{Headheight and headsep:
+                \the\headheight\space and \the\headsep}
+  \typeout{Columnsep and columnseprule:
+                \the\columnsep\space and \the\columnseprule}
+  \typeout{Marginparsep and marginparwidth:
+                \the\marginparsep\space and \the\marginparwidth}
+  \typeout{******************************************************}
+  \typeout{}
+}
+
+%%%% s = w/#1, t = 1.5s, e = 2s, f = 3s
+\newcommand*{\medievalpage}[1][9]{%
+  \spinemargin=\paperwidth
+  \divide\spinemargin #1\relax
+  \uppermargin = 1.5\spinemargin
+  \setlrmarginsandblock{\spinemargin}{*}{2}
+  \setulmarginsandblock{\uppermargin}{*}{2}}
+
+\newcommand*{\isopage}[1][9]{%
+  \spinemargin=\paperwidth
+  \divide\spinemargin #1\relax
+  \uppermargin=\paperheight
+  \divide\uppermargin #1\relax
+  \setlrmarginsandblock{\spinemargin}{*}{2}
+  \setulmarginsandblock{\uppermargin}{*}{2}}
+
+%%% s = w/#1, t = s, e = 2s, f = e
+\newcommand*{\semiisopage}[1][9]{%
+  \spinemargin=\paperwidth
+  \divide\spinemargin #1\relax
+  \uppermargin=\spinemargin
+  \setlrmarginsandblock{\spinemargin}{*}{2}
+  \setulmarginsandblock{\uppermargin}{*}{2}}
+
+\newcommand*{\setpagebl}[3]{%
+  \settrimmedsize{#1}{#2}{#3}%
+  \trimtop=\stockheight \advance\trimtop -\paperheight
+  \trimedge=\stockwidth \advance\trimedge -\paperwidth}
+\newcommand*{\setpageml}[3]{%
+  \settrimmedsize{#1}{#2}{#3}
+  \trimtop=\stockheight \advance\trimtop -\paperheight
+    \advance\trimtop -0.5\trimtop
+  \trimedge=\stockwidth \advance\trimedge -\paperwidth}
+\newcommand*{\setpagetl}[3]{%
+  \settrimmedsize{#1}{#2}{#3}
+  \trimtop=0pt
+  \trimedge=\stockwidth \advance\trimedge -\paperwidth}
+\newcommand*{\setpagetm}[3]{%
+  \settrimmedsize{#1}{#2}{#3}%
+  \trimtop=0pt
+  \trimedge=\stockwidth \advance\trimedge -\paperwidth
+  \advance\trimedge -0.5\trimedge}
+
+\newcommand*{\setpagetr}[3]{%
+  \settrimmedsize{#1}{#2}{#3}%
+  \trimtop=0pt
+  \trimedge=0pt}
+\newcommand*{\setpagemr}[3]{%
+  \settrimmedsize{#1}{#2}{#3}%
+  \trimtop=\stockheight \advance\trimtop -\paperheight
+    \advance\trimtop -0.5\trimtop
+  \trimedge=0pt}
+\newcommand*{\setpagebr}[3]{%
+  \settrimmedsize{#1}{#2}{#3}%
+  \trimtop=\stockheight  \advance\trimtop -\paperheight
+  \trimedge=0pt}
+\newcommand*{\setpagebm}[3]{%
+  \settrimmedsize{#1}{#2}{#3}%
+  \trimtop=\stockheight \advance\trimtop -\paperheight
+  \trimedge=\stockwidth \advance\trimedge -\paperwidth
+    \advance\trimedge -0.5\trimedge}
+\newcommand*{\setpagecc}[3]{%
+  \settrimmedsize{#1}{#2}{#3}%
+  \trimtop=\stockheight \advance\trimtop -\paperheight
+    \advance\trimtop -0.5\trimtop
+  \trimedge=\stockwidth \advance\trimedge -\paperwidth
+    \advance\trimedge -0.5\trimedge}
+
+\setcounter{topnumber}{3}
+\renewcommand{\topfraction}{.85}
+\setcounter{bottomnumber}{2}
+\renewcommand{\bottomfraction}{.5}
+\setcounter{totalnumber}{4}
+\renewcommand{\textfraction}{.1}
+\renewcommand{\floatpagefraction}{.7}
+\setcounter{dbltopnumber}{3}
+\renewcommand{\dbltopfraction}{.85}
+\renewcommand{\dblfloatpagefraction}{.7}
+\newcommand{\makeevenhead}[4]{%
+  \@namedef{#1eheadl}{#2}
+  \@namedef{#1eheadc}{#3}
+  \@namedef{#1eheadr}{#4}
+}
+\newcommand{\makeoddhead}[4]{%
+  \@namedef{#1oheadl}{#2}
+  \@namedef{#1oheadc}{#3}
+  \@namedef{#1oheadr}{#4}
+}
+\newcommand{\makeevenfoot}[4]{%
+  \@namedef{#1efootl}{#2}
+  \@namedef{#1efootc}{#3}
+  \@namedef{#1efootr}{#4}
+}
+\newcommand{\makeoddfoot}[4]{%
+  \@namedef{#1ofootl}{#2}
+  \@namedef{#1ofootc}{#3}
+  \@namedef{#1ofootr}{#4}
+}
+
+\newcommand*{\makerunningwidth}[1]{%
+  \def\m at mhfstyle{#1}%
+  \m at mopthfwidth}
+\newcommand*{\m at mopthfwidth}[2][\@mpty]{%
+  \@namedef{\m at mhfstyle headrunwidth}{#2}%
+  \ifx\@mpty #1
+    \@namedef{\m at mhfstyle footrunwidth}{#2}%
+  \else
+    \@namedef{\m at mhfstyle footrunwidth}{#1}%
+  \fi}
+\newcommand*{\makerunningheadwidth}[2]{%
+  \@namedef{#1headrunwidth}{#2}%
+}
+\newcommand*{\makerunningfootwidth}[2]{%
+  \@namedef{#1footrunwidth}{#2}%
+}
+
+\newlength{\normalrulethickness}
+  \setlength{\normalrulethickness}{0.4pt}
+\newcommand{\footruleheight}{0pt}
+\newcommand{\footruleskip}{0.3\normalbaselineskip}
+\newcommand{\makeheadrule}[3]{%
+  \@namedef{#1headrule}{%
+    \hrule\@width #2\@height #3 \vskip-#3}}
+\newcommand{\makefootrule}[4]{%
+  \@namedef{#1footrule}{%
+    \vskip-#4\vskip-#3
+    \hrule\@width #2\@height #3 \vskip #4}}
+
+\newcommand{\makeheadposition}[5]{%
+  \nametest{flushleft}{#2}
+  \ifsamename
+    \@namedef{#1evenhpl}{\relax} \@namedef{#1evenhpr}{\hss}
+  \else
+    \nametest{flushright}{#2}
+    \ifsamename
+      \@namedef{#1evenhpl}{\hss} \@namedef{#1evenhpr}{\relax}
+    \else
+      \@namedef{#1evenhpl}{\hss} \@namedef{#1evenhpr}{\hss}
+    \fi
+  \fi
+  \nametest{flushleft}{#3}
+  \ifsamename
+    \@namedef{#1oddhpl}{\relax} \@namedef{#1oddhpr}{\hss}
+  \else
+    \nametest{flushright}{#3}
+    \ifsamename
+      \@namedef{#1oddhpl}{\hss} \@namedef{#1oddhpr}{\relax}
+    \else
+      \@namedef{#1oddhpl}{\hss} \@namedef{#1oddhpr}{\hss}
+    \fi
+  \fi
+  \nametest{flushleft}{#4}
+  \ifsamename
+    \@namedef{#1evenfpl}{\relax} \@namedef{#1evenfpr}{\hss}
+  \else
+    \nametest{flushright}{#4}
+    \ifsamename
+      \@namedef{#1evenfpl}{\hss} \@namedef{#1evenfpr}{\relax}
+    \else
+      \@namedef{#1evenfpl}{\hss} \@namedef{#1evenfpr}{\hss}
+    \fi
+  \fi
+  \nametest{flushleft}{#5}
+  \ifsamename
+    \@namedef{#1oddfpl}{\relax} \@namedef{#1oddfpr}{\hss}
+  \else
+    \nametest{flushright}{#5}
+    \ifsamename
+      \@namedef{#1oddfpl}{\hss} \@namedef{#1oddfpr}{\relax}
+    \else
+      \@namedef{#1oddfpl}{\hss} \@namedef{#1oddfpr}{\hss}
+    \fi
+  \fi}
+
+\newcommand{\makepsmarks}[2]{\@namedef{#1pshook}{#2}}
+
+\newcommand*{\m at mhe@dreset}{\def\baselinestretch{1}\normalsize}
+
+\newcommand*\makeheadfootvposition[3]{%
+ \@namedef{#1headvplacement}{#2}\@namedef{#1footvplacement}{#3}}
+
+\newcommand{\makepagestyle}[1]{%
+  \@namedef{ps@#1}{%
+    \@namedef{#1 at evenhead}{%
+      \@nameuse{#1evenhpl}\hb at xt@\@nameuse{#1headrunwidth}{\m at mhe@dreset%
+        \vbox{\hbox{%
+        \rlap{\parbox[\@nameuse{#1headvplacement}]{\@nameuse{#1headrunwidth}}{%
+          \raggedright\@nameuse{#1eheadl}\strut}}\hfill
+              \parbox[\@nameuse{#1headvplacement}]{\@nameuse{#1headrunwidth}}{%
+          \centering\@nameuse{#1eheadc}\strut}\hfill
+        \llap{\parbox[\@nameuse{#1headvplacement}]{\@nameuse{#1headrunwidth}}{%
+          \raggedleft\@nameuse{#1eheadr}\strut}}}%
+        \@nameuse{#1headrule}}}\@nameuse{#1evenhpr}}%
+    \@namedef{#1 at oddhead}{%
+      \@nameuse{#1oddhpl}\hb at xt@\@nameuse{#1headrunwidth}{\m at mhe@dreset%
+        \vbox{\hbox{%
+        \rlap{\parbox[\@nameuse{#1headvplacement}]{\@nameuse{#1headrunwidth}}{%
+          \raggedright\@nameuse{#1oheadl}\strut}}\hfill
+              \parbox[\@nameuse{#1headvplacement}]{\@nameuse{#1headrunwidth}}{%
+          \centering\@nameuse{#1oheadc}\strut}\hfill
+        \llap{\parbox[\@nameuse{#1headvplacement}]{\@nameuse{#1headrunwidth}}{%
+          \raggedleft\@nameuse{#1oheadr}\strut}}}%
+        \@nameuse{#1headrule}}}\@nameuse{#1oddhpr}}%
+    \@namedef{#1 at evenfoot}{%
+      \@nameuse{#1evenfpl}\hb at xt@\@nameuse{#1footrunwidth}{\m at mhe@dreset%
+        \vbox{\@nameuse{#1footrule}\hbox{%
+        \rlap{\parbox[\@nameuse{#1footvplacement}]{\@nameuse{#1footrunwidth}}{%
+          \raggedright\@nameuse{#1efootl}\strut}}\hfill
+              \parbox[\@nameuse{#1footvplacement}]{\@nameuse{#1footrunwidth}}{%
+          \centering\@nameuse{#1efootc}\strut}\hfill
+        \llap{\parbox[\@nameuse{#1footvplacement}]{\@nameuse{#1footrunwidth}}{%
+          \raggedleft\@nameuse{#1efootr}\strut}}}%
+        }}\@nameuse{#1evenfpr}}%
+    \@namedef{#1 at oddfoot}{%
+      \@nameuse{#1oddfpl}\hb at xt@\@nameuse{#1footrunwidth}{\m at mhe@dreset%
+        \vbox{\@nameuse{#1footrule}\hbox{%
+        \rlap{\parbox[\@nameuse{#1footvplacement}]{\@nameuse{#1footrunwidth}}{%
+          \raggedright\@nameuse{#1ofootl}\strut}}\hfill
+              \parbox[\@nameuse{#1footvplacement}]{\@nameuse{#1footrunwidth}}{%
+          \centering\@nameuse{#1ofootc}\strut}\hfill
+        \llap{\parbox[\@nameuse{#1footvplacement}]{\@nameuse{#1footrunwidth}}{%
+          \raggedleft\@nameuse{#1ofootr}\strut}}}%
+        }}\@nameuse{#1oddfpr}}%
+    \def\@evenhead{\@nameuse{#1 at evenhead}}%
+    \def\@oddhead{\@nameuse{#1 at oddhead}}%
+    \def\@evenfoot{\@nameuse{#1 at evenfoot}}%
+    \def\@oddfoot{\@nameuse{#1 at oddfoot}}%
+    \@nameuse{#1pshook}}%
+  \makeevenhead{#1}{}{}{}%
+  \makeoddhead{#1}{}{}{}%
+  \makeevenfoot{#1}{}{}{}%
+  \makeoddfoot{#1}{}{}{}%
+  \makerunningwidth{#1}{\textwidth}%
+  \makeheadposition{#1}{}{}{}{}%
+  \makeheadrule{#1}{\textwidth}{0pt}%
+  \makefootrule{#1}{\textwidth}{\footruleheight}{\footruleskip}%
+  \makeheadfootvposition{#1}{b}{b}%
+  \makepsmarks{#1}{}}
+
+\newcommand{\aliaspagestyle}[2]{%
+  \@namedef{ps@#1}{\@nameuse{ps@#2}}}
+
+\newcommand{\copypagestyle}[2]{%
+  \makepagestyle{#1}%
+  \makeevenhead{#1}{\@nameuse{#2eheadl}}%
+               {\@nameuse{#2eheadc}}{\@nameuse{#2eheadr}}%
+  \makeoddhead{#1}{\@nameuse{#2oheadl}}%
+               {\@nameuse{#2oheadc}}{\@nameuse{#2oheadr}}%
+  \makeevenfoot{#1}{\@nameuse{#2efootl}}%
+               {\@nameuse{#2efootc}}{\@nameuse{#2efootr}}%
+  \makeoddfoot{#1}{\@nameuse{#2ofootl}}%
+              {\@nameuse{#2ofootc}}{\@nameuse{#2ofootr}}%
+  \makerunningwidth{#1}[\@nameuse{#2footrunwidth}]{\@nameuse{#2headrunwidth}}%
+  \@namedef{#1evenhpl}{\@nameuse{#2evenhpl}}%
+  \@namedef{#1oddhpl}{\@nameuse{#2oddhpl}}%
+  \@namedef{#1evenhpr}{\@nameuse{#2evenhpr}}%
+  \@namedef{#1oddhpr}{\@nameuse{#2oddhpr}}%
+  \makeheadfootvposition{#1}{\@nameuse{#2headvplacement}}{\@nameuse{#2footvplacement}}%
+  \@namedef{#1evenfpl}{\@nameuse{#2evenfpl}}%
+  \@namedef{#1oddfpl}{\@nameuse{#2oddfpl}}%
+  \@namedef{#1evenfpr}{\@nameuse{#2evenfpr}}%
+  \@namedef{#1oddfpr}{\@nameuse{#2oddfpr}}%
+  \@namedef{#1headrule}{\@nameuse{#2headrule}}%
+  \@namedef{#1footrule}{\@nameuse{#2footrule}}%
+  \makepsmarks{#1}{\@nameuse{#2pshook}}}
+
+\newcommand{\ifonlyfloats}[2]{\if at fcolmade #1\else #2\fi}
+
+\newcommand{\mergepagefloatstyle}[3]{%
+  \@nameuse{ps@#3}\@nameuse{ps@#2}%
+  \@namedef{ps@#1}{%
+  \def\@evenhead{\ifonlyfloats{\@nameuse{#3 at evenhead}}%
+                {\@nameuse{#2 at evenhead}}}%
+  \def\@oddhead{\ifonlyfloats{\@nameuse{#3 at oddhead}}%
+               {\@nameuse{#2 at oddhead}}}%
+  \def\@evenfoot{\ifonlyfloats{\@nameuse{#3 at evenfoot}}%
+                {\@nameuse{#2 at evenfoot}}}%
+  \def\@oddfoot{\ifonlyfloats{\@nameuse{#3 at oddfoot}}%
+               {\@nameuse{#2 at oddfoot}}}%
+  \@namedef{#1pshook}{\@nameuse{#2pshook}}%
+}}
+
+\makepagestyle{empty}
+
+\makepagestyle{plain}
+  \makeevenfoot{plain}{}{\thepage}{}
+  \makeoddfoot{plain}{}{\thepage}{}
+
+\newcommand*{\nouppercaseheads}{\let\memUChead\relax}
+\newcommand*{\uppercaseheads}{\let\memUChead\MakeUppercase}
+\uppercaseheads
+
+\newcommand*{\createplainmark}[3]{%
+  \nametest{#2}{left}%
+  \ifsamename
+    \@namedef{#1mark}{\markboth{\memUChead{#3}}{}}%
+  \else
+    \nametest{#2}{right}%
+    \ifsamename
+      \@namedef{#1mark}{\markright{\memUChead{#3}}}%
+    \else
+      \nametest{#2}{both}%
+      \ifsamename\else
+        \@memerror{%
+          Unknown mark setting type `#2' for #1mark}{%
+          I expected `left', `both' or `right'. \MessageBreak
+          I will assume you meant `both'}%
+      \fi
+      \@namedef{#1mark}{\markboth{\memUChead{#3}}{\memUChead{#3}}}%
+    \fi
+  \fi}
+
+\newcommand\createmark[5]{%
+  \def\@tempa{00}
+  \nametest{#3}{nonumber}%
+  \ifsamename
+    \def\@tempa{01}%
+  \else
+    \nametest{#3}{shownumber}
+    \ifsamename\else
+      \@memerror{Unknown numbering value `#3' for #1mark}%
+      {I expected `shownumber' or `nonumber'.\MessageBreak
+       I will assume you meant `shownumber'}%
+    \fi
+  \fi
+  \expandafter\if\@tempa%          compares the two \@tempa digits
+    \@namedef{#1marksn}##1{##1}%
+  \else
+    \@namedef{#1marksn}{\@gobble}%
+  \fi
+  \nametest{#2}{left}%
+  \ifsamename
+    \@namedef{#1mark}##1{%
+      \@setclcnt{#1}{@memmarkcntra}%
+      \advance\c@@memmarkcntra\m at ne
+      \markboth{%
+        \memUChead{%
+          \ifnum \c at secnumdepth > \c@@memmarkcntra
+            \if at mainmatter
+              \@nameuse{#1marksn}{#4\@nameuse{the#1}#5}%
+            \fi
+          \fi
+          ##1}}{}}%
+  \else
+    \nametest{#2}{right}
+    \ifsamename
+      \@namedef{#1mark}##1{%
+        \@setclcnt{#1}{@memmarkcntra}
+        \advance\c@@memmarkcntra\m at ne
+        \markright{%
+          \memUChead{%
+            \ifnum \c at secnumdepth > \c@@memmarkcntra
+              \if at mainmatter%
+                \@nameuse{#1marksn}{#4\@nameuse{the#1}#5}%
+              \fi%
+            \fi%
+            ##1}}}%
+    \else
+      \nametest{#2}{both}%
+      \ifsamename\else
+        \@memerror{%
+        Unknown mark setting type `#2' for #1mark}{%
+        I expected `left', `both' or `right'. \MessageBreak
+        I will assume you meant `both'}%
+      \fi
+    \@namedef{#1mark}##1{%
+      \@setclcnt{#1}{@memmarkcntra}
+      \advance\c@@memmarkcntra\m at ne
+      \markboth{%
+        \memUChead{%
+          \ifnum \c at secnumdepth > \c@@memmarkcntra
+            \if at mainmatter
+              \@nameuse{#1marksn}{#4\@nameuse{the#1}#5}%
+            \fi
+          \fi
+          ##1}}{%
+        \memUChead{%
+          \ifnum \c at secnumdepth > \c@@memmarkcntra
+            \if at mainmatter
+              \@nameuse{#1marksn}{#4\@nameuse{the#1}#5}%
+            \fi
+          \fi
+          ##1}}}%
+    \fi
+  \fi}
+
+\newcommand\addtopsmarks[3]{%
+  \expandafter\addtodef\expandafter{\csname #1pshook\endcsname}{#2}{#3}}
+\if at twoside
+  \makepagestyle{headings}
+    \makepsmarks{headings}{%
+      \def\chaptermark##1{%
+        \markboth{\memUChead{%
+          \ifnum \c at secnumdepth >\m at ne
+            \if at mainmatter
+              \@chapapp\ \thechapter. \ %
+            \fi
+          \fi
+          ##1}}{}}%
+      \def\tocmark{\markboth{\memUChead{\contentsname}}{\memUChead{\contentsname}}}%
+      \def\lofmark{\markboth{\memUChead{\listfigurename}}{\memUChead{\listfigurename}}}%
+      \def\lotmark{\markboth{\memUChead{\listtablename}}{\memUChead{\listtablename}}}%
+      \def\bibmark{\markboth{\memUChead{\bibname}}{\memUChead{\bibname}}}%
+      \def\indexmark{\markboth{\memUChead{\indexname}}{\memUChead{\indexname}}}%
+      \def\sectionmark##1{%
+        \markright{\memUChead{%
+          \ifnum \c at secnumdepth > \z@
+            \thesection. \ %
+          \fi
+          ##1}}}}
+    \makepsmarks{headings}{%
+      \createmark{chapter}{left}{shownumber}{\@chapapp\ }{. \ }
+      \createmark{section}{right}{shownumber}{}{. \ }
+      \createplainmark{toc}{both}{\contentsname}
+      \createplainmark{lof}{both}{\listfigurename}
+      \createplainmark{lot}{both}{\listtablename}
+      \createplainmark{bib}{both}{\bibname}
+      \createplainmark{index}{both}{\indexname}
+      \createplainmark{glossary}{both}{\glossaryname}
+    }
+    \makeevenhead{headings}{\thepage}{}{\slshape\leftmark}
+    \makeoddhead{headings}{\slshape\rightmark}{}{\thepage}
+\else
+  \makepagestyle{headings}
+    \makepsmarks{headings}{%
+      \def\chaptermark##1{%
+        \markright{\memUChead{%
+          \ifnum \c at secnumdepth >\m at ne
+            \if at mainmatter
+              \@chapapp\ \thechapter. \ %
+            \fi
+          \fi
+          ##1}}}%
+      \def\tocmark{\markright{\memUChead{\contentsname}}}%
+      \def\lofmark{\markright{\memUChead{\listfigurename}}}%
+      \def\lotmark{\markright{\memUChead{\listtablename}}}%
+      \def\bibmark{\markright{\memUChead{\bibname}}}%
+      \def\indexmark{\markright{\memUChead{\indexname}}}}
+    \makepsmarks{headings}{%
+      \createmark{chapter}{right}{shownumber}{\@chapapp\ }{. \ }
+      \createplainmark{toc}{right}{\contentsname}
+      \createplainmark{lof}{right}{\listfigurename}
+      \createplainmark{lot}{right}{\listtablename}
+      \createplainmark{bib}{right}{\bibname}
+      \createplainmark{index}{right}{\indexname}
+      \createplainmark{glossary}{right}{\glossaryname}
+    }
+    \makeoddhead{headings}{\slshape\rightmark}{}{\thepage}
+\fi
+
+\makepagestyle{myheadings}
+  \makepsmarks{myheadings}{%
+    \let\chaptermark\@gobble
+    \let\sectionmark\@gobble
+    \def\tocmark{}%
+    \def\lofmark{}%
+    \def\lotmark{}%
+    \def\bibmark{}%
+    \def\indexmark{}%
+    \def\glossarymark{}}
+  \makeevenhead{myheadings}{\thepage}{}{\slshape\leftmark}
+  \makeoddhead{myheadings}{\slshape\rightmark}{}{\thepage}
+
+\aliaspagestyle{chapter}{plain}
+\aliaspagestyle{part}{plain}
+\aliaspagestyle{cleared}{empty}
+
+\def\cleardoublepage{\clearpage\if at twoside \ifodd\c at page\else
+  \hbox{}\thispagestyle{cleared}%
+  \newpage\if at twocolumn\hbox{}\newpage\fi\fi\fi}
+
+\makepagestyle{ruled}
+\makeevenfoot{ruled}{\thepage}{}{}
+\makeoddfoot{ruled}{}{}{\thepage}
+\makeheadrule{ruled}{\textwidth}{\normalrulethickness}
+\newcommand{\@ruledmarks}{%
+  \def\chaptermark##1{%
+    \markboth{%
+      \ifnum \c at secnumdepth >\m at ne
+        \if at mainmatter
+          \thechapter. \ %
+        \fi
+      \fi
+      ##1}{}}
+  \def\sectionmark##1{\markright{##1}}
+  \def\tocmark{\markboth{\contentsname}{}}
+  \def\lofmark{\markboth{\listfigurename}{}}
+  \def\lotmark{\markboth{\listtablename}{}}
+  \def\bibmark{\markboth{\bibname}{}}
+  \def\indexmark{\markboth{\indexname}{}}
+  \def\glossarymark{\markboth{\glossaryname}{}}
+}
+\renewcommand*{\@ruledmarks}{%
+  \nouppercaseheads
+  \createmark{chapter}{left}{shownumber}{}{. \space}
+  \createmark{section}{right}{shownumber}{}{. \space}
+  \createplainmark{toc}{both}{\contentsname}
+  \createplainmark{lof}{both}{\listfigurename}
+  \createplainmark{lot}{both}{\listtablename}
+  \createplainmark{bib}{both}{\bibname}
+  \createplainmark{index}{both}{\indexname}
+  \createplainmark{glossary}{both}{\glossaryname}}
+\makepsmarks{ruled}{\@ruledmarks}
+\makeevenhead{ruled}{\scshape\leftmark}{}{}
+\makeoddhead{ruled}{}{}{\rightmark}
+
+\makepagestyle{Ruled}
+\makerunningwidth{Ruled}{1.1\textwidth}
+\makeheadposition{Ruled}{flushright}{flushleft}{flushright}{flushleft}
+\makeevenfoot{Ruled}{\thepage}{}{}
+\makeoddfoot{Ruled}{}{}{\thepage}
+\makeheadrule{Ruled}{1.1\textwidth}{\normalrulethickness}
+\makepsmarks{Ruled}{\@ruledmarks}
+\makeevenhead{Ruled}{\scshape\leftmark}{}{}
+\makeoddhead{Ruled}{}{}{\rightmark}
+
+\newlength{\headwidth}
+
+\makepagestyle{companion}
+\setlength{\headwidth}{\textwidth}
+  \addtolength{\headwidth}{\marginparsep}
+  \addtolength{\headwidth}{\marginparwidth}
+\makerunningwidth{companion}{\headwidth}
+\makeheadrule{companion}{\headwidth}{\normalrulethickness}
+\makeheadposition{companion}{flushright}{flushleft}{}{}
+\makepsmarks{companion}{%
+  \def\chaptermark##1{\markboth{##1}{##1}}    % left mark & right marks
+  \def\sectionmark##1{\markright{%
+    \ifnum \c at secnumdepth>\z@
+      \thesection. \ %
+    \fi
+    ##1}}
+  \def\tocmark{\markboth{\contentsname}{\contentsname}}
+  \def\lofmark{\markboth{\listfigurename}{\listfigurename}}
+  \def\lotmark{\markboth{\listtablename}{\listtablename}}
+  \def\bibmark{\markboth{\bibname}{\bibname}}
+  \def\indexmark{\markboth{\indexname}{\indexname}}}
+\makepsmarks{companion}{%
+  \nouppercaseheads
+  \createmark{chapter}{both}{nonumber}{}{}
+  \createmark{section}{right}{shownumber}{}{. \space}
+  \createplainmark{toc}{both}{\contentsname}
+  \createplainmark{lof}{both}{\listfigurename}
+  \createplainmark{lot}{both}{\listtablename}
+  \createplainmark{bib}{both}{\bibname}
+  \createplainmark{index}{both}{\indexname}
+  \createplainmark{glossary}{both}{\glossaryname}}
+\makeevenhead{companion}{\normalfont\bfseries\thepage}{}%
+                        {\normalfont\bfseries\leftmark}
+\makeoddhead{companion}{\normalfont\bfseries\rightmark}{}%
+                       {\normalfont\bfseries\thepage}
+
+\newif\ifshowheadfootloc
+  \showheadfootloctrue
+\newcommand*{\showheadfootlocon}{\showheadfootloctrue}
+\newcommand*{\showheadfootlocoff}{\showheadfootlocfalse}
+\newif\ifshowtextblockloc
+  \showtextblockloctrue
+\newcommand*{\showtextblocklocon}{\showtextblockloctrue}
+\newcommand*{\showtextblocklocoff}{\showtextblocklocfalse}
+
+\newcommand*{\framepichead}{%
+\ifshowheadfootloc
+  \begin{picture}(0,0)
+    \unitlength 1pt
+    \put(0,0){\line(1,0){\strip at pt\textwidth}}
+  \end{picture}%
+\fi}
+
+\newcommand*{\framepictextfoot}{%
+  \begin{picture}(0,0)
+    \unitlength 1pt
+    \ifshowheadfootloc
+      \put(0,0){\line(1,0){\strip at pt\textwidth}}
+    \fi
+    \ifshowtextblockloc
+      \put(0,\strip at pt\footskip)%
+        {\framebox(\strip at pt\textwidth,\strip at pt\textheight){}}
+    \fi
+  \end{picture}}
+
+\makepagestyle{showlocs}
+\makeevenhead{showlocs}{\framepichead\thepage}{\thepage}{\thepage}
+\makeoddhead{showlocs}{\framepichead\thepage}{\thepage}{\thepage}
+\makeevenfoot{showlocs}{\framepictextfoot\thepage}{\thepage}{\thepage}
+\makeoddfoot{showlocs}{\framepictextfoot\thepage}{\thepage}{\thepage}
+
+\renewcommand{\pagenumbering}{%
+  \@ifstar{\@smempnum}{\@mempnum}}
+\newcommand{\@smempnum}[1]{%
+  \gdef\thepage{\csname @#1\endcsname \c at page}}
+\newcommand{\@mempnum}[1]{%
+  \@smempnum{#1}\global\c at page \@ne}
+
+\newcounter{storedpagenumber}
+  \setcounter{storedpagenumber}{1}
+\newcommand{\savepagenumber}{\global\c at storedpagenumber \c at page}
+\newcommand{\restorepagenumber}{\global\c at page \c at storedpagenumber}
+
+%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
+\newcommand*{\setSpacing}[1]{%
+  \def\baselinestretch{#1}%
+  \@currsize}
+
+\newcommand*{\setSingleSpace}[1]{%
+  \def\m at m@singlespace{#1}}
+\setSingleSpace{1}
+
+\newcommand*{\SingleSpacing}{%
+  \setSpacing{\m at m@singlespace}%
+  \vskip\baselineskip% correction for coming into single spacing
+}
+\SingleSpacing
+
+\newcommand*{\OnehalfSpacing}{
+  \setSpacing{1.25}% default (10pt)
+  \ifcase \@ptsize \relax   % 10pt
+    \setSpacing{1.25}%
+  \or%  11pt
+    \setSpacing{1.213}%
+  \or%  12pt
+    \setSpacing{1.241}%
+  \or\or% 14pt
+    \setSpacing{1.20}%
+  \or\or\or% 17pt
+    \setSpacing{1.16}%
+  \or\or% 9pt
+    \setSpacing{1.35}%
+  \else% the extended sizes
+    \setSpacing{1.16}%
+  \fi}
+
+\newcommand*{\DoubleSpacing}{
+  \setSpacing{1.667}% default (10pt)
+  \ifcase \@ptsize \relax   % 10pt
+    \setSpacing{1.667}%
+  \or%  11pt
+    \setSpacing{1.618}%
+  \or%  12pt
+    \setSpacing{1.655}%
+  \or\or% 14pt
+    \setSpacing{1.60}%
+  \or\or\or% 17pt
+    \setSpacing{1.545}%
+  \or\or% 9pt
+    \setSpacing{1.8}%
+  \else%       larger sizes
+    \setSpacing{1.5}%
+  \fi}
+
+%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% check what this does!!!!!!!!
+\renewcommand*{\@setsize}[4]{%
+  \@nomath#1%
+  \let\@currsize#1%
+  \baselineskip #2%
+  \baselineskip \baselinestretch\baselineskip
+  \parskip \baselinestretch\parskip
+  \setbox\strutbox \hbox{%
+    \vrule height.7\baselineskip
+           depth .3\baselineskip
+           width \z@}%
+  \skip\footins \baselinestretch\skip\footins
+  \normalbaselineskip\baselineskip#3#4}
+
+\newenvironment{SingleSpace}{%
+  \vskip\baselineskip
+  \setSpacing{\m at m@singlespace}%
+  \vskip -\baselineskip
+}{\par}
+
+\newenvironment{SingleSpace*}{%
+%%  \vskip\baselineskip
+  \setSpacing{\m at m@singlespace}%
+  \vskip 0.5\baselineskip
+}{\vskip -0.5\baselineskip}
+
+\newcommand*{\m at mrestore@spacing}{%
+  \par
+  \vskip \parskip
+  \vskip \baselineskip
+  \endgroup
+  \vskip -\parskip
+  \vskip -\baselineskip}
+
+\newenvironment{Spacing}[1]{%
+  \par
+  \begingroup
+    \setSpacing{#1}}{\m at mrestore@spacing}
+
+\newenvironment{OnehalfSpace}{%
+  \begingroup
+    \OnehalfSpacing}{\m at mrestore@spacing}
+
+\newenvironment{DoubleSpace}{%
+  \begingroup
+    \DoubleSpacing}{\m at mrestore@spacing}
+
+\newcommand*{\memdskipstretch}{0.0}
+\newcommand*{\setDisplayskipStretch}[1]{%
+  \renewcommand*{\memdskipstretch}{#1}}
+\newcommand*{\noDisplayskipStretch}{\setDisplayskipStretch{0.0}}
+
+\newcommand*{\memdskips}{%
+  \advance\abovedisplayskip \memdskipstretch\abovedisplayskip
+  \advance\belowdisplayskip \memdskipstretch\belowdisplayskip
+  \advance\abovedisplayshortskip \memdskipstretch\abovedisplayshortskip
+  \advance\belowdisplayshortskip \memdskipstretch\belowdisplayshortskip}
+\everydisplay\expandafter{%
+  \the\everydisplay
+  \memdskips}
+
+\let\m at m@xfloat\@xfloat
+\def\@xfloat #1[#2]{%
+  \m at m@xfloat #1[#2]%
+  \def\baselinestretch{\m at m@singlespace}%
+  \normalsize}
+
+\newdimen\memPD
+\newenvironment{vminipage}{%
+  \par
+  \@ifnextchar[%]
+    \@ivminipage
+    {\@iiiminipage t\relax[s]}
+}{%
+  \par\global\memPD=\prevdepth
+  \endminipage
+  \par
+  \kern-\memPD%     no pagebreak allowed here
+  \hbox{\vrule depth \memPD width \z@}}
+
+ \def\@ivminipage[#1]{%
+  \@ifnextchar[%]
+    {\@iiminipage{t}}{\@iiiminipage{t}\relax[s]}}
+\newif\ifm at mnzpskip
+\newcommand*{\traditionalparskip}{%
+  \parskip \z@
+  \m at mnzpskipfalse}
+\newskip\m at mabparskip
+\newcommand*{\abnormalparskip}[1]{%
+  \setlength{\parskip}{#1}\m at mabparskip=#1\relax
+  \m at mnzpskiptrue}
+\newcommand*{\nonzeroparskip}{\abnormalparskip{%
+  0.5\baselineskip
+  \@plus .1\baselineskip \@minus .1\baselineskip% NTG
+%%  0.5/baselineskip \@plus 2pt% RF
+}}
+\traditionalparskip
+
+\newcommand{\pretitle}[1]{\def\@bspretitle{#1}}
+\newcommand{\posttitle}[1]{\def\@bsposttitle{#1}}
+\newcommand{\preauthor}[1]{\def\@bspreauthor{#1}}
+\newcommand{\postauthor}[1]{\def\@bspostauthor{#1}}
+\newcommand{\predate}[1]{\def\@bspredate{#1}}
+\newcommand{\postdate}[1]{\def\@bspostdate{#1}}
+
+  \pretitle{\begin{center}\LARGE}
+  \posttitle{\par\end{center}\vskip 0.5em}
+  \preauthor{\begin{center}
+    \large \lineskip .5em%
+    \begin{tabular}[t]{c}}
+  \postauthor{\end{tabular}\par\end{center}}
+  \predate{\begin{center}\large}
+  \postdate{\par\end{center}}
+
+\newcommand{\maketitlehooka}{}
+\newcommand{\maketitlehookb}{}
+\newcommand{\maketitlehookc}{}
+\newcommand{\maketitlehookd}{}
+
+\newcommand{\thanksmarkseries}[1]{%
+  \def\@bsmarkseries{\renewcommand{\thefootnote}%
+                     {\@nameuse{#1}{footnote}}}}
+\newcommand{\symbolthanksmark}{\thanksmarkseries{\fnsymbol}}
+\newcommand{\@bscontmark}{\setcounter{footnote}{0}}
+\newcommand{\continuousmarks}{\def\@bscontmark{}}
+\newcommand{\thanksheadextra}[2]{%
+  \def\@bsthanksheadpre{#1}%
+  \def\@bsthanksheadpost{#2}}
+\DeclareRobustCommand{\thanksmark}[1]{\footnotemark[#1]}
+\newcommand{\thanksgap}[1]{\hspace{#1}}
+\newcommand{\tamark}{\@thefnmark}
+
+\newlength{\thanksmarkwidth}
+\newlength{\thanksmarksep}
+\newcommand{\thanksmarkstyle}[1]{\def\thanksscript##1{#1}}
+\thanksmarkstyle{\textsuperscript{#1}}
+\newcommand{\makethanksmarkhook}{}
+
+\newcommand{\thanksfootmark}{%
+  \ifdim\thanksmarkwidth < \z@
+    \llap{\hb at xt@ -\thanksmarkwidth{%
+          \hss\normalfont\thanksscript{\tamark}}%
+          \hspace*{-\thanksmarkwidth}}%
+  \else
+    \ifdim\thanksmarkwidth = \z@
+      {\normalfont\thanksscript{\tamark}}%
+    \else
+      \hb at xt@\thanksmarkwidth{\hss\normalfont\thanksscript{\tamark}}%
+    \fi
+  \fi}
+
+\newcommand{\makethanksmark}{%
+  \leavevmode%
+  \parindent 1em\noindent
+  \if at RTL\rightskip\else\leftskip\fi\thanksmarksep\relax
+  \advance\if at RTL\rightskip\else\leftskip\fi\thanksmarkwidth \null\nobreak\hskip-\if at RTL\rightskip\else\leftskip\fi\relax
+  \makethanksmarkhook\relax
+  \thanksfootmark}
+
+\newcommand{\usethanksrule}{\let\footnoterule\thanksrule}
+\newcommand{\cancelthanksrule}{\let\footnoterule\@bsfootnoterule}
+
+\thanksmarkseries{fnsymbol}  % symbols
+\thanksheadextra{}{}
+\setlength{\thanksmarkwidth}{1.8em}
+\setlength{\thanksmarksep}{-\thanksmarkwidth}
+
+\AtBeginDocument{%
+  \let\thanksrule\footnoterule
+  \let\@bsfootnoterule\footnoterule
+}
+
+\newlength{\droptitle}
+\setlength{\droptitle}{0pt}
+
+\newcommand{\maketitle}{\par
+  \begingroup
+    \@bsmarkseries
+    \def\@makefnmark{\@textsuperscript{%
+       \normalfont\@bsthanksheadpre \tamark \@bsthanksheadpost}}%
+    \long\def\@makefntext##1{\makethanksmark ##1}
+    \if at twocolumn
+      \ifnum \col at number=\@ne
+        \@maketitle
+      \else
+        \twocolumn[\@maketitle]%
+      \fi
+    \else
+      \ifdim\pagetotal>\z@
+        \newpage
+      \fi
+      \global\@topnum\z@
+      \@maketitle
+    \fi
+    \thispagestyle{title}\@thanks
+  \endgroup
+  \@bscontmark  %  \setcounter{footnote}{0}%
+  }
+\aliaspagestyle{title}{plain}
+
+\newcommand*{\@mem at titlefootkill}[1]{%
+  \@memwarn{Do not use \string\footnote\space in
+            \string\maketitle.\MessageBreak
+            Use \protect\thanks\space instead}}
+
+\newcommand{\@maketitle}{%
+  \let\footnote\@mem at titlefootkill
+  \ifdim\pagetotal>\z@
+    \newpage
+  \fi
+  \null
+  \vskip 2em%
+        \vspace*{\droptitle}
+  \maketitlehooka
+  {\@bspretitle \@title \@bsposttitle}
+  \maketitlehookb
+  {\@bspreauthor \@author \@bspostauthor}
+  \maketitlehookc
+  {\@bspredate \@date \@bspostdate}
+  \maketitlehookd
+  \par
+  \vskip 1.5em}
+
+\newenvironment{titlingpage}%
+  {\let\footnoterule\relax
+   \let\footnotesize\small
+   \if at twocolumn
+     \@restonecoltrue\onecolumn
+   \else
+     \@restonecolfalse
+   \fi
+   \thispagestyle{titlingpage}%
+   \setcounter{page}{\@ne}%
+  }{%
+   \thispagestyle{titlingpage}%
+   \if at restonecol \twocolumn \fi
+   \if at twoside \cleardoublepage \else \clearpage \fi
+   \setcounter{page}{\@ne}}
+\aliaspagestyle{titlingpage}{empty}
+
+\newcommand{\emptythanks}{\global\let\@thanks\@empty}
+
+\newcommand*{\andnext}{%
+  \end{tabular}\\ \begin{tabular}[t]{c}}
+
+\newcommand{\@bsmtitlempty}{%
+  \global\let\maketitle\relax
+  \global\let\@maketitle\relax
+  \global\let\title\relax
+  \global\let\author\relax
+  \global\let\date\relax
+  \global\let\thanksmarkseries\relax
+  \global\let\thanksheadextra\relax
+  \global\let\thanksfootextra\relax
+  \global\let\thanksmark\relax
+  \global\let\thanksgap\relax}
+
+\newcommand{\keepthetitle}{%
+  \@bsmtitlempty
+  \global\let\thanks\relax
+  \global\let\and\relax
+  \global\let\andnext\relax
+  \global\let\@thanks\@empty
+  \global\let\@title\@empty
+  \global\let\@author\@empty
+  \global\let\@date\@empty}
+
+\newcommand{\killtitle}{%
+  \keepthetitle
+  \global\let\thetitle\relax
+  \global\let\theauthor\relax
+  \global\let\thedate\relax}
+
+\addtoiargdef{\title}{%
+  \begingroup\let\footnote\@gobble}{%
+  \begingroup
+    \renewcommand{\thanks}[1]{}
+    \renewcommand{\thanksmark}[1]{}
+    \renewcommand{\thanksgap}[1]{}
+    \protected at xdef\thetitle{#1}
+  \endgroup\endgroup}
+\addtoiargdef{\author}{%
+  \begingroup\let\footnote\@gobble}{%
+  \begingroup
+    \renewcommand{\thanks}[1]{}
+    \renewcommand{\and}{\unskip, }
+    \renewcommand{\andnext}{\unskip, }
+    \renewcommand{\thanksmark}[1]{}
+    \renewcommand{\thanksgap}[1]{}
+    \protected at xdef\theauthor{#1}
+  \endgroup\endgroup}
+\addtoiargdef{\date}{%
+  \begingroup\let\footnote\@gobble}{%
+  \begingroup
+    \renewcommand{\thanks}[1]{}
+    \renewcommand{\thanksmark}[1]{}
+    \renewcommand{\thanksgap}[1]{}
+    \protected at xdef\thedate{#1}
+  \endgroup\endgroup}
+
+\newcommand*{\bookpagemark}[1]{}
+\newcommand*{\partmark}[1]{}
+\newcommand*{\chaptermark}[1]{}
+
+\newcommand*{\bibmark}{}
+\newcommand*{\indexmark}{}
+\newcommand*{\glossarymark}{}
+
+\setcounter{secnumdepth}{2}
+\newcounter{book} \setcounter{book}{0}
+\newcounter{part} \setcounter{part}{0}
+\newcounter{chapter} \setcounter{chapter}{0}
+\newcounter{section}[chapter]
+\newcounter{subsection}[section]
+\newcounter{subsubsection}[subsection]
+\newcounter{paragraph}[subsubsection]
+\newcounter{subparagraph}[paragraph]
+\renewcommand*{\thebook}{\@Roman\c at book}
+\renewcommand*{\thepart}{\@Roman\c at part}
+\renewcommand*{\thechapter}{\@arabic\c at chapter}
+\renewcommand*{\thesection}{\thechapter\@SepMark\@arabic\c at section}
+\renewcommand*{\thesubsection}{%
+              \thesection\@SepMark\@arabic\c at subsection}
+\renewcommand*{\thesubsubsection}{%
+              \thesubsection\@SepMark\@arabic\c at subsubsection}
+\renewcommand*{\theparagraph}{%
+              \thesubsubsection\@SepMark\@arabic\c at paragraph}
+\renewcommand*{\thesubparagraph}{%
+              \theparagraph\@SepMark\@arabic\c at subparagraph}
+\newcommand{\@chapapp}{\chaptername}
+
+\newcommand{\frontmatter}{%
+  \@ifstar{\@smemfront}{\@memfront}}
+\newcommand{\@smemfront}{%
+  \cleardoublepage
+  \@mainmatterfalse
+  \setcounter{secnumdepth}{-10}
+  \counterwithout{figure}{chapter}
+  \counterwithout{table}{chapter}
+}
+\newcommand{\@memfront}{%
+  \@smemfront\pagenumbering{roman}}
+
+\newcommand{\mainmatter}{%
+  \@ifstar{\@smemmain}{\@memmain}}
+\newcommand*{\@smemmain}{%
+  \@mainmattertrue
+  \setcounter{secnumdepth}{\value{maxsecnumdepth}}
+  \ifartopt
+    \if at twoside
+      \cleardoublepage
+    \else
+      \clearpage
+    \fi
+  \else
+    \cleardoublepage
+    \counterwithin{figure}{chapter}
+    \counterwithin{table}{chapter}
+  \fi}
+\newcommand{\@memmain}{%
+  \@smemmain\pagenumbering{arabic}}
+
+\newcommand{\backmatter}{%
+  \ifartopt
+    \clearpage
+  \else
+    \if at openright
+      \cleardoublepage
+    \else
+      \clearpage
+    \fi
+  \fi
+  \@mainmatterfalse
+  \setcounter{secnumdepth}{-10}
+  \ifartopt\else
+    \counterwithout{figure}{chapter}
+    \counterwithout{table}{chapter}
+    \setcounter{figure}{0}
+    \setcounter{table}{0}
+  \fi}
+
+\newcommand*{\theHbook}{\arabic{book}}
+\newcommand*{\toclevel at book}{-2}
+
+\newcommand*{\book}{%
+  \@setupbook
+  \secdef\@book\@sbook}
+\newcommand*{\beforebookskip}{\null\vfil}
+\newcommand*{\midbookskip}{\par\vskip 2\onelineskip}
+\newcommand*{\afterbookskip}{\vfil\newpage}
+
+\newcommand{\@setupbook}{%
+  \if at openright
+    \cleardoublepage
+  \else
+    \clearpage
+  \fi
+  \thispagestyle{book}%
+  \if at twocolumn
+    \onecolumn
+    \@tempswatrue
+  \else
+    \@tempswafalse
+  \fi
+  \beforebookskip}
+
+\newcommand*{\booknamefont}{\normalfont\huge\bfseries}
+\newcommand*{\booknumfont}{\normalfont\huge\bfseries}
+\newcommand*{\booktitlefont}{\normalfont\Huge\bfseries}
+
+\newcommand*{\printbookname}{\booknamefont \bookname}
+\newcommand*{\booknamenum}{\space}
+\newcommand*{\printbooknum}{\booknumfont \thebook}
+\newcommand*{\printbooktitle}[1]{\booktitlefont #1}
+
+\newcommand{\membookinfo}[3]{}
+\newcommand{\membookstarinfo}[1]{}
+
+\long\def\@book[#1]#2{%
+  \M at gettitle{#1}%
+  \phantomsection
+  \ifnum \c at secnumdepth >-3\relax
+    \refstepcounter{book}%
+    \addcontentsline{toc}{book}%
+      {\protect\booknumberline{\thebook}#1}%
+    \membookinfo{\thebook}{#1}{#2}%
+  \else
+    \addcontentsline{toc}{book}{#1}%
+    \membookinfo{}{#1}{#2}%
+  \fi
+  \bookpagemark{#1}%
+  {\centering
+   \interlinepenalty \@M
+   \normalfont
+   \ifnum \c at secnumdepth >-3\relax
+     \printbookname \booknamenum \printbooknum
+     \midbookskip
+   \fi
+   \printbooktitle{#2}\par}%
+  \@endbook}
+
+\long\def\@sbook#1{%
+  \M at gettitle{#1}%
+  \phantomsection
+  \membookstarinfo{#1}%
+  {\centering
+   \interlinepenalty \@M
+   \normalfont
+   \printbooktitle{#1}\par}%
+  \@endbook}
+
+\newif\ifm at mnobooknewpage
+  \m at mnobooknewpagefalse
+\newcommand*{\bookblankpage}{\m at mnobooknewpagefalse}
+\newcommand*{\nobookblankpage}{\m at mnobooknewpagetrue}
+
+\def\@endbook{\afterbookskip
+  \ifm at mnobooknewpage
+  \else
+    \if at twoside
+      \if at openright
+        \null
+        \thispagestyle{afterbook}%
+        \newpage
+      \fi
+    \fi
+  \fi
+  \if at tempswa
+    \twocolumn
+  \fi}
+
+\aliaspagestyle{book}{empty}
+\aliaspagestyle{afterbook}{empty}
+
+\newcommand{\part}{%
+  \@setuppart
+  \secdef\@part\@spart}
+\newcommand{\beforepartskip}{\null\vfil}
+\newcommand{\midpartskip}{\par\vskip 2\onelineskip}
+\newcommand{\afterpartskip}{\vfil\newpage}
+
+\newcommand{\@setuppart}{%
+  \if at openright
+    \cleardoublepage
+  \else
+    \clearpage
+  \fi
+  \thispagestyle{part}%
+  \if at twocolumn
+    \onecolumn
+    \@tempswatrue
+  \else
+    \@tempswafalse
+  \fi
+  \beforepartskip}
+
+\newcommand{\partnamefont}{\normalfont\huge\bfseries}
+\newcommand{\partnumfont}{\normalfont\huge\bfseries}
+\newcommand{\parttitlefont}{\normalfont\Huge\bfseries}
+
+\newcommand{\printpartname}{\partnamefont \partname}
+\newcommand{\partnamenum}{\space}
+\newcommand{\printpartnum}{\partnumfont \thepart}
+\newcommand{\printparttitle}[1]{\parttitlefont #1}
+
+\newcommand{\mempartinfo}[3]{}
+\newcommand{\mempartstarinfo}[1]{}
+
+\long\def\@part[#1]#2{%
+  \M at gettitle{#1}%
+  \phantomsection
+  \ifnum \c at secnumdepth >-2\relax
+    \refstepcounter{part}%
+    \addcontentsline{toc}{part}%
+      {\protect\partnumberline{\thepart}#1}%
+    \mempartinfo{\thepart}{#1}{#2}%
+  \else
+    \addcontentsline{toc}{part}{#1}%
+    \mempartinfo{}{#1}{#2}%
+  \fi
+  \partmark{#1}%
+  {\centering
+   \interlinepenalty \@M
+   \normalfont
+   \ifnum \c at secnumdepth >-2\relax
+     \printpartname \partnamenum \printpartnum
+     \midpartskip
+   \fi
+   \printparttitle{#2}\par}%
+  \@endpart}
+
+\long\def\@spart#1{%
+  \M at gettitle{#1}%
+  \phantomsection
+  \mempartstarinfo{#1}%
+  {\centering
+   \interlinepenalty \@M
+   \normalfont
+   \printparttitle{#1}\par}%
+  \@endpart}
+
+\newif\ifm at mnopartnewpage
+  \m at mnopartnewpagefalse
+\newcommand*{\partblankpage}{\m at mnopartnewpagefalse}
+\newcommand*{\nopartblankpage}{\m at mnopartnewpagetrue}
+
+\def\@endpart{\afterpartskip
+  \ifm at mnopartnewpage
+  \else
+    \if at twoside
+      \if at openright
+        \null
+        \thispagestyle{afterpart}%
+        \newpage
+      \fi
+    \fi
+  \fi
+  \if at tempswa
+    \twocolumn
+  \fi}
+
+\aliaspagestyle{afterpart}{empty}
+
+\newcommand\chapter{%
+  \ifartopt\par\else
+    \clearforchapter
+    \thispagestyle{chapter}
+    \global\@topnum\z@
+  \fi
+  \@afterindentfalse
+  \@ifstar{\@m at mschapter}{\@m at mchapter}}
+
+\newcommand{\@m at mchapter}[1][]{%
+  \def\ch at pt@c{#1}% capture first optional arg
+  \@ifnextchar[{\@chapter}{\@chapter[]}%
+}
+\def\m at m@empty{\@empty}
+
+\newcommand{\memchapinfo}[4]{}
+\newcommand{\memchapstarinfo}[2]{}
+\newcommand{\memappchapinfo}[4]{}
+\newcommand{\memappchapstarinfo}[2]{}
+
+\newif\ifm at mpn@new at chap
+  \m at mpn@new at chapfalse
+\newif\ifm at mpn@new at schap
+  \m at mpn@new at schapfalse
+
+\def\@chapter[#1]#2{%
+  \m at mpn@new at chaptrue
+  \def\f at rbdy{#2}%
+  \ifx\ch at pt@c\@empty % no optional args
+    \def\f at rtoc{#2}%
+    \def\f at rhdr{#2}%
+  \else                  % at least one opt arg
+    \let\f at rtoc\ch at pt@c
+    \ifx\@empty#1\@empty
+      \let\f at rhdr\ch at pt@c
+    \else
+      \def\f at rhdr{#1}%
+    \fi
+  \fi
+  \m at m@Andfalse
+  \ifnum \c at secnumdepth >\m at ne
+    \if at mainmatter
+      \m at m@Andtrue
+    \fi
+  \fi
+  \ifm at m@And
+    \refstepcounter{chapter}%
+  \fi
+  \ifartopt
+    \@makechapterhead{#2}%
+    \@afterheading
+    \chaptermark{\f at rhdr}%
+  \else
+    \chaptermark{\f at rhdr}
+    \insertchapterspace
+    \if at twocolumn
+      \@topnewpage[\@makechapterhead{#2}]%
+    \else
+      \@makechapterhead{#2}%
+    \fi
+    \@afterheading
+  \fi
+  \ifm at m@And
+    \ifanappendix
+      \addcontentsline{toc}{appendix}{%
+        \protect\chapternumberline{\thechapter}\f at rtoc}%
+      \memappchapinfo{\thechapter}{\f at rtoc}{\f at rhdr}{#2}%
+    \else
+      \addcontentsline{toc}{chapter}{%
+        \protect\chapternumberline{\thechapter}\f at rtoc}%
+      \memchapinfo{\thechapter}{\f at rtoc}{\f at rhdr}{#2}%
+    \fi
+  \else
+    \addcontentsline{toc}{chapter}{\f at rtoc}%
+    \ifanappendix
+      \memappchapinfo{}{\f at rtoc}{\f at rhdr}{#2}%
+    \else
+      \memchapinfo{}{\f at rtoc}{\f at rhdr}{#2}%
+    \fi
+  \fi
+  \ifheadnameref\M at gettitle{\f at rhdr}\else\M at gettitle{\f at rtoc}\fi}
+
+\def\@makechapterhead#1{%
+  \chapterheadstart%  \vspace*{50\p@}%
+  {\parindent \z@ \if at RTL\raggedleft\else\raggedright\fi \normalfont
+   \ifm at m@And
+     \printchaptername \chapternamenum \printchapternum
+     \afterchapternum % \par\nobreak \vskip 20\p@
+   \else
+     \printchapternonum
+   \fi
+   \interlinepenalty\@M
+   \printchaptertitle{#1} % \Huge \bfseries #1
+   \afterchaptertitle % \par\nobreak \vskip 40\p@
+  }}
+
+\newcommand*{\insertchapterspace}{%
+  \addtocontents{lof}{\protect\addvspace{10pt}}%
+  \addtocontents{lot}{\protect\addvspace{10pt}}}
+
+\newlength{\beforechapskip}\setlength{\beforechapskip}{50pt}
+\newlength{\midchapskip}\setlength{\midchapskip}{20pt}
+\newlength{\afterchapskip}\setlength{\afterchapskip}{40pt}
+
+\newcommand{\@chs at def@ult}{%
+  \def\chapterheadstart{\vspace*{\beforechapskip}}%
+  \def\printchaptername{\chapnamefont \@chapapp}%
+  \def\chapternamenum{\space}%
+  \def\printchapternum{\chapnumfont \thechapter}%
+  \def\afterchapternum{\par\nobreak\vskip \midchapskip}%
+  \def\printchapternonum{}%
+  \def\printchaptertitle##1{\chaptitlefont ##1}%
+  \def\afterchaptertitle{\par\nobreak\vskip \afterchapskip}%
+  \def\chapnamefont{\normalfont\huge\bfseries}%
+  \def\chapnumfont{\normalfont\huge\bfseries}%
+  \def\chaptitlefont{\normalfont\Huge\bfseries}%
+  \setlength{\beforechapskip}{50pt}%
+  \setlength{\midchapskip}{20pt}%
+  \setlength{\afterchapskip}{40pt}}
+
+\newcommand{\@m at mschapter}[2][\@empty]{%
+  \@schapter{#2}%
+  \ifx \@empty#1
+    \def\f at rhdr{#2}%
+  \else%                    opt arg
+    \def\f at rhdr{#1}%
+    \setcounter{secnumdepth}{-10}%
+    \chaptermark{#1}%
+    \setcounter{secnumdepth}{\value{maxsecnumdepth}}%
+  \fi
+  \ifanappendix
+    \memappchapstarinfo{\f at rhdr}{#2}%
+  \else
+    \memchapstarinfo{\f at rhdr}{#2}%
+  \fi
+  \ifheadnameref\M at gettitle{\f at rhdr}\else\M at gettitle{#2}\fi}
+
+\newcommand{\@schapter}[1]{%
+  \m at mpn@new at schaptrue
+  \def\f at rbdy{#1}%
+  \ifartopt
+    \@makeschapterhead{#1}%
+  \else
+    \if at twocolumn
+      \@topnewpage[\@makeschapterhead{#1}]%
+    \else
+      \@makeschapterhead{#1}%
+    \fi
+  \fi
+  \@afterheading}
+
+\def\@makeschapterhead#1{%
+  \chapterheadstart
+  {\parindent \z@ \if at RTL\raggedleft\else\raggedright\fi \normalfont
+   \printchapternonum
+   \interlinepenalty\@M
+   \printchaptertitle{#1}%
+   \afterchaptertitle}%
+}
+
+\newcommand{\makechapterstyle}[2]{\@namedef{chs@#1}{\@chs at def@ult #2}}
+\newcommand{\chapterstyle}[1]{\@nameuse{chs@#1}}
+
+\makechapterstyle{default}{}%
+%%  \setlength{\beforechapskip}{50pt}
+%%  \def\chapterheadstart{\vspace*{\beforechapskip}}
+%%  \def\chapnamefont{\normalfont\huge\bfseries}
+%%  \def\printchaptername{\chapnamefont \@chapapp}
+%%  \def\chapternamenum{\space}
+%%  \def\chapnumfont{\normalfont\huge\bfseries}
+%%  \def\printchapternum{\chapnumfont \thechapter}
+%%  \setlength{\midchapskip}{20pt}
+%%  \def\afterchapternum{\par\nobreak\vskip \midchapskip}
+%%  \def\printchapternonum{}
+%%  \def\chaptitlefont{\normalfont\Huge\bfseries}
+%%  \def\printchaptertitle##1{\chaptitlefont ##1}
+%%  \setlength{\afterchapskip}{40pt}
+%%  \def\afterchaptertitle{\par\nobreak\vskip \afterchapskip}}
+\chapterstyle{default}
+
+\makechapterstyle{section}{%
+  \chapterstyle{default}
+  \renewcommand{\printchaptername}{}
+  \renewcommand{\chapternamenum}{}
+  \renewcommand{\chapnumfont}{\normalfont\Huge\bfseries}
+  \renewcommand{\printchapternum}{\chapnumfont \thechapter\space}
+  \renewcommand{\afterchapternum}{}}
+
+\makechapterstyle{article}{%
+  \chapterstyle{default}
+  \setlength{\beforechapskip}{3.5ex \@plus 1ex \@minus .2ex}
+  \renewcommand*{\chapterheadstart}{\vspace{\beforechapskip}}
+  \setlength{\afterchapskip}{2.3ex \@plus .2ex}
+  \renewcommand{\printchaptername}{}
+  \renewcommand{\chapternamenum}{}
+  \renewcommand{\chaptitlefont}{\normalfont\Large\bfseries}
+  \renewcommand{\chapnumfont}{\chaptitlefont}
+  \renewcommand{\printchapternum}{\chapnumfont \thechapter\quad}
+  \renewcommand{\afterchapternum}{}}
+
+\makechapterstyle{reparticle}{%
+  \chapterstyle{default}
+  \setlength{\beforechapskip}{3.5ex \@plus 1ex \@minus .2ex}
+  \renewcommand*{\chapterheadstart}{\vspace{\beforechapskip}}
+  \setlength{\afterchapskip}{2.3ex \@plus .2ex}
+  \renewcommand*{\printchaptername}{}
+  \renewcommand*{\chapternamenum}{}
+  \renewcommand*{\chaptitlefont}{\normalfont\Large\bfseries}
+  \renewcommand*{\chapnumfont}{\chaptitlefont}
+  \renewcommand*{\printchapternum}{\@hangfrom{\chapnumfont \thechapter\quad}}%
+  \renewcommand*{\afterchapternum}{}}
+
+\newcommand*{\reparticle}{%
+  \chapterstyle{reparticle}
+  \setsecheadstyle{\normalfont\large\bfseries\if at RTL\raggedleft\else\raggedright\fi}
+  \setsubsecheadstyle{\normalfont\bfseries\if at RTL\raggedleft\else\raggedright\fi}}
+
+\makechapterstyle{hangnum}{%
+  \chapterstyle{default}
+  \renewcommand*{\chapnumfont}{\chaptitlefont}
+  \settowidth{\chapindent}{\chapnumfont 999}
+  \renewcommand*{\printchaptername}{}
+  \renewcommand*{\chapternamenum}{}
+  \renewcommand*{\printchapternum}{%
+    \noindent\llap{\makebox[\chapindent][l]{\chapnumfont \thechapter}}}
+  \renewcommand*{\afterchapternum}{}}
+
+\newlength{\chapindent}
+
+\makechapterstyle{companion}{%
+  \chapterstyle{default}
+  \renewcommand*{\chapnamefont}{\normalfont\LARGE\scshape}
+  \renewcommand*{\printchaptername}{\raggedleft\chapnamefont \@chapapp}
+  \renewcommand*{\chapnumfont}{\normalfont\Huge}
+  \setlength{\chapindent}{\marginparsep}
+  \addtolength{\chapindent}{\marginparwidth}
+  \renewcommand*{\printchaptertitle}[1]{%
+    \begin{adjustwidth}{}{-\chapindent}
+      \raggedleft \chaptitlefont ##1\par\nobreak
+    \end{adjustwidth}}}
+
+\makechapterstyle{demo}{%
+  \chapterstyle{default}
+  \renewcommand*{\printchaptername}{\centering}
+  \renewcommand*{\printchapternum}{\chapnumfont \numtoName{\c at chapter}}
+  \renewcommand*{\chaptitlefont}{\normalfont\Huge\sffamily}
+  \renewcommand*{\printchaptertitle}[1]{%
+    \hrule\vskip\onelineskip \raggedleft \chaptitlefont ##1}
+  \renewcommand*{\afterchaptertitle}%
+               {\vskip\onelineskip \hrule\vskip \afterchapskip}}
+
+\makechapterstyle{bianchi}{%
+  \chapterstyle{default}
+  \renewcommand*{\chapnamefont}{\normalfont\Large\sffamily\itshape}
+  \renewcommand*{\chapnumfont}{\normalfont\huge}
+  \renewcommand*{\printchaptername}{%
+    \chapnamefont\centering\@chapapp}
+  \renewcommand*{\printchapternum}{\chapnumfont \textit{\thechapter}}
+  \renewcommand*{\chaptitlefont}{\normalfont\Huge\sffamily}
+  \renewcommand*{\printchaptertitle}[1]{%
+    \hrule\vskip\onelineskip \centering \chaptitlefont\textbf{##1}\par}
+  \renewcommand*{\afterchaptertitle}{\vskip\onelineskip \hrule\vskip
+    \afterchapskip}
+  \renewcommand*{\printchapternonum}{%
+    \vphantom{\chapnumfont \textit{9}}\afterchapternum}}
+
+\makechapterstyle{bringhurst}{%
+  \chapterstyle{default}
+  \renewcommand*{\chapterheadstart}{}
+  \renewcommand*{\printchaptername}{}
+  \renewcommand*{\chapternamenum}{}
+  \renewcommand*{\printchapternum}{}
+  \renewcommand*{\afterchapternum}{}
+  \renewcommand*{\printchaptertitle}[1]{%
+    \if at RTL\raggedleft\else\raggedright\fi\Large\scshape\MakeLowercase{##1}}
+  \renewcommand*{\afterchaptertitle}{%
+  \vskip\onelineskip \hrule\vskip\onelineskip}}
+
+\makechapterstyle{brotherton}{%
+  \chapterstyle{default}
+  \renewcommand*{\printchapternum}{\chapnumfont
+    \ifanappendix \thechapter \else \numtoName{\c at chapter}\fi}}
+
+\makechapterstyle{chappell}{%
+  \chapterstyle{default}
+  \setlength{\beforechapskip}{0pt}
+  \renewcommand*{\chapnamefont}{\large\centering}
+  \renewcommand*{\chapnumfont}{\large}
+  \renewcommand*{\printchapternonum}{%
+    \vphantom{\printchaptername \chapnumfont 1}
+    \afterchapternum
+    \vskip \onelineskip \vskip -\topskip}
+  \renewcommand*{\chaptitlefont}{\Large\itshape}
+  \renewcommand*{\printchaptertitle}[1]{%
+    \hrule\vskip\onelineskip \centering\chaptitlefont ##1}}
+
+\makechapterstyle{culver}{%
+  \chapterstyle{default}
+  \chapterstyle{article}%
+  \renewcommand*{\thechapter}{\Roman{chapter}}
+  \renewcommand*{\printchapternum}{% center number/title
+    \centering\chapnumfont \thechapter\space\space}%
+  \renewcommand*{\printchapternonum}{\centering}
+  \renewcommand*{\clearforchapter}{}% no new page
+  \aliaspagestyle{chapter}{headings}}% no special pagestyle
+
+\makechapterstyle{dash}{%
+  \chapterstyle{default}
+  \setlength{\beforechapskip}{5\onelineskip}
+  \renewcommand*{\printchaptername}{}
+  \renewcommand*{\chapternamenum}{}
+  \renewcommand*{\chapnumfont}{\normalfont\large}
+  \settoheight{\midchapskip}{\chapnumfont 1}
+  \renewcommand*{\printchapternum}{\centering \chapnumfont
+    \rule[0.5\midchapskip]{1em}{0.4pt} \thechapter\
+    \rule[0.5\midchapskip]{1em}{0.4pt}}
+  \renewcommand*{\afterchapternum}{\par\nobreak\vskip 0.5\onelineskip}
+  \renewcommand*{\printchapternonum}{\centering
+                 \vphantom{\chapnumfont 1}\afterchapternum}
+  \renewcommand*{\chaptitlefont}{\normalfont\Large}
+  \renewcommand*{\printchaptertitle}[1]{\centering \chaptitlefont ##1}
+  \setlength{\afterchapskip}{2.5\onelineskip}}
+
+\makechapterstyle{demo2}{%
+  \chapterstyle{default}
+  \renewcommand*{\printchaptername}{\centering}
+  \renewcommand*{\printchapternum}{\chapnumfont
+     \ifanappendix \thechapter \else \numtoName{\c at chapter}\fi}
+  \renewcommand*{\chaptitlefont}{\normalfont\Huge\sffamily}
+  \renewcommand*{\printchaptertitle}[1]{%
+    \hrule\vskip\onelineskip \raggedleft \chaptitlefont ##1}
+  \renewcommand*{\afterchaptertitle}{%
+    \vskip\onelineskip \hrule\vskip \afterchapskip}
+  \setlength{\beforechapskip}{3\baselineskip}
+  \renewcommand*{\printchapternonum}{%
+    \vphantom{\chapnumfont One}
+    \afterchapternum%
+    \vskip\topskip}
+  \setlength{\beforechapskip}{2\onelineskip}}
+
+\makechapterstyle{demo3}{%
+  \chapterstyle{default}
+  \renewcommand*{\printchaptername}{\centering}
+  \renewcommand*{\chapnumfont}{\normalfont\HUGE\itshape}
+  \renewcommand*{\printchapternum}{\chapnumfont
+     \ifanappendix \thechapter \else \numtoName{\c at chapter}\fi}
+  \renewcommand*{\chaptitlefont}{\normalfont\Huge\sffamily}
+  \renewcommand*{\printchaptertitle}[1]{%
+    \hrule\vskip\onelineskip \raggedleft \chaptitlefont ##1}
+  \renewcommand*{\afterchaptertitle}{%
+    \vskip\onelineskip \hrule\vskip \afterchapskip}
+  \setlength{\beforechapskip}{0pt}
+  \setlength{\midchapskip}{2\onelineskip}
+  \setlength{\afterchapskip}{2\onelineskip}
+  \renewcommand*{\printchapternonum}{%
+    \vphantom{\chapnumfont One}
+    \afterchapternum%
+    \vskip\topskip}}
+
+\makechapterstyle{ell}{%
+  \chapterstyle{default}
+  \renewcommand*{\chapnumfont}{\normalfont\HUGE\sffamily}
+  \renewcommand*{\chaptitlefont}{\normalfont\huge\sffamily}
+  \settowidth{\chapindent}{\chapnumfont 111}
+  \renewcommand*{\chapterheadstart}{\begingroup
+    \vspace*{\beforechapskip}%
+    \begin{adjustwidth}{}{-\chapindent}%
+    \hrulefill
+    \smash{\rule{0.4pt}{15mm}}
+    \end{adjustwidth}\endgroup}
+  \renewcommand*{\printchaptername}{}
+  \renewcommand*{\chapternamenum}{}
+  \renewcommand*{\printchapternum}{%
+    \begin{adjustwidth}{}{-\chapindent}
+    \hfill
+    \raisebox{10mm}[0pt][0pt]{\chapnumfont \thechapter}%
+                              \hspace*{1em}
+    \end{adjustwidth}\vspace*{-3.0\onelineskip}}
+  \renewcommand*{\printchaptertitle}[1]{%
+    \vskip\onelineskip
+    \raggedleft {\chaptitlefont ##1}\par\nobreak}}
+
+\makechapterstyle{ger}{%
+  \chapterstyle{default}
+  \renewcommand*{\chapterheadstart}{\vspace*{\beforechapskip}
+  \mbox{}\\\mbox{}\rule[0pt]{\textwidth}{0.4pt}\par}
+  \setlength{\midchapskip}{20pt}
+  \renewcommand*{\printchaptertitle}[1]{\chaptitlefont ##1
+    \\\mbox{}\rule[5pt]{\textwidth}{0.4pt}}}
+
+\makechapterstyle{lyhne}{%  needs graphicx package
+  \chapterstyle{default}
+  \setlength{\beforechapskip}{1.5cm}
+  \setlength{\afterchapskip}{1cm}
+  \setlength{\midchapskip}{2cm}
+  \renewcommand*{\chapnamefont}{\normalfont\normalsize\scshape\raggedleft}
+  \renewcommand*{\chaptitlefont}{\normalfont\normalsize\bfseries\sffamily\raggedleft}
+  \renewcommand*{\chapternamenum}{}
+  \renewcommand*{\printchapternum}{\makebox[0pt][l]{\hspace{0.2em}%
+    \resizebox{!}{2ex}{\chapnamefont\bfseries\sffamily\thechapter}}}
+  \renewcommand*{\afterchapternum}{\par\hspace{1.5cm}\hrule\vspace{0.2cm}}
+ \renewcommand*{\printchapternonum}{\vphantom{\chapnamefont 1}\afterchapternum}
+  \renewcommand*{\afterchaptertitle}{\vskip 0.2cm
+    \hrule\vskip\afterchapskip}}
+
+\makechapterstyle{madsen}{% requires graphicx package
+  \chapterstyle{default}
+  \renewcommand*{\chapnamefont}{%
+    \normalfont\Large\scshape\raggedleft}
+  \renewcommand*{\chaptitlefont}{%
+    \normalfont\Huge\bfseries\sffamily\raggedleft}
+  \renewcommand*{\chapternamenum}{}
+  \renewcommand*{\printchapternum}{%
+    \makebox[0pt][l]{\hspace{0.4em}
+      \resizebox{!}{4ex}{%
+        \chapnamefont\bfseries\sffamily\thechapter}
+    }%
+  }%
+  \renewcommand*{\afterchapternum}{%
+    \par\hspace{1.5cm}\hrule\vskip\midchapskip}}
+
+\newcommand*{\colorchapnum}{}
+\newcommand*{\colorchaptitle}{}
+\makechapterstyle{pedersen}{%
+  \chapterstyle{default}
+  \setlength{\beforechapskip}{-20pt}
+  \setlength{\afterchapskip}{10pt}
+  \renewcommand*{\chapnamefont}{\normalfont\LARGE\itshape}
+  \renewcommand*{\chapnumfont}{\normalfont\HUGE\itshape\colorchapnum}
+  \renewcommand*{\chaptitlefont}{\normalfont\huge\itshape\colorchaptitle}
+  \renewcommand*{\afterchapternum}{}
+  \renewcommand*{\printchaptername}{}
+  \setlength{\midchapskip}{20mm}% was \numberheight
+  \renewcommand*{\chapternamenum}{}
+  \renewcommand*{\printchapternum}{%
+    \sidebar{\raisebox{0pt}[0pt][0pt]{\makebox[0pt][l]{%
+      \resizebox{!}{\midchapskip}{\chapnumfont\thechapter}}}}}
+  \renewcommand*{\printchaptertitle}[1]{\chaptitlefont ##1}}
+
+%% Thomas Dye's southall chapter style
+\makechapterstyle{southall}{%
+  \chapterstyle{default}
+  \setlength{\afterchapskip}{5\baselineskip}
+  \setlength{\beforechapskip}{36pt}%    \headindent
+  \setlength{\midchapskip}{\textwidth}% \rightblock
+  \addtolength{\midchapskip}{-\beforechapskip}
+  \renewcommand*{\chapterheadstart}{\vspace*{2\baselineskip}}
+  \renewcommand*{\chaptitlefont}{\huge\rmfamily\if at RTL\raggedleft\else\raggedright\fi}
+  \renewcommand*{\chapnumfont}{\chaptitlefont}
+  \renewcommand*{\printchaptername}{}
+  \renewcommand*{\chapternamenum}{}
+  \renewcommand*{\afterchapternum}{}
+  \renewcommand*{\printchapternum}{%
+    \begin{minipage}[t][\baselineskip][b]{\beforechapskip}
+      {\vspace{0pt}\chapnumfont%%%\figureversion{lining}
+                   \thechapter}
+    \end{minipage}}
+  \renewcommand*{\printchaptertitle}[1]{%
+    \hfill\begin{minipage}[t]{\midchapskip}
+      {\vspace{0pt}\chaptitlefont ##1\par}\end{minipage}}
+  \renewcommand*{\afterchaptertitle}{%
+    \par\vspace{\baselineskip}%
+    \hrulefill \par\nobreak\noindent \vskip \afterchapskip}}
+
+\makechapterstyle{thatcher}{%
+  \chapterstyle{default}
+  \renewcommand*{\chapterheadstart}{}
+  \renewcommand*{\printchaptername}{%
+    \centerline{\chapnumfont{\@chapapp\ \thechapter}}}
+  \renewcommand*{\chapternamenum}{}
+  \renewcommand*{\chapnumfont}{\normalfont\scshape\MakeLowercase}
+  \renewcommand*{\printchapternum}{}
+  \renewcommand*{\afterchapternum}{%
+    \par\centerline{\parbox{0.5in}{\hrulefill}}\par}
+  \renewcommand*{\printchapternonum}{%
+    \vphantom{\chapnumfont \@chapapp 1}\par
+    \parbox{0.5in}{}\par}
+  \renewcommand*{\chaptitlefont}{\normalfont\large}
+  \renewcommand*{\printchaptertitle}[1]{%
+    \centering \chaptitlefont\MakeUppercase{##1}}}
+
+\makechapterstyle{veelo}{%
+   \setlength{\afterchapskip}{40pt}
+  \renewcommand*{\chapterheadstart}{\vspace*{40pt}}
+  \renewcommand*{\afterchapternum}{\par\nobreak\vskip 25pt}
+   \renewcommand*{\chapnamefont}{\normalfont\LARGE\flushright}
+   \renewcommand*{\chapnumfont}{\normalfont\HUGE}
+   \renewcommand*{\chaptitlefont}{\normalfont\HUGE\bfseries\flushright}
+   \renewcommand*{\printchaptername}{%
+     \chapnamefont\MakeUppercase{\@chapapp}}
+   \renewcommand*{\chapternamenum}{}
+  \setlength{\beforechapskip}{18mm}%  \numberheight
+  \setlength{\midchapskip}{\paperwidth}% \barlength
+  \addtolength{\midchapskip}{-\textwidth}
+  \addtolength{\midchapskip}{-\spinemargin}
+   \renewcommand*{\printchapternum}{%
+     \makebox[0pt][l]{%
+       \hspace{.8em}%
+       \resizebox{!}{\beforechapskip}{\chapnumfont \thechapter}%
+       \hspace{.8em}%
+       \rule{\midchapskip}{\beforechapskip}%
+     }%
+   }%
+   \makeoddfoot{plain}{}{}{\thepage}}
+
+\makechapterstyle{verville}{%
+ % \chapterstyle{default}
+  \setlength{\beforechapskip}{0pt}
+  \renewcommand*{\printchaptername}{}
+  \renewcommand*{\printchapternum}{%
+    \hrule \vskip 0.5\onelineskip
+    \Huge \centering \thechapter.\ }
+  \renewcommand*{\printchapternonum}{%
+    \hrule \vskip 0.5\onelineskip
+    \Huge \centering}
+  \renewcommand*{\afterchapternum}{}
+  \setlength{\midchapskip}{0pt}
+  \renewcommand*{\printchaptertitle}[1]{%
+    ##1 \par
+    \vskip 0.5\onelineskip
+   \hrule}}
+
+\makechapterstyle{crosshead}{%
+  \setlength{\beforechapskip}{2\onelineskip}%
+  \renewcommand*{\chapterheadstart}{\vspace{\beforechapskip}}%
+  \setlength{\afterchapskip}{2\onelineskip \@plus .2\onelineskip
+                             \@minus 0.2\onelineskip}%
+  \renewcommand*{\printchaptername}{}%
+  \renewcommand*{\chapternamenum}{}%
+  \renewcommand*{\chapnumfont}{\normalfont\LARGE\bfseries}%
+  \renewcommand*{\chaptitlefont}{\chapnumfont}%
+  \renewcommand*{\printchapternum}{%
+    \centering\chapnumfont \thechapter\quad}%
+  \renewcommand{\afterchapternum}{}%
+  \renewcommand*{\printchapternonum}{\centering}}
+
+\makechapterstyle{dowding}{%
+  \setlength{\beforechapskip}{2\onelineskip}%
+  \setlength{\afterchapskip}{1.5\onelineskip \@plus .1\onelineskip
+                            \@minus 0.167\onelineskip}%
+  \renewcommand*{\chapnamefont}{\normalfont}%
+  \renewcommand*{\chapnumfont}{\chapnamefont}%
+  \renewcommand*{\printchapternum}{\centering\chapnumfont \ifanappendix \thechapter
+                 \else \numtoName{\c at chapter}\fi}%
+  \renewcommand*{\chaptitlefont}{\normalfont\itshape\huge\centering}%
+  \renewcommand*{\printchapternonum}{%
+    \vphantom{\printchaptername}\vskip\midchapskip}}
+
+\makechapterstyle{komalike}{%
+  \setlength{\beforechapskip}{2\onelineskip}%
+  \setlength{\afterchapskip}{1.5\onelineskip \@plus .1\onelineskip
+                             \@minus 0.167\onelineskip}%
+  \renewcommand*{\printchaptername}{}%
+  \renewcommand*{\chapternamenum}{}%
+  \renewcommand*{\chapnumfont}{\normalfont\LARGE\sffamily\bfseries}%
+  \renewcommand*{\printchapternum}{\chapnumfont \thechapter\space}%
+  \renewcommand*{\afterchapternum}{}%
+  \renewcommand*{\chaptitlefont}{\normalfont\LARGE\sffamily\bfseries}}
+
+\makechapterstyle{ntglike}{%
+  \setlength{\beforechapskip}{50pt \@plus 20pt}%
+  \renewcommand*{\chapnamefont}{\normalfont\Large\bfseries}%
+  \renewcommand*{\chapnumfont}{\normalfont\Large\bfseries}%
+  \renewcommand*{\chaptitlefont}{\normalfont\Large\bfseries}}
+
+\makechapterstyle{tandh}{%
+  \setlength{\beforechapskip}{1\onelineskip}%
+  \setlength{\afterchapskip}{2\onelineskip \@plus .1\onelineskip
+                            \@minus 0.167\onelineskip}%
+  \renewcommand*{\printchaptername}{}%
+  \renewcommand*{\chapternamenum}{}%
+  \renewcommand*{\chapnumfont}{\normalfont\huge\bfseries}%
+  \renewcommand*{\printchapternum}{\chapnumfont \thechapter\quad}%
+  \renewcommand*{\afterchapternum}{}%
+  \renewcommand*{\chaptitlefont}{\chapnumfont\if at RTL\raggedleft\else\raggedright\fi}}
+
+\makechapterstyle{wilsondob}{%
+  \setlength{\beforechapskip}{2\onelineskip}%
+  \setlength{\afterchapskip}{4\onelineskip \@plus .1\onelineskip
+                             \@minus 0.167\onelineskip}%
+  \renewcommand*{\printchaptername}{}%
+  \renewcommand*{\chapternamenum}{}%
+  \renewcommand*{\chapnumfont}{\normalfont\Huge\itshape}%
+  \renewcommand*{\printchapternum}{\raggedleft\chapnumfont \thechapter\quad}%
+  \renewcommand*{\afterchapternum}{}%
+  \renewcommand*{\chaptitlefont}{\chapnumfont}%
+  \renewcommand*{\printchapternonum}{\raggedleft}}
+
+\newif\ifraggedbottomsection
+  \raggedbottomsectionfalse
+\newcommand*{\raggedbottomsection}{\raggedbottomsectiontrue}
+\newcommand*{\normalbottomsection}{\raggedbottomsectionfalse}
+
+\newlength{\bottomsectionskip}
+  \setlength{\bottomsectionskip}{10mm}
+
+\newcommand{\@trplargomm}[1]{%
+  \@ifnextchar[{\@xtrplargomm{#1}}%
+               {\@xxtrplarg{#1}}}
+\long\def\@xtrplargomm#1[#2]{\@dblarg{#1[#2]}}
+\newcommand{\@xxtrplarg}[2]{#1[{#2}][{#2}]{#2}}
+\newcommand{\@trplargoom}[1]{%
+  \@ifnextchar[{\@xtrplargoom{#1}}%
+               {\@xxtrplarg{#1}}}
+\long\def\@xtrplargoom#1[#2]{%
+  \@ifnextchar[{#1[{#2}]}%
+               {#1[{#2}][{#2}]}}
+
+\newcommand{\memsecinfo}[5]{}
+\newcommand{\memsecstarinfo}[2]{}
+
+\renewcommand{\@startsection}[6]{%
+  \ifraggedbottomsection\if at nobreak\else
+    \vskip\z@\@plus\bottomsectionskip
+    \penalty\z@
+    \vskip\z@\@plus -\bottomsectionskip
+  \fi\fi
+  \def\m at msecn@me{#1}%
+  \if at noskipsec \leavevmode \fi
+  \par
+  \@tempskipa #4\relax
+  \@afterindenttrue
+  \ifdim \@tempskipa <\z@
+    \@tempskipa -\@tempskipa \@afterindentfalse
+  \fi
+  \if at nobreak
+    \everypar{}%
+  \else
+    \addpenalty\@secpenalty\addvspace\@tempskipa
+  \fi
+  \@ifstar
+    {\@ssect{#3}{#4}{#5}{#6}}%
+    {\@trplargoom{\M at sect{#1}{#2}{#3}{#4}{#5}{#6}}}}
+
+\def\M at sect#1#2#3#4#5#6[#7][#8]#9{%
+  \ifheadnameref\M at gettitle{#8}\else\M at gettitle{#7}\fi
+  \ifnum #2>\c at secnumdepth
+    \let\@svsec\@empty
+    \memsecinfo{#1}{}{#7}{#8}{#9}%
+  \else
+    \refstepcounter{#1}%
+    \protected at edef\@svsec{\@seccntformat{#1}\relax}%
+    \memsecinfo{#1}{\@nameuse{the#1}}{#7}{#8}{#9}%
+  \fi
+  \@tempskipa #5\relax
+  \ifdim \@tempskipa>\z@
+    \begingroup
+      #6{%
+      \@hangfrom{\hskip #3\relax\@svsec}%
+        \interlinepenalty \@M #9\@@par}%
+    \endgroup
+    \csname #1mark\endcsname{#8}%
+    \addcontentsline{toc}{#1}{%
+      \ifnum #2>\c at secnumdepth \else
+        \protect\numberline{\csname the#1\endcsname}%
+      \fi
+      #7}%
+  \else
+    \def\@svsechd{%
+      #6{\hskip #3\relax
+     \@svsec #9}%
+     \csname #1mark\endcsname{#8}%
+     \addcontentsline{toc}{#1}{%
+       \ifnum #2>\c at secnumdepth \else
+        \protect\numberline{\csname the#1\endcsname}%
+       \fi
+       #7}}%
+  \fi
+  \@xsect{#5}}
+
+\let\@mem at old@ssect\@ssect
+\def\@ssect#1#2#3#4#5{%
+  \M at gettitle{#5}%
+  \memsecstarinfo{\m at msecn@me}{#5}%
+  \@mem at old@ssect{#1}{#2}{#3}{#4}{#5}}
+
+\newcommand{\section}{%
+  \sechook%
+  \@startsection{section}{1}%  level 1
+      {\secindent}%            heading indent
+      {\beforesecskip}%        skip before the heading
+      {\aftersecskip}%         skip after the heading
+      {\normalfont\secheadstyle}} % font
+\newcommand{\sechook}{}
+\newcommand{\setsechook}[1]{\renewcommand{\sechook}{#1}}
+\newlength{\secindent}
+\newcommand{\setsecindent}[1]{\setlength{\secindent}{#1}}
+  \setsecindent{\z@}
+\newskip\beforesecskip
+\newcommand{\setbeforesecskip}[1]{\setlength{\beforesecskip}{#1}}
+  \setbeforesecskip{-3.5ex \@plus -1ex \@minus -.2ex}
+\newskip\aftersecskip
+\newcommand{\setaftersecskip}[1]{\setlength{\aftersecskip}{#1}}
+  \setaftersecskip{2.3ex \@plus .2ex}
+\newcommand{\secheadstyle}{}
+\newcommand{\setsecheadstyle}[1]{\renewcommand{\secheadstyle}{#1}}
+  \setsecheadstyle{\Large\bfseries\if at RTL\raggedleft\else\raggedright\fi}
+
+\newcommand{\subsection}{%
+  \subsechook%
+  \@startsection{subsection}{2}%  level 2
+      {\subsecindent}%            heading indent
+      {\beforesubsecskip}%        skip before the heading
+      {\aftersubsecskip}%         skip after the heading
+      {\normalfont\subsecheadstyle}} % font
+\newcommand{\subsechook}{}
+\newcommand{\setsubsechook}[1]{\renewcommand{\subsechook}{#1}}
+\newlength{\subsecindent}
+\newcommand{\setsubsecindent}[1]{\setlength{\subsecindent}{#1}}
+  \setsubsecindent{\z@}
+\newskip\beforesubsecskip
+\newcommand{\setbeforesubsecskip}[1]{\setlength{\beforesubsecskip}{#1}}
+  \setbeforesubsecskip{-3.25ex \@plus -1ex \@minus -.2ex}
+\newskip\aftersubsecskip
+\newcommand{\setaftersubsecskip}[1]{\setlength{\aftersubsecskip}{#1}}
+  \setaftersubsecskip{1.5ex \@plus .2ex}
+\newcommand{\subsecheadstyle}{}
+\newcommand{\setsubsecheadstyle}[1]{\renewcommand{\subsecheadstyle}{#1}}
+  \setsubsecheadstyle{\large\bfseries\if at RTL\raggedleft\else\raggedright\fi}
+
+\newcommand{\subsubsection}{%
+  \subsubsechook%
+  \@startsection{subsubsection}{3}%  level 3
+      {\subsubsecindent}%            heading indent
+      {\beforesubsubsecskip}%        skip before the heading
+      {\aftersubsubsecskip}%         skip after the heading
+      {\normalfont\subsubsecheadstyle}} % font
+\newcommand{\subsubsechook}{}
+\newcommand{\setsubsubsechook}[1]{\renewcommand{\subsubsechook}{#1}}
+\newlength{\subsubsecindent}
+\newcommand{\setsubsubsecindent}[1]{%
+            \setlength{\subsubsecindent}{#1}}
+  \setsubsubsecindent{\z@}
+\newskip\beforesubsubsecskip
+\newcommand{\setbeforesubsubsecskip}[1]{%
+            \setlength{\beforesubsubsecskip}{#1}}
+  \setbeforesubsubsecskip{-3.25ex \@plus -1ex \@minus -.2ex}
+\newskip\aftersubsubsecskip
+\newcommand{\setaftersubsubsecskip}[1]{%
+            \setlength{\aftersubsubsecskip}{#1}}
+  \setaftersubsubsecskip{1.5ex \@plus .2ex}
+\newcommand{\subsubsecheadstyle}{}
+\newcommand{\setsubsubsecheadstyle}[1]{%
+            \renewcommand{\subsubsecheadstyle}{#1}}
+  \setsubsubsecheadstyle{\normalsize\bfseries\if at RTL\raggedleft\else\raggedright\fi}
+
+\newcommand{\paragraph}{%
+  \parahook%
+  \@startsection{paragraph}{4}%  level 4
+      {\paraindent}%            heading indent
+      {\beforeparaskip}%        skip before the heading
+      {\afterparaskip}%         skip after the heading
+      {\normalfont\paraheadstyle}} % font
+\newcommand{\parahook}{}
+\newcommand{\setparahook}[1]{\renewcommand{\parahook}{#1}}
+\newlength{\paraindent}
+\newcommand{\setparaindent}[1]{\setlength{\paraindent}{#1}}
+  \setparaindent{\z@}
+\newskip\beforeparaskip
+\newcommand{\setbeforeparaskip}[1]{\setlength{\beforeparaskip}{#1}}
+  \setbeforeparaskip{3.25ex \@plus 1ex \@minus .2ex}
+\newskip\afterparaskip
+\newcommand{\setafterparaskip}[1]{\setlength{\afterparaskip}{#1}}
+  \setafterparaskip{-1em}
+\newcommand{\paraheadstyle}{}
+\newcommand{\setparaheadstyle}[1]{\renewcommand{\paraheadstyle}{#1}}
+  \setparaheadstyle{\normalsize\bfseries}
+
+\newcommand{\subparagraph}{%
+  \subparahook%
+  \@startsection{subparagraph}{5}%  level 5
+      {\subparaindent}%            heading indent
+      {\beforesubparaskip}%        skip before the heading
+      {\aftersubparaskip}%         skip after the heading
+      {\normalfont\subparaheadstyle}} % font
+\newcommand{\subparahook}{}
+\newcommand{\setsubparahook}[1]{\renewcommand{\subparahook}{#1}}
+\newlength{\subparaindent}
+\newcommand{\setsubparaindent}[1]{%
+            \setlength{\subparaindent}{#1}}
+  \setsubparaindent{\parindent}
+\newskip\beforesubparaskip
+\newcommand{\setbeforesubparaskip}[1]{%
+            \setlength{\beforesubparaskip}{#1}}
+  \setbeforesubparaskip{3.25ex \@plus 1ex \@minus .2ex}
+\newskip\aftersubparaskip
+\newcommand{\setaftersubparaskip}[1]{%
+            \setlength{\aftersubparaskip}{#1}}
+  \setaftersubparaskip{-1em}
+\newcommand{\subparaheadstyle}{}
+\newcommand{\setsubparaheadstyle}[1]{%
+            \renewcommand{\subparaheadstyle}{#1}}
+  \setsubparaheadstyle{\normalsize\bfseries}
+
+\newcommand{\sethangfrom}[1]{\renewcommand{\@hangfrom}[1]{#1}}
+\newcommand{\setsecnumformat}[1]{\renewcommand{\@seccntformat}[1]{#1}}
+\newcommand{\hangsecnum}{%
+  \def\@seccntformat##1{\llap{\csname the##1\endcsname\quad}}}
+\newcommand{\defaultsecnum}{%
+  \def\@seccntformat##1{\csname the##1\endcsname\quad}}
+
+\newcommand{\plainbreak}{\@ifstar{\@spbreak}{\@pbreak}}
+\newcommand*{\@pbreak}[1]{\par
+  \penalty -100
+  \vskip #1\onelineskip \@plus 2\onelineskip
+  \penalty -20
+  \vskip \z@ \@plus -2\onelineskip
+  \@afterindentfalse
+  \@afterheading}
+\newcommand*{\@spbreak}[1]{\par
+  \penalty -100
+  \vskip #1\onelineskip \@plus 2\onelineskip
+  \penalty -20
+  \vskip \z@ \@plus -2\onelineskip
+  \@afterindenttrue
+  \@afterheading}
+
+\newcommand{\fancybreak}{\@ifstar{\@sfbreak}{\@fbreak}}
+\newcommand{\@fbreak}[1]{\par
+  \penalty -100
+  \noindent\parbox{\linewidth}{\centering #1}%%\null
+  \par
+%%  \penalty -20
+%%  \vskip -\onelineskip
+  \@afterindentfalse
+  \@afterheading}
+\newcommand{\@sfbreak}[1]{\par
+  \penalty -100
+  \noindent\parbox{\linewidth}{\centering #1}%%\null
+  \par
+%%  \penalty -20
+%%  \vskip -\onelineskip
+  \@afterindenttrue
+  \@afterheading}
+
+\newcommand{\plainfancybreak}{\@ifstar{\@spfbreak}{\@pfbreak}}
+\newcommand{\@pfbreak}[3]{\par
+  \@tempdimc\pagegoal \advance\@tempdimc-\pagetotal
+  \ifdim #1>\@tempdimc \@fbreak{#3}\else \@pbreak{#2}\fi}
+\newcommand{\@spfbreak}[3]{\par
+  \@tempdimc\pagegoal \advance\@tempdimc-\pagetotal
+  \ifdim #1>\@tempdimc \@sfbreak{#3}\else \@spbreak{#2}\fi}
+
+\newcommand*{\pen at ltyabovepfbreak}{2}
+\newcommand*{\pen at ltybelowpfbreak}{-4}
+
+\newlength{\pfbreakskip}
+  \setlength{\pfbreakskip}{2\baselineskip}
+\newcommand{\pfbreakdisplay}{*\quad*\quad*}
+
+\def\pfbre at kdispl@y{\vbox to 1\pfbreakskip{\vss
+  \hb at xt@ \columnwidth{\hss \pfbreakdisplay \hss}%
+  \vss}}
+
+\edef\nopfbreakOutput{\the\output}
+\def\pfbreakOutput{%
+  \ifnum\outputpenalty=\pen at ltyabovepfbreak
+    \nopfbreakOutput
+    \pfbre at kdispl@y
+    \nobreak
+    \vskip-\pfbreakskip
+  \else\ifnum\outputpenalty=\pen at ltybelowpfbreak
+    \unvbox 255\relax
+    \nobreak
+    \vskip-\pfbreakskip
+    \pfbre at kdispl@y
+    \break
+  \else
+    \nopfbreakOutput
+  \fi
+  \fi}
+\output={\pfbreakOutput}
+
+\newcommand{\pfbreak}{\@ifstar{\@spfbreakgap}{\@pfbreakgap}}
+\newcommand{\@pfbreakgap}{%
+  \par {%
+  \skip@\lastskip
+  \nobreak
+  \vskip -\ifdim\prevdepth>\maxdepth \maxdepth
+          \else\ifdim\prevdepth>-1000pt\prevdepth
+            \else\ifinner 0pt
+              \else \pagedepth
+          \fi \fi \fi
+  \vskip -\skip@
+  \ifdim\skip@<\pfbreakskip
+    \advance\skip@ -1\skip@ \advance\skip@ 1\pfbreakskip
+  \fi
+  \penalty\pen at ltyabovepfbreak
+  \vskip\skip@
+  \penalty\pen at ltybelowpfbreak
+  }
+  \@afterindentfalse
+  \@afterheading
+}
+\newcommand{\@spfbreakgap}{%
+  \par {%
+  \skip@\lastskip
+  \nobreak
+  \vskip -\ifdim\prevdepth>\maxdepth \maxdepth
+          \else\ifdim\prevdepth>-1000pt\prevdepth
+            \else\ifinner 0pt
+              \else \pagedepth
+          \fi \fi \fi
+  \vskip -\skip@
+  \ifdim\skip@<\pfbreakskip
+    \advance\skip@ -1\skip@ \advance\skip@ 1\pfbreakskip
+  \fi
+  \penalty\pen at ltyabovepfbreak
+  \vskip\skip@
+  \penalty\pen at ltybelowpfbreak
+  }
+  \@afterindenttrue
+  \@afterheading
+}
+
+\newcommand*{\noprelistbreak}{\@nobreaktrue\nopagebreak}
+
+\newcommand{\makeheadstyles}[2]{%
+  \@namedef{hds@#1}{\@hds at def@ult #2}}
+\newcommand*{\headstyles}[1]{\@nameuse{hds@#1}}
+\newcommand*{\@hds at def@ult}{%
+  \renewcommand*{\beforebookskip}{\null\vfil}%
+  \renewcommand*{\midbookskip}{\par\vskip 20pt}%
+  \renewcommand*{\afterbookskip}{\vfil\newpage}%
+  \renewcommand*{\booknamefont}{\normalfont\huge\bfseries}%
+  \renewcommand*{\booknumfont}{\normalfont\huge\bfseries}%
+  \renewcommand*{\booktitlefont}{\normalfont\Huge\bfseries}%
+  \renewcommand*{\printbookname}{\booknamefont \bookname}%
+  \renewcommand*{\booknamenum}{\space}%
+  \renewcommand*{\printbooknum}{\booknumfont \thebook}%
+  \renewcommand*{\printbooktitle}[1]{\booktitlefont{##1}}%
+  \renewcommand*{\beforepartskip}{\null\vfil}%
+  \renewcommand*{\midpartskip}{\par\vskip 20pt}%
+  \renewcommand*{\afterpartskip}{\vfil\newpage}%
+  \renewcommand*{\partnamefont}{\normalfont\huge\bfseries}%
+  \renewcommand*{\partnumfont}{\normalfont\huge\bfseries}%
+  \renewcommand*{\parttitlefont}{\normalfont\Huge\bfseries}%
+  \renewcommand*{\printpartname}{\partnamefont \partname}%
+  \renewcommand*{\partnamenum}{\space}%
+  \renewcommand*{\printpartnum}{\partnumfont \thepart}%
+  \renewcommand*{\printparttitle}[1]{\parttitlefont{##1}}%
+  \@chs at def@ult%               default chapterstyle
+  \setsechook{}
+  \setsecindent{\z@}%
+  \setbeforesecskip{-3.5ex \@plus -1ex \@minus -.2ex}%
+  \setaftersecskip{2.3ex \@plus .2ex}%
+  \setsecheadstyle{\Large\bfseries\if at RTL\raggedleft\else\raggedright\fi}%
+  \setsubsechook{}%
+  \setsubsecindent{\z@}%
+  \setbeforesubsecskip{-3.25ex \@plus -1ex \@minus -.2ex}%
+  \setaftersubsecskip{1.5ex \@plus .2ex}%
+  \setsubsecheadstyle{\large\bfseries\if at RTL\raggedleft\else\raggedright\fi}%
+  \setsubsubsechook{}%
+  \setsubsubsecindent{\z@}%
+  \setbeforesubsubsecskip{-3.25ex \@plus -1ex \@minus -.2ex}%
+  \setaftersubsubsecskip{1.5ex \@plus .2ex}%
+  \setsubsubsecheadstyle{\normalsize\bfseries\if at RTL\raggedleft\else\raggedright\fi}%
+  \setparahook{}%
+  \setparaindent{\z@}%
+  \setbeforeparaskip{3.25ex \@plus 1ex \@minus .2ex}%
+  \setafterparaskip{-1em}%
+  \setparaheadstyle{\normalsize\bfseries}%
+  \setsubparahook{}%
+  \setsubparaindent{\parindent}%
+  \setbeforesubparaskip{3.25ex \@plus 1ex \@minus .2ex}%
+  \setaftersubparaskip{-1em}%
+  \setsubparaheadstyle{\normalsize\bfseries}}
+
+\makeheadstyles{default}{}
+\headstyles{default}
+
+\newcommand*{\addperiod}[1]{#1.}
+
+\makeheadstyles{memman}{%
+  \renewcommand*{\booknamefont}{\normalfont\huge\sffamily}
+  \renewcommand*{\booknumfont}{\normalfont\huge\sffamily}
+  \renewcommand*{\booktitlefont}{\normalfont\Huge\sffamily}
+  \renewcommand*{\midbookskip}{\par\vskip 2\onelineskip}%
+  \renewcommand*{\partnamefont}{\normalfont\huge\sffamily}
+  \renewcommand*{\partnumfont}{\normalfont\huge\sffamily}
+  \renewcommand*{\parttitlefont}{\normalfont\Huge\sffamily}
+  \renewcommand*{\midpartskip}{\par\vskip 2\onelineskip}%
+  \chapterstyle{demo3}
+  \setbeforesecskip{-1.333\onelineskip
+                    \@plus -0.5\onelineskip \@minus -.5\onelineskip}%
+  \setaftersecskip{0.667\onelineskip \@plus 0.1\onelineskip}%
+  \setsecheadstyle{\normalfont\scshape\if at RTL\raggedleft\else\raggedright\fi}%
+  \setbeforesubsecskip{-0.667\onelineskip
+                       \@plus -0.25\onelineskip \@minus -0.25\onelineskip}%
+  \setaftersubsecskip{0.333\onelineskip \@plus 0.1\onelineskip}%
+  \setsubsecheadstyle{\normalfont\bfseries\if at RTL\raggedleft\else\raggedright\fi}%
+  \setbeforesubsubsecskip{-0.667\onelineskip
+                          \@plus -0.25\onelineskip \@minus -0.25\onelineskip}%
+  \setaftersubsubsecskip{0.333\onelineskip \@plus 0.1\onelineskip}%
+  \setsubsubsecheadstyle{\normalfont\normalsize\itshape\if at RTL\raggedleft\else\raggedright\fi}%
+  \setbeforeparaskip{1.0\onelineskip
+                     \@plus 0.5\onelineskip \@minus 0.2\onelineskip}%
+  \setafterparaskip{-1em}%
+  \setparaheadstyle{\normalfont\normalsize\itshape\addperiod}%
+  \setsubparaindent{\parindent}%
+  \setbeforesubparaskip{1.0\onelineskip
+                        \@plus 0.5\onelineskip \@minus 0.2\onelineskip}%
+  \setaftersubparaskip{-1em}%
+  \setsubparaheadstyle{\normalfont\normalsize\itshape\addperiod}}
+
+\makeheadstyles{bringhurst}{%
+\chapterstyle{bringhurst}
+  \setbeforesecskip{-1\onelineskip
+                    \@plus -0.5\onelineskip \@minus -.5\onelineskip}%
+  \setaftersecskip{1\onelineskip \@plus 0.1\onelineskip}%
+  \setsecheadstyle{\normalfont\if at RTL\raggedleft\else\raggedright\fi\scshape\MakeLowercase}%
+  \setbeforesubsecskip{-1.0\onelineskip
+                       \@plus -0.25\onelineskip \@minus -0.25\onelineskip}%
+  \setaftersubsecskip{1.0\onelineskip \@plus 0.1\onelineskip}%
+  \setsubsecheadstyle{\sethangfrom{\noindent ####1}\normalfont\itshape\if at RTL\raggedleft\else\raggedright\fi}%
+  \setbeforesubsubsecskip{1.0\onelineskip
+                          \@plus 0.5\onelineskip \@minus 0.2\onelineskip}%
+  \setaftersubsubsecskip{-1em}%
+  \setsubsubsecheadstyle{\normalfont\normalsize\scshape\MakeLowercase}%
+  \setbeforeparaskip{1.0\onelineskip
+                     \@plus 0.5\onelineskip \@minus 0.2\onelineskip}%
+  \setafterparaskip{-1em}%
+  \setparaheadstyle{\normalfont\normalsize\itshape\addperiod}%
+  \setsubparaindent{\parindent}%
+  \setbeforesubparaskip{1.0\onelineskip
+                        \@plus 0.5\onelineskip \@minus 0.2\onelineskip}%
+  \setaftersubparaskip{-1em}%
+  \setsubparaheadstyle{\normalfont\normalsize\itshape\addperiod}}
+
+\makeheadstyles{crosshead}{%
+  \chapterstyle{crosshead}
+  \setbeforesecskip{-1.25\onelineskip
+                    \@plus -0.5\onelineskip \@minus -.5\onelineskip}%
+  \setaftersecskip{0.75\onelineskip \@plus 0.1\onelineskip}%
+  \setsecheadstyle{\normalfont\centering\MakeUppercase}%
+  \setbeforesubsecskip{-1.25\onelineskip
+                       \@plus -0.25\onelineskip \@minus -0.25\onelineskip}%
+  \setaftersubsecskip{0.75\onelineskip \@plus 0.1\onelineskip}%
+  \setsubsecheadstyle{\normalfont\centering\bfseries}%
+  \setbeforesubsubsecskip{-.667\onelineskip
+                          \@plus -0.25\onelineskip \@minus -0.25\onelineskip}%
+  \setaftersubsubsecskip{.333\onelineskip \@plus 0.1\onelineskip}%
+  \setsubsubsecheadstyle{\normalfont\normalsize\centering\scshape\MakeLowercase}%
+  \setbeforeparaskip{-.667\onelineskip
+                     \@plus -02.5\onelineskip \@minus -0.25\onelineskip}%
+  \setafterparaskip{.333\onelineskip \@plus 0.1\onelineskip}%
+  \setparaheadstyle{\normalfont\normalsize\centering\itshape}%
+  \setsubparaindent{\parindent}%
+  \setbeforesubparaskip{1.0\onelineskip
+                        \@plus 0.5\onelineskip \@minus 0.2\onelineskip}%
+  \setaftersubparaskip{-1em}%
+  \setsubparaheadstyle{\normalfont\normalsize\scshape\MakeLowercase}}
+
+\makeheadstyles{dowding}{%
+  \chapterstyle{dowding}
+  \setbeforesecskip{-2\onelineskip
+                    \@plus -0.5\onelineskip \@minus -.5\onelineskip}%
+  \setaftersecskip{1\onelineskip \@plus 0.1\onelineskip}%
+  \setsecheadstyle{\normalfont\centering\MakeUppercase}%
+  \setbeforesubsecskip{-1.2\onelineskip
+                       \@plus -0.25\onelineskip \@minus -0.25\onelineskip}%
+  \setaftersubsecskip{0.8\onelineskip \@plus 0.1\onelineskip}%
+  \setsubsecheadstyle{\normalfont\scshape\centering\MakeLowercase}%
+  \setbeforesubsubsecskip{-0.667\onelineskip
+                          \@plus -0.25\onelineskip \@minus -0.25\onelineskip}%
+  \setaftersubsubsecskip{0.333\onelineskip \@plus 0.1\onelineskip}%
+  \setsubsubsecheadstyle{\normalfont\normalsize\centering\itshape}%
+  \setbeforeparaskip{1.0\onelineskip
+                     \@plus 0.5\onelineskip \@minus 0.2\onelineskip}%
+  \setafterparaskip{-1em}%
+  \setparaheadstyle{\normalfont\normalsize\itshape\addperiod}%
+  \setsubparaindent{\parindent}%
+  \setbeforesubparaskip{1.0\onelineskip
+                        \@plus 0.5\onelineskip \@minus 0.2\onelineskip}%
+  \setaftersubparaskip{-1em}%
+  \setsubparaheadstyle{\normalfont\normalsize\itshape\addperiod}}
+
+\makeheadstyles{komalike}{%
+  \renewcommand*{\partnamefont}{\huge\sffamily\bfseries}%
+  \renewcommand*{\partnumfont}{\huge\sffamily\bfseries}%
+  \renewcommand*{\parttitlefont}{\huge\sffamily\bfseries}%
+  \chapterstyle{komalike}
+  \setbeforesecskip{-3.5ex \@plus -1ex \@minus -.2ex}%
+  \setaftersecskip{2.3ex \@plus .2ex}%
+  \setsecheadstyle{\normalfont\Large\sffamily\bfseries\if at RTL\raggedleft\else\raggedright\fi}%
+  \setbeforesubsecskip{-3.25ex \@plus -1ex \@minus -.2ex}%
+  \setaftersubsecskip{1.5ex \@plus .2ex}%
+  \setsubsecheadstyle{\normalfont\large\sffamily\bfseries\if at RTL\raggedleft\else\raggedright\fi}%
+  \setbeforesubsubsecskip{-3.25ex \@plus -1ex \@minus -.2ex}%
+  \setaftersubsubsecskip{1.5ex \@plus .2ex}%
+  \setsubsubsecheadstyle{\normalfont\normalsize\sffamily\bfseries\if at RTL\raggedleft\else\raggedright\fi}%
+  \setbeforeparaskip{3.25ex \@plus 1ex \@minus .2ex}%
+  \setafterparaskip{-1em}%
+  \setparaheadstyle{\normalfont\normalsize\sffamily\bfseries}%
+  \setsubparaindent{\parindent}%
+  \setbeforesubparaskip{3.25ex \@plus 1ex \@minus .2ex}%
+  \setaftersubparaskip{-1em}%
+  \setsubparaheadstyle{\normalfont\normalsize\sffamily\bfseries}}
+
+\makeheadstyles{ntglike}{%
+  \renewcommand*{\partnamefont}{\Large\bfseries\MakeUppercase}%
+  \renewcommand*{\partnumfont}{\Large\bfseries}%
+  \renewcommand*{\parttitlefont}{\Large\MakeUppercase}%
+  \chapterstyle{ntglike}
+  \setbeforesecskip{-2\onelineskip
+                    \@plus -1\onelineskip \@minus -.5\onelineskip}%
+  \setaftersecskip{0.5\onelineskip}%
+  \setsecheadstyle{\normalfont\large\bfseries}%
+  \setbeforesubsecskip{-1\onelineskip
+                       \@plus -.5\onelineskip \@minus -.25\onelineskip}%
+  \setaftersubsecskip{0.01\onelineskip}%
+  \setsubsecheadstyle{\normalfont\normalsize\bfseries}%
+  \setbeforesubsubsecskip{-1\onelineskip
+                          \@plus -.5\onelineskip \@minus -.25\onelineskip}%
+  \setaftersubsubsecskip{0.01\onelineskip}%
+  \setsubsubsecheadstyle{\normalfont\normalsize\slshape}%
+  \setbeforeparaskip{3.25ex \@plus 1ex \@minus .2ex}%
+  \setafterparaskip{-1em}%
+  \setparaheadstyle{\normalfont\normalsize\slshape}%
+  \setsubparaindent{\parindent}%
+  \setbeforesubparaskip{3.25ex \@plus 1ex \@minus .2ex}%
+  \setaftersubparaskip{-1em}%
+  \setsubparaheadstyle{\normalfont\normalsize\slshape}}
+
+\makeheadstyles{tandh}{%
+  \chapterstyle{tandh}
+  \setbeforesecskip{-2\onelineskip
+                    \@plus -0.5\onelineskip \@minus -.5\onelineskip}%
+  \setaftersecskip{1\onelineskip \@plus 0.1\onelineskip}%
+  \setsecheadstyle{\normalfont\if at RTL\raggedleft\else\raggedright\fi\MakeUppercase}%
+  \setbeforesubsecskip{-1.2\onelineskip
+                       \@plus -0.25\onelineskip \@minus -0.25\onelineskip}%
+  \setaftersubsecskip{0.8\onelineskip \@plus 0.1\onelineskip}%
+  \setsubsecheadstyle{\normalfont\Large\itshape\if at RTL\raggedleft\else\raggedright\fi}%
+  \setbeforesubsubsecskip{-0.667\onelineskip
+                          \@plus -0.25\onelineskip \@minus -0.25\onelineskip}%
+  \setaftersubsubsecskip{0.333\onelineskip \@plus 0.1\onelineskip}%
+  \setsubsubsecheadstyle{\normalfont\normalsize\bfseries\if at RTL\raggedleft\else\raggedright\fi}%
+  \setbeforeparaskip{1.0\onelineskip
+                     \@plus 0.5\onelineskip \@minus 0.2\onelineskip}%
+  \setafterparaskip{-1em}%
+  \setparaheadstyle{\normalfont\normalsize\itshape\addperiod}%
+  \setsubparaindent{\parindent}%
+  \setbeforesubparaskip{1.0\onelineskip
+                        \@plus 0.5\onelineskip \@minus 0.2\onelineskip}%
+  \setaftersubparaskip{-1em}%
+  \setsubparaheadstyle{\normalfont\normalsize\itshape\addperiod}}
+
+\makeheadstyles{wilsondob}{%
+  \chapterstyle{wilsondob}
+  \setbeforesecskip{-1.333\onelineskip
+                    \@plus -0.5\onelineskip \@minus -.5\onelineskip}%
+  \setaftersecskip{0.667\onelineskip \@plus 0.1\onelineskip}%
+  \setsecheadstyle{\normalfont\if at RTL\raggedleft\else\raggedright\fi\MakeUppercase}%
+  \setbeforesubsecskip{-0.667\onelineskip
+                       \@plus -0.25\onelineskip \@minus -0.25\onelineskip}%
+  \setaftersubsecskip{0.333\onelineskip \@plus 0.1\onelineskip}%
+  \setsubsecheadstyle{\normalfont\Large\itshape\if at RTL\raggedleft\else\raggedright\fi}%
+  \setbeforesubsubsecskip{-0.667\onelineskip
+                          \@plus -0.25\onelineskip \@minus -0.25\onelineskip}%
+  \setaftersubsubsecskip{0.333\onelineskip \@plus 0.1\onelineskip}%
+  \setsubsubsecheadstyle{\normalfont\normalsize\if at RTL\raggedleft\else\raggedright\fi\scshape\MakeLowercase}%
+  \setbeforeparaskip{1.0\onelineskip
+                     \@plus 0.5\onelineskip \@minus 0.2\onelineskip}%
+  \setafterparaskip{-1em}%
+  \setparaheadstyle{\normalfont\normalsize\itshape\addperiod}%
+  \setsubparaindent{\parindent}%
+  \setbeforesubparaskip{1.0\onelineskip
+                        \@plus 0.5\onelineskip \@minus 0.2\onelineskip}%
+  \setaftersubparaskip{-1em}%
+  \setsubparaheadstyle{\normalfont\normalsize\itshape\addperiod}}
+
+\newif\ifanappendix
+  \anappendixfalse
+\newcommand{\appendix}{\par
+  \setcounter{chapter}{0}%
+  \setcounter{section}{0}%
+  \gdef\@chapapp{\appendixname}%
+  \gdef\thechapter{\@Alph\c at chapter}%
+  \anappendixtrue}
+
+\newcommand{\appendixpage}{%
+  \@ifstar{\@sapppage}{\@apppage}}
+\newcommand{\memapppageinfo}[1]{}
+\newcommand{\memapppagestarinfo}[1]{}
+
+\def\@apppage{%
+  \@setuppart
+  \addappheadtotoc
+  \partmark{\appendixpagename}%
+  \memapppageinfo{\appendixpagename}%
+  {\centering
+   \interlinepenalty \@M
+   \normalfont
+   \printparttitle{\appendixpagename}\par}%
+  \@endpart}
+\def\@sapppage{%
+  \@setuppart
+  \partmark{\appendixpagename}%
+  \memapppagestarinfo{\appendixpagename}%
+  {\centering
+   \interlinepenalty \@M
+   \normalfont
+   \printparttitle{\appendixpagename}\par}%
+  \@endpart}
+
+\def\addappheadtotoc{%
+  \phantomsection\addcontentsline{toc}{chapter}{\appendixtocname}}
+\newcounter{@ppsavesec}
+\newcounter{@ppsaveapp}
+\setcounter{@ppsaveapp}{0}
+\newcommand{\@ppsavesec}{%
+  \setcounter{@ppsavesec}{\value{chapter}}}
+\newcommand{\@pprestoresec}{%
+  \setcounter{chapter}{\value{@ppsavesec}}}
+\newcommand{\@ppsaveapp}{%
+  \setcounter{@ppsaveapp}{\value{chapter}}}
+\newcommand{\restoreapp}{%
+  \setcounter{chapter}{\value{@ppsaveapp}}}
+
+\newcommand{\@resets at pp}{%
+  \par
+  \@ppsavesec
+  \setcounter{section}{0}%
+  \setcounter{chapter}{0}%
+  \renewcommand\@chapapp{\appendixname}%
+  \renewcommand\thechapter{\@Alph\c at chapter}%
+  \restoreapp
+}
+
+\newenvironment{appendices}%
+  {\@resets at pp\anappendixtrue}%
+  {\@ppsaveapp\@pprestoresec\anappendixfalse}
+
+\newcommand{\setthesection}{\thechapter\@SepMark\Alph{section}}
+
+\newcommand{\@resets at ppsub}{
+  \par
+  \setcounter{section}{0}
+  \renewcommand{\thesection}{\setthesection}
+}
+
+\newif\ifnamesubappendix
+  \namesubappendixfalse
+\newcommand*{\namedsubappendices}{\namesubappendixtrue}
+\newcommand*{\unnamedsubappendices}{\namesubappendixfalse}
+
+\newenvironment{subappendices}{%
+  \@resets at ppsub
+  \def\addappheadtotoc{\phantomsection
+    \addcontentsline{toc}{section}{\appendixtocname}}
+  \ifnamesubappendix
+    \def\sectionname{\appendixname}
+    \def\@seccntformat##1{\@ifundefined{##1name}%
+                         {}{\csname ##1name\endcsname\ }%
+        \csname the##1\endcsname\quad}
+  \fi
+  }{}
+
+\newcommand{\@formatsecmark at pp}[1]{%
+  \MakeUppercase{\appendixname\space
+    \ifnum \c at secnumdepth >\z@
+      \thesection\quad
+    \fi
+    #1}}
+\newcommand*{\leadpagetoclevel}{chapter}
+\newcommand*{\newleadpage}[3][empty]{%
+  \@namedef{#2}{\@ifstar{\dlfm at msapppage{#1}{#2}{#3}}%
+                        {\dlfm at mapppage{#1}{#2}{#3}}}}
+\newcommand*{\renewleadpage}[3][empty]{%
+  \@namedef{#2}{\@ifstar{\dlfm at msapppage{#1}{#2}{#3}}%
+                        {\dlfm at mapppage{#1}{#2}{#3}}}}
+
+\newcommand{\memleadpageinfo}[3]{}
+\newcommand{\memleadpagestarinfo}[3]{}
+
+\newcommand*{\dlfm at msapppage}[3]{%
+  \@setuppart
+  \partmark{#3}%
+  \memleadpagestarinfo{#1}{#2}{#3}%
+  {\centering
+  \interlinepenalty \@M
+  \normalfont
+  \printparttitle{#3}\par
+  \thispagestyle{#1}}%
+  \dlfm at m@endpart{#1}}
+\newcommand*{\dlfm at mapppage}[3]{%
+  \@setuppart
+  \phantomsection
+  \addcontentsline{toc}{\leadpagetoclevel}{#3}%
+  \partmark{#3}%
+  \memleadpageinfo{#1}{#2}{#3}%
+  {\centering
+  \interlinepenalty \@M
+  \normalfont
+  \printparttitle{#3}\par
+  \thispagestyle{#1}}%
+  \dlfm at m@endpart{#1}}
+
+\newcommand*{\dlfm at m@endpart}[1]{%
+  \if at twoside
+    \if at openright
+      \null
+      \thispagestyle{#1}%
+      \newpage
+    \fi
+  \fi
+  \if at tempswa
+    \twocolumn
+  \fi}
+
+\let\memorigdbs\\
+\let\memorigpar\par
+\let\atcentercr\@centercr
+
+\newcommand*{\flushleftright}{%
+  \let\\\memorigdbs
+  \if at RTL\rightskip\else\leftskip\fi\z at skip
+  \if at RTL\leftskip\else\rightskip\fi\if at RTL\rightskip\else\leftskip\fi
+  \parfillskip\@flushglue
+  \everypar{}}
+
+\newcommand*{\linenottooshort}[1][4em]{%
+  \@tempdima=\hsize
+  \advance\@tempdima -#1
+  \if at RTL\rightskip\else\leftskip\fi\z at skip
+  \if at RTL\leftskip\else\rightskip\fi\if at RTL\rightskip\else\leftskip\fi
+  \parfillskip=\@tempdima \@minus \@tempdima}
+
+\newcommand*{\russianpar}{\ifhmode\unskip
+  \strut\vadjust{}\nobreak
+  \discretionary{}%
+  {\hbox{\hskip2\parindent
+         \vrule depth 273sp width 0sp height \ht\strutbox}}%
+  {\hbox{\hskip\parindent}}%
+  \hskip-2\parindent \@minus 2\parindent
+  \hskip\hsize \@minus \hsize
+  \kern\z@ \parfillskip\z@
+  \memorigpar
+  \ifdim\prevdepth=273sp
+    \nobreak
+    \vskip-2\baselineskip
+    \hbox{\strut}%
+  \fi\fi}
+
+\newcommand*{\lastlineparrule}{%
+  \hrule height 0.5ex depth \@tempdimb\relax}
+\newcommand*{\lastlinerulefill}{%
+  \let\\\@centercr
+  \@tempdimb=-0.5ex \advance\@tempdimb 0.4pt
+  \unskip\nobreak\space
+  \leaders\lastlineparrule\hskip\@flushglue
+  \vadjust{}{\parfillskip\z@\memorigpar}}
+
+\newcommand*{\centerlastline}{%
+  \if at RTL\rightskip\else\leftskip\fi\@flushglue
+  \if at RTL\leftskip\else\rightskip\fi=\z@ plus -1fil
+  \parfillskip=\z@ plus 2fil}
+
+\newcommand*{\leftcenterright}{%;
+  \let\\\break
+  \parindent\z@
+  \if at RTL\rightskip\else\leftskip\fi\@flushglue
+  \if at RTL\leftskip\else\rightskip\fi\if at RTL\rightskip\else\leftskip\fi
+  \parfillskip \z@ \@plus -1fil
+  \everypar={\hskip \z@ \@plus -1fil}}
+
+\newcommand*{\centerfloat}{%
+  \parindent \z@
+  \if at RTL\rightskip\else\leftskip\fi \z@ \@plus 1fil \@minus \textwidth
+  \if at RTL\leftskip\else\rightskip\fi\if at RTL\rightskip\else\leftskip\fi
+  \parfillskip \z at skip}
+
+\newdimen\ragrparindent
+  \setlength{\ragrparindent}{\parindent}
+\newcommand{\raggedyright}[1][2em]{%
+  \let\\\@centercr\@rightskip \z@ \@plus #1\relax \if at RTL\leftskip\else\rightskip\fi\@rightskip
+  \if at RTL\rightskip\else\leftskip\fi\z at skip
+  \parindent\ragrparindent}
+
+\newcommand*{\justlastraggedleft}{%
+  \if at RTL\rightskip\else\leftskip\fi\@flushglue
+  \if at RTL\leftskip\else\rightskip\fi-\if at RTL\rightskip\else\leftskip\fi
+  \parfillskip\if at RTL\rightskip\else\leftskip\fi
+  \parindent \z@}
+
+\newcommand*{\raggedrightthenleft}{%
+  \parindent \z@
+  \if at RTL\rightskip\else\leftskip\fi \z@ \@plus 1fill
+  \if at RTL\leftskip\else\rightskip\fi\@flushglue
+  \parfillskip \z@
+  \everypar{\hskip \z@ \@plus -1fill}}
+
+\newcommand{\hangfrom}[1]{%
+  \setbox\@tempboxa\hbox{{#1}}%
+  \hangindent \wd\@tempboxa\noindent\box\@tempboxa}
+
+\newcommand{\hangpara}[2]{\hangindent#1\hangafter#2\noindent}
+\newenvironment{hangparas}[2]{\setlength{\parindent}{\z@}
+  \everypar={\hangpara{#1}{#2}}}{\par}
+
+\newcommand{\leftspringright}[4]{%
+  \@tempdimb=\hsize
+  \par\noindent\hbox to\@tempdimb{%
+    \vtop{\hsize=#1\@tempdimb \flushleft#3\par}\hss
+    \vtop{\hsize=#2\@tempdimb \flushright#4\par}}}
+
+\newcommand*{\sourceatright}[2][2em]{{%
+  \unskip\nobreak\hfil\penalty50
+  \hskip#1\hbox{}\nobreak\hfil{#2}
+  \parfillskip\z@\finalhyphendemerits=0\par}}
+
+\if at twocolumn
+  \setlength{\leftmargini}{2em}
+\else
+  \setlength{\leftmargini}{2.5em}
+\fi
+\leftmargin \leftmargini
+\setlength{\leftmarginii}{2.2em}
+\setlength{\leftmarginiii}{1.87em}
+\setlength{\leftmarginiv}{1.7em}
+\if at twocolumn
+  \setlength{\leftmarginv}{.5em}
+  \setlength{\leftmarginvi}{.5em}
+\else
+  \setlength{\leftmarginv}{1em}
+  \setlength{\leftmarginvi}{1em}
+\fi
+\setlength{\itemindent}{\z@}
+\setlength{\labelsep}{0.5em}
+\setlength{\labelwidth}{\leftmargini}
+  \addtolength{\labelwidth}{-\labelsep}
+\@beginparpenalty -\@lowpenalty
+\@endparpenalty   -\@lowpenalty
+\@itempenalty     -\@lowpenalty
+
+%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
+\newdimen\everylistparindent
+  \everylistparindent \z@
+\renewcommand*{\list}[2]{%
+  \ifnum \@listdepth >5\relax
+    \@toodeep
+  \else
+    \global\advance\@listdepth\@ne
+  \fi
+  \rightmargin\z@
+  \listparindent\everylistparindent
+  \itemindent\z@
+  \csname @list\romannumeral\the\@listdepth\endcsname
+  \def\@itemlabel{#1}%
+  \let\makelabel\@mklab
+  \@nmbrlistfalse
+  #2\relax
+  \@trivlist
+  \parskip\parsep
+  \parindent\listparindent
+  \advance\linewidth -\rightmargin
+  \advance\linewidth -\leftmargin
+  \advance\@totalleftmargin \leftmargin
+  \parshape \@ne \@totalleftmargin \linewidth
+  \ignorespaces}
+
+\newlength{\parsepi}
+\newlength{\topsepi}
+\newlength{\itemsepi}
+\newlength{\parsepii}
+\newlength{\topsepii}
+\newlength{\topsepiii}
+
+\newlength{\itemsepii}
+\newlength{\itemsepiii}
+\newlength{\partopsepii}
+\newlength{\partopsepiii}
+\newcommand*{\setnzplist}{%
+  \partopsep \p@ \@plus\z@ \@minus\p@
+  \topsepi\z@
+  \parsepi\parskip
+  \itemsepi\z@
+  \topsepii\z@
+  \parsepii\parskip
+  \itemsepii\z@
+  \topsepiii\z@
+%%    \parsepiii\parskip
+  \itemsepiii\z@}
+
+\newcommand*{\defaultlists}{%
+  \setlength{\partopsep}{0.2\onelineskip \@plus 0.1\onelineskip
+                                         \@minus 0.1\onelineskip}%
+  \parsepi = 0.3333\onelineskip \@plus 0.1667\onelineskip \@minus \p@
+  \itemsepi = \parsepi
+  \topsepi = 0.6667\onelineskip \@plus 0.3333\onelineskip
+                                \@minus 0.2\onelineskip
+  \parsepii = 0.1667\onelineskip \@plus \p@ \@minus \p@
+  \topsepii = \parsepi
+  \topsepiii = \parsepii
+  \everylistparindent \listparindent
+  \itemsepii\parsepii
+  \itemsepiii\topsepiii
+  \partopsepiii \p@ \@plus\z@ \@minus\p@
+  \ifm at mnzpskip
+    \setnzplist
+  \fi}
+\defaultlists
+
+\newcommand*{\firmlists}{%
+  \@ifstar{\m at msfirmlists}{\m at mfirmlists}}
+
+\newcommand*{\m at msfirmlists}{
+  \setlength{\partopsep}{\z@ \@plus \p@ \@minus \p@}%
+  \parsepi = 0.1667\onelineskip \@plus 0.0833\onelineskip \@minus \p@
+  \itemsepi = \parsepi
+  \topsepi = \parsepi
+  \parsepii = 0.0833\onelineskip \@plus \p@ \@minus \p@
+  \topsepii = \parsepi
+  \topsepiii = \parsepii
+  \everylistparindent\listparindent}
+
+\newcommand*{\m at mfirmlists}{
+  \setlength{\partopsep}{0.1\onelineskip \@plus 0.05\onelineskip
+                                         \@minus 0.05\onelineskip}%
+  \parsepi = 0.1667\onelineskip \@plus 0.0833\onelineskip \@minus \p@
+  \itemsepi = \parsepi
+  \topsepi = \parsepi
+  \parsepii = 0.0833\onelineskip \@plus \p@ \@minus \p@
+  \topsepii = \parsepi
+  \topsepiii = \parsepii
+  \everylistparindent\listparindent}
+
+\newcommand*{\tightlists}{%
+  \@ifstar{\m at mstightlists}{\m at mtightlists}}
+
+\newcommand*{\m at mstightlists}{%
+  \setlength{\partopsep}{\z@ \@plus \p@ \@minus \p@}%
+  \parsepi = \z@ \@plus \p@ \@minus \p@
+  \itemsepi = \parsepi
+  \topsepi = \z@ \@plus \p@ \@minus \p@
+  \parsepii = \z@ \@plus \p@ \@minus \p@
+  \topsepii = \parsepi
+  \topsepiii = \parsepii
+  \everylistparindent\parindent
+  \ifm at mnzpskip
+    \setnzplist
+    \partopsepiii\partopsep
+  \fi}
+
+\newcommand*{\m at mtightlists}{%
+  \setlength{\partopsep}{0.5\onelineskip \@plus \p@ \@minus \p@}%
+  \parsepi = \z@ \@plus \p@ \@minus \p@
+  \itemsepi = \parsepi
+  \topsepi = \z@ \@plus \p@ \@minus \p@
+  \parsepii = \z@ \@plus \p@ \@minus \p@
+  \topsepii = \parsepi
+  \topsepiii = \parsepii
+  \everylistparindent\parindent
+  \ifm at mnzpskip
+    \setnzplist
+    \partopsepiii\partopsep
+  \fi}
+
+\newcommand{\firmlist}{%
+  \setlength{\itemsep}{0.5\itemsep}\setlength{\parskip}{0.5\parskip}}
+\newcommand{\tightlist}{%
+  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
+
+\newskip\m at msavetopsep
+\newskip\m at msavepartopsep
+\newcommand*{\savetrivseps}{%
+  \m at msavetopsep\topsep
+  \m at msavepartopsep\partopsep}
+\newcommand*{\restoretrivseps}{%
+  \topsep\m at msavetopsep
+  \partopsep\m at msavepartopsep}
+\savetrivseps
+
+\newcommand*{\zerotrivseps}{%
+  \topsep\z@
+  \partopsep\z@}
+
+\def\@listi{\leftmargin\leftmargini
+  \parsep\parsepi
+  \topsep\topsepi
+  \itemsep\itemsepi}
+\let\@listI\@listi
+\defaultlists
+\@listi
+
+\def\@listii{\leftmargin\leftmarginii
+             \labelwidth\leftmarginii
+             \advance\labelwidth-\labelsep
+             \topsep\topsepii
+             \parsep\parsepii
+             \itemsep\parsepii}
+
+\def\@listiii{\leftmargin\leftmarginiii
+              \labelwidth\leftmarginiii
+              \advance\labelwidth-\labelsep
+              \topsep\topsepiii
+              \parsep\z@
+%%%              \itemsep\topsep
+%%%              \partopsep \p@ \@plus\z@ \@minus\p@
+              \itemsep\itemsepiii
+              \partopsep\partopsepiii}
+
+\def\@listiv{\leftmargin\leftmarginiv
+             \labelwidth\leftmarginiv
+             \advance\labelwidth-\labelsep}
+
+\def\@listv{\leftmargin\leftmarginv
+            \labelwidth\leftmarginv
+            \advance\labelwidth-\labelsep}
+
+\def\@listvi{\leftmargin\leftmarginvi
+             \labelwidth\leftmarginvi
+             \advance\labelwidth-\labelsep}
+
+\renewcommand{\theenumi}{\@arabic\c at enumi}
+\renewcommand{\theenumii}{\@alph\c at enumii}
+\renewcommand{\theenumiii}{\@roman\c at enumiii}
+\renewcommand{\theenumiv}{\@Alph\c at enumiv}
+\newcommand{\labelenumi}{\theenumi.}
+\newcommand{\labelenumii}{\theenumii)}
+\newcommand{\labelenumiii}{\theenumiii.}
+\newcommand{\labelenumiv}{\theenumiv.}
+\renewcommand{\p at enumii}{\theenumi}
+\renewcommand{\p at enumiii}{\theenumi(\theenumii)}
+\renewcommand{\p at enumiv}{\p at enumiii\theenumiii}
+\newtoks\@enLab
+\def\@enQmark{?}
+\def\@enLabel#1#2{%
+  \edef\@enThe{\noexpand#1{\@enumctr}}%
+  \@enLab\expandafter{\the\@enLab\csname the\@enumctr\endcsname}%
+  \@enloop}
+\def\@enSpace{\afterassignment\@enSp at ce\let\@memtempa= }
+\def\@enSp at ce{\@enLab\expandafter{\the\@enLab\space}\@enloop}
+\def\@enGroup#1{\@enLab\expandafter{\the\@enLab{#1}}\@enloop}
+\def\@enOther#1{\@enLab\expandafter{\the\@enLab#1}\@enloop}
+\def\@enloop{\futurelet\@entemp\@enloop@}
+\def\@enloop@{%
+  \ifx A\@entemp         \def\@memtempa{\@enLabel\Alph  }\else
+  \ifx a\@entemp         \def\@memtempa{\@enLabel\alph  }\else
+  \ifx i\@entemp         \def\@memtempa{\@enLabel\roman }\else
+  \ifx I\@entemp         \def\@memtempa{\@enLabel\Roman }\else
+  \ifx 1\@entemp         \def\@memtempa{\@enLabel\arabic}\else
+  \ifx \@sptoken\@entemp \let\@memtempa\@enSpace         \else
+  \ifx \bgroup\@entemp   \let\@memtempa\@enGroup         \else
+  \ifx \@enum@\@entemp   \let\@memtempa\@gobble          \else
+                         \let\@memtempa\@enOther
+                         \@enhook
+             \fi\fi\fi\fi\fi\fi\fi\fi
+  \@memtempa}
+%% \providecommand\@enhook{}
+  \newcommand\@enhook{}
+\def\enumerate{%
+  \ifnum \@enumdepth >3 \@toodeep\else
+      \advance\@enumdepth \@ne
+      \edef\@enumctr{enum\romannumeral\the\@enumdepth}\fi
+  \@ifnextchar[{\@@enum@}{\@enum@}}
+\def\@@enum@[#1]{%
+  \@enLab{}\let\@enThe\@enQmark
+  \@enloop#1\@enum@
+  \ifx\@enThe\@enQmark\@warning{The counter will not be printed.%
+   ^^J\space\@spaces\@spaces\@spaces The label is: \the\@enLab}\fi
+  \expandafter\edef\csname label\@enumctr\endcsname{\the\@enLab}%
+  \expandafter\let\csname the\@enumctr\endcsname\@enThe
+  \csname c@\@enumctr\endcsname7
+  \expandafter\settowidth
+            \csname leftmargin\romannumeral\@enumdepth\endcsname
+            {\the\@enLab\hspace{\labelsep}}%
+  \@enum@}
+\def\@enum@{\list{\csname label\@enumctr\endcsname}%
+           {\usecounter{\@enumctr}\def\makelabel##1{\hss\llap{##1}}}}
+
+\newcommand{\labelitemi}{\textbullet}
+\newcommand{\labelitemii}{\normalfont\bfseries \textendash}
+\newcommand{\labelitemiii}{\textasteriskcentered}
+\newcommand{\labelitemiv}{\textperiodcentered}
+\renewcommand{\itemize}[1][\@empty]{%
+  \ifnum \@itemdepth >\thr@@\@toodeep\else
+    \advance\@itemdepth\@ne
+    \ifx \@empty #1\else % optional argument
+      \@namedef{labelitem\romannumeral\the\@itemdepth}{#1}%
+    \fi
+    \edef\@itemitem{labelitem\romannumeral\the\@itemdepth}%
+    \expandafter
+    \list
+      \csname\@itemitem\endcsname
+       {\def\makelabel##1{\hss\llap{##1}}}%
+  \fi}
+\let\enditemize =\endlist
+
+\newenvironment{description}%
+               {\list{}{\labelwidth\z@ \itemindent-\leftmargin
+                        \let\makelabel\descriptionlabel}}%
+               {\endlist}
+\newcommand*{\descriptionlabel}[1]{\hspace\labelsep
+                                   \normalfont\bfseries #1}
+\newenvironment{blockdescription}%
+               {\list{}{\labelwidth\z@ \itemindent 0.5em \labelsep 0.5em
+                        \let\makelabel\blockdescriptionlabel}}%
+               {\endlist}
+\newcommand*{\blockdescriptionlabel}[1]{%%% \hspace\labelsep
+                                   \normalfont\bfseries #1}
+\newenvironment{quotation}%
+               {\list{}{\listparindent 1.5em%
+                        \itemindent    \listparindent
+                        \rightmargin   \leftmargin
+                        \parsep        \z@ \@plus\p@}%
+                \item[]}%
+               {\endlist}
+\newenvironment{quote}%
+               {\list{}{\rightmargin\leftmargin}%
+                \item[]}%
+               {\endlist}
+\newcommand{\symbollabel}[1]{{#1 \hfill}}
+\newenvironment{symbols}{\list{}%
+    {\itemindent 0em \leftmargin 8em
+     \labelsep 1em \labelwidth 5em
+     \let\makelabel\symbollabel}}%
+    {\endlist}
+\newcommand{\symboldef}[2]{\item[#1] #2}
+\newif\if at bsonecol
+  \@bsonecoltrue
+\newif\ifadd at bstotoc
+  \add at bstotocfalse
+\newif\ifnumber at bs
+  \number at bsfalse
+\newif\if at bsrunin
+  \@bsruninfalse
+
+\newcommand{\abstractcol}{\@bsonecolfalse}
+\newcommand{\abstractintoc}{\add at bstotoctrue}
+\newcommand{\abstractnum}{\number at bstrue\@bsruninfalse}
+\newcommand{\abstractrunin}{\@bsrunintrue\number at bsfalse}
+
+\newcommand{\abstractnamefont}{\normalfont\small\bfseries}
+\newcommand{\abstracttextfont}{\normalfont\small}
+\newcommand{\abscolnamefont}{\normalfont\Large\bfseries}
+\newcommand{\abscoltextfont}{\normalfont}
+
+\newcommand{\absnamepos}{center}
+\newlength{\abstitleskip} \setlength{\abstitleskip}{-0.5em}
+\newlength{\absleftindent}
+  \absleftindent=\leftmargin
+\newdimen\abs at leftindent
+  \abs at leftindent=\leftmargin
+\newlength{\absrightindent}
+  \absrightindent=\leftmargin
+\newlength{\absparindent}
+\newlength{\absparsep}
+
+\newcommand{\abslabeldelim}[1]{\def\@bslabeldelim{#1}}
+\abslabeldelim{}
+\newcommand{\@bsrunintitle}{%
+  \hspace*{\abstitleskip}{\abstractnamefont\abstractname\@bslabeldelim}}
+
+\newcommand{\setup at bstract}{%
+  \abs at leftindent=\absleftindent
+  \if at twocolumn
+    \if at bsonecol
+    \else
+      \abs at leftindent=\z@
+      \absrightindent=\z@
+      \renewcommand*{\abstractnamefont}{\abscolnamefont}
+      \renewcommand*{\abstracttextfont}{\abscoltextfont}
+      \renewcommand*{\absnamepos}{flushleft}
+      \setlength{\abstitleskip}{-2ex}
+    \fi
+  \fi}
+
+\AtBeginDocument{\setlength{\absparindent}{\parindent}
+                 \setlength{\absparsep}{\parskip}}
+
+\newenvironment{@bstr at ctlist}{%
+  \list{}{%
+          %%\topsep        \z@
+          \partopsep     \z@
+          \listparindent \absparindent
+          \itemindent    \listparindent
+          \leftmargin    \abs at leftindent
+          \rightmargin   \absrightindent
+          \parsep        \absparsep}%
+  \item\relax}
+  {\endlist}
+
+\newcommand{\put at bsintoc}{%
+  \ifadd at bstotoc
+    \ifnumber at bs\else
+      \phantomsection
+      \addcontentsline{toc}{chapter}{\abstractname}
+    \fi
+  \fi}
+
+\newcommand{\num at bs}{\chapter{\abstractname}}
+
+\newenvironment{abstract}{%
+  \setup at bstract
+  \if at bsrunin\else
+    \ifnumber at bs \num at bs \else
+      \begin{\absnamepos}\abstractnamefont\abstractname\end\absnamepos%
+      \vspace{\abstitleskip}%
+    \fi
+  \fi
+  \put at bsintoc%
+  \begin{@bstr at ctlist}\if at bsrunin\@bsrunintitle\fi\abstracttextfont}%
+  {\par\end{@bstr at ctlist}}
+
+\newenvironment{onecolabstract}{%
+  \begin{@twocolumnfalse}\begin{abstract}}{%
+  \end{abstract}\end{@twocolumnfalse}}
+
+\addtoiargdef{\thanks}{}{%
+  \protected at xdef\@bs at thanks{\@bs at thanks
+    \protect\footnotetext[\the\c at footnote]{#1}}%
+}
+\let\@bs at thanks\@empty
+
+\newcommand{\saythanks}{\begingroup
+  \renewcommand{\thefootnote}{\fnsymbol{footnote}}\@bs at thanks
+  \endgroup\global\let\@bs at thanks\@empty}
+
+\newcounter{vslineno}
+\newcounter{poemline}
+\newcounter{modulo at vs}
+\newcounter{memfvsline}
+
+%%%\newcommand{\poemlines}[1]{\linenumberfrequency{#1}%
+%%%  \@memwarn{Use \string\linenumberfrequency\space
+%%%                        instead of \string\poemlines}}
+
+\newcommand{\linenumberfont}[1]{\def\vlvnumfont{#1}}
+%%% \linenumberfont{\small\rmfamily}
+
+\newif\ifbvcountlines%  TRUE to print line numbers of (boxed) verbatim lines
+  \bvcountlinesfalse
+
+\newcommand{\linenumberfrequency}[1]{%
+  \ifnum #1< \@ne
+    \def\linemodnum{0\relax}
+    \bvcountlinesfalse
+  \else
+    \def\linemodnum{#1\relax}
+    \bvcountlinestrue
+  \fi}
+
+%%%%\linenumberfrequency{0}
+
+\newcommand*{\setverselinenums}[2]{%
+  \c at poemline #1\relax \advance\c at poemline \m at ne
+  \refstepcounter{poemline}%
+  \ifnum\z@<\linemodnum%   we are printing line numbers
+    \@tempcnta #2\relax
+    \divide\@tempcnta\linemodnum
+    \multiply\@tempcnta\linemodnum
+    \c at memfvsline #2\relax
+    \advance\c at memfvsline-\@tempcnta
+  \fi}
+
+\newcommand{\getthelinenumber}[2]{%
+  \ifnum\@ne>\linemodnum%  no line numbers
+  \else
+    \ifnum\@ne=\linemodnum% every line numbered
+      \@nameuse{the#1}%
+    \else
+      \@tempcnta=\@nameuse{c@#1}%
+      \advance\@tempcnta -\@nameuse{c@#2}%
+      \divide\@tempcnta \linemodnum
+      \multiply\@tempcnta \linemodnum
+      \advance\@tempcnta \@nameuse{c@#2}%
+      \ifnum\@tempcnta=\@nameuse{c@#1}\@nameuse{the#1}\fi
+    \fi
+  \fi}
+
+\newif\ifaltindent
+  \altindentfalse
+\newif\ifpattern
+  \patternfalse
+\newif\ifstarpattern
+  \starpatternfalse
+
+\newlength{\vleftskip}
+  \setlength{\vleftskip}{3em}
+\newlength{\vrightskip}
+  \setlength{\vrightskip}{1em}
+
+\newlength{\stanzaskip}
+  \setlength{\stanzaskip}{\onelineskip}
+
+\newcommand{\flagverse}[1]{%
+  \hskip-\if at RTL\vrightskip\else\vleftskip\fi\llap{#1}\hskip\if at RTL\vrightskip\else\vleftskip\fi\ignorespaces}
+
+\newlength{\versewidth}
+\newlength{\vgap} \setlength{\vgap}{1.5em}
+\newcommand{\vin}{\hspace*{\vgap}}
+\newlength{\vindent} \setlength{\vindent}{2\vgap}
+\newcommand{\vinphantom}[1]{\leavevmode\phantom{#1}}
+\newcommand*{\vleftofline}[1]{\leavevmode\llap{#1}}
+\newdimen\vleftmargin
+  \vleftmargin=\leftmargini
+
+\newcommand{\verselinebreak}[1][\z@]{\newline\hspace*{#1}\ignorespaces}
+
+\newcommand{\incr at vsline}{%
+  \refstepcounter{poemline}%
+  \stepcounter{vslineno}}
+
+\newcommand{\@vsifbang}[1]{\@ifnextchar !{\@firstoftwo{#1}}}
+\newcommand{\@vsifgt}[1]{\@ifnextchar >{\@firstoftwo{#1}}}
+
+\newcommand*{\verselinenumbersright}{\def\@vstypelinenum{\@vslnumright}}
+\newcommand*{\verselinenumbersleft}{\def\@vstypelinenum{\@vslnumleft}}
+\verselinenumbersright
+
+\newcommand*{\@vslnumright}{%
+  \hfill\rlap{\kern\if at RTL\vleftskip\else\vrightskip\fi\kern\rightmargin%
+              \vlvnumfont\getthelinenumber{poemline}{memfvsline}}}
+\newcommand*{\@vslnumleft}{%
+  \hfill\rlap{\kern-\textwidth\kern-\if at RTL\vleftskip\else\vrightskip\fi%
+              \vlvnumfont\getthelinenumber{poemline}{memfvsline}}}
+\newcommand{\@vscentercr}{%
+  \ifhmode \unskip\else \@nolnerr\fi
+  \@vstypelinenum%
+  \@vsifgt{\verselinebreak}{%
+    \incr at vsline
+    \par\@ifstar{\nobreak\@vsxcentercr}{%
+      \@vsifbang{\@ifnextchar[ {\@vsicentercr}{}}{\@vsxcentercr}}}}
+\newcommand{\@vsxcentercr}{\addvspace{-\parskip}%
+  \@ifnextchar[ {\@vsicentercr}{\start at vsline}}
+\def\@vsicentercr[#1]{\vskip #1\ignorespaces \start at vsline}
+\newcommand{\start at vsline}{%
+  \ifaltindent\ifodd\c at vslineno\else\vin\fi\fi%
+  \ifpattern\get at vsindent\fi%
+  \ifstarpattern\getstar at vsindent\fi}
+
+\newcounter{verse}
+\setcounter{verse}{0}
+\newcommand{\theHpoemline}{\theverse.\thepoemline}
+
+\newenvironment{verse}[1][\linewidth]{%
+  \refstepcounter{verse}%
+  \setcounter{poemline}{0}\refstepcounter{poemline}%
+  \setcounter{vslineno}{1}%
+  \let\\=\@vscentercr
+  \list{}{\itemsep     \z@
+          \itemindent  -\vindent
+          \listparindent\itemindent
+          \leftmargin   \vleftmargin
+          \parsep       \stanzaskip
+          \ifdim #1<\linewidth%   %% short line
+            \rightmargin        \z@
+            \leftmargin         \linewidth
+            \advance\leftmargin -#1\relax
+            \advance\leftmargin -0.5\leftmargin
+            \advance\leftmargin \vindent
+          \else
+            \ifdim #1>\linewidth%  %% long line
+              \rightmargin \z@
+              \leftmargin  \vindent
+            \else%                   %% default
+              \rightmargin \leftmargin
+              \advance\leftmargin \vindent
+            \fi
+          \fi}
+  \item[]}{\endlist}
+
+\newenvironment{altverse}%
+  {\starpatternfalse\patternfalse\altindenttrue
+   \setcounter{vslineno}{1}}%
+  {\altindentfalse}
+
+\newif\ifbounderror
+  \bounderrorfalse
+\newif\ifinteger
+
+\newcounter{chrsinstr}  % CHARactersINSTRing
+
+\newcommand{\newarray}[3]{%
+  \@nameedef{#1-low}{#2}%
+  \@nameedef{#1-high}{#3}%
+  \ifnum #3<#2
+    \@memerror{Limits for array #1 are in reverse order}{\@ehc}%
+  \fi}
+
+\newcommand{\stringtoarray}[2]{%
+  \def\@vsarrayname{#1}%
+  \protected at edef\the at vsstring{#2}%
+  \newarray{\@vsarrayname}{1}{1}%
+  \@ifmtarg{#2}{%
+    \c at chrsinstr \z@
+    \@namedef{\@vsarrayname-1}{}
+  }{%
+    \c at chrsinstr \@ne
+    \expandafter\@vsstringtoarray \the at vsstring\@vsend
+  }}
+
+\def\@vsstringtoarray #1#2\@vsend{%
+  \@namedef{\@vsarrayname-\the\c at chrsinstr}{#1}
+  \@nameedef{\@vsarrayname-high}{\the\c at chrsinstr}
+  \@ifmtarg{#2}{%
+    \def\@vsinext{}%
+  }{%
+    \advance\c at chrsinstr \@ne
+    \def\@vsinext{%
+      \@vsstringtoarray #2\@vsend%
+    }%
+  }
+  \@vsinext}
+
+\newcommand{\setarrayelement}[3]{%
+  \checkarrayindex{#1}{#2}%
+  \@nameedef{#1-#2}{#3}}
+\newcommand{\getarrayelement}[3]{%
+  \checkarrayindex{#1}{#2}%
+  \protected at edef#3{\@nameuse{#1-#2}}}
+
+\newcommand{\checkarrayindex}[2]{%
+  \bounderrorfalse
+  \expandafter\ifx\csname #1-low\endcsname\relax%
+    \ifpattern\else
+      \@memerror{No array called #1}{\@ehc}%
+    \fi
+    \bounderrortrue
+  \fi
+  \ifnum #2<\@nameuse{#1-low}\relax%
+    \ifpattern\else
+      \@memerror{Index #2 outside limits for array #1}{\@ehc}%
+    \fi
+    \bounderrortrue
+  \fi
+  \ifnum #2>\@nameuse{#1-high}\relax%
+    \ifpattern\else
+      \@memerror{Index #2 outside limits for array #1}{\@ehc}%
+    \fi
+    \bounderrortrue
+  \fi}
+
+\newcommand{\arraytostring}[2]{%
+  \def#2{}%
+  \c at chrsinstr = \@nameuse{#1-low}%
+  \@vsarraytostring{#1}{#2}}
+
+\newcommand{\@vsarraytostring}[2]{%
+  \ifnum\c at chrsinstr>\@nameuse{#1-high}\else
+    \protected at edef#2{#2\@nameuse{#1-\thechrsinstr}}%
+    \advance\c at chrsinstr\@ne%
+    \@vsarraytostring{#1}{#2}%
+  \fi}
+
+\newcommand{\checkifinteger}[1]{%
+  \protected at edef\@vsa{#1}%
+  \ifcat _\ifnum9<1\gobm{#1} _\else A\fi
+    \integertrue%
+  \else
+    \integerfalse%
+  \fi}
+\newcommand{\gobm}[1]{#1}
+
+\newcommand{\indentpattern}[1]{%
+  \stringtoarray{Array at vs}{#1}}
+\newcommand{\get at vsindent}{%
+  \getarrayelement{Array at vs}{\number\value{vslineno}}{\@vspat}%
+  \ifbounderror
+    \arraytostring{Array at vs}{\@vsp at t}%
+    \@memwarn{%
+      Index `\thevslineno' for pattern `\@vsp at t' is out of bounds}%
+    \def\@vspat{0}%
+  \else
+    \checkifinteger{\@vspat}%
+    \ifinteger\else
+      \arraytostring{Array at vs}{\@vsp at t}%
+      \@memwarn{%
+       `\@vspat' at index `\thevslineno' in pattern `\@vsp at t'
+       is not a digit}%
+      \def\@vspat{0}%
+    \fi
+  \fi
+  \ifcase\@vspat\else\hspace*{\@vspat\vgap}\fi}
+\newcommand{\getstar at vsindent}{%
+  \expandafter\ifx\csname Array at vs-high\endcsname\relax
+    \@memerror{A pattern has not been specified}{\@ehc}
+  \else
+    \ifnum\c at vslineno>\@nameuse{Array at vs-high}%
+      \setcounter{vslineno}{1}%
+     \fi
+     \get at vsindent
+  \fi}
+
+\newenvironment{patverse}%
+  {\starpatternfalse\patterntrue\altindentfalse
+   \setcounter{vslineno}{1}}%
+  {\patternfalse}
+
+\newenvironment{patverse*}%
+  {\starpatterntrue\patternfalse\altindentfalse
+   \setcounter{vslineno}{1}}%
+  {\starpatternfalse}
+
+\newcommand{\poemtitle}{\par%
+  \secdef\@vsptitle\@vssptitle}
+\newcommand{\poemtoc}{section}
+
+\newcommand{\mempoeminfo}[1]{}
+\newcommand{\mempoemstarinfo}[1]{}
+
+\long\def\@vsptitle[#1]#2{%
+  \phantomsection
+  \addcontentsline{toc}{\poemtoc}{#1}%
+  \M at gettitle{#1}%
+  \mempoeminfo{#1}%
+  \poemtitlemark{#1}%
+  \@vstypeptitle{#2}%
+  \@afterheading}
+
+\long\def\@vssptitle#1{%
+  \M at gettitle{#1}%
+  \mempoemstarinfo{#1}%
+  \@vstypeptitle{#1}%
+  \@afterheading}
+
+\newcommand{\@vstypeptitle}[1]{%
+  \vspace{\beforepoemtitleskip}%
+  {\poemtitlefont #1\par}%
+  \vspace{\afterpoemtitleskip}%
+}
+
+\newcommand{\poemtitlefont}{\normalfont\large\bfseries\centering}
+\newcommand{\poemtitlemark}[1]{}
+
+\newlength{\beforepoemtitleskip}
+  \setlength{\beforepoemtitleskip}{3.5ex \@plus 1ex \@minus .2ex}
+\newlength{\afterpoemtitleskip}
+  \setlength{\afterpoemtitleskip}{2.3ex \@plus.2ex}
+
+\newif\if at numptitle
+\newcommand*{\NumberPoemTitle}{\@numptitletrue}
+\newcommand*{\PlainPoemTitle}{\@numptitlefalse}
+\NumberPoemTitle
+
+\newcounter{poem}\setcounter{poem}{0}
+  \renewcommand*{\thepoem}{\@arabic\c at poem}
+\newcommand*{\theHpoem}{\arabic{poem}}
+
+\newcommand*{\poemtitlestarmark}[1]{}
+\newcommand*{\poemtitlepstyle}{}
+\newcommand*{\poemtitlestarpstyle}{}
+
+\newcommand\PoemTitle{%
+  \par
+  \@afterindentfalse
+  \@ifstar{\@m at msPoemTitle}{\@m at mPoemTitle}}
+
+\newcommand{\@m at mPoemTitle}[1][]{%
+  \def\poemt at c{#1}% capture first optional arg
+  \@ifnextchar[{\@PoemTitle}{\@PoemTitle[]}%
+}
+
+\newcommand{\memPoemTitleinfo}[4]{}
+\newcommand{\memPoemTitlestarinfo}[2]{}
+
+\def\@PoemTitle[#1]#2{%
+  \phantomsection
+  \ifx\poemt at c\@empty % no optional args
+    \def\poemf at rtoc{#2}%
+    \def\poemf at rhdr{#2}%
+  \else                  % at least one opt arg
+    \let\poemf at rtoc\poemt at c
+    \ifx\@empty#1\@empty
+      \let\poemf at rhdr\poemt at c
+    \else
+      \def\poemf at rhdr{#1}%
+    \fi
+  \fi
+  \m at m@Andfalse
+  \if at numptitle
+    \if at mainmatter
+      \m at m@Andtrue
+    \fi
+  \fi
+  \ifm at m@And
+    \refstepcounter{poem}%
+  \fi
+  \@makePoemTitlehead{#2}%
+  \@afterheading
+  \poemtitlemark{\poemf at rhdr}%
+  \poemtitlepstyle
+  \ifm at m@And
+    \addcontentsline{toc}{\poemtoc}{%
+      \protect\numberline{\thepoem}\poemf at rtoc}%
+    \memPoemTitleinfo{\thepoem}{\poemf at rtoc}{\poemf at rhdr}{#2}%
+  \else
+    \addcontentsline{toc}{\poemtoc}{\poemf at rtoc}%
+    \memPoemTitleinfo{}{\poemf at rtoc}{\poemf at rhdr}{#2}%
+  \fi
+  \ifheadnameref\M at gettitle{\poemf at rhdr}\else\M at gettitle{\poemf at rtoc}\fi}
+
+\def\@makePoemTitlehead#1{{%
+  \PoemTitleheadstart
+  \parindent \z@ \normalfont
+   \ifm at m@And
+     \printPoemTitlenum
+     \afterPoemTitlenum
+   \else
+     \printPoemTitlenonum
+   \fi
+   \interlinepenalty\@M
+   \printPoemTitletitle{#1}%
+   \afterPoemTitle}}
+
+\newcommand{\@PTchs at def@ult}{%
+  \def\PoemTitleheadstart{\vspace{\beforePoemTitleskip}}
+  \def\printPoemTitlenum{\PoemTitlenumfont \thepoem}
+  \def\afterPoemTitlenum{\par\nobreak\vskip \midPoemTitleskip}
+  \def\printPoemTitlenonum{}
+  \def\printPoemTitletitle##1{\PoemTitlefont ##1}
+  \def\afterPoemTitle{\par\nobreak\vskip \afterPoemTitleskip}}
+\@PTchs at def@ult
+
+\newcommand*{\PoemTitlenumfont}{\normalfont\large\centering}
+\newcommand*{\PoemTitlefont}{\normalfont\large\centering}
+\newlength{\beforePoemTitleskip}
+  \setlength{\beforePoemTitleskip}{1\onelineskip}
+\newlength{\midPoemTitleskip}
+  \setlength{\midPoemTitleskip}{0pt}
+\newlength{\afterPoemTitleskip}
+  \setlength{\afterPoemTitleskip}{1\onelineskip}
+
+\newcommand{\@m at msPoemTitle}[2][\@empty]{%
+  \@sPoemTitle{#2}%
+  \ifx \@empty#1
+    \def\poemf at rhdr{#2}%
+  \else   % opt arg
+    \def\poemf at rhdr{#1}%
+  \fi
+  \poemtitlestarmark{\poemf at rhdr}%
+  \poemtitlestarpstyle
+  \memPoemTitlestarinfo{\poemf at rhdr}{#2}}
+
+\newcommand{\@sPoemTitle}[1]{%
+  \@makesPoemTitlehead{#1}%
+  \@afterheading
+  \M at gettitle{#1}}
+
+\def\@makesPoemTitlehead#1{{%
+  \PoemTitleheadstart
+  \parindent \z@ \normalfont
+  \printPoemTitlenonum
+  \interlinepenalty\@M
+  \printPoemTitletitle{#1}
+  \afterPoemTitle}}
+
+\setlength\arraycolsep{5\p@}
+\setlength\tabcolsep{6\p@}
+\setlength\arrayrulewidth{.4\p@}
+\setlength\doublerulesep{2\p@}
+\setlength\tabbingsep{\labelsep}
+
+\newcommand{\@minipagerestore}{%
+  \let\@verbfootnotetext\@verbmpfootnotetext
+  \m at mdoextrafeetmini
+  \ifm at mnzpskip \parskip=\m at mabparskip\fi}
+
+\skip\@mpfootins = \skip\footins
+
+\setlength\fboxsep{3\p@}
+\setlength\fboxrule{.4\p@}
+
+\@addtoreset{equation}{chapter}
+\renewcommand{\theequation}{%
+  \ifnum \c at chapter>\z@ \thechapter\@SepMark\fi \@arabic\c at equation}
+
+%%%%%%%%%% Array package code %%%%%%%%%%%%%%%%%%%%%
+%%%%%%%%%% With acknowledgements to %%%%%%%%%%%%%%%%%%%%%
+%%%%%%%%%% Frank Mittelbach & David Carlisle %%%%%%%%%%%%%%%%%%%%%
+
+\def\@addtopreamble#1{\xdef\@preamble{\@preamble #1}}
+\def\@testpach{\@chclass
+ \ifnum \@lastchclass=6 \@ne \@chnum \@ne \else
+  \ifnum \@lastchclass=7 5 \else
+   \ifnum \@lastchclass=8 \tw@ \else
+    \ifnum \@lastchclass=9 \thr@@
+   \else \z@
+   \ifnum \@lastchclass = 10 \else
+   \edef\@nextchar{\expandafter\string\@nextchar}%
+   \@chnum
+   \if \@nextchar c\z@ \else
+    \if \@nextchar l\@ne \else
+     \if \@nextchar r\tw@ \else
+   \z@ \@chclass
+   \if\@nextchar |\@ne \else
+    \if \@nextchar !6 \else
+     \if \@nextchar @7 \else
+      \if \@nextchar <8 \else
+       \if \@nextchar >9 \else
+  10
+  \@chnum
+  \if \@nextchar m\thr@@\else
+   \if \@nextchar p4 \else
+    \if \@nextchar b5 \else
+   \z@ \@chclass \z@ \@preamerr \z@ \fi \fi \fi \fi
+   \fi \fi  \fi  \fi  \fi  \fi  \fi \fi \fi \fi \fi \fi}
+\def\prepnext at tok{\advance \count@ \@ne
+   \toks\count@{}}
+
+\def\save at decl{\toks \count@ = \expandafter\expandafter\expandafter
+                  {\expandafter\@nextchar\the\toks\count@}}
+
+\def\insert at column{%
+   \the at toks \the \@tempcnta
+   \ignorespaces \@sharp \unskip
+   \the at toks \the \count@ \relax}
+\let\m at mold@addamp\@addamp
+\newcommand*{\m at m@addamp}{%
+  \if at firstamp
+    \@firstampfalse
+    \global\@curtab\@ne
+  \else
+    \@addtopreamble{&}
+    \global\advance\@curtab\@ne
+  \fi}
+\let\@addamp\m at m@addamp
+
+\newdimen\col at sep
+\def\@acol{\@addtopreamble{\hskip\col at sep}}
+\def\@mkpream#1{\gdef\@preamble{}\@lastchclass 4 \@firstamptrue
+   \let\@sharp\relax \let\@startpbox\relax \let\@endpbox\relax
+   \@temptokena{#1}\@tempswatrue
+   \@whilesw\if at tempswa\fi{\@tempswafalse\the\NC at list}%
+   \count@\m at ne
+   \let\the at toks\relax
+   \prepnext at tok
+   \expandafter \@tfor \expandafter \@nextchar
+    \expandafter :\expandafter =\the\@temptokena \do
+   {\@testpach
+   \ifcase \@chclass \@classz \or \@classi \or \@classii
+     \or \save at decl \or \or \@classv \or \@classvi
+     \or \@classvii \or \@classviii
+     \or \@classx
+     \or \@classx \fi
+   \@lastchclass\@chclass}%
+   \ifcase\@lastchclass
+   \@acol \or
+   \or
+   \@acol \or
+   \@preamerr \thr@@ \or
+   \@preamerr \tw@ \@addtopreamble\@sharp \or
+   \or
+   \else  \@preamerr \@ne \fi
+   \def\the at toks{\the\toks}}
+\def\@classx{%
+  \ifcase \@lastchclass
+  \@acolampacol \or
+  \@addamp \@acol \or
+  \@acolampacol \or
+  \or
+  \@acol \@firstampfalse \or
+  \@addamp
+  \fi}
+\def\@classz{\@classx
+   \@tempcnta \count@
+   \prepnext at tok
+   \@addtopreamble{\ifcase \@chnum
+      \hfil
+      \d at llarbegin
+      \insert at column
+      \d at llarend \hfil \or
+      \hskip1sp\d at llarbegin \insert at column \d at llarend \hfil \or
+      \hfil\hskip1sp\d at llarbegin \insert at column \d at llarend \or
+   $\vcenter%$
+   \@startpbox{\@nextchar}\insert at column \@endpbox $\or%$
+   \vtop \@startpbox{\@nextchar}\insert at column \@endpbox \or
+   \vbox \@startpbox{\@nextchar}\insert at column \@endpbox
+  \fi}\prepnext at tok}
+
+\let\@classix\relax
+
+\def\@classviii{\ifnum \@lastchclass >\z@\ifnum\@lastchclass=\tw@\else
+      \@preamerr 4\@chclass 6 \@classvi \fi\fi}
+
+\def\@arrayrule{\@addtopreamble \vline}
+
+\def\@classvii{\ifnum \@lastchclass = \thr@@
+   \@preamerr \thr@@ \fi}
+
+\def\@classvi{\ifcase \@lastchclass
+      \@acol \or
+      \@addtopreamble{\hskip \doublerulesep}\or
+      \@acol \or
+      \@classvii
+      \fi}
+
+\def\@classii{\advance \count@ \m at ne
+   \save at decl\prepnext at tok}
+
+\def\@classv{\save at decl
+   \expandafter\NC at ecs\@nextchar\extracolsep{}\extracolsep\@@@
+   \@addtopreamble{\d at llarbegin\the at toks\the\count@\relax\d at llarend}%
+   \prepnext at tok}
+\def\NC at ecs#1\extracolsep#2#3\extracolsep#4\@@@{\def\@tempa{#2}%
+  \ifx\@tempa\@empty\else\toks\count@={#1\tabskip#2\relax#3}\fi}
+
+\def\@classi{\@classvi
+   \ifcase \@chnum \@arrayrule \or
+      \@classv \fi}
+
+\def\@startpbox#1{\bgroup
+  \setlength\hsize{#1}\@arrayparboxrestore
+   \everypar{%
+      \vrule \@height \ht\@arstrutbox \@width \z@
+      \everypar{}}%
+   }
+\def\@endpbox{\@finalstrut\@arstrutbox \egroup\hfil}
+\def\@array[#1]#2{%
+  \@tempdima \ht \strutbox
+  \advance \@tempdima by\extrarowheight
+  \setbox \@arstrutbox \hbox{\vrule
+             \@height \arraystretch \@tempdima
+             \@depth \arraystretch \dp \strutbox
+             \@width \z@}%
+  \begingroup
+  \@mkpream{#2}%
+  \xdef\@preamble{\noexpand \ialign \@halignto
+                  \bgroup \@arstrut \@preamble
+                          \tabskip \z@ \cr}%
+  \endgroup
+  \@arrayleft
+  \if #1t\vtop \else \if#1b\vbox \else \vcenter \fi \fi
+  \bgroup
+  \let \@sharp ##\let \protect \relax
+  \lineskip \z@
+  \baselineskip \z@
+  \m at th
+  \let\\\@arraycr \let\tabularnewline\\\let\par\@empty \@preamble}
+\newdimen \extrarowheight
+\extrarowheight=0pt
+\def\@arstrut{\unhcopy\@arstrutbox}
+\def\@arraycr{\relax\iffalse{\fi\ifnum 0=`}\fi
+  \@ifstar \@xarraycr \@xarraycr}
+\def\@xarraycr{\@ifnextchar [%
+  \@argarraycr {\ifnum 0=`{}\fi\cr}}
+\def\@argarraycr[#1]{\ifnum0=`{}\fi\ifdim #1>\z@
+  \expandafter\@xargarraycr\else
+  \expandafter\@yargarraycr\fi{#1}}
+\def\@xargarraycr#1{\unskip
+  \@tempdima #1\advance\@tempdima \dp\@arstrutbox
+  \vrule \@depth\@tempdima \@width\z@ \cr}
+\def\@yargarraycr#1{\cr\noalign{\vskip #1}}
+\long\def\multicolumn#1#2#3{%
+   \multispan{#1}\begingroup
+   \def\@addamp{\if at firstamp \@firstampfalse \else
+                \@preamerr 5\fi}%
+   \@mkpream{#2}\@addtopreamble\@empty
+   \endgroup
+   \def\@sharp{#3}%
+   \@arstrut \@preamble
+   \null
+   \ignorespaces}
+\let\d at llarbegin\begingroup
+\let\d at llarend\endgroup
+\def\array{\col at sep\arraycolsep
+  \def\d at llarbegin{$}\let\d at llarend\d at llarbegin\gdef\@halignto{}%$
+  \@tabarray}
+\def\@tabarray{\@ifnextchar[{\@@array}{\@@array[c]}}
+\let\@@array\@array
+\def\tabular{\gdef\@halignto{}\@tabular}
+\expandafter\def\csname tabular*\endcsname#1{%
+       \setlength\dimen@{#1}%
+       \xdef\@halignto{to\the\dimen@}\@tabular}
+\def\@tabular{%
+  \leavevmode
+  \hbox \bgroup $\col at sep\tabcolsep \let\d at llarbegin\begingroup%$
+                                    \let\d at llarend\endgroup
+  \@tabarray}
+\def\endarray{\crcr \egroup \egroup \@arrayright \gdef\@preamble{}}
+\let\@arrayleft\@empty
+\let\@arrayright\@empty
+\def\endtabular{\endarray $\egroup}%$
+\expandafter\let\csname endtabular*\endcsname=\endtabular
+\let\@ampacol=\relax        \let\@expast=\relax
+\let\@arrayclassiv=\relax   \let\@arrayclassz=\relax
+\let\@tabclassiv=\relax     \let\@tabclassz=\relax
+\let\@arrayacol=\relax      \let\@tabacol=\relax
+\let\@tabularcr=\relax      \let\@@endpbox=\relax
+\let\@argtabularcr=\relax   \let\@xtabularcr=\relax
+\def\@preamerr#1{\def\@tempd{{..} at wrong position: }%
+   \ClassError{bidimemoir}{%
+   \ifcase #1 Illegal pream-token (\@nextchar): `c' used\or %0
+    Missing arg: token ignored\or                           %1
+    Empty preamble: `l' used\or                             %2
+    >\@tempd token ignored\or                               %3
+    <\@tempd changed to !{..}\or                            %4
+    Only one column-spec. allowed.\fi}\@ehc}                %5
+
+\def\newcolumntype#1{%
+  \edef\NC at char{\string#1}%
+  \@ifundefined{NC at find@\NC at char}%
+    {\@tfor\next:=<>clrmbp@!|\do{\if\noexpand\next\NC at char
+        \@memwarn{Redefining primitive column \NC at char}\fi}%
+     \NC at list\expandafter{\the\NC at list\NC at do#1}}%
+    {\@memwarn{Column \NC at char\space is already defined}}%
+  \@namedef{NC at find@\NC at char}##1#1{\NC@{##1}}%
+  \@ifnextchar[{\newcol@{\NC at char}}{\newcol@{\NC at char}[0]}}
+\def\newcol@#1[#2]#3{\expandafter\@reargdef
+     \csname NC at rewrite@#1\endcsname[#2]{\NC at find#3}}
+\def\NC@#1{%
+  \@temptokena\expandafter{\the\@temptokena#1}\futurelet\next\NC at ifend}
+\def\NC at ifend{%
+  \ifx\next\relax
+    \else\@tempswatrue\expandafter\NC at rewrite\fi}
+\def\NC at do#1{%
+  \expandafter\let\expandafter\NC at rewrite
+    \csname NC at rewrite@\string#1\endcsname
+  \expandafter\let\expandafter\NC at find
+    \csname NC at find@\string#1\endcsname
+  \expandafter\@temptokena\expandafter{\expandafter}%
+        \expandafter\NC at find\the\@temptokena#1\relax}
+\def\showcols{{\def\NC at do##1{\let\NC at do\NC at show}\the\NC at list}}
+\def\NC at show#1{%
+  \typeout{Column #1\expandafter\expandafter\expandafter\NC at strip
+  \expandafter\meaning\csname NC at rewrite@#1\endcsname\@@}}
+\def\NC at strip#1:#2->#3 #4\@@{#2 -> #4}
+\newtoks\NC at list
+\newcolumntype{*}[2]{}
+\long\@namedef{NC at rewrite@*}#1#2{%
+  \count@#1\relax
+  \loop
+  \ifnum\count@>\z@
+    \advance\count@\m at ne
+    \@temptokena\expandafter{\the\@temptokena#2}%
+  \repeat
+  \NC at find}
+
+\newlength{\extratabsurround}
+\setlength{\extratabsurround}{2pt}
+\newlength{\backup at length}
+\newcommand{\firsthline}{%
+  \multicolumn1c{%
+    \global\backup at length\ht\@arstrutbox
+    \global\advance\backup at length\dp\@arstrutbox
+    \global\advance\backup at length\arrayrulewidth
+     \raise\extratabsurround\copy\@arstrutbox
+    }\\[-\backup at length]\hline
+}
+\newcommand{\lasthline}{\hline\multicolumn1c{%
+    \global\backup at length2\ht\@arstrutbox
+    \global\advance\backup at length2\dp\@arstrutbox
+    \global\advance\backup at length\arrayrulewidth
+    }\\[-\backup at length]%
+    \multicolumn1c{%
+       \lower\extratabsurround\copy\@arstrutbox
+       }%
+}
+\CheckCommand*\@xhline{\ifx\reserved at a\hline
+               \vskip\doublerulesep
+               \vskip-\arrayrulewidth
+             \fi
+      \ifnum0=`{\fi}}
+\renewcommand*\@xhline{\ifx\reserved at a\hline
+               \vskip\doublerulesep
+             \fi
+      \ifnum0=`{\fi}}
+
+%%%%%%%%%%% end Array package code %%%%%%%%%%%%%%%%%%%%%
+
+%%%%%%%%%% Dcolumn package code %%%%%%%%%%%%%%%%%%%%%
+%%%%%%%%%% With acknowledgements to David Carlisle %%%%%%%%%%%%%%%%%%%%%
+
+\def\DC@#1#2#3{%
+  \uccode`\~=`#1\relax
+  \m at th
+  \afterassignment\DC at x\count@#3\relax{#1}{#2}}
+\def\DC at x#1\relax#2#3{%
+  \ifnum\z@>\count@
+    \expandafter\DC at centre
+  \else
+    \expandafter\DC at right
+  \fi
+  {#2}{#3}{#1}}
+\def\DC at centre#1#2#3{%
+  \let\DC at end\DC at endcentre
+  \uppercase{\def~}{$\egroup\setbox\tw@=\hbox\bgroup${#2}}%$
+  \setbox\tw@=\hbox{${\phantom{{#2}}}$}%
+  \setbox\z@=\hbox\bgroup$\mathcode`#1="8000 }%$
+\def\DC at endcentre{$\egroup%$
+    \ifdim \wd\z@>\wd\tw@
+      \setbox\tw@=\hbox to\wd\z@{\unhbox\tw@\hfill}%
+    \else
+      \setbox\z@=\hbox to\wd\tw@{\hfill\unhbox\z@}\fi
+    \box\z@\box\tw@}
+\def\DC at right#1#2#3{%
+  \ifx\relax#3\relax
+    \hfill
+    \let\DC at rl\bgroup
+  \else
+    \edef\DC at rl{to\the\count@\dimen at ii\bgroup\hss\hfill}%
+    \count@\@gobble#3\relax
+  \fi
+  \let\DC at end\DC at endright
+  \uppercase{\def~}{$\egroup\setbox\tw@\hbox to\dimen@\bgroup${#2}}%
+   \setbox\z@\hbox{$1$}\dimen at ii\wd\z@
+   \dimen@\count@\dimen at ii
+   \setbox\z@\hbox{${#2}$}\advance\dimen@\wd\z@
+   \setbox\tw@\hbox to\dimen@{}%
+   \setbox\z@\hbox\DC at rl$\mathcode`#1="8000 }%$
+\def\DC at endright{$\hfil\egroup\box\z@\box\tw@}%$
+\newcolumntype{D}[3]{>{\DC@{#1}{#2}{#3}}c<{\DC at end}}
+
+%%%%%%%%%% end Dcolumn package code %%%%%%%%%%%%%%%%%%%%%
+
+%%%%%%%%%% Delarray package code %%%%%%%%%%%%%%%%%%%%%
+%%%%%%%%%% With acknowledgements to David Carlisle %%%%%%%%%%%%%%%%%%%%%
+
+\def\@@array[#1]{\@ifnextchar\bgroup
+  {\let\@arrayleft\relax\let\@arrayright\relax\@array[#1]}%
+  {\@del at array[#1]}}
+\def\@del at array[#1]#2#3#4{%
+  \setbox\z@\hbox{$\left#2\right#4$}%
+  \if#1c\def\@arrayleft{\left#2}\def\@arrayright{\right#4}%
+  \else\def\@arrayleft{\setbox\z@}%
+  \def\@arrayright{%
+     \dimen@=\dp\z@
+     \advance\dimen at -\ht\z@
+     \divide \dimen@ by \tw@
+     \advance\dimen@ by\fontdimen22 \textfont\tw@
+     \lower\dimen@\hbox{$\left#2\vcenter{\unvbox\z@}\right#4$}}%
+  \fi
+  \@array[#1]{#3}}
+%%%%%%%%%% end Delarray package code %%%%%%%%%%%%%%%%%%%%%
+
+%%%%%%%%%% Tabularx package code %%%%%%%%%%%%%%%%%%%%%
+%%%%%%%%%% With acknowledgements to David Carlisle %%%%%%%%%%%%%%%%%%%%%
+
+\newdimen\TX at col@width
+\newdimen\TX at old@table
+\newdimen\TX at old@col
+\newdimen\TX at target
+\newdimen\TX at delta
+\newcount\TX at cols
+\newif\ifTX@
+\def\tabularx#1{%
+\edef\TX@{\@currenvir}%
+  {\ifnum0=`}\fi
+  \setlength\TX at target{#1}%
+  \TX at typeout{Target width: #1 = \the\TX at target.}%
+  \toks@{}\TX at get@body}
+
+\let\endtabularx\relax
+\long\def\TX at get@body#1\end
+  {\toks@\expandafter{\the\toks@#1}\TX at find@end}
+\def\TX at find@end#1{%
+  \def\@tempa{#1}%
+  \ifx\@tempa\TX@\expandafter\TX at endtabularx
+  \else\toks@\expandafter
+    {\the\toks@\end{#1}}\expandafter\TX at get@body\fi}
+\def\TX@{tabularx}
+\def\TX at endtabularx{%
+  \expandafter\TX at newcol\expandafter{\tabularxcolumn{\TX at col@width}}%
+  \let\verb\TX at verb
+  \def\@elt##1{\global\value{##1}\the\value{##1}\relax}%
+  \edef\TX at ckpt{\cl@@ckpt}%
+  \let\@elt\relax
+  \TX at old@table\maxdimen
+  \TX at col@width\TX at target
+  \global\TX at cols\@ne
+  \TX at typeout@
+    {\@spaces Table Width\@spaces Column Width\@spaces X Columns}%
+  \TX at trial{\def\NC at rewrite@X{%
+          \global\advance\TX at cols\@ne\NC at find p{\TX at col@width}}}%
+  \loop
+    \TX at arith
+    \ifTX@
+    \TX at trial{}%
+  \repeat
+  {\let\@footnotetext\TX at ftntext\let\@xfootnotenext\TX at xftntext
+    \csname tabular*\expandafter\endcsname\expandafter\TX at target
+      \the\toks@
+    \csname endtabular*\endcsname}%
+  \global\TX at ftn\expandafter{\expandafter}\the\TX at ftn
+  \ifnum0=`{\fi}%
+  \expandafter\end\expandafter{\TX@}}
+\def\TX at arith{%
+  \TX at false
+  \ifdim\TX at old@table=\wd\@tempboxa
+    \TX at col@width\TX at old@col
+    \TX at typeout@{Reached minimum width, backing up.}%
+  \else
+    \dimen@\wd\@tempboxa
+    \advance\dimen@ -\TX at target
+    \ifdim\dimen@<\TX at delta
+      \TX at typeout@{Reached target.}%
+    \else
+      \ifnum\TX at cols>\@ne
+        \advance\TX at cols\m at ne
+      \fi
+      \divide\dimen@\TX at cols
+      \advance\dimen@ -\TX at col@width
+      \ifdim \dimen@ >\z@
+        \@memwarn{X Columns too narrow (table too wide)\MessageBreak}%
+        \TX at col@width\TX at error@width\relax
+      \else
+        \TX at old@col\TX at col@width
+        \TX at old@table\wd\@tempboxa
+        \TX at col@width-\dimen@
+        \TX at true
+      \fi
+    \fi
+  \fi}
+\def\TX at error@width{1em}
+\TX at delta\hfuzz
+\newcolumntype{X}{}
+\def\tabularxcolumn#1{p{#1}}
+\def\TX at newcol{\newcol@{X}[0]}
+\def\TX at trial#1{%
+  \setbox\@tempboxa\hbox{%
+    #1\relax
+  \let\@footnotetext\TX at trial@ftn
+  \let\TX at vwarn\@empty
+   \expandafter\let\expandafter\tabularx\csname tabular*\endcsname
+   \expandafter\let\expandafter\endtabularx\csname endtabular*\endcsname
+   \def\write{\begingroup
+     \def\let{\afterassignment\endgroup\toks@}%
+        \afterassignment\let\count@}%
+    \hbadness\@M
+    \hfuzz\maxdimen
+    \let\hbadness\@tempcnta
+    \let\hfuzz\@tempdima
+    \expandafter\tabular\the\toks@
+    \endtabular}%
+  \TX at ckpt
+  \TX at typeout@{\@spaces
+     \expandafter\TX at align
+        \the\wd\@tempboxa\space\space\space\space\space\@@
+     \expandafter\TX at align
+        \the\TX at col@width\space\space\space\space\space\@@
+     \@spaces\the\TX at cols}}
+\def\TX at align#1.#2#3#4#5#6#7#8#9\@@{%
+  \ifnum#1<10 \space\fi
+  \ifnum#1<100 \space\fi
+  \ifnum#1<\@m\space\fi
+  \ifnum#1<\@M\space\fi
+  #1.#2#3#4#5#6#7#8\space\space}
+\def\arraybackslash{\let\\\@arraycr}
+\def\tracingtabularx{%
+  \def\TX at typeout{\ClassWarningNoLine{bidimemoir}}%
+  \def\TX at typeout@##1{\typeout{(tabularx) ##1}}}
+\let\TX at typeout\@gobble
+\let\TX at typeout@\@gobble
+\newtoks\TX at ftn
+\long\def\TX at ftntext#1{%
+  \edef\@tempa{\the\TX at ftn\noexpand\footnotetext
+                    [\the\csname c@\@mpfn\endcsname]}%
+  \global\TX at ftn\expandafter{\@tempa{#1}}}%
+\long\def\TX at xftntext[#1]#2{%
+  \global\TX at ftn\expandafter{\the\TX at ftn\footnotetext[#1]{#2}}}
+\long\def\TX at trial@ftn#1{}
+{\uccode`\*=`\ %
+\uppercase{\gdef\TX at verb{%
+  \leavevmode\null\TX at vwarn
+  {\ifnum0=`}\fi\ttfamily\let\\\ignorespaces
+  \@ifstar{\let~*\TX at vb}{\TX at vb}}}}
+\def\TX at vb#1{\def\@tempa##1#1{\toks@{##1}\edef\@tempa{\the\toks@}%
+    \expandafter\TX at v\meaning\@tempa\\ \\\ifnum0=`{\fi}}\@tempa!}
+\def\TX at v#1!{\afterassignment\TX at vfirst\let\@tempa= }
+\begingroup
+\catcode`\*=\catcode`\#
+\catcode`\#=12
+\gdef\TX at vfirst{%
+  \if\@tempa#%
+    \def\@tempb{\TX at v@#}%
+  \else
+    \let\@tempb\TX at v@
+    \if\@tempa\space~\else\@tempa\fi
+  \fi
+  \@tempb}
+\gdef\TX at v@*1 *2{%
+  \TX at v@hash*1##\relax\if*2\\\else~\expandafter\TX at v@\fi*2}
+\gdef\TX at v@hash*1##*2{*1\ifx*2\relax\else#\expandafter\TX at v@hash\fi*2}
+\endgroup
+\def\TX at vwarn{%
+  \@warning{\noexpand\verb may be unreliable inside tabularx}%
+  \global\let\TX at vwarn\@empty}
+
+%%%%%%%%%% end Tabularx package code %%%%%%%%%%%%%%%%%%%%%
+
+%%\@memfakeusepackage{array}
+%%\@memfakeusepackage{dcolumn}
+%%\@memfakeusepackage{delarray}
+%%\@memfakeusepackage{tabularx}
+
+\newcommand*{\bktabrule}[1]{%
+  \hrule \@height#1}
+
+%%%%%%%%%% Booktabs package code       %%%%%%%%%%%%%%%%%%%%%
+%%%%%%%%%% slightly modified by PRW    %%%%%%%%%%%%%%%%%%%%%
+%%%%%%%%%% by permission of Simon Fear %%%%%%%%%%%%%%%%%%%%%
+
+\AtBeginDocument{%
+  \providecommand*{\CT at arc@}{}}
+
+\newdimen\heavyrulewidth
+\newdimen\lightrulewidth
+\newdimen\cmidrulewidth
+\newdimen\belowrulesep
+\newdimen\belowbottomsep
+\newdimen\aboverulesep
+\newdimen\abovetopsep
+\newdimen\cmidrulesep
+\newdimen\cmidrulekern
+\newdimen\defaultaddspace
+\heavyrulewidth=.08em
+\lightrulewidth=.05em
+\cmidrulewidth=.03em
+\belowrulesep=.65ex
+\belowbottomsep=\z@
+\aboverulesep=.4ex
+\abovetopsep=\z@
+\cmidrulesep=\doublerulesep
+\cmidrulekern=.5em
+\defaultaddspace=.5em
+
+\newcount\@cmidla
+\newcount\@cmidlb
+\newdimen\@aboverulesep
+\newdimen\@belowrulesep
+\newcount\@thisruleclass
+\newcount\@lastruleclass
+\@lastruleclass=0
+\newdimen\@thisrulewidth
+
+\def\futurenonspacelet#1{\def\@BTcs{#1}%
+ \afterassignment\@BTfnslone\let\nexttoken= }
+\def\@BTfnslone{\expandafter\futurelet\@BTcs\@BTfnsltwo}
+\def\@BTfnsltwo{\expandafter\ifx\@BTcs\@sptoken\let\next=\@BTfnslthree
+ \else\let\next=\nexttoken\fi \next}
+\def\@BTfnslthree{\afterassignment\@BTfnslone\let\next= }
+
+\def\toprule{\noalign{\ifnum0=`}\fi
+  \@aboverulesep=\abovetopsep
+  \global\@belowrulesep=\belowrulesep
+  \global\@thisruleclass=\@ne
+  \@ifnextchar[{\@BTrule}{\@BTrule[\heavyrulewidth]}}
+
+\def\midrule{\noalign{\ifnum0=`}\fi
+  \@aboverulesep=\aboverulesep
+  \global\@belowrulesep=\belowrulesep
+  \global\@thisruleclass=\@ne
+  \@ifnextchar[{\@BTrule}{\@BTrule[\lightrulewidth]}}
+
+\def\bottomrule{\noalign{\ifnum0=`}\fi
+  \@aboverulesep=\aboverulesep
+  \global\@belowrulesep=\belowbottomsep
+  \global\@thisruleclass=\@ne
+  \@ifnextchar[{\@BTrule}{\@BTrule[\heavyrulewidth]}}
+
+\def\specialrule#1#2#3{\noalign{\ifnum0=`}\fi
+  \@aboverulesep=#2\global\@belowrulesep=#3\global\@thisruleclass=\tw@
+  \@BTrule[#1]}
+
+\def\addlinespace{\noalign{\ifnum0=`}\fi
+  \@ifnextchar[{\@addspace}{\@addspace[\defaultaddspace]}}
+\def\@addspace[#1]{\global\@belowrulesep=#1\global\@thisruleclass=\tw@
+  \futurelet\@tempa\@BTendrule}
+
+\def\@BTrule[#1]{%
+  \global\@thisrulewidth=#1\relax
+  \ifnum\@thisruleclass=\tw@\vskip\@aboverulesep\else
+  \ifnum\@lastruleclass=\z@\vskip\@aboverulesep\else
+  \ifnum\@lastruleclass=\@ne\vskip\doublerulesep\fi\fi\fi
+
+  \ifx\longtable\undefined\let\@BTswitch\@BTnormal\else
+  \ifx\hline\LT at hline\let\@BTswitch\@BLTrule
+  \else\let\@BTswitch\@BTnormal\fi\fi
+  \@BTswitch}
+
+\def\@BTnormal{%
+%%  \bktabrule{\@thisrulewidth}
+  {\CT at arc@\bktabrule{\@thisrulewidth}}%
+  \futurenonspacelet\@tempa\@BTendrule}
+\def\@BLTrule{\@ifnextchar({\@@BLTrule}{\@@BLTrule()}}
+\def\@@BLTrule(#1){\@setrulekerning{#1}%
+\global\@cmidlb\LT at cols
+\ifnum0=`{\fi}%
+\@cmidruleb
+\noalign{\ifnum0=`}\fi
+\futurenonspacelet\@tempa\@BTendrule}
+
+\def\@BTendrule{%
+  \ifx\@tempa\toprule\global\@lastruleclass=\@thisruleclass
+  \else\ifx\@tempa\midrule\global\@lastruleclass=\@thisruleclass
+  \else\ifx\@tempa\bottomrule\global\@lastruleclass=\@thisruleclass
+  \else\ifx\@tempa\cmidrule\global\@lastruleclass=\@thisruleclass
+  \else\ifx\@tempa\specialrule\global\@lastruleclass=\@thisruleclass
+  \else\ifx\@tempa\addlinespace\global\@lastruleclass=\@thisruleclass
+  \else\global\@lastruleclass=\z@\fi\fi\fi\fi\fi\fi
+  \ifnum\@lastruleclass=\@ne\relax\else\vskip\@belowrulesep\fi
+  \ifnum0=`{\fi}}
+\def\@setrulekerning#1{%
+  \global\let\cmrkern at l\z@
+  \global\let\cmrkern at r\z@
+  \@tfor\@tempa :=#1\do
+  {\def\@tempb{r}%
+   \ifx\@tempa\@tempb
+     \global\let\cmrkern at r\cmidrulekern
+      \def\cmrsideswitch{\cmrkern at r}%
+   \else
+     \def\@tempb{l}%
+     \ifx\@tempa\@tempb
+       \global\let\cmrkern at l\cmidrulekern
+       \def\cmrsideswitch{\cmrkern at l}%
+     \else
+       \global\expandafter\let\cmrsideswitch\@tempa
+     \fi
+   \fi}}
+
+\def\cmidrule{\noalign{\ifnum0=`}\fi
+    \@ifnextchar[{\@cmidrule}{\@cmidrule[\cmidrulewidth]}}
+\def\@cmidrule[#1]{\@ifnextchar({\@@cmidrule[#1]}{\@@cmidrule[#1]()}}
+\def\@@cmidrule[#1](#2)#3{\@@@cmidrule[#3]{#1}{#2}}
+
+\def\@@@cmidrule[#1-#2]#3#4{\global\@cmidla#1\relax
+    \global\advance\@cmidla\m at ne
+    \ifnum\@cmidla>0\global\let\@gtempa\@cmidrulea\else
+    \global\let\@gtempa\@cmidruleb\fi
+    \global\@cmidlb#2\relax
+    \global\advance\@cmidlb-\@cmidla
+    \global\@thisrulewidth=#3
+    \@setrulekerning{#4}
+    \ifnum\@lastruleclass=\z@\vskip \aboverulesep\fi
+    \ifnum0=`{\fi}\@gtempa
+    \noalign{\ifnum0=`}\fi\futurenonspacelet\@tempa\@xcmidrule}
+\def\@xcmidrule{\ifx\@tempa\cmidrule\vskip-\@thisrulewidth
+    \global\@lastruleclass=\@ne\else
+    \ifx\@tempa\morecmidrules\vskip \cmidrulesep
+    \global\@lastruleclass=\@ne\else
+    \vskip \belowrulesep\global\@lastruleclass=\z@\fi\fi
+    \ifnum0=`{\fi}}
+
+\def\@cmidrulea{%
+  \multispan\@cmidla&\multispan\@cmidlb
+%%    \unskip\hskip \cmrkern at l\leaders\bktabrule{\@thisrulewidth}\hfill
+    \unskip\hskip \cmrkern at l{%
+    \CT at arc@\leaders\bktabrule{\@thisrulewidth}\hfill}%
+    \hskip \cmrkern at r\cr}
+\def\@cmidruleb{%
+  \multispan\@cmidlb
+%%    \unskip\hskip \cmrkern at l\leaders\bktabrule{\@thisrulewidth}\hfill
+  \unskip\hskip \cmrkern at l{%
+    \CT at arc@\leaders\bktabrule{\@thisrulewidth}\hfill}%
+    \hskip \cmrkern at r\cr}
+
+\def\morecmidrules{\noalign{\relax}}
+
+%%%%%%%%%% end of Booktabs package code %%%%%%%%%%%%%%%%%%%%%
+
+%%\@memfakeusepackage{booktabs}
+
+\ifetex
+  \renewcommand*{\killm at matf}[1]{%
+    \ifnum 6=\currentgrouptype
+      \ifvmode
+        \expandafter\expandafter\expandafter\@firstoftwo
+        \expandafter\expandafter\expandafter\noalign
+      \fi
+    \fi
+    \@firstofone
+    {\@namelet{#1-m at mfb}\relax
+     \@namelet{#1-m at mfe}\relax
+    }%
+  }
+\fi
+
+\newskip\ctableftskip \ctableftskip=\fill
+\newskip\ctabrightskip \ctabrightskip=\fill
+
+\expandafter\def\csname ctabular*\endcsname{%
+  \@ifnextchar[ {\@ctabularstar}{\@ctabularstar[c]}}
+\def\@ctabularstar[#1]#2{\global\@curtab\@ne
+  \ctableftskip\fill
+  \ctabrightskip\fill
+  \if l#1% left
+    \ctableftskip\z@
+  \else
+    \if r#1% right
+       \ctabrightskip\z@
+    \fi
+  \fi
+  \setlength\dimen@{#2}%
+  \xdef\@halignto{to\the\dimen@}\NC at tabular}
+\newcommand*{\ctabular}[1][c]{\global\@curtab\@ne
+  \ctableftskip\fill
+  \ctabrightskip\fill
+  \if l#1% left
+    \ctableftskip\z@
+  \else
+    \if r#1% right
+      \ctabrightskip\z@
+    \fi
+  \fi
+  \gdef\@halignto{to\hsize}\NC at tabular}
+
+\newcommand*{\NC at tabular}{%
+  \par
+  \addvspace{\topsep}
+  \col at sep\tabcolsep
+  \let\d at llarbegin\begingroup
+  \let\d at llarend\endgroup
+  \@NCtabarray}
+
+\newcommand*{\@NCialign}{\everycr{}\tabskip\ctableftskip\halign}
+
+\newcommand*{\@NCtabarray}[1]{%
+  \@tempdima \ht\strutbox
+  \advance\@tempdima\extrarowheight
+  \setbox \@arstrutbox \hbox{\vrule
+    \@height \arraystretch \@tempdima
+    \@depth \arraystretch \dp\strutbox
+    \@width\z@}%
+  \begingroup
+%%    \@mkpream{@{\hspace{\@totalleftmargin}}#1@{}}%
+    \@mkpream{#1}%
+    \xdef\@preamble{\@NCialign \@halignto
+                    \bgroup & \tabskip\z@
+                      \@arstrut
+                      \@preamble
+                      \tabskip\ctabrightskip
+                      \cr}%
+  \endgroup
+  \let\@sharp ##\let\protect\relax
+  \lineskip\z@
+  \baselineskip\z@
+  \let\\\@arraycr
+  \let\tabularnewline\\%
+  \let\par\@empty
+  \ctabsetlines
+  \@preamble
+}
+
+\def\endctabular{%
+  \crcr \egroup
+  \gdef\@preamble{}%
+  \addvspace{\topsep}
+  \noindent}
+\expandafter\let\csname endctabular*\endcsname=\endctabular
+
+%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
+\newcommand*{\memcline}[2]{\m at m@cline[#1]#2\@nil}
+\def\m at m@cline[#1]#2-#3\@nil{%
+  \omit
+  \@multicnt#2%
+  \advance\@multispan\m at ne
+  \ifnum\@multicnt=\@ne\@firstofone{&\omit}\fi
+  \@multicnt#3%
+  \advance\@multicnt-#2%
+  \advance\@multispan\@ne
+  \leaders\hrule\@height #1\hfill  % <- variable \@height value
+  \cr
+  \noalign{\vskip- #1}}            % <- variable \@height value
+
+\newcommand*{\memhline}[1][\arrayrulewidth]{\memcline{#1}{1-\@curtab}}
+\newcommand*{\m at mhline}{\cline{1-\@curtab}}
+\def\m at m@BTnormal{%
+  \ifnum0=`{\fi}   % closes the \noalign
+  \multispan{\@curtab} \leaders\bktabrule{\@thisrulewidth}\hfill\cr
+  \noalign{\ifnum0=`}\fi
+  \futurenonspacelet\@tempa\@BTendrule}
+
+\def\ctabsetlines{%
+  \let\hline\m at mhline
+  \let\@BTnormal\m at m@BTnormal}
+
+%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
+\newcount\abovecolumnspenalty
+  \abovecolumnspenalty=10000
+\newcount\@linestogo           % lines remaining to be procesed
+\newcount\@cellstogo           % cells remaining in column or row
+\newcount\@cellsincolumn         % number of lines per column
+\newtoks\crtok
+  \crtok = {\cr}%
+
+\newdimen\@mincolumnwidth
+\let\c at lleftskip\hfil   % left skip within a column
+\let\c at lrightskip\hfil % right skip within a column
+
+\let\preautotab\relax
+\let\postautotab\relax
+
+\newcommand{\autocols}[5][0pt]{\par\begingroup
+  \ctabsetlines
+  \if l#2
+    \raggedright
+  \else
+    \if r#2
+      \raggedleft
+    \else
+      \centering
+    \fi
+  \fi
+  \let\c at lleftskip\hfil
+  \let\c at lrightskip\hfil
+  \if l#4
+    \let\c at lleftskip\relax
+  \else
+    \if r#4
+      \let\c at lrightskip\relax
+    \fi
+  \fi
+  \@mincolumnwidth\z@
+  \TX at cols=#3
+  \@curtab=#3
+  \@linestogo\z@
+  \@for\@tempa:=#5\do{
+    \advance\@linestogo\@ne
+    \settowidth{\@tempdima}{\@tempa}
+    \ifdim\@tempdima>\@mincolumnwidth
+      \@mincolumnwidth=\@tempdima
+    \fi
+  }
+  \advance\@mincolumnwidth\tabcolsep
+  \linespercol
+  \def\@endcolumnactions{%
+    \global\advance\@linestogo\m at ne
+    \ifnum\@cellstogo<\tw@
+      \global\advance\TX at cols\m at ne
+      \ifnum\TX at cols>\z@\linespercol\fi
+      \the\crtok
+    \else
+        &\global\advance\@cellstogo\m at ne
+    \fi}%
+  \ifdim #1 > \z@
+    \TX at col@width=#1
+    \divide\TX at col@width \TX at cols
+  \else
+    \TX at col@width=\@mincolumnwidth
+  \fi
+  \penalty\abovecolumnspenalty
+  \noindent% usually not a paragraph
+  \def\@preamble{}%
+  \begingroup
+    \let\@sharp\relax
+    \ifnum\@cellsincolumn>\@ne
+      \loop
+        \g at addto@macro{\@preamble}{%
+          \hb at xt@ \TX at col@width{%
+               \c at lleftskip\strut\@sharp\c at lrightskip} &}%
+        \advance\@cellsincolumn\m at ne
+      \ifnum\@cellsincolumn>\@ne
+      \repeat
+    \fi
+    \g at addto@macro{\@preamble}{%
+      \hb at xt@ \TX at col@width{\c at lleftskip\strut\@sharp\c at lrightskip}}%
+  \endgroup
+  \let\@sharp ##
+  \tabskip\ctableftskip
+%%  \tabskip\z@
+  \valign \bgroup
+    \tabskip\z@
+    \@preamble
+    \tabskip\ctabrightskip\cr
+    \@for\@tempa:=#5\do{
+      \@tempa\unskip\space\@endcolumnactions}%
+    \the\crtok \egroup \par \endgroup}
+
+\newcommand*{\linespercol}{%
+  \@cellsincolumn=\@linestogo
+  \divide\@cellsincolumn \TX at cols
+  \@cellstogo=\@cellsincolumn
+  \multiply\@cellstogo \TX at cols
+  \@tempcnta=\@linestogo
+  \advance\@tempcnta -\@cellstogo
+  \ifnum \@tempcnta>\z@
+    \advance\@cellsincolumn \@ne
+  \fi
+  \global\@cellstogo=\@cellsincolumn}
+
+\newcommand{\autorows}[5][0pt]{\par\begingroup
+ \ctabsetlines
+  \ctableftskip\fill
+  \ctabrightskip\fill
+  \if l#2
+    \ctableftskip\z@
+  \else
+    \if r#2
+      \ctabrightskip\z@
+    \fi
+  \fi
+  \let\c at lleftskip\hfil
+  \let\c at lrightskip\hfil
+  \if l#4
+    \let\c at lleftskip\relax
+  \else
+    \if r#4
+      \let\c at lrightskip\relax
+    \fi
+  \fi
+  \TX at cols=#3\relax
+  \@curtab=#3\relax
+  \@cellstogo = \TX at cols
+  \@mincolumnwidth\z@
+  \@linestogo\z@
+  \@for\@tempa:=#5\do{%
+    \advance\@linestogo\@ne
+    \settowidth{\@tempdima}{\@tempa}
+    \ifdim\@tempdima>\@mincolumnwidth
+      \@mincolumnwidth=\@tempdima
+    \fi}%
+  \advance\@mincolumnwidth\tabcolsep
+  \def\@endcolumnactions{%
+    \global\advance\@linestogo\m at ne
+    \global\advance\@cellstogo\m at ne
+    \ifnum\@cellstogo<\@ne
+      \global\@cellstogo=\TX at cols
+      \the\crtok
+    \else
+      &
+    \fi}%
+  \ifdim #1>\z@
+    \TX at col@width=#1
+  \else
+    \TX at col@width=\hsize
+  \fi
+  \divide\TX at col@width \TX at cols
+  \ifdim #1=\z@
+    \TX at col@width=\@mincolumnwidth
+  \fi
+  \penalty\abovecolumnspenalty
+  \noindent % usually not a paragraph
+  \vskip -\z@ % don't know why we need this, but looks bad without it
+  \def\@preamble{}%
+  \begingroup
+    \let\@sharp\relax
+    \ifnum\TX at cols>\@ne
+      \loop
+        \ifdim #1<\z@
+          \g at addto@macro{\@preamble}{%
+            \strut\c at lleftskip\@sharp\c at lrightskip &}%
+        \else
+          \g at addto@macro{\@preamble}{%
+            \hb at xt@ \TX at col@width{%
+                    \strut\c at lleftskip\@sharp\c at lrightskip} &}%
+        \fi
+        \advance\TX at cols\m at ne
+      \ifnum\TX at cols>\@ne
+      \repeat
+    \fi
+    \ifdim #1<\z@
+      \g at addto@macro{\@preamble}{%
+        \strut\c at lleftskip\@sharp\c at lrightskip}%
+    \else
+      \g at addto@macro{\@preamble}{%
+        \hb at xt@ \TX at col@width{\strut\c at lleftskip\@sharp\c at lrightskip}}%
+    \fi
+  \endgroup
+  \let\@sharp ##
+  \tabskip\ctableftskip
+  \halign to \hsize \bgroup
+    \tabskip\z@
+    \@preamble
+%%    \tabskip\ctabrightskip\cr \preautotab
+    \tabskip\ctabrightskip\cr
+    \@for\@tempa:=#5\do{%
+      \@tempa\unskip\space\@endcolumnactions}%
+%%    \the\crtok \postautotab \the\crtok \egroup \endgroup \par
+    \the\crtok \egroup \endgroup \par}
+
+\newcounter{newflo at tctr}
+  \setcounter{newflo at tctr}{1}
+
+\newcommand{\newfloat}[4][\@empty]{%
+%%%  \@namedef{ftype@#2}{\value{newflo at tctr}}
+%%%  \addtocounter{newflo at tctr}{\value{newflo at tctr}}
+  \expandafter\edef\csname ftype@#2\endcsname{\the\c at newflo@tctr}%
+  \advance\c at newflo@tctr \c at newflo@tctr
+  \@ifundefined{c@#2}{% counter is not defined
+    \ifx \@empty#1\relax
+      \newcounter{#2}
+    \else
+      \newcounter{#2}[#1]
+      \expandafter\edef\csname the#2\endcsname{%
+  \expandafter\noexpand\csname the#1\endcsname.\noexpand\arabic{#2}}
+    \fi}{}
+  \setcounter{#2}{0}
+
+  \@namedef{ext@#2}{#3}%     file extension
+  \@ifundefined{c@#3depth}{\newcounter{#3depth}}{}
+  \setcounter{#3depth}{1}
+
+  \@namedef{fps@#2}{tbp}                     % position
+  \@namedef{fnum@#2}{#4~\@nameuse{the#2}}    % caption naming
+  \@namedef{fleg#2}{#4}                      % legend naming
+  \@namedef{flegtoc#2}##1{}                  % legend name in ToC
+
+  \newenvironment{#2}{\@float{#2}}{\end at float}
+  \newenvironment{#2*}{\@dblfloat{#2}}{\end at dblfloat}
+} % end \newfloat
+
+\newcommand*{\setfloatlocations}[2]{\@namedef{fps@#1}{#2}}
+
+\newcommand{\newsubfloat}[1]{%
+  \newlistentry[#1]{sub#1}{\@nameuse{ext@#1}}{1}
+  \@namedef{ext at sub#1}{\csname ext@#1\endcsname}
+  \@namedef{thesub#1}{(\alph{sub#1})}
+  \@namedef{@thesub#1}{\@nameuse{thesub#1}%
+            \if at tightsubcap\hskip\subfloatlabelskip\else\space\fi}
+  \@namedef{@@thesub#1}{\@nameuse{thesub#1}}
+  \@namedef{p at sub#1}{\csname the#1\endcsname}
+  \@namedef{toclevel at sub#1}{1}}
+
+\newif\ifdonemaincaption
+  \donemaincaptionfalse
+
+\let\@memoldfloat\@float
+\renewcommand{\@float}[1]{\donemaincaptionfalse
+  \@ifundefined{c at sub#1}{}{\csname c at sub#1\endcsname = 0\relax}%
+  \@memoldfloat{#1}}
+\let\@memolddblfloat\@dblfloat
+\renewcommand{\@dblfloat}[1]{\donemaincaptionfalse
+  \@ifundefined{c at sub#1}{}{\csname c at sub#1\endcsname = 0\relax}%
+  \@memolddblfloat{#1}}
+
+\let\@memoldefloat\end at float
+\def\end at float{%
+  \@memlistsubcaptions{\@captype}\@memoldefloat}
+\let\@memoldedblfloat\end at dblfloat
+\def\end at dblfloat{%
+  \@memlistsubcaptions{\@captype}\@memoldedblfloat}
+
+\AtBeginDocument{\@ifpackageloaded{fixltx2e}{%
+  \def\end at dblfloat{%
+    \if at twocolumn
+      \@endfloatbox
+      \ifnum\@floatpenalty<\z@
+        \@largefloatcheck
+        \global\dp\@currbox1sp %
+        \@cons\@deferlist\@currbox
+      \fi
+      \ifnum\@floatpenalty=-\@Mii \@Esphack\fi
+    \else
+      \end at float
+    \fi}}{}}
+
+\newif\if at contcw
+\newif\if at conthang
+\newif\if at contindent
+
+\newcommand{\captiondelim}[1]{\def\@contdelim{#1}}
+\captiondelim{: }
+
+\newcommand{\captionnamefont}[1]{\def\@contnfont{#1}}
+\captionnamefont{}
+
+\newcommand{\captiontitlefont}[1]{\def\@conttfont{#1}}
+\captiontitlefont{}
+
+\newcommand*{\captionstyle}[1]{\def\@contcstyle{#1}}
+\captionstyle{}
+
+\renewcommand{\captionstyle}{%
+  \@ifnextchar[ {\@memcshort}{\@memcnorm}}
+\def\@memcshort[#1]#2{%
+  \def\@contcshortstyle{#1}
+  \def\@contcstyle{#2}}
+\def\@memcnorm#1{%
+  \def\@contcshortstyle{#1}
+  \def\@contcstyle{#1}}
+\captionstyle{}
+
+\newlength{\@contcwidth}
+\newcommand{\captionwidth}[1]{\setlength{\@contcwidth}{#1}}
+\captionwidth{\linewidth}
+\newcommand{\changecaptionwidth}{\@contcwtrue}
+\newcommand{\normalcaptionwidth}{\@contcwfalse}
+\normalcaptionwidth
+
+\newlength{\@contindw}
+\newcommand{\hangcaption}{\@conthangtrue\@contindentfalse}
+\newcommand{\indentcaption}[1]{\setlength{\@contindw}{#1}%
+  \@conthangfalse\@contindenttrue}
+\newcommand{\normalcaption}{\@conthangfalse\@contindentfalse}
+\normalcaption
+
+\newcommand{\precaption}[1]{\def\@contpre{#1}}
+\precaption{}
+\newcommand{\postcaption}[1]{\def\@contpost{#1}}
+\postcaption{}
+\newcommand{\midbicaption}[1]{\def\@contmidbi{#1}}
+\midbicaption{}
+
+\newcommand*{\captiontitlefinal}[1]{\def\@contfinal{#1}}
+  \captiontitlefinal{}
+
+\newlength{\abovecaptionskip}
+  \setlength{\abovecaptionskip}{0.5\onelineskip}
+\newlength{\belowcaptionskip}
+  \setlength{\belowcaptionskip}{0.5\onelineskip}
+
+\let\@memoldcaption\caption
+\def\caption{\donemaincaptiontrue\@memoldcaption}
+
+\newcommand{\memcaptioninfo}[4]{}
+
+\let\@memold at caption\@caption
+\long\def\@caption#1[#2]#3{%
+  \M at gettitle{#2}%
+  \memcaptioninfo{#1}{\csname the#1\endcsname}{#2}{#3}%
+  \@memold at caption{#1}[{#2}]{#3}}
+
+\long\def\@makecaption#1#2{\let\@memtempa\relax
+  \ifdim\prevdepth>-99\p@ \vskip\abovecaptionskip
+  \else \def\@memtempa{\vbox to\topskip{}}\fi
+  \let\@contfnote\footnote \renewcommand{\footnote}[2][]{}
+  \let\@contfmark\footnotemark \renewcommand{\footnotemark}[1][]{}
+  \sbox\@tempboxa{\@contnfont #1\@contdelim \@conttfont #2\@contfinal}
+  \let\footnote\@contfnote
+  \let\footnotemark\@contfmark
+  \ifdim\wd\@tempboxa<\linewidth \centering \fi
+  \if at contcw
+    \centering
+    \parbox{\@contcwidth}{%
+    \ifdim\wd\@tempboxa<\@contcwidth \centering \fi
+  \fi
+  \if at conthang
+    \sbox\@tempboxa{\@contnfont #1\@contdelim}
+    \@contpre%
+    {\@contcstyle\hangindent=\wd\@tempboxa
+     \noindent\box\@tempboxa\@memtempa \@conttfont #2\@contfinal\par}
+  \else
+    \if at contindent
+      \@contpre%
+      {\@contnfont #1\@contdelim}\@memtempa
+      {\@contcstyle\hangindent=\@contindw
+                   \hangafter=\@ne\@conttfont #2\@contfinal\par}% <- v1.4
+    \else
+      \@contpre%
+      {\@contnfont #1\@contdelim}\@memtempa
+      {\ifdim\wd\@tempboxa<\linewidth
+         \@contcshortstyle\else \@contcstyle\fi%  <- v1.4
+       \@conttfont #2\@contfinal\par}
+    \fi
+  \fi
+  \@contpost
+  \if at contcw
+    \par
+    }  % end of the \parbox
+  \fi
+  \vskip\belowcaptionskip}
+
+\newcommand{\contcaption}{%
+  \addtocounter{\@captype}{\m at ne}\refstepcounter{\@captype}%
+  \@contcaption\@captype}
+
+\long\def\@@contcaption#1#2{%
+  \par
+  \begingroup
+     \@parboxrestore
+     \if at minipage
+       \@setminipage
+     \fi
+     \normalsize
+     \@makecaption{\csname fnum@#1\endcsname}{\ignorespaces #2}\par
+  \endgroup}
+
+\long\def\@contcaption#1#2{%
+  \if at contbotsub
+    \@memlistsubcaptions{#1}%
+    \@@contcaption{#1}{#2}%
+  \else
+    \@@contcaption{#1}{#2}%
+    \@memlistsubcaptions{#1}%
+  \fi}
+
+\newcommand{\memlegendinfo}[1]{}
+\newcommand{\legend}[1]{%
+  \M at gettitle{#1}%
+  \memlegendinfo{#1}%
+  \par
+  \begingroup
+     \@parboxrestore
+     \if at minipage
+       \@setminipage
+     \fi
+     \normalsize
+     \captiondelim{\mbox{}}
+     \@makecaption{}{\ignorespaces #1}\par
+  \endgroup}
+
+\newcommand{\namedlegend}{\@dblarg{\@legend\@captype}}
+\newcommand{\memnamedlegendinfo}[3]{}
+
+\long\def\@legend#1[#2]#3{%
+  \M at gettitle{#2}%
+  \memnamedlegendinfo{#1}{#2}{#3}%
+  \par
+  \csname flegtoc#1\endcsname{#2}%
+  \begingroup
+    \@parboxrestore
+    \if at minipage
+      \@setminipage
+    \fi
+    \normalsize
+    \@makecaption{\csname fleg#1\endcsname}{\ignorespaces #3}\par
+  \endgroup}
+
+\newcommand{\newfixedcaption}[3][\caption]{%
+  \newcommand{#2}{\def\@captype{#3}#1}}
+\newcommand{\renewfixedcaption}[3][\caption]{%
+  \renewcommand{#2}{\def\@captype{#3}#1}}
+\newcommand{\providefixedcaption}[3][\caption]{%
+  \providecommand{#2}{\def\@captype{#3}#1}}
+
+\newcommand{\membitwonumcaptioninfo}[7]{}
+\newcommand{\membionenumcaptioninfo}[7]{}
+\newcommand{\membicaptioninfo}[6]{}
+
+\newcommand{\bitwonumcaption}[6][\@empty]{%
+  \begingroup
+  \let\memcaptioninfo\@gobblefour
+  \@ifmtarg{#2}{\def\m at mscapi{#3}\caption{#3}}%
+               {\def\m at mscapi{#2}\caption[#2]{#3}}%
+  \ifx \@empty #1\else
+    \label{#1}%
+  \fi
+  \setlength{\abovecaptionskip}{0pt}%
+  \setlength{\belowcaptionskip}{0pt}%
+  \edef\@memtempc{#4}%
+  \expandafter\renewcommand\csname \@captype name\endcsname{\@memtempc}%
+  \addtocounter{\@captype}{-1}%
+  \@contmidbi
+  \@ifmtarg{#5}{\def\m at mscapii{#6}\caption{#6}}%
+               {\def\m at mscapii{#5}\caption[#5]{#6}}%
+  \membitwonumcaptioninfo{\@captype}{\@nameuse{the\@captype}}%
+                         {\m at mscapi}{#3}{#4}{\m at mscapii}{#6}%
+  \endgroup}
+
+\newcommand{\bionenumcaption}[6][\@empty]{%
+  \begingroup
+  \let\memcaptioninfo\@gobblefour
+  \@ifmtarg{#2}{\def\m at mscapi{#3}\caption{#3}}%
+               {\def\m at mscapi{#2}\caption[#2]{#3}}%
+  \ifx \@empty #1\else
+    \label{#1}%
+  \fi
+  \setlength{\abovecaptionskip}{0pt}%
+  \setlength{\belowcaptionskip}{0pt}%
+  \edef\@memtempc{#4}%
+  \expandafter\renewcommand\csname \@captype name\endcsname{\@memtempc}
+  \@contmidbi
+  \contcaption{#6}%
+  \@ifmtarg{#5}{%
+    \def\m at mscapii{#6}%
+    \addcontentsline{\csname ext@\@captype\endcsname}{\@captype}%
+      {\protect\numberline{}{\ignorespaces #6}}}{%
+    \def\m at mscapii{#5}%
+    \addcontentsline{\csname ext@\@captype\endcsname}{\@captype}%
+      {\protect\numberline{}{\ignorespaces #5}}}%
+  \membionenumcaptioninfo{\@captype}{\@nameuse{the\@captype}}%
+                         {\m at mscapi}{#3}{#4}{\m at mscapii}{#6}%
+  \endgroup}
+
+\newcommand{\bicaption}[5][\@empty]{%
+  \begingroup
+  \let\memcaptioninfo\@gobblefour
+  \@ifmtarg{#2}{\def\m at mscapi{#3}\caption{#3}}%
+               {\def\m at mscapi{#2}\caption[#2]{#3}}%
+  \ifx \@empty #1\else
+    \label{#1}%
+  \fi
+  \setlength{\abovecaptionskip}{0pt}%
+  \setlength{\belowcaptionskip}{0pt}%
+  \edef\@memtempc{#4}
+  \expandafter\renewcommand\csname \@captype name\endcsname{\@memtempc}%
+  \@contmidbi
+  \contcaption{#5}%
+  \membicaptioninfo{\@captype}{\@nameuse{the\@captype}}%
+                   {\m at mscapi}{#3}{#4}{#5}%
+  \endgroup}
+
+\newcommand{\bicontcaption}[3]{%
+  \begingroup
+  \contcaption{#1}%
+  \setlength{\abovecaptionskip}{0pt}%
+  \setlength{\belowcaptionskip}{0pt}%
+  \edef\@memtempc{#2}%
+  \expandafter\renewcommand\csname \@captype name\endcsname{\@memtempc}%
+  \@contmidbi
+  \contcaption{#3}%
+  \endgroup}
+
+\newcommand{\subcaptionstyle}[1]{\def\@contsubcstyle{#1}}
+\subcaptionstyle{}
+
+\newif\if at shortsubcap
+\newif\if at hangsubcap
+\newcommand*{\shortsubcaption}{\@shortsubcaptrue}
+\newcommand*{\hangsubcaption}{\@hangsubcaptrue}
+\newcommand*{\normalsubcaption}{\@shortsubcapfalse\@hangsubcapfalse}
+\normalsubcaption
+
+\newskip\subfloattopskip
+\newskip\subfloatcapskip
+\newskip\subfloatcaptopadj
+\newskip\subfloatbottomskip
+\newskip\subfloatlabelskip
+\newdimen\subfloatcapmargin
+\newif\if at tightsubcap
+\newcommand{\loosesubcaptions}{%
+  \subfloattopskip = 10\p@
+  \subfloatcapskip  = 10\p@
+  \subfloatcaptopadj = \z@
+  \subfloatbottomskip = 10\p@
+  \subfloatlabelskip = 0.33em
+  \subfloatcapmargin = 10\p@
+  \@tightsubcapfalse
+}
+
+\newcommand{\tightsubcaptions}{%
+  \subfloattopskip = 5\p@
+  \subfloatcapskip  = \z@
+  \subfloatcaptopadj = 3\p@
+  \subfloatbottomskip = 5\p@
+  \subfloatlabelskip = 0.33em \@plus 0.07em \@minus 0.03em
+  \subfloatcapmargin = \z@
+  \@tightsubcaptrue
+}
+\tightsubcaptions
+
+\newcommand*{\subcaptionsize}[1]{\def\@subcapsize{#1}}
+\newcommand*{\subcaptionlabelfont}[1]{\def\@subcaplabelfont{#1}}
+\newcommand*{\subcaptionfont}[1]{\def\@subcapfont{#1}}
+\subcaptionsize{\footnotesize}
+\subcaptionlabelfont{\normalfont}
+\subcaptionfont{\normalfont}
+
+  \newcounter{@contsubnum}
+  \newcommand{\@contkeep}{%
+    \setcounter{@contsubnum}{\value{sub\@captype}}}
+  \newcommand{\@contset}{%
+    \setcounter{sub\@captype}{\value{@contsubnum}}}
+  \newcommand{\subconcluded}{%
+    \setcounter{sub\@captype}{0}}
+\newif\if at contbotsub
+  \@contbotsubtrue
+
+\newcommand{\subcaption}{%
+  \bgroup
+    \let\label=\memsub at label
+    \ifdonemaincaption\else
+      \advance\csname c@\@captype\endcsname\@ne
+    \fi
+    \refstepcounter{sub\@captype}\@contkeep
+    \@ifnextchar [%
+      {\@memsubcap{sub\@captype}}%
+      {\@memsubcap{sub\@captype}[\@empty]}}
+\long\def\@memsubcap#1[#2]#3{%
+  \@tempdima=\hsize
+  \vskip\subfloatcapskip
+  \ifx \@empty #2
+    \@memsubcaption{#1}{#3}{#3}%
+  \else
+    \@memsubcaption{#1}{#2}{#3}%
+  \fi
+  \vskip\subfloatcapskip
+  \egroup}
+\newcommand{\@memsubcaption}[3]{%
+  \ifx \relax#2\relax \else
+    \bgroup
+      \let\label\@gobble
+      \let\protect\string
+      \def\@memsubcaplabel{\@nameuse{@@the#1}}%
+      \xdef\@memsubfigcaptionlist{%
+        \@memsubfigcaptionlist,%
+  {\protect\numberline{\@memsubcaplabel}\noexpand{\ignorespaces #2}}}%
+    \egroup
+  \fi
+  \@makesubfloatcaption{\@nameuse{@the#1}}{#3}}
+
+\newcommand{\contsubcaption}{%
+  \bgroup
+    \let\label=\memsub at label
+    \@contset
+    \refstepcounter{sub\@captype}\@contkeep
+    \@ifnextchar [%
+      {\@memsubcap{sub\@captype}}%
+      {\@memsubcap{sub\@captype}[\@empty]}}
+\newenvironment{subfloat}{}{}
+
+\newcommand{\subbottom}{%
+  \@contbotsubtrue
+  \@memsubbody}
+
+\newcommand{\@memsubbody}{%
+  \bgroup
+  \let\label=\memsub at label
+  \ifdonemaincaption\else
+    \advance\csname c@\@captype\endcsname\@ne
+  \fi
+  \refstepcounter{sub\@captype}\@contkeep%
+  \leavevmode
+  \@ifnextchar [%
+    {\@memsubfig}%
+    {\@memsubfig[\@empty]}}
+
+\newcommand{\contsubbottom}{%
+  \@contbotsubtrue
+  \@memcontsubbody}
+
+\newcommand{\@memcontsubbody}{%
+  \bgroup
+  \let\label=\memsub at label
+  \@contset
+  \refstepcounter{sub\@captype}\@contkeep%
+  \leavevmode
+  \@ifnextchar [%
+    {\@memsubfig}%
+    {\@memsubfig[\@empty]}}
+
+\newcommand{\subtop}{%
+  \@contbotsubfalse
+  \@memsubbody}
+
+\newcommand{\contsubtop}{%
+  \@contbotsubfalse
+  \@memcontsubbody}
+
+\def\@memsubfig[#1]{%
+  \@ifnextchar [%
+    {\@memsubfloat{sub\@captype}[#1]}%
+    {\@memsubfloat{sub\@captype}[\@empty #1][#1]}}
+
+\def\@memsubfloat#1[#2][#3]#4{%
+  \@tempcnta=\@ne
+  \if at tightsubcap
+    \if at minipage
+      \@tempcnta=\z@
+    \else
+      \ifdim\lastskip=\z@
+        \@tempcnta=\@ne
+      \else
+        \@tempcnta=\tw@
+      \fi
+    \fi
+  \fi
+  \if at contbotsub
+    \def\subfig at top{\subfloattopskip}%
+    \def\subfig at bottom{\subfloatbottomskip}%
+  \else
+    \def\subfig at top{\subfloatbottomskip}%
+    \def\subfig at bottom{\subfloattopskip}%
+  \fi
+  \setbox\@tempboxa \hbox{#4}%
+  \@tempdima=\wd\@tempboxa
+  \vtop\bgroup
+    \vbox\bgroup
+    \ifcase\@tempcnta
+      \@minipagefalse
+    \or
+      \vspace{\subfig at top}
+    \or
+      \ifdim \lastskip=\z@ \else
+        \@tempskipb\subfig at top\@xaddvskip
+      \fi
+    \fi
+    \if at contbotsub
+      \box\@tempboxa\egroup
+      \ifx \@empty#3\relax \else
+        \vskip\subfloatcapskip
+        \@memsubcaption{#1}{#2}{#3}%
+      \fi
+    \else
+      \ifx \@empty#3\relax \else
+        \@memsubcaption{#1}{#2}{#3}%
+        \vskip\subfloatcapskip
+        \vskip\subfloatcaptopadj
+      \fi\egroup
+      \box\@tempboxa
+    \fi
+    \vspace{\subfig at bottom}
+  \egroup
+\egroup}
+
+\newcommand*{\@memsubfigcaptionlist}{}
+\newcommand*{\memlistsubcaptions}{%
+  \@ifstar
+    {\gdef\@memsubfigcaptionlist{}}%
+    {\@memlistsubcaptions{\@captype}}}
+
+\newcommand*{\@memlistsubcaptions}[1]{%
+  \@ifundefined{@captype}{}{%
+    \@ifundefined{ext at sub#1}{}{%
+      \@for \@tempa:=\@memsubfigcaptionlist \do {%
+        \ifx \@empty\@tempa\relax \else
+          \addcontentsline{\@nameuse{ext at sub#1}}{sub#1}{\@tempa}%
+        \fi}}}%
+  \gdef\@memsubfigcaptionlist{}}
+
+\newcommand{\@makesubfloatcaption}[2]{%
+  \setbox\@tempboxa\hbox{%
+    \@subcapsize
+    {\@subcaplabelfont #1}{\@subcapfont\ignorespaces #2}}%
+  \@tempdimb=-\subfloatcapmargin
+  \multiply\@tempdimb\tw@
+  \advance\@tempdimb\@tempdima
+  \hb at xt@\@tempdima{%
+    \hss
+    \ifdim \wd\@tempboxa >\@tempdimb
+      \memsubfig at caption{#1}{#2}%
+    \else
+      \if at shortsubcap
+        \memsubfig at caption{#1}{#2}%
+      \else
+        \box\@tempboxa
+      \fi
+    \fi
+    \hss}}
+
+\newcommand{\memsubfig at caption}[2]{%
+  \if at hangsubcap
+    \sbox{\@tempboxa}{\@subcapsize\@subcaplabelfont #1}%
+    \addtolength{\@tempdimb}{-\wd\@tempboxa}%
+    \usebox{\@tempboxa}%
+    \memsubfig at captionpar{\@tempdimb}{%
+      {\@subcapfont\ignorespaces #2}}%
+  \else
+    \memsubfig at captionpar{\@tempdimb}{{\@subcaplabelfont #1}%
+      {\@subcapfont\ignorespaces #2}}%
+  \fi}
+
+\newcommand{\memsubfig at captionpar}[2]{%
+  \parbox[t]{#1}{\@subcapsize\@contsubcstyle #2}}
+
+\newcommand{\memsub at label}{%
+  \@ifnextchar (%
+    {\sf at memsub@label}%
+    {\sf at memsub@label(Sub\@captype\space
+                     \@nameuse{p at sub\@captype}%
+                     \@nameuse{thesub\@captype})}}
+\def\sf at memsub@label(#1)#2{%
+  \protected at edef\mem at currentlabelname{#1}%
+  \sf@@memsub at label{#2}}
+
+\AtBeginDocument{%
+  \@ifpackageloaded{nameref}{%
+    \newcommand*{\sf@@memsub at label}[1]{%
+      \@bsphack
+      \protected at write\@auxout{}{%
+        \string\newlabel{#1}%
+          {{\@nameuse{p at sub\@captype}\@nameuse{@@thesub\@captype}}%
+          {\thepage}%
+          {\mem at currentlabelname\relax}%
+          {\@currentHref}{}}}%
+      \protected at write\@auxout{}{%
+        \string\newlabel{sub@#1}%
+          {{\@nameuse{@@thesub\@captype}}%
+          {\thepage}%
+          {\mem at currentlabelname\relax}%
+          {\@currentHref}{}}}%
+  \@esphack}
+  }{\@ifpackageloaded{hyperref}{%
+    \newcommand*{\sf@@memsub at label}[1]{%
+      \@bsphack
+      \protected at write\@auxout{}{%
+        \string\newlabel{#1}%
+          {{\@nameuse{p at sub\@captype}\@nameuse{@@thesub\@captype}}%
+          {\thepage}%
+          {\mem at currentlabelname\relax}%
+          {\@currentHref}{}}}%
+      \protected at write\@auxout{}{%
+        \string\newlabel{sub@#1}%
+          {{\@nameuse{@@thesub\@captype}}%
+          {\thepage}%
+          {\mem at currentlabelname\relax}%
+          {\@currentHref}{}}}%
+  \@esphack}
+  }{%
+    \let\@memoldlabel\label
+    \newcommand*{\sf@@memsub at label}[1]{%
+      \@bsphack
+      \@memoldlabel{#1}%
+      \protected at write\@auxout{}{%
+        \string\newlabel{sub@#1}%
+          {{\@nameuse{@@thesub\@captype}}%
+          {\thepage}}}%
+  \@esphack}
+  }{}%
+  }
+}
+
+\newcommand*{\subcaptionref}{%
+  \@ifstar{\ssc at ref}{\sc at ref}}
+\newcommand*{\ssc at ref}[1]{\ref{sub@#1}}
+\newcommand*{\sc at ref}[1]{{\@subcaplabelfont\ref{sub@#1}}}
+
+\newsavebox{\m at mscap@capbox}
+\newsavebox{\m at mscap@fbox}
+
+\newdimen\sidecapsep
+  \sidecapsep=\marginparsep
+\newdimen\sidecapwidth
+  \sidecapwidth=\marginparwidth
+\newcommand*{\setsidecaps}[2]{%
+  \setlength{\sidecapsep}{#1}\@memznegtest{\sidecapsep}%
+  \setlength{\sidecapwidth}{#2}\@memznegtest{\sidecapwidth}}
+
+\newdimen\m at m@tempdima
+\newdimen\m at mscapraise
+\newdimen\sidecapraise
+  \sidecapraise \z@
+
+\newcommand*{\setsidecappos}[1]{%
+  \def\m at mscappos{#1}\def\@tempb{t}%
+  \ifx\@tempb\m at mscappos
+  \else
+    \def\@tempb{b}%
+    \ifx\@tempb\m at mscappos
+    \else
+      \def\@tempb{c}%
+      \ifx\@tempb\m at mscappos
+      \else
+        \@memerror{Argument to \string\setsidecappos\space is not t or c or b.
+                   \MessageBreak Set to c}{\@ehc}%
+        \def\m at mscappos{c}%
+      \fi
+    \fi
+  \fi}
+\setsidecappos{c}
+
+\newcommand{\sidecapmargin}[1]{%
+  \def\@tempa{#1}\def\@tempb{left}%
+    \ifx\@tempb\@tempa
+      \def\m at mscapmarg{0}%   left
+    \else
+      \def\@tempb{right}%
+      \ifx\@tempb\@tempa
+        \def\m at mscapmarg{1}%  right
+      \else
+        \def\@tempb{outer}%
+        \ifx\@tempb\@tempa
+          \def\m at mscapmarg{2}%  outer
+        \else
+          \def\@tempb{inner}%
+          \ifx\@tempb\@tempa
+            \def\m at mscapmarg{3}%  inner
+          \else
+            \@memerror{Unrecognized argument for \string\sidecapmargin}%
+                      {\@ehc}%
+            \def\m at mscapmarg{-1}% error
+          \fi
+        \fi
+      \fi
+    \fi}
+\sidecapmargin{left}
+
+\newif\ifscapmargleft
+
+\def\sidecapfloatwidth{\linewidth}
+\newdimen\m at mscapmainwidth
+
+\newdimen\m at mscaplkern
+\newcommand*{\setm at mscaplkern}{%
+  \m at mscaplkern=\sidecapwidth
+  \advance\m at mscaplkern \sidecapsep
+  \advance\m at mscaplkern \m at mscapmainwidth}
+
+\newcommand*{\sidecapstyle}{%
+%%%  \captionnamefont{\bfseries}%
+  \ifscapmargleft
+    \captionstyle{\raggedleft}%
+  \else
+    \captionstyle{\raggedright}%
+  \fi}
+
+\newcommand*{\sidecaption}{%
+  \@ifnextchar [{\@sidecaption}{\@sidecaption[]}}
+\def\@sidecaption[#1]#2{%
+  \@ifnextchar [{\@@sidecaption{#1}{#2}}{\@@sidecaption{#1}{#2}[]}}
+\newcommand\@mem at scap@beforehook{}
+\newcommand\@mem at scap@afterhook{}
+
+\def\@@sidecaption#1#2[#3]{%
+  \ifx\@empty#1\@empty
+    \def\m at mscap@fortoc{#2}%
+  \else
+    \def\m at mscap@fortoc{#1}%
+  \fi
+  \def\m at mscap@forcap{#2}%
+  \ifx\@empty#3\@empty
+    \def\m at mscaplabel{}%
+  \else
+    \def\m at mscaplabel{\@bsphack\label{#3}\@esphack}%
+  \fi
+  \m at mscapstart@fbox}
+
+\newcommand*{\m at mscapstart@fbox}{%
+  \@mem at scap@beforehook%
+  \setlength{\m at mscapmainwidth}{\sidecapfloatwidth}%
+  \setm at mscaplkern
+  \begin{lrbox}{\m at mscap@fbox}%
+    \begin{minipage}[c]{\m at mscapmainwidth}}
+\newcommand*{\m at mscapend@fbox}{%
+    \end{minipage}%
+  \end{lrbox}}
+
+\def\endsidecaption{%
+  \m at mscapend@fbox
+  \refstepcounter\@captype
+  \m at mscaplabel
+  \begin{lrbox}{\m at mscap@capbox}%
+    \begin{minipage}[c]{\sidecapwidth}%
+      \sidecapstyle
+      \@caption\@captype[\m at mscap@fortoc]{\m at mscap@forcap}
+    \end{minipage}%
+  \end{lrbox}%
+  \m at mscapopboxes}
+\newcommand*{\m at mscapopboxes}{%
+  \m at mcalcscapraise
+  \usebox{\m at mscap@fbox}\m at mscapcheckside
+  \ifscapmargleft%
+    \rlap{\kern-\m at mscaplkern
+          \raisebox{\m at mscapraise}{\usebox{\m at mscap@capbox}}}%
+  \else%
+    \rlap{\kern\sidecapsep
+          \raisebox{\m at mscapraise}{\usebox{\m at mscap@capbox}}}%
+  \fi
+  \gdef\m at mscapthisside{}%
+  \@mem at scap@afterhook%
+}
+
+\newcommand*{\m at mcalcscapraise}{%
+  \def\@tempb{t}%
+  \ifx\m at mscappos\@tempb
+    \settoheight{\m at m@tempdima}{\strut\usebox{\m at mscap@capbox}}%
+    \settoheight{\m at mscapraise}{\usebox{\m at mscap@fbox}}%
+    \advance\m at mscapraise -\m at m@tempdima
+    \advance\m at mscapraise  0.5ex
+  \else
+    \def\@tempb{b}%
+    \ifx\m at mscappos\@tempb
+      \settodepth{\m at m@tempdima}{\usebox{\m at mscap@fbox}}%
+      \settodepth{\m at mscapraise}{\strut\usebox{\m at mscap@capbox}}%
+      \advance\m at mscapraise -\m at m@tempdima
+    \else
+      \m at mscapraise=\z@
+      \advance\m at mscapraise 0.25ex
+    \fi
+  \fi
+  \advance\m at mscapraise  \sidecapraise}
+
+\newcommand*{\m at mscapcheckside}{%
+  \if at twocolumn
+    \ifdim\hsize=\textwidth%  float*
+      \m at mscapcheckregside
+    \else
+      \if at firstcolumn
+        \scapmarglefttrue
+      \else
+        \scapmargleftfalse
+      \fi
+    \fi
+  \else
+    \m at mscapcheckregside
+  \fi
+  \m at mscapthisside}
+\newcommand*{\m at mscapcheckregside}{%
+    \if at twoside
+      \checkoddpage
+      \ifnum\m at mscapmarg<\@ne%      % left
+        \scapmarglefttrue
+      \else
+        \ifnum\m at mscapmarg=\@ne%    % right
+          \scapmargleftfalse
+        \else
+          \ifnum\m at mscapmarg=\tw@%  % outer
+            \scapmarglefttrue
+            \ifoddpage
+              \scapmargleftfalse
+            \fi
+          \else%                  % inner
+            \scapmargleftfalse
+            \ifoddpage
+              \scapmarglefttrue
+            \fi
+          \fi
+        \fi
+      \fi
+    \else%     oneside
+      \scapmarglefttrue
+      \ifnum\m at mscapmarg>\@ne
+        \ifnum\m at mscapmarg<\thr@@
+          \scapmargleftfalse
+        \fi
+      \fi
+    \fi}
+
+\newcommand*{\overridescapmargin}[1]{%
+  \def\@tempb{#1}\def\@tempa{left}%
+  \ifx\@tempa\@tempb
+    \def\m at mscapthisside{\scapmarglefttrue}%
+  \else
+    \def\@tempa{right}%
+    \ifx\@tempa\@tempb
+      \def\m at mscapthisside{\scapmargleftfalse}%
+    \else
+      \@memerror{Argument to \string\overridescapmargin\space neither
+                 left nor right}{\@ehc}%
+      \def\m at mscapthisside{}%
+    \fi
+  \fi}
+\newcommand*{\m at mscapthisside}{}
+
+\newcommand*{\sidecontcaption}{%
+  \@sidecontcaption}
+\def\@sidecontcaption#1{%
+  \@ifnextchar [{\@@sidecontcaption{#1}}{\@@sidecontcaption{#1}[]}}
+\def\@@sidecontcaption#1[#2]{%
+  \def\m at mscap@forcap{#1}%
+  \ifx\@empty#2\@empty
+    \def\m at mscaplabel{}%
+  \else
+    \def\m at mscaplabel{\@bsphack\label{#2}\@esphack}%
+  \fi
+  \m at mscapstart@fbox}
+
+\def\endsidecontcaption{%
+  \m at mscapend@fbox
+  \addtocounter{\@captype}{\m at ne}\refstepcounter\@captype
+  \m at mscaplabel
+  \begin{lrbox}{\m at mscap@capbox}%
+    \begin{minipage}[c]{\sidecapwidth}%
+      \sidecapstyle
+      \@contcaption\@captype{\m at mscap@forcap}
+    \end{minipage}%
+  \end{lrbox}%
+  \m at mscapopboxes}
+
+\newcommand*{\sidenamedlegend}{%
+  \@ifnextchar [{\@sidenamedlegend}{\@sidenamedlegend[]}}
+\def\@sidenamedlegend[#1]#2{%
+  \@@sidenamedlegend{#1}{#2}}
+\def\@@sidenamedlegend#1#2{%
+  \ifx\@empty#1\@empty
+    \def\m at mscap@fortoc{#2}%
+  \else
+    \def\m at mscap@fortoc{#1}%
+  \fi
+  \def\m at mscap@forcap{#2}%
+  \def\m at mscaplabel{}%
+  \m at mscapstart@fbox}
+
+\def\endsidenamedlegend{%
+  \m at mscapend@fbox
+  \begin{lrbox}{\m at mscap@capbox}%
+    \begin{minipage}[c]{\sidecapwidth}%
+      \sidecapstyle
+      \@legend\@captype[\m at mscap@fortoc]{\m at mscap@forcap}
+    \end{minipage}%
+  \end{lrbox}%
+  \m at mscapopboxes}
+
+\newcommand*{\sidelegend}{%
+  \@@sidelegend}
+\def\@@sidelegend#1{%
+  \def\m at mscap@forcap{#1}%
+  \m at mscapstart@fbox}
+
+\def\endsidelegend{%
+  \m at mscapend@fbox
+  \begin{lrbox}{\m at mscap@capbox}%
+    \begin{minipage}[c]{\sidecapwidth}%
+      \sidecapstyle
+      \legend{\m at mscap@forcap}
+    \end{minipage}%
+  \end{lrbox}%
+  \m at mscapopboxes}
+
+\newlength{\beforeepigraphskip}
+  \setlength{\beforeepigraphskip}{.5\baselineskip}
+\newlength{\afterepigraphskip}
+  \setlength{\afterepigraphskip}{.5\baselineskip}
+\newlength{\epigraphwidth}
+  \setlength{\epigraphwidth}{.4\textwidth}
+\newlength{\epigraphrule}
+  \setlength{\epigraphrule}{.4\p@}
+\newcommand{\epigraphsize}{\small}
+\newcommand{\epigraphflush}{flushright}
+\newcommand{\textflush}{flushleft}
+\newcommand{\sourceflush}{flushright}
+\newcommand{\epigraphfontsize}[1]{\def\epigraphsize{#1}}
+\newcommand{\epigraphposition}[1]{\long\def\epigraphflush{#1}}
+\newcommand{\epigraphtextposition}[1]{\def\textflush{#1}}
+\newcommand{\epigraphsourceposition}[1]{\def\sourceflush{#1}}
+
+\newcommand{\@epirule}{\rule[.5ex]{\epigraphwidth}{\epigraphrule}}
+\newcommand{\@epitext}[1]{%
+  \begin{minipage}{\epigraphwidth}\begin{\textflush} #1\par
+    \ifdim\epigraphrule>\z@ \@epirule \else \vspace*{1ex} \fi
+  \end{\textflush}\end{minipage}}
+\newcommand{\@episource}[1]{%
+  \begin{minipage}{\epigraphwidth}
+    \begin{\sourceflush} #1\par
+  \end{\sourceflush}\end{minipage}}
+
+\newcommand{\epigraph}[2]{\vspace{\beforeepigraphskip}
+  {\epigraphsize\begin{\epigraphflush}\begin{minipage}{\epigraphwidth}
+    \@epitext{#1}\\ \@episource{#2}
+    \end{minipage}\end{\epigraphflush}
+    \vspace{\afterepigraphskip}}}
+\newcommand{\qitem}[2]{{%
+  \raggedright\item \begin{minipage}{\epigraphwidth}
+    \@epitext{#1}\\ \@episource{#2}
+  \end{minipage}}}
+\newcommand{\qitemlabel}[1]{\hfill}
+\newenvironment{epigraphs}{%
+  \vspace{\beforeepigraphskip}\begin{\epigraphflush}
+  \epigraphsize
+  \begin{minipage}{\epigraphwidth}
+   \list{}%
+    {\itemindent\z@ \labelwidth\z@ \labelsep\z@
+     \leftmargin\z@ \rightmargin\z@
+     \let\makelabel\qitemlabel}}%
+  {\endlist\end{minipage}\end{\epigraphflush}
+   \vspace{\afterepigraphskip}}
+\newcommand{\dropchapter}[1]{%
+  \let\@epichapapp\@chapapp
+  \renewcommand{\@chapapp}{\vspace*{#1}\@epichapapp}}
+\newcommand{\undodrop}{\let\@chapapp\@epichapapp}
+\newif\if at epirhs     \@epirhstrue
+\newif\if at epicenter  \@epicentertrue
+\newcommand{\@epipos}{
+  \long\def\@ept{flushleft}
+  \ifx\epigraphflush\@ept
+    \@epirhsfalse \@epicenterfalse
+  \else
+    \long\def\@ept{center}
+    \ifx\epigraphflush\@ept
+      \@epirhsfalse \@epicentertrue
+    \else
+      \@epirhstrue  \@epicenterfalse
+    \fi
+  \fi}
+\newcommand{\epigraphhead}[2][95]{%
+  \def\@epitemp{\begin{minipage}{\epigraphwidth}#2\end{minipage}}
+  \def\ps at epigraph{\let\@mkboth\@gobbletwo
+    \@epipos
+    \if at epirhs
+      \def\@oddhead{\hfil\begin{picture}(0,0)
+                         \put(0,-#1){\makebox(0,0)[r]{\@epitemp}}
+                         \end{picture}}
+    \else
+      \if at epicenter
+        \def\@oddhead{\hfil\begin{picture}(0,0)
+                           \put(0,-#1){\makebox(0,0)[b]{\@epitemp}}
+                           \end{picture}\hfil}
+      \else
+        \def\@oddhead{\begin{picture}(0,0)
+                           \put(0,-#1){\makebox(0,0)[l]{\@epitemp}}
+                           \end{picture}\hfil}
+      \fi
+    \fi
+    \let\@evenhead\@oddhead
+    \def\@oddfoot{\reset at font\hfil\thepage\hfil}
+    \let\@evenfoot\@oddfoot}
+  \thispagestyle{epigraph}}
+
+\newcommand{\the at epigraph}{}
+\newcommand{\@epidrop}{95}
+\newcommand{\epigraphforheader}[2][95]{%
+  \def\@epidrop{#1}\long\def\the at epigraph{#2}}
+
+\newcommand{\epigraphpicture}{%
+  \def\@epitemp{%
+    \begin{minipage}{\epigraphwidth}\the at epigraph\end{minipage}}%
+  \@epipos
+  \if at epirhs
+    \begin{picture}(0,0)%
+      \put(0,-\@epidrop){\makebox(0,0)[r]{\@epitemp}}%
+    \end{picture}%
+  \else
+    \if at epicenter
+      \begin{picture}(0,0)%
+        \put(0,-\@epidrop){\makebox(0,0)[b]{\@epitemp}}%
+      \end{picture}%
+    \else
+      \begin{picture}(0,0)%
+        \put(0,-\@epidrop){\makebox(0,0)[l]{\@epitemp}}%
+      \end{picture}%
+    \fi
+  \fi}
+
+\newcommand*{\@memoldfonterr}[3]{%
+  \@memerror{Font command \protect#1\space is not supported}{%
+    Use \protect#2, or \protect#3{...}, or the oldfontcommands option}}
+\newcommand*{\@memoldfontwarn}[3]{%
+  \@memwarn{The \protect#1\space font command is deprecated.
+    \MessageBreak Use \protect#2{...} or {\protect#3... } instead}}
+
+\if at memoldfont
+  \def\@mem at rmwarn{\@memoldfontwarn{\rm}{\textrm}{\rmfamily}}
+  \DeclareOldFontCommand{\rm}{\@mem at rmwarn\gdef\@mem at rmwarn{}%
+    \normalfont\rmfamily}{\mathrm}
+\else
+  \def\rm{\@memoldfonterr{\rm}{\textrm}{\rmfamily}}
+\fi
+
+\if at memoldfont
+  \def\@mem at sfwarn{\@memoldfontwarn{\sf}{\textsf}{\sffamily}}
+  \DeclareOldFontCommand{\sf}{\@mem at sfwarn\gdef\@mem at sfwarn{}%
+    \normalfont\sffamily}{\mathsf}
+\else
+  \def\sf{\@memoldfonterr{\sf}{\textsf}{\sffamily}}
+\fi
+
+\if at memoldfont
+  \def\@mem at ttwarn{\@memoldfontwarn{\tt}{\texttt}{\ttfamily}}
+  \DeclareOldFontCommand{\tt}{\@mem at ttwarn\gdef\@mem at ttwarn{}%
+    \normalfont\ttfamily}{\mathtt}
+\else
+  \def\tt{\@memoldfonterr{\tt}{\texttt}{\ttfamily}}
+\fi
+
+\if at memoldfont
+  \def\@mem at bfwarn{\@memoldfontwarn{\bf}{\textbf}{\bfseries}}
+  \DeclareOldFontCommand{\bf}{\@mem at bfwarn\gdef\@mem at bfwarn{}%
+    \normalfont\bfseries}{\mathbf}
+\else
+  \def\bf{\@memoldfonterr{\bf}{\textbf}{\bfseries}}
+\fi
+
+\if at memoldfont
+  \def\@mem at itwarn{\@memoldfontwarn{\it}{\textit}{\itshape}}
+  \DeclareOldFontCommand{\it}{\@mem at itwarn\gdef\@mem at itwarn{}%
+    \normalfont\itshape}{\mathit}
+\else
+  \def\it{\@memoldfonterr{\it}{\textit}{\itshape}}
+\fi
+
+\if at memoldfont
+  \def\@mem at slwarn{\@memoldfontwarn{\sl}{\textsl}{\slshape}}
+  \DeclareOldFontCommand{\sl}{\@mem at slwarn\gdef\@mem at slwarn{}%
+    \normalfont\slshape}{\@nomath\sl}
+\else
+  \def\sl{\@memoldfonterr{\sl}{\textsl}{\slshape}}
+\fi
+
+\if at memoldfont
+  \def\@mem at scwarn{\@memoldfontwarn{\sc}{\textsc}{\scshape}}
+  \DeclareOldFontCommand{\sc}{\@mem at scwarn\gdef\@mem at scwarn{}%
+    \normalfont\scshape}{\@nomath\sc}
+\else
+  \def\sc{\@memoldfonterr{\sc}{\textsc}{\scshape}}
+\fi
+
+\if at memoldfont
+  \def\@mem at calwarn{%
+    \@memwarn{The \protect\cal\space font command is deprecated.
+    \MessageBreak Try to use \protect\mathcal\space instead}}
+  \DeclareRobustCommand*\cal{\@mem at calwarn\gdef\@mem at calwarn{}%
+    \@fontswitch\relax\mathcal}
+\else
+  \def\cal{%
+    \@memerror{Font command \protect\cal\space is not supported}{%
+    Use \protect\mathcal, or the oldfontcommands option}}
+\fi
+
+\if at memoldfont
+  \def\@mem at mitwarn{%
+    \@memwarn{The \protect\mit\space font command is deprecated.
+    \MessageBreak Try to use \protect\mathnormal\space instead}}
+  \DeclareRobustCommand*\mit{\@mem at mitwarn\gdef\@mem at mitwarn{}%
+    \@fontswitch\relax\mathnormal}
+\else
+  \def\mit{%
+  \@memerror{Font command \protect\mit\space is not supported}{%
+             Use \protect\mathnormal, or the oldfontcommands option}}
+\fi
+
+\DeclareRobustCommand{\em}{%
+  \@nomath\em
+  \ifdim\fontdimen\@ne\font > \z@
+    \eminnershape
+  \else
+    \itshape
+  \fi}
+\providecommand{\eminnershape}{\upshape}
+\DeclareTextFontCommand{\emph}{\em}
+
+\newcommand*{\fref}[1]{\figurerefname~\ref{#1}}
+\newcommand*{\tref}[1]{\tablerefname~\ref{#1}}
+\newcommand*{\pref}[1]{\pagerefname~\pageref{#1}}
+\newcommand*{\Aref}[1]{\appendixrefname\ref{#1}}
+\newcommand*{\Bref}[1]{\bookrefname\ref{#1}}
+\newcommand*{\Pref}[1]{\partrefname\ref{#1}}
+\newcommand*{\Cref}[1]{\chapterrefname\ref{#1}}
+\newcommand*{\Sref}[1]{\sectionrefname\ref{#1}}
+
+\newif\ifheadnameref
+\newcommand*{\headnameref}{\headnamereftrue}
+\newcommand*{\tocnameref}{\headnamereffalse}
+  \tocnameref
+\newcommand{\theTitleReference}[2]{#2}
+
+\let\@mem at old@label\label
+\def\label#1{\@bsphack\begingroup
+  \protected at edef\@currentlabel{\protect\M at TitleReference
+      {\@currentlabel}{\M at currentTitle}}%
+  \@mem at old@label{#1}%
+  \endgroup \@esphack}%
+
+\def\@mem@@gettitle#1{\begingroup \let\protect\@unexpandable at protect
+    \let\label\@mem at nestwarn
+    \let\index\@gobble \let\glossary\@gobble
+    \let\markboth\@gobbletwo \let\@mkboth\@gobbletwo
+    \let\markright\@gobble
+    \edef\@tempa{\noexpand\def\noexpand\M at currentTitle{#1}}%
+  \expandafter\endgroup\@tempa}
+
+\let\@mem at nestwarn\@gobble
+\let\M at TitleReference\@firstoftwo
+
+\newcommand*\@mem at titleref[1]{\begingroup
+  \let\numberline\@gobble
+  \let\M at TitleReference\@mem at theTR % interrupt recursion of \ref
+  \ref{#1}\endgroup}
+\let\@mem at titlerefnolink\@mem at titleref
+
+\DeclareRobustCommand\titleref{\@ifstar{\@mem at titlerefnolink}{\@mem at titleref}}
+
+\DeclareRobustCommand{\currenttitle}{\begingroup
+  \let\numberline\@gobble
+  \theTitleReference\@currentlabel\M at currentTitle\endgroup}
+
+\let\M at currentTitle\@empty
+
+\def\@mem at theTR{\let\M at TitleReference\@firstoftwo \theTitleReference}
+
+\newcommand*{\namerefon}{\let\M at gettitle\@mem@@gettitle}
+\newcommand*{\namerefoff}{\let\M at gettitle\@gobble}
+  \namerefon
+\newcommand{\@pnumwidth}{1.55em}
+\newcommand{\@tocrmarg} {2.55em}
+\newcommand{\@dotsep}{4.5}
+\newlength{\tocentryskip} \setlength{\tocentryskip}{1em}
+\newlength{\tocbaseline} \setlength{\tocbaseline}{20pt}
+\newcommand{\tocskip}[1]{%
+    \addtocontents{toc}{\protect\vspace{#1}}}
+\newcommand*{\ensureonecol}{%
+  \if at twocolumn
+    \@restonecoltrue\onecolumn
+  \else
+    \@restonecolfalse
+  \fi}
+\newcommand*{\restorefromonecol}{\if at restonecol\twocolumn\fi}
+
+\newlength{\cftparskip}
+\setlength{\cftparskip}{0pt}
+
+\newcommand{\newlistof}[3]{%
+  \@namedef{ext@#2}{#2}
+  \@ifundefined{c@#2depth}{\newcounter{#2depth}}{}
+  \setcounter{#2depth}{1}
+  \@namedef{#2mark}{\markboth{#3}{#3}}
+  \@namedef{#1}{\@ifstar{\@nameuse{@star#2}}{\@nameuse{@plain#2}}}
+  \@namedef{@star#2}{%
+    \ensureonecol
+    \par
+    \begingroup
+%%%      \parindent\z@ \parskip\cftparskip
+      \@nameuse{@#2maketitle}
+\parskip\cftparskip
+      \@starttoc{#2}%
+    \endgroup
+    \restorefromonecol}
+  \@namedef{@plain#2}{%
+    \ensureonecol
+    \par
+    \begingroup
+%%%      \parindent\z@ \parskip\cftparskip
+      \@nameuse{@#2maketitle}
+      \phantomsection
+      \addcontentsline{toc}{chapter}{#3}
+\parskip\cftparskip
+      \@starttoc{#2}%
+    \endgroup
+    \restorefromonecol}
+  \@namedef{@#2maketitle}{%
+    \@nameuse{#2headstart}
+   {\parindent\z@
+%%%%  \parskip\cftparskip
+    \interlinepenalty\@M
+    \@nameuse{print#2nonum}%
+    \@nameuse{print#2title}{#3}%
+    \@nameuse{#2mark}%
+    \thispagestyle{chapter}%
+    \@nameuse{after#2title}
+   }
+    \@afterheading}
+  \@namedef{#2headstart}{\chapterheadstart}
+  \@namedef{after#2title}{\afterchaptertitle}
+  \@namedef{print#2nonum}{\printchapternonum}
+  \@namedef{print#2title}##1{\printchaptertitle{##1}}
+} % end \newlistof
+
+\renewcommand{\@starttoc}[1]{%
+  \begingroup\makeatletter
+    \@input{\jobname.#1}%
+    \if at filesw
+      \AtEndDocument{%
+        \expandafter\newwrite\csname tf@#1\endcsname
+        \immediate\openout \csname tf@#1\endcsname \jobname.#1\relax
+      }%
+    \fi
+  \@nobreakfalse
+  \endgroup}
+
+\newlistof{tableofcontents}{toc}{\contentsname}
+\newcommand*{\setpnumwidth}[1]{\renewcommand{\@pnumwidth}{#1}}
+\newcommand*{\setrmarg}[1]{\renewcommand{\@tocrmarg}{#1}}
+\providecommand{\cftdot}{.}
+\providecommand{\cftdotfill}[1]{%
+  \leaders\hbox{$\m at th\mkern #1 mu\hbox{\cftdot}\mkern #1 mu$}\hfill}
+\providecommand{\cftdotsep}{4.5}
+\newcommand{\cftnodots}{2000}
+\newcommand*{\cftparfillskip}{\parfillskip=0pt plus1fil}
+\newcommand*{\@cftn at me}{}
+
+\renewcommand*{\numberline}[1]{%
+  \hb at xt@\@tempdima{\@cftn at me\@cftbsnum #1\@cftasnum\hfil}\@cftasnumb}
+\newcommand{\@cftbsnum}{}
+\newcommand{\@cftasnum}{}
+\newcommand{\@cftasnumb}{}
+\newcommand{\newlistentry}[4][\@empty]{%
+  \@ifundefined{c@#2}{%    check & set the counter
+    \ifx \@empty#1\relax
+      \newcounter{#2}
+    \else
+      \newcounter{#2}[#1]%
+      \expandafter\edef\csname the#2\endcsname{%
+  \expandafter\noexpand\csname the#1\endcsname.\noexpand\arabic{#2}}
+    \fi}{}
+  \setcounter{#2}{0}
+  \@namedef{l@#2}##1##2{%
+    \ifnum \@nameuse{c@#3depth} > #4\relax
+      \vskip \@nameuse{cftbefore#2skip}
+      {\if at RTL\rightskip\else\leftskip\fi \@nameuse{cft#2indent}\relax
+       \if at RTL\leftskip\else\rightskip\fi \@tocrmarg
+       \parfillskip -\if at RTL\leftskip\else\rightskip\fi
+       \parindent \@nameuse{cft#2indent}\relax\@afterindenttrue
+       \interlinepenalty\@M
+       \leavevmode
+       \settowidth{\@tempdima}{\@nameuse{cft#2font}\@nameuse{cft#2name}}%
+       \addtolength{\@tempdima}{\@nameuse{cft#2numwidth}}%
+ \expandafter\let\expandafter\@cftbsnum\csname cft#2presnum\endcsname
+ \expandafter\let\expandafter\@cftasnum\csname cft#2aftersnum\endcsname
+ \expandafter\let\expandafter\@cftasnumb\csname cft#2aftersnumb\endcsname
+ \expandafter\let\expandafter\@cftn at me\csname cft#2name\endcsname
+       \advance\if at RTL\rightskip\else\leftskip\fi\@tempdima \null\nobreak\hskip -\if at RTL\rightskip\else\leftskip\fi
+       {\@nameuse{cft#2font}##1}\nobreak
+       \@nameuse{cft#2fillnum}{##2}}
+    \fi
+  }  % end of \l@#2
+
+  \expandafter\newlength\csname cftbefore#2skip\endcsname
+    \setlength{\@nameuse{cftbefore#2skip}}{\z@ \@plus .2\p@}
+  \expandafter\newlength\csname cft#2indent\endcsname
+  \expandafter\newlength\csname cft#2numwidth\endcsname
+  \ifcase #4\relax  % 0   (level 1)
+    \setlength{\@nameuse{cft#2indent}}{0em}
+    \setlength{\@nameuse{cft#2numwidth}}{2.3em}
+  \or               % 1   (level 2)
+    \setlength{\@nameuse{cft#2indent}}{2.3em}
+    \setlength{\@nameuse{cft#2numwidth}}{3.2em}
+  \or               % 2   (level 3)
+    \setlength{\@nameuse{cft#2indent}}{5.5em}
+    \setlength{\@nameuse{cft#2numwidth}}{4.1em}
+  \or               % 3   (level 4)
+    \setlength{\@nameuse{cft#2indent}}{8.5em}
+    \setlength{\@nameuse{cft#2numwidth}}{5.0em}
+  \else             % anything else
+    \setlength{\@nameuse{cft#2indent}}{10.5em}
+    \setlength{\@nameuse{cft#2numwidth}}{6.0em}
+  \fi
+  \@namedef{cft#2font}{\normalfont}
+  \@namedef{cft#2name}{}
+  \@namedef{cft#2presnum}{}
+  \@namedef{cft#2aftersnum}{}
+  \@namedef{cft#2aftersnumb}{}
+  \@namedef{cft#2dotsep}{\cftdotsep}
+  \@namedef{cft#2leader}{\normalfont\cftdotfill{\@nameuse{cft#2dotsep}}}
+  \@namedef{cft#2pagefont}{\normalfont}
+  \@namedef{cft#2afterpnum}{}
+  \@namedef{toclevel@#2}{#4}
+  \@namedef{cft#2formatpnum}##1{%
+    \hb at xt@\@pnumwidth{\hfil\@nameuse{cft#2pagefont}##1}}
+  \@namedef{cft#2fillnum}##1{%
+    {\@nameuse{cft#2leader}}\nobreak
+%%%    \hb at xt@\@pnumwidth{%
+%%%      \hfil\@nameuse{cft#2pagefont}##1}
+       \@nameuse{cft#2formatpnum}{##1}%
+       \@nameuse{cft#2afterpnum}\par}
+} % end \newlistentry
+
+\newcommand*{\cftsetindents}[3]{%
+  \setlength{\@nameuse{cft#1indent}}{#2}
+  \setlength{\@nameuse{cft#1numwidth}}{#3}}
+
+\newcommand*{\cftbookname}{}
+
+\newcommand*{\cftbookbreak}{\addpenalty{-\@highpenalty}%
+  \addvspace{\cftbeforebookskip}}
+\newcommand*{\l at book}[2]{%
+  \ifnum\c at tocdepth >-3\relax
+%%    \addpenalty{-\@highpenalty}%
+    \cftbookbreak
+%%    \addvspace{\cftbeforebookskip}%
+    \begingroup
+      {\if at RTL\rightskip\else\leftskip\fi \cftbookindent\relax
+       \if at RTL\leftskip\else\rightskip\fi \@tocrmarg
+       \parfillskip -\if at RTL\leftskip\else\rightskip\fi
+       \parindent \cftbookindent\relax\@afterindenttrue
+       \interlinepenalty\@M
+       \leavevmode
+       \settowidth{\@tempdima}{\cftbookfont\cftbookname}%
+       \addtolength{\@tempdima}{\cftbooknumwidth}%
+       \let\@cftbsnum \cftbookpresnum
+       \let\@cftasnum \cftbookaftersnum
+       \let\@cftasnumb \cftbookaftersnumb
+       \advance\if at RTL\rightskip\else\leftskip\fi \@tempdima \null\nobreak\hskip -\if at RTL\rightskip\else\leftskip\fi
+       {\cftbookfont #1}%
+       \cftbookfillnum{#2}}
+      \nobreak
+      \global\@nobreaktrue
+      \everypar{\global\@nobreakfalse\everypar{}}%
+    \endgroup
+  \fi}
+\newcommand{\booknumberline}[1]{%
+  \hb at xt@\@tempdima{%
+    \cftbookname\@cftbsnum #1\@cftasnum\hfil}\@cftasnumb}%%\space}
+
+\newlength{\cftbeforebookskip}
+  \setlength{\cftbeforebookskip}{2.25em \@plus\p@}
+\newdimen\cftbookindent
+  \setlength{\cftbookindent}{0em}
+\newdimen\cftbooknumwidth
+  \setlength{\cftbooknumwidth}{1.5em}
+\newcommand*{\cftbookfont}{\large\bfseries}
+\newcommand*{\cftbookpresnum}{}
+\newcommand*{\cftbookaftersnum}{}
+\newcommand*{\cftbookaftersnumb}{}
+\newcommand*{\cftbookleader}{%
+  \large\bfseries\cftdotfill{\cftbookdotsep}}
+\newcommand*{\cftbookdotsep}{\cftnodots}
+\newcommand*{\cftbookpagefont}{\large\bfseries}
+\newcommand{\cftbookafterpnum}{}
+\newcommand{\cftbookfillnum}[1]{%
+  {\cftbookleader}%
+%%%%  {\hb at xt@\@pnumwidth{\hss {\cftbookpagefont #1}}}%
+  \cftbookformatpnum{#1}%
+  \cftbookafterpnum\par}
+\newcommand{\cftbookformatpnum}[1]{%
+  \hb at xt@\@pnumwidth{\hss {\cftbookpagefont #1}}}
+
+\newcommand*{\cftpartname}{}
+
+\newcommand*{\cftpartbreak}{\addpenalty{-\@highpenalty}%
+  \addvspace{\cftbeforepartskip}}
+\newcommand*{\l at part}[2]{%
+  \ifnum \c at tocdepth >-2\relax
+%%%    \addpenalty{-\@highpenalty}%
+%%%    \addvspace{\cftbeforepartskip}%
+    \cftpartbreak
+    \begingroup
+      {\if at RTL\rightskip\else\leftskip\fi \cftpartindent\relax
+       \if at RTL\leftskip\else\rightskip\fi \@tocrmarg
+       \parfillskip -\if at RTL\leftskip\else\rightskip\fi
+       \parindent \cftpartindent\relax\@afterindenttrue
+       \interlinepenalty\@M
+       \leavevmode
+       \settowidth{\@tempdima}{\cftpartfont\cftpartname}%
+       \addtolength{\@tempdima}{\cftpartnumwidth}%
+       \let\@cftbsnum \cftpartpresnum
+       \let\@cftasnum \cftpartaftersnum
+       \let\@cftasnumb \cftpartaftersnumb
+       \advance\if at RTL\rightskip\else\leftskip\fi \@tempdima \null\nobreak\hskip -\if at RTL\rightskip\else\leftskip\fi
+       {\cftpartfont #1}%
+       \cftpartfillnum{#2}}
+      \nobreak
+        \global\@nobreaktrue
+        \everypar{\global\@nobreakfalse\everypar{}}%
+    \endgroup
+  \fi}
+
+\newcommand*{\toclevel at part}{-1}
+
+\newcommand{\partnumberline}[1]{%
+  \hb at xt@\@tempdima{%
+    \cftpartname\@cftbsnum #1\@cftasnum\hfil}\@cftasnumb}%%\space}
+
+  \newlength{\cftbeforepartskip}
+    \setlength{\cftbeforepartskip}{2.25em \@plus\p@}
+  \newlength{\cftpartindent}
+    \setlength{\cftpartindent}{0em}
+  \newlength{\cftpartnumwidth}
+    \setlength{\cftpartnumwidth}{1.5em}
+  \newcommand{\cftpartfont}{\large\bfseries}
+  \newcommand{\cftpartpresnum}{}
+  \newcommand{\cftpartaftersnum}{}
+  \newcommand{\cftpartaftersnumb}{}
+  \newcommand{\cftpartleader}{%
+              \large\bfseries\cftdotfill{\cftpartdotsep}}
+  \newcommand{\cftpartdotsep}{\cftnodots}
+  \newcommand{\cftpartpagefont}{\large\bfseries}
+  \newcommand{\cftpartafterpnum}{}
+  \newcommand*{\cftpartformatpnum}[1]{%
+    \hb at xt@\@pnumwidth{\hss {\cftpartpagefont #1}}}
+  \newcommand{\cftpartfillnum}[1]{%
+    {\cftpartleader}%
+    {\cftpartformatpnum{#1}}%
+     \cftpartafterpnum\par}
+
+\newcommand*{\cftchaptername}{}
+
+\newcommand*{\l at chapapp}[3]{%
+  \ifnum \c at tocdepth >\m at ne
+    \cftchapterbreak
+    \vskip \cftbeforechapterskip
+    {\if at RTL\rightskip\else\leftskip\fi \cftchapterindent\relax
+     \if at RTL\leftskip\else\rightskip\fi \@tocrmarg
+     \parfillskip -\if at RTL\leftskip\else\rightskip\fi
+     \parindent \cftchapterindent\relax
+     \@afterindenttrue
+     \interlinepenalty\@M
+     \leavevmode
+     \let\@cftbsnum \cftchapterpresnum
+     \let\@cftasnum \cftchapteraftersnum
+     \let\@cftasnumb \cftchapteraftersnumb
+     \def\@chapapp at head{#3}%
+     \settowidth{\@tempdima}{\cftchapterfont\@chapapp at head}%
+     \addtolength{\@tempdima}{\cftchapternumwidth}%
+     \advance\if at RTL\rightskip\else\leftskip\fi \@tempdima \null\nobreak\hskip -\if at RTL\rightskip\else\leftskip\fi
+     {\cftchapterfont #1}\nobreak
+     \cftchapterfillnum{#2}}
+  \fi}
+
+\newcommand*{\l at chapter}[2]{%
+  \l at chapapp{#1}{#2}{\cftchaptername}}
+
+\newcommand*{\toclevel at chapter}{0}
+
+\newcommand*{\cftappendixname}{}
+
+\newcommand*{\l at appendix}[2]{%
+  \l at chapapp{#1}{#2}{\cftappendixname}}
+\newcommand{\toclevel at appendix}{0}
+
+\newcommand{\chapternumberline}[1]{%
+  \hb at xt@\@tempdima{\@chapapp at head\@cftbsnum #1\@cftasnum\hfil}%
+  \@cftasnumb}
+
+  \newlength{\cftbeforechapterskip}
+    \setlength{\cftbeforechapterskip}{1.0em \@plus\p@}
+  \newlength{\cftchapterindent}
+    \setlength{\cftchapterindent}{0em}
+  \newlength{\cftchapternumwidth}
+    \setlength{\cftchapternumwidth}{1.5em}
+  \newcommand{\cftchapterfont}{\bfseries}
+  \newcommand{\cftchapterpresnum}{}
+  \newcommand{\cftchapteraftersnum}{}
+  \newcommand{\cftchapteraftersnumb}{}
+  \newcommand{\cftchapterleader}{%
+              \bfseries\cftdotfill{\cftchapterdotsep}}
+  \newcommand{\cftchapterdotsep}{\cftnodots}
+  \newcommand{\cftchapterpagefont}{\bfseries}
+  \newcommand{\cftchapterafterpnum}{}
+  \newcommand*{\cftchapterformatpnum}[1]{%
+    \hb at xt@\@pnumwidth{\hfil\cftchapterpagefont #1}}
+  \newcommand*{\cftchapterfillnum}[1]{
+    {\cftchapterleader}\nobreak
+    \cftchapterformatpnum{#1}%
+    \cftchapterafterpnum\par}
+  \newcommand{\cftchapterbreak}{\addpenalty{-\@highpenalty}}
+
+\newlistentry[chapter]{section}{toc}{0}
+  \cftsetindents{section}{1.5em}{2.3em}
+\newlistentry[section]{subsection}{toc}{1}
+  \cftsetindents{subsection}{3.8em}{3.2em}
+\newlistentry[subsection]{subsubsection}{toc}{2}
+  \cftsetindents{subsubsection}{7.0em}{4.1em}
+\newlistentry[subsubsection]{paragraph}{toc}{3}
+  \cftsetindents{paragraph}{10.0em}{5.0em}
+\newlistentry[paragraph]{subparagraph}{toc}{4}
+  \cftsetindents{subparagraph}{12.0em}{6.0em}
+
+\newcommand*{\@cftl at subfigtab}{
+\newlistentry[figure]{subfigure}{lof}{1}
+  \cftsetindents{subfigure}{2.3em}{2.5em}
+\newlistentry[table]{subtable}{lot}{1}
+  \cftsetindents{subtable}{2.3em}{2.5em}}
+\renewcommand*{\@cftl at subfigtab}{}
+
+\AtBeginDocument{\@ifpackageloaded{subfigure}{\@cftl at subfigtab}{}}
+
+\DeclareRobustCommand{\cftpagenumbersoff}[1]{%
+  \@namedef{cft#1fillnum}##1{%
+    \cftparfillskip\@nameuse{cft#1afterpnum}\par}}
+
+\DeclareRobustCommand{\cftpagenumberson}[1]{%
+  \@namedef{cft#1fillnum}##1{%
+    \@nameuse{cft#1leader}\nobreak
+    \@nameuse{cft#1formatpnum}{##1}%
+    \@nameuse{cft#1afterpnum}\par}}
+
+\newcommand{\chapterprecis}[1]{%
+  \chapterprecishere{#1}
+  \chapterprecistoc{#1}}
+\newcommand{\chapterprecishere}[1]{%
+  \prechapterprecis #1\postchapterprecis}
+\newdimen\prechapterprecisshift
+\ifartopt
+  \prechapterprecisshift=0pt
+\else
+  \prechapterprecisshift=-2\baselineskip
+\fi
+\newcommand*{\precisfont}{\normalfont\itshape}
+\newcommand{\prechapterprecis}{%
+  \vspace*{\prechapterprecisshift}%
+  \begin{quote}\precisfont}
+\newcommand*{\postchapterprecis}{\end{quote}}
+
+\newcommand{\precistocfont}{\normalfont\itshape}
+\newcommand{\chapterprecistoc}[1]{%
+  \addtocontents{toc}{\precistoctext{#1}}}
+\DeclareRobustCommand{\precistoctext}[1]{%
+  {\nopagebreak\if at RTL\rightskip\else\leftskip\fi \cftchapterindent\relax
+   \advance\if at RTL\rightskip\else\leftskip\fi \cftchapternumwidth\relax
+   \if at RTL\leftskip\else\rightskip\fi \@tocrmarg\relax
+   \precistocfont #1\par}}
+\newcommand{\cftlocalchange}[3]{%
+  \addtocontents{#1}{\protect\setpnumwidth{#2} \protect\setrmarg{#3}}}
+\newcommand{\cftaddtitleline}[4]{%
+  \addtocontents{#1}{\protect\contentsline{#2}{#3}{#4}}}
+\newcommand{\cftaddnumtitleline}[5]{%
+  \addtocontents{#1}%
+    {\protect\contentsline{#2}{\protect\numberline{#3}%
+                              {\protect\ignorespaces #4}}{#5}}}
+\newcommand*{\cftinsert}[1]{\@nameuse{cftinsert#1}}
+\newcommand{\cftinsertcode}[2]{\@namedef{cftinsert#1}{#2}}
+\newcommand*{\cftinserthook}[2]{%
+  \addtocontents{#1}{\protect\cftinsert\protect{#2\protect}}}
+
+\newcommand*{\@setclcnt}[2]{%
+  \@tempswafalse
+  \nametest{#1}{none}%
+  \ifsamename
+    \setcounter{#2}{-10}%
+    \@tempswatrue
+  \fi
+  \nametest{#1}{book}%
+  \ifsamename
+    \setcounter{#2}{-2}%
+    \@tempswatrue
+  \fi
+  \nametest{#1}{part}%
+  \ifsamename
+    \setcounter{#2}{-1}%
+    \@tempswatrue
+  \fi
+  \nametest{#1}{chapter}%
+  \ifsamename
+    \setcounter{#2}{0}%
+    \@tempswatrue
+  \fi
+  \nametest{#1}{section}%
+  \ifsamename
+    \setcounter{#2}{1}%
+    \@tempswatrue
+  \fi
+  \nametest{#1}{subsection}%
+  \ifsamename
+    \setcounter{#2}{2}%
+    \@tempswatrue
+  \fi
+  \nametest{#1}{subsubsection}%
+  \ifsamename
+    \setcounter{#2}{3}%
+    \@tempswatrue
+  \fi
+  \nametest{#1}{paragraph}%
+  \ifsamename
+    \setcounter{#2}{4}%
+    \@tempswatrue
+  \fi
+  \nametest{#1}{subparagraph}%
+  \ifsamename
+    \setcounter{#2}{5}%
+    \@tempswatrue
+  \fi
+  \nametest{#1}{all}%
+  \ifsamename
+    \setcounter{#2}{50}%
+    \@tempswatrue
+  \fi
+  \if at tempswa\else
+    \@memerror{%
+      Unknown document division name (#1)
+    }{%
+     I'll ignore it.
+     Type \space <return> and I'll continue.\MessageBreak
+     If you haven't mistyped the name then use
+     \protect\setcounter\space instead.}%
+  \fi}
+
+\newcommand*{\settocdepth}[1]{%
+  \@tempswafalse
+  \nametest{#1}{none}%
+  \ifsamename
+    \addtocontents{toc}{\changetocdepth{-10}}%
+    \@tempswatrue
+  \fi
+  \nametest{#1}{book}%
+  \ifsamename
+    \addtocontents{toc}{\changetocdepth{-2}}%
+    \@tempswatrue
+  \fi
+  \nametest{#1}{part}%
+  \ifsamename
+    \addtocontents{toc}{\changetocdepth{-1}}%
+    \@tempswatrue
+  \fi
+  \nametest{#1}{chapter}%
+  \ifsamename
+    \addtocontents{toc}{\changetocdepth{0}}%
+    \@tempswatrue
+  \fi
+  \nametest{#1}{section}%
+  \ifsamename
+    \addtocontents{toc}{\changetocdepth{1}}%
+    \@tempswatrue
+  \fi
+  \nametest{#1}{subsection}%
+  \ifsamename
+    \addtocontents{toc}{\changetocdepth{2}}%
+    \@tempswatrue
+  \fi
+  \nametest{#1}{subsubsection}%
+  \ifsamename
+    \addtocontents{toc}{\changetocdepth{3}}%
+    \@tempswatrue
+  \fi
+  \nametest{#1}{paragraph}%
+  \ifsamename
+    \addtocontents{toc}{\changetocdepth{4}}%
+    \@tempswatrue
+  \fi
+  \nametest{#1}{subparagraph}%
+  \ifsamename
+    \addtocontents{toc}{\changetocdepth{5}}%
+    \@tempswatrue
+  \fi
+  \nametest{#1}{all}%
+  \ifsamename
+    \addtocontents{toc}{\changetocdepth{50}}%
+    \@tempswatrue
+  \fi
+  \if at tempswa
+    \@ifundefined{toclevel@#1}{%
+      \@memwarn{Unknown toclevel for #1}%
+    }{%
+      \setcounter{tocdepth}{\@nameuse{toclevel@#1}}%
+    }
+  \else
+    \@memerror{%
+      Unknown document division name (#1)
+    }{%
+     I'll ignore it.
+     Type \space <return> and I'll continue.}%
+  \fi}
+
+\newcommand*{\toclevel at none}{-10}
+\newcommand*{\toclevel at all}{50}
+
+\DeclareRobustCommand{\changetocdepth}[1]{\setcounter{tocdepth}{#1}}
+
+\newcommand{\maxtocdepth}[1]{%
+  \@setclcnt{#1}{tocdepth}}
+\newcounter{maxsecnumdepth}
+\newcommand{\maxsecnumdepth}[1]{%
+  \@setclcnt{#1}{secnumdepth}\@setclcnt{#1}{maxsecnumdepth}}
+
+\newcommand{\setsecnumdepth}[1]{%
+  \ifx\@nodocument\relax%      after the preamble
+    \@setclcnt{#1}{secnumdepth}%
+  \else
+    \@setclcnt{#1}{secnumdepth}%
+    \@setclcnt{#1}{maxsecnumdepth}%
+  \fi}
+\setsecnumdepth{section}
+
+\newdimen\bibindent
+  \setlength\bibindent{1.5em}
+\newlength{\bibitemsep}
+  \setlength{\bibitemsep}{\itemsep}
+\newcommand{\biblistextra}{\itemsep=\bibitemsep}
+
+\newenvironment{bibitemlist}[1]{%
+  \typeout{bibitemlist}
+  \list{\@biblabel{\@arabic\c at enumiv}}%
+       {\settowidth\labelwidth{\@biblabel{#1}}%
+        \leftmargin\labelwidth
+        \advance\leftmargin\labelsep
+        \@openbib at code
+        \usecounter{enumiv}%
+        \let\p at enumiv\@empty
+        \renewcommand\theenumiv{\@arabic\c at enumiv}%
+        \biblistextra}%
+  \sloppy
+  \clubpenalty4000
+  \@clubpenalty \clubpenalty
+  \widowpenalty4000%
+  \sfcode`\.\@m}%
+  {\def\@noitemerr
+    {\@latex at warning{Empty `thebibliography' environment}}%
+    \endlist}
+
+\newcommand{\newblock}{\hskip .11em\@plus.33em\@minus.07em}
+\let\@openbib at code\@empty
+\newcommand*{\setbiblabel}[1]{%
+  \renewcommand*{\@biblabel}[1]{#1}}
+\setbiblabel{[#1]\hfill}
+\newcommand{\@memb at bchap}{%
+  \chapter*{\bibname}%
+  \bibmark
+  \ifnobibintoc\else
+    \phantomsection
+    \addcontentsline{toc}{chapter}{\bibname}%
+  \fi
+  \prebibhook}
+\newcommand{\@memb at bsec}{\section{\bibname}\prebibhook}
+\newcommand{\bibsection}{\@memb at bchap}
+
+\newenvironment{thebibliography}[1]{%
+  \bibsection
+  \begin{bibitemlist}{#1}}{\end{bibitemlist}\postbibhook}
+\newif\ifnobibintoc
+\newcommand*{\bibintoc}{\nobibintocfalse}
+\newcommand*{\nobibintoc}{\nobibintoctrue}
+\bibintoc
+
+\newcommand{\prebibhook}{}
+\newcommand{\postbibhook}{}
+
+\AtBeginDocument{%
+  \@ifpackageloaded{natbib}{% natbib is loaded
+    \addtodef{\endthebibliography}{}{\vskip-\lastskip\postbibhook}
+    \@ifpackagewith{natbib}{sectionbib}{% with sectionbib option
+      \renewcommand{\bibsection}{\@memb at bsec}}%
+      {\renewcommand{\bibsection}{\@memb at bchap}}}%
+  {}
+  \@ifpackagewith{chapterbib}{sectionbib}{%
+    \renewcommand{\sectionbib}[2]{}
+    \renewcommand{\bibsection}{\@memb at bsec}}{}
+}
+
+\newif\ifonecolindex
+  \onecolindexfalse
+
+\newcommand*{\onecolindex}{\onecolindextrue}
+\newcommand*{\twocolindex}{\onecolindexfalse}
+
+\newenvironment{theindex}{%
+  \clearforchapter
+  \if at twocolumn
+    \@restonecolfalse
+  \else
+    \@restonecoltrue
+  \fi
+  \ifonecolindex
+    \onecolumn
+    \chapter*{\indexname}
+    \preindexhook
+  \else
+    \setlength{\columnseprule}{\indexrule}%
+    \setlength{\columnsep}{\indexcolsep}%
+    \twocolumn[\@makeschapterhead{\indexname}
+               \preindexhook]%
+  \fi
+  \indexmark
+  \ifnoindexintoc\else
+    \phantomsection
+    \addcontentsline{toc}{chapter}{\indexname}%
+  \fi
+  \thispagestyle{indextitlepagestyle}\parindent\z@
+  \parskip\z@ \@plus .3\p@\relax
+  \let\item\@idxitem}%
+  {\if at restonecol\onecolumn\else\twocolumn\fi}
+
+\aliaspagestyle{indextitlepagestyle}{chapter}
+
+\newif\ifnoindexintoc
+\newcommand*{\indexintoc}{\noindexintocfalse}
+\newcommand*{\noindexintoc}{\noindexintoctrue}
+\indexintoc
+
+\newlength{\indexcolsep} \setlength{\indexcolsep}{35pt}
+\newlength{\indexrule}   \setlength{\indexrule}{0pt}
+
+\newcommand{\preindexhook}{}
+\newcommand{\l at index}{\@dottedtocline{1}{0em}{0pt}}
+\newcommand{\@idxitem}  {\par\hangindent 40\p@}
+\newcommand{\subitem}   {\par\hangindent 40\p@ \hspace*{20\p@}}
+\newcommand{\subsubitem}{\par\hangindent 40\p@ \hspace*{30\p@}}
+\newcommand{\indexspace}{\par \vskip 10\p@ \@plus5\p@ \@minus3\p@\relax}
+
+\newcommand*{\makememindexhook}{}
+\providecommand*{\makeindex}{}
+\renewcommand*{\makeindex}[1][\jobname]{%
+  \if at filesw
+    \def\index{\@bsphack%
+      \@ifnextchar [{\@index}{\@index[\jobname]}}
+    \def\specialindex{\@bsphack\@spindex}%
+    \makememindexhook
+    \expandafter\newwrite\csname #1 at idxfile\endcsname
+    \expandafter\immediate\openout \csname #1 at idxfile\endcsname #1.idx\relax
+    \typeout{Writing index file #1.idx }%
+  \fi}
+
+\renewcommand{\index}[2][\jobname]{\@bsphack\@esphack}
+\newcommand{\specialindex}[3]{\@bsphack\@esphack}
+
+\newcommand{\printindex}[1][\jobname]{\@input@{#1.ind}}
+
+\newif\ifreportnoidxfile
+\newcommand*{\reportnoidxfile}{\reportnoidxfiletrue}
+\newcommand*{\ignorenoidxfile}{\reportnoidxfilefalse}
+  \ignorenoidxfile
+\newif\ifshowindexmark
+\newcommand*{\showindexmarks}{\showindexmarktrue}
+\newcommand*{\hideindexmarks}{\showindexmarkfalse}
+  \hideindexmarks
+
+\def\@index[#1]{%
+  \@ifundefined{#1 at idxfile}%
+  {\ifreportnoidxfile
+     \@memwarn{Undefined index file #1}%
+    \fi
+    \begingroup
+    \@sanitize
+    \@nowrindex}%
+  {\def\@idxfile{#1}%
+   \begingroup
+   \@sanitize
+   \@wrindexm at m}}
+\newcommand{\@nowrindex}[1]{%
+  \ifshowindexmark\@showidx{#1}\fi\endgroup\@esphack}
+
+\newcommand{\@wrindexm at m}[1]{\@@wrindexhyp#1||\\}
+\def\@@wrindexhyp#1|#2|#3\\{%
+  \ifshowindexmark\@showidx{#1}\fi
+  \ifx\\#2\\%
+    \protected at write\@auxout{}%
+      {\string\@@wrindexm at m{\@idxfile}{#1|hyperpage}{\thepage}}%
+  \else
+    \def\Hy at temp@A{#2}%
+    \ifx\Hy at temp@A\HyInd at ParenLeft
+      \protected at write\@auxout{}%
+        {\string\@@wrindexm at m{\@idxfile}{#1|#2hyperpage}{\thepage}}%
+    \else
+      \protected at write\@auxout{}%
+        {\string\@@wrindexm at m{\@idxfile}{#1|#2}{\thepage}}%
+    \fi
+  \fi
+  \endgroup
+  \@esphack}
+\newcommand{\hyperpage}[1]{#1}
+\newcommand{\hyperlink}[2]{#2}
+
+\newcommand{\@@wrindexm at m}[1]{\begingroup
+  \def\@idxfile{\@nameuse{#1 at idxfile}}
+  \@sanitize
+  \@@@wrindexm at m}
+
+\newcommand{\@@@wrindexm at m}[2]{\endgroup}
+\AtBeginDocument{%
+  \def\@@@wrindexm at m#1#2{%
+    \if at filesw
+      \immediate\write \@idxfile{\string\indexentry{#1}{#2}}%
+    \fi
+    \endgroup}%
+}
+\newcommand{\@spindex}[2]{%
+  \@ifundefined{#1 at idxfile}%
+  {\ifreportnoidxfile
+     \@memwarn{Undefined index file #1}%
+    \fi
+    \begingroup
+    \@sanitize
+    \@nowrindex}%
+  {\def\@idxfile{#1}%
+   \def\@sptheidx{#2}%
+   \begingroup
+   \@sanitize
+   \@wrspindex}}
+
+\newcommand{\@wrspindex}[1]{\@@wrspindexhyp#1||\\}
+\def\@@wrspindexhyp#1|#2|#3\\{%
+  \ifshowindexmark\@showidx{#1}\fi
+  \ifx\\#2\\%
+    \protected at write\@auxout{}%
+      {\string\@@wrindexm at m{\@idxfile}%
+        {#1|hyperspindexpage(\thepage)}%
+      {\@nameuse{the\@sptheidx}}}%
+  \else
+    \def\Hy at temp@A{#2}%
+    \ifx\Hy at temp@A\HyInd at ParenLeft
+      \protected at write\@auxout{}%
+        {\string\@@wrindexm at m{\@idxfile}%
+         {#1|#2hyperspindexpage(\thepage)}%
+         {\@nameuse{the\@sptheidx}}}%
+    \else
+      \protected at write\@auxout{}%
+        {\string\@@wrindexm at m{\@idxfile}{#1|#2}%
+        {\@nameuse{the\@sptheidx}}}%
+    \fi
+  \fi
+  \endgroup
+  \@esphack}
+\def\hyperspindexpage(#1)#2{\hyperlink{page.#1}{#2}}
+
+\newif\ifmemhyperindex
+  \memhyperindextrue
+
+\newif\ifm at mxindy
+\m at mxindyfalse
+\newcommand*{\xindyindex}{\m at mxindytrue}
+\def\@@wrspindexhyp#1|#2|#3\\{%
+  \ifshowindexmark\@showidx{#1}\fi
+  \ifx\\#2\\%
+    \protected at write\@auxout{}%
+      {\string\@@wrindexm at m{\@idxfile}%
+        \ifm at mxindy{#1}\else{#1|hyperspindexpage(\thepage)}\fi
+      {\@nameuse{the\@sptheidx}}}%
+  \else
+    \def\Hy at temp@A{#2}%
+    \ifx\Hy at temp@A\HyInd at ParenLeft
+      \protected at write\@auxout{}%
+        {\string\@@wrindexm at m{\@idxfile}%
+         \ifm at mxindy{#1|#2}\else{#1|#2hyperspindexpage(\thepage)}\fi
+      {\@nameuse{the\@sptheidx}}}%
+    \else
+      \protected at write\@auxout{}%
+        {\string\@@wrindexm at m{\@idxfile}{#1|#2}%
+      {\@nameuse{the\@sptheidx}}}%
+    \fi
+  \fi
+  \endgroup
+  \@esphack}
+
+\AtBeginDocument{%
+  \@ifpackageloaded{hyperref}{}{\memhyperindexfalse}%
+  \ifmemhyperindex\else
+    \def\@@wrindexhyp#1||\\{%
+      \ifshowindexmark\@showidx{#1}\fi
+      \protected at write\@auxout{}%
+        {\string\@@wrindexm at m{\@idxfile}{#1}{\thepage}}%
+      \endgroup
+      \@esphack}%
+    \def\@@wrspindexhyp#1||\\{%
+      \ifshowindexmark\@showidx{#1}\fi
+      \protected at write\@auxout{}%
+        {\string\@@wrindexm at m{\@idxfile}{#1}{\@nameuse{the\@sptheidx}}}%
+      \endgroup
+      \@esphack}%
+  \fi
+}
+
+\newcommand*{\see}[2]{\emph{\seename} #1}
+\newcommand*{\seename}{see}
+\newcommand*{\seealso}[2]{\emph{\alsoname} #1}
+\newcommand*{\alsoname}{see also}
+
+\newcommand{\citeindexfile}{\jobname}
+\AtBeginDocument{\@ifpackageloaded{natbib}{%
+  \def\NAT at index{\index[\citeindexfile]{\NAT at idxtxt}}}{}}
+
+\newtoks\indexmarkstyle
+  \indexmarkstyle{\normalfont\footnotesize\ttfamily}
+\newinsert\@indexbox
+  \dimen\@indexbox\maxdimen
+
+\begingroup
+  \catcode`\@\active
+  \expandafter\gdef\csname\string @sanitizeat\endcsname
+  {\def @{\char`\@}}
+\endgroup
+
+\newcommand{\@showidx}[1]{%
+  \insert\@indexbox{%
+    \@sanitizeat
+    \the\indexmarkstyle
+    \hsize\marginparwidth
+    \hangindent\marginparsep \parindent\z@
+    \everypar{}\let\par\@@par \parfillskip\@flushglue
+    \lineskip\normallineskip
+    \baselineskip .8\normalbaselineskip\sloppy
+    \raggedright \leavevmode
+    \vrule \@height .7\normalbaselineskip \@width \z@\relax
+      #1\relax
+    \vrule \@height \z@ \@depth .3\normalbaselineskip \@width \z@\relax
+  }%
+  \ifhmode\penalty\@M \hskip\z at skip\fi}
+
+\newcommand{\@leftidx}{\hskip-\marginparsep \hskip-\marginparwidth}
+\newcommand{\@rightidx}{\hskip\columnwidth \hskip\marginparsep}
+
+\newcommand{\@mkidx}{\vbox to \z@{%
+  \rlap{%
+    \if at twocolumn
+      \if at firstcolumn \@leftidx \else \@rightidx \fi
+    \else
+      \if at twoside
+        \ifodd\c at page \@rightidx \else \@leftidx \fi
+      \else
+        \@rightidx
+      \fi
+    \fi
+    \box\@indexbox
+  }%
+  \vss}}
+
+\renewcommand{\raggedbottom}{%
+  \def\@textbottom{\vskip\z@ plus.0001fil}%
+  \let\@texttop\@mkidx}
+\renewcommand{\flushbottom}{%
+  \let\@textbottom\relax
+  \let\@texttop\@mkidx}
+\let\@texttop\@mkidx
+
+\newcommand*{\sloppybottom}{%
+  \def\@textbottom{\vskip \z@ \@plus.0001fil \@minus .95\topskip}%
+  \topskip=1\topskip \@plus 0.625\topskip \@minus .95\topskip
+  \def\@texttop{\vskip \z@ \@plus -0.625\topskip \@minus -0.95\topskip}}
+
+\newif\ifonecolglossary
+  \onecolglossarytrue
+\newcommand*{\onecolglossary}{\onecolglossarytrue}
+\newcommand*{\twocolglossary}{\onecolglossaryfalse}
+
+\newenvironment{theglossary}{%
+  \if at twocolumn
+    \@restonecolfalse
+  \else
+    \@restonecoltrue
+  \fi
+  \ifonecolglossary
+    \onecolumn
+    \chapter*{\glossaryname}
+    \preglossaryhook
+  \else
+    \setlength{\columnseprule}{\glossaryrule}
+    \setlength{\columnsep}{\glossarycolsep}
+    \twocolumn[\@makeschapterhead{\glossaryname}
+               \preglossaryhook]%
+  \fi
+  \glossarymark
+  \ifnoglossaryintoc\else
+    \phantomsection
+    \addcontentsline{toc}{chapter}{\glossaryname}
+  \fi
+  \thispagestyle{chapter}\parindent\z@
+  \parskip\z@ \@plus .3\p@\relax
+  \begintheglossaryhook}%
+  {\atendtheglossaryhook\if at restonecol\onecolumn\else\twocolumn\fi}
+
+\newcommand*{\begintheglossaryhook}{}
+\newcommand*{\atendtheglossaryhook}{}
+\newcommand*{\preglossaryhook}{}
+
+\newif\ifnoglossaryintoc
+\newcommand*{\glossaryintoc}{\noglossaryintocfalse}
+\newcommand*{\noglossaryintoc}{\noglossaryintoctrue}
+  \glossaryintoc
+
+\newdimen\glossarycolsep \glossarycolsep=35\p@
+\newdimen\glossaryrule \glossaryrule=0\p@
+\newcommand*{\glossaryspace}{%
+    \par \vskip 1.0\onelineskip \@plus 5\p@ \@minus3\p@\relax}
+
+\providecommand*{\makeglossary}{}
+\renewcommand*{\makeglossary}[1][\jobname]{%
+  \makememglossaryhook
+  \@namedef{memglsact#1}{@}%           actual
+  \@namedef{memglsnx#1}{}%             no ref
+  \@namedef{memglsn#1}{\thepage}%      num  by page
+  \@namedef{memglsnf#1}{|memjustarg}%  no special number format
+  \if at filesw \expandafter\newwrite\csname #1memglofile\endcsname
+    \expandafter\immediate\openout \csname #1memglofile\endcsname #1.glo\relax
+    \typeout{Writing glossary file #1.glo }%
+  \fi}
+
+\newcommand*{\makememglossaryhook}{}
+
+  \def\glossary{\@bsphack%
+    \@ifnextchar [{\@glossary}{\@glossary[\jobname]}}%
+\def\@glossary[#1]{%
+  \@ifnextchar ({\@@glossary[#1]}{\@@glossary[#1]()}}
+\def\@@glossary[#1](#2)#3#4{%
+  \@ifundefined{#1memglofile}{%
+    \begingroup
+    \@sanitize
+    \endgroup
+    \@esphack%
+   }{%
+    \def\memglofile{#1}%
+    \begingroup
+    \@sanitize
+    \ifx\@empty#2\@empty
+      \@wrglom at m{#3}{#3}{#4}%
+    \else
+      \@wrglom at m{#2}{#3}{#4}%
+    \fi}}
+
+\newcommand{\@wrglom at m}[3]{%
+  \protected at write\@auxout{}%
+    {\string\@@wrglom at m{\memglofile}{#1}{#2}{#3}{\@nameuse{memglsnx\memglofile}}{\@nameuse{memglsn\memglofile}}}%
+  \endgroup
+  \@esphack}
+
+\newcommand{\@@wrglom at m}[1]{\begingroup
+  \def\memglofile{\@nameuse{#1memglofile}}%
+  \def\m at mgf{#1}%
+  \@sanitize
+  \memwritetoglo}
+
+\newcommand{\memwritetoglo}[5]{\endgroup}
+\newcommand{\@ctualm at mwritetoglo}[5]{%
+  \immediate\write \memglofile{\string\glossaryentry{#1\@nameuse{memglsact\m at mgf}
+                    {\string\memgloterm{#2}}{\string\memglodesc{#3}}
+                    {\string\memgloref{#4}}\@nameuse{memglsnf\m at mgf}}{#5}}%
+  \endgroup}
+\AtBeginDocument{%
+  \let\memwritetoglo\@ctualm at mwritetoglo}
+
+\newcommand*{\changeglossactual}[2][\jobname]{%
+  \@namedef{memglsact#1}{#2}}
+\newcommand*{\changeglossref}[2][\jobname]{%
+  \@namedef{memglsnx#1}{#2}}
+\newcommand*{\changeglossnum}[2][\jobname]{%
+  \@namedef{memglsn#1}{#2}}
+\newcommand*{\changeglossnumformat}[2][\jobname]{%
+  \@namedef{memglsnf#1}{#2}}
+
+\newcommand{\glossitem}[4]{#1 #2 #3 #4\par}
+
+\newcommand*{\memgloterm}[1]{#1}
+\newcommand*{\memglodesc}[1]{#1}
+\newcommand*{\memgloref}[1]{#1}
+\newcommand*{\memglonum}[1]{#1}
+
+\newcommand*{\printglossary}[1][\jobname]{\@input@{#1.gls}}
+
+\def\@addmarginpar{%
+    \checkoddpage
+    \@next\@marbox\@currlist{\@cons\@freelist\@marbox
+    \@cons\@freelist\@currbox}\@latexbug\@tempcnta\@ne
+    \if at twocolumn
+        \if at firstcolumn \@tempcnta\m at ne \fi
+    \else
+      \if at mparswitch
+        \ifoddpage \else \@tempcnta\m at ne \fi
+      \fi
+    \if at reversemargin \@tempcnta -\@tempcnta \fi
+    \fi
+    \ifnum\@tempcnta <\z@  \global\setbox\@marbox\box\@currbox \fi
+    \@tempdima\@mparbottom
+    \advance\@tempdima -\@pageht
+    \advance\@tempdima\ht\@marbox
+    \ifdim\@tempdima >\z@
+      \@latex at warning@no at line {Marginpar on page
+                               \thepage\space moved by \the\@tempdima}%
+    \else
+      \@tempdima\z@
+    \fi
+    \global\@mparbottom\@pageht
+    \global\advance\@mparbottom\@tempdima
+    \global\advance\@mparbottom\dp\@marbox
+    \global\advance\@mparbottom\marginparpush
+    \advance\@tempdima -\ht\@marbox
+    \global\setbox \@marbox
+                   \vbox {\vskip \@tempdima
+                          \box \@marbox}%
+    \global \ht\@marbox \z@
+    \global \dp\@marbox \z@
+    \kern -\@pagedp
+    \nointerlineskip
+    \hb at xt@\columnwidth
+      {\ifnum \@tempcnta >\z@
+          \hskip\columnwidth \hskip\marginparsep
+       \else
+          \hskip -\marginparsep \hskip -\marginparwidth
+       \fi
+       \box\@marbox \hss}%
+    \nointerlineskip
+    \hbox{\vrule \@height\z@ \@width\z@ \@depth\@pagedp}%
+}
+
+\newcommand{\parnopar}{\parfillskip=0pt\par\parskip=0pt\noindent
+                       \parfillskip\@flushglue}
+
+\newif\ifreversesidepar
+  \reversesidepartrue
+\newif\ifsideparswitch
+  \sideparswitchfalse
+\if at twoside \sideparswitchtrue \fi
+
+\newlength{\sideparvshift}
+%%%%  \setlength{\sideparvshift}{-2.08ex}% seems to work for all font sizes
+
+\newcommand{\sidepar}{\@dblarg{\@sidepar}}
+\long\def\@sidepar[#1]#2{\@bsphack\strut\vadjust{%
+  \checkoddpage
+  \ifsideparswitch
+    \ifreversesidepar
+      \ifoddpage
+        \oddpagefalse
+      \else
+        \oddpagetrue
+      \fi
+    \fi
+  \else
+    \oddpagetrue
+    \ifreversesidepar
+      \oddpagefalse
+     \fi
+  \fi
+  \rlap{\kern-\parindent
+    \if at twocolumn
+      \if at firstcolumn%              put at left
+        \kern -\marginparsep \kern -\marginparwidth
+      \else%                        put at right
+        \kern \columnwidth \kern \marginparsep
+      \fi
+    \else
+      \ifoddpage%                   put at right
+        \kern \textwidth \kern \marginparsep
+      \else%                        put at left
+        \kern -\marginparsep \kern -\marginparwidth
+      \fi
+    \fi
+    \setbox0=\vtop to 0pt{%
+      \begin{minipage}[t]{\marginparwidth}%
+        \normalfont\normalsize
+        \ifoddpage #2\else #1\fi%
+      \end{minipage}%
+      \vss}%
+    \vtop to 0pt{\kern\sideparvshift%  default should be 0pt
+      \kern-\dp\strutbox
+      \kern-\ht0
+      \box0 \vss}}}%
+  \@esphack}
+\setlength{\sideparvshift}{0pt}
+
+\newinsert\sideins
+  \skip\sideins=0pt
+  \count\sideins=0
+
+\newlength{\sidebartopsep}
+  \setlength{\sidebartopsep}{0pt}
+\newcommand{\setsidebarheight}[1]{%
+  \setlength{\dimen\sideins}{#1}%
+  \advance\dimen\sideins-\topskip
+  \advance\dimen\sideins\ht\strutbox}
+
+\newlength{\sidebarhsep}
+\newlength{\sidebarvsep}
+\newlength{\sidebarwidth}
+\newcommand{\sidebarfont}{}
+\newcommand*{\setsidebars}[6]{%
+  \nametest{#1}{*}\ifsamename\else
+    \setlength{\sidebarhsep}{#1}\@memznegtest{\sidebarhsep}%
+  \fi
+  \nametest{#2}{*}\ifsamename\else
+    \setlength{\sidebarwidth}{#2}\@memznegtest{\sidebarwidth}%
+  \fi
+  \nametest{#3}{*}\ifsamename\else
+    \setlength{\sidebarvsep}{#3}\@memnegtest{\sidebarvsep}%
+  \fi
+  \nametest{#4}{*}\ifsamename\else
+    \setlength{\sidebartopsep}{#4}%
+  \fi
+  \nametest{#5}{*}\ifsamename\else
+    \def\sidebarfont{#5}%
+  \fi
+  \nametest{#6}{*}\ifsamename\else
+    \setsidebarheight{#6}%
+    \ifdim\dimen\sideins>\z@\else
+%%%%      \@memerror{\protect\sidebarheight\space is zero or negative}{\@ehd}%
+      \@memwarn{\protect\sidebarheight\space is zero or negative}%
+    \fi
+  \fi}
+\setsidebars{\marginparsep}%          sidebarhsep
+            {\marginparwidth}%        sidebarwidth
+            {\onelineskip}%           sidebarvsep
+            {0pt}%                    sidebartopsep
+            {\normalsize\normalfont}% sidebarfont
+            {\textheight}%            sidebarheight
+
+\newcommand{\sidebarform}{\if at RTL\leftskip\else\rightskip\fi=\z@ \@plus 2em}
+
+\newif\ifsidebaroneside
+  \if at twoside\sidebaronesidefalse\else\sidebaronesidetrue\fi
+
+\newcommand*{\sidebarmargin}[1]{%
+  \def\@tempa{#1}\def\@tempb{left}%
+  \ifx\@tempa\@tempb
+    \gdef\m at msidebar@margin{0}%
+  \else
+    \def\@tempb{right}%
+    \ifx\@tempa\@tempb
+      \gdef\m at msidebar@margin{1}%
+    \else
+      \def\@tempb{outer}%
+      \ifx\@tempa\@tempb
+        \gdef\m at msidebar@margin{2}%
+      \else
+        \def\@tempb{inner}%
+        \ifx\@tempa\@tempb
+          \gdef\m at msidebar@margin{3}%
+        \else
+          \@memwarn{Bad \string\sidebarmargin\space argument}%
+          \gdef\m at msidebar@margin{1}%
+        \fi
+       \fi
+     \fi
+  \fi}
+%%%% default outer
+\gdef\m at msidebar@margin{2}
+\newcommand*{\m at sideb@left}{%
+  \@tempdimc \sidebarwidth
+  \advance\@tempdimc\sidebarhsep
+  \kern-\@tempdimc}
+\newcommand*{\m at sideb@right}{%
+  \@tempdimc \columnwidth%  or \hsize
+  \advance\@tempdimc\sidebarhsep
+  \kern\@tempdimc}
+
+\newcommand{\sidecontents}{\hbox to \z@{%
+  \if at twocolumn%    %% put outside nearest column
+    \if at firstcolumn%  %% move to left
+      \m at sideb@left
+    \else%            %% move to right
+      \m at sideb@right
+    \fi
+  \else%            %% put into foremargin?
+    \ifsidebaroneside%  %% put into right hand margin
+      \m at sideb@right
+    \else%              %% pick the margin
+      \ifcase\m at msidebar@margin%   0 to left
+        \m at sideb@left
+      \or%                         1 to right
+        \m at sideb@right
+      \or%                         2 to outer
+        \ifodd\c at page%  %% move to right
+          \m at sideb@right
+        \else%          %% move to left
+          \m at sideb@left
+        \fi
+      \or%                        3 to inner
+        \ifodd\c at page%  %% move to left
+          \m at sideb@left
+        \else%          %% move to right
+          \m at sideb@right
+        \fi
+      \fi
+    \fi
+  \fi
+  \vtop to0pt{%
+    \normalsize\normalfont\sidebarfont% select font so we know the strut size
+    \vskip\topskip \vskip-\ht\strutbox
+    \vskip\sidebartopsep% extra vertical shift
+    \unvbox\sideins \vss}%
+  \hss}}
+
+\newcommand{\sidebar}[1]{%
+  \insert\sideins{%
+    \hsize\sidebarwidth
+    \@parboxrestore
+    \sidebarform \normalsize\normalfont\sidebarfont
+    \splittopskip=\ht\strutbox
+    \splitmaxdepth=\dp\strutbox % doesn't do anything useful
+    \allowbreak
+    \prevdepth=\dp\strutbox    % supersedes a "top-strut"
+    \vskip-\parskip
+    #1%
+    \ifvmode\else
+      \unskip\@finalstrut\strutbox
+    \fi\par
+    \ifdim\prevdepth>\dp\strutbox \prevdepth=\dp\strutbox \fi
+    \ifdim\prevdepth>99\p@
+      \nobreak
+      \vskip-\prevdepth
+      \allowbreak
+      \vskip\dp\strutbox
+    \fi
+    \vskip\sidebarvsep}}
+
+\renewcommand{\footnoterule}{%
+  \kern-3\p@
+  \hrule width .4\columnwidth
+  \kern 2.6\p@}
+\skip\footins=\bigskipamount
+\@addtoreset{footnote}{chapter}
+\newcommand*{\multfootsep}{\textsuperscript{\normalfont,}}
+\newcommand*{\multiplefootnotemarker}{3sp}
+\newcommand*{\m at mmf@prepare}{%
+  \kern-\multiplefootnotemarker
+  \kern\multiplefootnotemarker\relax}
+\newcommand*{\m at mmf@check}{%
+  \ifdim\lastkern=\multiplefootnotemarker\relax
+    \edef\@x at sf{\the\spacefactor}%
+    \unkern
+    \multfootsep
+    \spacefactor\@x at sf\relax
+  \fi}
+
+\renewcommand{\@footnotetext}[1]{\insert\footins{%
+  \def\baselinestretch{\m at m@singlespace}%  <- v1.61803 addition
+  \reset at font%            <- v1.6180 addition
+  \foottextfont
+  \@preamfntext
+  \hsize\columnwidth
+  \protected at edef\@currentlabel{%
+    \csname p at footnote\endcsname\@thefnmark}%
+  \color at begingroup
+    \@makefntext{%
+      \rule\z@\footnotesep\ignorespaces{\foottextfont #1}%
+      \@finalstrut\strutbox}%
+  \color at endgroup}\m at mmf@prepare}
+\let\m at mold@footnotetext\@footnotetext
+\renewcommand*{\@footnotemark}{%
+  \leavevmode
+  \ifhmode
+    \edef\@x at sf{\the\spacefactor}%
+    \m at mmf@check
+    \nobreak
+  \fi
+  \@makefnmark
+  \m at mmf@prepare
+  \ifhmode\spacefactor\@x at sf\fi
+  \relax}
+
+\newlength{\footmarkwidth}
+\newlength{\footmarksep}
+\newlength{\footparindent}
+\newcommand*{\footmarkstyle}[1]{\def\footscript##1{#1}}
+\newcommand{\makefootmarkhook}{}
+
+\newcommand{\footfootmark}{%
+  \ifdim\footmarkwidth < \z@
+    \llap{\hb at xt@ -\footmarkwidth{%
+            \hss\normalfont\footscript{\@thefnmark}}%
+          \hspace*{-\footmarkwidth}}%
+  \else
+    \ifdim\footmarkwidth = \z@
+      {\normalfont\footscript{\@thefnmark}}%
+    \else
+      \hb at xt@\footmarkwidth{\hss\normalfont\footscript{\@thefnmark}}%
+    \fi
+  \fi}
+
+\newcommand{\makefootmark}[1]{%
+  \leavevmode
+  \parindent \footparindent\noindent
+  \leftskip\footmarksep\relax
+  \advance\leftskip \footmarkwidth \null\nobreak\hskip -\leftskip\relax
+  \makefootmarkhook\relax
+  \footfootmark #1}
+\newcommand{\@makefntext}[1]{\makefootmark #1}
+\footmarkstyle{\textsuperscript{#1}}
+\setlength{\footmarkwidth}{1.8em}
+\setlength{\footmarksep}{-1.8em}
+\setlength{\footparindent}{1em}
+
+\newcommand{\footref}[1]{%
+  \begingroup
+    \unrestored at protected@xdef\@thefnmark{\ref{#1}}%
+  \endgroup
+  \@footnotemark}
+
+\def\verbfootnote{\@ifnextchar[\@xverbfootnote{\stepcounter\@mpfn
+  \protected at xdef\@thefnmark{\thempfn}%
+  \@footnotemark\@verbfootnotetext}}
+
+\def\@xverbfootnote[#1]{%
+  \begingroup
+    \csname c@\@mpfn\endcsname #1\relax
+    \unrestored at protected@xdef\@thefnmark{\thempfn}%
+  \endgroup
+  \@footnotemark\@verbfootnotetext}
+
+\long\def\@verbfootnotetext{%
+  \insert\footins\bgroup
+    \footnotesize
+    \interlinepenalty\interfootnotelinepenalty
+    \splittopskip\footnotesep
+    \splitmaxdepth \dp\strutbox \floatingpenalty \@MM
+    \hsize\columnwidth \@parboxrestore
+    \edef\@currentlabel{\csname p at footnote\endcsname\@thefnmark}%
+%%%%    \color at begingroup
+    \@makefntext{\rule{\z@}{\footnotesep}\ignorespaces}%
+    \futurelet\next\fo at t
+}
+\def\fo at t{\ifcat\bgroup\noexpand\next \let\next\f@@t
+          \else \let\next\f at t\fi \next}
+\def\f@@t{\bgroup\aftergroup\@foot\let\next}
+\def\f at t#1{%
+  \color at begingroup
+  #1\@foot
+  \color at endgroup}
+\def\@foot{%
+  \strut\egroup
+%%%%  \color at endgroup
+  \m at mmf@prepare
+  }
+
+\long\def\@verbmpfootnotetext{%
+  \global\setbox\@mpfootins\vbox{%
+    \reset at font\footnotesize
+    \unvbox\@mpfootins
+    \bgroup
+    \hsize\columnwidth
+    \@parboxrestore
+    \edef\@currentlabel{\csname p at mpfootnote\endcsname\@thefnmark}%
+    \color at begingroup
+    \@makefntext{\rule{\z@}{\footnotesep}\ignorespaces}%
+    }
+    \futurelet\next\fo at t
+}
+
+%%%%%%%%%%%%%% major extension to footnoting
+
+\newcommand*{\setfootnoterule}[4][]{%
+  \def\footnoterule{\kern -#2\relax #1\relax
+    \hrule width #3\relax
+    \kern #2\kern-#4}}
+\setfootnoterule{3pt}{0.4\columnwidth}{\normalrulethickness}
+
+\newcommand{\m at mdoextrafeet}{\extrafeetins}
+\newcommand*{\extrafeetins}{%
+  \setbox\@outputbox \vbox{%
+    \boxmaxdepth \@maxdepth
+    \unvbox\@outputbox
+    \ifvoid\footinsv at r\else\@footstartv at r\@footgroupv at r\fi
+    \extrafeetinshook}}
+\newcommand{\extrafeetinshook}{}
+
+\newcommand{\m at mdodoreinextrafeet}{%
+  \ifvoid\footinsv at r\else\insert\footinsv at r{\unvbox\footinsv at r}\fi
+  \extrafeetreinshook}
+\newcommand{\extrafeetreinshook}{}
+
+\newcommand{\foottextfont}{\footnotesize}
+\newlength{\footinsdim}
+  \setlength{\footinsdim}{8in}   % standard for \dimen\footins
+\newcommand{\@preamfntext}{%
+  \interlinepenalty\interfootnotelinepenalty
+  \floatingpenalty \@MM
+  \splittopskip=\footnotesep
+  \splitmaxdepth=\dp\strutbox
+  \@parboxrestore}
+
+\renewcommand{\@mpfootnotetext}[1]{%
+  \global\setbox\@mpfootins\vbox{%
+    \unvbox\@mpfootins
+    \def\baselinestretch{\m at m@singlespace}%   <- v1.61803 addition
+    \foottextfont \hsize\columnwidth \@parboxrestore
+    \protected at edef\@currentlabel{%
+      \csname p at mpfootnote\endcsname\@thefnmark}%
+  \color at begingroup
+  \reset at font%           <- v1.6180 addition
+    \@makefntext{%
+      \rule\z@\footnotesep\ignorespaces{\foottextfont #1}%
+      \@finalstrut\strutbox}%
+  \color at endgroup}}
+
+\let\m at mold@mpfootnotetext\@mpfootnotetext
+
+\newcommand{\m at mdoextrafeetmini}{%
+  \extrafeetminihook}
+\newcommand{\extrafeetminihook}{}
+%%%%\renewcommand{\@minipagerestore}{\m at mdoextrafeetmini}
+
+\newcommand{\extrafeetendmini}{%
+  \ifvoid\@mpfootinsv at r\else
+    \vskip\skip\@mpfootins
+    \normalcolor\footnoterule\mp at footgroupv@r
+  \fi
+  \extrafeetendminihook}
+\newcommand{\extrafeetendminihook}{}
+
+\newcommand{\m at mdoextrafeetendmini}{\extrafeetendmini}
+\def\endminipage{%
+  \par
+  \unskip
+  \ifvoid\@mpfootins\else
+    \vskip\skip\@mpfootins
+    \normalcolor
+    \footnoterule
+    \unvbox\@mpfootins
+  \fi
+  \m at mdoextrafeetendmini
+  \@minipagefalse
+  \color at endgroup
+  \egroup
+  \expandafter\@iiiparbox\@mpargs{\unvbox\@tempboxa}}
+
+\newcommand{\plainfootnotes}{%
+  \let\@footnotetext\m at mold@footnotetext
+  \let\@mpfootnotetext\m at mold@mpfootnotetext}
+
+\newcommand{\newfootnoteseries}[1]{%
+  \expandafter\newinsert\csname footins#1\endcsname%  -> \footins#1
+  \expandafter\skip\csname footins#1\endcsname \bigskipamount%
+%%%                                      - > \skip\footins#1 % [RS]
+  \newcounter{footnote#1}%                       -> \c at footnote#1
+  \@nameuse{c at footnote#1} \z@%                   -> \c at footnote#1=0
+  \global\@namelet{p at footnote#1} \@empty%        -> \p at footnote#1
+  \@namedef{thefootnote#1}{\arabic{footnote#1}}% -> \thefootnote#1
+  \@namedef{foottextfont#1}{\foottextfont}%      -> \foottextfont#1
+  \m at makefootnote{#1}%                           -> \footnote#1
+  \m at make@xfootnote{#1}%                         -> \@xfootnote#1
+  \m at make@footnotetext{#1}%                      -> \@footnotetext#1
+  \m at makefootnotemark{#1}%                       -> \footnotemark#1
+  \m at make@xfootnotemark{#1}%                     -> \@xfootnotemark#1
+  \m at make@footnotemark{#1}%                      -> \@footnotemark#1
+  \m at makefootnotetext{#1}%                       -> \footnotetext#1
+  \m at make@xfootnotenext{#1}%                     -> \@xfootnotenext#1
+  \m at make@mpfn{#1}%                              -> \@mpfn#1
+  \m at makethempfn{#1}%                            -> \thempfn#1
+  \m at make@makefnmark{#1}%                        -> \@makefnmark#1
+  \m at makefootref{#1}%                            -> \footref#1
+  \m at makefootfootmark{#1}%                       -> \footfootmark#1
+  \m at makemakefootmark{#1}%                       -> \makefootmark#1
+  \m at makefootmarkstyle{#1}%                      -> \footmarkstyle#1
+  \@namedef{@makefntext#1}##1{\@nameuse{makefootmark#1} ##1}%
+  \m at make@footstart{#1}%                         -> \@footstart#1
+  \m at make@footgroup{#1}%                         -> \@footgroup#1
+  \expandafter\newinsert\csname @mpfootins#1\endcsname% -> \@mpfootins#1
+  \newcounter{mpfootnote#1}%                     -> \c at mpfootnote#1
+  \global\@namelet{p at mpfootnote#1}\@empty
+  \@namedef{thempfootnote#1}{\itshape\alph{mpfootnote#1}}%
+  \m at make@mpfootnotetext{#1}%                    -> \@mpfootnotetext#1
+  \ifartopt\else%  [RS]
+    \expandafter\@cons\csname cl at chapter\endcsname {{footnote#1}}%
+  \fi
+  \g at addto@macro{\extrafeetinshook}{%
+    \ifvoid\@nameuse{footins#1}\else
+      \@nameuse{@footstart#1}\@nameuse{@footgroup#1}\fi}
+  \g at addto@macro{\extrafeetreinshook}{%
+    \ifvoid\@nameuse{footins#1}\else
+      \insert\@nameuse{footins#1}{\unvbox\@nameuse{footins#1}}\fi}
+  \g at addto@macro{\extrafeetendminihook}{%
+    \ifvoid\@nameuse{@mpfootins#1}\else
+      \vskip\skip\@mpfootins
+      \normalcolor\footnoterule\@nameuse{mp at footgroup#1}\fi}
+  \g at addto@macro{\extrafeetminihook}{%
+    \@namedef{@mpfn#1}{mpfootnote#1}
+    \@namedef{thempfn#1}{\@nameuse{thempfootnote#1}}
+    \csname c at mpfootnote#1\endcsname\z@
+     \expandafter\let\expandafter\@t at mp \csname @mpfootnotetext#1\endcsname
+     \expandafter\let \csname @footnotetext#1\endcsname \@t at mp}
+  \g at addto@macro{\@mem at extranofeet}{%  % [RS]
+    \ifvoid\@nameuse{footins#1}\else\@mem at nofootfalse\fi}
+  \plainfootstyle{#1}%
+}
+
+\newcommand{\m at makefootnote}[1]{
+  \@namedef{footnote#1}{\@ifnextchar[
+    {\@nameuse{@xfootnote#1}}{%\advance \@nameuse{c@\@mpfn#1} by \@ne
+                              \stepcounter{\@mpfn#1}%
+      \@name at p@xdef{@thefnmark#1}{\@nameuse{thempfn#1}}%
+      \@nameuse{@footnotemark#1}\@nameuse{@footnotetext#1}}}}
+
+\newcommand{\m at make@xfootnote}[1]{
+  \@namedef{@xfootnote#1}[##1]{%
+  \begingroup
+    \csname c@\@mpfn#1\endcsname ##1\relax
+    \@name at unresp@xdef{@thefnmark#1}{\@nameuse{thempfn#1}}%
+  \endgroup
+  \@nameuse{@footnotemark#1}\@nameuse{@footnotetext#1}}}
+
+\newcommand{\m at make@footnotetext}[1]{%
+  \@namelongdef{@footnotetext#1}##1{%
+  \insert\@nameuse{footins#1}{%
+  \def\baselinestretch{\m at m@singlespace}%  <- v1.61803 addition
+  \reset at font\@nameuse{foottextfont#1}%
+  \@preamfntext
+  \hsize\columnwidth
+  \protected at edef\@currentlabel{%
+    \csname p at footnote#1\endcsname\@nameuse{@thefnmark#1}}%
+  \color at begingroup
+    \@nameuse{@makefntext#1}{%
+      \rule\z@\footnotesep\ignorespaces{\@nameuse{foottextfont#1}##1}% <- v1.6180339a
+      \@finalstrut\strutbox}%
+  \color at endgroup}%
+  \m at mmf@prepare}}
+
+\newcommand{\m at make@mpfootnotetext}[1]{%
+  \@namelongdef{@mpfootnotetext#1}##1{%
+    \global\setbox\@nameuse{@mpfootins#1}\vbox{%
+      \unvbox\@nameuse{@mpfootins#1}%
+      \def\baselinestretch{\m at m@singlespace}%  <- v1.61803 addition
+      \reset at font\@nameuse{foottextfont#1}%
+      \hsize\columnwidth \@parboxrestore
+      \protected at edef\@currentlabel{%
+        \csname p at mpfootnote#1\endcsname\@nameuse{@thefnmark#1}}%
+    \color at begingroup
+      \@nameuse{@makefntext#1}{%
+        \rule\z@\footnotesep\ignorespaces{\@nameuse{foottextfont#1}##1}% <- v1.6180339a
+        \@finalstrut\strutbox}%
+    \color at endgroup}%
+    \m at mmf@prepare}}
+
+\newcommand{\m at makefootnotemark}[1]{
+\@namedef{footnotemark#1}{%
+  \@ifnextchar[ {\@nameuse{@xfootnotemark#1}}
+    {%\advance\@nameuse{c at footnote#1} by \@ne%
+     \stepcounter{footnote#1}%
+     \@name at p@xdef{@thefnmark#1}{\@nameuse{thefootnote#1}}%
+     \@nameuse{@footnotemark#1}}}}
+
+\newcommand{\m at make@xfootnotemark}[1]{%
+  \@namedef{@xfootnotemark#1}[##1]{%
+  \begingroup
+    \@nameuse{c at footnote#1} ##1\relax
+    \@name at unresp@xdef{@thefnmark#1}{\@nameuse{thefootnote#1}}%
+  \endgroup
+  \@nameuse{@footnotemark#1}}}
+
+\newcommand{\m at make@footnotemark}[1]{%
+\@namedef{@footnotemark#1}{%
+  \leavevmode
+  \ifhmode
+    \edef\@x at sf{\the\spacefactor}%
+    \m at mmf@check
+    \nobreak
+  \fi
+  \@nameuse{@makefnmark#1}%
+  \m at mmf@prepare
+  \ifhmode\spacefactor\@x at sf\fi
+  \relax}}
+
+\newcommand{\m at makefootmarkstyle}[1]{%
+ \@namedef{footmarkstyle#1}##1{%
+    \@namedef{footscript#1}####1{##1}}}
+
+\newcommand{\m at makefootnotetext}[1]{%
+\@namedef{footnotetext#1}{%
+  \@ifnextchar[  {\@nameuse{@xfootnotenext#1}}%
+  {\@name at p@xdef{@thefnmark#1}{\@nameuse{thempfn#1}}%
+  \@nameuse{@footnotetext#1}}}}
+
+\newcommand{\m at make@xfootnotenext}[1]{
+\@namedef{@xfootnotenext#1}[##1]{%
+  \begingroup
+    \csname c@\@mpfn#1\endcsname ##1\relax
+    \@name at unresp@xdef{@thefnmark#1}{\@nameuse{thempfn#1}}%
+  \endgroup
+  \@nameuse{@footnotetext#1}}}
+
+\newcommand{\m at make@mpfn}[1]{%
+  \@namedef{@mpfn#1}{\@nameuse{footnote#1}}}
+
+\newcommand{\m at makethempfn}[1]{%
+  \@namedef{thempfn#1}{\@nameuse{thefootnote#1}}}
+
+\newcommand{\m at make@makefnmark}[1]{%
+  \@namedef{@makefnmark#1}{%
+    \hbox{\@textsuperscript{\normalfont\@nameuse{@thefnmark#1}}}}}
+
+\newcommand{\m at makefootref}[1]{%
+  \@namedef{footref#1}##1{%
+    \begingroup
+      \@name at unresp@xdef{@thefnmark#1}{\ref{##1}}%
+    \endgroup
+    \@nameuse{@footnotemark#1}}}
+
+\newcommand{\m at makefootfootmark}[1]{%
+  \@namedef{footfootmark#1}{%
+    \ifdim\footmarkwidth < \z@
+      \llap{\hb at xt@ -\footmarkwidth{%
+            \hss\normalfont\@nameuse{footscript#1}%
+            {\@nameuse{@thefnmark#1}}}%
+            \hspace*{-\footmarkwidth}}%
+    \else
+      \ifdim\footmarkwidth = \z@
+        {\normalfont\@nameuse{footscript#1}{\@nameuse{@thefnmark#1}}}%
+      \else
+        \hb at xt@\footmarkwidth{%
+            \hss\normalfont\@nameuse{footscript#1}%
+            {\@nameuse{@thefnmark#1}}}%
+      \fi
+    \fi}}
+
+\newcommand{\m at makemakefootmark}[1]{%
+  \@namedef{makefootmark#1}##1{%
+    \leavevmode
+    \parindent \footparindent\noindent
+    \leftskip\footmarksep\relax
+    \advance\leftskip \footmarkwidth
+    \null\nobreak\hskip -\leftskip\relax
+    \makefootmarkhook\relax
+    \@nameuse{footfootmark#1}##1}}
+
+\newcommand{\m at make@footgroup}[1]{%
+  \@namedef{@footgroup#1}{\unvbox\@nameuse{footins#1}}}
+
+\newcommand{\m at makemp@footgroup}[1]{%
+  \@namedef{mp at footgroup#1}{\unvbox\@nameuse{@mpfootins#1}}}
+
+\newcommand{\m at make@footstart}[1]{%
+  \@namedef{@footstart#1}{%
+    \vskip\bigskipamount
+    \if at RTL\rightskip\else\leftskip\fi=\z@
+    \if at RTL\leftskip\else\rightskip\fi=\z@
+    \footnoterule}}
+
+\newcommand{\plainfootstyle}[1]{%
+  \m at make@footnotetext{#1}%
+  \m at make@footgroup{#1}%
+  \m at make@footstart{#1}%
+  \m at make@mpfootnotetext{#1}%
+  \m at makemp@footgroup{#1}%
+  \@nameuse{footmarkstyle#1}{\textsuperscript{##1}}
+  \expandafter\dimen\csname footins#1\endcsname=\footinsdim
+  \expandafter\count\csname footins#1\endcsname=1000\relax}
+
+\newinsert\footinsv at r
+  \skip\footinsv at r\bigskipamount
+  \count\footinsv at r=1000 % no magnifcation
+  \dimen\footinsv at r=\footinsdim
+\m at make@footstart{v at r}
+\newcommand{\@footgroupv at r}{}
+
+\newinsert\@mpfootinsv at r
+\newcommand{\mp at footgroupv@r}{}
+
+\newcount\m at m@k \newdimen\m at m@h
+\newcommand*{\m at mrigidbalance}[3]{\setbox0=\box#1 \m at m@k=#2 \m at m@h=#3
+  \@@line{\splittopskip=\m at m@h \vbadness=\@M \hfilneg
+  \valign{##\vfill\cr\m at mdosplits}}}
+\newcommand*{\m at mdosplits}{\ifnum\m at m@k>0 \noalign{\hfil}\m at msplitoff
+  \global\advance\m at m@k-1\cr\m at mdosplits\fi}
+\newcommand*{\m at msplitoff}{\dimen0=\ht0
+  \divide\dimen0 by\m at m@k \advance\dimen0 by\m at m@h
+  \setbox2 \vsplit0 to \dimen0
+  \unvbox2 }
+
+\newcommand{\twocolumnfootnotes}{%
+  \@namedef{foottextfontv at r}{\foottextfont}%  % [RS]
+  \let\@footnotetext\@twocolfootnotetext
+  \dimen\footinsv at r=2\footinsdim
+  \count\footinsv at r=500\relax
+  \m at make@twocol at footgroup{v at r}%
+  \let\@footgroupv at r\@twocol at footgroupv@r
+  \let\@mpfootnotetext\@mptwocolfootnotetext
+  \m at make@mptwocol at footgroup{v at r}%
+  \let\mp at footgroupv@r\@mptwocol at footgroupv@r}
+
+\newcommand{\@twocolfootnotetext}[1]{\insert\footinsv at r{%
+  \def\baselinestretch{\m at m@singlespace}%   <- v1.61803 addition
+  \reset at font\foottextfont
+  \@preamfntext
+  \protected at edef\@currentlabel{%
+    \csname p at footnote\endcsname\@thefnmark}%
+  \color at begingroup
+    \@twocolfootfmt{#1}%
+  \color at endgroup}%
+  \m at mmf@prepare}
+
+\newcommand{\@preamtwofmt}{%
+  \hsize .45\hsize
+  \parindent=\z@
+  \tolerance=5000\relax
+  \raggedright
+  \leavevmode}
+
+\newcommand{\@twocolfootfmt}[1]{%
+  \@preamtwofmt
+  {\footfootmark\strut {\foottextfont #1}\strut\par}\allowbreak}
+
+\newcommand{\@mptwocolfootnotetext}[1]{%
+  \global\setbox\@mpfootinsv at r\vbox{%
+    \unvbox\@mpfootinsv at r
+    \def\baselinestretch{\m at m@singlespace}%    <- v1.61803 addition
+    \reset at font\foottextfont
+    \hsize\columnwidth \@parboxrestore
+    \protected at edef\@currentlabel{%
+      \csname p at mpfootnote\endcsname\@thefnmark}%
+  \color at begingroup
+    \@twocolfootfmt{#1}%
+  \color at endgroup}%
+  \m at mmf@prepare}
+
+\newcommand{\twocolumnfootstyle}[1]{%
+  \m at make@twocolfootnotetext{#1}%
+  \m at make@mptwocolfootnotetext{#1}%
+  \m at make@twocolfootfmt{#1}%
+  \m at make@twocol at footgroup{#1}%
+  \m at make@mptwocol at footgroup{#1}%
+  \m at make@footstart{#1}%
+  \@namelongdef{@footnotetext#1}##1{%
+     \@nameuse{@twocolfootnotetext#1}{##1}}%
+  \@namelongdef{@mpfootnotetext#1}##1{%
+     \@nameuse{@mptwocolfootnotetext#1}{##1}}%
+  \@namedef{@footgroup#1}{\@nameuse{@twocol at footgroup#1}}%
+  \@namedef{mp at footgroup#1}{\@nameuse{@mptwocol at footgroup#1}}%
+  \expandafter\dimen\csname footins#1\endcsname=2\footinsdim
+  \expandafter\count\csname footins#1\endcsname=500\relax}
+
+\newcommand{\m at make@twocolfootnotetext}[1]{%
+  \@namelongdef{@twocolfootnotetext#1}##1{%
+    \insert\@nameuse{footins#1}{%
+    \def\baselinestretch{\m at m@singlespace}%   <- v1.61803 addition
+    \reset at font\@nameuse{foottextfont#1}%
+    \@preamfntext
+    \protected at edef\@currentlabel{%
+      \csname p at footnote#1\endcsname \@nameuse{@thefnmark#1}}%
+    \color at begingroup
+      \@nameuse{@twocolfootfmt#1}{##1}%
+    \color at endgroup}%
+    \m at mmf@prepare}}
+
+\newcommand{\m at make@mptwocolfootnotetext}[1]{%
+\@namelongdef{@mptwocolfootnotetext#1}##1{%
+  \global\setbox\@nameuse{@mpfootins#1}\vbox{%
+    \unvbox\@nameuse{@mpfootins#1}
+    \def\baselinestretch{\m at m@singlespace}%   <- v1.61803 addition
+    \reset at font\@nameuse{foottextfont#1}%
+    \hsize\columnwidth \@parboxrestore
+    \protected at edef\@currentlabel{%
+      \csname p at mpfootnote#1\endcsname\@nameuse{@thefnmark#1}}%
+  \color at begingroup
+    \@nameuse{@twocolfootfmt#1}{##1}%
+  \color at endgroup}\m at mmf@prepare}}
+
+\newcommand{\m at make@twocolfootfmt}[1]{%
+  \@namedef{@twocolfootfmt#1}##1{%
+    \@preamtwofmt
+    {\@nameuse{footfootmark#1}\strut
+     {\@nameuse{foottextfont#1}##1}\strut\par}\allowbreak}}
+
+\newcommand{\m at make@twocol at footgroup}[1]{%
+  \@namedef{@twocol at footgroup#1}{{%
+    \@nameuse{foottextfont#1} \splittopskip=\ht\strutbox
+     \m at mrigidbalance{\@nameuse{footins#1}}{\tw@}{\splittopskip}}}}
+
+\newcommand{\m at make@mptwocol at footgroup}[1]{%
+\@namedef{@mptwocol at footgroup#1}{{%
+  \@nameuse{foottextfont#1} \splittopskip=\ht\strutbox
+  \m at mrigidbalance{\@nameuse{@mpfootins#1}}{\tw@}{\splittopskip}}}}
+
+\newcommand{\threecolumnfootnotes}{%
+  \@namedef{foottextfontv at r}{\foottextfont}%  % [RS]
+  \let\@footnotetext\@threecolfootnotetext
+  \dimen\footinsv at r=3\footinsdim
+  \count\footinsv at r=333\relax
+  \m at make@threecol at footgroup{v at r}%
+  \let\@footgroupv at r\@threecol at footgroupv@r
+  \let\@mpfootnotetext\@mpthreecolfootnotetext
+  \m at make@mpthreecol at footgroup{v at r}%
+  \let\mp at footgroupv@r\@mpthreecol at footgroupv@r}
+
+\newcommand{\@threecolfootnotetext}[1]{\insert\footinsv at r{%
+  \def\baselinestretch{\m at m@singlespace}%   <- v1.61803 addition
+  \reset at font\foottextfont
+  \@preamfntext
+  \protected at edef\@currentlabel{%
+    \csname p at footnote\endcsname\@thefnmark}%
+  \color at begingroup
+    \@threecolfootfmt{#1}%
+  \color at endgroup}\m at mmf@prepare}
+
+\newcommand{\@preamthreefmt}{%
+  \hsize .3\hsize
+  \parindent=\z@
+  \tolerance=5000\relax
+  \raggedright
+  \leavevmode}
+
+\newcommand{\@threecolfootfmt}[1]{%
+  \@preamthreefmt
+  {\footfootmark\strut {\foottextfont #1}\strut\par}\allowbreak}
+
+\newcommand{\@mpthreecolfootnotetext}[1]{%
+  \global\setbox\@mpfootinsv at r\vbox{%
+    \unvbox\@mpfootinsv at r
+    \def\baselinestretch{\m at m@singlespace}%   <- v1.61803 addition
+    \reset at font\foottextfont
+    \hsize\columnwidth \@parboxrestore
+    \protected at edef\@currentlabel{%
+      \csname p at mpfootnote\endcsname\@thefnmark}%
+  \color at begingroup
+    \@threecolfootfmt{#1}%
+  \color at endgroup}\m at mmf@prepare}
+
+\newcommand{\threecolumnfootstyle}[1]{%
+  \m at make@threecolfootnotetext{#1}%
+  \m at make@mpthreecolfootnotetext{#1}%
+  \m at make@threecolfootfmt{#1}%
+  \m at make@threecol at footgroup{#1}%
+  \m at make@mpthreecol at footgroup{#1}%
+  \m at make@footstart{#1}%
+  \@namelongdef{@footnotetext#1}##1{%
+    \@nameuse{@threecolfootnotetext#1}{##1}}%
+  \@namelongdef{@mpfootnotetext#1}##1{%
+    \@nameuse{@mpthreecolfootnotetext#1}{##1}}%
+  \@namedef{@footgroup#1}{\@nameuse{@threecol at footgroup#1}}%
+  \@namedef{mp at footgroup#1}{\@nameuse{@mpthreecol at footgroup#1}}%
+  \expandafter\dimen\csname footins#1\endcsname=3\footinsdim
+  \expandafter\count\csname footins#1\endcsname=333\relax}
+
+\newcommand{\m at make@threecolfootnotetext}[1]{%
+\@namelongdef{@threecolfootnotetext#1}##1{%
+  \insert\@nameuse{footins#1}{%
+  \def\baselinestretch{\m at m@singlespace}%   <- v1.61803 addition
+  \reset at font\@nameuse{foottextfont#1}%
+  \@preamfntext
+  \protected at edef\@currentlabel{%
+    \csname p at footnote#1\endcsname \@nameuse{@thefnmark#1}}%
+  \color at begingroup
+    \@nameuse{@threecolfootfmt#1}{##1}%
+  \color at endgroup}\m at mmf@prepare}}
+
+\newcommand{\m at make@mpthreecolfootnotetext}[1]{%
+\@namelongdef{@mpthreecolfootnotetext#1}##1{%
+  \global\setbox\@nameuse{@mpfootins#1}\vbox{%
+    \unvbox\@nameuse{@mpfootins#1}
+    \def\baselinestretch{\m at m@singlespace}%   <- v1.61803 addition
+    \reset at font\@nameuse{foottextfont#1}%
+    \hsize\columnwidth \@parboxrestore
+    \protected at edef\@currentlabel{%
+      \csname p at mpfootnote#1\endcsname\@nameuse{@thefnmark#1}}%
+  \color at begingroup
+    \@nameuse{@threecolfootfmt#1}{##1}%
+  \color at endgroup}\m at mmf@prepare}}
+
+\newcommand{\m at make@threecolfootfmt}[1]{%
+\@namelongdef{@threecolfootfmt#1}##1{%
+  \@preamthreefmt
+  {\@nameuse{footfootmark#1}\strut
+   {\@nameuse{foottextfont#1}##1}\strut\par}\allowbreak}}
+
+\newcommand{\m at make@threecol at footgroup}[1]{%
+\@namedef{@threecol at footgroup#1}{{%
+  \@nameuse{foottextfont#1} \splittopskip=\ht\strutbox
+  \m at mrigidbalance{\@nameuse{footins#1}}{\thr@@}{\splittopskip}}}}
+
+\newcommand{\m at make@mpthreecol at footgroup}[1]{%
+\@namedef{@mpthreecol at footgroup#1}{{%
+  \@nameuse{foottextfont#1} \splittopskip=\ht\strutbox
+  \m at mrigidbalance{\@nameuse{@mpfootins#1}}{\thr@@}{\splittopskip}}}}
+
+\newcommand{\m at munvxh}[1]{%
+  \setbox0=\vbox{\unvbox#1%
+    \global\setbox1=\lastbox}%
+  \unhbox1
+  \unskip
+  \unskip
+  \unpenalty
+  \hskip\m at mipn@skip}
+
+\newcommand{\m at mungebox}{%
+  \setbox0=\hbox{\m at munvxh0}%
+  \dp0=\z@
+  \ht0=\footfudgefactor\wd0
+  \box0
+  \penalty0}
+
+\newskip\m at mipn@skip
+\newcommand*{\m at minterparanoteglue}[1]{%
+  {\foottextfont\global\m at mipn@skip=#1\relax}}
+\m at minterparanoteglue{1em plus.4em minus.4em}
+
+\newcommand*{\m at mmakehboxofhboxes}{\setbox0=\hbox{}%
+  \loop
+    \unpenalty
+    \setbox2=\lastbox
+  \ifhbox2
+    \setbox0=\hbox{\box2\unhbox0}
+  \repeat}
+
+\newcommand*{\m at mremovehboxes}{\setbox0=\lastbox
+  \ifhbox0{\m at mremovehboxes}\unhbox0 \fi}
+
+\newcommand*{\footfudgefiddle}{64}
+
+\newcommand{\paragraphfootnotes}{%
+  \@namedef{foottextfontv at r}{\foottextfont}%  % [RS]
+  \let\@footnotetext\@parafootnotetext
+  \dimen\footinsv at r=\footinsdim
+  \count\footinsv at r=1000\relax
+  \m at make@para at footgroup{v at r}%
+  \let\@footgroupv at r\@para at footgroupv@r
+  \let\@mpfootnotetext\@mpparafootnotetext
+  \m at make@mppara at footgroup{v at r}%
+  \let\mp at footgroupv@r\@mppara at footgroupv@r
+  {\foottextfont
+   \dimen0=\baselineskip
+   \multiply\dimen0 by 1024
+   \divide\dimen0 by \hsize \multiply\dimen0 by \footfudgefiddle
+   \xdef\footfudgefactor{\expandafter\strip at pt\dimen0 }}}
+
+\newcommand{\@parafootnotetext}[1]{\insert\footinsv at r{
+  \def\baselinestretch{\m at m@singlespace}%   <- v1.61803 addition
+  \reset at font\foottextfont
+  \@preamfntext
+  \protected at edef\@currentlabel{%
+    \csname p at footnote\endcsname\@thefnmark}%
+  \setbox0=\vbox{\hsize=\maxdimen
+    \color at begingroup
+      \noindent \@parafootfmt{#1}%
+    \color at endgroup}%
+  \m at mungebox}\m at mmf@prepare}
+
+\newcommand{\@parafootfmt}[1]{%
+  \parindent=\z@
+  \parfillskip=0pt \@plus 1fil
+  {\footfootmark\strut {\foottextfont #1}\penalty-10}}
+
+\newcommand{\@mpparafootnotetext}[1]{%
+  \global\setbox\@mpfootinsv at r\vbox{%
+    \unvbox\@mpfootinsv at r
+    \def\baselinestretch{\m at m@singlespace}%   <- v1.61803 addition
+    \reset at font\foottextfont
+    \hsize\columnwidth \@parboxrestore
+    \protected at edef\@currentlabel{%
+      \csname p at mpfootnote\endcsname\@thefnmark}%
+    \setbox0=\vbox{\hsize=\maxdimen
+      \color at begingroup
+      \noindent \@parafootfmt{#1}%
+      \color at endgroup}%
+  \m at mungebox}\m at mmf@prepare}
+
+\newcommand{\paragraphfootstyle}[1]{%
+  \m at make@parafootnotetext{#1}%
+  \m at make@mpparafootnotetext{#1}%
+  \m at make@parafootfmt{#1}%
+  \m at make@para at footgroup{#1}%
+  \m at make@mppara at footgroup{#1}%
+  \m at make@para at footstart{#1}%
+  \@namelongdef{@footnotetext#1}##1{%
+    \@nameuse{@parafootnotetext#1}{##1}}%
+  \@namelongdef{@mpfootnotetext#1}##1{%
+    \@nameuse{@mpparafootnotetext#1}{##1}}%
+  \@namedef{@footgroup#1}{\@nameuse{@para at footgroup#1}}%
+  \@namedef{mp at footgroup#1}{\@nameuse{@mppara at footgroup#1}}%
+  \@namedef{@footstart#1}{\@nameuse{@para at footstart#1}}%
+  \expandafter\dimen\csname footins#1\endcsname=\footinsdim
+  \expandafter\count\csname footins#1\endcsname=1000\relax
+  {\@nameuse{foottextfont#1}%
+   \dimen0=\baselineskip
+   \multiply\dimen0 by 1024
+   \divide\dimen0 by \hsize \multiply\dimen0 by 64
+   \xdef\footfudgefactor{\expandafter\strip at pt\dimen0 }}}
+
+\newcommand{\m at make@parafootnotetext}[1]{%
+\@namelongdef{@parafootnotetext#1}##1{%
+  \insert\@nameuse{footins#1}{
+  \def\baselinestretch{\m at m@singlespace}%   <- v1.61803 addition
+  \reset at font\@nameuse{foottextfont#1}%
+  \@preamfntext
+  \protected at edef\@currentlabel{%
+    \csname p at footnote#1\endcsname \@nameuse{@thefnmark#1}}%
+  \setbox0=\vbox{\hsize=\maxdimen
+    \color at begingroup
+      \noindent \@nameuse{@parafootfmt#1}{##1}%
+    \color at endgroup}%
+  \m at mungebox}\m at mmf@prepare}}
+
+\newcommand{\m at make@mpparafootnotetext}[1]{%
+\@namelongdef{@mpparafootnotetext#1}##1{%
+  \global\setbox\@nameuse{@mpfootins#1}\vbox{%
+    \unvbox\@nameuse{@mpfootins#1}
+    \def\baselinestretch{\m at m@singlespace}%   <- v1.61803 addition
+    \reset at font\@nameuse{foottextfont#1}%
+    \hsize\columnwidth \@parboxrestore
+    \protected at edef\@currentlabel{%
+      \csname p at mpfootnote#1\endcsname\@nameuse{@thefnmark#1}}%
+    \setbox0=\vbox{\hsize=\maxdimen
+      \color at begingroup
+        \noindent \@nameuse{@parafootfmt#1}{##1}%
+      \color at endgroup}%
+    \m at mungebox}\m at mmf@prepare}}
+
+\newcommand{\m at make@parafootfmt}[1]{%
+\@namelongdef{@parafootfmt#1}##1{%
+  \parindent=\z@
+  \parfillskip=0pt \@plus 1fil
+  {\@nameuse{footfootmark#1}\strut
+   {\@nameuse{foottextfont#1}##1}\penalty-10}}}
+
+\newcommand{\m at make@para at footgroup}[1]{%
+\@namedef{@para at footgroup#1}{%
+  \unvbox\@nameuse{footins#1}
+  \m at mmakehboxofhboxes
+  \setbox0=\hbox{\unhbox0 \m at mremovehboxes}%
+  \@nameuse{foottextfont#1}%
+  \noindent\unhbox0\par}}
+
+\newcommand{\m at make@mppara at footgroup}[1]{%
+\@namedef{@mppara at footgroup#1}{%
+  \unvbox\@nameuse{@mpfootins#1}
+  \m at mmakehboxofhboxes
+  \setbox0=\hbox{\unhbox0 \m at mremovehboxes}%
+  \@nameuse{foottextfont#1}%
+  \noindent\unhbox0\par}}
+
+\newcommand{\m at make@para at footstart}[1]{%
+\@namedef{@para at footstart#1}{%
+  \vskip\bigskipamount
+  \if at RTL\rightskip\else\leftskip\fi=\z@
+  \if at RTL\leftskip\else\rightskip\fi=\z@
+  \parindent=\z@
+  \vskip\skip\@nameuse{footins#1}%
+  \footnoterule}}
+
+\newif\if at mem@nofoot
+\newcommand*{\@mem at testifnofoot}{%
+  \@mem at nofoottrue
+  \ifvoid\footins\else\@mem at nofootfalse\fi
+  \ifvoid\footinsv at r\else\@mem at nofootfalse\fi
+  \ifvoid\sideins\else\@mem at nofootfalse\fi
+  \@mem at extranofeet}
+\newcommand*{\@mem at extranofeet}{}
+
+\let\memold at doclearpage\@doclearpage
+\newcommand{\mem at doclearpage}{%
+  \@mem at testifnofoot
+  \if at mem@nofoot
+    \setbox\@tempboxa\vsplit\@cclv to\z@ \unvbox\@tempboxa
+    \setbox\@tempboxa\box\@cclv
+    \xdef\@deferlist{\@toplist\@botlist\@deferlist}%
+    \global\let\@toplist\@empty
+    \global\let\@botlist\@empty
+    \global\@colroom\@colht
+    \ifx \@currlist\@empty
+    \else
+      \@latexerr{Float(s) lost}\@ehb
+      \global\let\@currlist\@empty
+    \fi
+    \@makefcolumn\@deferlist
+    \@whilesw\if at fcolmade \fi{\@opcol\@makefcolumn\@deferlist}%
+    \if at twocolumn
+      \if at firstcolumn
+        \xdef\@dbldeferlist{\@dbltoplist\@dbldeferlist}%
+        \global\let\@dbltoplist\@empty
+        \global\@colht\textheight
+        \begingroup
+          \@dblfloatplacement
+          \@makefcolumn\@dbldeferlist
+          \@whilesw\if at fcolmade \fi{\@outputpage
+                                    \@makefcolumn\@dbldeferlist}%
+        \endgroup
+      \else
+        \vbox{}\clearpage
+      \fi
+    \fi
+  \else
+    \setbox\@cclv\vbox{\box\@cclv\vfil}%
+    \@makecol\@opcol
+    \clearpage
+  \fi}
+\gdef\@doclearpage{\mem at doclearpage}
+
+\newcommand*{\m at m@makecolfloats}{%
+  \xdef\@freelist{\@freelist\@midlist}%
+  \global\let\@midlist\@empty
+  \@combinefloats}
+\newcommand*{\m at m@makecoltext}{%
+  \ifvbox\@kludgeins
+    \@makespecialcolbox
+  \else
+    \setbox\@outputbox \vbox to\@colht{%
+      \@texttop
+      \dimen@ \dp\@outputbox
+      \unvbox \@outputbox
+      \vskip -\dimen@
+      \@textbottom}%
+  \fi}
+
+\newcommand*{\m at m@makecolintro}{}
+
+\newcommand*{\m at mopfootnote}{\setbox\@outputbox \vbox{%
+  \boxmaxdepth\@maxdepth
+  \@tempdima\dp\@cclv
+  \unvbox\@cclv
+  \vskip-\@tempdima
+  \vskip \skip\footins
+  \color at begingroup
+    \normalcolor
+    \footnoterule
+    \unvbox \footins
+  \color at endgroup}}
+
+\newcommand*{\m at mopfootnotebf}{%
+  \setbox\@outputbox \vbox{%
+  \boxmaxdepth\@maxdepth
+  \unvbox\@outputbox
+  \vskip\skip\footins
+  \color at begingroup
+    \normalcolor
+    \footnoterule
+    \unvbox \footins
+  \color at endgroup}}
+
+\newcommand*{\m at mopsidebar}{%
+  \ifvoid\sideins\else
+    \setbox\@outputbox \vbox{%
+      \sidecontents
+      \unvbox\@outputbox}
+  \fi}
+
+\gdef\mem at makecol{%
+  \m at m@makecolintro
+  \ifvoid\footins
+    \setbox\@outputbox \box\@cclv
+  \else
+    \m at mopfootnote
+  \fi
+  \m at mdoextrafeet
+  \m at m@makecolfloats
+  \m at mopsidebar
+  \m at m@makecoltext
+  \global \maxdepth \@maxdepth}
+
+\gdef\mem at makecolbf{%
+  \m at m@makecolintro
+  \setbox\@outputbox \box\@cclv
+  \m at m@makecolfloats
+  \ifvoid\footins\else
+    \m at mopfootnotebf
+  \fi
+  \m at mdoextrafeet
+  \m at mopsidebar
+  \m at m@makecoltext
+  \global\maxdepth \@maxdepth}
+
+\gdef\mem at makecoldblf{%
+  \m at m@makecolintro
+  \setbox\@outputbox \box\@cclv
+  \m at m@makecolfloats
+  \m at mopsidebar%    <- added
+  \ifvoid\footins
+  \else
+    \m at mopfootnote
+  \fi
+  \m at mdoextrafeet
+  \m at m@makecoltext
+  \global \maxdepth \@maxdepth}
+
+\newcommand{\feetabovefloat}{\gdef\@makecol{\mem at makecol}}
+\newcommand{\feetbelowfloat}{\gdef\@makecol{\mem at makecolbf}}
+\feetabovefloat
+
+\gdef\@reinserts{%
+  \ifvoid\footins\else\insert\footins{\unvbox\footins}\fi
+  \m at mdodoreinextrafeet
+  \ifvbox\@kludgeins\insert\@kludgeins{\unvbox\@kludgeins}\fi
+  \ifvoid\sideins\else\insert\sideins{\unvbox\sideins}\fi}
+
+\newif\ifm at mpnpageopt
+  \m at mpnpageoptfalse
+\newif\ifm at mpncontopt
+  \m at mpncontoptfalse
+\newcounter{pagenote}[chapter]
+\renewcommand{\thepagenote}{\arabic{pagenote}}
+\setcounter{pagenote}{0}
+
+\newcommand*{\notepageref}{\m at mpnpageopttrue}
+\@onlypreamble\notepageref
+\newcommand*{\continuousnotenums}{%
+  \counterwithout{pagenote}{chapter}
+  \renewcommand{\thepagenote}{\arabic{pagenote}}}
+\@onlypreamble\continuousnotenums
+
+\newif\ifmempagenotes
+  \mempagenotesfalse
+
+\newcommand*{\makepagenote}{%
+  \newwrite\@notefile
+  \immediate\openout\@notefile=\jobname.ent
+  \mempagenotestrue
+  \def\pagenote{\@bsphack\begingroup
+    \@sanitize
+    \m at m@wrpnote}%
+  \typeout{Writing note file \jobname.ent}%
+  \let\makepagenote\@empty}
+
+\newcommand{\immediate at protected@write}[3]{%
+  \begingroup
+  #2%
+  \let\protect\@unexpandable at protect
+  \edef\reserved at a{\immediate\write#1{#3}}%
+  \reserved at a
+  \endgroup
+  \if at nobreak\ifvmode\nobreak\fi\fi}
+
+\let\m at m@pnwrite\immediate at protected@write
+\AtBeginDocument{%
+  \ifm at mpnpageopt
+    \let\m at m@pnwrite\protected at write
+  \fi}
+
+\newcommand*{\pnchap}{\f at rtoc}
+\newcommand*{\pnschap}{\f at rbdy}
+
+\newcommand{\m at m@wrpnote}[2][]{%
+  \@ifmtarg{#1}{\refstepcounter{pagenote}%
+                \notenumintext{\thepagenote}}{}%
+  \ifm at mpn@new at chap
+    \global\m at mpn@new at chapfalse
+    \addtonotes{\string\pagenotesubhead{\@chapapp}{\thechapter}{\pnchap}}%
+  \fi
+  \ifm at mpn@new at schap
+    \global\m at mpn@new at schapfalse
+    \addtonotes{\string\pagenotesubhead{\@chapapp}{}{\pnschap}}%
+  \fi
+  \m at m@pnwrite\@notefile{}
+    {\string\noteentry{\thepagenote}{#1}{#2}{\thepage}}%
+  \endgroup
+  \@esphack}
+
+\def\pagenote{\@bsphack\begingroup \@sanitize\m at m@pagenote}
+\newcommand{\m at m@pagenote}[2][]{\endgroup\@esphack}
+
+\newcommand*{\pagetofootnote}{%
+  \let\memsavepagenote\pagenote
+  \renewcommand{\pagenote}[2][]{\footnote{##2}}}
+\newcommand*{\foottopagenote}{%
+  \let\memsavefootnote\footnote
+  \renewcommand*{\footnote}[2][]{\pagenote{##2}}}
+
+\newcommand{\addtonotes}[1]{\ifmempagenotes
+ \IfFileExists{\jobname.ent}{\m at m@pnwrite\@notefile{}{#1}}{\mempnofilewarn}%
+\fi}
+
+\newcommand{\notenumintext}[1]{%
+  \textsuperscript{#1}}
+\newcommand{\notenuminnotes}[1]{%
+  {\normalfont #1.}\space}
+\newcommand{\noteentry}[4]{%
+  \prenoteinnotes
+  \noteidinnotes{#1}{#2}\pageinnotes{#4}\noteinnotes{#3}%
+  \postnoteinnotes}
+
+\newcommand{\idtextinnotes}[1]{%
+  [#1]\space}
+\newcommand{\noteidinnotes}[2]{%
+  \@ifmtarg{#2}{%
+    \notenuminnotes{#1}}{\idtextinnotes{#2}}}
+\newcommand{\pageinnotes}[1]{%
+  \ifm at mpnpageopt \printpageinnotes{#1}\fi}
+\newcommand*{\printpageinnotes}[1]{%
+  (\pagerefname\ #1)\space}
+\newcommand{\noteinnotes}[1]{#1}
+
+\newcommand{\prenoteinnotes}{\par\noindent}
+\newcommand{\postnoteinnotes}{\par}
+
+\providecommand*{\notesname}{Notes}
+\newcommand*{\notedivision}{\chapter{\notesname}}
+
+\newcommand*{\printpagenotes}{\@ifstar{\@sprintpagenotes}{\@printpagenotes}}
+\newcommand*{\mempnofilewarn}{%
+  \ClassWarning{bidimemoir}{There is no .ent file}}
+
+\newcommand*{\@sprintpagenotes}{%
+  \ifmempagenotes
+  \notedivision
+\IfFileExists{\jobname.ent}{%
+  \immediate\closeout\@notefile
+  \input{\jobname.ent}%
+  \immediate\openout\@notefile=\jobname.ent%
+  }{%
+  \mempnofilewarn
+}%
+\fi}
+
+\newcommand*{\@printpagenotes}{%
+  \ifmempagenotes
+    \notedivision
+    \IfFileExists{\jobname.ent}{%
+      \immediate\closeout\@notefile
+      \input{\jobname.ent}%
+     }{%
+       \mempnofilewarn
+     }
+  \fi}
+
+\newcommand*{\pagenotesubhead}[3]{%
+  \section*{#1 #2 #3}}
+
+\newif\ifchangemarks\changemarksfalse
+\newcommand*{\changemarks}{\changemarkstrue}
+\newcommand*{\nochangemarks}{\changemarksfalse}
+
+\newcommand{\v at rid}[2]{%
+  \@bsphack
+  \ifchangemarks
+     \ifdraftdoc
+       \marginpar[#1]{#2}%
+  \fi\fi
+  \@esphack}
+
+\newcommand{\added}[1]{%
+  \@bsphack
+  \ifchangemarks
+    \v at rid{\small$\oplus$ #1}{\small$\oplus$ #1}%
+  \fi
+  \@esphack}
+\newcommand{\deleted}[1]{%
+  \@bsphack
+  \ifchangemarks
+    \v at rid{\small$\neq$ #1}{\small$\neq$ #1}%
+  \fi
+  \@esphack}
+\newcommand{\changed}[1]{%
+  \@bsphack
+  \ifchangemarks
+    \v at rid{\small$\Leftrightarrow$ #1}{\small$\Leftrightarrow$ #1}%
+  \fi
+  \@esphack}
+
+\newcommand*{\showtrimsoff}{\showtrimsfalse}
+\newcommand*{\showtrimson}{\showtrimstrue}
+
+\newcommand*{\trimmark}{%
+  \begin{picture}(0,0)
+    \unitlength 1cm
+    \thinlines
+    \put(-2,0){\line(1,0){4}}
+    \put(0,-2){\line(0,1){4}}
+  \end{picture}}
+
+\newcommand*{\Ltrimpictl}{%
+  \begin{picture}(0,0)
+    \unitlength 1mm
+    \thinlines
+    \put(-2,0){\line(-1,0){18}}
+    \put(0,2){\line(0,1){18}}
+  \end{picture}}
+\newcommand*{\Ltrimpictr}{%
+  \begin{picture}(0,0)
+    \unitlength 1mm
+    \thinlines
+    \put(2,0){\line(1,0){18}}
+    \put(0,2){\line(0,1){18}}
+  \end{picture}}
+\newcommand*{\Ltrimpicbl}{%
+  \begin{picture}(0,0)
+    \unitlength 1mm
+    \thinlines
+    \put(-2,0){\line(-1,0){18}}
+    \put(0,-2){\line(0,-1){18}}
+  \end{picture}}
+\newcommand*{\Ltrimpicbr}{%
+  \begin{picture}(0,0)
+    \unitlength 1mm
+    \thinlines
+    \put(2,0){\line(1,0){18}}
+    \put(0,-2){\line(0,-1){18}}
+  \end{picture}}
+
+\newcommand*{\Ftrimpicbl}{%
+  \begin{picture}(0,0)
+    \unitlength 1pt
+    \thinlines
+    \put(0,0){\framebox(\strip at pt\paperwidth,\strip at pt\paperheight){}}
+  \end{picture}}
+
+\newcommand*{\tmarktl}{\trimmark}
+\newcommand*{\tmarktr}{\trimmark}
+\newcommand*{\tmarkbl}{\trimmark}
+\newcommand*{\tmarkbr}{\trimmark}
+
+\newcommand*{\tmarktm}{}
+\newcommand*{\tmarkml}{}
+\newcommand*{\tmarkmr}{}
+\newcommand*{\tmarkbm}{}
+
+\newcommand*{\trimXmarks}{%
+  \let\tmarktl\trimmark
+  \let\tmarktr\trimmark
+  \let\tmarkbl\trimmark
+  \let\tmarkbr\trimmark}
+\newcommand*{\trimLmarks}{%
+  \let\tmarktl\Ltrimpictl
+  \let\tmarktr\Ltrimpictr
+  \let\tmarkbl\Ltrimpicbl
+  \let\tmarkbr\Ltrimpicbr}
+\newcommand*{\trimFrame}{%
+  \let\tmarktl\null
+  \let\tmarktr\null
+  \let\tmarkbl\Ftrimpicbl
+  \let\tmarkbr\null}
+\newcommand*{\trimNone}{%
+  \let\tmarktl\relax
+  \let\tmarktr\relax
+  \let\tmarkbl\relax
+  \let\tmarkbr\relax
+  \let\tmarktm\relax
+  \let\tmarkml\relax
+  \let\tmarkmr\relax
+  \let\tmarkbm\relax}
+
+\newcommand*{\trimmarks}{%
+  \vbox to \z@{\vskip-1in \vskip\trimtop % top of logical page
+    \hb at xt@\z@{\hskip-1in
+      \ifodd\c at page
+        \hskip\stockwidth \hskip-\trimedge \hskip-\paperwidth
+      \else
+        \if at twoside
+          \hskip\trimedge  % left of logical page
+        \else
+          \hskip\stockwidth \hskip-\trimedge \hskip-\paperwidth
+        \fi
+      \fi
+      \vbox to \paperheight{%
+        \let\protect\relax        % <- v1.4 addition
+        \hb at xt@\paperwidth{\tmarktl\hfil\tmarktm\hfil\tmarktr}%
+        \vfil
+        \hb at xt@\paperwidth{\tmarkml\hfil\tmarkmr}%
+        \vfil
+        \hb at xt@\paperwidth{\tmarkbl\hfil\tmarkbm\hfil\tmarkbr}}%
+    \hss}%
+  \vss}}
+
+\newcommand*{\registrationColour}[1]{#1}
+\newcommand*{\quarkmarks}{%
+\renewcommand*{\tmarktl}{\registrationColour{%
+  \begin{picture}(0,0)
+    \setlength{\unitlength}{1bp}\thicklines
+    \put(-36,0){\line(1,0){24}}
+    \put(0,12){\line(0,1){24}}
+    \put(3,27){\ttfamily\fontsize{8bp}{10bp}\selectfont\jobname\ \
+      \today\ \ \printtime\ \ Page \thepage}
+  \end{picture}}}
+\renewcommand*{\tmarktm}{\registrationColour{%
+  \begin{picture}(0,0)
+    \setlength{\unitlength}{1bp}\thicklines
+    \put(-24,24){\line(1,0){48}}
+    \put(0,12){\line(0,1){24}}
+    \put(0,24){\oval(12,12)}
+  \end{picture}}}
+\renewcommand*{\tmarktr}{\registrationColour{%
+  \begin{picture}(0,0)
+    \setlength{\unitlength}{1bp}\thicklines
+    \put(12,0){\line(1,0){24}}
+    \put(0,12){\line(0,1){24}}
+  \end{picture}}}
+\renewcommand*{\tmarkmr}{\registrationColour{%
+  \begin{picture}(0,0)
+    \setlength{\unitlength}{1bp}\thicklines
+    \put(12,0){\line(1,0){24}}
+    \put(24,-24){\line(0,1){48}}
+    \put(24,0){\oval(12,12)}
+  \end{picture}}}
+\renewcommand*{\tmarkbr}{\registrationColour{%
+  \begin{picture}(0,0)
+    \setlength{\unitlength}{1bp}\thicklines
+    \put(12,0){\line(1,0){24}}
+    \put(0,-36){\line(0,1){24}}
+  \end{picture}}}
+\renewcommand*{\tmarkbm}{\registrationColour{%
+  \begin{picture}(0,0)
+    \setlength{\unitlength}{1bp}\thicklines
+    \put(-24,-24){\line(1,0){48}}
+    \put(0,-36){\line(0,1){24}}
+    \put(0,-24){\oval(12,12)}
+  \end{picture}}}
+\renewcommand*{\tmarkbl}{\registrationColour{%
+  \begin{picture}(0,0)
+    \setlength{\unitlength}{1bp}\thicklines
+    \put(-36,0){\line(1,0){24}}
+    \put(0,-36){\line(0,1){24}}
+  \end{picture}}}
+\renewcommand*{\tmarkml}{\registrationColour{%
+  \begin{picture}(0,0)
+    \setlength{\unitlength}{1bp}\thicklines
+    \put(-36,0){\line(1,0){24}}
+    \put(-24,-24){\line(0,1){48}}
+    \put(-24,0){\oval(12,12)}
+  \end{picture}}}
+\renewcommand*{\trimmarks}{%
+%%  \special{papersize=\the\stockwidth,\the\stockheight}
+  {%
+  \vbox to \z@{\vskip-1in \vskip\trimtop % top of logical page
+    \hb at xt@\z@{\hskip-1in
+      \ifodd\c at page
+        \hskip\stockwidth \hskip-\trimedge \hskip-\paperwidth
+      \else
+        \if at twoside
+          \hskip\trimedge % left of logical page
+        \else
+          \hskip\stockwidth \hsip-\trimedge \hskip-\paperwidth
+        \fi
+      \fi
+      \vbox to \paperheight{%
+        \let\protect\relax %      <- v1.4 addition
+        \hb at xt@\paperwidth{\tmarktl\hfil\tmarktm\hfil\tmarktr}%
+        \vfil
+        \hb at xt@\paperwidth{\tmarkml\hfil\tmarkmr}%
+        \vfil
+        \hb at xt@\paperwidth{\tmarkbl\hfil\tmarkbm\hfil\tmarkbr}}%
+      \hss}%
+    \vss}}%
+}}
+
+\let\mem at oldshipout\shipout
+\newcommand*{\mem at shipi}{%
+  \ifvoid\@cclv\expandafter\aftergroup\fi\mem at shipii}
+\newcommand*\mem at shipii{%
+  \ifvoid\@cclv
+    \mem at oldshipout\box\@cclv
+  \else
+    \ifshowtrims
+      \mem at oldshipout\vbox{\trimmarks\unvbox\@cclv}%
+    \else
+      \mem at oldshipout\box\@cclv
+    \fi
+  \fi}
+\ifshowtrims
+  \renewcommand*{\shipout}{\afterassignment\mem at shipi\setbox\@cclv=}
+\fi
+
+\newtoks\every at verbatim
+  \every at verbatim={}
+\newtoks\afterevery at verbatim
+  \afterevery at verbatim={}
+
+\def\@makeother#1{\catcode`#112\relax}
+\begingroup
+ \catcode`\ =\active%
+ \def\x{\def\@vobeyspaces{\catcode`\ \active\let \@xobeysp}}
+ \expandafter\endgroup\x
+\def\@xobeysp{\leavevmode\penalty\@M\ }
+\newtoks\verbatim at line
+\newcount\tab at position
+\def\@xobeytab{%
+  \loop
+    \toks@\expandafter{\the\toks@\@xobeysp}%
+    \advance\tab at position-1
+  \ifnum\tab at position>0 \repeat
+}
+\begingroup
+  \catcode`\^^I=\active
+  \gdef\@vobeytabs{\catcode`\^^I\active\let^^I\@xobeytab}%
+\endgroup
+\def\verbatim at tabexpand#1{%
+  \ifx#1\@nil
+    \the\toks@
+    \expandafter\par
+  \else
+    \ifx#1\@xobeytab
+      \@xobeytab
+    \else
+      \toks@\expandafter{\the\toks@#1}%
+      \advance\tab at position\m at ne
+    \fi
+    \ifnum\tab at position=0 \tab at position\tab at size \fi
+    \expandafter\verbatim at tabexpand
+  \fi
+}
+
+\newif\ift at bs
+\newcommand{\tabson}[1][4]{%
+  \ifnum\@ne > #1\relax
+    \tabsoff
+  \else
+    \t at bstrue
+    \def\tab at size{#1\relax}%
+    \def\@maybeobeytabs{\@vobeytabs}%
+  \fi
+}
+\newcommand{\tabsoff}{%
+  \t at bsfalse
+  \def\tab at size{\z@}%
+  \def\@maybeobeytabs{}%
+}
+\tabsoff
+
+\def\tabverbatim at processline{\tab at position\tab at size
+  \toks@{}%
+  \expandafter\verbatim at tabexpand\the\verbatim at line\@nil}
+\def\notabverbatim at processline{\the\verbatim at line\par}
+
+\def\verbatim at startline{\verbatim at line{}}
+\def\verbatim at addtoline#1{%
+  \verbatim at line\expandafter{\the\verbatim at line#1}}
+\def\verbatim at processline{\notabverbatim at processline}
+\def\verbatim at finish{\ifcat$\the\verbatim at line$\else
+  \verbatim at processline\fi}
+\newcommand{\setverbatimfont}[1]{\def\m at mverbfont{#1}}
+\setverbatimfont{\normalfont\ttfamily}
+
+\def\verbatim at font{\m at mverbfont
+                   \hyphenchar\font\m at ne
+                   \let\do\do at noligs
+                   \verbatim at nolig@list}
+
+\def\@verbatim{\the\every at verbatim
+  \trivlist \item \relax
+  \if at minipage\else\vskip\parskip\fi
+  \@beginparpenalty \predisplaypenalty
+  \if at RTL\rightskip\else\leftskip\fi\@totalleftmargin\if at RTL\leftskip\else\rightskip\fi\z@
+  \parindent\z@\parfillskip\@flushglue\parskip\z@
+  \@@par
+  \def\par{%
+    \if at tempswa
+      \leavevmode\null\@@par\penalty\interlinepenalty
+    \else
+      \@tempswatrue
+      \ifhmode\@@par\penalty\interlinepenalty\fi
+    \fi}%
+  \def\@noitemerr{\@warning{No verbatim text}}%
+  \obeylines
+  \let\do\@makeother \dospecials
+  \verbatim at font
+  \everypar \expandafter{\the\everypar \unpenalty}%
+  \wrapright\the\afterevery at verbatim}
+\def\verbatim{\begingroup
+  \ift at bs
+    \def\verbatim at processline{\tabverbatim at processline}%
+  \fi
+  \@verbatim \frenchspacing\@vobeyspaces\@maybeobeytabs\verbatim at start}
+\@namedef{verbatim*}{\begingroup
+  \ift at bs
+    \def\verbatim at processline{\tabverbatim at processline}%
+  \fi
+  \@verbatim\@maybeobeytabs\verbatim at start}
+\def\endverbatim{\endtrivlist\endgroup\@doendpe}
+\@namelet{endverbatim*}\endverbatim
+
+\newcommand{\setupcomment}{%
+  \let\do\@makeother\dospecials\catcode`\^^M\active
+  \let\verbatim at startline\relax
+  \let\verbatim at addtoline\@gobble
+  \let\verbatim at processline\relax
+  \let\verbatim at finish\relax}
+\newcommand{\newcomment}[1]{%
+  \expandafter\def\csname #1\endcsname{\@bsphack\setupcomment\verbatim@}%
+  \expandafter\let\csname end#1\endcsname=\@esphack}
+\newcommand{\commentsoff}[1]{%
+  \expandafter\def\csname #1\endcsname{}%
+  \expandafter\def\csname end#1\endcsname{}}
+\newcommand{\commentson}[1]{\newcomment{#1}}
+
+\newcomment{comment}
+
+\@ifundefined{vrb at catcodes}%
+  {\def\vrb at catcodes{%
+     \catcode`\!12\catcode`\[12\catcode`\]12}}{}
+\begingroup
+ \vrb at catcodes
+ \lccode`\!=`\\ \lccode`\[=`\{ \lccode`\]=`\}
+ \catcode`\~=\active \lccode`\~=`\^^M
+ \lccode`\C=`\C
+ \lowercase{\endgroup
+    \def\verbatim at start#1{%
+      \verbatim at startline
+      \if\noexpand#1\noexpand~%
+        \let\next\verbatim@
+      \else \def\next{\verbatim@#1}\fi
+      \next}%
+    \def\verbatim@#1~{\verbatim@@#1!end\@nil}%
+    \def\verbatim@@#1!end{%
+       \verbatim at addtoline{#1}%
+       \futurelet\next\verbatim@@@}%
+    \def\verbatim@@@#1\@nil{%
+       \ifx\next\@nil
+         \verbatim at processline
+         \verbatim at startline
+         \let\next\verbatim@
+       \else
+         \def\@tempa##1!end\@nil{##1}%
+         \@temptokena{!end}%
+         \def\next{\expandafter\verbatim at test\@tempa#1\@nil~}%
+       \fi \next}%
+    \def\verbatim at test#1{%
+           \let\next\verbatim at test
+           \if\noexpand#1\noexpand~%
+             \expandafter\verbatim at addtoline
+               \expandafter{\the\@temptokena}%
+             \verbatim at processline
+             \verbatim at startline
+             \let\next\verbatim@
+           \else \if\noexpand#1
+             \@temptokena\expandafter{\the\@temptokena#1}%
+           \else \if\noexpand#1\noexpand[%
+             \let\@tempc\@empty
+             \let\next\verbatim at testend
+           \else
+             \expandafter\verbatim at addtoline
+               \expandafter{\the\@temptokena}%
+             \def\next{\verbatim@#1}%
+           \fi\fi\fi
+           \next}%
+    \def\verbatim at testend#1{%
+         \if\noexpand#1\noexpand~%
+           \expandafter\verbatim at addtoline
+             \expandafter{\the\@temptokena[}%
+           \expandafter\verbatim at addtoline
+             \expandafter{\@tempc}%
+           \verbatim at processline
+           \verbatim at startline
+           \let\next\verbatim@
+         \else\if\noexpand#1\noexpand]%
+           \let\next\verbatim@@testend
+         \else\if\noexpand#1\noexpand!%
+           \expandafter\verbatim at addtoline
+             \expandafter{\the\@temptokena[}%
+           \expandafter\verbatim at addtoline
+             \expandafter{\@tempc}%
+           \def\next{\verbatim@!}%
+         \else \expandafter\def\expandafter\@tempc\expandafter
+           {\@tempc#1}\fi\fi\fi
+         \next}%
+    \def\verbatim@@testend{%
+       \ifx\@tempc\@currenvir
+         \verbatim at finish
+         \edef\next{\noexpand\end{\@currenvir}%
+                    \noexpand\verbatim at rescan{\@currenvir}}%
+       \else
+         \expandafter\verbatim at addtoline
+           \expandafter{\the\@temptokena[}%
+           \expandafter\verbatim at addtoline
+             \expandafter{\@tempc]}%
+         \let\next\verbatim@
+       \fi
+       \next}%
+    \def\verbatim at rescan#1#2~{\if\noexpand~\noexpand#2~\else
+        \@warning{Characters dropped after `\string\end{#1}'}\fi}}
+\newread\verbatim at in@stream
+\def\verbatim at readfile#1{%
+  \verbatim at startline
+  \openin\verbatim at in@stream #1\relax
+  \ifeof\verbatim at in@stream
+    \typeout{No file #1.}%
+  \else
+    \@addtofilelist{#1}%
+    \ProvidesFile{#1}[(verbatim)]%
+    \expandafter\endlinechar\expandafter\m at ne
+    \expandafter\verbatim at read@file
+    \expandafter\endlinechar\the\endlinechar\relax
+    \closein\verbatim at in@stream
+  \fi
+  \verbatim at finish
+}
+\def\verbatim at read@file{%
+  \read\verbatim at in@stream to\next
+  \ifeof\verbatim at in@stream
+  \else
+    \expandafter\verbatim at addtoline\expandafter{\next}%
+    \verbatim at processline
+    \verbatim at startline
+    \expandafter\verbatim at read@file
+  \fi
+}
+\def\verbatiminput{\begingroup
+  \ift at bs
+    \def\verbatim at processline{\tabverbatim at processline}%
+  \fi
+  \@ifstar{\verbatim at input{\@maybeobeytabs}}%
+          {\verbatim at input{\frenchspacing\@vobeyspaces\@maybeobeytabs}}}
+\def\verbatim at input#1#2{%
+   \IfFileExists {#2}{\@verbatim #1\relax
+    \verbatim at readfile{\@filef at und}\endtrivlist\endgroup\@doendpe}%
+   {\typeout {No file #2.}\endgroup}}
+\newlength{\verbatimindent}
+  \setlength{\verbatimindent}{3em}
+\newcommand*{\verbatimbreakchar}{\char`\%}
+\newcommand*{\setverbatimbreak}{%
+  \vspace*{-\baselineskip}%
+  \def\@xobeysp{~\discretionary{\verbatimbreakchar}%
+    {\kern\verbatimindent}{}}%
+}
+
+\newcommand*{\raggedwrap}{%
+  \@rightskip\@flushglue
+  \if at RTL\leftskip\else\rightskip\fi\@rightskip
+  \if at RTL\rightskip\else\leftskip\fi\@totalleftmargin
+  \parindent\ragrparindent}
+\newcommand*{\wrappingon}{%
+  \def\@xobeysp{~\discretionary{\verbatimbreakchar}%
+    {\kern\verbatimindent}{}}%
+  \def\wrapright{\raggedwrap}}
+\newcommand*{\wrappingoff}{%
+  \def\@xobeysp{\leavevmode\penalty\@M\ }%
+  \def\wrapright{}}
+\wrappingoff
+
+\newwrite \verbatim at out
+\def\verbatimoutput#1{%
+  \@bsphack
+  \immediate\openout \verbatim at out #1
+  \let\do\@makeother\dospecials
+  \catcode`\^^M\active %% \catcode`\^^I=12
+  \def\verbatim at processline{%
+    \immediate\write\verbatim at out
+      {\the\verbatim at line}}%
+  \verbatim at start}
+\def\endverbatimoutput{%
+  \immediate\closeout\verbatim at out
+  \@esphack}
+\def\fboxverbatim{\begingroup%
+  \tabsoff %% PW otherwise box fills the width
+  \def\verbatim at processline{%
+    {\setbox0=\hbox{\the\verbatim at line}%
+    \hsize=\wd0 \the\verbatim at line\par}}%
+  \@minipagetrue%%%DPC%%%
+  \@tempswatrue%%%DPC%%%
+  \setbox0=\vbox\bgroup \verbatim
+}
+\def\endfboxverbatim{%
+  \endverbatim
+  \unskip\setbox0=\lastbox %%%DPC%%%
+  \egroup
+  \fbox{\box0}% <<<=== change here for centering,...
+\endgroup}
+\def\MakeShortVerb#1{%
+  \expandafter\ifx\csname cc\string#1\endcsname\relax
+    \@shortvrbinfo{Made }{#1}%
+    \add at special{#1}%
+    \expandafter
+    \xdef\csname cc\string#1\endcsname{\the\catcode`#1}%
+    \begingroup
+      \catcode`\~\active  \lccode`\~`#1%
+      \lowercase{%
+      \global\expandafter\let
+         \csname ac\string#1\endcsname~%
+      \gdef~{\verb~}}%
+    \endgroup
+    \global\catcode`#1\active
+  \else
+    \@shortvrbinfo\@empty{#1 already}%
+  \fi}
+\def\DeleteShortVerb#1{%
+  \expandafter\ifx\csname cc\string#1\endcsname\relax
+  \else
+    \@shortvrbinfo{Deleted }{#1 as}%
+    \rem at special{#1}%
+    \global\catcode`#1\csname cc\string#1\endcsname
+    \global \expandafter\let \csname cc\string#1\endcsname \relax
+    \ifnum\catcode`#1=\active
+      \begingroup
+        \catcode`\~\active   \lccode`\~`#1%
+        \lowercase{%
+          \global\expandafter\let\expandafter~%
+          \csname ac\string#1\endcsname}%
+      \endgroup \fi \fi}
+\def\@shortvrbinfo#1#2{%
+  \ClassInfo{bidimemoir}{%
+     #1\expandafter\@gobble\string#2 a short reference
+                                          for \string\verb}}
+\def\add at special#1{%
+  \rem at special{#1}%
+  \expandafter\gdef\expandafter\dospecials\expandafter
+    {\dospecials \do #1}%
+  \expandafter\gdef\expandafter\@sanitize\expandafter
+    {\@sanitize \@makeother #1}}
+\def\rem at special#1{%
+  \def\do##1{%
+    \ifnum`#1=`##1 \else \noexpand\do\noexpand##1\fi}%
+  \xdef\dospecials{\dospecials}%
+  \begingroup
+    \def\@makeother##1{%
+      \ifnum`#1=`##1 \else \noexpand\@makeother\noexpand##1\fi}%
+    \xdef\@sanitize{\@sanitize}%
+  \endgroup}
+\def\boxverbflag{14 }
+\newlength{\bvboxsep}      % user can change this
+\setlength{\bvboxsep}{1em}
+
+\newif\ifbvperpage % start/end lines on every page of multipage verbatim
+\bvperpagetrue
+
+\newcommand{\bvtopofpage}[1]{%
+  \long\def\b at vtop{#1}}
+\def\b at vtop{}  % used in \boxverb at split for heading
+
+\newcounter{memfbvline}
+  \c at memfbvline=\z@
+\newcounter{bvlinectr}
+\newcommand*{\setbvlinenums}[2]{%
+  \c at bvlinectr #1\relax \advance\c at bvlinectr \m at ne
+  \ifnum\z@<\linemodnum%   we are printing line numbers
+    \@tempcnta #2\relax
+    \divide\@tempcnta\linemodnum
+    \multiply\@tempcnta\linemodnum
+    \c at memfbvline #2\relax
+    \advance\c at memfbvline-\@tempcnta
+  \fi}
+
+\def\theb at vlinenumber{\getthelinenumber{bvlinectr}{memfbvline}}
+\newcommand*{\resetbvlinenumber}{\setcounter{bvlinectr}{0}}
+
+\def\b at vdocount{\ifbvcountlines\stepcounter{bvlinectr}\fi}
+\newlength{\bvnumlength}
+%% \settowidth{\bvnumlength}{\vlvnumfont 9999}
+\settowidth{\bvnumlength}{\normalfont 999}
+
+\newif\ifbvcountinside  % TRUE if line numbers inside box
+  \bvcountinsidetrue
+\newcommand*{\bvnumbersinside}{\bvcountinsidetrue}
+\newcommand*{\bvnumbersoutside}{\bvcountinsidefalse}
+
+\def\b at vdoinside{%
+  \ifbvcountlines\ifbvcountinside%
+    \makebox[\bvnumlength][r]{%
+      \vlvnumfont \theb at vlinenumber\space}%
+  \fi\fi}
+
+\def\b at vdooutside{%
+  \ifbvcountlines\ifbvcountinside\else%
+    \llap{\makebox[\bvnumlength][r]{%
+      \vlvnumfont \theb at vlinenumber\space}}%
+  \fi\fi}
+
+\newcommand*{\@@m at mline}{\hb at xt@\linewidth}
+
+\newcommand{\setupboxverb at line}{%
+  \par
+  \ifbvperpage
+    \output=\expandafter{\expandafter\boxverb at split \the\output}
+  \fi
+  \def\verbatim at processline{\leavevmode
+    \b at vdocount%
+    \bvleftsidehook\vbox{\advance% \hsize-.8\p@ \@@line % changed to \linewidth
+                                 \linewidth-.8\p@ \@@line
+      {\b at vdooutside\strut\kern\bvboxsep%
+       \b at vdoinside%
+       \ift at bs
+         \tabverbatim at processline
+       \else
+         \the\verbatim at line
+       \fi
+       \hss}%
+     \kern\bvboxsep}\bvrightsidehook\par}}
+
+\newcommand{\setupbox at verb}{%
+  \if at RTL\rightskip\else\leftskip\fi\z at skip \if at RTL\leftskip\else\rightskip\fi\z at skip
+  \interlinepenalty\boxverbflag
+  \parfillskip\z@ plus\p@ minus\p@
+  \lineskip-\bvboxsep \baselineskip\z at skip
+  \frenchspacing\@vobeyspaces\@maybeobeytabs
+  \boxverb at toprule}
+
+\def\boxedverbatim{\begingroup
+  \let\@@line\@@m at mline%    new from mempatch v4.9
+  \setupboxverb at line
+  \@verbatim
+  \setupbox at verb
+  \verbatim at start}
+\def\endboxedverbatim{\bvendrulehook\endtrivlist\endgroup\@doendpe}
+\@namedef{boxedverbatim*}{\let\frenchspacing\@gobble \boxedverbatim}
+\@namelet{endboxedverbatim*}\endboxverbatim
+
+\def\boxverb at toprule{\bvtoprulehook
+  \@@line{\bvleftsidehook \bvtopmidhook \bvrightsidehook}}
+
+\newcommand*{\bvendofpage}[1]{%
+  \def\boxverb at botpage{#1}}
+%%%%\bvendofpage{\hrule\kern-.4pt}
+\bvendofpage{\hrule width\linewidth\kern-.4pt}
+
+\def\boxverb at split{\ifnum\outputpenalty=\boxverbflag
+  \ifdim\dp\@cclv=\z@
+%%%%    \setbox\@cclv\vbox{\unvbox\@cclv\hrule\kern-.4pt}%
+    \setbox\@cclv\vbox{\unvbox\@cclv\boxverb at botpage}%
+    \null \kern-.7\topskip \b at vtop \boxverb at toprule
+  \fi
+\fi}
+
+\def\bvtoprulehook{\hrule width\linewidth \nobreak\vskip-.1\p@}
+\def\bvendrulehook{\hrule width\linewidth}
+\def\bvleftsidehook{\vrule}
+\def\bvrightsidehook{\vrule}
+\def\bvtopmidhook{\rule{0\p@}{2\bvboxsep} \hss}
+
+\newcommand{\boxedverbatiminput}{\begingroup
+  \@ifstar{\let\frenchspacing\@gobble
+           \boxedverbatim at input\relax}%
+          {\boxedverbatim at input{\frenchspacing\@vobeyspaces}}}
+
+\def\boxedverbatim at input#1#2{%
+  \setupboxverb at line
+  \IfFileExists{#2}{\@verbatim #1\relax
+  \setupbox at verb
+    \verbatim at readfile{\@filef at und}%
+      \bvendrulehook\endtrivlist\endgroup\@doendpe}%
+  {\typeout {No file #2.}\endgroup}}
+
+\newcommand{\bvbox}{%
+  \bvperpagetrue%
+  \renewcommand{\bvtoprulehook}{\hrule \nobreak \vskip-.1\p@}%
+  \renewcommand{\bvleftsidehook}{\vrule}%
+  \renewcommand{\bvrightsidehook}{\vrule}%
+  \renewcommand{\bvendrulehook}{\hrule}}
+
+\newcommand{\nobvbox}{%
+  \bvperpagefalse%
+  \renewcommand{\bvtoprulehook}{}%
+  \renewcommand{\bvleftsidehook}{}%
+  \renewcommand{\bvrightsidehook}{}%
+  \renewcommand{\bvendrulehook}{}}
+
+\newcommand{\bvtopandtail}{%
+  \bvperpagefalse%
+  \renewcommand{\bvtoprulehook}{\hrule \nobreak \vskip-.1\p@}%
+  \renewcommand{\bvleftsidehook}{}%
+  \renewcommand{\bvrightsidehook}{}%
+  \renewcommand{\bvendrulehook}{\hrule}}
+
+\newcommand{\bvsides}{%
+  \bvperpagefalse%
+  \renewcommand{\bvtoprulehook}{\vskip 3ex}%
+  \renewcommand{\bvleftsidehook}{\vrule}%
+  \renewcommand{\bvrightsidehook}{\vrule}%
+  \renewcommand{\bvendrulehook}{}}
+
+\let\framed\relax \let\endframed\relax
+\let\shaded\relax \let\endshaded\relax
+
+\chardef\FrameRestore=\catcode`\| % for debug
+\catcode`\|=\catcode`\% % (debug: insert space after backslash)
+
+\def\MakeFramed#1{\par
+ \fb at sizeofframe\FrameCommand
+ \let\width\fb at frw \let\height\fb at frh
+ \begingroup
+ \skip@\lastskip
+ \if at nobreak\else
+    \penalty9999 % updates \page parameters
+    \ifdim\pagefilstretch=\z@ \ifdim\pagefillstretch=\z@
+       \edef\@tempa{\the\skip@}%
+       \ifx\@tempa\zero at glue \penalty-30
+       \else \vskip-\skip@ \penalty-30 \vskip\skip@
+    \fi\fi\fi
+    \penalty\z@
+    \advance\skip@ \z@ plus-.5\baselineskip
+    \advance\skip@ \z@ plus-.231\height
+    \advance\skip@ \z@ plus-.231\skip@
+    \advance\skip@ \z@ plus-.231\topsep
+    \vskip-\skip@ \penalty 1800 \vskip\skip@
+ \fi
+ \addvspace{\topsep}%
+ \endgroup
+ \penalty\@M \vskip 2\baselineskip \vskip\height
+ \penalty9999 \vskip -2\baselineskip \vskip-\height
+ \penalty9999 % updates \pagetotal
+|\message{After clearout, \pagetotal=\the\pagetotal,
+|         \pagegoal=\the\pagegoal. }%
+ \fb at adjheight
+ \setbox\@tempboxa\vbox\bgroup
+   #1% Modifications to \hsize (can use \width and \height)
+   \textwidth\hsize \columnwidth\hsize}
+
+\def\endMakeFramed{\par
+     \kern\z@
+     \hrule\@width\hsize\@height\z@
+     \penalty-100 % put depth into height
+ \egroup
+  % {\showoutput\showbox\@tempboxa}%
+ \begingroup
+   \fb at put@frame\FrameCommand\FirstFrameCommand
+ \endgroup}
+
+\def\fb at put@frame#1#2{\relax
+ \ifdim\pagegoal=\maxdimen \pagegoal\vsize \fi
+ \ifinner
+   \fb at putboxa#1%
+   \fb at afterframe
+ \else
+  \dimen@\pagegoal \advance\dimen at -\pagetotal % natural space left on page
+  \ifdim\dimen@<2\baselineskip % Too little room on page
+|   \message{Page has only \the\dimen@\space room left; eject. }%
+    \eject \fb at adjheight \fb at put@frame#1#2%
+  \else % there's appreciable room left on the page
+     \fb at sizeofframe#1%
+|    \message{\string\pagetotal=\the\pagetotal,
+|        \string\pagegoal=\the\pagegoal,
+|        \string\pagestretch=\the\pagestretch,
+|        \string\pageshrink=\the\pageshrink,
+|        \string\fb at frh=\fb at frh. \space}
+|    \message{Box of size \the\ht\@tempboxa\space + \fb at frh}%
+     \begingroup % temporarily set \dimen@ to be...
+     \advance\dimen at .8\pageshrink  % maximum space available on page
+     \advance\dimen at -\fb at frh\relax % space available for frame's contents
+     \expandafter\endgroup
+     \ifdim\dimen@>\ht\@tempboxa % whole box does fit
+|       \message{fits in \the\dimen at . }%
+        \fb at putboxa#1%
+        \fb at afterframe
+     \else % box must be split
+|       \message{must be split to fit in \the\dimen at . }%
+        \fb at sizeofframe#2%
+        \setbox\@tempboxa\vbox{% simulate frame and flexiblity of the page:
+           \vskip \fb at frh \@plus\pagestretch \@minus.8\pageshrink
+           \kern137sp\kern-137sp\penalty-30
+           \unvbox\@tempboxa}%
+        \edef\fb at resto@set{\boxmaxdepth\the\boxmaxdepth
+                           \splittopskip\the\splittopskip}%
+        \boxmaxdepth\z@ \splittopskip\z@
+|       \message{Padded box of size \the\ht\@tempboxa\space split
+|                to \the\dimen@}%
+        \setbox\tw@\vsplit\@tempboxa to\dimen@
+|       \toks99\expandafter{\splitfirstmark}%
+|       \toks98\expandafter{\splitbotmark}%
+|       \message{Marks are: \the\toks99, \the\toks98. }%
+        \setbox\tw@\vbox{\unvbox\tw@}% natural-sized
+|       \message{Natural height of split box is \the\ht\tw@, leaving
+|          \the\ht\@tempboxa\space remainder. }%
+        \begingroup
+        \advance\dimen@\topskip
+        \expandafter\endgroup
+        \ifdim\dimen@>\pagegoal
+|         \message{Frame is big -- Use up the full column. }%
+          \dimen at ii\pagegoal
+          \advance\dimen at ii -\topskip
+          \advance\dimen at ii \FrameHeightAdjust\relax
+        \else  % suspect this is wrong:
+          \advance\dimen at .8\pageshrink
+          \ifdim\ht\tw@>\dimen@
+|           \message{Box too tall; rebox it to \the\dimen at . }%
+            \dimen at ii\dimen@
+          \else % use natural size
+            \dimen at ii\ht\tw@
+          \fi
+        \fi
+        \advance\dimen at ii -\fb at frh
+        \setbox\tw@\vbox to\dimen at ii \bgroup
+        \vskip -\fb at frh \@plus-\pagestretch \@minus-.8\pageshrink
+        \unvbox\tw@ \unpenalty\unpenalty
+        \ifdim\lastkern=-137sp % whole box went to next page
+|          \message{box split at beginning! }%
+           % need work here???
+           \egroup \fb at resto@set \eject % (\vskip for frame size was discarded)
+           \fb at adjheight
+           \fb at put@frame#1#2% INSERTED ???
+        \else % Got material split off at the head
+           \egroup \fb at resto@set
+           \ifvoid\@tempboxa % it all fit after all
+|             \message{box split at end! }%
+              \setbox\@tempboxa\box\tw@
+              \fb at putboxa#1%
+              \fb at afterframe
+           \else % it really did split
+|             \message{box split as expected. Its reboxed height
+|                      is \the\ht\tw at . }%
+              \ifdim\wd\tw@>\z@
+                \wd\tw@\wd\@tempboxa
+                \memfblineboxtwo{#2{\box\tw@}}%  ??? \centerline bad idea? \\
+              \else
+|               \message{Zero width means likely blank.
+|                        Don't frame it (guess)}%
+                \box\tw@
+              \fi
+              \hrule \@height\z@ \@width\hsize
+              \eject
+              \fb at adjheight
+              \fb at put@frame\LastFrameCommand\MidFrameCommand
+  \fi\fi\fi\fi\fi}
+
+\newcommand{\memfblineboxtwo}[1]{\centerline{#1}}
+\newcommand{\memfblineboxa}[1]{\centerline{#1}}
+
+\def\fb at putboxa#1{%
+  \ifvoid\@tempboxa
+%%%%    PackageWarning{framed}{Boxa is void -- discard it. }%
+    \@memwarn{Boxa is void -- discard it. }%
+  \else
+|   \message{Frame and place boxa. }%
+|   %{\showoutput\showbox\@tempboxa}%
+%%%%%%%    \centerline{#1{\box\@tempboxa}}%
+    \memfblineboxa{#1{\box\@tempboxa}}%
+  \fi}
+
+\def\fb at afterframe{%
+    \nointerlineskip \null %{\showoutput \showlists}
+    \penalty-30 \vskip\topsep \relax}
+
+\newdimen\fb at frw
+\newdimen\fb at frh
+\def\fb at sizeofframe#1{\begingroup
+ \setbox\z@\vbox{\vskip-5in \hbox{\hskip-5in
+   #1{\hbox{\vrule \@height 4.7in \@depth.3in \@width 5in}}}%
+   \vskip\z at skip}%
+|  \message{Measuring frame addition for \string#1 in \@currenvir\space
+|    gives ht \the\ht\z@\space and wd \the\wd\z at . }%
+ \global\fb at frw\wd\z@ \global\fb at frh\ht\z@
+ \endgroup}
+
+\def\fb at adjheight{%
+  \vbox to\FrameHeightAdjust{}% get proper baseline skip from above.
+  \penalty\@M \nointerlineskip
+  \vskip-\FrameHeightAdjust
+  \penalty\@M} % useful for tops of pages
+
+\edef\zero at glue{\the\z at skip}
+
+\catcode`\|=\FrameRestore
+
+\providecommand\FrameCommand{%
+ \setlength\fboxrule{\FrameRule}\setlength\fboxsep{\FrameSep}%
+ \fbox}
+\@ifundefined{FrameRule}{\newdimen\FrameRule \FrameRule=\fboxrule}{}
+\@ifundefined{FrameSep} {\newdimen\FrameSep  \FrameSep =3\fboxsep}{}
+\providecommand\FirstFrameCommand{\FrameCommand}
+\providecommand\MidFrameCommand{\FrameCommand}
+\providecommand\LastFrameCommand{\FrameCommand}
+\providecommand\FrameHeightAdjust{6pt}
+
+\def\FrameRestore{%
+   \let\if at nobreak\iffalse
+   \let\if at noskipsec\iffalse
+   \let\-\@dischyph
+   \let\'\@acci\let\`\@accii\let\=\@acciii
+   %  \message{FrameRestore:
+   %    \@totalleftmargin=\the \@totalleftmargin,
+   %    \rightmargin=\the\rightmargin,
+   %    \@listdepth=\the\@listdepth.  }%
+   \ifnum \ifdim\@totalleftmargin>\z@ 1\fi
+          \ifdim\rightmargin>\z@ 1\fi
+          \ifnum\@listdepth>0 1\fi 0>\z@
+     %     \message{In a list: \linewidth=\the\linewidth,
+     %       \@totalleftmargin=\the\@totalleftmargin,
+     %       \parshape=\the\parshape, \columnwidth=\the\columnwidth,
+     %       \hsize=\the\hsize,
+     %       \labelwidth=\the\labelwidth. }%
+%%%     \@setminipage % snug fit around the item
+%%%     \advance\linewidth-\columnwidth \advance\linewidth\hsize
+%%%     \parshape\@ne \@totalleftmargin \linewidth
+     \memfblistfixparams
+   \else % Not in list
+     \linewidth=\hsize
+     %\message{No list, set \string\linewidth=\the\hsize. }%
+   \fi
+   \sloppy}
+
+%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
+
+\newcommand*{\memfblistfixparams}{%
+  \@setminipage % snug fit around the item
+  \advance\linewidth-\columnwidth \advance\linewidth\hsize
+  \parshape\@ne \@totalleftmargin \linewidth}
+
+\newenvironment{framed}% using default \FrameCommand
+  {\MakeFramed {\advance\hsize-\width \FrameRestore}}%
+  {\endMakeFramed}
+
+\newenvironment{shaded}{%
+  \def\FrameCommand{\fboxsep=\FrameSep \colorbox{shadecolor}}%
+  \MakeFramed {\FrameRestore}}%
+  {\endMakeFramed}
+
+\newenvironment{leftbar}{%
+  \def\FrameCommand{\vrule width 3pt \hspace{10pt}}%
+  \MakeFramed {\advance\hsize-\width \FrameRestore}}%
+ {\endMakeFramed}
+
+\newenvironment{snugshade}{%
+  \def\FrameCommand{\colorbox{shadecolor}}%
+  \MakeFramed {\FrameRestore\@setminipage}}%
+ {\par\unskip\endMakeFramed}
+
+\AtBeginPackage{framed}{%
+  \let\framed\relax \let\endframed\relax
+  \let\shaded\relax \let\endshaded\relax
+  \let\leftbar\relax \let\endleftbar\relax
+  \let\snugshade\relax \let\endsnugshade\relax}
+
+\newenvironment{qframe}{%
+  \def\FrameCommand##1{\fboxrule=\FrameRule\fboxsep=\FrameSep
+    \hskip\@totalleftmargin\fbox{##1}% There is no \@totalrightmargin, so...
+      \hskip-\linewidth \hskip-\@totalleftmargin \hskip\columnwidth}%
+  \MakeFramed{\advance\hsize-\width
+              \advance\hsize \FrameSep
+              \@totalleftmargin\z@ \linewidth=\hsize}}%
+ {\endMakeFramed}
+
+\newenvironment{qshade}{%
+  \def\FrameCommand##1{\fboxsep=\FrameSep
+    \hskip\@totalleftmargin
+    \hskip -1\FrameSep
+    \colorbox{shadecolor}{##1}%
+      \hskip-\linewidth \hskip-\@totalleftmargin
+      \hskip -1\FrameSep
+      \hskip\columnwidth}%
+  \MakeFramed{\advance\hsize-\width
+              \advance\hsize 3\FrameSep
+              \@totalleftmargin\z@ \linewidth=\hsize}}%
+ {\endMakeFramed}
+
+\newcommand*{\newoutputstream}[1]{%
+  \@ifundefined{#1outstre at m}%
+    {\expandafter\newwrite\csname #1outstre at m\endcsname
+     \csname newif\expandafter\endcsname
+       \csname ifstre at m#1open\endcsname
+     \global\csname stre at m#1openfalse\endcsname
+     \expandafter\ifx\csname atstreamopen#1\endcsname\relax
+       \global\@namedef{atstreamopen#1}{}%
+     \fi
+     \expandafter\ifx\csname atstreamclose#1\endcsname\relax
+       \global\@namedef{atstreamclose#1}{}%
+     \fi
+    }%
+    {\@memwarn{Output stream #1\space is already defined}}}
+
+\newcommand*{\newinputstream}[1]{%
+  \@ifundefined{#1instre at m}%
+    {\expandafter\newread\csname #1instre at m\endcsname
+     \csname newif\expandafter\endcsname
+       \csname ifstre at m#1open\endcsname
+     \global\csname stre at m#1openfalse\endcsname
+     \expandafter\ifx\csname atstreamopen#1\endcsname\relax
+       \global\@namedef{atstreamopen#1}{}%
+     \fi
+     \expandafter\ifx\csname atstreamclose#1\endcsname\relax
+       \global\@namedef{atstreamclose#1}{}%
+     \fi
+    }%
+    {\@memwarn{Input stream #1\space is already defined}}}
+
+\newcommand{\IfStreamOpen}[3]{%
+  \csname ifstre at m#1open\endcsname#2\else#3\fi}
+\newcommand{\instre at mandopen}[2]{%
+  \@ifundefined{#1instre at m}{%
+    \@memwarn{#1\space is not an input stream}}%
+  {\IfStreamOpen{#1}{#2}{%
+    \@memwarn{Input stream #1\space is not open}}}}
+
+\newcommand{\instre at mandclosed}[2]{%
+  \@ifundefined{#1instre at m}{%
+    \@memwarn{#1\space is not an input stream}}%
+  {\IfStreamOpen{#1}{%
+    \@memwarn{Input stream #1\space is open}}{#2}}}
+
+\newcommand{\outstre at mandopen}[2]{%
+  \@ifundefined{#1outstre at m}{%
+    \@memwarn{#1\space is not an output stream}}%
+  {\IfStreamOpen{#1}{#2}{%
+    \@memwarn{Output stream #1\space is not open}}}}
+
+\newcommand{\outstre at mandclosed}[2]{%
+  \@ifundefined{#1outstre at m}{%
+    \@memwarn{#1\space is not an output stream}}%
+  {\IfStreamOpen{#1}{%
+    \@memwarn{Output stream #1\space is open}}{#2}}}
+
+\newcommand*{\openoutputfile}[2]{%
+  \outstre at mandclosed{#2}{%
+    \global\@namedef{#1 at filename}{#1}%
+    \if at filesw
+      \immediate\openout\@nameuse{#2outstre at m}=\@nameuse{#1 at filename}%
+    \fi
+    \global\csname stre at m#2opentrue\endcsname%
+    \@nameuse{atstreamopen#2}}}
+
+\newcommand*{\closeoutputstream}[1]{%
+  \outstre at mandopen{#1}{%
+    \@nameuse{atstreamclose#1}%
+    \immediate\closeout\@nameuse{#1outstre at m}%
+    \global\csname stre at m#1openfalse\endcsname}}
+
+\newcommand{\openinputfile}[2]{%
+  \IfFileExists{#1}{%                   file exists
+    \instre at mandclosed{#2}{%
+      \@addtofilelist{#1}%
+      \global\@namedef{#1 at filename}{#1}%
+      \immediate\openin\@nameuse{#2instre at m}=\@nameuse{#1 at filename}%
+      \global\csname stre at m#2opentrue\endcsname%
+      \@nameuse{atstreamopen#2}}}%
+  {%                                    file not found
+    \typeout{No file #1.}
+  }}
+
+\newcommand{\closeinputstream}[1]{%
+  \instre at mandopen{#1}{%
+     \@nameuse{atstreamclose#1}%
+     \immediate\closein\@nameuse{#1instre at m}%
+     \global\csname stre at m#1openfalse\endcsname}}
+
+\def\writeverbatim#1{%
+  \@bsphack
+  \let\do\@makeother\dospecials
+  \catcode`\^^M\active
+  \def\verbatim at processline{%
+    \immediate\write\@nameuse{#1outstre at m}{\the\verbatim at line}}%
+  \verbatim at start}
+\def\endwriteverbatim{\@esphack}
+
+\newcommand{\addtostream}[2]{%
+  \@bsphack
+  \outstre at mandopen{#1}{%
+    {\let\protect\string
+     \immediate\write\@nameuse{#1outstre at m}{#2}%
+    }}%
+  \@esphack}
+
+\newif\ifstre at mnoteof
+\newcommand{\checkstre at meof}[1]{%
+  \stre at mnoteoftrue\ifeof\@nameuse{#1instre at m}\stre at mnoteoffalse\fi}
+
+\def\readstream#1{
+  \instre at mandopen{#1}{%
+    \loop \checkstre at meof{#1} \ifstre at mnoteof
+      \read\@nameuse{#1instre at m} to\temptokstre at m
+     \temptokstre at m
+    \repeat
+    }}
+
+\def\readaline#1{
+  \instre at mandopen{#1}{%
+    \ifeof\@nameuse{#1instre at m}
+      \@memwarn{No more to read from stream #1}
+    \else
+      \read\@nameuse{#1instre at m} to\temptokstre at m
+      \temptokstre at m
+    \fi}}
+
+\def\readverbatim{\begingroup
+  \ift at bs
+    \def\verbatim at processline{\tabverbatim at processline}%
+  \fi
+  \@ifstar{\stre at mverb@input{\@maybeobeytabs}}%
+     {\stre at mverb@input{\frenchspacing\@vobeyspaces\@maybeobeytabs}}}
+
+\newcommand{\stre at mverb@input}[2]{%
+  \IfStreamOpen{#2}%
+    {\@verbatim #1\relax
+     \def\@verbinstre at m{\@nameuse{#2instre at m}}
+     \verb at readstre@m\endtrivlist\endgroup\@doendpe}%
+    {\@memwarn{Stream #2\space is not open}\endgroup}}
+
+\newcommand{\verb at readstre@m}{%
+  \verbatim at startline
+  \expandafter\endlinechar\expandafter\m at ne
+  \expandafter\verbatim at read@stre at m
+  \expandafter\endlinechar\the\endlinechar\relax
+  \verbatim at finish}
+
+\newcommand{\verbatim at read@stre at m}{%
+  \read\@verbinstre at m to\next
+  \ifeof\@verbinstre at m
+  \else
+    \expandafter\verbatim at addtoline\expandafter{\next}%
+    \verbatim at processline
+    \verbatim at startline
+    \expandafter\verbatim at read@stre at m
+  \fi}
+
+\newcommand{\readboxedverbatim}{\begingroup
+  \@ifstar{\stre at mbvin\relax}%
+          {\stre at mbvin{\frenchspacing\@vobeyspaces}}}
+
+\newcommand{\stre at mbvin}[2]{%
+  \IfStreamOpen{#2}%
+    {\setupboxverb at line
+     \@verbatim #1\relax
+     \def\@verbinstre at m{\@nameuse{#2instre at m}}%
+     \setupbox at verb
+     \verb at readstre@m\bvendrulehook\endtrivlist\endgroup\@doendpe}%
+    {\@memwarn{Stream #2\space is not open}\endgroup}}
+
+\newcommand{\provideenvironment}{\@star at or@long\m at mprovenv}
+\newcommand{\m at mprovenv}[1]{\@ifundefined{#1}%
+  {\new at environment{#1}}%       % create new environment
+  {\@memwarn{Environment `#1' already defined}%
+   \m at mgobbleoptsandtwo}}
+\newcommand{\m at mgobbleoptsandtwo}{%
+  \@ifnextchar [{\m at mgobbleoptandtwo}{\@gobbletwo}}
+\def\m at mgobbleoptandtwo[#1]{%
+  \@ifnextchar [{\m at mgobbleoptandtwo}{\@gobbletwo}}
+
+\newcommand*{\providecounter}[1]{%
+  \@ifundefined{c@#1}%
+    {\newcounter{#1}}%
+    {\@memwarn{Counter `#1' already defined}%
+      \@ifnextchar[{\m at mgobbleopt}{}}}
+
+\def\m at mgobbleopt[#1]{}
+
+\newcommand*{\providelength}[1]{%
+  \begingroup
+    \escapechar\m at ne\xdef\@gtempa{{\string#1}}%
+  \endgroup
+  \expandafter\@ifundefined\@gtempa
+    {\newlength{#1}}%
+    {\@memwarn{Length #1 already defined}}}
+
+\newcommand*{\newloglike}{\@ifstar{\m at mnewlogs}{\m at mnewlog}}
+\newcommand*{\m at mnewlogs}[2]{%
+  \newcommand*{#1}{\mathop{\operator at font #2}}}
+\newcommand*{\m at mnewlog}[2]{%
+  \newcommand*{#1}{\mathop{\operator at font #2}\nolimits}}
+
+\newcommand*{\provideloglike}{\@ifstar{\m at mprovlogs}{\m at mprovlog}}
+\newcommand*{\m at mprovlogs}[2]{%
+  \providecommand*{#1}{\mathop{\operator at font #2}}}
+\newcommand*{\m at mprovlog}[2]{%
+  \providecommand*{#1}{\mathop{\operator at font #2}\nolimits}}
+
+\providecommand{\@removefromreset}[2]{{%
+  \expandafter\let\csname c@#1\endcsname\@removefromreset
+  \def\@elt##1{%
+    \expandafter\ifx\csname c@##1\endcsname\@removefromreset
+    \else
+      \noexpand\@elt{##1}%
+    \fi}%
+  \expandafter\xdef\csname cl@#2\endcsname{%
+    \csname cl@#2\endcsname}}}
+
+\newcommand{\@ifbothcntrs}[3]{%
+  \@ifundefined{c@#1}{% counter undefined
+    \@memerror{#1 is not a counter}{\@eha}}%
+  {% else counter is defined
+    \@ifundefined{c@#2}{% within undefined
+      \@memerror{#2 is not a counter}{\@eha}}%
+    {% else both counter and within  are defined
+     #3}}}
+
+\newcommand{\counterwithin}{\@ifstar{\@csinstar}{\@csin}}
+\newcommand{\@csinstar}[2]{%
+  \@ifbothcntrs{#1}{#2}{\@addtoreset{#1}{#2}}}
+\newcommand{\@csin}[2]{%
+  \@ifbothcntrs{#1}{#2}{\@addtoreset{#1}{#2}%
+                        \@namedef{the#1}{\@nameuse{the#2}.\arabic{#1}}}}
+
+\newcommand{\counterwithout}{\@ifstar{\@csoutstar}{\@csout}}
+\newcommand{\@csoutstar}[2]{%
+  \@ifbothcntrs{#1}{#2}{\@removefromreset{#1}{#2}}}
+\newcommand{\@csout}[2]{%
+  \@ifbothcntrs{#1}{#2}{\@removefromreset{#1}{#2}%
+                        \@namedef{the#1}{\arabic{#1}}}}
+
+\newif\ifoddpage
+\newif\ifstrictpagecheck
+  \strictpagecheckfalse
+\newcommand*{\strictpagecheck}{\strictpagechecktrue}
+\newcommand*{\easypagecheck}{\strictpagecheckfalse}
+
+\newcounter{cp at cntr}
+\newcommand{\cplabel}{^_}
+\DeclareRobustCommand{\checkoddpage}{%
+  \oddpagefalse%
+  \ifstrictpagecheck%
+    \stepcounter{cp at cntr}\pmemlabel{\cplabel\thecp at cntr}%
+    \@memcnta=\pmemlabelref{\cplabel\thecp at cntr}\relax
+    \ifodd\@memcnta\oddpagetrue\fi
+  \else
+    \ifodd\c at page\oddpagetrue\fi
+  \fi}
+
+\gdef\thepmemc@@page{\the\c at page}
+
+\long\def\pmemprotected at write#1#2#3{%
+  \begingroup
+  \let\thepmemc@@page\relax
+  #2%
+  \let\protect\@unexpandable at protect
+  \edef\reserved at a{\write#1{#3}}%
+  \reserved at a
+  \endgroup
+  \if at nobreak\ifvmode\nobreak\fi\fi}
+
+\newcommand{\pmemlabel}[1]{\@bsphack
+  \pmemprotected at write\@auxout{}%
+    {\string\newpmemlabel{#1}{\thepmemc@@page}}%
+  \@esphack}
+\newcommand{\newpmemlabel}[2]{{\global\@namedef{m@#1}{#2}}}
+\newcommand{\pmemlabelref}[1]{%
+  \expandafter\ifx\csname m@#1\endcsname\relax
+    0%
+  \else
+    \csname m@#1\endcsname
+  \fi}
+
+\begingroup
+\catcode`\Q=3
+\long\gdef\@ifmtarg#1{\@xifmtarg#1QQ\@secondoftwo\@firstoftwo\@nil}
+\long\gdef\@xifmtarg#1#2Q#3#4#5\@nil{#4}
+\long\gdef\@ifnotmtarg#1{\@xifmtarg#1QQ\@firstofone\@gobble\@nil}
+\endgroup
+
+\DeclareRobustCommand{\ch at ngetext}{%
+  \setlength{\@colht}{\textheight}\setlength{\@colroom}{\textheight}%
+  \setlength{\vsize}{\textheight}\setlength{\columnwidth}{\textwidth}%
+  \if at twocolumn%
+    \advance\columnwidth-\columnsep \divide\columnwidth\tw@%
+    \@firstcolumntrue%
+  \fi%
+  \setlength{\hsize}{\columnwidth}%
+  \setlength{\linewidth}{\hsize}}
+
+\DeclareRobustCommand{\changetext}[5]{%
+  \@ifmtarg{#1}{}{\addtolength{\textheight}{#1}}%
+  \@ifmtarg{#2}{}{\addtolength{\textwidth}{#2}}%
+  \@ifmtarg{#3}{}{\addtolength{\evensidemargin}{#3}}%
+  \@ifmtarg{#4}{}{\addtolength{\oddsidemargin}{#4}}%
+  \@ifmtarg{#5}{}{\addtolength{\columnsep}{#5}}%
+  \ch at ngetext}
+
+\DeclareRobustCommand{\changepage}[9]{%
+  \@ifmtarg{#1}{}{\addtolength{\textheight}{#1}}%
+  \@ifmtarg{#2}{}{\addtolength{\textwidth}{#2}}%
+  \@ifmtarg{#3}{}{\addtolength{\evensidemargin}{#3}}%
+  \@ifmtarg{#4}{}{\addtolength{\oddsidemargin}{#4}}%
+  \@ifmtarg{#5}{}{\addtolength{\columnsep}{#5}}%
+  \ch at ngetext
+  \@ifmtarg{#6}{}{\addtolength{\topmargin}{#6}}%
+  \@ifmtarg{#7}{}{\addtolength{\headheight}{#7}}%
+  \@ifmtarg{#8}{}{\addtolength{\headsep}{#8}}%
+  \@ifmtarg{#9}{}{\addtolength{\footskip}{#9}}}
+
+\newenvironment{adjustwidth}[2]{%
+  \begin{list}{}{%
+    \topsep\z@%
+    \listparindent\parindent%
+    \parsep\parskip%
+    \@ifmtarg{#1}{\setlength{\leftmargin}{\z@}}%
+                 {\setlength{\leftmargin}{#1}}%
+    \@ifmtarg{#2}{\setlength{\rightmargin}{\z@}}%
+                 {\setlength{\rightmargin}{#2}}%
+    }
+    \item[]}{\end{list}}
+
+\newenvironment{adjustwidth*}[2]{%
+  \begin{list}{}{%
+    \topsep\z@%
+    \listparindent\parindent%
+    \parsep\parskip%
+    \checkoddpage
+    \ifoddpage  % odd numbered page
+      \@ifmtarg{#1}{\setlength{\leftmargin}{\z@}}%
+                   {\setlength{\leftmargin}{#1}}%
+      \@ifmtarg{#2}{\setlength{\rightmargin}{\z@}}%
+                   {\setlength{\rightmargin}{#2}}%
+    \else       % even numbered page
+      \@ifmtarg{#2}{\setlength{\leftmargin}{\z@}}%
+                   {\setlength{\leftmargin}{#2}}%
+      \@ifmtarg{#1}{\setlength{\rightmargin}{\z@}}%
+                   {\setlength{\rightmargin}{#1}}%
+    \fi
+    }
+    \item[]}{\end{list}}
+
+\newcommand{\calccentering}[1]{
+  #1 = \paperwidth
+  \advance #1 by -\textwidth
+  \divide #1 by \tw@
+  \advance #1 by -\spinemargin}
+
+\newenvironment{vplace}[1][1]{%
+  \par\vspace{\stretch{#1}}%
+}{%
+  \vspace*{\stretch{1}}%
+  \par}
+
+\newcommand{\cleartoevenpage}[1][\@empty]{%
+  \clearpage%
+  \ifodd\c at page\hbox{}#1\clearpage\fi}
+
+\newcommand{\movetoevenpage}[1][\@empty]{%
+  \newpage%
+  \ifodd\c at page\hbox{}#1\newpage\fi}
+
+\newcommand{\cleartooddpage}[1][\@empty]{%
+  \clearpage%
+  \ifodd\c at page\else\hbox{}#1\clearpage\fi}
+
+\newcommand{\movetooddpage}[1][\@empty]{%
+  \newpage%
+  \ifodd\c at page\else\hbox{}#1\newpage\fi}
+
+\newcommand{\needspace}[1]{\begingroup\setlength{\dimen@}{#1}%
+  \vskip\z@\@plus\dimen@\penalty -100\vskip\z@\@plus-\dimen@
+  \vskip\dimen@\penalty 9999\vskip-\dimen@\endgroup}
+
+\newcommand{\Needspace}{\@ifstar{\M at sneedsp@}{\M at needsp@}}
+\newcommand{\M at sneedsp@}[1]{\par \penalty-100\begingroup
+  \setlength{\dimen@}{#1}%
+  \dimen at ii\pagegoal \advance\dimen at ii-\pagetotal
+  \ifdim \dimen@>\dimen at ii
+    \break
+  \fi\endgroup}
+\newcommand{\M at needsp@}[1]{\par \penalty-100\begingroup
+  \setlength{\dimen@}{#1}%
+  \dimen at ii\pagegoal \advance\dimen at ii-\pagetotal
+  \ifdim \dimen@>\dimen at ii
+    \ifdim \dimen at ii>\z@
+      \vfil
+    \fi
+    \break
+  \fi\endgroup}
+
+\newcommand*{\midsloppy}{%
+  \tolerance 5000%
+  \hbadness 4000%
+  \emergencystretch 1.5em%
+  \hfuzz .1\p@
+  \vfuzz\hfuzz}
+\newenvironment{midsloppypar}{\par\midsloppy}{\par}
+
+\newcommand{\medspace}{\kern .22222em }
+\DeclareRobustCommand{\:}{%
+  \relax\ifmmode\mskip\medmuskip\else\medspace\fi}
+\DeclareRobustCommand{\!}{%
+  \relax\ifmmode\mskip-\thinmuskip\else\negthinspace\fi}
+
+\DeclareRobustCommand*{\slashfracstyle}[1]{%
+  {\m at th\ensuremath{\mbox{\fontsize\sf at size\z@\selectfont #1}}}}
+\DeclareRobustCommand*{\slashfrac}[2]{\leavevmode
+  \raise.5ex\hbox{\slashfracstyle{#1}}\kern-.13em/%
+  \kern-.15em\lower.25ex\hbox{\slashfracstyle{#2}}}
+
+\DeclareRobustCommand*{\textsubscript}[1]{%
+  \@textsubscript{\selectfont#1}}
+\newcommand*{\@textsubscript}[1]{%
+  {\m at th\ensuremath{_{\mbox{\fontsize\sf at size\z@#1}}}}}
+
+%%%%%%%%%%%%%%%%%%%% number formatting
+
+\newif\iflowernumtoname
+  \lowernumtonamefalse
+\newif\ifpriornum
+\newif\ifminusnumber
+\newif\ifnotnumtonameallcaps
+\newif\ifmakeordinal
+
+\newcommand*{\namenumberand}{ and }
+\newcommand*{\namenumbercomma}{, }
+\newcommand*{\lcminusname}{minus }
+\newcommand*{\ucminusname}{Minus }
+\let\minusname\lcminusname
+\newcommand*{\fnumbersep}{,}
+\newcommand*\tensunitsep{-}
+\newcommand*{\nthstring}{th}      % nth
+\newcommand*{\iststring}{st}      % 1st
+\newcommand*{\iindstring}{nd}     % 2nd
+\newcommand*{\iiirdstring}{rd}    % 3rd
+\newcommand*{\tiethstring}{tieth} % tieth
+\newcommand*{\teenstring}{teen}   % teen
+\newcommand{\ordscript}[1]{#1}
+
+\chardef\m at mten=10 % shorthand for 10
+
+\newcounter{ism at mctr}  % units
+\newcounter{xsm at mctr}  % tens
+\newcounter{csm at mctr}  % hundreds
+\newcounter{ksm at mctr}  % thousands
+\newcounter{xksm at mctr} % ten thousands
+\newcounter{cksm at mctr} % hundred thousands
+\newcounter{msm at mctr}  % millions
+\newcounter{xmsm at mctr} % ten millions
+\newcounter{cmsm at mctr} % hundred millions
+\newcounter{bsm at mctr}  % billions
+\newcounter{workm at mctr}
+
+\newcommand*{\numdigits}[1]{%
+  \setcounter{ism at mctr}{0}%
+  \setcounter{xsm at mctr}{0}%
+  \setcounter{csm at mctr}{0}%
+  \setcounter{ksm at mctr}{0}%
+  \setcounter{xksm at mctr}{0}%
+  \setcounter{cksm at mctr}{0}%
+  \setcounter{msm at mctr}{0}%
+  \setcounter{xmsm at mctr}{0}%
+  \setcounter{cmsm at mctr}{0}%
+  \setcounter{bsm at mctr}{0}%
+  \setcounter{workm at mctr}{#1}%
+  \minusnumberfalse
+  \ifnum \c at workm@mctr < \z@  % negative
+    \minusnumbertrue
+    \c at workm@mctr = -\c at workm@mctr
+  \fi
+  \ifnum \c at workm@mctr > \m at ne     % units
+    \c at ism@mctr = \c at workm@mctr
+    \divide \c at workm@mctr by \m at mten
+    \multiply \c at workm@mctr by \m at mten
+    \advance \c at ism@mctr by -\c at workm@mctr
+    \divide \c at workm@mctr by \m at mten
+  \fi
+  \ifnum \c at workm@mctr > \z@    % tens
+    \c at xsm@mctr = \c at workm@mctr
+    \divide \c at workm@mctr by \m at mten
+    \multiply \c at workm@mctr by \m at mten
+    \advance \c at xsm@mctr by -\c at workm@mctr
+    \divide \c at workm@mctr by \m at mten
+  \fi
+  \ifnum \c at workm@mctr > \z@   % hundreds
+    \c at csm@mctr = \c at workm@mctr
+    \divide \c at workm@mctr by \m at mten
+    \multiply \c at workm@mctr by \m at mten
+    \advance \c at csm@mctr by -\c at workm@mctr
+    \divide \c at workm@mctr by \m at mten
+  \fi
+  \ifnum \c at workm@mctr > \z@   % thousands
+    \c at ksm@mctr = \c at workm@mctr
+    \divide \c at workm@mctr by \m at mten
+    \multiply \c at workm@mctr by \m at mten
+    \advance \c at ksm@mctr by -\c at workm@mctr
+    \divide \c at workm@mctr by \m at mten
+  \fi
+  \ifnum \c at workm@mctr > \z@   % ten thousands
+    \c at xksm@mctr = \c at workm@mctr
+    \divide \c at workm@mctr by \m at mten
+    \multiply \c at workm@mctr by \m at mten
+    \advance \c at xksm@mctr by -\c at workm@mctr
+    \divide \c at workm@mctr by \m at mten
+  \fi
+  \ifnum \c at workm@mctr > \z@   % hundred thousands
+    \c at cksm@mctr = \c at workm@mctr
+    \divide \c at workm@mctr by \m at mten
+    \multiply \c at workm@mctr by \m at mten
+    \advance \c at cksm@mctr by -\c at workm@mctr
+    \divide \c at workm@mctr by \m at mten
+  \fi
+  \ifnum \c at workm@mctr > \z@   % millions
+    \c at msm@mctr = \c at workm@mctr
+    \divide \c at workm@mctr by \m at mten
+    \multiply \c at workm@mctr by \m at mten
+    \advance \c at msm@mctr by -\c at workm@mctr
+    \divide \c at workm@mctr by \m at mten
+  \fi
+  \ifnum \c at workm@mctr > \z@  % ten millions
+    \c at xmsm@mctr = \c at workm@mctr
+    \divide \c at workm@mctr by \m at mten
+    \multiply \c at workm@mctr by \m at mten
+    \advance \c at xmsm@mctr by -\c at workm@mctr
+    \divide \c at workm@mctr by \m at mten
+  \fi
+  \ifnum \c at workm@mctr > \z@  % hundred millions
+    \c at cmsm@mctr = \c at workm@mctr
+    \divide \c at workm@mctr by \m at mten
+    \multiply \c at workm@mctr by \m at mten
+    \advance \c at cmsm@mctr by -\c at workm@mctr
+    \divide \c at workm@mctr by \m at mten
+  \fi
+  \ifnum \c at workm@mctr > \z@% billions
+    \c at bsm@mctr = \c at workm@mctr
+    \divide \c at workm@mctr by \m at mten
+    \multiply \c at workm@mctr by \m at mten
+    \advance \c at bsm@mctr by -\c at workm@mctr
+  \fi}
+
+\newcommand*{\form at tnumber}[1]{%
+  \numdigits{#1}%
+  \ifminusnumber-\fi
+  \priornumfalse
+  \ifnum \c at bsm@mctr > \z@ % billions
+    \priornumtrue
+    \thebsm at mctr\fnumbersep
+  \fi
+  \ifpriornum                 % hundred millions
+    \thecmsm at mctr
+  \else
+    \ifnum \c at cmsm@mctr > \z@
+      \priornumtrue
+      \thecmsm at mctr
+    \fi
+  \fi
+  \ifpriornum                 % ten millions
+    \thexmsm at mctr
+  \else
+    \ifnum \c at xmsm@mctr > \z@
+      \priornumtrue
+      \thexmsm at mctr
+    \fi
+  \fi
+  \ifpriornum                 % millions
+    \themsm at mctr\fnumbersep
+  \else
+    \ifnum \c at msm@mctr > \z@
+      \priornumtrue
+      \themsm at mctr\fnumbersep
+    \fi
+  \fi
+  \ifpriornum                % hundred thousands
+    \thecksm at mctr
+  \else
+    \ifnum \c at cksm@mctr > \z@
+      \priornumtrue
+      \thecksm at mctr
+    \fi
+  \fi
+  \ifpriornum                % ten thousands
+    \thexksm at mctr
+  \else
+    \ifnum \c at xksm@mctr > \z@
+      \priornumtrue
+      \thexksm at mctr
+    \fi
+  \fi
+  \ifpriornum                % thousands
+    \theksm at mctr\fnumbersep
+  \else
+    \ifnum \c at ksm@mctr > \z@
+      \priornumtrue
+      \theksm at mctr\fnumbersep
+    \fi
+  \fi
+  \ifpriornum                % hundreds
+    \thecsm at mctr
+  \else
+    \ifnum \c at csm@mctr > \z@
+      \priornumtrue
+      \thecsm at mctr
+    \fi
+  \fi
+  \ifpriornum                % tens
+    \thexsm at mctr
+  \else
+    \ifnum \c at xsm@mctr > \z@
+      \priornumtrue
+      \thexsm at mctr
+    \fi
+  \fi
+  \theism at mctr}              % units
+
+\newcommand*{\cardinal}[1]{%
+  \begingroup
+  \let\fnumbersep\relax
+  \form at tnumber{#1}%
+  \endgroup}
+\newcommand*{\fcardinal}[1]{%
+  \begingroup
+  \form at tnumber{#1}%
+  \endgroup}
+
+\newcommand*{\ordinal}[1]{%
+  \begingroup
+  \let\fnumbersep\relax
+  \form at tnumber{#1}%
+  \let\ordstring\nthstring
+  \ifnum \c at xsm@mctr=\@ne\else
+    \ifcase \c at ism@mctr
+      \or \let\ordstring\iststring%    1st
+      \or \let\ordstring\iindstring%   2nd
+      \or \let\ordstring\iiirdstring%  3rd
+    \fi
+  \fi
+  \ordscript{\ordstring}%
+  \endgroup
+}
+\newcommand*{\fordinal}[1]{%
+  \begingroup
+  \form at tnumber{#1}%
+  \let\ordstring\nthstring
+  \ifnum \c at xsm@mctr=\@ne\else
+    \ifcase \c at ism@mctr
+      \or \let\ordstring\iststring%    1st
+      \or \let\ordstring\iindstring%   2nd
+      \or \let\ordstring\iiirdstring%  3rd
+    \fi
+  \fi
+  \ordscript{\ordstring}%
+  \endgroup
+}
+
+\newcommand*\nNameo{\iflowernumtoname z\else Z\fi ero}
+\newcommand*\nNamec{\iflowernumtoname h\else H\fi undred}
+\newcommand*\nNamem{\iflowernumtoname t\else T\fi housand}
+\newcommand*\nNamemm{\iflowernumtoname m\else M\fi illion}
+\newcommand*\nNamemmm{\iflowernumtoname b\else B\fi illion}
+
+\newcommand*\nNamei{\iflowernumtoname o\else O\fi ne}
+\newcommand*\nNameii{\iflowernumtoname t\else T\fi wo}
+\newcommand*\nNameiii{\iflowernumtoname t\else T\fi hree}
+\newcommand*\nNameiv{\iflowernumtoname f\else F\fi our}
+\newcommand*\nNamev{\iflowernumtoname f\else F\fi ive}
+\newcommand*\nNamevi{\iflowernumtoname s\else S\fi ix}
+\newcommand*\nNamevii{\iflowernumtoname s\else S\fi even}
+\newcommand*\nNameviii{\iflowernumtoname e\else E\fi ight}
+\newcommand*\nNameix{\iflowernumtoname n\else N\fi ine}
+\newcommand*\nNamex{\iflowernumtoname t\else T\fi en}
+\newcommand*\nNamexi{\iflowernumtoname e\else E\fi leven}
+\newcommand*\nNamexii{\iflowernumtoname t\else T\fi welve}
+\newcommand*\nNamexiii{\iflowernumtoname t\else T\fi hir\teenstring}
+\newcommand*\nNamexiv{\iflowernumtoname f\else F\fi our\teenstring}
+\newcommand*\nNamexv{\iflowernumtoname f\else F\fi if\teenstring}
+\newcommand*\nNamexvi{\iflowernumtoname s\else S\fi ix\teenstring}
+\newcommand*\nNamexvii{\iflowernumtoname s\else S\fi even\teenstring}
+\newcommand*\nNamexviii{\iflowernumtoname e\else E\fi igh\teenstring}
+\newcommand*\nNamexix{\iflowernumtoname n\else N\fi ine\teenstring}
+\newcommand*\nNamexx{\iflowernumtoname t\else T\fi wenty}
+\newcommand*\nNamexxx{\iflowernumtoname t\else T\fi hirty}
+\newcommand*\nNamexl{\iflowernumtoname f\else F\fi orty}
+\newcommand*\nNamel{\iflowernumtoname f\else F\fi ifty}
+\newcommand*\nNamelx{\iflowernumtoname s\else S\fi ixty}
+\newcommand*\nNamelxx{\iflowernumtoname s\else S\fi eventy}
+\newcommand*\nNamelxxx{\iflowernumtoname e\else E\fi ighty}
+\newcommand*\nNamexc{\iflowernumtoname n\else N\fi inety}
+
+\newcommand*{\unitnumbername}[1]{%
+  \ifcase #1 \nNameo\or
+   \nNamei\or
+   \nNameii\or
+   \nNameiii\or
+   \nNameiv\or
+   \nNamev\or
+   \nNamevi\or
+   \nNamevii\or
+   \nNameviii\or
+   \nNameix\fi}
+
+\newcommand*{\teennumbername}[1]{%
+  \ifcase #1 \nNamex\or
+   \nNamexi\or
+   \nNamexii\or
+   \nNamexiii\or
+   \nNamexiv\or
+   \nNamexv\or
+   \nNamexvi\or
+   \nNamexvii\or
+   \nNamexviii\or
+   \nNamexix\fi}
+
+\newcommand*{\tensnumbername}[2]{%
+  \ifnum #1=\@ne
+    \teennumbername{#2}\ifnotnumtonameallcaps\lowernumtonametrue\fi
+  \else
+    \ifcase #1
+    \or
+    \or \nNamexx
+    \or \nNamexxx
+    \or \nNamexl
+    \or \nNamel
+    \or \nNamelx
+    \or \nNamelxx
+    \or \nNamelxxx
+    \or \nNamexc
+    \fi
+    \ifnotnumtonameallcaps\lowernumtonametrue\fi
+    \ifnum #2 > \z@ \tensunitsep\unitnumbername{#2}\fi
+  \fi}
+
+\newcommand*\nthNameo{\nNameo\nthstring}
+\newcommand*\nthNamei{\iflowernumtoname f\else F\fi irst}
+\newcommand*\nthNameii{\iflowernumtoname s\else S\fi econd}
+\newcommand*\nthNameiii{\iflowernumtoname t\else T\fi hird}
+\newcommand*\nthNameiv{\nNameiv\nthstring}
+\newcommand*\nthNamev{\iflowernumtoname f\else F\fi if\nthstring}
+\newcommand*\nthNamevi{\nNamevi\nthstring}
+\newcommand*\nthNamevii{\nNamevii\nthstring}
+\newcommand*\nthNameviii{\iflowernumtoname e\else E\fi igh\nthstring}
+\newcommand*\nthNameix{\iflowernumtoname n\else N\fi in\nthstring}
+\newcommand*\nthNamexii{\iflowernumtoname t\else T\fi welf\nthstring}
+
+\newcommand*{\unitordinalname}[1]{%
+  \ifcase #1 \nthNameo\or
+  \nthNamei\or
+  \nthNameii\or
+  \nthNameiii\or
+  \nthNameiv\or
+  \nthNamev\or
+  \nthNamevi\or
+  \nthNamevii\or
+  \nthNameviii\or
+  \nthNameix\fi}
+
+\newcommand*{\teenordinalname}[1]{%
+  \ifcase #1 \nNamex\nthstring\or
+  \nNamexi\nthstring\or
+  \nthNamexii\or
+  \nNamexiii\nthstring\or
+  \nNamexiv\nthstring\or
+  \nNamexv\nthstring\or
+  \nNamexvi\nthstring\or
+  \nNamexvii\nthstring\or
+  \nNamexviii\nthstring\or
+  \nNamexix\nthstring\fi}
+
+\newcommand*{\tensordinalname}[2]{%
+  \ifnum #1=\@ne
+    \teenordinalname{#2}\ifnotnumtonameallcaps\lowernumtonametrue\fi
+  \else
+    \ifnum #2> \z@
+      \ifcase #1
+      \or
+      \or \nNamexx
+      \or \nNamexxx
+      \or \nNamexl
+      \or \nNamel
+      \or \nNamelx
+      \or \nNamelxx
+      \or \nNamelxxx
+      \or \nNamexc
+      \fi
+      \ifnotnumtonameallcaps\lowernumtonametrue\fi
+      \tensunitsep\unitordinalname{#2}
+    \else
+      \ifcase #1
+      \or
+      \or \nthNamexx
+      \or \nthNamexxx
+      \or \nthNamexl
+      \or \nthNamel
+      \or \nthNamelx
+      \or \nthNamelxx
+      \or \nthNamelxxx
+      \or \nthNamexc
+      \fi
+      \ifnotnumtonameallcaps\lowernumtonametrue\fi
+    \fi
+  \fi}
+
+\newcommand*\nthNamexx{\iflowernumtoname t\else T\fi wen\tiethstring}
+\newcommand*\nthNamexxx{\iflowernumtoname t\else T\fi hir\tiethstring}
+\newcommand*\nthNamexl{\iflowernumtoname f\else F\fi or\tiethstring}
+\newcommand*\nthNamel{\iflowernumtoname f\else F\fi if\tiethstring}
+\newcommand*\nthNamelx{\iflowernumtoname s\else S\fi ix\tiethstring}
+\newcommand*\nthNamelxx{\iflowernumtoname s\else S\fi even\tiethstring}
+\newcommand*\nthNamelxxx{\iflowernumtoname e\else E\fi igh\tiethstring}
+\newcommand*\nthNamexc{\iflowernumtoname n\else N\fi ine\tiethstring}
+
+\newcommand*{\n at me@number}[1]{%
+\begingroup
+    \numdigits{#1}%
+    \ifminusnumber\minusname\fi
+    \priornumfalse
+%% billions
+    \ifnum \c at bsm@mctr > \z@
+      \unitnumbername{\thebsm at mctr}\space
+      \ifnotnumtonameallcaps\lowernumtonametrue\fi\nNamemmm
+      \priornumtrue
+    \fi
+%% hundred millions
+    \ifnum \c at cmsm@mctr > \z@
+      \ifpriornum\namenumbercomma\fi
+      \unitnumbername{\thecmsm at mctr}\space
+      \ifnotnumtonameallcaps\lowernumtonametrue\fi\nNamec
+      \priornumtrue
+    \fi
+%% tens/units millions
+    \ifnum \c at xmsm@mctr > \z@
+      \ifpriornum
+        \ifnum\c at cmsm@mctr>\z@\namenumberand\else\namenumbercomma\fi
+      \fi
+      \tensnumbername{\thexmsm at mctr}{\themsm at mctr}%
+      \priornumtrue
+    \else
+      \ifnum \c at msm@mctr > \z@
+        \ifpriornum
+          \ifnum\c at cmsm@mctr>\z@\namenumberand\else\namenumbercomma\fi
+        \fi
+        \unitnumbername{\themsm at mctr}%
+        \ifnotnumtonameallcaps\lowernumtonametrue\fi
+        \priornumtrue
+      \fi
+    \fi
+    \ifnum \c at cmsm@mctr > \z@
+      \ifpriornum\space\fi
+      \nNamemm
+    \else
+      \ifnum \c at xmsm@mctr > \z@
+        \ifpriornum\space\fi
+        \nNamemm
+      \else
+        \ifnum \c at msm@mctr > \z@
+          \ifpriornum\space\fi
+          \nNamemm
+        \fi
+      \fi
+    \fi
+%% hundred thousands
+    \ifnum \c at cksm@mctr > \z@
+      \ifpriornum\namenumbercomma\fi
+      \unitnumbername{\thecksm at mctr}\space
+        \ifnotnumtonameallcaps\lowernumtonametrue\fi\nNamec
+      \priornumtrue
+    \fi
+%% tens/units thousands
+    \ifnum \c at xksm@mctr > \z@
+      \ifpriornum
+        \ifnum\c at cksm@mctr>\z@\namenumberand\else\namenumbercomma\fi
+      \fi
+      \tensnumbername{\thexksm at mctr}{\theksm at mctr}%
+      \priornumtrue
+    \else
+      \ifnum \c at ksm@mctr > \z@
+        \ifpriornum
+          \ifnum\c at cksm@mctr>\z@\namenumberand\else\namenumbercomma\fi
+        \fi
+        \unitnumbername{\theksm at mctr}%
+        \ifnotnumtonameallcaps\lowernumtonametrue\fi
+        \priornumtrue
+      \fi
+    \fi
+    \ifnum \c at cksm@mctr > \z@
+      \ifpriornum\space\fi
+      \nNamem
+    \else
+      \ifnum \c at xksm@mctr > \z@
+        \ifpriornum\space\fi
+        \nNamem
+      \else
+        \ifnum \c at ksm@mctr > \z@
+          \ifpriornum\space\fi
+          \nNamem
+        \fi
+      \fi
+    \fi
+%% hundreds
+    \ifnum \c at csm@mctr > \z@
+      \ifpriornum\namenumbercomma\fi
+      \unitnumbername{\thecsm at mctr}\space
+        \ifnotnumtonameallcaps\lowernumtonametrue\fi\nNamec
+      \priornumtrue
+    \fi
+%% tens/units
+  \ifmakeordinal
+    \ifnum \c at xsm@mctr > \z@
+      \ifpriornum\namenumberand\fi
+      \tensordinalname{\thexsm at mctr}{\theism at mctr}%
+    \else
+      \ifnum \c at ism@mctr > \z@
+        \ifpriornum\namenumberand\fi
+        \unitordinalname{\theism at mctr}%
+      \else
+        \ifpriornum\nthstring\else\unitordinalname{\theism at mctr}\fi
+      \fi
+    \fi
+  \else  % not ordinal
+    \ifnum \c at xsm@mctr > \z@
+      \ifpriornum\namenumberand\fi
+      \tensnumbername{\thexsm at mctr}{\theism at mctr}%
+    \else
+      \ifnum \c at ism@mctr > \z@
+        \ifpriornum\namenumberand\fi
+        \unitnumbername{\theism at mctr}%
+      \else
+        \ifpriornum\else\unitnumbername{\theism at mctr}\fi
+      \fi
+    \fi
+  \fi % end ifmakeordinal
+\endgroup}
+
+\DeclareRobustCommand{\numtoname}[1]{%
+  \makeordinalfalse
+  \notnumtonameallcapstrue%
+  \lowernumtonametrue%
+  \n at me@number{#1}}
+
+\DeclareRobustCommand{\numtoName}[1]{%
+  \makeordinalfalse
+  \notnumtonameallcapstrue%
+  \lowernumtonamefalse%
+  \n at me@number{#1}}
+
+\DeclareRobustCommand{\NumToName}[1]{%
+  \makeordinalfalse
+  \notnumtonameallcapsfalse%
+  \lowernumtonamefalse%
+  \n at me@number{#1}}
+
+\DeclareRobustCommand{\ordinaltoname}[1]{%
+  \makeordinaltrue
+  \notnumtonameallcapstrue%
+  \lowernumtonametrue%
+  \n at me@number{#1}}
+
+\DeclareRobustCommand{\ordinaltoName}[1]{%
+  \makeordinaltrue
+  \notnumtonameallcapstrue%
+  \lowernumtonamefalse%
+  \n at me@number{#1}}
+
+\DeclareRobustCommand{\OrdinalToName}[1]{%
+  \makeordinaltrue
+  \notnumtonameallcapsfalse%
+  \lowernumtonamefalse%
+  \n at me@number{#1}}
+
+\long\def \@topnewpage [#1]{%
+  \@nodocument
+  \@next\@currbox\@freelist{}{}%
+  \global \setbox\@currbox
+    \vbox {%
+      \break
+      \prevdepth\z@
+      \begingroup
+      \normalcolor
+      \hsize\textwidth
+      \@parboxrestore
+      \col at number \@ne
+      #1%
+      \vskip -\dbltextfloatsep
+      \endgroup
+      \null % ordinary \baselineskip
+      \vskip -\topskip
+  }%
+  \begingroup %% \showbox\@currbox
+    \splitmaxdepth\maxdepth \splittopskip\topskip
+    \setbox\@tempboxa \vsplit\@currbox to \z@
+  \endgroup %% \showbox\@currbox
+  \ifdim \ht\@currbox>\textheight
+    \ht\@currbox \textheight
+  \fi
+  \global \count\@currbox \tw@
+  \@tempdima -\ht\@currbox
+  \advance \@tempdima -\dbltextfloatsep
+  \global \advance \@colht \@tempdima
+  \ifx \@dbltoplist \@empty
+  \else
+    \@latexerr{Float(s) lost}\@ehb
+    \let \@dbltoplist \@empty
+  \fi
+  \@cons \@dbltoplist \@currbox
+  \global \@dbltopnum \m at ne
+  \ifdim \@colht<2.5\baselineskip
+    \@latex at warning@no at line {Optional argument of \noexpand\twocolumn
+        too tall on page \thepage}%
+    \@emptycol
+    \if at firstcolumn
+    \else
+      \@emptycol
+    \fi
+  \else
+    \global \vsize \@colht
+    \global \@colroom \@colht
+    \@floatplacement
+  \fi}
+
+\newcommand*{\m at mcalchm}{%
+  \count0 = \time \divide \count0 by 60\relax
+  \count2 = \count0\relax%    the hour
+  \count4 = \time \multiply\count0 by 60\relax
+  \advance\count4 by -\count0\relax% the minute
+  \ifnum\count4<10 \toks1 = {0}%  make a leading zero
+  \else \toks1 = {}%
+  \fi}
+%%% punctuation, am and pm for \printtime
+\newcommand*{\hmpunct}{:}% hours minutes separator
+\newcommand*{\amname}{am}% ante meridiem
+\newcommand*{\pmname}{pm}% post meridiem
+
+\newcommand*{\printtime}{%
+  \@ifstar{\m at msprtime}{\m at mprtime}}
+\newcommand*{\m at mprtime}{\begingroup
+  \m at mcalchm
+  \number\count2\hmpunct\the\toks1 \number\count4
+  \endgroup}
+\newcommand*{\m at msprtime}{\begingroup
+  \m at mcalchm
+  \def\@mpm{\pmname}%
+  \ifnum\count2<1\relax% early in the morning
+    \count2=12\relax
+    \ifnum\count4>0\relax% not midnight
+      \def\@mpm{\amname}%
+    \fi
+  \else
+    \ifnum\time<721\relax% noon or earlier
+      \def\@mpm{\amname}%
+    \else
+      \ifnum\time>779\relax% 1300 hrs or later
+        \advance\count2 by -12\relax
+      \fi
+    \fi
+  \fi
+  \number\count2\hmpunct\the\toks1 \number\count4\ \@mpm
+  \endgroup}
+
+\newcounter{sheetsequence}
+  \setcounter{sheetsequence}{1}
+  \renewcommand{\thesheetsequence}{\@arabic\c at sheetsequence}
+\g at addto@macro{\@outputpage}{\stepcounter{sheetsequence}}
+
+\newcounter{lastsheet}
+  \setcounter{lastsheet}{0}
+\newcounter{lastpage}
+  \setcounter{lastpage}{0}
+
+\newcommand{\dol at stsheet}{%
+  \if at filesw
+    \addtocounter{sheetsequence}{-1}%
+    \immediate\write\@auxout%
+      {\string\memsetcounter{lastsheet}{\the\c at sheetsequence}}%
+    \stepcounter{sheetsequence}%
+  \fi}
+\newcommand{\dol at stpage}{%
+  \if at filesw
+    \addtocounter{page}{-1}%
+    \immediate\write\@auxout%
+      {\string\memsetcounter{lastpage}{\the\c at page}}%
+    \stepcounter{page}%
+  \fi}
+\AtBeginDocument{\AtEndDocument{\clearpage\dol at stsheet\dol at stpage}}
+
+\newif\ifcntrmod
+\newif\ifnotcntrmod
+\newcommand*{\iscntrmod}[2]{
+  \@tempcnta=\@nameuse{c@#1}%
+  \@tempcntb=\@tempcnta
+  \divide\@tempcnta #2\relax
+  \multiply\@tempcnta #2\relax
+  \advance\@tempcntb-\@tempcnta
+  \ifnum\@tempcntb=0\relax
+    \cntrmodtrue
+    \notcntrmodfalse
+  \else
+    \cntrmodfalse
+    \notcntrmodtrue
+  \fi}
+
+\newcommand*{\@memensuresigpages}{%
+  \ifnum\@mempagespersig<\@ne
+  \else
+    \iscntrmod{sheetsequence}{\@mempagespersig}
+    \ifcntrmod
+    \else
+        \clearpage
+        \pagestyle{empty}
+        \mbox{}
+      \loop
+        \iscntrmod{sheetsequence}{\@mempagespersig}
+        \ifnotcntrmod
+        \clearpage
+        \pagestyle{empty}
+        \mbox{}
+      \repeat
+    \fi
+  \fi}
+
+\newcommand*{\leavespergathering}[1]{\@memcnta=#1\relax
+                                     \ifnum\@memcnta<\tw@
+                                       \def\@mempagespersig{-1}%
+                                     \else
+                                       \multiply\@memcnta \tw@
+                                       \edef\@mempagespersig{\@memcnta}%
+                                     \fi}
+\leavespergathering{0}
+
+\AtEndDocument{\@memensuresigpages}
+
+\newcommand*{\abstractname}{Abstract}
+\newcommand*{\contentsname}{Contents}
+\newcommand*{\listfigurename}{List of Figures}
+\newcommand*{\listtablename}{List of Tables}
+\newcommand*{\bookname}{Book}
+\newcommand*{\partname}{Part}
+\newcommand*{\chaptername}{Chapter}
+\newcommand*{\appendixname}{Appendix}
+\newcommand*{\appendixtocname}{Appendices}
+\newcommand*{\appendixpagename}{Appendices}
+\newcommand*{\bibname}{Bibliography}
+\newcommand*{\indexname}{Index}
+\newcommand*{\glossaryname}{Glossary}
+\newcommand*{\figurename}{Figure}
+\newcommand*{\tablename}{Table}
+\newcommand*{\figurerefname}{Figure}
+\newcommand*{\tablerefname}{Table}
+\newcommand*{\pagename}{page}
+\newcommand*{\pagerefname}{page}
+\newcommand*{\bookrefname}{Book~}
+\newcommand*{\partrefname}{Part~}
+\newcommand*{\chapterrefname}{Chapter~}
+\newcommand*{\sectionrefname}{\S}
+\newcommand*{\appendixrefname}{Appendix~}
+
+\newcommand{\today}{\ifcase\month\or
+  January\or February\or March\or April\or May\or June\or
+  July\or August\or September\or October\or November\or December\fi
+  \space\number\day, \number\year}
+\setlength\columnsep{10\p@}
+\setlength\columnseprule{0\p@}
+\pagestyle{headings}
+\pagenumbering{arabic}
+
+\setcounter{part}{0}
+\setcounter{chapter}{0}
+\setcounter{tocdepth}{1}
+\setcounter{secnumdepth}{2}
+\maxsecnumdepth{section}
+
+\linenumberfrequency{0}
+\linenumberfont{\small\rmfamily}
+\settowidth{\bvnumlength}{\vlvnumfont 9999}
+
+\if at twoside
+\else
+  \raggedbottom
+\fi
+\if at twocolumn
+  \twocolumn
+  \sloppy
+  \flushbottom
+\else
+  \onecolumn
+\fi
+
+\newfloat[chapter]{figure}{lof}{\figurename}
+%%%  \kill at lastcounter{lofdepth}
+\renewcommand{\thefigure}{\thechapter\@SepMark\@arabic\c at figure}
+
+\newlistof{listoffigures}{lof}{\listfigurename}
+%%%  \kill at lastcounter{lofdepth}
+\newlistentry[chapter]{figure}{lof}{0}
+  \cftsetindents{figure}{0em}{2.3em}
+%%  \kill at lastcounter{lofdepth}
+
+\newfloat[chapter]{table}{lot}{\tablename}
+%%%  \kill at lastcounter{lotdepth}
+\renewcommand{\thetable}{\thechapter\@SepMark\@arabic\c at table}
+
+\newlistof{listoftables}{lot}{\listtablename}
+%%%  \kill at lastcounter{lotdepth}
+\newlistentry[chapter]{table}{lot}{0}
+  \cftsetindents{table}{0em}{2.3em}
+%%  \kill at lastcounter{lotdepth}
+
+%%%\AtBeginDocument{%
+%%%  \@ifundefined{c at lofdepth}%
+%%%     {\newcounter{lofdepth}\setcounter{lofdepth}{1}}{}
+%%%  \@ifundefined{c at lotdepth}%
+%%%     {\newcounter{lotdepth}\setcounter{lotdepth}{1}}{}}
+
+\ifartopt
+  \chapterstyle{article}
+  \counterwithout{figure}{chapter}
+  \counterwithout{table}{chapter}
+  \counterwithout{footnote}{chapter}
+  \counterwithout{equation}{chapter}
+  \renewcommand{\chaptername}{}
+  \renewcommand{\maketitlehookb}{%
+    \vskip -1.5\topsep\vskip -1.5\partopsep}
+  \renewcommand{\maketitlehookc}{%
+    \vskip -1.5\topsep\vskip -1.5\partopsep}
+\fi
+
+\newcommand{\msdoublespacing}{}
+\newcommand{\mssinglespacing}{}
+\ifmsdoc
+  \renewcommand{\msdoublespacing}{%
+    \renewcommand{\baselinestretch}{1.6}\large\normalsize}
+  \renewcommand{\mssinglespacing}{%
+    \renewcommand{\baselinestretch}{1.0}\large\normalsize}
+  \renewcommand{\familydefault}{cmtt}
+  \renewcommand{\rmdefault}{cmtt}
+  \renewcommand{\sfdefault}{cmtt}
+  \renewcommand{\bfdefault}{m}
+  \renewcommand{\itdefault}{n}
+  \renewcommand{\sldefault}{n}
+  \renewcommand{\scdefault}{n}
+  \renewcommand{\baselinestretch}{1.6}
+  \@twocolumnfalse
+  \onecolumn
+  \sloppy
+  \@twosidefalse
+  \raggedbottom
+  \pagestyle{plain}
+\fi
+
+\EmulatedPackage{abstract}[2008/07/23]
+\EmulatedPackage{appendix}[2008/07/23]
+\EmulatedPackage{array}[2008/07/23]
+\EmulatedPackage{booktabs}[2008/07/23]
+\EmulatedPackage{ccaption}[2008/07/23]
+\EmulatedPackage{changepage}[2008/07/23]
+\EmulatedPackage{chngcntr}[2008/07/23]
+\EmulatedPackage{chngpage}[2008/07/23]
+\EmulatedPackage{crop}
+\EmulatedPackage{dcolumn}[2008/07/23]
+\EmulatedPackage{delarray}[2008/07/23]
+\EmulatedPackage{enumerate}[2008/07/23]
+\EmulatedPackage{epigraph}[2008/07/23]
+%%%%%\EmulatedPackage{framed}[2008/07/23]
+\EmulatedPackage{ifmtarg}[2008/07/23]
+\ifm at mifetex\EmulatedPackage{ifetex}[2008/07/23]\fi
+\ifm at mifluatex\EmulatedPackage{ifluatex}[2008/07/23]\fi
+\ifm at mifpdf\EmulatedPackage{ifpdf}[2008/07/23]\fi
+\ifm at mifxetex\EmulatedPackage{ifxetex}[2008/07/23]\fi
+\EmulatedPackage{index}[2008/07/23]
+\EmulatedPackage{makeidx}[2008/07/23]
+\EmulatedPackage{moreverb}[2008/07/23]
+\EmulatedPackage{mparhack}[2008/07/23]
+\EmulatedPackage{needspace}[2008/07/23]
+\EmulatedPackage{newfile}[2008/07/23]
+\EmulatedPackage{nextpage}[2008/07/23]
+\EmulatedPackage{pagenote}[2008/07/23]
+\EmulatedPackage{parskip}[2008/07/23]
+\EmulatedPackage{patchcmd}[2008/07/23]
+\EmulatedPackage{setspace}[2008/07/23]
+\EmulatedPackage{shortvrb}[2008/07/23]
+\EmulatedPackage{showidx}[2008/07/23]
+\EmulatedPackage{tabularx}[2008/07/23]
+\EmulatedPackage{titleref}[2008/07/23]
+\EmulatedPackage{titling}[2008/07/23]
+\EmulatedPackage{tocbibind}[2008/07/23]
+\EmulatedPackage{verbatim}[2008/07/23]
+\EmulatedPackage{verse}[2008/07/23]
+
+%%% revert changes to captioning macros if the caption package is used.
+\AtBeginPackage{caption}{
+\ClassWarningNoLine{bidimemoir}{%
+  You are using the caption package with the bidimemoir \MessageBreak
+  class. This may cause unexpected or inconsistent \MessageBreak
+  results if you use any of bidimemoir's captioning facilities}
+
+\long\def\@makecaption##1##2{%
+  \vskip\abovecaptionskip
+  \sbox\@tempboxa{##1: ##2}%
+  \ifdim \wd\@tempboxa >\hsize
+    \if at RTL\beginR\fi##1: ##2\par
+  \else
+    \global \@minipagefalse
+    \hb at xt@\hsize{\if at RTL\beginR\fi\hfil\box\@tempboxa\hfil\if at RTL\endR\fi}%
+  \fi
+  \vskip\belowcaptionskip}
+
+\def\caption{%
+   \ifx\@captype\@undefined
+     \@latex at error{\noexpand\caption outside float}\@ehd
+     \expandafter\@gobble
+   \else
+     \refstepcounter\@captype
+     \expandafter\@firstofone
+   \fi
+   {\@dblarg{\@caption\@captype}}%
+}
+
+\long\def\@caption##1[##2]##3{%
+  \par
+  \addcontentsline{\csname ext@##1\endcsname}{##1}%
+    {\protect\numberline{\csname the##1\endcsname}{\ignorespaces ##2}}%
+  \begingroup
+    \@parboxrestore
+    \if at minipage
+      \@setminipage
+    \fi
+    \normalsize
+    \@makecaption{\csname fnum@##1\endcsname}{\ignorespaces ##3}\par
+  \endgroup}
+}
+
+\AtBeginPackage{float}{\let\newfloat\relax}
+
+\InputIfFileExists{mempatch.sty}{}{} % should be this
+%% 
+%% Copyright ?? 2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `bidimemoir.cls'.

Added: tags/texmf/tex/xelatex/bidi/bidimoderncv.cls
===================================================================
--- tags/texmf/tex/xelatex/bidi/bidimoderncv.cls	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/bidi/bidimoderncv.cls	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,275 @@
+%%
+%% This is file `bidimoderncv.cls',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% bidi.dtx  (with options: `bidimoderncv.cls')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\NeedsTeXFormat{LaTeX2e}
+\ProvidesClass{bidimoderncv}
+\newif\if at DEBUG\@DEBUGfalse
+\DeclareOption{a4paper}{
+  \setlength\paperheight{297mm}
+  \setlength\paperwidth{210mm}}
+\DeclareOption{a5paper}{
+  \setlength\paperheight{210mm}
+  \setlength\paperwidth{148mm}}
+\DeclareOption{b5paper}{
+  \setlength\paperheight{250mm}
+  \setlength\paperwidth{176mm}}
+\DeclareOption{letterpaper}{
+  \setlength\paperheight{11in}
+  \setlength\paperwidth{8.5in}}
+\DeclareOption{legalpaper}{
+  \setlength\paperheight{14in}
+  \setlength\paperwidth{8.5in}}
+\DeclareOption{executivepaper}{
+  \setlength\paperheight{10.5in}
+  \setlength\paperwidth{7.25in}}
+\DeclareOption{landscape}{
+  \setlength\@tempdima{\paperheight}
+  \setlength\paperheight{\paperwidth}
+  \setlength\paperwidth{\@tempdima}}
+\newcommand\@ptsize{}
+\DeclareOption{10pt}{\renewcommand\@ptsize{0}}
+\DeclareOption{11pt}{\renewcommand\@ptsize{1}}
+\DeclareOption{12pt}{\renewcommand\@ptsize{2}}
+\DeclareOption{draft}{\setlength\overfullrule{5pt}}
+\DeclareOption{final}{\setlength\overfullrule{0pt}}
+\newif\if at colour\@colourtrue
+\DeclareOption{nocolour}{\@colourfalse}
+\ExecuteOptions{a4paper,11pt,colour,final}
+\ProcessOptions\relax
+\input{size1\@ptsize.clo}
+\RequirePackage{graphicx}
+\RequirePackage{pstricks}
+\RequirePackage{ifthen}
+\RequirePackage{marvosym}
+\addtolength{\oddsidemargin}{-54pt}
+\addtolength{\textwidth}{109pt}
+\addtolength{\topmargin}{-70pt}
+\addtolength{\textheight}{122pt}
+\addtolength{\marginparsep}{-5pt}
+\addtolength{\marginparwidth}{-10pt}
+\RequirePackage{url}
+\RequirePackage{hyperref}
+\hypersetup{%
+  breaklinks,
+  baseurl       = http://,%
+  pdfborder     = 0 0 0,%
+  pdfpagemode   = UseNone,%
+  pdfstartpage  = 1}
+\AtEndOfClass{%
+  \AtBeginDocument{%
+    \hypersetup{%
+      pdfauthor     = \@firstname~\@familyname,%
+      pdftitle      = \@title,%
+      pdfsubject    = \@firstname~\@familyname,%
+      pdfkeywords   = \@resumename~\@firstname~\@familyname}}}
+\urlstyle{tt}
+\RequirePackage{fancyhdr}
+\fancypagestyle{plain}{%
+  \renewcommand{\headrulewidth}{0pt}
+  \renewcommand{\footrulewidth}{0pt}
+  \fancyhf{}}
+\pagestyle{plain}
+\setlength\lineskip{1\p@}
+\setlength\normallineskip{1\p@}
+\renewcommand\baselinestretch{}
+\setlength{\parindent}{0pt}
+\setlength{\parskip}{0pt}
+\setlength\columnsep{10\p@}
+\setlength\columnseprule{0\p@}
+\pagestyle{empty}
+\pagenumbering{arabic}
+\raggedbottom
+\onecolumn
+\providecommand*{\listitemsymbol}{\textbullet}
+\providecommand*{\addresssymbol}{}
+\providecommand*{\mobilesymbol}{\Mobilefone}
+\providecommand*{\phonesymbol}{\Telefon}
+\providecommand*{\faxsymbol}{\FAX}
+\providecommand*{\emailsymbol}{\Letter}
+\def\firstnamecolour#1{\gdef\@firstnamecolour{\addfontfeature{Color=#1}}}
+\def\familynamecolour#1{\gdef\@familynamecolour{\addfontfeature{Color=#1}}}
+\def\titlecolour#1{\gdef\@titlecolour{\addfontfeature{Color=#1}}}
+\def\addresscolour#1{\gdef\@addresscolour{\addfontfeature{Color=#1}}}
+\def\quotecolour#1{\gdef\@quotecolour{\addfontfeature{Color=#1}}}
+\def\sectiontitlecolour#1{\gdef\@sectiontitlecolour{\addfontfeature{Color=#1}}}
+\def\subsectioncolour#1{\gdef\@subsectioncolour{\addfontfeature{Color=#1}}}
+\def\hintcolour#1{\gdef\@hintcolour{\addfontfeature{Color=#1}}}
+\providecommand*{\firstnamefont}{}
+\providecommand*{\familynamefont}{}
+\providecommand*{\titlefont}{}
+\providecommand*{\addressfont}{}
+\providecommand*{\quotefont}{}
+\providecommand*{\sectionfont}{}
+\providecommand*{\subsectionfont}{}
+\providecommand*{\hintfont}{\small}
+\providecommand*{\firstnamestyle}[1]{{\firstnamefont\@firstnamecolour#1}}
+\providecommand*{\familynamestyle}[1]{{\familynamefont\@familynamecolour#1}}
+\providecommand*{\titlestyle}[1]{{\titlefont\@titlecolour#1}}
+\providecommand*{\addresstyle}[1]{{\addressfont\@addresscolour#1}}
+\providecommand*{\quotestyle}[1]{{\quotefont\@quotecolour#1}}
+\providecommand*{\sectionstyle}[1]{{\sectionfont\@sectiontitlecolour#1}}
+\providecommand*{\subsectionstyle}[1]{{\subsectionfont\@subsectioncolour#1}}
+\providecommand*{\hintstyle}[1]{{\hintfont\@hintcolour#1}}
+\newcommand*{\cvtheme}[2][]{
+  \def\@cvtheme{#2}
+  \def\@cvthemeoptions{#1}}
+\cvtheme{bidi-casual}
+\AtBeginDocument{\RequirePackage[\@cvthemeoptions]{cvtheme\@cvtheme}}
+\newcommand*{\resumename}[1]{\def\@resumename{#1}}
+\newcommand*{\firstname}[1]{\def\@firstname{#1}}
+\newcommand*{\familyname}[1]{\def\@familyname{#1}}
+\renewcommand*{\title}[1]{\def\@title{#1}}
+\newcommand*{\address}[1]{\def\@address{#1}}
+\newcommand*{\mobile}[1]{\def\@mobile{#1}}
+\newcommand*{\phone}[1]{\def\@phone{#1}}
+\renewcommand*{\fax}[1]{\def\@fax{#1}}
+\newcommand*{\email}[1]{\def\@email{#1}}
+\newcommand*{\extrainfo}[1]{\def\@extrainfo{#1}}
+\def\@photowidth{0pt}
+\newcommand*{\photo}[2][64pt]{\def\@photowidth{#1}\def\@photo{#2}}
+\newcommand*{\quote}[1]{\def\@quote{#1}}
+\newlength{\quotewidth}
+\newlength{\hintscolumnwidth}
+\newlength{\separatorcolumnwidth}
+\setlength{\separatorcolumnwidth}{0.025\textwidth}
+\newlength{\maincolumnwidth}
+\newlength{\doubleitemmaincolumnwidth}
+\newlength{\listitemsymbolwidth}
+\settowidth{\listitemsymbolwidth}{\listitemsymbol{}~}
+\newlength{\listitemmaincolumnwidth}
+\newlength{\listdoubleitemmaincolumnwidth}
+\newcommand*{\recomputethemelengths}{}
+\newcommand*{\recomputelengths}{%
+\setlength{\quotewidth}{0.65\textwidth}%
+\setlength{\maincolumnwidth}{\textwidth}%
+\addtolength{\maincolumnwidth}{-\separatorcolumnwidth}%
+\addtolength{\maincolumnwidth}{-\hintscolumnwidth}%
+\setlength{\listitemmaincolumnwidth}{\maincolumnwidth}%
+\addtolength{\listitemmaincolumnwidth}{-\listitemsymbolwidth}%
+\setlength{\doubleitemmaincolumnwidth}{\maincolumnwidth}%
+\addtolength{\doubleitemmaincolumnwidth}{-\hintscolumnwidth}%
+\addtolength{\doubleitemmaincolumnwidth}{-\separatorcolumnwidth}%
+\setlength{\doubleitemmaincolumnwidth}{0.5\doubleitemmaincolumnwidth}%
+\setlength{\listdoubleitemmaincolumnwidth}{\maincolumnwidth}%
+\addtolength{\listdoubleitemmaincolumnwidth}{-\listitemsymbolwidth}%
+\setlength{\listdoubleitemmaincolumnwidth}{0.475\listdoubleitemmaincolumnwidth}%
+\renewcommand{\headwidth}{\textwidth}%
+\recomputethemelengths}
+\setlength{\hintscolumnwidth}{0.15\textwidth}
+\recomputelengths
+\title{}
+\renewcommand*{\maketitle}{}
+\newcommand*{\section}[1]{%
+\vspace*{2.5ex \@plus 1ex \@minus .2ex}%
+  \phantomsection{}%
+  \addcontentsline{toc}{part}{#1}%
+  \parbox[m]{\hintscolumnwidth}{\raggedleft\hintfont{\beginL\psline[linecolor=sectionrectanglecolour,linewidth=4pt](-2.5,0)(0,0)\endL}}%
+  \hspace{\separatorcolumnwidth}%
+  \parbox[m]{\maincolumnwidth}{\sectionstyle{#1}}\\[1ex]}
+\newcommand*{\subsection}[1]{%
+  \cvline[0.45em]{}{\subsectionstyle{#1}}}
+\newcommand*{\cvline}[3][.25em]{%
+  \begin{tabular}{@{}p{\hintscolumnwidth}@{\hspace{\separatorcolumnwidth}}p{\maincolumnwidth}@{}}%
+    \raggedleft\hintfont{#2} &{#3}%
+  \end{tabular}\\[#1]}
+\newcommand*{\cvdoubleitem}[4]{%
+ \cvline{#1}{\begin{minipage}[t]{\doubleitemmaincolumnwidth}#2\end{minipage}%
+ \hfill%
+ \begin{minipage}[t]{\hintscolumnwidth}\raggedleft\hintfont{#3}\end{minipage}\hspace*{\separatorcolumnwidth}\begin{minipage}[t]{\doubleitemmaincolumnwidth}#4\end{minipage}}}
+\newcommand*{\cvlistitem}[2][\listitemsymbol{}]{%
+  \cvline[0pt]{}{#1~\begin{minipage}[t]{\listitemmaincolumnwidth}#2\end{minipage}}}
+\newcommand*{\cvlistdoubleitem}[3][\listitemsymbol{}]{%
+  \cvline[0pt]{}{#1~\begin{minipage}[t]{\listdoubleitemmaincolumnwidth}#2\end{minipage}%
+  \hfill%
+  \ifthenelse{\equal{#3}{}}%
+    {}%
+    {#1~\begin{minipage}[t]{\listdoubleitemmaincolumnwidth}#3\end{minipage}}}}
+\newcommand*{\cventry}[6]{%
+  \cvline{#1}{%
+    {\bfseries#2}%
+    \ifx#3\else{, {\slshape#3}}\fi%
+    \ifx#4\else{, #4}\fi%
+    \ifx#5\else{, #5}\fi%
+    .%
+    \ifx#6\else{\newline{}\begin{minipage}[t]{\linewidth}\small#6\end{minipage}}\fi
+    }}%
+\newcommand*{\cvlanguage}[3]{%
+  \cvline{#1}{\begin{minipage}[t]{.225\maincolumnwidth}\textbf{#2}\end{minipage}\hfill\begin{minipage}[t]{0.725\maincolumnwidth}\raggedleft\footnotesize\itshape #3\end{minipage}}}
+\newcommand*{\cvcomputer}[4]{%
+  \cvdoubleitem{#1}{\small#2}{#3}{\small#4}}
+\newcommand*{\link}[2][]{%
+  \ifthenelse{\equal{#1}{}}%
+    {\beginL\href{#2}{\beginR#2\endR}\endL}%
+    {\beginL\href{#2}{\beginR#1\endR}\endL}}
+\newcommand*{\httplink}[2][]{%
+  \ifthenelse{\equal{#1}{}}%
+    {\beginL\href{http://#2}{\beginR#2\endR}\endL}%
+    {\beginL\href{http://#2}{\beginR#1\endR}\endL}}
+\newcommand*{\emaillink}[2][]{%
+  \ifthenelse{\equal{#1}{}}%
+    {\beginL\href{mailto:#2}{\beginR#2\endR}\endL}%
+    {\beginL\href{mailto:#2}{\beginR#1\endR}\endL}}
+\newif\if at displaypagenumbers\@displaypagenumberstrue
+\newcommand*{\nopagenumbers}{\@displaypagenumbersfalse}
+\AtBeginDocument{%
+  \if at displaypagenumbers%
+    \@ifundefined{r at lastpage}{}{%
+      \ifthenelse{\pageref{lastpage} > 1}{%
+      \fancypagestyle{plain}{%
+        \fancyfoot[r]{\beginL\addressfont\@quotecolour\footnotesize\thepage\beginL/\endL\pageref{lastpage}\endL}}%
+      \pagestyle{plain}}{}}%
+  \AtEndDocument{\label{lastpage}}%
+  \fi}
+\newlength{\bibindent}
+\setlength{\bibindent}{1.5em}
+\newcommand*{\bibliographyitemlabel}{\includegraphics{bibitem.pdf}}
+\newenvironment{thebibliography}[1]%
+  {%
+    \section{\refname}%
+    \small%
+    \begin{list}{\bibliographyitemlabel}%
+      {%
+        \setlength{\topsep}{0pt}%
+        \setlength{\labelwidth}{\hintscolumnwidth}%
+        \setlength{\labelsep}{\separatorcolumnwidth}%
+        \leftmargin\labelwidth%
+        \advance\leftmargin\labelsep%
+        \@openbib at code%
+        \usecounter{enumiv}%
+        \let\p at enumiv\@empty%
+        \renewcommand\theenumiv{\@arabic\c at enumiv}}%
+        \sloppy\clubpenalty4000\widowpenalty4000%
+  }%
+  {%
+    \def\@noitemerr{\@latex at warning{Empty `thebibliography' environment}}%
+    \end{list}%
+  }
+\newcommand\newblock{\hskip .11em\@plus.33em\@minus.07em}
+\let\@openbib at code\@empty
+
+%% 
+%% Copyright ?? 2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `bidimoderncv.cls'.

Added: tags/texmf/tex/xelatex/bidi/bidipresentation.cls
===================================================================
--- tags/texmf/tex/xelatex/bidi/bidipresentation.cls	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/bidi/bidipresentation.cls	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,102 @@
+%%
+%% This is file `bidipresentation.cls',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% bidi.dtx  (with options: `bidipresentation.cls')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\NeedsTeXFormat{LaTeX2e}
+\ProvidesClass{bidipresentation}
+\DeclareOption*{\PassOptionsToClass{\CurrentOption}{article}}
+\ProcessOptions\relax
+\LoadClass{article}
+
+\RequirePackage[foot=10.2pt,head=0pt,paperwidth=128mm,paperheight=96mm,left=5mm,top=5mm,right=7mm,bottom=8mm]{geometry}
+
+\RequirePackage{fancyhdr}
+\renewcommand{\headrulewidth}{0mm}
+
+\renewcommand{\maketitle}%
+  {\ClassError{bidipresentation}{Caution: ``maketitle'' command not supported}%
+  {Please use ``titlepage'' environment instead}%
+}
+
+\fancypagestyle{pres}{%
+\fancyhf{}%
+\fancyfoot[RO,LE]{\footnotesize \thepage}%
+}
+
+\pagestyle{pres}
+
+\newcommand{\distance}[1]{\vspace*{\stretch{#1}}}
+\newcommand{\abstand}[1]{\vspace*{\stretch{#1}}}
+
+\setlength{\parskip}{0.6ex}
+\setlength{\parindent}{0mm}
+
+\newenvironment{plainslide}[1][]%
+   {{\raggedleft \large\bfseries #1\par}\par\vspace*{\stretch{1}}}%
+   {\par\vspace*{\stretch{1}}\newpage}
+
+\newenvironment{rawslide}{}{\newpage}%
+
+\def\itemize{%
+  \ifnum \@itemdepth >\thr@@\@toodeep\else
+    \advance\@itemdepth\@ne
+    \edef\@itemitem{labelitem\romannumeral\the\@itemdepth}%
+    \expandafter
+    \list
+      \csname\@itemitem\endcsname
+      {\def\makelabel##1{\hss\llap{##1}}}%
+  \fi
+    \setlength{\itemsep}{0ex}%
+    \setlength{\parskip}{0.1ex}%
+    \setlength{\parsep}{0ex}%
+    }%
+\let\enditemize =\endlist
+
+\def\enumerate{%
+  \ifnum \@enumdepth >\thr@@\@toodeep\else
+    \advance\@enumdepth\@ne
+    \edef\@enumctr{enum\romannumeral\the\@enumdepth}%
+      \expandafter
+      \list
+        \csname label\@enumctr\endcsname
+        {\usecounter\@enumctr\def\makelabel##1{\hss\llap{##1}}}%
+  \fi
+    \setlength{\itemsep}{0ex}%
+    \setlength{\parskip}{0.1ex}%
+    \setlength{\parsep}{0ex}%
+    }%
+\let\endenumerate =\endlist
+
+\renewenvironment{description}
+               {\list{}{\labelwidth\z@ \itemindent-\leftmargin
+                        \let\makelabel\descriptionlabel}
+ \setlength{\itemsep}{0ex}%
+    \setlength{\parskip}{0.1ex}%
+    \setlength{\parsep}{0ex}}
+               {\endlist}
+
+%% 
+%% Copyright ?? 2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `bidipresentation.cls'.

Added: tags/texmf/tex/xelatex/bidi/book-bidi.def
===================================================================
--- tags/texmf/tex/xelatex/bidi/book-bidi.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/bidi/book-bidi.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,149 @@
+%%
+%% This is file `book-bidi.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% bidi.dtx  (with options: `book-bidi.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\renewcommand*\l at part[2]{%
+  \ifnum \c at tocdepth >-2\relax
+    \addpenalty{-\@highpenalty}%
+    \addvspace{2.25em \@plus\p@}%
+    \setlength\@tempdima{3em}%
+    \begingroup
+      \parindent \z@ \if at RTL\leftskip\else\rightskip\fi \@pnumwidth
+      \parfillskip -\@pnumwidth
+      {\leavevmode
+       \large \bfseries #1\hfil \hb at xt@\@pnumwidth{\hss #2}}\par
+       \nobreak
+         \global\@nobreaktrue
+         \everypar{\global\@nobreakfalse\everypar{}}%
+    \endgroup
+  \fi}
+\renewcommand\theequation
+  {\ifnum \c at chapter>\z@ \thechapter\@SepMark\fi \@arabic\c at equation}
+\renewcommand \thefigure
+     {\ifnum \c at chapter>\z@ \thechapter\@SepMark\fi \@arabic\c at figure}
+\renewcommand \thetable
+     {\ifnum \c at chapter>\z@ \thechapter\@SepMark\fi \@arabic\c at table}
+\renewcommand \thechapter {\@arabic\c at chapter}
+\renewcommand \thesection {\thechapter\@SepMark\@arabic\c at section}
+\renewcommand\thesubsection   {\thesection\@SepMark\@arabic\c at subsection}
+\renewcommand\thesubsubsection{\thesubsection \@SepMark\@arabic\c at subsubsection}
+\renewcommand\theparagraph    {\thesubsubsection\@SepMark\@arabic\c at paragraph}
+\renewcommand\thesubparagraph {\theparagraph\@SepMark\@arabic\c at subparagraph}
+\def\@makechapterhead#1{%
+  \vspace*{50\p@}%
+  {\parindent \z@ \raggedleft \normalfont
+    \ifnum \c at secnumdepth >\m at ne
+      \if at mainmatter
+        \huge\bfseries \@chapapp\space \thechapter
+        \par\nobreak
+        \vskip 20\p@
+      \fi
+    \fi
+    \interlinepenalty\@M
+    \Huge \bfseries #1\par\nobreak
+    \vskip 40\p@
+  }}
+\def\@makeschapterhead#1{%
+  \vspace*{50\p@}%
+  {\parindent \z@ \raggedleft
+    \normalfont
+    \interlinepenalty\@M
+    \Huge \bfseries  #1\par\nobreak
+    \vskip 40\p@
+  }}
+\renewenvironment{thebibliography}[1]
+     {\chapter*{\bibname}%
+      \@mkboth{\MakeUppercase\bibname}{\MakeUppercase\bibname}%
+      \list{\@biblabel{\@arabic\c at enumiv}}%
+           {\settowidth\labelwidth{\@biblabel{#1}}%
+            \rightmargin\labelwidth
+            \advance\rightmargin\labelsep
+            \@openbib at code
+            \usecounter{enumiv}%
+            \let\p at enumiv\@empty
+            \renewcommand\theenumiv{\@arabic\c at enumiv}}%
+      \sloppy
+      \clubpenalty4000
+      \@clubpenalty \clubpenalty
+      \widowpenalty4000%
+      \sfcode`\.\@m}
+     {\def\@noitemerr
+       {\@latex at warning{Empty `thebibliography' environment}}%
+      \endlist}
+\renewcommand\backmatter{%
+  \if at openright
+    \cleardoublepage
+  \else
+    \clearpage
+  \fi
+  \@mainmatterfalse}
+
+\if at twoside
+  \def\ps at headings{%
+      \let\@oddfoot\@empty\let\@evenfoot\@empty
+      \def\@evenhead{\sl\beginR\rightmark\endR\hfil\thepage}%
+      \def\@oddhead{\sl\thepage\hfil\beginR\leftmark\endR}%
+      \let\@mkboth\markboth
+    \def\chaptermark##1{%
+      \markboth {\MakeUppercase{%
+ \beginR\@chapapp\ \thechapter.\,\,\endR%
+        \ifnum \c at secnumdepth >\m at ne
+          \if at mainmatter
+           \beginR##1\endR
+          \fi
+        \fi
+        }}{}}%
+    \def\ps at plain{\ps at empty
+\def\@oddfoot{\hfil\thepage\hfil}%
+\let\@evenfoot\@oddfoot
+}
+    \def\sectionmark##1{%
+      \markright {\MakeUppercase{%
+\beginR\thesection\endR\,
+        \ifnum \c at secnumdepth >\z@
+          \beginR##1\endR \ %
+        \fi
+        }}}}
+\else
+  \def\ps at headings{%
+    \let\@oddfoot\@empty
+    \def\@oddhead{\sl\thepage\hfil\beginR\rightmark\endR}%
+    \let\@mkboth\markboth
+    \def\chaptermark##1{%
+      \markright {\MakeUppercase{%
+       \beginR\@chapapp\ \thechapter. \endR %
+        \ifnum \c at secnumdepth >\m at ne
+          \if at mainmatter
+            \beginR##1\endR
+          \fi
+        \fi
+        }}}}
+
+\fi
+\pagestyle{headings}
+\def\@idxitem{\par\hangindent -40\p@}
+%% 
+%% Copyright ?? 2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `book-bidi.def'.

Added: tags/texmf/tex/xelatex/bidi/bookest-bidi.def
===================================================================
--- tags/texmf/tex/xelatex/bidi/bookest-bidi.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/bidi/bookest-bidi.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,93 @@
+%%
+%% This is file `bookest-bidi.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% bidi.dtx  (with options: `bookest-bidi.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\AtBeginDocument{
+\def\@makechapterhead#1{%
+  \vspace*{20\p@}
+  {\parindent \z@ \raggedleft \normalfont
+    \ifnum \c at secnumdepth >\m at ne
+      \if at mainmatter
+        {\colorA\huge\scshape \@chapapp\space \thechapter}
+        \par\nobreak
+        \vskip 10\p@
+      \fi
+    \fi
+    \interlinepenalty\@M
+  {\colorB\hrule}
+  \vskip 15\p@
+   \begin{flushleft}
+     {\colorA\Huge \bfseries #1}\par\nobreak
+   \end{flushleft}
+  \vskip 5\p@
+  {\colorB\hrule}
+  \vskip 30\p@
+  }}
+\def\@makeschapterhead#1{%
+  \vspace*{20\p@}
+  {\parindent \z@ \raggedright \normalfont
+  {\colorB\hrule}
+  \vskip 15\p@
+   \begin{center}
+     {\colorA\Huge \bfseries #1}\par\nobreak
+   \end{center}
+  \vskip 5\p@
+  {\colorB\hrule}
+  \vskip 30\p@
+  }}
+\renewcommand{\setevenhead}[1]{\def\@evenhead{#1}}
+\renewcommand{\setoddhead}[1]{\def\@oddhead{#1}}
+\renewcommand{\setevenfoot}[1]{\def\@evenfoot{#1}}
+\renewcommand{\setoddfoot}[1]{\def\@oddfoot{#1}}
+\renewcommand{\oddheadtext}{{\colorA{\slshape\rightmark}\hfill\thepage}}
+\renewcommand{\setoddheadtext}[1]{\renewcommand{\oddheadtext}{#1}}
+\renewcommand{\evenheadtext}{\oddheadtext}
+\renewcommand{\setevenheadtext}[1]{\renewcommand{\evenheadtext}{#1}}
+\renewcommand{\evenfoottext}{}
+\renewcommand{\setevenfoottext}[1]{\renewcommand{\evenfoottext}{#1}}
+\renewcommand{\oddfoottext}{}
+\renewcommand{\setoddfoottext}[1]{\renewcommand{\oddfoottext}{#1}}
+\renewcommand{\setleftmark}[1]{\renewcommand{\leftmark}{#1}}
+\renewcommand{\setrightmark}[1]{\renewcommand{\rightmark}{#1}}
+\renewcommand{\makeheadrule}{{\colorB\hrule\@width\textwidth \@height 0.4pt \vskip-0.4pt}}
+\renewcommand{\makefootrule}{\makeheadrule}
+\if at twoside
+  \setevenheadtext{{\colorA\thepage\hfill\slshape\leftmark}}
+\fi
+\setevenhead{\vbox{\evenheadtext \vskip 5\p@ \makeheadrule}}
+\setoddhead{\vbox{\oddheadtext \vskip 5\p@ \makeheadrule}}
+\let\UCase\MakeUppercase
+\renewcommand{\MakeUppercase}{}
+\def\ps at plain{%
+    \def\@oddfoot{{\hfil\colorA\thepage\hfil}}
+    \def\@evenfoot{{\hfil\colorA\thepage\hfil}}
+    \let\@oddhead\@empty
+    \let\@evenhead\@empty
+}
+}
+\NoHyper
+%% 
+%% Copyright ?? 2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `bookest-bidi.def'.

Added: tags/texmf/tex/xelatex/bidi/cvthemebidicasual.sty
===================================================================
--- tags/texmf/tex/xelatex/bidi/cvthemebidicasual.sty	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/bidi/cvthemebidicasual.sty	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,118 @@
+%%
+%% This is file `cvthemebidicasual.sty',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% bidi.dtx  (with options: `cvthemebidicasual.sty')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\NeedsTeXFormat{LaTeX2e}
+\ProvidesPackage{cvthemebidicasual}
+\DeclareOption{blue}{}
+\newif\if at colourorange\@colourorangefalse
+\DeclareOption{orange}{\@colourorangetrue}
+\newif\if at colourgreen\@colourgreenfalse
+\DeclareOption{green}{\@colourgreentrue}
+\newif\if at colourred\@colourredfalse
+\DeclareOption{red}{\@colourredtrue}
+\newif\if at colourgrey\@colourgreyfalse
+\DeclareOption{grey}{\@colourgreytrue}
+\DeclareOption*{
+  \PackageWarning{cvthemebidicasual}{Unknown option ???\CurrentOption???}}
+\ExecuteOptions{colour}
+\ProcessOptions\relax
+\renewcommand*{\listitemsymbol}{\textbullet}
+\familynamecolour{808080}
+\firstnamecolour{A9A9A9}
+\quotecolour{696969}
+\addresscolour{696969}
+\definecolor{sectionrectanglecolour}{rgb}{0.25,0.50,0.75}
+\sectiontitlecolour{1E90FF}
+\subsectioncolour{4682B4}
+\definecolor{rulecolour}{gray}{0.6}
+\definecolor{footersymbolcolour}{rgb}{0.25,0.50,0.75}
+\if at colourorange
+  \definecolor{sectionrectanglecolour}{rgb}{1.00,0.65,0.20}
+  \sectiontitlecolour{FF8C00}
+  \subsectioncolour{FF8C00}
+  \definecolor{footersymbolcolour}{rgb}{0.95,0.55,0.15}\fi
+\if at colourgreen
+  \definecolor{sectionrectanglecolour}{rgb}{0.55,0.85,0.35}
+  \sectiontitlecolour{008000}
+  \subsectioncolour{008000}
+  \definecolor{footersymbolcolour}{rgb}{0.30,0.65,0.15}\fi
+\if at colourred
+  \definecolor{sectionrectanglecolour}{rgb}{1.00,0.30,0.30}
+  \sectiontitlecolour{FF0000}
+  \subsectioncolour{FF0000}
+  \definecolor{footersymbolcolour}{rgb}{0.95,0.20,0.20}\fi
+\if at colourgrey
+  \definecolor{sectionrectanglecolour}{rgb}{0.75,0.75,0.75}
+  \sectiontitlecolour{808080}
+  \subsectioncolour{808080}
+  \definecolor{footersymbolcolour}{rgb}{0.35,0.35,0.35}\fi
+\renewcommand*{\ttdefault}{pcr}
+\renewcommand*{\firstnamefont}{\fontsize{38}{40}\mdseries\upshape}
+\renewcommand*{\familynamefont}{\firstnamefont}
+\renewcommand*{\addressfont}{\normalsize\mdseries\slshape}
+\renewcommand*{\quotefont}{\large\slshape}
+\renewcommand*{\sectionfont}{\Large\mdseries\upshape}
+\renewcommand*{\subsectionfont}{\large\mdseries\upshape}
+\renewcommand*{\maketitle}{%
+  {\beginL%
+    \ifthenelse{\isundefined{\@photo}}%
+      {}%
+      {{\framebox{\includegraphics[width=\@photowidth]{\@photo}}}}%
+    \hfill%
+    \raggedleft{\beginR\firstnamestyle{\@firstname}~\familynamestyle{\@familyname}\endR}\endL\\[-.35em]}%
+  {\beginL\psline[linewidth=2pt,linecolor=rulecolour](-11.2,-0.2)(5.6,-0.2)\endL\\[2.5em]}%
+  \ifthenelse{\isundefined{\@quote}}%
+    {}%
+    {\centering{\begin{minipage}{\quotewidth}\centering\quotestyle{\@quote}\end{minipage}}\\[2.5em]}%
+  }%
+\newif\if at firstfooterelement\@firstfooterelementtrue
+\providecommand*{\footersymbol}{}
+\renewcommand*{\footersymbol}{%
+  \if at firstfooterelement%
+  \else%
+    { ~~\beginL\psdot[linecolor=footersymbolcolour](0,0.1)\endL~~~}\fi}
+\providecommand*{\makefooter}{}
+\renewcommand*{\makefooter}{%
+  \fancypagestyle{plain}{%
+    \fancyfoot[c]{%
+      \parbox{0.8\textwidth}{%
+      \centering%
+      \addressfont\@addresscolour%
+      \ifthenelse{\isundefined{\@address}}{}{%
+        \beginR\addresssymbol~\@address\endR\\%
+        \@firstfooterelementfalse}%
+      \beginR\ifthenelse{\isundefined{\@mobile}}{}{\beginR\mobilesymbol~\@mobile\endR\@firstfooterelementfalse}%
+      \ifthenelse{\isundefined{\@phone}}{}{\footersymbol\beginR\phonesymbol~\@phone\endR\@firstfooterelementfalse}%
+      \ifthenelse{\isundefined{\@fax}}{}{\footersymbol\beginR\faxsymbol~\@fax\endR\@firstfooterelementfalse}%
+      \ifthenelse{\isundefined{\@email}}{}{\footersymbol\beginR\emailsymbol~\emaillink{\@email}\endR\@firstfooterelementfalse}%
+      \ifthenelse{\isundefined{\@extrainfo}}{}{\beginR\footersymbol\@extrainfo\endR\@firstfooterelementfalse}\endR}}%
+  }%
+  \pagestyle{plain}}
+\AtBeginDocument{\makefooter}
+
+%% 
+%% Copyright ?? 2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `cvthemebidicasual.sty'.

Added: tags/texmf/tex/xelatex/bidi/cvthemebidiclassic.sty
===================================================================
--- tags/texmf/tex/xelatex/bidi/cvthemebidiclassic.sty	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/bidi/cvthemebidiclassic.sty	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,130 @@
+%%
+%% This is file `cvthemebidiclassic.sty',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% bidi.dtx  (with options: `cvthemebidiclassic.sty')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\NeedsTeXFormat{LaTeX2e}
+\ProvidesPackage{cvthemebidiclassic}
+\DeclareOption{blue}{}
+\newif\if at colourorange\@colourorangefalse
+\DeclareOption{orange}{\@colourorangetrue}
+\newif\if at colourgreen\@colourgreenfalse
+\DeclareOption{green}{\@colourgreentrue}
+\newif\if at colourred\@colourredfalse
+\DeclareOption{red}{\@colourredtrue}
+\newif\if at colourgrey\@colourgreyfalse
+\DeclareOption{grey}{\@colourgreytrue}
+\DeclareOption*{
+  \PackageWarning{cvthemebidiclassic}{Unknown option ???\CurrentOption???}}
+\ExecuteOptions{colour}
+\ProcessOptions\relax
+\renewcommand*{\listitemsymbol}{\textbullet}
+\firstnamecolour{}
+\familynamecolour{}
+\titlecolour{808080}
+\quotecolour{696969}
+\addresscolour{696969}
+\definecolor{sectionrectanglecolour}{rgb}{0.25,0.50,0.75}
+\sectiontitlecolour{1E90FF}
+\subsectioncolour{4682B4}
+\if at colourorange
+  \addresscolour{FF8C00}
+  \definecolor{sectionrectanglecolour}{rgb}{1.00,0.65,0.20}
+  \sectiontitlecolour{FF8C00}
+  \subsectioncolour{FF8C00}\fi
+\if at colourgreen
+  \addresscolour{008000}
+  \definecolor{sectionrectanglecolour}{rgb}{0.55,0.85,0.35}
+  \sectiontitlecolour{008000}
+  \subsectioncolour{008000}\fi
+\if at colourred
+  \addresscolour{FF0000}
+  \definecolor{sectionrectanglecolour}{rgb}{1.00,0.30,0.30}
+  \sectiontitlecolour{FF0000}
+  \subsectioncolour{FF0000}\fi
+\if at colourgrey
+  \addresscolour{808080}
+  \definecolor{sectionrectanglecolour}{rgb}{0.75,0.75,0.75}
+  \sectiontitlecolour{808080}
+  \subsectioncolour{808080}\fi
+\renewcommand*{\ttdefault}{pcr}
+\renewcommand*{\firstnamefont}{\fontsize{34}{36}\mdseries\upshape}
+\renewcommand*{\titlefont}{\LARGE\mdseries\slshape}
+\renewcommand*{\addressfont}{\normalsize\mdseries\slshape}
+\renewcommand*{\familynamefont}{\firstnamefont}
+\renewcommand*{\quotefont}{\large\slshape}
+\renewcommand*{\sectionfont}{\Large\mdseries\upshape}
+\renewcommand*{\subsectionfont}{\large\mdseries\upshape}
+\newlength{\maketitlenamemaxwidth}
+\setlength{\maketitlenamemaxwidth}{.525\textwidth}
+\newlength{\maketitlenamefullwidth}
+\settowidth{\maketitlenamefullwidth}{\firstnamestyle{\@firstname~}\familynamestyle{\@familyname}}
+\newlength{\maketitlenamewidth}
+\ifnum\maketitlenamemaxwidth<\maketitlenamefullwidth\setlength{\maketitlenamewidth}{\maketitlenamemaxwidth}\else\setlength{\maketitlenamewidth}{\maketitlenamefullwidth}\fi
+\newlength{\maketitlepicturewidth}
+\setlength{\maketitlepicturewidth}{\@photowidth}
+\newlength{\maketitledetailswidth}
+\renewcommand*{\recomputethemelengths}{%
+  \setlength{\maketitledetailswidth}{\textwidth}%
+  \addtolength{\maketitledetailswidth}{-\maketitlenamewidth}%
+  \addtolength{\maketitledetailswidth}{-\separatorcolumnwidth}%
+  \addtolength{\maketitledetailswidth}{-\maketitlepicturewidth}}
+\recomputethemelengths
+\newif\if at firstdetailselement\@firstdetailselementtrue
+\newcommand*{\maketitledetailsnewline}{
+  \if at firstdetailselement%
+    \@firstdetailselementfalse%
+  \else%
+    \\[.2em]\fi}
+\renewcommand*{\maketitle}{%
+  % name and title
+  \begin{minipage}[b]{\maketitlenamewidth}%
+    \firstnamestyle{\@firstname~}\familynamestyle{\@familyname}%
+    \ifthenelse{\equal{\@title}{}}{}{\\[1.25em]\titlestyle{\@title}}%
+  \end{minipage}%
+  % optional data
+  \begin{minipage}[b]{\maketitledetailswidth}%
+    \raggedleft\addressfont\@addresscolour%
+   \ifthenelse{\isundefined{\@address}}{}{%
+      \maketitledetailsnewline%
+      \addresssymbol~\\\@address}%
+    \ifthenelse{\isundefined{\@mobile}}{}{\maketitledetailsnewline\mobilesymbol~\@mobile}%
+    \ifthenelse{\isundefined{\@phone}}{}{\maketitledetailsnewline\phonesymbol~\@phone}%
+    \ifthenelse{\isundefined{\@fax}}{}{\maketitledetailsnewline\faxsymbol~\@fax}%
+    \ifthenelse{\isundefined{\@email}}{}{\maketitledetailsnewline\emailsymbol~\emaillink{\@email}}%
+    \ifthenelse{\isundefined{\@extrainfo}}{}{\maketitledetailsnewline\@extrainfo}%
+  \end{minipage}%
+  % optional photo
+  \ifthenelse{\isundefined{\@photo}}%
+    {}%
+    {\hspace*{\separatorcolumnwidth}\framebox{\includegraphics[width=\maketitlepicturewidth]{\@photo}}}\\[3em]%
+  % optional quote
+  \ifthenelse{\isundefined{\@quote}}%
+    {}%
+    {\centering{\begin{minipage}{\quotewidth}\centering\quotestyle{\@quote}\end{minipage}}\\[2.5em]}%
+  }
+
+%% 
+%% Copyright ?? 2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `cvthemebidiclassic.sty'.

Added: tags/texmf/tex/xelatex/bidi/draftwatermark-bidi.def
===================================================================
--- tags/texmf/tex/xelatex/bidi/draftwatermark-bidi.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/bidi/draftwatermark-bidi.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,31 @@
+%%
+%% This is file `draftwatermark-bidi.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% bidi.dtx  (with options: `draftwatermark-bidi.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\renewcommand\SetWatermarkText[1]{%
+  \def\sc at wm@text{\if at RTL\beginR\fi#1\if at RTL\endR\fi}}
+%% 
+%% Copyright ?? 2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `draftwatermark-bidi.def'.

Added: tags/texmf/tex/xelatex/bidi/extbook-bidi.def
===================================================================
--- tags/texmf/tex/xelatex/bidi/extbook-bidi.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/bidi/extbook-bidi.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,148 @@
+%%
+%% This is file `extbook-bidi.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% bidi.dtx  (with options: `extbook-bidi.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\renewcommand*\l at part[2]{%
+  \ifnum \c at tocdepth >-2\relax
+    \addpenalty{-\@highpenalty}%
+    \addvspace{2.25em \@plus\p@}%
+    \begingroup
+      \parindent \z@ \if at RTL\leftskip\else\rightskip\fi \@pnumwidth
+      \parfillskip -\@pnumwidth
+      {\leavevmode
+       \large \bfseries #1\hfil \hb at xt@\@pnumwidth{\hss #2}}\par
+       \nobreak
+         \global\@nobreaktrue
+         \everypar{\global\@nobreakfalse\everypar{}}%
+    \endgroup
+  \fi}
+\renewcommand\theequation
+  {\ifnum \c at chapter>\z@ \thechapter\@SepMark\fi \@arabic\c at equation}
+\renewcommand \thefigure
+     {\ifnum \c at chapter>\z@ \thechapter\@SepMark\fi \@arabic\c at figure}
+\renewcommand \thetable
+     {\ifnum \c at chapter>\z@ \thechapter\@SepMark\fi \@arabic\c at table}
+\renewcommand \thechapter {\@arabic\c at chapter}
+\renewcommand \thesection {\thechapter\@SepMark\@arabic\c at section}
+\renewcommand\thesubsection   {\thesection\@SepMark\@arabic\c at subsection}
+\renewcommand\thesubsubsection{\thesubsection \@SepMark\@arabic\c at subsubsection}
+\renewcommand\theparagraph    {\thesubsubsection\@SepMark\@arabic\c at paragraph}
+\renewcommand\thesubparagraph {\theparagraph\@SepMark\@arabic\c at subparagraph}
+\def\@makechapterhead#1{%
+  \vspace*{50\p@}%
+  {\parindent \z@ \raggedleft \normalfont
+    \ifnum \c at secnumdepth >\m at ne
+      \if at mainmatter
+        \huge\bfseries \@chapapp\space \thechapter
+        \par\nobreak
+        \vskip 20\p@
+      \fi
+    \fi
+    \interlinepenalty\@M
+    \Huge \bfseries #1\par\nobreak
+    \vskip 40\p@
+  }}
+
+\def\@makeschapterhead#1{%
+  \vspace*{50\p@}%
+  {\parindent \z@ \raggedleft
+    \normalfont
+    \interlinepenalty\@M
+    \Huge \bfseries  #1\par\nobreak
+    \vskip 40\p@
+  }}
+\renewenvironment{thebibliography}[1]
+     {\chapter*{\bibname}%
+      \@mkboth{\MakeUppercase\bibname}{\MakeUppercase\bibname}%
+      \list{\@biblabel{\@arabic\c at enumiv}}%
+           {\settowidth\labelwidth{\@biblabel{#1}}%
+            \rightmargin\labelwidth
+            \advance\rightmargin\labelsep
+            \@openbib at code
+            \usecounter{enumiv}%
+            \let\p at enumiv\@empty
+            \renewcommand\theenumiv{\@arabic\c at enumiv}}%
+      \sloppy
+      \clubpenalty4000
+      \@clubpenalty \clubpenalty
+      \widowpenalty4000%
+      \sfcode`\.\@m}
+     {\def\@noitemerr
+       {\@latex at warning{Empty `thebibliography' environment}}%
+      \endlist}
+\renewcommand\backmatter{%
+  \if at openright
+    \cleardoublepage
+  \else
+    \clearpage
+  \fi
+  \@mainmatterfalse}
+\if at twoside
+  \def\ps at headings{%
+      \let\@oddfoot\@empty\let\@evenfoot\@empty
+      \def\@evenhead{\sl\beginR\rightmark\endR\hfil\thepage}%
+      \def\@oddhead{\sl\thepage\hfil\beginR\leftmark\endR}%
+      \let\@mkboth\markboth
+    \def\chaptermark##1{%
+      \markboth {\MakeUppercase{%
+ \beginR\@chapapp\ \thechapter.\,\,\endR%
+        \ifnum \c at secnumdepth >\m at ne
+          \if at mainmatter
+           \beginR##1\endR
+          \fi
+        \fi
+        }}{}}%
+    \def\ps at plain{\ps at empty
+\def\@oddfoot{\hfil\thepage\hfil}%
+\let\@evenfoot\@oddfoot
+}
+    \def\sectionmark##1{%
+      \markright {\MakeUppercase{%
+\beginR\thesection\endR\,
+        \ifnum \c at secnumdepth >\z@
+          \beginR##1\endR \ %
+        \fi
+        }}}}
+\else
+  \def\ps at headings{%
+    \let\@oddfoot\@empty
+    \def\@oddhead{\sl\thepage\hfil\beginR\rightmark\endR}%
+    \let\@mkboth\markboth
+    \def\chaptermark##1{%
+      \markright {\MakeUppercase{%
+       \beginR\@chapapp\ \thechapter. \endR %
+        \ifnum \c at secnumdepth >\m at ne
+          \if at mainmatter
+            \beginR##1\endR
+          \fi
+        \fi
+        }}}}
+
+\fi
+\pagestyle{headings}
+\def\@idxitem{\par\hangindent -40\p@}
+%% 
+%% Copyright ?? 2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `extbook-bidi.def'.

Added: tags/texmf/tex/xelatex/bidi/fancyhdr-bidi.def
===================================================================
--- tags/texmf/tex/xelatex/bidi/fancyhdr-bidi.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/bidi/fancyhdr-bidi.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,39 @@
+%%
+%% This is file `fancyhdr-bidi.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% bidi.dtx  (with options: `fancyhdr-bidi.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\def\@fancyhead#1#2#3#4#5{\beginR#1\endR\hbox to\headwidth{\fancy at reset
+  \@fancyvbox\headheight{\hbox
+    {\rlap{\parbox[b]{\headwidth}{\raggedright\beginR#2\endR}}\hfill
+      \parbox[b]{\headwidth}{\centering\beginR#3\endR}\hfill
+      \llap{\parbox[b]{\headwidth}{\raggedleft\beginR#4\endR}}}\headrule}}\beginR#5\endR}
+\def\@fancyfoot#1#2#3#4#5{\beginR#1\endR\hbox to\headwidth{\fancy at reset
+    \@fancyvbox\footskip{\footrule
+      \hbox{\rlap{\parbox[t]{\headwidth}{\raggedright\beginR#2\endR}}\hfill
+        \parbox[t]{\headwidth}{\centering\beginR#3\endR}\hfill
+        \llap{\parbox[t]{\headwidth}{\raggedleft\beginR#4\endR}}}}}\beginR#5\endR}
+%% 
+%% Copyright ?? 2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `fancyhdr-bidi.def'.

Added: tags/texmf/tex/xelatex/bidi/footnote-bidi.def
===================================================================
--- tags/texmf/tex/xelatex/bidi/footnote-bidi.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/bidi/footnote-bidi.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,230 @@
+%%
+%% This is file `footnote-bidi.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% bidi.dtx  (with options: `footnote-bidi.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\if at RTLmain\@RTL at footnotetrue\else\@RTL at footnotefalse\fi
+\def\bidi at footnote@output{{%
+    \dimen0=\ht\footins
+    \advance\dimen0 by\dp\footins
+    \def\@elt##1##2{%
+      \ifx\bidi at footnoterule\relax\global\let\bidi at footnoterule##2\fi
+      \advance\dimen0 by -##1\relax
+      \ifdim\dimen0<\z@
+        {%
+  \let\@elt\relax\let\right at footnote\relax\let\left at footnote\relax
+  \dimen0=-\dimen0%
+  \xdef\new at bidi@footnote at list{\new at bidi@footnote at list\noexpand\@elt{\the\dimen0}{##2}}%
+}%
+      \fi
+      \ifdim\dimen0>\z@\else
+\let\right at footnote\relax\let\left at footnote\relax
+\def\@elt####1####2{%
+  {\let\@elt\relax
+  \xdef\new at bidi@footnote at list{\new at bidi@footnote at list\noexpand\@elt{####1}{####2}}}%
+}%
+      \fi
+    }%
+    \def\new at bidi@footnote at list{}%
+    \bidi at footnote@list
+    \global\let\bidi at footnote@list\new at bidi@footnote at list
+  }}
+\def\right at footnote{%
+  \hbox to \columnwidth
+  {\beginR \vbox{\kern -3\p@
+   \hrule width .4\columnwidth \kern2.6\p@}\hfil\endR}}
+\def\left at footnote{%
+   \hrule width .4\columnwidth\kern 2.6\p@}
+\def\textwidth at footnote{\kern-3\p@
+  \hrule \@width \textwidth \kern 2.6\p@}
+\def\right at footnoterule{\bidi at footnote@output\right at footnote\global\let\bidi at footnoterule\relax}
+\def\left at footnoterule{\bidi at footnote@output\left at footnote\global\let\bidi at footnoterule\relax}
+\def\textwidth at footnoterule{\bidi at footnote@output\textwidth at footnote\global\let\bidi at footnoterule\relax}
+\def\auto at footnoterule{\bidi at footnote@output
+  \ifx\bidi at footnoterule\relax\if at RTL\right at footnote\else\left at footnote\fi\else\bidi at footnoterule\fi
+  \global\let\bidi at footnoterule\relax}
+\def\leftfootnoterule{\def\footnoterule{\left at footnoterule}}
+\let\LRfootnoterule=\leftfootnoterule
+\def\rightfootnoterule{\def\footnoterule{\right at footnoterule}}
+\def\textwidthfootnoterule{\def\footnoterule{\textwidth at footnoterule}}
+\def\autofootnoterule{\def\footnoterule{\auto at footnoterule}}
+\def\@makefnmark{\hbox{$^{\hbox{\scriptsize\@thefnmark}}\m at th$}}
+\def\bidi at footnote@list{}
+\let\bidi at footnoterule\relax
+\def\RTLfootnote{\@ifnextchar[\@xRTLfootnote{\stepcounter\@mpfn
+     \protected at xdef\@thefnmark{\thempfn}
+     \@footnotemark\@RTLfootnotetext}}
+\def\@xRTLfootnote[#1]{
+   \begingroup
+     \csname c@\@mpfn\endcsname #1\relax
+     \unrestored at protected@xdef\@thefnmark{\thempfn}
+   \endgroup
+   \@footnotemark\@RTLfootnotetext}
+\def\LTRfootnote{\@ifnextchar[\@xLTRfootnote{\stepcounter\@mpfn
+     \protected at xdef\@thefnmark{\thempfn}
+     \@footnotemark\@LTRfootnotetext}}
+\def\@xLTRfootnote[#1]{
+   \begingroup
+     \csname c@\@mpfn\endcsname #1\relax
+     \unrestored at protected@xdef\@thefnmark{\thempfn}
+   \endgroup
+   \@footnotemark\@LTRfootnotetext}
+\def\insertRTL{\bgroup\beginR\@RTLtrue}
+\def\endinsertRTL{\endR\egroup}
+\def\insertLTR{\bgroup\beginL\@RTLfalse}
+\def\endinsertLTR{\endL\egroup}
+\DeclareRobustCommand\InLTR{\insertLTR}
+\DeclareRobustCommand\EInLTR{\endinsertLTR}
+\DeclareRobustCommand\InRTL{\insertRTL}
+\DeclareRobustCommand\EInRTL{\endinsertRTL}
+\def\parse at lsent#1#2\EInLTR#3#4#5\parse at end{\@sentdirfalse
+\def\@tempa{\InLTR}\def\@tempb{\EInLTR}\def\@tempc{#1}\def\@tempd{#4}%
+\ifx\@tempa\@tempc\ifx\@tempb\@tempd\@sentdirtrue\fi\fi}
+\def\parse at rsent#1#2\EInRTL#3#4#5\parse at end{\@sentdirfalse
+\def\@tempa{\InRTL}\def\@tempb{\EInRTL}\def\@tempc{#1}\def\@tempd{#4}%
+\ifx\@tempa\@tempc\ifx\@tempb\@tempd\@sentdirtrue\fi\fi}
+\def\iflsentence#1{\parse at lsent#1\EInLTR123\parse at end\if at sentdir}
+\def\ifrsentence#1{\parse at rsent#1\EInRTL123\parse at end\if at sentdir}
+\def\bidi at footnotetext@dir#1{%
+   \@tempswatrue
+   \ifrsentence{#1}\rtl\@tempswafalse\fi
+   \iflsentence{#1}\ltr\@tempswafalse\fi
+   \if at tempswa\if at RTL\rtl\else\ltr\fi\fi
+   \xdef\bidi at this@footnote{\if at RTL\noexpand\right at footnote\else\noexpand\left at footnote\fi}%
+}
+\def\bidi at footnotetext@after{%
+   {%
+     \let\@elt\relax\let\right at footnote\relax\let\left at footnote\relax
+     \dimen0=\ht\footins
+     \advance\dimen0 by\dp\footins
+     \xdef\bidi at footnote@list{\bidi at footnote@list\@elt{\the\dimen0}{\bidi at this@footnote}}%
+   }%
+}
+\def\setfootnoteRL{\@RTL at footnotetrue}
+\def\unsetfootnoteRL{\@RTL at footnotefalse}
+\def\setfootnoteLR{\unsetfootnoteRL}
+\long\def\@footnotetext#1{%
+    \begingroup
+    \setbox\footins
+    \vbox{\if at RTL@footnote\@RTLtrue\else\@RTLfalse\fi\reset at font\footnotesize
+    \interlinepenalty\interfootnotelinepenalty
+    \splittopskip\footnotesep
+    \splitmaxdepth \dp\strutbox \floatingpenalty \@MM
+    \hsize\columnwidth \@parboxrestore
+    \bidi at footnotetext@dir{#1}%
+    \protected at edef\@currentlabel{\csname p at footnote\endcsname\@thefnmark}\@makefntext
+    {\rule{\z@}{\footnotesep}\ignorespaces\if at RTL@footnote#1\else\rmfamily#1\fi\strut}}%
+     \bidi at footnotetext@after
+    \insert\footins{\unvbox\footins}%
+    \endgroup}
+\long\def\@RTLfootnotetext#1{%
+    \begingroup
+    \setbox\footins
+    \vbox{\@RTLtrue\reset at font\footnotesize
+    \interlinepenalty\interfootnotelinepenalty
+    \splittopskip\footnotesep
+    \splitmaxdepth \dp\strutbox \floatingpenalty \@MM
+    \hsize\columnwidth \@parboxrestore
+    \bidi at footnotetext@dir{#1}%
+    \protected at edef\@currentlabel{\csname p at footnote\endcsname\@thefnmark}\@makefntext
+    {\rule{\z@}{\footnotesep}\ignorespaces #1\strut}}%
+     \bidi at footnotetext@after
+    \insert\footins{\unvbox\footins}%
+    \endgroup}
+\long\def\@LTRfootnotetext#1{%
+    \begingroup
+    \setbox\footins
+    \vbox{\@RTLfalse\reset at font\footnotesize
+    \interlinepenalty\interfootnotelinepenalty
+    \splittopskip\footnotesep
+    \splitmaxdepth \dp\strutbox \floatingpenalty \@MM
+    \hsize\columnwidth \@parboxrestore
+    \bidi at footnotetext@dir{#1}%
+    \protected at edef\@currentlabel{\csname p at footnote\endcsname\@thefnmark}\@makefntext
+    {\rule{\z@}{\footnotesep}\ignorespaces\rmfamily #1\strut}}%
+     \bidi at footnotetext@after
+    \insert\footins{\unvbox\footins}%
+    \endgroup}
+\long\def\@mpRTLfootnotetext#1{
+  \global\setbox\@mpfootins\vbox{\@RTLtrue
+    \unvbox\@mpfootins
+    \reset at font\footnotesize
+    \hsize\columnwidth
+    \@parboxrestore
+    \protected at edef\@currentlabel
+         {\csname p at mpfootnote\endcsname\@thefnmark}
+    \color at begingroup
+     \bidi at footnotetext@dir{#1}
+    \if at RTL\global\let\bidi at footnoterule\right at footnote\else\global\let\bidi at footnoterule\left at footnote\fi
+      \@makefntext{
+        \rule\z@\footnotesep\ignorespaces#1\@finalstrut\strutbox}
+    \color at endgroup}}
+\long\def\@mpLTRfootnotetext#1{
+  \global\setbox\@mpfootins\vbox{\@RTLfalse
+    \unvbox\@mpfootins
+    \reset at font\footnotesize
+    \hsize\columnwidth
+    \@parboxrestore
+    \protected at edef\@currentlabel
+         {\csname p at mpfootnote\endcsname\@thefnmark}
+    \color at begingroup
+     \bidi at footnotetext@dir{#1}
+    \if at RTL\global\let\bidi at footnoterule\right at footnote\else\global\let\bidi at footnoterule\left at footnote\fi
+      \@makefntext{
+        \rule\z@\footnotesep\ignorespaces\rmfamily#1\@finalstrut\strutbox}
+    \color at endgroup}}
+\long\def\@mpfootnotetext#1{
+  \global\setbox\@mpfootins\vbox{\if at RTL@footnote\@RTLtrue\else\@RTLfalse\fi
+    \unvbox\@mpfootins
+    \reset at font\footnotesize
+    \hsize\columnwidth
+    \@parboxrestore
+    \protected at edef\@currentlabel
+         {\csname p at mpfootnote\endcsname\@thefnmark}
+    \color at begingroup
+     \bidi at footnotetext@dir{#1}
+    \if at RTL\global\let\bidi at footnoterule\right at footnote\else\global\let\bidi at footnoterule\left at footnote\fi
+      \@makefntext{
+        \rule\z@\footnotesep\ignorespaces\if at RTL@footnote#1\else\rmfamily#1\fi\@finalstrut\strutbox}
+    \color at endgroup}}
+\def\@iiiminipage#1#2[#3]#4{%
+  \leavevmode
+  \@pboxswfalse
+  \setlength\@tempdima{#4}%
+  \def\@mpargs{{#1}{#2}[#3]{#4}}%
+  \setbox\@tempboxa\vbox\bgroup
+    \color at begingroup
+      \hsize\@tempdima
+      \textwidth\hsize \columnwidth\hsize
+      \@parboxrestore
+      \def\@mpfn{mpfootnote}\def\thempfn{\thempfootnote}\c at mpfootnote\z@
+      \let\@footnotetext\@mpfootnotetext
+      \let\@LTRfootnotetext\@mpLTRfootnotetext
+      \let\@RTLfootnotetext\@mpRTLfootnotetext
+      \let\@listdepth\@mplistdepth \@mplistdepth\z@
+      \@minipagerestore
+      \@setminipage}
+%% 
+%% Copyright ?? 2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `footnote-bidi.def'.

Added: tags/texmf/tex/xelatex/bidi/graphicx-bidi.def
===================================================================
--- tags/texmf/tex/xelatex/bidi/graphicx-bidi.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/bidi/graphicx-bidi.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,43 @@
+%%
+%% This is file `graphicx-bidi.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% bidi.dtx  (with options: `graphicx-bidi.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\def\Gin at ii[#1]#2{%
+    \def\@tempa{[}\def\@tempb{#2}%
+    \ifx\@tempa\@tempb
+      \def\@tempa{\Gin at iii[#1][}%
+      \expandafter\@tempa
+    \else
+     \begingroup
+       \@tempswafalse
+       \toks@{\beginL\Ginclude at graphics{#2}\endL}%
+       \setkeys{Gin}{#1}%
+       \Gin at esetsize
+       \the\toks@
+     \endgroup
+     \fi}%
+%% 
+%% Copyright ?? 2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `graphicx-bidi.def'.

Added: tags/texmf/tex/xelatex/bidi/listings-bidi.def
===================================================================
--- tags/texmf/tex/xelatex/bidi/listings-bidi.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/bidi/listings-bidi.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,37 @@
+%%
+%% This is file `listings-bidi.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% bidi.dtx  (with options: `listings-bidi.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\long\def\@makecaption#1#2{%
+ \vskip 10pt%
+ \setbox\@tempboxa\hbox{#1: #2}%
+ \ifdim \wd\@tempboxa >\hsize \beginR#1: #2\par%
+ \else \hbox
+to\hsize{\beginR\hfil\box\@tempboxa\hfil%
+\endR}%
+ \fi}
+%% 
+%% Copyright ?? 2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `listings-bidi.def'.

Added: tags/texmf/tex/xelatex/bidi/longtable-bidi.def
===================================================================
--- tags/texmf/tex/xelatex/bidi/longtable-bidi.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/bidi/longtable-bidi.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,138 @@
+%%
+%% This is file `longtable-bidi.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% bidi.dtx  (with options: `longtable-bidi.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\def\LT at makecaption#1#2#3{%
+  \LT at mcol\LT at cols c{\hbox to\z@{\hss\parbox[t]\LTcapwidth{%
+    \sbox\@tempboxa{\if at RTL\beginR\fi#1{#2: }#3\if at RTL\endR\fi}%
+    \ifdim\wd\@tempboxa>\hsize
+      #1{#2: }#3%
+    \else
+      \hbox to\hsize{\hfil\box\@tempboxa\hfil}%
+    \fi
+    \endgraf\vskip\baselineskip}%
+  \hss}}}
+
+\def\longtable{\if at RTL\global\@RTLtabtrue\fi%
+  \par
+  \ifx\multicols\@undefined
+  \else
+     \ifnum\col at number>\@ne
+       \@twocolumntrue
+     \fi
+  \fi
+  \if at twocolumn
+    \LT at err{longtable not in 1-column mode}\@ehc
+  \fi
+  \begingroup \if at RTLtab\beginR \fi
+  \@ifnextchar[\LT at array{\LT at array[x]}}
+
+\def\LT at array[#1]#2{%
+  \refstepcounter{table}\stepcounter{LT at tables}%
+  \if l#1%
+    \LTleft\z@ \LTright\fill
+  \else\if r#1%
+    \LTleft\fill \LTright\z@
+  \else\if c#1%
+    \LTleft\fill \LTright\fill
+  \fi\fi\fi
+  \let\LT at mcol\multicolumn
+  \let\LT@@tabarray\@tabarray
+  \let\LT@@hl\hline
+  \def\@tabarray{%
+    \let\hline\LT@@hl
+    \LT@@tabarray}%
+  \let\\\LT at tabularcr\let\tabularnewline\\%
+  \def\newpage{\noalign{\break}}%
+  \def\pagebreak{\noalign{\ifnum`}=0\fi\@testopt{\LT at no@pgbk-}4}%
+  \def\nopagebreak{\noalign{\ifnum`}=0\fi\@testopt\LT at no@pgbk4}%
+  \let\hline\LT at hline \let\kill\LT at kill\let\caption\LT at caption
+  \@tempdima\ht\strutbox
+  \let\@endpbox\LT at endpbox
+  \ifx\extrarowheight\@undefined
+    \let\@acol\@tabacol
+    \let\@classz\@tabclassz \let\@classiv\@tabclassiv
+    \def\@startpbox{\vtop\LT at startpbox}%
+    \let\@@startpbox\@startpbox
+    \let\@@endpbox\@endpbox
+    \let\LT at LL@FM at cr\@tabularcr
+  \else
+    \advance\@tempdima\extrarowheight
+    \col at sep\tabcolsep
+    \let\@startpbox\LT at startpbox\let\LT at LL@FM at cr\@arraycr
+  \fi
+  \setbox\@arstrutbox\hbox{\vrule
+    \@height \arraystretch \@tempdima
+    \@depth \arraystretch \dp \strutbox
+    \@width \z@}%
+  \let\@sharp##\let\protect\relax
+   \begingroup
+    \@mkpream{#2}%
+    \xdef\LT at bchunk{%
+       \global\advance\c at LT@chunks\@ne
+       \global\LT at rows\z@\setbox\z@\vbox\bgroup
+       \LT at setprevdepth
+       \tabskip\LTleft \noexpand\halign to\hsize\bgroup
+      \tabskip\z@ \@arstrut \@preamble \tabskip\LTright \cr}%
+  \endgroup
+  \expandafter\LT at nofcols\LT at bchunk&\LT at nofcols
+  \LT at make@row
+  \m at th\let\par\@empty
+  \everycr{}\lineskip\z@\baselineskip\z@
+  \if at RTLtab\hbox\bgroup\beginR\vbox\bgroup\fi
+  \LT at bchunk}
+
+\def\endlongtable{%
+  \crcr
+  \noalign{%
+    \let\LT at entry\LT at entry@chop
+    \xdef\LT at save@row{\LT at save@row}}%
+  \LT at echunk
+  \LT at start
+  \unvbox\z@
+  \LT at get@widths
+  \if at filesw
+    {\let\LT at entry\LT at entry@write\immediate\write\@auxout{%
+      \gdef\expandafter\noexpand
+        \csname LT@\romannumeral\c at LT@tables\endcsname
+          {\LT at save@row}}}%
+  \fi
+  \ifx\LT at save@row\LT@@save at row
+  \else
+    \LT at warn{Column \@width s have changed\MessageBreak
+             in table \thetable}%
+    \LT at final@warn
+  \fi
+  \endgraf\penalty -\LT at end@pen
+  \if at RTLtab\egroup\endR\egroup\fi
+   \if at RTLtab\endR\fi \endgroup
+  \global\@mparbottom\z@
+  \pagegoal\vsize
+  \endgraf\penalty\z@\addvspace\LTpost
+  \ifvoid\footins\else\insert\footins{}\fi
+   \global\@RTLtabfalse}
+%% 
+%% Copyright ?? 2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `longtable-bidi.def'.

Added: tags/texmf/tex/xelatex/bidi/minitoc-bidi.def
===================================================================
--- tags/texmf/tex/xelatex/bidi/minitoc-bidi.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/bidi/minitoc-bidi.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,66 @@
+%%
+%% This is file `minitoc-bidi.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% bidi.dtx  (with options: `minitoc-bidi.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\def\@undottedtocline#1#2#3#4#5{%
+  \ifnum #1>\c at tocdepth\relax \else
+  \vskip \z@ plus.2\p@
+  {\if at RTL\rightskip\else\leftskip\fi #2\relax \if at RTL\leftskip\else\rightskip\fi \@tocrmarg \parfillskip -\if at RTL\leftskip\else\rightskip\fi
+   \parindent #2\relax\@afterindenttrue
+   \interlinepenalty\@M
+   \leavevmode
+   \@tempdima #3\relax \advance\if at RTL\rightskip\else\leftskip\fi \@tempdima \hbox{}%
+   \hskip -\if at RTL\rightskip\else\leftskip\fi
+    #4\nobreak\hfill \nobreak
+           \null\par}%
+  \fi}
+\def\@Undottedtocline#1#2#3#4#5{%
+  \ifnum #1>\c at tocdepth\relax \else
+    \vskip \z@ \@plus.2\p@
+    {\if at RTL\rightskip\else\leftskip\fi #2\relax \if at RTL\leftskip\else\rightskip\fi \@tocrmarg \parfillskip -\if at RTL\leftskip\else\rightskip\fi
+     \parindent #2\relax\@afterindenttrue
+     \interlinepenalty\@M
+     \leavevmode
+     \@tempdima #3\relax
+     \advance\if at RTL\rightskip\else\leftskip\fi \@tempdima \null\nobreak\hskip -\if at RTL\rightskip\else\leftskip\fi
+     {\coffeefont #4}\nobreak \nobreak\null
+    \par}%
+  \fi}
+\def\@Undottedtoclinep#1#2#3#4#5{%
+  \ifnum #1>\c at tocdepth\relax \else
+    \vskip \z@ \@plus.2\p@
+    {\if at RTL\rightskip\else\leftskip\fi #2\relax \if at RTL\leftskip\else\rightskip\fi \@tocrmarg \parfillskip -\if at RTL\leftskip\else\rightskip\fi
+     \parindent #2\relax\@afterindenttrue
+     \interlinepenalty\@M
+     \leavevmode
+     \@tempdima #3\relax
+     \advance\if at RTL\rightskip\else\leftskip\fi \@tempdima \null\nobreak\hskip -\if at RTL\rightskip\else\leftskip\fi
+     {#4}\nobreak \hfill \nobreak\null
+     \hb at xt@\@pnumwidth{\hfil\normalfont \normalcolor #5}%
+    \par}%
+  \fi}
+%% 
+%% Copyright ?? 2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `minitoc-bidi.def'.

Added: tags/texmf/tex/xelatex/bidi/pdfpages-bidi.def
===================================================================
--- tags/texmf/tex/xelatex/bidi/pdfpages-bidi.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/bidi/pdfpages-bidi.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,76 @@
+%%
+%% This is file `pdfpages-bidi.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% bidi.dtx  (with options: `pdfpages-bidi.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\renewcommand*{\includepdf}[2][]{%
+  \begingroup
+  \@RTLfalse
+  \let\AM at threadname\relax
+  \AM at split@options{pdfpages}{#1}%
+  \edef\AM at temp{{pdfpages}{\the\@temptokena}}%
+  \expandafter\setkeys\AM at temp
+  \ifthenelse{\boolean{AM at pkg@draft} \and \boolean{AM at survey}}{%
+    \let\AM at currentdocname\relax
+    \renewcommand\includegraphics[2][]{Survey in draft-mode}%
+    \def\AM at pagecount{0}%
+  }{%
+    \AM at findfile{#2}%
+    \if\AM at threadname\relax
+      \def\AM at threadname{\AM at currentdocname}%
+    \fi
+  }%
+  \ifAM at survey
+    \def\AM at pagestemp{}%
+    \@tempcnta=0
+    \def\foo{%
+      \@ifundefined{r@\AM at xrprefix pdfpages at page\the\@tempcnta}%
+         {\let\foo\relax}
+         {\expandafter\ifx\expandafter\\\AM at pagestemp\\
+             \edef\AM at pagestemp{%
+                \AM at pageref{\AM at xrprefix pdfpages at page\the\@tempcnta}}%
+          \else
+            \edef\AM at pagestemp{\AM at pagestemp,%
+               \AM at pageref{\AM at xrprefix pdfpages at page\the\@tempcnta}}%
+          \fi
+          \advance\@tempcnta 1\relax
+         }%
+      \foo
+    }%
+    \foo
+    \expandafter\ifx\expandafter\\\AM at pagestemp\\
+      \def\AM at pagestemp{1}%
+    \fi
+  \fi
+  \ifAM at output
+    \expandafter\AM at readlist\expandafter{\AM at pagestemp}%
+    \AM at output{#1}%
+  \fi
+  \AM at CheckAtEnd
+  \endgroup
+  \AM at ClearShipoutPicture
+}
+%% 
+%% Copyright ?? 2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `pdfpages-bidi.def'.

Added: tags/texmf/tex/xelatex/bidi/picture.jpg
===================================================================
(Binary files differ)


Property changes on: tags/texmf/tex/xelatex/bidi/picture.jpg
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: tags/texmf/tex/xelatex/bidi/pstricks-bidi.def
===================================================================
--- tags/texmf/tex/xelatex/bidi/pstricks-bidi.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/bidi/pstricks-bidi.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,30 @@
+%%
+%% This is file `pstricks-bidi.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% bidi.dtx  (with options: `pstricks-bidi.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\def\pspicture{\begingroup\@RTLfalse\pst at ifstar\pst at picture}%
+%% 
+%% Copyright ?? 2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `pstricks-bidi.def'.

Added: tags/texmf/tex/xelatex/bidi/ragged2e-bidi.def
===================================================================
--- tags/texmf/tex/xelatex/bidi/ragged2e-bidi.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/bidi/ragged2e-bidi.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,114 @@
+%%
+%% This is file `ragged2e-bidi.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% bidi.dtx  (with options: `ragged2e-bidi.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\renewcommand{\Centering}{%
+   \ifx\\\@raggedtwoe at savedcr
+      \let\\\@centercr
+   \fi
+   \let\@gnewline\@raggedtwoe at gnewline
+   \if at RTL\rightskip\else\leftskip\fi\CenteringLeftskip
+   \@rightskip\CenteringRightskip
+   \if at RTL\leftskip\else\rightskip\fi\@rightskip
+   \parfillskip\CenteringParfillskip
+   \parindent\CenteringParindent
+   \@raggedtwoe at spaceskiptrue
+   \@raggedtwoe at everyselectfont
+   }
+\renewcommand{\RaggedLeft}{%
+   \ifx\\\@raggedtwoe at savedcr
+      \let\\\@centercr
+   \fi
+   \let\@gnewline\@raggedtwoe at gnewline
+   \if at RTL\rightskip\else\leftskip\fi\RaggedLeftLeftskip
+   \@rightskip\RaggedLeftRightskip
+   \if at RTL\leftskip\else\rightskip\fi\@rightskip
+   \parfillskip\RaggedLeftParfillskip
+   \parindent\RaggedLeftParindent
+   \@raggedtwoe at spaceskiptrue
+   \@raggedtwoe at everyselectfont
+   }
+\renewcommand{\RaggedRight}{%
+   \ifx\\\@raggedtwoe at savedcr
+      \let\\\@centercr
+   \fi
+   \let\@gnewline\@raggedtwoe at gnewline
+   \if at RTL\rightskip\else\leftskip\fi\RaggedRightLeftskip
+   \@rightskip\RaggedRightRightskip
+   \if at RTL\leftskip\else\rightskip\fi\@rightskip
+   \parfillskip\RaggedRightParfillskip
+   \parindent\RaggedRightParindent
+   \@raggedtwoe at spaceskiptrue
+   \@raggedtwoe at everyselectfont
+   }
+\renewcommand{\justifying}{%
+   \let\\\@raggedtwoe at savedcr
+   \let\@gnewline\@raggedtwoe at saved@gnewline
+   \if at RTL\rightskip\else\leftskip\fi\z@
+   \@rightskip\z@
+   \if at RTL\leftskip\else\rightskip\fi\@rightskip
+   \parfillskip\JustifyingParfillskip
+   \parindent\JustifyingParindent
+   \@raggedtwoe at spaceskipfalse
+   \@raggedtwoe at everyselectfont
+   }
+\renewcommand*{\@raggedtwoe at raggedrightboxes@opt}{
+  \CheckCommand*{\@arrayparboxrestore}{%
+    \let\if at nobreak\iffalse
+    \let\if at noskipsec\iffalse
+    \let\par\@@par
+    \let\-\@dischyph
+    \let\'\@acci\let\`\@accii\let\=\@acciii
+    \parindent\z@ \parskip\z at skip
+    \everypar{}%
+    \linewidth\hsize
+    \@totalleftmargin\z@
+    \if at RTL\rightskip\else\leftskip\fi\z at skip \if at RTL\leftskip\else\rightskip\fi\z at skip \@rightskip\z at skip
+    \parfillskip\@flushglue \lineskip\normallineskip
+    \baselineskip\normalbaselineskip
+    \sloppy}%
+  \renewcommand{\@arrayparboxrestore}{%
+    \let\if at nobreak\iffalse
+    \let\if at noskipsec\iffalse
+    \let\par\@@par
+    \let\-\@dischyph
+    \let\'\@acci\let\`\@accii\let\=\@acciii
+    \parskip\z at skip
+    \everypar{}%
+    \linewidth\hsize
+    \@totalleftmargin\z@
+    \RaggedRight
+    \lineskip\normallineskip
+    \baselineskip\normalbaselineskip
+    \sloppy}%
+  \let\@raggedtwoe at raggedrightboxes@opt\relax
+  }
+\let\origin at RaggedLeft=\RaggedLeft
+\let\origin at RaggedRight=\RaggedRight
+\def\RaggedLeft{\if at RTL\origin at RaggedRight\else\origin at RaggedLeft\fi}
+\def\RaggedRight{\if at RTL\origin at RaggedLeft\else\origin at RaggedRight\fi}
+%% 
+%% Copyright ?? 2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `ragged2e-bidi.def'.

Added: tags/texmf/tex/xelatex/bidi/rapport3-bidi.def
===================================================================
--- tags/texmf/tex/xelatex/bidi/rapport3-bidi.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/bidi/rapport3-bidi.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,119 @@
+%%
+%% This is file `rapport3-bidi.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% bidi.dtx  (with options: `rapport3-bidi.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\renewcommand*\@regtocline[3]{%
+  \ifnum #1>\c at tocdepth
+  \else
+    \vskip\z@\@plus.2\p@
+    {\hangindent\z@ \@afterindenttrue \interlinepenalty\@M
+     \if at RTL\rightskip\else\leftskip\fi\unitindent
+     \if at RTL\leftskip\else\rightskip\fi\unitindent\@plus 1fil
+     \parfillskip\z@
+     \@tempdima\unitindent
+     \parindent\z@
+     \leavevmode
+     \hbox{}\hskip -\if at RTL\rightskip\else\leftskip\fi\relax#2\nobreak
+     \hskip 1em \nobreak{\slshape #3}\par
+     }%
+  \fi}
+\if at oldtoc
+\renewcommand*\l at part[2]{%
+  \ifnum \c at tocdepth >-2\relax
+    \addpenalty{-\@highpenalty}%
+    \addvspace{2.25em \@plus\p@}%
+    \begingroup
+      \setlength\@tempdima{3em}%
+      \parindent \z@ \if at RTL\leftskip\else\rightskip\fi \@pnumwidth
+      \parfillskip -\@pnumwidth
+      {\leavevmode
+        \large \bfseries #1\hfil \hb at xt@\@pnumwidth{\hss #2}}\par
+        \nobreak
+        \global\@nobreaktrue
+        \everypar{\global\@nobreakfalse\everypar{}}%
+    \endgroup
+  \fi}
+\else
+   \renewcommand*\l at part{%
+     \ifnum \c at tocdepth >-2\relax
+     \addpenalty{-\@highpenalty}%
+     \addvspace{2.25em \@plus \p@}%
+     \@regtocline{0}%
+   \fi}
+\fi
+\if at oldtoc
+\renewcommand*\l at chapter[2]{%
+    \addpenalty{-\@highpenalty}%
+    \vskip 1.0em \@plus\p@
+    \setlength\@tempdima{1.5em}%
+    \begingroup
+    \parindent \z@ \if at RTL\leftskip\else\rightskip\fi \@pnumwidth
+    \parfillskip -\@pnumwidth
+    \leavevmode \bfseries
+    \advance\if at RTL\rightskip\else\leftskip\fi\@tempdima
+    \hskip -\if at RTL\rightskip\else\leftskip\fi
+    #1\nobreak\hfil \nobreak\hb at xt@\@pnumwidth{\hss #2}\par
+    \penalty\@highpenalty
+   \endgroup}
+\else
+  \renewcommand*\l at chapter{\@regtocline{0}}
+\fi
+\renewcommand*\head at style{%
+    \interlinepenalty \@M
+    \hyphenpenalty=\@M \exhyphenpenalty=\@M
+    \if at RTL\leftskip\else\rightskip\fi=0cm plus .7\hsize\relax}
+\if at titlepage
+  \renewenvironment{abstract}{%
+      \titlepage
+      \null\vfil
+      \hbox{\SectFont \abstractname}
+      \noindent\ignorespaces}
+     {\par\vfil\null\endtitlepage}
+\else
+  \renewenvironment{abstract}{%
+      \if at twocolumn
+        \section*{\abstractname}%
+      \else
+        \small
+        \bgroup\if at RTL\leftskip\else\rightskip\fi=\unitindent
+        \hbox{\SectFont \abstractname}%
+        \noindent\ignorespaces
+      \fi}
+      {\if at twocolumn\else\par\egroup\fi}
+\fi
+\renewcommand*\thesection{\thechapter\@SepMark\@arabic\c at section}
+\renewcommand*\thesubsection{\thesection\@SepMark\@arabic\c at subsection}
+\renewcommand*\thesubsubsection{\thesubsection\@SepMark\@arabic\c at subsubsection}
+\renewcommand*\theparagraph{\thesubsubsection\@SepMark\@arabic\c at paragraph}
+\renewcommand*\thesubparagraph{\theparagraph\@SepMark\@arabic\c at subparagraph}
+\renewcommand*\thefigure{%
+  \ifnum\c at chapter>\z@\thechapter\@SepMark\fi\@arabic\c at figure}
+\renewcommand*\thetable{%
+  \ifnum\c at chapter>\z@\thechapter\@SepMark\fi\@arabic\c at table}
+\renewcommand*\theequation{%
+  \ifnum \c at chapter>\z@ \thechapter\@SepMark\fi\@arabic\c at equation}
+%% 
+%% Copyright ?? 2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `rapport3-bidi.def'.

Added: tags/texmf/tex/xelatex/bidi/refrep-bidi.def
===================================================================
--- tags/texmf/tex/xelatex/bidi/refrep-bidi.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/bidi/refrep-bidi.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,54 @@
+%%
+%% This is file `refrep-bidi.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% bidi.dtx  (with options: `refrep-bidi.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\renewcommand*\l at part[2]{%
+  \ifnum \c at tocdepth >-2\relax
+    \addpenalty{-\@highpenalty}%
+    \addvspace{2.25em \@plus\p@}%
+    \begingroup
+      \parindent \z@ \if at RTL\leftskip\else\rightskip\fi \@pnumwidth
+      \parfillskip -\@pnumwidth
+      {\leavevmode
+       \large \bfseries #1\hfil \hbox to\@pnumwidth{\hss #2}}\par
+       \nobreak
+         \global\@nobreaktrue
+         \everypar{\global\@nobreakfalse\everypar{}}%
+      \endgroup
+  \fi}
+\renewcommand\theequation
+{\ifnum \c at chapter>\z@ \thechapter\@SepMark\fi \@arabic\c at equation}
+\renewcommand\thefigure
+     {\ifnum \c at chapter>\z@ \thechapter\@SepMark\fi \@arabic\c at figure}
+\renewcommand\thetable%
+     {\ifnum \c at chapter>\z@ \thechapter\@SepMark\fi \@arabic\c at table}
+\renewcommand\thesection       {\thechapter\@SepMark\@arabic\c at section}
+\renewcommand\thesubsection    {\thesection\@SepMark\@arabic\c at subsection}
+\renewcommand\thesubsubsection {\thesubsection \@SepMark\@arabic\c at subsubsection}
+\renewcommand\theparagraph     {\thesubsubsection\@SepMark\@arabic\c at paragraph}
+\renewcommand\thesubparagraph  {\theparagraph\@SepMark\@arabic\c at subparagraph}
+%% 
+%% Copyright ?? 2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `refrep-bidi.def'.

Added: tags/texmf/tex/xelatex/bidi/report-bidi.def
===================================================================
--- tags/texmf/tex/xelatex/bidi/report-bidi.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/bidi/report-bidi.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,134 @@
+%%
+%% This is file `report-bidi.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% bidi.dtx  (with options: `report-bidi.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\renewcommand*\l at part[2]{%
+  \ifnum \c at tocdepth >-2\relax
+    \addpenalty{-\@highpenalty}%
+    \addvspace{2.25em \@plus\p@}%
+    \setlength\@tempdima{3em}%
+    \begingroup
+      \parindent \z@ \if at RTL\leftskip\else\rightskip\fi \@pnumwidth
+      \parfillskip -\@pnumwidth
+      {\leavevmode
+       \large \bfseries #1\hfil \hb at xt@\@pnumwidth{\hss #2}}\par
+       \nobreak
+         \global\@nobreaktrue
+         \everypar{\global\@nobreakfalse\everypar{}}%
+    \endgroup
+  \fi}
+\renewcommand\theequation
+  {\ifnum \c at chapter>\z@ \thechapter\@SepMark\fi \@arabic\c at equation}
+\renewcommand \thefigure
+     {\ifnum \c at chapter>\z@ \thechapter\@SepMark\fi \@arabic\c at figure}
+\renewcommand \thetable
+     {\ifnum \c at chapter>\z@ \thechapter\@SepMark\fi \@arabic\c at table}
+\renewcommand \thechapter {\@arabic\c at chapter}
+\renewcommand \thesection {\thechapter\@SepMark\@arabic\c at section}
+\renewcommand\thesubsection   {\thesection\@SepMark\@arabic\c at subsection}
+\renewcommand\thesubsubsection{\thesubsection \@SepMark\@arabic\c at subsubsection}
+\renewcommand\theparagraph    {\thesubsubsection\@SepMark\@arabic\c at paragraph}
+\renewcommand\thesubparagraph {\theparagraph\@SepMark\@arabic\c at subparagraph}
+\def\@makechapterhead#1{%
+  \vspace*{50\p@}%
+  {\parindent \z@ \raggedleft \normalfont
+    \ifnum \c at secnumdepth >\m at ne
+        \huge\bfseries \@chapapp\space \thechapter
+        \par\nobreak
+        \vskip 20\p@
+    \fi
+    \interlinepenalty\@M
+    \Huge \bfseries #1\par\nobreak
+    \vskip 40\p@
+  }}
+\def\@makeschapterhead#1{%
+  \vspace*{50\p@}%
+  {\parindent \z@ \raggedleft
+    \normalfont
+    \interlinepenalty\@M
+    \Huge \bfseries  #1\par\nobreak
+    \vskip 40\p@
+  }}
+\renewenvironment{thebibliography}[1]
+     {\chapter*{\bibname}%
+      \@mkboth{\MakeUppercase\bibname}{\MakeUppercase\bibname}%
+      \list{\@biblabel{\@arabic\c at enumiv}}%
+           {\settowidth\labelwidth{\@biblabel{#1}}%
+            \rightmargin\labelwidth
+            \advance\rightmargin\labelsep
+            \@openbib at code
+            \usecounter{enumiv}%
+            \let\p at enumiv\@empty
+            \renewcommand\theenumiv{\@arabic\c at enumiv}}%
+      \sloppy
+      \clubpenalty4000
+      \@clubpenalty \clubpenalty
+      \widowpenalty4000%
+      \sfcode`\.\@m}
+     {\def\@noitemerr
+       {\@latex at warning{Empty `thebibliography' environment}}%
+      \endlist}
+\if at twoside
+  \def\ps at headings{%
+      \let\@oddfoot\@empty\let\@evenfoot\@empty
+      \def\@evenhead{\sl\thepage\hfil\beginR\leftmark\endR}%
+      \def\@oddhead{\sl\beginR\rightmark\endR\hfil\thepage}%
+      \let\@mkboth\markboth
+    \def\chaptermark##1{%
+      \markboth {\MakeUppercase{%
+        \ifnum \c at secnumdepth >\m at ne
+            \beginR\@chapapp\ \thechapter. \ \endR%
+        \fi
+        \beginR##1\endR}}{}}%
+    \def\sectionmark##1{%
+      \markright {\MakeUppercase{%
+        \ifnum \c at secnumdepth >\z@
+          \beginR\thesection. \ \endR%
+        \fi
+        \beginR##1\endR}}}}
+\else
+  \def\ps at headings{%
+    \let\@oddfoot\@empty
+    \def\@oddhead{\sl\beginR\rightmark\endR\hfil\thepage}%
+    \let\@mkboth\markboth
+    \def\chaptermark##1{%
+      \markright {\MakeUppercase{%
+        \ifnum \c at secnumdepth >\m at ne
+            \beginR\@chapapp\ \thechapter. \ \endR%
+        \fi
+        \beginR##1\endR}}}}
+\fi
+\def\ps at myheadings{%
+    \let\@oddfoot\@empty\let\@evenfoot\@empty
+    \def\@evenhead{\sl\thepage\hfil\beginR\leftmark\endR}%
+    \def\@oddhead{\sl\beginR\rightmark\endR\hfil\thepage}%
+    \let\@mkboth\@gobbletwo
+    \let\chaptermark\@gobble
+    \let\sectionmark\@gobble
+    }
+\pagestyle{plain}
+%% 
+%% Copyright ?? 2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `report-bidi.def'.

Added: tags/texmf/tex/xelatex/bidi/scrartcl-bidi.def
===================================================================
--- tags/texmf/tex/xelatex/bidi/scrartcl-bidi.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/bidi/scrartcl-bidi.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,102 @@
+%%
+%% This is file `scrartcl-bidi.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% bidi.dtx  (with options: `scrartcl-bidi.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\renewcommand*\l at part[2]{%
+  \ifnum \c at tocdepth >\m at ne\relax
+    \addpenalty{\@secpenalty}%
+    \addvspace{2.25em \@plus\p@}%
+    \setlength{\@tempdima}{2em}%
+    \if at tocleft
+      \ifx\toc at l@number\@empty\else
+        \setlength\@tempdima{0\toc at l@number}%
+      \fi
+    \fi
+    \begingroup
+      \parindent \z@ \if at RTL\leftskip\else\rightskip\fi \@pnumwidth
+      \parfillskip -\@pnumwidth
+      \leavevmode
+      \advance\if at RTL\rightskip\else\leftskip\fi\@tempdima
+      \hskip -\if at RTL\rightskip\else\leftskip\fi
+      \usekomafont{partentry}{#1\nobreak
+        \usekomafont{partentrypagenumber}{\hfil\nobreak
+          \hb at xt@\@pnumwidth{\hss#2}}}\par
+      \ifnum \scr at compatibility>\@nameuse{scr at v@2.96}\relax
+      \endgroup
+      \penalty20010
+      \else
+        \if at compatibility
+          \global\@nobreaktrue
+          \everypar{\global\@nobreakfalse\everypar{}}%
+        \else
+          \penalty\@highpenalty
+         \fi
+      \endgroup
+    \fi
+  \fi
+}
+\renewcommand*\l at section[2]{%
+  \ifnum \c at tocdepth >\z@
+    \ifnum \lastpenalty<20009
+      \addpenalty{\@secpenalty}%
+    \fi
+    \addvspace{1.0em \@plus\p@}%
+    \setlength\@tempdima{1.5em}%
+     \if at tocleft
+      \ifx\toc at l@number\@empty\else
+        \setlength\@tempdima{0\toc at l@number}%
+      \fi
+    \fi
+   \begingroup
+      \raggedsectionentry
+      \parindent \z@ \advance\if at RTL\leftskip\else\rightskip\fi \@pnumwidth
+      \parfillskip -\@pnumwidth
+      \interlinepenalty\@M
+      \leavevmode
+      \advance\if at RTL\rightskip\else\leftskip\fi \@tempdima \null\nobreak\hskip -\if at RTL\rightskip\else\leftskip\fi
+      \usekomafont{sectionentry}{#1\nobreak
+        \usekomafont{sectionentrypagenumber}{%
+          \hfill\nobreak
+          \hb at xt@\@pnumwidth{\hss#2}}}\par
+    \endgroup
+    \ifnum \scr at compatibility>\@nameuse{scr at v@2.96}\relax
+      \penalty20008
+    \fi
+  \fi
+}
+\def\raggedsection{\if at RTL\raggedleft\else\raggedright\fi}
+\def\raggedpart{\if at RTL\raggedleft\else\raggedright\fi}
+\renewcommand*\autodot{\if at altsecnumformat\@SepMark\fi}
+\renewcommand*{\thesubsection}{\thesection\@SepMark\@arabic\c at subsection}
+\renewcommand*{\thesubsubsection}{%
+  \thesubsection\@SepMark\@arabic\c at subsubsection
+}
+\renewcommand*{\theparagraph}{\thesubsubsection\@SepMark\@arabic\c at paragraph}
+\renewcommand*{\thesubparagraph}{%
+  \theparagraph\@SepMark\@arabic\c at subparagraph
+}
+%% 
+%% Copyright ?? 2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `scrartcl-bidi.def'.

Added: tags/texmf/tex/xelatex/bidi/scrbook-bidi.def
===================================================================
--- tags/texmf/tex/xelatex/bidi/scrbook-bidi.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/bidi/scrbook-bidi.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,158 @@
+%%
+%% This is file `scrbook-bidi.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% bidi.dtx  (with options: `scrbook-bidi.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\renewcommand*\l at part[2]{%
+  \ifnum \c at tocdepth >-2\relax
+    \addpenalty{-\@highpenalty}%
+    \addvspace{2.25em \@plus\p@}%
+    \setlength{\@tempdima}{2em}%
+    \if at tocleft
+      \ifx\toc at l@number\@empty\else
+        \setlength\@tempdima{0\toc at l@number}%
+      \fi
+    \fi
+    \begingroup
+      \parindent \z@ \if at RTL\leftskip\else\rightskip\fi \@pnumwidth
+      \parfillskip -\@pnumwidth
+      \leavevmode
+      \advance\if at RTL\rightskip\else\leftskip\fi\@tempdima
+      \hskip -\if at RTL\rightskip\else\leftskip\fi
+      \usekomafont{partentry}{#1\nobreak
+        \usekomafont{partentrypagenumber}{\hfil\nobreak
+          \hb at xt@\@pnumwidth{\hss#2}}}\par
+      \ifnum \scr at compatibility>\@nameuse{scr at v@2.96}\relax
+      \endgroup
+      \penalty20010
+      \else
+          \penalty\@highpenalty
+      \endgroup
+    \fi
+  \fi
+}\renewcommand*\l at part[2]{%
+  \ifnum \c at tocdepth >-2\relax
+    \addpenalty{-\@highpenalty}%
+    \addvspace{2.25em \@plus\p@}%
+    \setlength{\@tempdima}{2em}%
+    \if at tocleft
+      \ifx\toc at l@number\@empty\else
+        \setlength\@tempdima{0\toc at l@number}%
+      \fi
+    \fi
+    \begingroup
+      \parindent \z@ \if at RTL\leftskip\else\rightskip\fi \@pnumwidth
+      \parfillskip -\@pnumwidth
+      \leavevmode
+      \advance\if at RTL\rightskip\else\leftskip\fi\@tempdima
+      \hskip -\if at RTL\rightskip\else\leftskip\fi
+      \usekomafont{partentry}{#1\nobreak
+        \usekomafont{partentrypagenumber}{\hfil\nobreak
+          \hb at xt@\@pnumwidth{\hss#2}}}\par
+      \ifnum \scr at compatibility>\@nameuse{scr at v@2.96}\relax
+      \endgroup
+      \penalty20010
+      \else
+          \penalty\@highpenalty
+      \endgroup
+    \fi
+  \fi
+}
+\renewcommand*\l at chapter[2]{%
+  \ifnum \c at tocdepth >\m at ne
+    \ifnum \lastpenalty<20010
+      \addpenalty{-\@highpenalty}%
+    \fi
+    \vskip 1.0em \@plus\p@
+    \setlength\@tempdima{1.5em}%
+    \if at tocleft
+      \ifx\toc at l@number\@empty\else
+        \setlength\@tempdima{0\toc at l@number}%
+      \fi
+    \fi
+    \begingroup
+      \raggedchapterentry
+      \parindent \z@ \advance\if at RTL\leftskip\else\rightskip\fi \@pnumwidth
+      \parfillskip -\@pnumwidth
+      \interlinepenalty\@M
+      \leavevmode
+      \advance\if at RTL\rightskip\else\leftskip\fi \@tempdima \null\nobreak\hskip -\if at RTL\rightskip\else\leftskip\fi
+      \usekomafont{chapterentry}{#1\nobreak
+        \usekomafont{chapterentrypagenumber}{%
+          \hfill\nobreak
+          \hb at xt@\@pnumwidth{\hss#2}}}\par
+      \ifnum \scr at compatibility>\@nameuse{scr at v@2.96}\relax
+      \endgroup
+      \penalty20009
+      \else
+        \penalty\@highpenalty
+      \endgroup
+    \fi
+  \fi
+}
+\def\raggedsection{\if at RTL\raggedleft\else\raggedright\fi}
+\renewcommand*\autodot{\if at altsecnumformat\@SepMark\fi}
+\renewcommand*\thesection{%
+  \ifnum \scr at compatibility>\@nameuse{scr at v@2.97d}\relax
+    \if at mainmatter\thechapter\@SepMark\fi
+  \else
+  \thechapter\@SepMark%
+  \fi
+  \@arabic\c at section
+}
+\renewcommand*{\thesubsection}{\thesection\@SepMark\@arabic\c at subsection}
+\renewcommand*{\thesubsubsection}{%
+  \thesubsection\@SepMark\@arabic\c at subsubsection
+}
+\renewcommand*{\theparagraph}{\thesubsubsection\@SepMark\@arabic\c at paragraph}
+\renewcommand*{\thesubparagraph}{%
+  \theparagraph\@SepMark\@arabic\c at subparagraph
+}
+\renewcommand*\thefigure{%
+  \ifnum \scr at compatibility>\@nameuse{scr at v@2.97d}\relax
+    \if at mainmatter\thechapter\@SepMark\fi
+  \else
+  \thechapter\@SepMark%
+  \fi
+  \@arabic\c at figure
+}
+\renewcommand*\thetable{%
+  \ifnum \scr at compatibility>\@nameuse{scr at v@2.97d}\relax
+    \if at mainmatter\thechapter\@SepMark\fi
+  \else
+  \thechapter\@SepMark%
+  \fi
+  \@arabic\c at table
+}
+\renewcommand*\theequation{%
+  \ifnum \scr at compatibility>\@nameuse{scr at v@2.97d}\relax
+    \if at mainmatter\thechapter\@SepMark\fi
+  \else
+  \thechapter\@SepMark%
+  \fi
+  \@arabic\c at equation
+}
+%% 
+%% Copyright ?? 2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `scrbook-bidi.def'.

Added: tags/texmf/tex/xelatex/bidi/scrreprt-bidi.def
===================================================================
--- tags/texmf/tex/xelatex/bidi/scrreprt-bidi.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/bidi/scrreprt-bidi.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,115 @@
+%%
+%% This is file `scrreprt-bidi.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% bidi.dtx  (with options: `scrreprt-bidi.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\renewcommand*\l at part[2]{%
+  \ifnum \c at tocdepth >-2\relax
+    \addpenalty{-\@highpenalty}%
+    \addvspace{2.25em \@plus\p@}%
+    \setlength{\@tempdima}{2em}%
+    \if at tocleft
+      \ifx\toc at l@number\@empty\else
+        \setlength\@tempdima{0\toc at l@number}%
+      \fi
+    \fi
+    \begingroup
+      \parindent \z@ \if at RTL\leftskip\else\rightskip\fi \@pnumwidth
+      \parfillskip -\@pnumwidth
+      \leavevmode
+      \advance\if at RTL\rightskip\else\leftskip\fi\@tempdima
+      \hskip -\if at RTL\rightskip\else\leftskip\fi
+      \usekomafont{partentry}{#1\nobreak
+        \usekomafont{partentrypagenumber}{\hfil\nobreak
+          \hb at xt@\@pnumwidth{\hss#2}}}\par
+      \ifnum \scr at compatibility>\@nameuse{scr at v@2.96}\relax
+      \endgroup
+      \penalty20010
+      \else
+          \penalty\@highpenalty
+      \endgroup
+    \fi
+  \fi
+}
+\renewcommand*\l at chapter[2]{%
+  \ifnum \c at tocdepth >\m at ne
+    \ifnum \lastpenalty<20010
+      \addpenalty{-\@highpenalty}%
+    \fi
+    \vskip 1.0em \@plus\p@
+    \setlength\@tempdima{1.5em}%
+    \if at tocleft
+      \ifx\toc at l@number\@empty\else
+        \setlength\@tempdima{0\toc at l@number}%
+      \fi
+    \fi
+    \begingroup
+      \raggedchapterentry
+      \parindent \z@ \advance\if at RTL\leftskip\else\rightskip\fi \@pnumwidth
+      \parfillskip -\@pnumwidth
+      \interlinepenalty\@M
+      \leavevmode
+      \advance\if at RTL\rightskip\else\leftskip\fi \@tempdima \null\nobreak\hskip -\if at RTL\rightskip\else\leftskip\fi
+      \usekomafont{chapterentry}{#1\nobreak
+        \usekomafont{chapterentrypagenumber}{%
+          \hfill\nobreak
+          \hb at xt@\@pnumwidth{\hss#2}}}\par
+      \ifnum \scr at compatibility>\@nameuse{scr at v@2.96}\relax
+      \endgroup
+      \penalty20009
+      \else
+        \penalty\@highpenalty
+      \endgroup
+    \fi
+  \fi
+}
+\def\raggedsection{\if at RTL\raggedleft\else\raggedright\fi}
+\renewcommand*\autodot{\if at altsecnumformat\@SepMark\fi}
+\renewcommand*\thesection{%
+  \thechapter\@SepMark%
+  \@arabic\c at section
+}
+\renewcommand*{\thesubsection}{\thesection\@SepMark\@arabic\c at subsection}
+\renewcommand*{\thesubsubsection}{%
+  \thesubsection\@SepMark\@arabic\c at subsubsection
+}
+\renewcommand*{\theparagraph}{\thesubsubsection\@SepMark\@arabic\c at paragraph}
+\renewcommand*{\thesubparagraph}{%
+  \theparagraph\@SepMark\@arabic\c at subparagraph
+}
+\renewcommand*\thefigure{%
+  \thechapter\@SepMark%
+  \@arabic\c at figure
+}
+\renewcommand*\thetable{%
+  \thechapter\@SepMark%
+  \@arabic\c at table
+}
+\renewcommand*\theequation{%
+  \thechapter\@SepMark%
+  \@arabic\c at equation
+}
+%% 
+%% Copyright ?? 2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `scrreprt-bidi.def'.

Added: tags/texmf/tex/xelatex/bidi/stabular-bidi.def
===================================================================
--- tags/texmf/tex/xelatex/bidi/stabular-bidi.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/bidi/stabular-bidi.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,55 @@
+%%
+%% This is file `stabular-bidi.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% bidi.dtx  (with options: `stabular-bidi.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\def\@stabular{\if at RTL\global\@RTLtabtrue\fi
+   \leavevmode \bgroup \if at RTLtab\beginR \fi
+   \let\@acol\@tabacol
+   \let\@classz\@tabclassz
+   \let\@classiv\@tabclassiv \let\\\@tabularcr\@stabarray}
+\def\endstabular{\crcr\egroup\if at RTLtab\egroup\endR\egroup\fi
+                 \egroup \if at RTLtab\endR\fi\egroup
+                 \global\@RTLtabfalse}
+\expandafter \let \csname endstabular*\endcsname = \endstabular
+\def\@sarray[#1]#2{%
+  \bgroup
+  \setbox\@arstrutbox\hbox{%
+    \vrule \@height\arraystretch\ht\strutbox
+           \@depth\arraystretch \dp\strutbox
+           \@width\z@}%
+  \@mkpream{#2}%
+  \edef\@preamble{%
+    \ialign \noexpand\@halignto
+      \bgroup \@arstrut \@preamble \tabskip\z at skip \cr}%
+  \let\@startpbox\@@startpbox \let\@endpbox\@@endpbox
+  \let\tabularnewline\\%
+    \let\@sharp##%
+    \set at typeset@protect
+    \lineskip\z at skip\baselineskip\z at skip
+  \if at RTLtab\hbox\bgroup\beginR\vbox\bgroup\fi
+    \@preamble}
+%% 
+%% Copyright ?? 2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `stabular-bidi.def'.

Added: tags/texmf/tex/xelatex/bidi/tabls-bidi.def
===================================================================
--- tags/texmf/tex/xelatex/bidi/tabls-bidi.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/bidi/tabls-bidi.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,63 @@
+%%
+%% This is file `tabls-bidi.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% bidi.dtx  (with options: `tabls-bidi.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\def\endtabular{\endarray $\if at RTLtab\endR\fi\egroup
+                 \global\@RTLtabfalse}
+
+\expandafter\let\csname endtabular*\endcsname=\endtabular
+
+\def\endarray{\ifvmode\csname crcr\endcsname % just do \crcr if \\ given
+  \else \\[\z@ \global\advance\@arstdepth-\@otarlinesep]%
+  \fi\egroup\if at RTLtab\egroup\endR\egroup\fi\@unrecurse\egroup}
+
+\def\@array[#1]#2{%  remember global variables to allow recursion:
+ \edef\@unrecurse{\global\@skip at bove\the\@skip at bove
+     \global\@arstheight\the\@arstheight\global\@arstdepth\the\@arstdepth}%
+ \let\@otarlinesep\@tarlinesep \global\@skip at bove-\@otarlinesep
+ \ifx\@classz\@arrayclassz \let\@tarlinesep\arraylinesep
+ \else \let\@tarlinesep\tablinesep \fi
+ \divide\@tarlinesep\tw@ % half sep is applied to height & depth
+ \let\@seesize\relax \let\@rememsize\relax \@mkpream{#2}%
+ \@tempdima\arraystretch\ht\strutbox \@tempdimb\arraystretch\dp\strutbox
+ \ifdim\@tarlinesep>\z@ % (need \protect for \multicolumn)
+   \def\@rememsize{\protect\@r at m@msize}\let\@seesize\@s@@size
+   \advance\@tempdima-\@tarlinesep \advance\@tempdimb-\@tarlinesep
+ \fi \setbox\@arstrutbox\hbox{% set up smaller strut
+    \vrule \@height\@tempdima \@depth\@tempdimb \@width\z@}%
+ \let\protect\noexpand
+ \edef\@preamble{\ialign \noexpand\@halignto \bgroup
+ \unhcopy\@arstrutbox \@preamble \tabskip\z at skip &\@sharp \cr}%
+ \let\@startpbox\@@startpbox \let\@endpbox\@@endpbox
+ \if#1t\vtop \else \if#1b\vbox \else \vcenter \fi\fi
+ \bgroup \let\par\@empty
+ \global\@arstheight\ht\@arstrutbox \global\@arstdepth\dp\@arstrutbox
+ \advance\extrarulesep.5\arrayrulewidth
+ \let\@sharp##\let\protect\relax \lineskip\z at skip \baselineskip\z at skip
+ \if at RTLtab\hbox\bgroup\beginR\vbox\bgroup\fi
+ \@preamble}
+%% 
+%% Copyright ?? 2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `tabls-bidi.def'.

Added: tags/texmf/tex/xelatex/bidi/tikz-bidi.def
===================================================================
--- tags/texmf/tex/xelatex/bidi/tikz-bidi.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/bidi/tikz-bidi.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,33 @@
+%%
+%% This is file `tikz-bidi.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% bidi.dtx  (with options: `tikz-bidi.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\let\origin at tikzpicture=\tikzpicture
+\let\origin at endtikzpicture=\endtikzpicture
+\def\tikzpicture{\LTR\origin at tikzpicture}
+\def\endtikzpicture{\origin at endtikzpicture\endLTR}
+%% 
+%% Copyright ?? 2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `tikz-bidi.def'.

Added: tags/texmf/tex/xelatex/bidi/tocloft-bidi.def
===================================================================
--- tags/texmf/tex/xelatex/bidi/tocloft-bidi.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/bidi/tocloft-bidi.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,335 @@
+%%
+%% This is file `tocloft-bidi.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% bidi.dtx  (with options: `tocloft-bidi.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\if at cfthaspart
+\renewcommand*{\l at part}[2]{
+  \@cftdopartfalse
+  \ifnum \c at tocdepth >-2\relax
+    \if at cfthaschapter
+      \@cftdoparttrue
+    \fi
+    \ifnum \c at tocdepth >\m at ne
+      \if at cfthaschapter\else
+        \@cftdoparttrue
+      \fi
+    \fi
+  \fi
+  \if at cftdopart
+    \if at cfthaschapter
+      \addpenalty{-\@highpenalty}
+    \else
+      \addpenalty\@secpenalty
+    \fi
+    \addvspace{\cftbeforepartskip}
+    \begingroup
+      {\if at RTL\rightskip\else\leftskip\fi \cftpartindent\relax
+       \if at RTL\leftskip\else\rightskip\fi \@tocrmarg
+       \parfillskip -\if at RTL\leftskip\else\rightskip\fi
+       \parindent \cftpartindent\relax\@afterindenttrue
+       \interlinepenalty\@M
+       \leavevmode
+       \@tempdima \cftpartnumwidth\relax
+       \let\@cftbsnum \cftpartpresnum
+       \let\@cftasnum \cftpartaftersnum
+       \let\@cftasnumb \cftpartaftersnumb
+       \advance\if at RTL\rightskip\else\leftskip\fi \@tempdima \null\nobreak\hskip -\if at RTL\rightskip\else\leftskip\fi
+       {\cftpartfont \cftpartpresnum #1}
+       \cftpartfillnum{#2}}
+      \nobreak
+      \if at cfthaschapter
+        \global\@nobreaktrue
+        \everypar{\global\@nobreakfalse\everypar{}}
+      \else
+        \if at compatibility
+          \global\@nobreaktrue
+          \everypar{\global\@nobreakfalse\everypar{}}
+        \fi
+      \fi
+    \endgroup
+  \fi}
+\fi
+\if at cfthaschapter
+\renewcommand*{\l at chapter}[2]{
+  \ifnum \c at tocdepth >\m at ne
+    \addpenalty{-\@highpenalty}
+    \vskip \cftbeforechapskip
+    {\if at RTL\rightskip\else\leftskip\fi \cftchapindent\relax
+     \if at RTL\leftskip\else\rightskip\fi \@tocrmarg
+     \parfillskip -\if at RTL\leftskip\else\rightskip\fi
+     \parindent \cftchapindent\relax\@afterindenttrue
+     \interlinepenalty\@M
+     \leavevmode
+     \@tempdima \cftchapnumwidth\relax
+     \let\@cftbsnum \cftchappresnum
+     \let\@cftasnum \cftchapaftersnum
+     \let\@cftasnumb \cftchapaftersnumb
+     \advance\if at RTL\rightskip\else\leftskip\fi \@tempdima \null\nobreak\hskip -\if at RTL\rightskip\else\leftskip\fi
+     {\cftchapfont #1}\nobreak
+     \cftchapfillnum{#2}}
+  \fi}
+\fi
+\renewcommand*{\l at section}[2]{%
+  \ifnum \c at tocdepth >\z@
+    \if at cfthaschapter
+      \vskip \cftbeforesecskip
+    \else
+      \addpenalty\@secpenalty
+      \addvspace{\cftbeforesecskip}
+    \fi
+    {\if at RTL\rightskip\else\leftskip\fi \cftsecindent\relax
+     \if at RTL\leftskip\else\rightskip\fi \@tocrmarg
+     \parfillskip -\if at RTL\leftskip\else\rightskip\fi
+     \parindent \cftsecindent\relax\@afterindenttrue
+     \interlinepenalty\@M
+     \leavevmode
+     \@tempdima \cftsecnumwidth\relax
+     \let\@cftbsnum \cftsecpresnum
+     \let\@cftasnum \cftsecaftersnum
+     \let\@cftasnumb \cftsecaftersnumb
+     \advance\if at RTL\rightskip\else\leftskip\fi \@tempdima \null\nobreak\hskip -\if at RTL\rightskip\else\leftskip\fi
+     {\cftsecfont #1}\nobreak
+     \cftsecfillnum{#2}}
+  \fi}
+\renewcommand*{\l at subsection}[2]{%
+  \ifnum \c at tocdepth >\@ne
+    \vskip \cftbeforesubsecskip
+    {\if at RTL\rightskip\else\leftskip\fi \cftsubsecindent\relax
+     \if at RTL\leftskip\else\rightskip\fi \@tocrmarg
+     \parfillskip -\if at RTL\leftskip\else\rightskip\fi
+     \parindent \cftsubsecindent\relax\@afterindenttrue
+     \interlinepenalty\@M
+     \leavevmode
+     \@tempdima \cftsubsecnumwidth\relax
+     \let\@cftbsnum \cftsubsecpresnum
+     \let\@cftasnum \cftsubsecaftersnum
+     \let\@cftasnumb \cftsubsecaftersnumb
+     \advance\if at RTL\rightskip\else\leftskip\fi \@tempdima \null\nobreak\hskip -\if at RTL\rightskip\else\leftskip\fi
+     {\cftsubsecfont #1}\nobreak
+     \cftsubsecfillnum{#2}}
+  \fi}
+\renewcommand*{\l at subsubsection}[2]{%
+  \ifnum \c at tocdepth >\tw@
+    \vskip \cftbeforesubsubsecskip
+    {\if at RTL\rightskip\else\leftskip\fi \cftsubsubsecindent\relax
+     \if at RTL\leftskip\else\rightskip\fi \@tocrmarg
+     \parfillskip -\if at RTL\leftskip\else\rightskip\fi
+     \parindent \cftsubsubsecindent\relax\@afterindenttrue
+     \interlinepenalty\@M
+     \leavevmode
+     \@tempdima \cftsubsubsecnumwidth\relax
+     \let\@cftbsnum \cftsubsubsecpresnum
+     \let\@cftasnum \cftsubsubsecaftersnum
+     \let\@cftasnumb \cftsubsubsecaftersnumb
+     \advance\if at RTL\rightskip\else\leftskip\fi \@tempdima \null\nobreak\hskip -\if at RTL\rightskip\else\leftskip\fi
+     {\cftsubsubsecfont #1}\nobreak
+     \cftsubsubsecfillnum{#2}}
+  \fi}
+\renewcommand*{\l at paragraph}[2]{%
+  \ifnum \c at tocdepth >3\relax
+    \vskip \cftbeforeparaskip
+    {\if at RTL\rightskip\else\leftskip\fi \cftparaindent\relax
+     \if at RTL\leftskip\else\rightskip\fi \@tocrmarg
+     \parfillskip -\if at RTL\leftskip\else\rightskip\fi
+     \parindent \cftparaindent\relax\@afterindenttrue
+     \interlinepenalty\@M
+     \leavevmode
+     \@tempdima \cftparanumwidth\relax
+     \let\@cftbsnum \cftparapresnum
+     \let\@cftasnum \cftparaaftersnum
+     \let\@cftasnumb \cftparaaftersnumb
+     \advance\if at RTL\rightskip\else\leftskip\fi \@tempdima \null\nobreak\hskip -\if at RTL\rightskip\else\leftskip\fi
+     {\cftparafont #1}\nobreak
+     \cftparafillnum{#2}}
+  \fi}
+\renewcommand*{\l at subparagraph}[2]{%
+  \ifnum \c at tocdepth >4\relax
+    \vskip \cftbeforesubparaskip
+    {\if at RTL\rightskip\else\leftskip\fi \cftsubparaindent\relax
+     \if at RTL\leftskip\else\rightskip\fi \@tocrmarg
+     \parfillskip -\if at RTL\leftskip\else\rightskip\fi
+     \parindent \cftsubparaindent\relax\@afterindenttrue
+     \interlinepenalty\@M
+     \leavevmode
+     \@tempdima \cftsubparanumwidth\relax
+     \let\@cftbsnum \cftsubparapresnum
+     \let\@cftasnum \cftsubparaaftersnum
+     \let\@cftasnumb \cftsubparaaftersnumb
+     \advance\if at RTL\rightskip\else\leftskip\fi \@tempdima \null\nobreak\hskip -\if at RTL\rightskip\else\leftskip\fi
+     {\cftsubparafont #1}\nobreak
+     \cftsubparafillnum{#2}}
+  \fi}
+\renewcommand*{\l at figure}[2]{%
+  \ifnum \c at lofdepth >\z@
+    \vskip \cftbeforefigskip
+    {\if at RTL\rightskip\else\leftskip\fi \cftfigindent\relax
+     \if at RTL\leftskip\else\rightskip\fi \@tocrmarg
+     \parfillskip -\if at RTL\leftskip\else\rightskip\fi
+     \parindent \cftfigindent\relax\@afterindenttrue
+     \interlinepenalty\@M
+     \leavevmode
+     \@tempdima \cftfignumwidth\relax
+     \let\@cftbsnum \cftfigpresnum
+     \let\@cftasnum \cftfigaftersnum
+     \let\@cftasnumb \cftfigaftersnumb
+     \advance\if at RTL\rightskip\else\leftskip\fi \@tempdima \null\nobreak\hskip -\if at RTL\rightskip\else\leftskip\fi
+     {\cftfigfont #1}\nobreak
+     \cftfigfillnum{#2}}
+   \fi
+  }
+\renewcommand*{\l at table}[2]{%
+  \ifnum\c at lotdepth >\z@
+    \vskip \cftbeforetabskip
+    {\if at RTL\rightskip\else\leftskip\fi \cfttabindent\relax
+     \if at RTL\leftskip\else\rightskip\fi \@tocrmarg
+     \parfillskip -\if at RTL\leftskip\else\rightskip\fi
+     \parindent \cfttabindent\relax\@afterindenttrue
+     \interlinepenalty\@M
+     \leavevmode
+     \@tempdima \cfttabnumwidth\relax
+     \let\@cftbsnum \cfttabpresnum
+     \let\@cftasnum \cfttabaftersnum
+     \let\@cftasnumb \cfttabaftersnumb
+     \advance\if at RTL\rightskip\else\leftskip\fi \@tempdima \null\nobreak\hskip -\if at RTL\rightskip\else\leftskip\fi
+     {\cfttabfont #1}\nobreak
+     \cfttabfillnum{#2}}
+   \fi
+  }
+\renewcommand{\@cftl at subfig}{
+\renewcommand*{\l at subfigure}[2]{%
+  \ifnum \c at lofdepth > \toclevel at subfigure
+    \vskip \cftbeforesubfigskip
+    {\if at RTL\rightskip\else\leftskip\fi \cftsubfigindent\relax
+     \if at RTL\leftskip\else\rightskip\fi \@tocrmarg
+     \parfillskip -\if at RTL\leftskip\else\rightskip\fi
+     \parindent \cftsubfigindent\relax\@afterindenttrue
+     \interlinepenalty\@M
+     \leavevmode
+     \@tempdima \cftsubfignumwidth\relax
+     \let\@cftbsnum \cftsubfigpresnum
+     \let\@cftasnum \cftsubfigaftersnum
+     \let\@cftasnumb \cftsubfigaftersnumb
+     \advance\if at RTL\rightskip\else\leftskip\fi \@tempdima \null\nobreak\hskip -\if at RTL\rightskip\else\leftskip\fi
+     {\cftsubfigfont ##1}\nobreak
+     \cftsubfigfillnum{##2}}
+  \fi
+  }
+}
+\renewcommand{\@cftl at subtab}{
+\renewcommand*{\l at subtable}[2]{%
+  \ifnum \c at lotdepth > \toclevel at subtable
+    \vskip \cftbeforesubtabskip
+    {\if at RTL\rightskip\else\leftskip\fi \cftsubtabindent\relax
+     \if at RTL\leftskip\else\rightskip\fi \@tocrmarg
+     \parfillskip -\if at RTL\leftskip\else\rightskip\fi
+     \parindent \cftsubtabindent\relax\@afterindenttrue
+     \interlinepenalty\@M
+     \leavevmode
+     \@tempdima \cftsubtabnumwidth\relax
+     \let\@cftbsnum \cftsubtabpresnum
+     \let\@cftasnum \cftsubtabaftersnum
+     \let\@cftasnumb \cftsubtabaftersnumb
+     \advance\if at RTL\rightskip\else\leftskip\fi \@tempdima \null\nobreak\hskip -\if at RTL\rightskip\else\leftskip\fi
+     {\cftsubtabfont ##1}\nobreak
+     \cftsubtabfillnum{##2}}
+  \fi
+  }
+}
+\renewcommand{\newlistentry}[4][\@empty]{%
+  \@ifundefined{c@#2}{%    check & set the counter
+    \ifx \@empty#1\relax
+      \newcounter{#2}
+    \else
+      \@ifundefined{c@#1}{\PackageWarning{tocloft}%
+                          {#1 has no counter for use as a `within'}
+        \newcounter{#2}}%
+      {\newcounter{#2}[#1]%
+       \expandafter\edef\csname the#2\endcsname{%
+         \expandafter\noexpand\csname the#1\endcsname.\noexpand\arabic{#2}}}
+    \fi
+    \setcounter{#2}{0}
+  }
+  {\PackageError{tocloft}{#2 has been previously defined}{\@eha}}
+
+  \@namedef{l@#2}##1##2{%
+    \ifnum \@nameuse{c@#3depth} > #4\relax
+      \vskip \@nameuse{cftbefore#2skip}
+      {\if at RTL\rightskip\else\leftskip\fi \@nameuse{cft#2indent}\relax
+       \if at RTL\leftskip\else\rightskip\fi \@tocrmarg
+       \parfillskip -\if at RTL\leftskip\else\rightskip\fi
+       \parindent \@nameuse{cft#2indent}\relax\@afterindenttrue
+       \interlinepenalty\@M
+       \leavevmode
+       \@tempdima \@nameuse{cft#2numwidth}\relax
+       \expandafter\let\expandafter\@cftbsnum\csname cft#2presnum\endcsname
+       \expandafter\let\expandafter\@cftasnum\csname cft#2aftersnum\endcsname
+       \expandafter\let\expandafter\@cftasnumb\csname cft#2aftersnumb\endcsname
+       \advance\if at RTL\rightskip\else\leftskip\fi\@tempdima \null\nobreak\hskip -\if at RTL\rightskip\else\leftskip\fi
+       {\@nameuse{cft#2font}##1}\nobreak
+       \@nameuse{cft#2fillnum}{##2}}
+    \fi
+  }  % end of \l@#2
+
+  \expandafter\newlength\csname cftbefore#2skip\endcsname
+    \setlength{\@nameuse{cftbefore#2skip}}{\z@ \@plus .2\p@}
+  \expandafter\newlength\csname cft#2indent\endcsname
+  \expandafter\newlength\csname cft#2numwidth\endcsname
+  \ifcase #4\relax  % 0
+    \setlength{\@nameuse{cft#2indent}}{0em}
+    \setlength{\@nameuse{cft#2numwidth}}{1.5em}
+  \or               % 1
+    \setlength{\@nameuse{cft#2indent}}{1.5em}
+    \setlength{\@nameuse{cft#2numwidth}}{2.3em}
+  \or               % 2
+    \setlength{\@nameuse{cft#2indent}}{3.8em}
+    \setlength{\@nameuse{cft#2numwidth}}{3.2em}
+  \or               % 3
+    \setlength{\@nameuse{cft#2indent}}{7.0em}
+    \setlength{\@nameuse{cft#2numwidth}}{4.1em}
+  \else             % anything else
+    \setlength{\@nameuse{cft#2indent}}{10.0em}
+    \setlength{\@nameuse{cft#2numwidth}}{5.0em}
+  \fi
+  \@namedef{cft#2font}{\normalfont}
+  \@namedef{cft#2presnum}{}
+  \@namedef{cft#2aftersnum}{}
+  \@namedef{cft#2aftersnumb}{}
+  \@namedef{cft#2dotsep}{\cftdotsep}
+  \@namedef{cft#2leader}{\normalfont\cftdotfill{\@nameuse{cft#2dotsep}}}
+  \@namedef{cft#2pagefont}{\normalfont}
+  \@namedef{cft#2afterpnum}{}
+  \@namedef{toclevel@#2}{#4}
+  \@namedef{cft#2fillnum}##1{%
+    {\@nameuse{cft#2leader}}\nobreak
+    \hb at xt@\@pnumwidth{\hfil\@nameuse{cft#2pagefont}##1}\@nameuse{cft#2afterpnum}\par}
+} % end \newlistentry
+\renewcommand{\cftchapterprecistoc}[1]{\addtocontents{toc}{%
+  {\if at RTL\rightskip\else\leftskip\fi \cftchapindent\relax
+   \advance\if at RTL\righskip\else\leftskip\fi \cftchapnumwidth\relax
+   \if at RTL\leftskip\else\rightskip\fi \@tocrmarg\relax
+   \textit{#1}\protect\par}}}
+%% 
+%% Copyright ?? 2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `tocloft-bidi.def'.

Added: tags/texmf/tex/xelatex/bidi/tocstyle-bidi.def
===================================================================
--- tags/texmf/tex/xelatex/bidi/tocstyle-bidi.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/bidi/tocstyle-bidi.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,274 @@
+%%
+%% This is file `tocstyle-bidi.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% bidi.dtx  (with options: `tocstyle-bidi.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\renewcommand*{\tocstyle at dottedtocline}[5]{%
+  \let\numberline\tocstyle at numberline
+  \ifnum #1>\c at tocdepth \else
+    \if at tocstyle@penalties
+      \begingroup
+        \@tempcnta 20010
+        \advance \@tempcnta by -#1
+        \ifnum \@tempcnta>\lastpenalty
+          \aftergroup\penalty\aftergroup\@lowpenalty
+        \fi
+      \endgroup
+    \fi
+    \edef\tocstyledepth{#1}%
+    \tocstyle at activate@features
+    \ifx\tocstyle at feature@entryvskip\relax
+      \vskip \z@ \@plus.2\p@
+    \else
+      \addvspace{\tocstyle at feature@entryvskip}%
+    \fi
+    {%
+      \parskip \z@ \parindent \z@ \if at RTL\rightskip\else\leftskip\fi \z@ \if at RTL\leftskip\else\rightskip\fi \z@
+      \tocstyle at feature@raggedhook
+      \@tempdima #3\relax
+      \@tempdimb #2\relax
+      \typeout{m (\tocstyleTOC, \tocstyledepth): \the\@tempdima}%
+      \ifnum #1>\z@\relax
+        \@tempcnta #1\relax \advance\@tempcnta \m at ne
+        \ifcsname tocstyle at skipwidth@\tocstyleTOC @\the\@tempcnta\endcsname
+          \ifcsname tocstyle at numwidth@\tocstyleTOC @\the\@tempcnta\endcsname
+            \@tempdimb
+            \csname tocstyle at skipwidth@\tocstyleTOC @\the\@tempcnta\endcsname
+            \advance\@tempdimb
+            \csname tocstyle at numwidth@\tocstyleTOC @\the\@tempcnta\endcsname
+          \fi
+        \fi
+      \fi
+      \typeout{C (\tocstyleTOC, \tocstyledepth): \the\@tempdimb}%
+      \ifcsname tocstyle at skipwidth@\tocstyleTOC @#1\endcsname
+        \ifdim \@tempdimb>
+        \csname tocstyle at skipwidth@\tocstyleTOC @#1\endcsname\relax
+          \expandafter\xdef\csname tocstyle at skipwidth@\tocstyleTOC
+          @#1\endcsname{\the\@tempdimb}%
+        \fi
+      \else
+        \expandafter\xdef\csname tocstyle at skipwidth@\tocstyleTOC
+        @#1\endcsname{\the\@tempdimb}%
+      \fi
+      \iftocstyle at autolength
+        \ifcsname tocstyle at maxskipwidth@\tocstyleTOC @#1\endcsname
+          \@tempdimb \csname tocstyle at maxskipwidth@\tocstyleTOC @#1\endcsname
+          \relax
+        \fi
+        \ifcsname tocstyle at maxnumwidth@\tocstyleTOC @#1\endcsname
+          \@tempdima \csname tocstyle at maxnumwidth@\tocstyleTOC @#1\endcsname
+          \relax
+        \fi
+        \typeout{a (\tocstyleTOC, \tocstyledepth): \the\@tempdima}%
+        \typeout{A (\tocstyleTOC, \tocstyledepth): \the\@tempdimb}%
+      \else
+        \@tempdimb #2\relax
+        \typeout{M (\tocstyleTOC, \tocstyledepth): \the\@tempdimb}%
+      \fi
+      \ifcsname tocstyle at unumwidth@\tocstyleTOC @\endcsname
+        \ifdim \@tempdima>
+        \csname tocstyle at unumwidth@\tocstyleTOC @\endcsname\relax
+          \expandafter\xdef\csname tocstyle at unumwidth@\tocstyleTOC
+          @\endcsname{\the\@tempdima}%
+        \fi
+      \else
+        \expandafter\xdef\csname tocstyle at unumwidth@\tocstyleTOC
+        @\endcsname{\the\@tempdima}%
+      \fi
+      \ifcase\tocstyle at indentstyle\relax\else
+        \@tempdimb \z@
+        \ifcsname tocstyle at maxunumwidth@\tocstyleTOC @\endcsname
+          \@tempdima \csname tocstyle at maxunumwidth@\tocstyleTOC @\endcsname
+          \relax
+        \fi
+        \typeout{s (\tocstyleTOC, \tocstyledepth): \the\@tempdima}%
+        \typeout{S (\tocstyleTOC, \tocstyledepth): \the\@tempdimb}%
+      \fi
+      \advance\parindent \@tempdimb\@afterindenttrue
+      \advance\if at RTL\rightskip\else\leftskip\fi \parindent
+      \advance\if at RTL\leftskip\else\rightskip\fi \@tocrmarg
+      \parfillskip -\if at RTL\leftskip\else\rightskip\fi
+      \ifx\tocstyle at feature@parfillskip\relax\else
+        \advance\parfillskip \tocstyle at feature@parfillskip\relax
+      \fi
+      \interlinepenalty\@M
+      \leavevmode
+      \advance\if at RTL\rightskip\else\leftskip\fi \@tempdima
+      \null\nobreak
+      \iftocstyle at indentnotnumbered\else
+        \hskip -\if at RTL\rightskip\else\leftskip\fi
+      \fi
+      \tocstyle at feature@entryhook
+      {#4}\nobreak
+      \ifx\tocstyle at feature@leaders\relax
+        \leaders\hbox{$\m at th
+          \mkern \@dotsep mu\hbox{\tocstyle at feature@dothook .}%
+          \mkern \@dotsep mu$}\hfill
+      \else
+        \tocstyle at feature@leaders
+      \fi
+      \nobreak
+      \ifx\tocstyle at feature@pagenumberbox\relax
+        \hb at xt@\@pnumwidth{\hfil\tocstyle at feature@pagenumberhook #5}%
+      \else
+        \tocstyle at feature@pagenumberbox{\tocstyle at feature@pagenumberhook #5}%
+      \fi
+      \par
+    }%
+    \if at tocstyle@penalties
+      \bgroup
+        \@tempcnta 20009
+        \advance\@tempcnta by -#1
+        \edef\reserved at a{\egroup\penalty\the\@tempcnta\relax}%
+      \reserved at a
+    \fi
+  \fi}
+\renewcommand*{\tocstyle at numberline}[1]{%
+  \begingroup
+    \ifx\tocstyle at feature@spaceafternumber\relax
+      \settowidth\@tempdima{\tocstyle@@numberline{#1}\enskip}%
+    \else
+      \settowidth\@tempdima{\tocstyle@@numberline{#1}}%
+      \advance \@tempdima \tocstyle at feature@spaceafternumber\relax
+    \fi
+    \ifcsname tocstyle at numwidth@\tocstyleTOC @\tocstyledepth\endcsname
+      \ifdim \@tempdima >
+      \csname tocstyle at numwidth@\tocstyleTOC @\tocstyledepth\endcsname\relax
+        \expandafter\xdef\csname tocstyle at numwidth@\tocstyleTOC
+        @\tocstyledepth\endcsname{\the\@tempdima}%
+      \fi
+    \else
+      \expandafter\xdef\csname tocstyle at numwidth@\tocstyleTOC
+      @\tocstyledepth\endcsname{\the\@tempdima}%
+    \fi
+  \endgroup
+  \iftocstyle at indentnotnumbered
+    \hskip -\if at RTL\rightskip\else\leftskip\fi
+  \fi
+  \ifcase \tocstyle at indentstyle
+    \hb at xt@\@tempdima{\tocstyle@@numberline{#1}\hfil}%
+  \or
+    \hb at xt@\@tempdima{\tocstyle@@numberline{#1}\hfil}%
+  \else
+    \ifx\tocstyle at feature@spaceafternumber\relax
+      \hbox{\tocstyle@@numberline{#1}\enskip}%
+    \else
+      \hbox{\tocstyle@@numberline{#1}\hskip
+        \tocstyle at feature@spaceafternumber\relax}%
+    \fi
+  \fi
+}
+\AtBeginDocument{%
+  \ifcsname l at part\endcsname
+    \ifcsname l at chapter\endcsname
+      \setbox\@tempboxa\vbox{\hsize\maxdimen
+        \l at part{\tocstyle at l@define{part}{-1}}{}}%
+    \else
+      \setbox\@tempboxa\vbox{\hsize\maxdimen
+        \l at part{\tocstyle at l@define{part}{0}}{}}%
+    \fi
+  \fi
+  \ifcsname l at chapter\endcsname
+    \setbox\@tempboxa\vbox{\hsize\maxdimen
+      \l at chapter{\tocstyle at l@define{chapter}{0}}{}}%
+  \fi
+  \ifcsname l at section\endcsname
+    \setbox\@tempboxa\vbox{\hsize\maxdimen
+      \l at section{\tocstyle at l@define{section}{1}}{}}%
+  \fi
+  \ifcsname l at subsection\endcsname
+    \setbox\@tempboxa\vbox{\hsize\maxdimen
+      \l at subsection{\tocstyle at l@define{subsection}{2}}{}}%
+  \fi
+  \ifcsname l at subsubsection\endcsname
+    \setbox\@tempboxa\vbox{\hsize\maxdimen
+      \l at subsubsection{\tocstyle at l@define{subsubsection}{3}}{}}%
+  \fi
+  \ifcsname l at paragraph\endcsname
+    \setbox\@tempboxa\vbox{\hsize\maxdimen
+      \l at paragraph{\tocstyle at l@define{paragraph}{4}}{}}%
+  \fi
+  \ifcsname l at subparagraph\endcsname
+    \setbox\@tempboxa\vbox{\hsize\maxdimen
+      \l at subparagraph{\tocstyle at l@define{subparagraph}{5}}{}}%
+  \fi
+  \ifcsname l at table\endcsname
+    \setbox\@tempboxa\vbox{\hsize\maxdimen
+      \l at table{\tocstyle at l@define{table}{1}}{}}%
+  \fi
+  \ifcsname l at figure\endcsname
+    \setbox\@tempboxa\vbox{\hsize\maxdimen
+      \l at figure{\tocstyle at l@define{figure}{1}}{}}%
+  \fi
+  \def\@tempa#1#2#3#4#5{%
+    \ifnum #1>\c at tocdepth \else
+      \vskip \z@ \@plus.2\p@
+      {\if at RTL\rightskip\else\leftskip\fi #2\relax \if at RTL\leftskip\else\rightskip\fi \@tocrmarg \parfillskip -\if at RTL\leftskip\else\rightskip\fi
+       \parindent #2\relax\@afterindenttrue
+       \interlinepenalty\@M
+       \leavevmode
+       \@tempdima #3\relax
+       \advance\if at RTL\rightskip\else\leftskip\fi \@tempdima \null\nobreak\hskip -\if at RTL\rightskip\else\leftskip\fi
+       {#4}\nobreak
+       \leaders\hbox{$\m at th
+          \mkern \@dotsep mu\hbox{.}\mkern \@dotsep
+          mu$}\hfill
+       \nobreak
+       \hb at xt@\@pnumwidth{\hfil \normalfont \normalcolor #5}%
+       \par}%
+    \fi}%
+  \ifx\@dottedtocline\@tempa\else
+    \tocstyle at macrochangewarning\@dottedtocline
+  \fi
+  \let\tocstyle at saved@dottedtocline\@dottedtocline
+  \def\@tempa#1{\hb at xt@\@tempdima{#1\autodot\hfil}}%
+  \ifx\numberline\@tempa\else
+    \def\@tempa#1{\hb at xt@\@tempdima{#1\hfil}}%
+    \ifx\numberline at tempa\else
+      \tocstyle at macrochangewarning\numberline
+    \fi
+  \fi
+  \let\tocstyle at saved@numberline\numberline
+}
+\renewcommand*{\tocstyle at l@define}[2]{%
+  \advance\if at RTL\rightskip\else\leftskip\fi-\@tempdima
+  \edef\@tempa{%
+    \noexpand\global\noexpand\let
+    \expandafter\noexpand\csname tocstyle at saved@l@#1\endcsname
+    \expandafter\noexpand\csname l@#1\endcsname
+    \noexpand\gdef
+    \expandafter\noexpand\csname tocstyle at l@#1\endcsname{%
+      \noexpand\@dottedtocline{#2}{\the\if at RTL\rightskip\else\leftskip\fi}{\the\@tempdima}}%
+    \noexpand\g at addto@macro\noexpand\tocstyle at activate@all at l{%
+      \noexpand\let\expandafter\noexpand\csname l@#1\endcsname
+      \expandafter\noexpand\csname tocstyle at l@#1\endcsname
+    }%
+  }%
+  \PackageInfo{tocstyle}{prepare \expandafter\string
+    \csname l@#1\endcsname\space for redefinition}%
+  \@tempa
+}
+%% 
+%% Copyright ?? 2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `tocstyle-bidi.def'.

Added: tags/texmf/tex/xelatex/bidi/wrapfig-bidi.def
===================================================================
--- tags/texmf/tex/xelatex/bidi/wrapfig-bidi.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/bidi/wrapfig-bidi.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,104 @@
+%%
+%% This is file `wrapfig-bidi.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% bidi.dtx  (with options: `wrapfig-bidi.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\let\WF@@everypar\n at everypar
+\def\WF at putfigmaybe{%
+\ifinner
+  \vskip-\parskip \global\WF at floatfalse
+  \let\pagetotal\maxdimen % kludge flag for "not top of page"
+\else % outer page
+  \@tempdima\pagedepth % save page depth
+   {\advance\parskip\if at RTL\@tempdimb\else\@tempdima\fi\vskip-\parskip}% back up to baseline
+   \penalty\interlinepenalty % update pg. parameters
+   \@tempdimb\pagegoal \advance\@tempdimb-\pagetotal % room left on page
+   \ifdim\@tempdimb<\z@ % \WF at info{Page overfull already;}%
+      \global\WF at floatfalse
+      \ifdim-\@tempdimb>\pageshrink \else \pagebreak \fi
+   \else
+      \ifdim\WF at size>\@tempdimb
+         \ifWF at float \dimen at .5\baselineskip \else \dimen@ 2\baselineskip\fi
+         \ifdim\pagestretch>\dimen@ \dimen@\pagestretch \fi
+         \ifdim\pagefilstretch>\z@ \dimen@\@tempdimb \fi
+         \ifdim\pagefillstretch>\z@ \dimen@\@tempdimb \fi
+         \advance\dimen at .5\baselineskip
+         \ifdim\dimen@>\@tempdimb % \WF at info{Page nearly full; can stretch}%
+            \global\WF at floatfalse \pagebreak
+         \fi
+      \else % \WF at info{Fits in \the\@tempdimb;}%
+         \global\WF at floatfalse
+   \fi\fi
+   \vskip\@tempdima\relax % (return erased page depth)
+\fi
+\noindent
+\ifWF at float
+  \WF at fltmes
+\else % putting here;
+  \WF at info{Put \WF at wfname here:}%
+  {\ifodd\if at twoside\c at page\else\@ne\fi % assign l/r to i/o placement
+    \lccode`i`l\lccode`o`r\else \lccode`i`r\lccode`o`l\fi
+    \xdef\WF at place{\the\lccode\lccode\WF at place}}% twice to get only l or r
+  \hbox to\z@{% llap or rlap depending on {l} or {r}; calc effective width
+   \@tempdima\wd\WF at box \@tempdimb\WF at ovh
+   \advance\@tempdima-\@tempdimb \advance\@tempdima\columnsep
+   \@tempdimb\hsize \advance\@tempdimb-\@tempdima
+   \xdef\WF at adjlw{\the\@tempdima}%
+   \ifnum `l=\WF at place % fig on left
+    \if at RTL%
+     \kern\@tempdimb \kern\columnsep
+    \def\@tempa{\hss}% position to left of the gap
+     \else%
+    \hss % figure overlaps space to the left
+    \def\@tempa{\kern\columnsep}% position to left of the gap
+    \fi%
+   \else  %  fig on right
+    \if at RTL%
+     \hss
+      \@tempdima\z@
+      \def\@tempa{\kern\columnsep}
+     \else%
+    \@tempdima\z@ % no left indentation
+    \kern\@tempdimb \kern\columnsep
+    \def\@tempa{\hss}% figure overlaps space to the right
+    \fi%
+   \fi
+   \ifdim\@tempdimb<\hsize
+    \xdef\WF at wrapil{\the\@tempdima \the\@tempdimb}% indentation and length
+    \xdef\WF at adjtlm{\the\@tempdima}%
+   \else
+    \xdef\WF at wrapil{\z@ \the\hsize}%
+    \xdef\WF at adjlw{\z@}\xdef\WF at adjtlm{\z@}%
+   \fi
+   \ifdim\pagetotal=\z@ % \WF at info{Put \WF at wfname at top of p.\thepage}%
+    \global\advance\WF at size-\intextsep
+   \else % \WF at info{Putting \WF at wfname in middle of page}%
+    \setbox\WF at box\hbox{\lower\intextsep\box\WF at box}%
+   \fi \dp\WF at box\z@ \box\WF at box \@tempa
+  }% end \hbox to 0pt
+  \aftergroup\WF at startwrapping % after the \endgroup which immediately follows
+\fi}
+%% 
+%% Copyright ?? 2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `wrapfig-bidi.def'.

Added: tags/texmf/tex/xelatex/bidi/xltxtra-bidi.def
===================================================================
--- tags/texmf/tex/xelatex/bidi/xltxtra-bidi.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/bidi/xltxtra-bidi.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,33 @@
+%%
+%% This is file `xltxtra-bidi.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% bidi.dtx  (with options: `xltxtra-bidi.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\let\@@XeTeX\XeTeX
+\def\XeTeX{\@ensure at LTR{\@@XeTeX}}
+\let\@@XeLaTeX\XeLaTeX
+\def\XeLaTeX{\@ensure at LTR{\@@XeLaTeX}}
+%% 
+%% Copyright ?? 2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `xltxtra-bidi.def'.

Added: tags/texmf/tex/xelatex/xepersian/algorithm-xepersian.def
===================================================================
--- tags/texmf/tex/xelatex/xepersian/algorithm-xepersian.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/xepersian/algorithm-xepersian.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,32 @@
+%%
+%% This is file `algorithm-xepersian.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% xepersian.dtx  (with options: `algorithm-xepersian.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2008-2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\def\ALG at name{\if at RTL ????????????????\else Algorithm\fi}
+\def\ALGS at name{???????????????????????}
+\def\listalgorithmname{\if at RTL ???????? \ALGS at name\else List of \ALG at name s\fi}
+%% 
+%% Copyright ?? 2008-2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `algorithm-xepersian.def'.

Added: tags/texmf/tex/xelatex/xepersian/algorithmic-xepersian.def
===================================================================
--- tags/texmf/tex/xelatex/xepersian/algorithmic-xepersian.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/xepersian/algorithmic-xepersian.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,31 @@
+%%
+%% This is file `algorithmic-xepersian.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% xepersian.dtx  (with options: `algorithmic-xepersian.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2008-2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\def\algorithmicrequire{\if at RTL\textbf{??????????:}\else\textbf{Require:}\fi}
+\def\algorithmicensure{\if at RTL\textbf{??????????:}\else\textbf{Ensure:}\fi}
+%% 
+%% Copyright ?? 2008-2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `algorithmic-xepersian.def'.

Added: tags/texmf/tex/xelatex/xepersian/amsart-xepersian.def
===================================================================
--- tags/texmf/tex/xelatex/xepersian/amsart-xepersian.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/xepersian/amsart-xepersian.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,34 @@
+%%
+%% This is file `amsart-xepersian.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% xepersian.dtx  (with options: `amsart-xepersian.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2008-2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\renewcommand \thepart {\@tartibi\c at part}
+\renewcommand\appendix{\par
+  \setcounter{section}{0}%
+  \setcounter{subsection}{0}%
+  \gdef\thesection{\@harfi\c at section}}
+%% 
+%% Copyright ?? 2008-2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `amsart-xepersian.def'.

Added: tags/texmf/tex/xelatex/xepersian/amsbook-xepersian.def
===================================================================
--- tags/texmf/tex/xelatex/xepersian/amsbook-xepersian.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/xepersian/amsbook-xepersian.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,37 @@
+%%
+%% This is file `amsbook-xepersian.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% xepersian.dtx  (with options: `amsbook-xepersian.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2008-2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\def\frontmatter{\cleardoublepage\pagenumbering{harfi}}
+\renewcommand \thepart {\@tartibi\c at part}
+\renewcommand\appendix{\par
+  \setcounter{chapter}{0}%
+  \setcounter{section}{0}%
+  \gdef\@chapapp{\appendixname}%
+  \gdef\thechapter{\@harfi\c at chapter}
+}%end appendix
+%% 
+%% Copyright ?? 2008-2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `amsbook-xepersian.def'.

Added: tags/texmf/tex/xelatex/xepersian/article-xepersian.def
===================================================================
--- tags/texmf/tex/xelatex/xepersian/article-xepersian.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/xepersian/article-xepersian.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,34 @@
+%%
+%% This is file `article-xepersian.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% xepersian.dtx  (with options: `article-xepersian.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2008-2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\renewcommand \thepart {\@tartibi\c at part}
+\renewcommand\appendix{\par
+  \setcounter{section}{0}%
+  \setcounter{subsection}{0}%
+  \gdef\thesection{\@harfi\c at section}}
+%% 
+%% Copyright ?? 2008-2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `article-xepersian.def'.

Added: tags/texmf/tex/xelatex/xepersian/backref-xepersian.def
===================================================================
--- tags/texmf/tex/xelatex/xepersian/backref-xepersian.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/xepersian/backref-xepersian.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,30 @@
+%%
+%% This is file `backref-xepersian.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% xepersian.dtx  (with options: `backref-xepersian.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2008-2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\def\backrefpagesname{\if at RTL ??????????\else pages\fi}
+%% 
+%% Copyright ?? 2008-2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `backref-xepersian.def'.

Added: tags/texmf/tex/xelatex/xepersian/beamer-xepersian.def
===================================================================
--- tags/texmf/tex/xelatex/xepersian/beamer-xepersian.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/xepersian/beamer-xepersian.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,45 @@
+%%
+%% This is file `beamer-xepersian.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% xepersian.dtx  (with options: `beamer-xepersian.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2008-2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\def\familydefault{\rmdefault}
+\def\latin{\bgroup\LatinAlphs\par\raggedright\@RTLfalse\@RTL at footnotefalse\latinfont}
+\def\endlatin{\par\egroup}
+\def\persian{\bgroup\PersianAlphs\par\raggedleft\@RTLtrue\@RTL at footnotetrue\persianfont}
+\def\endpersian{\par\egroup}
+\def\biditheoremname{????????}
+\def\bidicorollaryname{??????????}
+\def\bidifactname{??????????}
+\def\bidilemmaname{????}
+\def\bidiproblemname{??????????}
+\def\bidisolutionname{????????}
+\def\bididefinitionname{??????????}
+\def\bididefinitionsname{?????????????????}
+\def\bidiexamplename{????????}
+\def\bidiexamplesname{???????????????}
+\def\bidiproofname{??????????}
+%% 
+%% Copyright ?? 2008-2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `beamer-xepersian.def'.

Added: tags/texmf/tex/xelatex/xepersian/bidimemoir-xepersian.def
===================================================================
--- tags/texmf/tex/xelatex/xepersian/bidimemoir-xepersian.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/xepersian/bidimemoir-xepersian.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,40 @@
+%%
+%% This is file `bidimemoir-xepersian.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% xepersian.dtx  (with options: `bidimemoir-xepersian.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2008-2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\renewcommand{\@memfront}{%
+  \@smemfront\pagenumbering{harfi}}
+\renewcommand{\setthesection}{\thechapter\@SepMark\harfi{section}}
+\renewcommand*{\thebook}{\@tartibi\c at book}
+\renewcommand*{\thepart}{\@tartibi\c at part}
+\renewcommand{\appendix}{\par
+  \setcounter{chapter}{0}%
+  \setcounter{section}{0}%
+  \gdef\@chapapp{\appendixname}%
+  \gdef\thechapter{\@harfi\c at chapter}%
+  \anappendixtrue}
+%% 
+%% Copyright ?? 2008-2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `bidimemoir-xepersian.def'.

Added: tags/texmf/tex/xelatex/xepersian/bidimoderncv-xepersian.def
===================================================================
--- tags/texmf/tex/xelatex/xepersian/bidimoderncv-xepersian.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/xepersian/bidimoderncv-xepersian.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,30 @@
+%%
+%% This is file `bidimoderncv-xepersian.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% xepersian.dtx  (with options: `bidimoderncv-xepersian.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2008-2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\def\refname{??????????????}
+%% 
+%% Copyright ?? 2008-2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `bidimoderncv-xepersian.def'.

Added: tags/texmf/tex/xelatex/xepersian/book-xepersian.def
===================================================================
--- tags/texmf/tex/xelatex/xepersian/book-xepersian.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/xepersian/book-xepersian.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,44 @@
+%%
+%% This is file `book-xepersian.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% xepersian.dtx  (with options: `book-xepersian.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2008-2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\renewcommand\frontmatter{%
+    \cleardoublepage
+  \@mainmatterfalse
+  \pagenumbering{harfi}}
+\renewcommand\mainmatter{%
+    \cleardoublepage
+  \@mainmattertrue
+  \pagenumbering{arabic}}
+\renewcommand \thepart {\@tartibi\c at part}
+\renewcommand\appendix{\par
+  \setcounter{chapter}{0}%
+  \setcounter{section}{0}%
+  \gdef\@chapapp{\appendixname}%
+  \gdef\thechapter{\@harfi\c at chapter}
+}%end appendix
+%% 
+%% Copyright ?? 2008-2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `book-xepersian.def'.

Added: tags/texmf/tex/xelatex/xepersian/bookest-xepersian.def
===================================================================
--- tags/texmf/tex/xelatex/xepersian/bookest-xepersian.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/xepersian/bookest-xepersian.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,36 @@
+%%
+%% This is file `bookest-xepersian.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% xepersian.dtx  (with options: `bookest-xepersian.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2008-2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\renewcommand \thepart {\@tartibi\c at part}
+\renewcommand\appendix{\par
+  \setcounter{chapter}{0}%
+  \setcounter{section}{0}%
+  \gdef\@chapapp{\appendixname}%
+  \gdef\thechapter{\@harfi\c at chapter}
+}%end appendix
+%% 
+%% Copyright ?? 2008-2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `bookest-xepersian.def'.

Added: tags/texmf/tex/xelatex/xepersian/commands-ltx.def
===================================================================
--- tags/texmf/tex/xelatex/xepersian/commands-ltx.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/xepersian/commands-ltx.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,841 @@
+%%
+%% This is file `commands-ltx.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% xepersian.dtx  (with options: `commands-ltx.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2008-2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\eqcommand[]{\abovedisplayshortskip}
+\eqcommand[]{\abovedisplayskip}
+\eqcommand[]{\abstractname}
+\eqcommand[]{\acute}
+\eqcommand[]{\addcontentsline}
+\eqcommand[]{\address}
+\eqcommand[]{\addtocontents}
+\eqcommand[]{\addtocounter}
+\eqcommand[]{\addtolength}
+\eqcommand[]{\addvspace}
+\eqcommand[]{\aleph}
+\eqcommand[]{\allowdisplaybreaks}
+\eqcommand[]{\Alph}
+\eqcommand[]{\alph}
+\eqcommand[]{\alpha}
+\eqcommand[]{\alsoname}
+\eqcommand[]{\amalg}
+\eqcommand[]{\and}
+\eqcommand[]{\angle}
+\eqcommand[]{\appendixname}
+\eqcommand[]{\approx}
+\eqcommand[]{\arabic}
+\eqcommand[]{\arccos}
+\eqcommand[]{\arcsin}
+\eqcommand[]{\arctan}
+\eqcommand[]{\arg}
+\eqcommand[]{\arraycolsep}
+\eqcommand[]{\arrayrulewidth}
+\eqcommand[]{\arraystretch}
+\eqcommand[]{\ast}
+\eqcommand[]{\asymp}
+\eqcommand[]{\AtBeginDocument}
+\eqcommand[]{\AtEndDocument}
+\eqcommand[]{\AtEndOfClass}
+\eqcommand[]{\AtEndOfPackage}
+\eqcommand[]{\author}
+\eqcommand[]{\backmatter}
+\eqcommand[]{\backslash}
+\eqcommand[]{\bar}
+\eqcommand[]{\baselineskip}
+\eqcommand[]{\baselinestretch}
+\eqcommand[]{\begin}
+\eqcommand[]{\belowdisplayshortskip}
+\eqcommand[]{\belowdisplayskip}
+\eqcommand[]{\beta}
+\eqcommand[]{\bfdefault}
+\eqcommand[]{\bfseries}
+\eqcommand[]{\bibitem}
+\eqcommand[]{\bibliography}
+\eqcommand[]{\bibliographystyle}
+\eqcommand[]{\bibname}
+\eqcommand[]{\big}
+\eqcommand[]{\Big}
+\eqcommand[]{\bigcap}
+\eqcommand[]{\bigcirc}
+\eqcommand[]{\bigcup}
+\eqcommand[]{\bigg}
+\eqcommand[]{\Bigg}
+\eqcommand[]{\bigodot}
+\eqcommand[]{\bigoplus}
+\eqcommand[]{\bigotimes}
+\eqcommand[]{\bigskip}
+\eqcommand[]{\bigskipamount}
+\eqcommand[]{\bigsqcup}
+\eqcommand[]{\bigtriangledown}
+\eqcommand[]{\bigtriangleup}
+\eqcommand[]{\biguplus}
+\eqcommand[]{\bigvee}
+\eqcommand[]{\bigwedge}
+\eqcommand[]{\binom}
+\eqcommand[]{\bmod}
+\eqcommand[]{\boldmath}
+\eqcommand[]{\boldsymbol}
+\eqcommand[]{\bot}
+\eqcommand[]{\botfigrule}
+\eqcommand[]{\bottomfraction}
+\eqcommand[]{\bowtie}
+\eqcommand[]{\Box}
+\eqcommand[]{\boxed}
+\eqcommand[]{\breve}
+\eqcommand[]{\bullet}
+\eqcommand[]{\cap}
+\eqcommand[]{\caption}
+\eqcommand[]{\cc}
+\eqcommand[]{\ccname}
+\eqcommand[]{\cdot}
+\eqcommand[]{\cdots}
+\eqcommand[]{\centering}
+\eqcommand[]{\centerline}
+\eqcommand[]{\cfrac}
+\eqcommand[]{\chapter}
+\eqcommand[]{\chapter*}
+\eqcommand[]{\chaptername}
+\eqcommand[]{\check}
+\eqcommand[]{\CheckCommand}
+\eqcommand[]{\chi}
+\eqcommand[]{\circ}
+\eqcommand[]{\circle}
+\eqcommand[]{\circle*}
+\eqcommand[]{\cite}
+\eqcommand[]{\citep}
+\eqcommand[]{\citet}
+\eqcommand[]{\ClassError}
+\eqcommand[]{\ClassInfo}
+\eqcommand[]{\ClassWarning}
+\eqcommand[]{\ClassWarningNoLine}
+\eqcommand[]{\cleardoublepage}
+\eqcommand[]{\clearpage}
+\eqcommand[]{\cline}
+\eqcommand[]{\closing}
+\eqcommand[]{\clubsuit}
+\eqcommand[]{\color}
+\eqcommand[]{\colorbox}
+\eqcommand[]{\columnsep}
+\eqcommand[]{\columnseprule}
+\eqcommand[]{\cong}
+\eqcommand[]{\contentsline}
+\eqcommand[]{\contentsname}
+\eqcommand[]{\coprod}
+\eqcommand[]{\copyright}
+\eqcommand[]{\cos}
+\eqcommand[]{\cosh}
+\eqcommand[]{\cot}
+\eqcommand[]{\coth}
+\eqcommand[]{\csc}
+\eqcommand[]{\cup}
+\eqcommand[]{\CurrentOption}
+\eqcommand[]{\dag}
+\eqcommand[]{\dagger}
+\eqcommand[]{\dashbox}
+\eqcommand[]{\dashv}
+\eqcommand[]{\date}
+\eqcommand[]{\dbinom}
+\eqcommand[]{\dblfigrule}
+\eqcommand[]{\dblfloatpagefraction}
+\eqcommand[]{\dblfloatsep}
+\eqcommand[]{\dbltextfloatsep}
+\eqcommand[]{\dbltopfraction}
+\eqcommand[]{\ddag}
+\eqcommand[]{\ddagger}
+\eqcommand[]{\dddot}
+\eqcommand[]{\ddddot}
+\eqcommand[]{\ddot}
+\eqcommand[]{\ddots}
+\eqcommand[]{\DeclareGraphicsExtensions}
+\eqcommand[]{\DeclareGraphicsRule}
+\eqcommand[]{\DeclareOption}
+\eqcommand[]{\DeclareOption*}
+\eqcommand[]{\DeclareRobustCommand}
+\eqcommand[]{\DeclareRobustCommand*}
+\eqcommand[]{\definecolor}
+\eqcommand[]{\deg}
+\eqcommand[]{\DeleteShortVerb}
+\eqcommand[]{\Delta}
+\eqcommand[]{\delta}
+\eqcommand[]{\depth}
+\eqcommand[]{\det}
+\eqcommand[]{\dfrac}
+\eqcommand[]{\Diamond}
+\eqcommand[]{\diamond}
+\eqcommand[]{\diamondsuit}
+\eqcommand[]{\dim}
+\eqcommand[]{\discretionary}
+\eqcommand[]{\displaybreak}
+\eqcommand[]{\displaystyle}
+\eqcommand[]{\div}
+\eqcommand[]{\documentclass}
+\eqcommand[]{\dot}
+\eqcommand[]{\doteq}
+\eqcommand[]{\dotfill}
+\eqcommand[]{\dots}
+\eqcommand[]{\dotsb}
+\eqcommand[]{\dotsc}
+\eqcommand[]{\dotsi}
+\eqcommand[]{\dotsm}
+\eqcommand[]{\doublebox}
+\eqcommand[]{\doublerulesep}
+\eqcommand[]{\Downarrow}
+\eqcommand[]{\downarrow}
+\eqcommand[]{\ell}
+\eqcommand[]{\em}
+\eqcommand[]{\emph}
+\eqcommand[]{\emptyset}
+\eqcommand[]{\encl}
+\eqcommand[]{\enclname}
+\eqcommand[]{\end}
+\eqcommand[]{\endfirsthead}
+\eqcommand[]{\endfoot}
+\eqcommand[]{\endhead}
+\eqcommand[]{\endlastfoot}
+\eqcommand[]{\enlargethispage}
+\eqcommand[]{\enlargethispage*}
+\eqcommand[]{\ensuremath}
+\eqcommand[]{\epsilon}
+\eqcommand[]{\eqref}
+\eqcommand[]{\equiv}
+\eqcommand[]{\eta}
+\eqcommand[]{\euro}
+\eqcommand[]{\EUR}
+\eqcommand[]{\evensidemargin}
+\eqcommand[]{\ExecuteOptions}
+\eqcommand[]{\exists}
+\eqcommand[]{\exp}
+\eqcommand[]{\extracolsep}
+\eqcommand[]{\fancypage}
+\eqcommand[]{\fbox}
+\eqcommand[]{\fboxrule}
+\eqcommand[]{\fboxsep}
+\eqcommand[]{\fcolorbox}
+\eqcommand[]{\figurename}
+\eqcommand[]{\fill}
+\eqcommand[]{\flat}
+\eqcommand[]{\floatpagefraction}
+\eqcommand[]{\floatsep}
+\eqcommand[]{\flushbottom}
+\eqcommand[]{\fnsymbol}
+\eqcommand[]{\fontfamily}
+\eqcommand[]{\fontseries}
+\eqcommand[]{\fontshape}
+\eqcommand[]{\fontsize}
+\eqcommand[]{\LTRfootnote}
+\eqcommand[]{\footnote}
+\eqcommand[]{\footnotemark}
+\eqcommand[]{\footnoterule}
+\eqcommand[]{\footnotesep}
+\eqcommand[]{\footnotesize}
+\eqcommand[]{\footnotetext}
+\eqcommand[]{\footskip}
+\eqcommand[]{\forall}
+\eqcommand[]{\frac}
+\eqcommand[]{\frame}
+\eqcommand[]{\framebox}
+\eqcommand[]{\frenchspacing}
+\eqcommand[]{\frontmatter}
+\eqcommand[]{\frown}
+\eqcommand[]{\fussy}
+\eqcommand[]{\Gamma}
+\eqcommand[]{\gamma}
+\eqcommand[]{\gcd}
+\eqcommand[]{\ge}
+\eqcommand[]{\genfrac}
+\eqcommand[]{\geq}
+\eqcommand[]{\gets}
+\eqcommand[]{\gg}
+\eqcommand[]{\glossary}
+\eqcommand[]{\glossaryentry}
+\eqcommand[]{\graphpaper}
+\eqcommand[]{\grave}
+\eqcommand[]{\guillemotleft}
+\eqcommand[]{\guillemotright}
+\eqcommand[]{\guilsinglleft}
+\eqcommand[]{\guilsinglright}
+\eqcommand[]{\hat}
+\eqcommand[]{\hbar}
+\eqcommand[]{\headheight}
+\eqcommand[]{\headsep}
+\eqcommand[]{\headtoname}
+\eqcommand[]{\heartsuit}
+\eqcommand[]{\height}
+\eqcommand[]{\hfill}
+\eqcommand[]{\hline}
+\eqcommand[]{\hoffset}
+\eqcommand[]{\hom}
+\eqcommand[]{\hookleftarrow}
+\eqcommand[]{\hookrightarrow}
+\eqcommand[]{\hrulefill}
+\eqcommand[]{\hspace}
+\eqcommand[]{\hspace*}
+\eqcommand[]{\huge}
+\eqcommand[]{\Huge}
+\eqcommand[]{\hyperlink}
+\eqcommand[]{\hypersetup}
+\eqcommand[]{\hypertarget}
+\eqcommand[]{\hyphenation}
+\eqcommand[]{\idotsint}
+\eqcommand[]{\iff}
+\eqcommand[]{\IfFileExists}
+\eqcommand[]{\ifthenelse}
+\eqcommand[]{\Im}
+\eqcommand[]{\imath}
+\eqcommand[]{\in}
+\eqcommand[]{\include}
+\eqcommand[]{\includegraphics}
+\eqcommand[]{\includegraphics*}
+\eqcommand[]{\includeonly}
+\eqcommand[]{\indent}
+\eqcommand[]{\index}
+\eqcommand[]{\indexentry}
+\eqcommand[]{\indexname}
+\eqcommand[]{\indexspace}
+\eqcommand[]{\inf}
+\eqcommand[]{\infty}
+\eqcommand[]{\input}
+\eqcommand[]{\InputIfFileExists}
+\eqcommand[]{\int}
+\eqcommand[]{\iint}
+\eqcommand[]{\iiint}
+\eqcommand[]{\iiiint}
+\eqcommand[]{\intertext}
+\eqcommand[]{\intertextsep}
+\eqcommand[]{\invisible}
+\eqcommand[]{\iota}
+\eqcommand[]{\itdefault}
+\eqcommand[]{\item}
+\eqcommand[]{\itemindent}
+\eqcommand[]{\itemsep}
+\eqcommand[]{\itshape}
+\eqcommand[]{\jmath}
+\eqcommand[]{\join}
+\eqcommand[]{\jot}
+\eqcommand[]{\kappa}
+\eqcommand[]{\ker}
+\eqcommand[]{\kill}
+\eqcommand[]{\label}
+\eqcommand[]{\labelenumi}
+\eqcommand[]{\labelenumii}
+\eqcommand[]{\labelenumiii}
+\eqcommand[]{\labelenumiv}
+\eqcommand[]{\labelitemi}
+\eqcommand[]{\labelitemii}
+\eqcommand[]{\labelitemiii}
+\eqcommand[]{\labelitemiv}
+\eqcommand[]{\labelsep}
+\eqcommand[]{\labelwidth}
+\eqcommand[]{\Lambda}
+\eqcommand[]{\lambda}
+\eqcommand[]{\langle}
+\eqcommand[]{\language}
+\eqcommand[]{\large}
+\eqcommand[]{\Large}
+\eqcommand[]{\LARGE}
+\eqcommand[]{\LaTeX}
+\eqcommand[]{\LaTeXe}
+\eqcommand[]{\lceil}
+\eqcommand[]{\ldots}
+\eqcommand[]{\le}
+\eqcommand[]{\leadsto}
+\eqcommand[]{\left}
+\eqcommand[]{\Leftarrow}
+\eqcommand[]{\leftarrow}
+\eqcommand[]{\lefteqn}
+\eqcommand[]{\leftharpoondown}
+\eqcommand[]{\leftharpoonup}
+\eqcommand[]{\leftmargin}
+\eqcommand[]{\Leftrightarrow}
+\eqcommand[]{\leftrightarrow}
+\eqcommand[]{\leftroot}
+\eqcommand[]{\leq}
+\eqcommand[]{\lfloor}
+\eqcommand[]{\lg}
+\eqcommand[]{\lhd}
+\eqcommand[]{\lim}
+\eqcommand[]{\liminf}
+\eqcommand[]{\limits}
+\eqcommand[]{\limsup}
+\eqcommand[]{\line}
+\eqcommand[]{\linebreak}
+\eqcommand[]{\linethickness}
+\eqcommand[]{\linewidth}
+\eqcommand[]{\listfigurename}
+\eqcommand[]{\listfiles}
+\eqcommand[]{\listoffigures}
+\eqcommand[]{\listoftables}
+\eqcommand[]{\listparindent}
+\eqcommand[]{\listtablename}
+\eqcommand[]{\ll}
+\eqcommand[]{\ln}
+\eqcommand[]{\LoadClass}
+\eqcommand[]{\LoadClassWithOptions}
+\eqcommand[]{\location}
+\eqcommand[]{\log}
+\eqcommand[]{\Longleftarrow}
+\eqcommand[]{\longleftarrow}
+\eqcommand[]{\Longleftrightarrow}
+\eqcommand[]{\longleftrightarrow}
+\eqcommand[]{\longmapsto}
+\eqcommand[]{\Longrightarrow}
+\eqcommand[]{\longrightarrow}
+\eqcommand[]{\lvert}
+\eqcommand[]{\lVert}
+\eqcommand[]{\mainmatter}
+\eqcommand[]{\makebox}
+\eqcommand[]{\makeglossary}
+\eqcommand[]{\makeindex}
+\eqcommand[]{\makelabel}
+\eqcommand[]{\makelabels}
+\eqcommand[]{\MakeLowercase}
+\eqcommand[]{\MakeShortVerb}
+\eqcommand[]{\maketitle}
+\eqcommand[]{\MakeUppercase}
+\eqcommand[]{\mapsto}
+\eqcommand[]{\marginpar}
+\eqcommand[]{\marginparpush}
+\eqcommand[]{\marginparsep}
+\eqcommand[]{\marginparwidth}
+\eqcommand[]{\markboth}
+\eqcommand[]{\markright}
+\eqcommand[]{\mathbf}
+\eqcommand[]{\mathcal}
+\eqcommand[]{\mathindent}
+\eqcommand[]{\mathit}
+\eqcommand[]{\mathnormal}
+\eqcommand[]{\mathring}
+\eqcommand[]{\mathrm}
+\eqcommand[]{\mathsf}
+\eqcommand[]{\mathtt}
+\eqcommand[]{\max}
+\eqcommand[]{\mbox}
+\eqcommand[]{\mddefault}
+\eqcommand[]{\mdseries}
+\eqcommand[]{\medskip}
+\eqcommand[]{\medskipamount}
+\eqcommand[]{\medspace}
+\eqcommand[]{\MessageBreak}
+\eqcommand[]{\mho}
+\eqcommand[]{\mid}
+\eqcommand[]{\min}
+\eqcommand[]{\mod}
+\eqcommand[]{\models}
+\eqcommand[]{\mp}
+\eqcommand[]{\mspace}
+\eqcommand[]{\mu}
+\eqcommand[]{\multicolumn}
+\eqcommand[]{\multiput}
+\eqcommand[]{\multlinegap}
+\eqcommand[]{\nabla}
+\eqcommand[]{\name}
+\eqcommand[]{\natural}
+\eqcommand[]{\nearrow}
+\eqcommand[]{\NeedsTeXFormat}
+\eqcommand[]{\neg}
+\eqcommand[]{\negmedspace}
+\eqcommand[]{\negthickspace}
+\eqcommand[]{\negthinspace}
+\eqcommand[]{\neq}
+\eqcommand[]{\newboolean}
+\eqcommand[]{\newcommand}
+\eqcommand[]{\newcommand*}
+\eqcommand[]{\newcounter}
+\eqcommand[]{\newenvironment}
+\eqcommand[]{\newenvironment*}
+\eqcommand[]{\newfont}
+\eqcommand[]{\newlength}
+\eqcommand[]{\newline}
+\eqcommand[]{\newpage}
+\eqcommand[]{\newsavebox}
+\eqcommand[]{\newtheorem}
+\eqcommand[]{\ni}
+\eqcommand[]{\nocite}
+\eqcommand[]{\nofiles}
+\eqcommand[]{\noindent}
+\eqcommand[]{\nolimits}
+\eqcommand[]{\nolinebreak}
+\eqcommand[]{\nonfrenchspacing}
+\eqcommand[]{\nonumber}
+\eqcommand[]{\nopagebreak}
+\eqcommand[]{\normalcolor}
+\eqcommand[]{\normalfont}
+\eqcommand[]{\normalmarginpar}
+\eqcommand[]{\normalsize}
+\eqcommand[]{\not}
+\eqcommand[]{\notag}
+\eqcommand[]{\notin}
+\eqcommand[]{\nu}
+\eqcommand[]{\numberwithin}
+\eqcommand[]{\nwarrow}
+\eqcommand[]{\oddsidemargin}
+\eqcommand[]{\odot}
+\eqcommand[]{\oint}
+\eqcommand[]{\Omega}
+\eqcommand[]{\omega}
+\eqcommand[]{\ominus}
+\eqcommand[]{\onecolumn}
+\eqcommand[]{\onlynotes}
+\eqcommand[]{\onlyslides}
+\eqcommand[]{\opening}
+\eqcommand[]{\oplus}
+\eqcommand[]{\OptionNotUsed}
+\eqcommand[]{\oslash}
+\eqcommand[]{\otimes}
+\eqcommand[]{\oval}
+\eqcommand[]{\ovalbox}
+\eqcommand[]{\Ovalbox}
+\eqcommand[]{\overbrace}
+\eqcommand[]{\overleftarrow}
+\eqcommand[]{\overleftrightarrow}
+\eqcommand[]{\overline}
+\eqcommand[]{\overrightarrow}
+\eqcommand[]{\overset}
+\eqcommand[]{\PackageError}
+\eqcommand[]{\PackageInfo}
+\eqcommand[]{\PackageWarning}
+\eqcommand[]{\PackageWarningNoLine}
+\eqcommand[]{\pagebreak}
+\eqcommand[]{\pagecolor}
+\eqcommand[]{\pagename}
+\eqcommand[]{\pagenumbering}
+\eqcommand[]{\pageref}
+\eqcommand[]{\pagestyle}
+\eqcommand[]{\paperheight}
+\eqcommand[]{\paperwidth}
+\eqcommand[]{\par}
+\eqcommand[]{\paragraph}
+\eqcommand[]{\paragraph*}
+\eqcommand[]{\parallel}
+\eqcommand[]{\parbox}
+\eqcommand[]{\parindent}
+\eqcommand[]{\parsep}
+\eqcommand[]{\parskip}
+\eqcommand[]{\part}
+\eqcommand[]{\part*}
+\eqcommand[]{\partial}
+\eqcommand[]{\partname}
+\eqcommand[]{\partopsep}
+\eqcommand[]{\PassOptionToClass}
+\eqcommand[]{\PassOptionToPackage}
+\eqcommand[]{\path}
+\eqcommand[]{\prep}
+\eqcommand[]{\Phi}
+\eqcommand[]{\phi}
+\eqcommand[]{\Pi}
+\eqcommand[]{\pi}
+\eqcommand[]{\pm}
+\eqcommand[]{\pmb}
+\eqcommand[]{\pmod}
+\eqcommand[]{\pod}
+\eqcommand[]{\poptabs}
+\eqcommand[]{\pounds}
+\eqcommand[]{\Pr}
+\eqcommand[]{\prec}
+\eqcommand[]{\preceq}
+\eqcommand[]{\prime}
+\eqcommand[]{\printindex}
+\eqcommand[]{\ProcessOptions}
+\eqcommand[]{\ProcessOptions*}
+\eqcommand[]{\prod}
+\eqcommand[]{\propto}
+\eqcommand[]{\protect}
+\eqcommand[]{\providecommand}
+\eqcommand[]{\providecommand*}
+\eqcommand[]{\ProvidesClass}
+\eqcommand[]{\ProvidesFile}
+\eqcommand[]{\ProvidesPackage}
+\eqcommand[]{\ps}
+\eqcommand[]{\Psi}
+\eqcommand[]{\psi}
+\eqcommand[]{\pushtabs}
+\eqcommand[]{\put}
+\eqcommand[]{\qbezier}
+\eqcommand[]{\qquad}
+\eqcommand[]{\quad}
+\eqcommand[]{\raggedbottom}
+\eqcommand[]{\raggedleft}
+\eqcommand[]{\raggedright}
+\eqcommand[]{\raisebox}
+\eqcommand[]{\raisetag}
+\eqcommand[]{\rangle}
+\eqcommand[]{\rceil}
+\eqcommand[]{\Re}
+\eqcommand[]{\ref}
+\eqcommand[]{\reflectbox}
+\eqcommand[]{\refname}
+\eqcommand[]{\refstepcounter}
+\eqcommand[]{\renewcommand}
+\eqcommand[]{\renewcommand*}
+\eqcommand[]{\renewenvironment}
+\eqcommand[]{\renewenvironment*}
+\eqcommand[]{\RequirePackage}
+\eqcommand[]{\RequirePackageWithOptions}
+\eqcommand[]{\resizebox}
+\eqcommand[]{\resizebox*}
+\eqcommand[]{\reversemarginpar}
+\eqcommand[]{\rfloor}
+\eqcommand[]{\rhd}
+\eqcommand[]{\rho}
+\eqcommand[]{\right}
+\eqcommand[]{\Rightarrow}
+\eqcommand[]{\rightarrow}
+\eqcommand[]{\rightharpoondown}
+\eqcommand[]{\rightharpoonup}
+\eqcommand[]{\rightleftharpoons}
+\eqcommand[]{\rightmargin}
+\eqcommand[]{\rmdefault}
+\eqcommand[]{\rmfamily}
+\eqcommand[]{\Roman}
+\eqcommand[]{\roman}
+\eqcommand[]{\rotatebox}
+\eqcommand[]{\rule}
+\eqcommand[]{\rvert}
+\eqcommand[]{\rVert}
+\eqcommand[]{\savebox}
+\eqcommand[]{\sbox}
+\eqcommand[]{\scalebox}
+\eqcommand[]{\scdefault}
+\eqcommand[]{\scriptscriptstyle}
+\eqcommand[]{\scriptsize}
+\eqcommand[]{\scripstyle}
+\eqcommand[]{\scshape}
+\eqcommand[]{\searrow}
+\eqcommand[]{\sec}
+\eqcommand[]{\section}
+\eqcommand[]{\section*}
+\eqcommand[]{\see}
+\eqcommand[]{\seealso}
+\eqcommand[]{\seename}
+\eqcommand[]{\selectfont}
+\eqcommand[]{\setboolean}
+\eqcommand[]{\setcounter}
+\eqcommand[]{\setlength}
+\eqcommand[]{\setminus}
+\eqcommand[]{\settodepth}
+\eqcommand[]{\settoheight}
+\eqcommand[]{\settowidth}
+\eqcommand[]{\sfdefault}
+\eqcommand[]{\sffamily}
+\eqcommand[]{\shadowbox}
+\eqcommand[]{\sharp}
+\eqcommand[]{\shortstack}
+\eqcommand[]{\sideset}
+\eqcommand[]{\Sigma}
+\eqcommand[]{\sigma}
+\eqcommand[]{\signature}
+\eqcommand[]{\sim}
+\eqcommand[]{\simeq}
+\eqcommand[]{\sin}
+\eqcommand[]{\sinh}
+\eqcommand[]{\sldefault}
+\eqcommand[]{\sloppy}
+\eqcommand[]{\slshape}
+\eqcommand[]{\small}
+\eqcommand[]{\smallskip}
+\eqcommand[]{\smallskipamount}
+\eqcommand[]{\smash}
+\eqcommand[]{\smile}
+\eqcommand[]{\spadesuit}
+\eqcommand[]{\sqcap}
+\eqcommand[]{\sqcup}
+\eqcommand[]{\sqrt}
+\eqcommand[]{\sqsubset}
+\eqcommand[]{\sqsubseteq}
+\eqcommand[]{\sqsupset}
+\eqcommand[]{\sqsupseteq}
+\eqcommand[]{\stackrel}
+\eqcommand[]{\star}
+\eqcommand[]{\stepcounter}
+\eqcommand[]{\stretch}
+\eqcommand[]{\subitem}
+\eqcommand[]{\subparagraph}
+\eqcommand[]{\subparagraph*}
+\eqcommand[]{\subsection}
+\eqcommand[]{\subsection*}
+\eqcommand[]{\substack}
+\eqcommand[]{\subsubitem}
+\eqcommand[]{\subsubsection}
+\eqcommand[]{\subsubsection*}
+\eqcommand[]{\subset}
+\eqcommand[]{\subseteq}
+\eqcommand[]{\succ}
+\eqcommand[]{\succeq}
+\eqcommand[]{\sum}
+\eqcommand[]{\sup}
+\eqcommand[]{\supressfloats}
+\eqcommand[]{\supset}
+\eqcommand[]{\supseteq}
+\eqcommand[]{\surd}
+\eqcommand[]{\swarrow}
+\eqcommand[]{\tabbingsep}
+\eqcommand[]{\tabcolsep}
+\eqcommand[]{\tableofcontents}
+\eqcommand[]{\tablename}
+\eqcommand[]{\tabularnewline}
+\eqcommand[]{\tag}
+\eqcommand[]{\tan}
+\eqcommand[]{\tanh}
+\eqcommand[]{\tau}
+\eqcommand[]{\tbinom}
+\eqcommand[]{\telephone}
+\eqcommand[]{\TeX}
+\eqcommand[]{\text}
+\eqcommand[]{\textbullet}
+\eqcommand[]{\textemdash}
+\eqcommand[]{\textendash}
+\eqcommand[]{\textexclamdown}
+\eqcommand[]{\textperiodcentered}
+\eqcommand[]{\textquestiondown}
+\eqcommand[]{\textquotedblleft}
+\eqcommand[]{\textquotedblright}
+\eqcommand[]{\textquoteleft}
+\eqcommand[]{\textquoteright}
+\eqcommand[]{\textvisiblespace}
+\eqcommand[]{\textasciicircum}
+\eqcommand[]{\textasciitilde}
+\eqcommand[]{\textbackslash}
+\eqcommand[]{\textbar}
+\eqcommand[]{\textgreater}
+\eqcommand[]{\textless}
+\eqcommand[]{\textbf}
+\eqcommand[]{\textcircled}
+\eqcommand[]{\textcolor}
+\eqcommand[]{\textcompwordmark}
+\eqcommand[]{\textfloatsep}
+\eqcommand[]{\textfraction}
+\eqcommand[]{\textheight}
+\eqcommand[]{\textit}
+\eqcommand[]{\textmd}
+\eqcommand[]{\textnormal}
+\eqcommand[]{\textregistered}
+\eqcommand[]{\textrm}
+\eqcommand[]{\textsc}
+\eqcommand[]{\textsf}
+\eqcommand[]{\textsl}
+\eqcommand[]{\textstyle}
+\eqcommand[]{\textsuperscript}
+\eqcommand[]{\texttrademark}
+\eqcommand[]{\texttt}
+\eqcommand[]{\textup}
+\eqcommand[]{\textwidth}
+\eqcommand[]{\tfrac}
+\eqcommand[]{\thanks}
+\eqcommand[]{\Theta}
+\eqcommand[]{\theta}
+\eqcommand[]{\thicklines}
+\eqcommand[]{\thickspace}
+\eqcommand[]{\thinlines}
+\eqcommand[]{\thinspace}
+\eqcommand[]{\thisfancypage}
+\eqcommand[]{\thispagestyle}
+\eqcommand[]{\tilde}
+\eqcommand[]{\tiny}
+\eqcommand[]{\times}
+\eqcommand[]{\title}
+\eqcommand[]{\to}
+\eqcommand[]{\today}
+\eqcommand[]{\top}
+\eqcommand[]{\topfigrule}
+\eqcommand[]{\topfraction}
+\eqcommand[]{\topmargin}
+\eqcommand[]{\topsep}
+\eqcommand[]{\topskip}
+\eqcommand[]{\totalheight}
+\eqcommand[]{\triangle}
+\eqcommand[]{\triangleleft}
+\eqcommand[]{\triangleright}
+\eqcommand[]{\ttdefault}
+\eqcommand[]{\ttfamily}
+\eqcommand[]{\twocolumn}
+\eqcommand[]{\typein}
+\eqcommand[]{\typeout}
+\eqcommand[]{\unboldmath}
+\eqcommand[]{\underbrace}
+\eqcommand[]{\underleftarrow}
+\eqcommand[]{\underleftrightarrow}
+\eqcommand[]{\underline}
+\eqcommand[]{\underrightarrow}
+\eqcommand[]{\underset}
+\eqcommand[]{\unitlength}
+\eqcommand[]{\unlhd}
+\eqcommand[]{\unrhd}
+\eqcommand[]{\Uparrow}
+\eqcommand[]{\uparrow}
+\eqcommand[]{\updefault}
+\eqcommand[]{\Updownarrow}
+\eqcommand[]{\updownarrow}
+\eqcommand[]{\uplus}
+\eqcommand[]{\upshape}
+\eqcommand[]{\Upsilon}
+\eqcommand[]{\upsilon}
+\eqcommand[]{\uproot}
+\eqcommand[]{\url}
+\eqcommand[]{\urlstyle}
+\eqcommand[]{\usebox}
+\eqcommand[]{\usecounter}
+\eqcommand[]{\usefont}
+\eqcommand[]{\usepackage}
+\eqcommand[]{\value}
+\eqcommand[]{\varepsilon}
+\eqcommand[]{\varinjlim}
+\eqcommand[]{\varliminf}
+\eqcommand[]{\varlimsup}
+\eqcommand[]{\varphi}
+\eqcommand[]{\varpi}
+\eqcommand[]{\varprojlim}
+\eqcommand[]{\varrho}
+\eqcommand[]{\varsigma}
+\eqcommand[]{\vartheta}
+\eqcommand[]{\vdash}
+\eqcommand[]{\vdots}
+\eqcommand[]{\vec}
+\eqcommand[]{\vector}
+\eqcommand[]{\vee}
+\eqcommand[]{\verb}
+\eqcommand[]{\verb*}
+\eqcommand[]{\vfill}
+\eqcommand[]{\visible}
+\eqcommand[]{\vline}
+\eqcommand[]{\voffset}
+\eqcommand[]{\vpageref}
+\eqcommand[]{\vref}
+\eqcommand[]{\vspace}
+\eqcommand[]{\vspace*}
+\eqcommand[]{\wedge}
+\eqcommand[]{\whiledo}
+\eqcommand[]{\widehat}
+\eqcommand[]{\widetilde}
+\eqcommand[]{\width}
+\eqcommand[]{\wp}
+\eqcommand[]{\wr}
+\eqcommand[]{\Xi}
+\eqcommand[]{\xi}
+\eqcommand[]{\xleftarrow}
+\eqcommand[]{\xrightarrow}
+\eqcommand[]{\zeta}
+%% 
+%% Copyright ?? 2008-2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `commands-ltx.def'.

Added: tags/texmf/tex/xelatex/xepersian/commands-xepersian.def
===================================================================
--- tags/texmf/tex/xelatex/xepersian/commands-xepersian.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/xepersian/commands-xepersian.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,30 @@
+%%
+%% This is file `commands-xepersian.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% xepersian.dtx  (with options: `commands-xepersian.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2008-2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+
+%% 
+%% Copyright ?? 2008-2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `commands-xepersian.def'.

Added: tags/texmf/tex/xelatex/xepersian/enumerate-xepersian.def
===================================================================
--- tags/texmf/tex/xelatex/xepersian/enumerate-xepersian.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/xepersian/enumerate-xepersian.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,45 @@
+%%
+%% This is file `enumerate-xepersian.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% xepersian.dtx  (with options: `enumerate-xepersian.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2008-2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\def\@enloop@{%
+  \ifx ??\@entemp         \def\@tempa{\@enLabel\harfi  }\else
+  \ifx ??\@entemp         \def\@tempa{\@enLabel\adadi  }\else
+  \ifx ??\@entemp         \def\@tempa{\@enLabel\tartibi  }\else
+  \ifx A\@entemp         \def\@tempa{\@enLabel\Alph  }\else
+  \ifx a\@entemp         \def\@tempa{\@enLabel\alph  }\else
+  \ifx i\@entemp         \def\@tempa{\@enLabel\roman }\else
+  \ifx I\@entemp         \def\@tempa{\@enLabel\Roman }\else
+  \ifx 1\@entemp         \def\@tempa{\@enLabel\arabic}\else
+  \ifx \@sptoken\@entemp \let\@tempa\@enSpace         \else
+  \ifx \bgroup\@entemp   \let\@tempa\@enGroup         \else
+  \ifx \@enum@\@entemp   \let\@tempa\@gobble          \else
+                         \let\@tempa\@enOther
+                         \@enhook
+             \fi\fi\fi\fi\fi\fi\fi\fi\fi\fi\fi
+  \@tempa}
+%% 
+%% Copyright ?? 2008-2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `enumerate-xepersian.def'.

Added: tags/texmf/tex/xelatex/xepersian/environments-ltx.def
===================================================================
--- tags/texmf/tex/xelatex/xepersian/environments-ltx.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/xepersian/environments-ltx.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,91 @@
+%%
+%% This is file `environments-ltx.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% xepersian.dtx  (with options: `environments-ltx.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2008-2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\eqenvironment[]{abstract}
+\eqenvironment[]{align}
+\eqenvironment[]{alignat}
+\eqenvironment[]{aligned}
+\eqenvironment[]{appendix}
+\eqenvironment[]{array}
+\eqenvironment[]{center}
+\eqenvironment[]{alltt}
+\eqenvironment[]{bmatrix}
+\eqenvironment[]{Bmatrix}
+\eqenvironment[]{cases}
+\eqenvironment[]{description}
+\eqenvironment[]{displaymath}
+\eqenvironment[]{enumerate}
+\eqenvironment[]{eqnarray}
+\eqenvironment[]{eqnarray*}
+\eqenvironment[]{equation}
+\eqenvironment[]{equation*}
+\eqenvironment[]{falign}
+\eqenvironment[]{figure}
+\eqenvironment[]{figure*}
+\eqenvironment[]{filecontents}
+\eqenvironment[]{filecontents*}
+\eqenvironment[]{flushleft}
+\eqenvironment[]{flushright}
+\eqenvironment[]{gather}
+\eqenvironment[]{gathered}
+\eqenvironment[]{itemize}
+\eqenvironment[]{letter}
+\eqenvironment[]{list}
+\eqenvironment[]{longtable}
+\eqenvironment[]{lrbox}
+\eqenvironment[]{math}
+\eqenvironment[]{matrix}
+\eqenvironment[]{minipage}
+\eqenvironment[]{multicols}
+\eqenvironment[]{multline}
+\eqenvironment[]{note}
+\eqenvironment[]{overlay}
+\eqenvironment[]{picture}
+\eqenvironment[]{pmatrix}
+\eqenvironment[]{quotation}
+\eqenvironment[]{quote}
+\eqenvironment[]{slide}
+\eqenvironment[]{sloppypar}
+\eqenvironment[]{split}
+\eqenvironment[]{subarray}
+\eqenvironment[]{subequations}
+\eqenvironment[]{tabbing}
+\eqenvironment[]{table}
+\eqenvironment[]{table*}
+\eqenvironment[]{tabular}
+\eqenvironment[]{tabular*}
+\eqenvironment[]{thebibliography}
+\eqenvironment[]{theindex}
+\eqenvironment[]{titlepage}
+\eqenvironment[]{trivlist}
+\eqenvironment[]{verbatim}
+\eqenvironment[]{verbatim*}
+\eqenvironment[]{verse}
+\eqenvironment[]{vmatrix}
+\eqenvironment[]{Vmatrix}
+%% 
+%% Copyright ?? 2008-2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `environments-ltx.def'.

Added: tags/texmf/tex/xelatex/xepersian/environments-xepersian.def
===================================================================
--- tags/texmf/tex/xelatex/xepersian/environments-xepersian.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/xepersian/environments-xepersian.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,30 @@
+%%
+%% This is file `environments-xepersian.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% xepersian.dtx  (with options: `environments-xepersian.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2008-2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+
+%% 
+%% Copyright ?? 2008-2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `environments-xepersian.def'.

Added: tags/texmf/tex/xelatex/xepersian/extbook-xepersian.def
===================================================================
--- tags/texmf/tex/xelatex/xepersian/extbook-xepersian.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/xepersian/extbook-xepersian.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,44 @@
+%%
+%% This is file `extbook-xepersian.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% xepersian.dtx  (with options: `extbook-xepersian.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2008-2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\renewcommand\frontmatter{%
+    \cleardoublepage
+  \@mainmatterfalse
+  \pagenumbering{harfi}}
+\renewcommand\mainmatter{%
+    \cleardoublepage
+  \@mainmattertrue
+  \pagenumbering{arabic}}
+\renewcommand \thepart {\@tartibi\c at part}
+\renewcommand\appendix{\par
+  \setcounter{chapter}{0}%
+  \setcounter{section}{0}%
+  \gdef\@chapapp{\appendixname}%
+  \gdef\thechapter{\@harfi\c at chapter}
+}%end appendix
+%% 
+%% Copyright ?? 2008-2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `extbook-xepersian.def'.

Added: tags/texmf/tex/xelatex/xepersian/footnote-bidi-xepersian.def
===================================================================
--- tags/texmf/tex/xelatex/xepersian/footnote-bidi-xepersian.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/xepersian/footnote-bidi-xepersian.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,113 @@
+%%
+%% This is file `footnote-bidi-xepersian.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% xepersian.dtx  (with options: `footnote-bidi-xepersian.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2008-2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\long\def\@footnotetext#1{%
+    \begingroup
+    \setbox\footins
+    \vbox{\if at RTL@footnote\@RTLtrue\else\@RTLfalse\fi\reset at font\footnotesize
+    \interlinepenalty\interfootnotelinepenalty
+    \splittopskip\footnotesep
+    \splitmaxdepth \dp\strutbox \floatingpenalty \@MM
+    \hsize\columnwidth \@parboxrestore
+    \bidi at footnotetext@dir{#1}%
+    \protected at edef\@currentlabel{\csname p at footnote\endcsname\@thefnmark}\@makefntext
+    {\rule{\z@}{\footnotesep}\ignorespaces\if at RTL@footnote#1\else\latinfont#1\fi\strut}}%
+     \bidi at footnotetext@after
+    \insert\footins{\unvbox\footins}%
+    \endgroup}
+\long\def\@RTLfootnotetext#1{%
+    \begingroup
+    \setbox\footins
+    \vbox{\@RTLtrue\reset at font\footnotesize
+    \interlinepenalty\interfootnotelinepenalty
+    \splittopskip\footnotesep
+    \splitmaxdepth \dp\strutbox \floatingpenalty \@MM
+    \hsize\columnwidth \@parboxrestore
+    \bidi at footnotetext@dir{#1}%
+    \protected at edef\@currentlabel{\csname p at footnote\endcsname\@thefnmark}\@makefntext
+    {\rule{\z@}{\footnotesep}\ignorespaces\persianfont #1\strut}}%
+     \bidi at footnotetext@after
+    \insert\footins{\unvbox\footins}%
+    \endgroup}
+\long\def\@LTRfootnotetext#1{%
+    \begingroup
+    \setbox\footins
+    \vbox{\@RTLfalse\reset at font\footnotesize
+    \interlinepenalty\interfootnotelinepenalty
+    \splittopskip\footnotesep
+    \splitmaxdepth \dp\strutbox \floatingpenalty \@MM
+    \hsize\columnwidth \@parboxrestore
+    \bidi at footnotetext@dir{#1}%
+    \protected at edef\@currentlabel{\csname p at footnote\endcsname\@thefnmark}\@makefntext
+    {\rule{\z@}{\footnotesep}\ignorespaces\latinfont #1\strut}}%
+     \bidi at footnotetext@after
+    \insert\footins{\unvbox\footins}%
+    \endgroup}
+\long\def\@mpfootnotetext#1{
+  \global\setbox\@mpfootins\vbox{\if at RTL@footnote\@RTLtrue\else\@RTLfalse\fi
+    \unvbox\@mpfootins
+    \reset at font\footnotesize
+    \hsize\columnwidth
+    \@parboxrestore
+    \protected at edef\@currentlabel
+         {\csname p at mpfootnote\endcsname\@thefnmark}
+    \color at begingroup
+     \bidi at footnotetext@dir{#1}
+    \if at RTL\global\let\bidi at footnoterule\right at footnote\else\global\let\bidi at footnoterule\left at footnote\fi
+      \@makefntext{
+        \rule\z@\footnotesep\ignorespaces\if at RTL@footnote#1\else\latinfont#1\fi\@finalstrut\strutbox}
+    \color at endgroup}}
+\long\def\@mpRTLfootnotetext#1{
+  \global\setbox\@mpfootins\vbox{\@RTLtrue
+    \unvbox\@mpfootins
+    \reset at font\footnotesize
+    \hsize\columnwidth
+    \@parboxrestore
+    \protected at edef\@currentlabel
+         {\csname p at mpfootnote\endcsname\@thefnmark}
+    \color at begingroup
+     \bidi at footnotetext@dir{#1}
+    \if at RTL\global\let\bidi at footnoterule\right at footnote\else\global\let\bidi at footnoterule\left at footnote\fi
+      \@makefntext{
+        \rule\z@\footnotesep\ignorespaces\persianfont#1\@finalstrut\strutbox}
+    \color at endgroup}}
+\long\def\@mpLTRfootnotetext#1{
+  \global\setbox\@mpfootins\vbox{\@RTLfalse
+    \unvbox\@mpfootins
+    \reset at font\footnotesize
+    \hsize\columnwidth
+    \@parboxrestore
+    \protected at edef\@currentlabel
+         {\csname p at mpfootnote\endcsname\@thefnmark}
+    \color at begingroup
+     \bidi at footnotetext@dir{#1}
+    \if at RTL\global\let\bidi at footnoterule\right at footnote\else\global\let\bidi at footnoterule\left at footnote\fi
+      \@makefntext{
+        \rule\z@\footnotesep\ignorespaces\latinfont#1\@finalstrut\strutbox}
+    \color at endgroup}}
+%% 
+%% Copyright ?? 2008-2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `footnote-bidi-xepersian.def'.

Added: tags/texmf/tex/xelatex/xepersian/img/ireland.jpg
===================================================================
(Binary files differ)


Property changes on: tags/texmf/tex/xelatex/xepersian/img/ireland.jpg
___________________________________________________________________
Name: svn:executable
   + *
Name: svn:mime-type
   + application/octet-stream

Added: tags/texmf/tex/xelatex/xepersian/img/weather/clouds.jpg
===================================================================
(Binary files differ)


Property changes on: tags/texmf/tex/xelatex/xepersian/img/weather/clouds.jpg
___________________________________________________________________
Name: svn:executable
   + *
Name: svn:mime-type
   + application/octet-stream

Added: tags/texmf/tex/xelatex/xepersian/img/weather/rain.jpg
===================================================================
(Binary files differ)


Property changes on: tags/texmf/tex/xelatex/xepersian/img/weather/rain.jpg
___________________________________________________________________
Name: svn:executable
   + *
Name: svn:mime-type
   + application/octet-stream

Added: tags/texmf/tex/xelatex/xepersian/img/weather/sun.jpg
===================================================================
(Binary files differ)


Property changes on: tags/texmf/tex/xelatex/xepersian/img/weather/sun.jpg
___________________________________________________________________
Name: svn:executable
   + *
Name: svn:mime-type
   + application/octet-stream

Added: tags/texmf/tex/xelatex/xepersian/kashida-xepersian.def
===================================================================
--- tags/texmf/tex/xelatex/xepersian/kashida-xepersian.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/xepersian/kashida-xepersian.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,70 @@
+%%
+%% This is file `kashida-xepersian.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% xepersian.dtx  (with options: `kashida-xepersian.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2008-2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\chardef\zwj="200D % zero-width joiner
+\chardef\ksh="0640 % kashida
+
+\chardef\D=10 % dual-joiner class
+\chardef\L=11 % lam
+\chardef\R=12 % right-joiner
+\chardef\A=13 % alef
+\chardef\V=256 % vowel or other combining mark (to be ignored)
+
+\def\kashida{\zwj\nobreak \setbox0=\hbox{\ksh}%
+    \leaders\hrule height\ht0 \hskip0pt plus 0.5em \zwj}
+
+\def\setclass#1#2{\def\theclass{#1}\def\charlist{#2}%
+  \expandafter\dosetclass\charlist,\end}
+\def\dosetclass#1,#2\end{%
+  \def\test{#1}\def\charlist{#2}%
+  \ifx\test\empty\let\next\finishsetclass
+  \else \XeTeXcharclass "\test = \theclass
+     \let\next\dosetclass \fi
+  \expandafter\next\charlist,,\end}
+\def\finishsetclass#1,,\end{}
+
+\setclass \A {0622,0623,0625,0627}
+\setclass \R {0624,0629,062F,0630,0631,0632,0648,0698}
+\setclass \D {0626,0628,062A,062B,062C,062D,062E}
+\setclass \D {0633,0634,0635,0636,0637,0638,0639,063A}
+\setclass \D {0640,0641,0642,0643,0645,0646,0647,0649,064A}
+\setclass \D {067E,0686,06A9,06AF,06CC}
+\setclass \L {0644}
+\setclass \V {064B,064C,064D,064E,064F,0650,0651,0652}
+
+\XeTeXinterchartoks \D \D = {\kashida}
+\XeTeXinterchartoks \L \D = {\kashida}
+\XeTeXinterchartoks \D \L = {\kashida}
+\XeTeXinterchartoks \L \L = {\kashida}
+\XeTeXinterchartoks \D \R = {\kashida}
+\XeTeXinterchartoks \D \A = {\kashida}
+\XeTeXinterchartoks \L \R = {\kashida}
+\XeTeXinterchartoks \L \A = {}
+
+\XeTeXinterchartokenstate=1
+%% 
+%% Copyright ?? 2008-2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `kashida-xepersian.def'.

Added: tags/texmf/tex/xelatex/xepersian/listings-xepersian.def
===================================================================
--- tags/texmf/tex/xelatex/xepersian/listings-xepersian.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/xepersian/listings-xepersian.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,31 @@
+%%
+%% This is file `listings-xepersian.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% xepersian.dtx  (with options: `listings-xepersian.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2008-2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\def\lstlistingname{??????????????}
+\def\lstlistlistingname{?????????? ???????????????????}
+%% 
+%% Copyright ?? 2008-2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `listings-xepersian.def'.

Added: tags/texmf/tex/xelatex/xepersian/localise-xepersian.def
===================================================================
--- tags/texmf/tex/xelatex/xepersian/localise-xepersian.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/xepersian/localise-xepersian.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,53 @@
+%%
+%% This is file `localise-xepersian.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% xepersian.dtx  (with options: `localise-xepersian.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2008-2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\catcode`\???=3
+\catcode`???=11
+\newcommand\eqcommand[2][]{\let#1=#2}
+\newcommand\eqenvironment[2][]{\newenvironment{#1}{\begin{#2}}{\end{#2}}}
+\define at key[zf]{options}{??????????}{%
+  \edef\@tempa{#1}%
+  \edef\@tempb{MatchLowercase}%
+  \ifx\@tempa\@tempb
+    \zf at calc@scale{5}%
+  \else
+    \edef\@tempb{MatchUppercase}%
+    \ifx\@tempa\@tempb
+      \zf at calc@scale{8}%
+    \else
+      \edef\zf at scale{#1}%
+    \fi
+  \fi
+  \zf at update@family{+scale:\zf at scale}%
+  \edef\zf at scale{s*[\zf at scale]}}
+\input{commands-ltx.def}
+\input{commands-xepersian.def}
+\input{environments-ltx.def}
+\input{environments-xepersian.def}
+\input{misccommandsenvironments-ltx.def}
+%% 
+%% Copyright ?? 2008-2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `localise-xepersian.def'.

Added: tags/texmf/tex/xelatex/xepersian/minitoc-xepersian.def
===================================================================
--- tags/texmf/tex/xelatex/xepersian/minitoc-xepersian.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/xepersian/minitoc-xepersian.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,38 @@
+%%
+%% This is file `minitoc-xepersian.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% xepersian.dtx  (with options: `minitoc-xepersian.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2008-2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\def\ptctitle{\if at RTL ?????????? ??????????\else Table of Contents\fi}%
+\def\plftitle{\if at RTL ???????? ????????????\else List of Figures\fi}%
+\def\plttitle{\if at RTL ???????? ??????????\else List of Tables\fi}%
+\def\mtctitle{\if at RTL ????????????\else Contents\fi}%
+\def\mlftitle{\if at RTL ??????????\else Figures\fi}%
+\def\mlttitle{\if at RTL ??????????\else Tables\fi}%
+\def\stctitle{\if at RTL ????????????\else Contents\fi}%
+\def\slftitle{\if at RTL ??????????\else Figures\fi}%
+\def\slttitle{\if at RTL ??????????\else Tables\fi}%
+%% 
+%% Copyright ?? 2008-2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `minitoc-xepersian.def'.

Added: tags/texmf/tex/xelatex/xepersian/misccommandsenvironments-ltx.def
===================================================================
--- tags/texmf/tex/xelatex/xepersian/misccommandsenvironments-ltx.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/xepersian/misccommandsenvironments-ltx.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,31 @@
+%%
+%% This is file `misccommandsenvironments-ltx.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% xepersian.dtx  (with options: `misccommandsenvironments-ltx.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2008-2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\eqcommand[\??????]{\document}
+\eqcommand[\end??????]{\enddocument}
+%% 
+%% Copyright ?? 2008-2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `misccommandsenvironments-ltx.def'.

Added: tags/texmf/tex/xelatex/xepersian/rapport3-xepersian.def
===================================================================
--- tags/texmf/tex/xelatex/xepersian/rapport3-xepersian.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/xepersian/rapport3-xepersian.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,35 @@
+%%
+%% This is file `rapport3-xepersian.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% xepersian.dtx  (with options: `rapport3-xepersian.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2008-2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\renewcommand*\thepart{\@tartibi\c at part}
+\renewcommand*\appendix{\par
+  \setcounter{chapter}{0}%
+  \setcounter{section}{0}%
+  \gdef\@chapapp{\appendixname}%
+  \gdef\thechapter{\@harfi\c at chapter}}
+%% 
+%% Copyright ?? 2008-2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `rapport3-xepersian.def'.

Added: tags/texmf/tex/xelatex/xepersian/refrep-xepersian.def
===================================================================
--- tags/texmf/tex/xelatex/xepersian/refrep-xepersian.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/xepersian/refrep-xepersian.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,36 @@
+%%
+%% This is file `refrep-xepersian.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% xepersian.dtx  (with options: `refrep-xepersian.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2008-2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\renewcommand \thepart {\@tartibi\c at part}
+\renewcommand\appendix{\par
+  \setcounter{chapter}{0}%
+  \setcounter{section}{0}%
+  \gdef\@chapapp{\appendixname}%
+  \gdef\thechapter{\@harfi\c at chapter}
+}%end appendix
+%% 
+%% Copyright ?? 2008-2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `refrep-xepersian.def'.

Added: tags/texmf/tex/xelatex/xepersian/report-xepersian.def
===================================================================
--- tags/texmf/tex/xelatex/xepersian/report-xepersian.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/xepersian/report-xepersian.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,36 @@
+%%
+%% This is file `report-xepersian.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% xepersian.dtx  (with options: `report-xepersian.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2008-2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\renewcommand \thepart {\@tartibi\c at part}
+\renewcommand\appendix{\par
+  \setcounter{chapter}{0}%
+  \setcounter{section}{0}%
+  \gdef\@chapapp{\appendixname}%
+  \gdef\thechapter{\@harfi\c at chapter}
+}%end appendix
+%% 
+%% Copyright ?? 2008-2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `report-xepersian.def'.

Added: tags/texmf/tex/xelatex/xepersian/scrartcl-xepersian.def
===================================================================
--- tags/texmf/tex/xelatex/xepersian/scrartcl-xepersian.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/xepersian/scrartcl-xepersian.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,64 @@
+%%
+%% This is file `scrartcl-xepersian.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% xepersian.dtx  (with options: `scrartcl-xepersian.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2008-2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\renewcommand*\descfont{\if at RTL\persiansffamily\else\sffamily\fi\bfseries}
+\DeclareOldFontCommand{\sf}{\normalfont\if at RTL\persiansffamily\else\sffamily\fi}{\mathsf}
+\DeclareOldFontCommand{\tt}{\normalfont\if at RTL\persianttfamily\else\ttfamily\fi}{\mathtt}
+\DeclareOldFontCommand{\sfb}{\normalfont\if at RTL\persiansffamily\else\sffamily\fi\bfseries}{%
+  \@nomath\sfb}
+\renewcommand*\sectfont{\normalcolor\if at RTL\persiansffamily\else\sffamily\fi\bfseries}
+\newkomafont{dictum-xepersian}{\normalfont\normalcolor\if at RTL\persiansffamily\else\sffamily\fi\small}
+\renewcommand*{\thepart}{\@tartibi\c at part}
+\renewcommand*\appendix{\par%
+  \setcounter{section}{0}%
+  \setcounter{subsection}{0}%
+  \gdef\thesection{\@harfi\c at section}%
+  \csname appendixmore\endcsname
+}
+\renewcommand*{\@@maybeautodot}[1]{%
+  \ifx #1\@stop\let\@@maybeautodot\relax
+  \else
+    \ifx #1\harfi \@autodottrue\fi
+    \ifx #1\adadi \@autodottrue\fi
+    \ifx #1\tartibi \@autodottrue\fi
+    \ifx #1\Alph \@autodottrue\fi
+    \ifx #1\alph \@autodottrue\fi
+    \ifx #1\Roman \@autodottrue\fi
+    \ifx #1\roman \@autodottrue\fi
+    \ifx #1\@harfi \@autodottrue\fi
+    \ifx #1\@adadi \@autodottrue\fi
+    \ifx #1\@tartibi \@autodottrue\fi
+    \ifx #1\@Alph \@autodottrue\fi
+    \ifx #1\@alph \@autodottrue\fi
+    \ifx #1\@Roman \@autodottrue\fi
+    \ifx #1\@roman \@autodottrue\fi
+    \ifx #1\romannumeral \@autodottrue\fi
+  \fi
+  \@@maybeautodot
+}
+%% 
+%% Copyright ?? 2008-2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `scrartcl-xepersian.def'.

Added: tags/texmf/tex/xelatex/xepersian/scrbook-xepersian.def
===================================================================
--- tags/texmf/tex/xelatex/xepersian/scrbook-xepersian.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/xepersian/scrbook-xepersian.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,69 @@
+%%
+%% This is file `scrbook-xepersian.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% xepersian.dtx  (with options: `scrbook-xepersian.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2008-2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\renewcommand*\descfont{\if at RTL\persiansffamily\else\sffamily\fi\bfseries}
+\DeclareOldFontCommand{\sf}{\normalfont\if at RTL\persiansffamily\else\sffamily\fi}{\mathsf}
+\DeclareOldFontCommand{\tt}{\normalfont\if at RTL\persianttfamily\else\ttfamily\fi}{\mathtt}
+\DeclareOldFontCommand{\sfb}{\normalfont\if at RTL\persiansffamily\else\sffamily\fi\bfseries}{%
+  \@nomath\sfb}
+\renewcommand*\sectfont{\normalcolor\if at RTL\persiansffamily\else\sffamily\fi\bfseries}
+\newkomafont{dictum-xepersian}{\normalfont\normalcolor\if at RTL\persiansffamily\else\sffamily\fi\small}
+\renewcommand*\frontmatter{%
+  \if at twoside\cleardoubleoddpage\else\clearpage\fi
+  \@mainmatterfalse\pagenumbering{harfi}%
+}
+\renewcommand*{\thepart}{\@tartibi\c at part}
+\renewcommand*\appendix{\par%
+  \setcounter{chapter}{0}%
+  \setcounter{section}{0}%
+  \gdef\@chapapp{\appendixname}%
+  \gdef\thechapter{\@harfi\c at chapter}%
+  \csname appendixmore\endcsname
+}
+\renewcommand*{\@@maybeautodot}[1]{%
+  \ifx #1\@stop\let\@@maybeautodot\relax
+  \else
+    \ifx #1\harfi \@autodottrue\fi
+    \ifx #1\adadi \@autodottrue\fi
+    \ifx #1\tartibi \@autodottrue\fi
+    \ifx #1\Alph \@autodottrue\fi
+    \ifx #1\alph \@autodottrue\fi
+    \ifx #1\Roman \@autodottrue\fi
+    \ifx #1\roman \@autodottrue\fi
+    \ifx #1\@harfi \@autodottrue\fi
+    \ifx #1\@adadi \@autodottrue\fi
+    \ifx #1\@tartibi \@autodottrue\fi
+    \ifx #1\@Alph \@autodottrue\fi
+    \ifx #1\@alph \@autodottrue\fi
+    \ifx #1\@Roman \@autodottrue\fi
+    \ifx #1\@roman \@autodottrue\fi
+    \ifx #1\romannumeral \@autodottrue\fi
+  \fi
+  \@@maybeautodot
+}
+%% 
+%% Copyright ?? 2008-2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `scrbook-xepersian.def'.

Added: tags/texmf/tex/xelatex/xepersian/scrreprt-xepersian.def
===================================================================
--- tags/texmf/tex/xelatex/xepersian/scrreprt-xepersian.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/xepersian/scrreprt-xepersian.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,65 @@
+%%
+%% This is file `scrreprt-xepersian.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% xepersian.dtx  (with options: `scrreprt-xepersian.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2008-2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\renewcommand*\descfont{\if at RTL\persiansffamily\else\sffamily\fi\bfseries}
+\DeclareOldFontCommand{\sf}{\normalfont\if at RTL\persiansffamily\else\sffamily\fi}{\mathsf}
+\DeclareOldFontCommand{\tt}{\normalfont\if at RTL\persianttfamily\else\ttfamily\fi}{\mathtt}
+\DeclareOldFontCommand{\sfb}{\normalfont\if at RTL\persiansffamily\else\sffamily\fi\bfseries}{%
+  \@nomath\sfb}
+\renewcommand*\sectfont{\normalcolor\if at RTL\persiansffamily\else\sffamily\fi\bfseries}
+\newkomafont{dictum-xepersian}{\normalfont\normalcolor\if at RTL\persiansffamily\else\sffamily\fi\small}
+\renewcommand*{\thepart}{\@tartibi\c at part}
+\renewcommand*\appendix{\par%
+  \setcounter{chapter}{0}%
+  \setcounter{section}{0}%
+  \gdef\@chapapp{\appendixname}%
+  \gdef\thechapter{\@harfi\c at chapter}%
+  \csname appendixmore\endcsname
+}
+\renewcommand*{\@@maybeautodot}[1]{%
+  \ifx #1\@stop\let\@@maybeautodot\relax
+  \else
+    \ifx #1\harfi \@autodottrue\fi
+    \ifx #1\adadi \@autodottrue\fi
+    \ifx #1\tartibi \@autodottrue\fi
+    \ifx #1\Alph \@autodottrue\fi
+    \ifx #1\alph \@autodottrue\fi
+    \ifx #1\Roman \@autodottrue\fi
+    \ifx #1\roman \@autodottrue\fi
+    \ifx #1\@harfi \@autodottrue\fi
+    \ifx #1\@adadi \@autodottrue\fi
+    \ifx #1\@tartibi \@autodottrue\fi
+    \ifx #1\@Alph \@autodottrue\fi
+    \ifx #1\@alph \@autodottrue\fi
+    \ifx #1\@Roman \@autodottrue\fi
+    \ifx #1\@roman \@autodottrue\fi
+    \ifx #1\romannumeral \@autodottrue\fi
+  \fi
+  \@@maybeautodot
+}
+%% 
+%% Copyright ?? 2008-2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `scrreprt-xepersian.def'.

Added: tags/texmf/tex/xelatex/xepersian/tocloft-xepersian.def
===================================================================
--- tags/texmf/tex/xelatex/xepersian/tocloft-xepersian.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/xepersian/tocloft-xepersian.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,39 @@
+%%
+%% This is file `tocloft-xepersian.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% xepersian.dtx  (with options: `tocloft-xepersian.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2008-2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\renewcommand*{\cftchapname}{\if at RTL ??????\else chapter\fi}
+\renewcommand*{\cftsecname}{\if at RTL ????????\else section\fi}
+\renewcommand*{\cftsubsecname}{\if at RTL ??????????????\else subsection\fi}
+\renewcommand*{\cftsubsubsecname}{\if at RTL ????????????????????\else subsubsection\fi}
+\renewcommand*{\cftparaname}{\if at RTL ????????????????\else paragraph\fi}
+\renewcommand*{\cftsubparaname}{\if at RTL ??????????????????????\else subparagraph\fi}
+\renewcommand*{\cftfigname}{\if at RTL ??????\else figure\fi}
+\renewcommand*{\cftsubfigname}{\if at RTL ????????????\else subfigure\fi}
+\renewcommand*{\cfttabname}{\if at RTL ????????\else table\fi}
+\renewcommand*{\cftsubtabname}{\if at RTL ??????????????\else subtable\fi}
+%% 
+%% Copyright ?? 2008-2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `tocloft-xepersian.def'.

Added: tags/texmf/tex/xelatex/xepersian/xepersian-magazine.cls
===================================================================
--- tags/texmf/tex/xelatex/xepersian/xepersian-magazine.cls	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/xepersian/xepersian-magazine.cls	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,898 @@
+%%
+%% This is file `xepersian-magazine.cls',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% xepersian.dtx  (with options: `xepersian-magazine.cls')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2008-2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\NeedsTeXFormat{LaTeX2e}
+\ProvidesClass{xepersian-magazine}[2009/01/05 v0.1 Typesetting Persian magazines in XeLaTeX (Author: Vafa Khalighi)]
+\RequirePackage{ifthen}
+\newlength{\xepersian at imgsize}
+\newlength{\xepersian at coltitsize}
+\newlength{\xepersian at pageneed}
+\newlength{\xepersian at pageleft}
+\newlength{\xepersian at indexwidth}
+\newcommand{\xepersian at ncolumns}{0}
+\newlength{\columnlines}
+\setlength{\columnlines}{0 pt} % no lines by default
+\newboolean{xepersian at hyphenatedtitles}
+\setboolean{xepersian at hyphenatedtitles}{true}
+\newboolean{xepersian at ninepoints}
+\setboolean{xepersian at ninepoints}{false}
+\newboolean{xepersian at showgrid}
+\setboolean{xepersian at showgrid}{false}
+\newboolean{xepersian at a3paper}
+\setboolean{xepersian at a3paper}{false}
+\newboolean{xepersian at insidefrontpage}
+\setboolean{xepersian at insidefrontpage}{false}
+\newboolean{xepersian at insideweather}
+\setboolean{xepersian at insideweather}{false}
+\newboolean{xepersian at insideindex}
+\setboolean{xepersian at insideindex}{false}
+\newcount\xepersian at gridrows
+\newcount\xepersian at gridcolumns
+\xepersian at gridrows=40
+\xepersian at gridcolumns=50
+\newcount\minraggedcols
+\minraggedcols=5
+\DeclareOption{10pt}{\PassOptionsToClass{10pt}{article}}
+\DeclareOption{11pt}{\PassOptionsToClass{11pt}{article}}
+\DeclareOption{12pt}{\PassOptionsToClass{12pt}{article}}
+\DeclareOption{twocolumn}%
+{\ClassWarning{xepersian-magazine}{Option 'twocolumn' not available for xepersian-magazine.}}
+\DeclareOption{notitlepage}%
+{\ClassWarning{xepersian-magazine}{Option 'notitlepage' not available for xepersian-magazine.}}
+\DeclareOption{twoside}%
+{\ClassWarning{xepersian-magazine}{Option 'twoside' not available for xepersian-magazine.}}
+\DeclareOption{9pt}{\setboolean{xepersian at ninepoints}{true}}
+\DeclareOption{hyphenatedtitles}{\setboolean{xepersian at hyphenatedtitles}{false}}
+\DeclareOption{columnlines}{\setlength{\columnlines}{0.1 pt}}
+\DeclareOption{showgrid}{\setboolean{xepersian at showgrid}{true}}
+\DeclareOption{a3paper}{\setboolean{xepersian at a3paper}{true}}
+\ProcessOptions\relax
+\LoadClass[10pt, onecolumn, titlepage, a4paper]{article}
+\RequirePackage{ifxetex}
+\RequirePackage{multido}
+\RequirePackage{datetime}
+\RequirePackage{fmultico}
+\RequirePackage{fancyhdr}
+\RequirePackage{fancybox}
+\ifthenelse{\boolean{xepersian at a3paper}}{%
+\RequirePackage[a3paper,headsep=0.5cm,vmargin={2cm,2cm},hmargin={1.5cm,1.5cm}]{geometry}
+}{
+\RequirePackage[headsep=0.5cm,vmargin={2cm,2cm},hmargin={1.5cm,1.5cm}]{geometry}
+}
+\RequirePackage[absolute]{textpos} % absoulte positioning
+\RequirePackage{hyphenat} % when hyphenate
+\RequirePackage{lastpage} % to know the last page number
+\RequirePackage{setspace} % set space between lines
+\RequirePackage{ragged2e}
+\newcommand{\raggedFormat}{\RaggedLeft}
+\AtEndOfClass{\xepersianInit}
+\ifthenelse{\boolean{xepersian at showgrid}}{%
+\AtBeginDocument{
+\grid[show]{\xepersian at gridrows}{\xepersian at gridcolumns}}
+\advance\minraggedcols by -1
+}{%
+\AtBeginDocument{
+\grid[]{\xepersian at gridrows}{\xepersian at gridcolumns}}
+\advance\minraggedcols by -1
+}
+\ifthenelse{\boolean{xepersian at ninepoints}}{
+\renewcommand{\normalsize}{%
+  \@setfontsize{\normalsize}{9pt}{10pt}%
+  \setlength{\abovedisplayskip}{5pt plus 1pt minus .5pt}%
+  \setlength{\belowdisplayskip}{\abovedisplayskip}%
+  \setlength{\abovedisplayshortskip}{3pt plus 1pt minus 2pt}%
+  \setlength{\belowdisplayshortskip}{\abovedisplayshortskip}}
+
+\renewcommand{\tiny}{\@setfontsize{\tiny}{5pt}{6pt}}
+
+\renewcommand{\scriptsize}{\@setfontsize{\scriptsize}{7pt}{8pt}}
+
+\renewcommand{\small}{%
+  \@setfontsize{\small}{8pt}{9pt}%
+  \setlength{\abovedisplayskip}{4pt plus 1pt minus 1pt}%
+  \setlength{\belowdisplayskip}{\abovedisplayskip}%
+  \setlength{\abovedisplayshortskip}{2pt plus 1pt}%
+  \setlength{\belowdisplayshortskip}{\abovedisplayshortskip}}
+
+\renewcommand{\footnotesize}{%
+  \@setfontsize{\footnotesize}{8pt}{9pt}%
+  \setlength{\abovedisplayskip}{4pt plus 1pt minus .5pt}%
+  \setlength{\belowdisplayskip}{\abovedisplayskip}%
+  \setlength{\abovedisplayshortskip}{2pt plus 1pt}%
+  \setlength{\belowdisplayshortskip}{\abovedisplayshortskip}}
+
+\renewcommand{\large}{\@setfontsize{\large}{11pt}{13pt}}
+\renewcommand{\Large}{\@setfontsize{\Large}{14pt}{18pt}}
+\renewcommand{\LARGE}{\@setfontsize{\LARGE}{18pt}{20pt}}
+\renewcommand{\huge}{\@setfontsize{\huge}{20pt}{25pt}}
+\renewcommand{\Huge}{\@setfontsize{\Huge}{25pt}{30pt}}
+}{}
+\def\customwwwTxt#1{\gdef\@customwwwTxt{\lr{#1}}}
+\newcommand{\xepersian at wwwFormat}{\sffamily}
+\newcommand{\xepersian at www}{%
+\raisebox{-3pt}{{\xepersian at wwwFormat\@customwwwTxt}}
+}
+\newcommand{\xepersian at edition}{???????????? ????}
+\newcommand{\editionFormat}{\large\bfseries\texttt}
+\newcommand{\xepersian at editionLogo}{%
+\raisebox{-3pt}{%
+{\editionFormat\xepersian at edition}%
+}%
+}
+\newcommand{\indexFormat}{\large\bfseries}
+\newcommand{\xepersian at indexFrameTitle}[1]
+{\begin{flushright}{{\indexFormat #1}}\end{flushright}}
+
+\newcommand{\indexEntryFormat}{\normalsize}
+\newcommand{\xepersian at indexEntry}[1]{\begin{minipage}{13\TPHorizModule}%
+{\indexEntryFormat\noindent\ignorespaces{#1}}%
+\end{minipage}}
+\newcommand{\indexEntrySeparator}{\rule{\xepersian at indexwidth}{.1pt}}
+\newcommand{\indexEntryPageTxt}{??????????}
+\newcommand{\indexEntryPageFormat}{\footnotesize}
+\newcommand{\xepersian at indexEntryPage}[1]{%
+{\indexEntryPageFormat{\indexEntryPageTxt{}~#1}}%
+}
+\newcommand{\headDateTimeFormat}{}
+\newcommand{\xepersian at headDateTime}{%
+\headDateTimeFormat\date\hspace{5pt}$\parallel$\hspace{5pt}%
+\currenttime %
+}
+\newcommand{\weatherFormat}{\bfseries}
+\newcommand{\xepersian at weather}[1]{%
+\noindent{\weatherFormat #1}%
+}
+\newcommand{\weatherTempFormat}{\small}
+\newcommand{\weatherUnits}{\textdegree{}C}
+\newcommand{\xepersian at section}[0]{?????????? ??????}
+\newcommand{\xepersian at headleft}{%
+{\small\bfseries \@custommagazinename}?? \date
+}
+\newcommand{\xepersian at headcenter}{%
+\xepersian at section{}
+}
+\newcommand{\xepersian at headright}{%
+\small\xepersian at edition%
+\hspace*{5pt}\beginL\thepage\ / \pageref{LastPage}\endL
+}
+
+\newcommand{\heading}[3]{%
+\renewcommand{\xepersian at headleft}{\beginR#1\endR}%
+\renewcommand{\xepersian at headcenter}{\beginR#2\endR}%
+\renewcommand{\xepersian at headright}{\beginR#3\endR}%
+}
+\newcommand{\xepersian at footright}{%
+{\footnotesize\lr{\copyright\ \@customwwwTxt{}}---????????????????? ???????? \lr{\XePersian}}%
+}
+\newcommand{\xepersian at footcenter}{%
+}
+\newcommand{\xepersian at footleft}{%
+}
+
+\newcommand{\foot}[3]{%
+\renewcommand{\xepersian at footleft}{\beginR#1\endR}%
+\renewcommand{\xepersian at footcenter}{\beginR#2\endR}%
+\renewcommand{\xepersian at footright}{\beginR#3\endR}%
+}
+\newcommand{\firstTitleFormat}{\Huge\bfseries\flushright}
+\newcommand{\xepersian at firstTitle}[1]{%
+{%
+\begin{spacing}{2.0}{%
+\noindent\ignorespaces
+\ifthenelse{\boolean{xepersian at hyphenatedtitles}}%
+{\nohyphens{\firstTitleFormat #1}}%
+{{\firstTitleFormat #1}}%
+}%
+\end{spacing}%
+}%
+}
+\newcommand{\firstTextFormat}{}
+\newcommand{\xepersian at firstText}[1]{%
+{\noindent\ignorespaces\firstTextFormat #1}%
+}
+\newcommand{\secondTitleFormat}{\LARGE\bfseries}
+\newcommand{\xepersian at secondTitle}[1]{%
+\begin{spacing}{1.5}{%
+\noindent\ignorespaces\flushright
+\ifthenelse{\boolean{xepersian at hyphenatedtitles}}%
+{\nohyphens{\secondTitleFormat #1}}%
+{{\secondTitleFormat #1}}%
+}\end{spacing}%
+}
+\newcommand{\secondSubtitleFormat}{\large}
+\newcommand{\xepersian at secondSubtitle}[1]{%
+{\noindent\ignorespaces{\secondSubtitleFormat #1}}%
+}
+\newcommand{\secondTextFormat}{}
+\newcommand{\xepersian at secondText}[1]{%
+\begin{multicols}{2}
+{\noindent\ignorespaces\secondTextFormat #1}
+\end{multicols}
+}
+\newcommand{\thirdTitleFormat}{\Large\bfseries}
+\newcommand{\xepersian at thirdTitle}[1]{%
+\begin{spacing}{1.5}{%
+\noindent\ignorespaces\flushright
+\ifthenelse{\boolean{xepersian at hyphenatedtitles}}%
+{\nohyphens{\thirdTitleFormat #1}}%
+{{\thirdTitleFormat #1}}%
+}\end{spacing}%
+}
+\newcommand{\thirdSubtitleFormat}{\large}
+\newcommand{\xepersian at thirdSubtitle}[1]%
+{{\noindent\ignorespaces\thirdSubtitleFormat #1}}
+\newcommand{\thirdTextFormat}{}
+\newcommand{\xepersian at thirdText}[1]{{\thirdTextFormat #1}}
+\newcommand{\pictureCaptionFormat}{\small\bfseries}
+\newcommand{\xepersian at pictureCaption}[1]{%
+{\noindent\pictureCaptionFormat #1}%
+}
+\newcommand{\pagesFormat}{\bfseries\footnotesize}
+\newcommand{\xepersian at pages}[1]%
+{\noindent{\pagesFormat\MakeUppercase{#1}}}
+\newcommand{\innerTitleFormat}{\Huge}
+\newcommand{\xepersian at innerTitle}[1]{%
+\begin{flushright}{%
+\noindent
+\ifthenelse{\boolean{xepersian at hyphenatedtitles}}%
+{\nohyphens{\innerTitleFormat #1}}%
+{{\innerTitleFormat #1}}%
+}%
+\\%
+\end{flushright}%
+}
+\newcommand{\innerSubtitleFormat}{\large}
+\newcommand{\xepersian at innerSubtitle}[1]{{\innerSubtitleFormat #1}}
+\newcommand{\timestampTxt}{}
+\newcommand{\timestampSeparator}{|}
+\newcommand{\timestampFormat}{\small}
+\newcommand{\timestamp}[1]{%
+{\timestampFormat%
+#1~\timestampTxt{}%
+}~\timestampSeparator{}%
+}
+\newcommand{\innerAuthorFormat}{\footnotesize}
+\newcommand{\innerPlaceFormat}{\footnotesize\bfseries}
+\newcommand{\innerTextFinalMark}{\rule{0.65em}{0.65em}}
+\newcommand{\editorialTitleFormat}{\LARGE\textit}
+\newcommand{\xepersian at editorialTitle}[1]{\editorialTitleFormat{#1}}
+\newcommand{\editorialAuthorFormat}{\textsc}
+\newcommand{\shortarticleTitleFormat}{\LARGE\bfseries}
+\newcommand{\xepersian at shortarticleTitle}[1]{{\shortarticleTitleFormat #1}}
+\newcommand{\shortarticleSubtitleFormat}{\Large}
+\newcommand{\xepersian at shortarticleSubtitle}[1]{{\shortarticleSubtitleFormat #1}}
+\newcommand{\shortarticleItemTitleFormat}{\large\bfseries}
+\newcommand{\xepersian at shortarticleItemTitle}[1]{{\shortarticleItemTitleFormat #1}}
+\renewcommand{\maketitle}{\begin{titlepage}%
+  \let\footnotesize\small
+  \let\footnoterule\relax
+  \let \footnote \thanks
+  \null\vfil
+  \vskip 60\p@
+  \begin{center}%
+    {\LARGE \@title \par}%
+    \vskip 1em%
+    {\LARGE ??\xepersian at edition?? \par}%
+    \vskip 3em%
+    {\large
+     \lineskip .75em%
+      \begin{tabular}[t]{c}%
+        \@author
+      \end{tabular}\par}%
+      \vskip 1.5em%
+    {\large \@date \par}%
+  \end{center}\par
+  \@thanks
+  \vfil\null
+  \end{titlepage}%
+  \setcounter{footnote}{0}%
+  \global\let\thanks\relax
+  \global\let\maketitle\relax
+  \global\let\@thanks\@empty
+  \global\let\@author\@empty
+  \global\let\@date\@empty
+  \global\let\@title\@empty
+  \global\let\title\relax
+  \global\let\author\relax
+  \global\let\date\relax
+  \global\let\and\relax
+}
+\newcommand{\xepersian at say}[1]{\typeout{#1}}
+\newsavebox{\xepersian at fmbox}
+\newenvironment{xepersian at fmpage}[1]
+ {\begin{lrbox}{\xepersian at fmbox}\begin{minipage}{#1}}
+ {\end{minipage}\end{lrbox}\fbox{\usebox{\xepersian at fmbox}}}
+\newcommand{\image}[2]{
+\vspace{5pt}
+\setlength{\fboxsep}{1pt}
+\addtolength{\xepersian at imgsize}{\columnwidth}
+\addtolength{\xepersian at imgsize}{-1\columnsep}
+\ifxetex
+\setlength{\xepersian at pageneed}{1.5\xepersian at imgsize}
+\addtolength{\xepersian at pageneed}{50pt}
+\ClassWarning{xepersian-magazine}{%
+Image #1 needs: \the\xepersian at pageneed \space %
+and there is left: \the\page at free\space%
+}
+\ifdim \xepersian at pageneed < \page at free
+
+{\centering\fbox{%
+\includegraphics[width = \xepersian at imgsize,
+height = \xepersian at imgsize,
+keepaspectratio ]{#1}}}
+\xepersian at pictureCaption{#2}
+
+\vspace{5pt}
+\else
+\ClassWarning{Image #1 needs more space!%
+  It was not inserted!}
+\fi
+\fi
+}
+\textblockorigin{1cm}{1cm}
+\newdimen\xepersian at dx
+\newdimen\xepersian at dy
+\newcount\xepersian at cx
+\newcount\xepersian at cy
+\newcommand{\grid}[3][]{
+\xepersian at dx=\textwidth%
+\xepersian at dy=\textheight%
+\xepersian at cx=#3% %columns
+\xepersian at cy=#2% %rows
+
+\count1=#3%
+\advance\count1 by 1
+
+\count2=#2%
+\advance\count2 by 1
+
+\divide\xepersian at dx by #3
+\divide\xepersian at dy by #2
+
+\setlength{\TPHorizModule}{\xepersian at dx}
+\setlength{\TPVertModule}{\xepersian at dy}
+
+\ifthenelse{\equal{#1}{show}}{
+\multido{\xepersian at nrow=0+1}{\count2}{
+\begin{textblock}{\xepersian at cx}(0,\xepersian at nrow)
+\rule[0pt]{\textwidth}{.1pt}
+\end{textblock}
+}
+
+\multido{\xepersian at ncol=0+1}{\count1}{
+\begin{textblock}{\xepersian at cy}(\xepersian at ncol,0)
+\rule[0pt]{.1pt}{\textheight}
+\end{textblock}
+}
+}{}
+}
+\newcommand{\xepersianInit}{
+\setlength{\headheight}{14pt}
+\renewcommand{\headrulewidth}{0.4pt}
+
+\pagestyle{fancy}
+
+\setlength{\columnseprule}{\columnlines}
+\setlength{\fboxrule}{0.1 pt}
+
+}
+
+\def\customlogo#1{\gdef\@customlogo{\beginR#1\endR}}
+\def\customminilogo#1{\gdef\@customminilogo{\beginR#1\endR}}
+\def\custommagazinename#1{\gdef\@custommagazinename{\beginR#1\endR}}
+\newcommand{\logo}[0]{
+%% Heading %%
+\noindent\hrulefill\hspace{10pt}\xepersian at editionLogo\hspace{5pt}\xepersian at www
+
+\vspace*{-3pt}
+
+{\Large\bfseries \@customlogo}
+\hrulefill
+\hspace{10pt}\xepersian at headDateTime
+
+}
+\newcommand{\minilogo}[0]{
+{\large\bfseries \@customminilogo}
+
+\vspace*{5pt}
+}
+\newcommand{\mylogo}[1]{
+{\beginR#1\endR}
+
+\noindent
+\xepersian at editionLogo\hspace{5pt}
+\hrulefill
+\hspace{5pt}\xepersian at headDateTime
+}
+\newcommand{\edition}[1]{\renewcommand{\xepersian at edition}{#1}}
+\newenvironment{frontpage}[0]
+{
+\setboolean{xepersian at insidefrontpage}{true}
+\thispagestyle{empty}
+\logo
+
+}%
+{
+\thispagestyle{empty}
+\clearpage
+\newpage
+\fancyhead{}
+ \fancyfoot{}
+\fancyhead[RO,LE]{\beginR\xepersian at headright\endR}
+\fancyhead[LO,RE]{\beginR\xepersian at headleft\endR}
+    \fancyhead[C]{\beginR\xepersian at headcenter\endR}
+    \fancyfoot[RO,LE]{\beginR\xepersian at footright\endR}
+    \fancyfoot[LO,RE]{\beginR\xepersian at footleft\endR}
+\fancyfoot[C]{\beginR\xepersian at footcenter\endR}
+\renewcommand{\headrulewidth}{0.4pt}
+\setboolean{xepersian at insidefrontpage}{false}
+
+}
+\newcommand{\firstarticle}[3]
+{
+\ifthenelse{\boolean{xepersian at insidefrontpage}}{%
+\ifthenelse{\boolean{xepersian at hyphenatedtitles}}{%
+\begin{textblock}{24}(22,5)
+}
+{
+\begin{textblock}{28}(22,5)
+}
+\vspace{-7pt}
+\xepersian at firstTitle{#1}
+\end{textblock}
+\begin{textblock}{29}(22,10)
+\vspace{5pt plus 2pt minus 2pt}
+
+\xepersian at firstText{\timestamp{#3}~#2}
+
+\end{textblock}
+
+\begin{textblock}{50}(0,15)
+\rule{50\TPHorizModule}{.3pt}
+\end{textblock}
+}{%else
+\ClassError{xepersian-magazine}{%
+\protect\firstarticle\space in a wrong place.\MessageBreak
+\protect\firstarticle\space may only appear inside frontpage environment.
+}{%
+\protect\firstarticle\space may only appear inside frontpage environment.
+}%
+}
+}
+\newcommand{\secondarticle}[5]
+{
+\ifthenelse{\boolean{xepersian at insidefrontpage}}{%
+\begin{textblock}{33}(2,16)
+\xepersian at pages{#4}
+\vspace{-5pt}
+\xepersian at secondTitle{#1}
+
+\vspace*{5pt}
+
+\xepersian at secondSubtitle{#2}
+
+\vspace*{-7pt}
+
+\xepersian at secondText{\timestamp{#5}~#3}
+
+\end{textblock}
+
+\begin{textblock}{33}(2,25)
+\vspace{5pt plus 2pt minus 2pt}
+
+\noindent\ignorespaces\rule{33\TPHorizModule}{.3pt}
+\end{textblock}
+}{%else
+\ClassError{xepersian-magazine}{%
+\protect\secondarticle\space in a wrong place.\MessageBreak
+\protect\secondarticle\space may only appear inside frontpage environment.
+}{%
+\protect\secondarticle\space may only appear inside frontpage environment.
+}%
+}
+}
+\newcommand{\thirdarticle}[6]
+{
+\ifthenelse{\boolean{xepersian at insidefrontpage}}{%
+\begin{textblock}{32}(2,26)
+\xepersian at pages{#5}
+\vspace{-5pt}
+\setlength{\fboxsep}{1pt}
+\xepersian at thirdTitle{#1}
+
+\vspace*{5pt}
+
+\xepersian at thirdSubtitle{#2}
+
+\vspace*{5pt}
+
+{\noindent\ignorespaces %
+\ifthenelse{\equal{#4}{}}{}
+
+\xepersian at thirdText{\timestamp{#6}~#3}
+
+}
+
+\vspace*{5pt}
+
+\end{textblock}
+}{%else
+\ClassError{xepersian-magazine}{%
+\protect\thirdarticle\space in a wrong place.\MessageBreak
+\protect\thirdarticle\space may only appear inside frontpage environment.
+}{%
+\protect\thirdarticle\space may only appear inside frontpage environment.
+}%
+}
+}
+\newcommand{\firstimage}[2]
+{
+\ifthenelse{\boolean{xepersian at insidefrontpage}}{%
+\begin{textblock}{18}(2,5)
+\setlength{\fboxsep}{1pt}
+\ifxetex % only in PDF
+\noindent\fbox{\includegraphics[width = 18\TPHorizModule ]{#1}}
+\fi
+
+\xepersian at pictureCaption{#2}
+\end{textblock}%
+}
+{\ClassError{xepersian-magazine}{%
+\protect\firstimage\space in a wrong place.\MessageBreak
+\protect\firstimage\space may only appear inside frontpage environment.
+}{%
+\protect\firstimage\space may only appear inside frontpage environment.
+}}
+}%
+\newcommand{\weatheritem}[5]{%
+\ifthenelse{\boolean{xepersian at insideweather}}{
+\begin{minipage}{45pt}
+\ifxetex
+\includegraphics[width=40pt]{#1}
+\fi
+\end{minipage}
+\begin{minipage}{50pt}
+\weatherTempFormat
+#2\\
+\beginL#3 $\|$ #4 \lr{\weatherUnits{}}\endL\\
+#5
+\end{minipage}
+}{%else
+\ClassError{xepersian-magazine}{%
+\protect\weatheritem\space in a wrong place.\MessageBreak
+\protect\weatheritem\space may only appear inside weatherblock environment.
+}{%
+\protect\weatheritem\space may only appear inside weatherblock environment.\MessageBreak
+weatherblock environment may only appear inside frontpage environment.
+}%
+}
+}
+\newenvironment{weatherblock}[1]
+{
+\ifthenelse{\boolean{xepersian at insidefrontpage}}{%
+\setboolean{xepersian at insideweather}{true}
+\begin{textblock}{32}(2,38)
+\vspace*{-15pt}
+
+\xepersian at weather{\beginR#1\endR}
+
+\vspace*{5pt}
+
+\noindent\begin{xepersian at fmpage}{32\TPHorizModule}
+\begin{minipage}{32\TPHorizModule}
+\hspace{5pt}
+
+}{%
+\ClassError{xepersian-magazine}{%
+weatherblock in a wrong place.\MessageBreak
+weatherblock may only appear inside frontpage environment.
+}{%
+weatherblock may only appear inside frontpage environment.
+}
+}
+}%
+{
+\end{minipage}
+\end{xepersian at fmpage}
+\end{textblock}
+\setboolean{xepersian at insideweather}{false}
+}
+\newenvironment{authorblock}[0]
+{
+\ifthenelse{\boolean{xepersian at insidefrontpage}}{%
+\begin{textblock}{15}(36,35)
+\setlength{\fboxsep}{5pt}
+\begin{xepersian at fmpage}{13\TPHorizModule}
+\begin{minipage}{13\TPHorizModule}
+\centering
+\minilogo
+
+}{%else
+\ClassError{xepersian-magazine}{%
+authorblock in a wrong place.\MessageBreak
+authorblock may only appear inside frontpage environment.
+}{%
+authorblock may only appear inside frontpage environment.
+}
+}
+}
+{
+\end{minipage}
+\end{xepersian at fmpage}
+\end{textblock}
+}
+\newenvironment{indexblock}[1]
+{
+\ifthenelse{\boolean{xepersian at insidefrontpage}}{%
+\setboolean{xepersian at insideindex}{true}%let's in
+\begin{textblock}{15}(36,16)
+\setlength{\xepersian at indexwidth}{13\TPHorizModule}
+\xepersian at indexFrameTitle{#1}
+
+\setlength{\fboxsep}{5pt} %espacio entre el frame y la imagen
+\begin{xepersian at fmpage}{\xepersian at indexwidth}
+\begin{minipage}{\xepersian at indexwidth}
+\vspace*{10pt}
+}{%else
+\ClassError{xepersian-magazine}{%
+indexblock in a wrong place.\MessageBreak
+indexblock may only appear inside frontpage environment.
+}{%
+indexblock may only appear inside frontpage environment.
+}
+}
+}%
+{
+\end{minipage}
+\end{xepersian at fmpage}
+\end{textblock}
+\setboolean{xepersian at insideindex}{false}%let's out
+}
+\newcommand{\indexitem}[2]
+{
+\ifthenelse{\boolean{xepersian at insideindex}}{
+\xepersian at indexEntry{#1?? \xepersian at indexEntryPage{\pageref{#2}}}
+
+\vspace{0.5cm}
+
+\noindent\ignorespaces\indexEntrySeparator{}
+}{%else
+\ClassError{xepersian-magazine}{%
+\protect\indexitem\space in a wrong place.\MessageBreak
+\protect\indexitem\space may only appear inside indexblock environment.
+}{%
+\protect\indexitem\space may only appear inside indexblock environment.\MessageBreak
+indexblock environment may only appear inside frontpage environment.
+}%
+}
+}
+\newcommand{\xepersian at inexpandedtitle}[1]{
+\begin{minipage}{.95\textwidth}
+\begin{center}
+\noindent\Large\textbf{\beginR#1\endR}
+\end{center}
+\end{minipage}
+}
+\newcommand{\expandedtitle}[2]{
+\end{multicols}
+
+\begin{center}
+\setlength{\fboxsep}{5pt}
+\setlength{\shadowsize}{2pt}
+\ifthenelse{\equal{#1}{shadowbox}}{%
+\shadowbox{%
+\xepersian at inexpandedtitle{#2}%
+}%
+}{}
+\ifthenelse{\equal{#1}{doublebox}}{%
+\doublebox{%
+\xepersian at inexpandedtitle{#2}%
+}%
+}{}
+\ifthenelse{\equal{#1}{ovalbox}}{%
+\ovalbox{%
+\xepersian at inexpandedtitle{#2}%
+}%
+}{}
+\ifthenelse{\equal{#1}{Ovalbox}}{%
+\Ovalbox{%
+\xepersian at inexpandedtitle{#2}%
+}%
+}{}
+\ifthenelse{\equal{#1}{lines}}{
+\hrule
+\vspace*{8pt}
+\begin{center}
+\noindent\Large\textbf{#2}
+\end{center}
+\vspace*{8pt}
+\hrule
+}{}
+\end{center}
+
+\begin{multicols}{\xepersian at ncolumns{}}
+\ifnum \xepersian at ncolumns > \minraggedcols
+\raggedFormat
+\fi
+}
+\newcommand{\xepersian at incolumntitle}[2]{
+\begin{minipage}{#1}
+\begin{center}
+\noindent\normalsize\textbf{#2}
+\end{center}
+\end{minipage}
+}
+
+\newcommand{\columntitle}[2]{
+\vspace*{5pt}
+\begin{center}
+\setlength{\fboxsep}{5pt}
+\setlength{\shadowsize}{2pt}
+\addtolength{\xepersian at coltitsize}{\columnwidth}
+\addtolength{\xepersian at coltitsize}{-1\columnsep}
+\addtolength{\xepersian at coltitsize}{-5pt}
+\addtolength{\xepersian at coltitsize}{-1\shadowsize}
+\ifthenelse{\equal{#1}{shadowbox}}{%
+\shadowbox{%
+\xepersian at incolumntitle{\xepersian at coltitsize}{#2}%
+}%
+}{}
+\ifthenelse{\equal{#1}{doublebox}}{%
+\doublebox{%
+\xepersian at incolumntitle{\xepersian at coltitsize}{#2}%
+}%
+}{}
+\ifthenelse{\equal{#1}{ovalbox}}{%
+\ovalbox{%
+\xepersian at incolumntitle{\xepersian at coltitsize}{#2}%
+}%
+}{}
+\ifthenelse{\equal{#1}{Ovalbox}}{%
+\Ovalbox{%
+\xepersian at incolumntitle{\xepersian at coltitsize}{#2}%
+}%
+}{}
+\ifthenelse{\equal{#1}{lines}}{
+\hrule
+\vspace*{5pt}
+\begin{center}
+\noindent\normalsize\textbf{#2}
+\end{center}
+\vspace*{5pt}
+\hrule
+}{}
+\end{center}
+}
+\renewcommand{\date}{%
+\longdate{\today}%
+}
+\newcommand{\authorandplace}[2]{%
+\rightline{%
+{\innerAuthorFormat #1},\space{}{\innerPlaceFormat #2}%
+}%
+\par %
+}
+\newcommand{\newsection}[1]{
+\renewcommand{\xepersian at section}{#1}
+}
+\newenvironment{article}[5]
+{
+\xepersian at say{Adding a new piece of article}
+\renewcommand{\xepersian at ncolumns}{#1}
+\begin{multicols}{#1}[
+\xepersian at pages{#4}
+\xepersian at innerTitle{#2}%
+\xepersian at innerSubtitle{#3}%
+][4cm]%
+\label{#5}
+\ifnum #1 > \minraggedcols
+\raggedFormat
+\fi
+}
+{~\innerTextFinalMark{}
+\end{multicols}
+}
+\newcommand{\articlesep}{%
+\setlength{\xepersian at pageneed}{16000pt}
+\setlength\xepersian at pageleft{\pagegoal}
+\addtolength\xepersian at pageleft{-\pagetotal}
+
+\xepersian at say{How much left \the\xepersian at pageleft}
+
+\ifdim \xepersian at pageneed < \xepersian at pageleft
+\xepersian at say{Not enough space}
+\else
+\xepersian at say{Adding sep line between articles}
+\vspace*{10pt plus 10pt minus 5pt}
+\hrule
+\vspace*{10pt plus 5pt minus 5pt}
+\fi
+
+}
+\newcommand{\xepersian at editorialTit}[2]{
+\setlength{\arrayrulewidth}{.1pt}
+\begin{center}
+\begin{tabular}{c}
+\noindent
+\xepersian at editorialTitle{#1}
+\vspace{2pt plus 1pt minus 1pt}
+\\
+\hline
+\vspace{2pt plus 1pt minus 1pt}
+\\
+\editorialAuthorFormat{#2}
+\end{tabular}
+\end{center}
+}
+\newenvironment{editorial}[4]
+{
+\xepersian at say{Adding a new editorial}
+\begin{multicols}{#1}[%
+\xepersian at editorialTit{#2}{#3}%
+][4cm]
+\label{#4}
+\ifnum #1 > \minraggedcols
+\raggedFormat
+\fi
+}
+{
+\end{multicols}
+}
+\newcommand{\xepersian at shortarticleTit}[2]{
+\begin{center}
+\vbox{%
+\noindent
+\xepersian at shortarticleTitle{#1}
+\vspace{4pt plus 2pt minus 2pt}
+\hrule
+\vspace{4pt plus 2pt minus 2pt}
+\xepersian at shortarticleSubtitle{#2}
+}
+\end{center}
+}
+\newenvironment{shortarticle}[4]
+{
+\xepersian at say{Adding a short article block}
+\begin{multicols}{#1}[\xepersian at shortarticleTit{#2}{#3}][4cm] %
+    \label{#4}
+\par %
+\ifnum #1 > \minraggedcols
+\raggedFormat
+\fi
+}
+{
+\end{multicols}
+}
+\newcommand{\shortarticleitem}[2]{
+\goodbreak
+\vspace{5pt plus 3pt minus 3pt}
+{\vbox{\noindent\xepersian at shortarticleItemTitle{#1}}}
+\vspace{5pt plus 3pt minus 3pt}
+{\noindent #2}\\
+}
+%% 
+%% Copyright ?? 2008-2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `xepersian-magazine.cls'.

Added: tags/texmf/tex/xelatex/xepersian/xepersian-mathsdigitspec.sty
===================================================================
--- tags/texmf/tex/xelatex/xepersian/xepersian-mathsdigitspec.sty	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/xepersian/xepersian-mathsdigitspec.sty	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,106 @@
+%%
+%% This is file `xepersian-mathsdigitspec.sty',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% xepersian.dtx  (with options: `xepersian-mathsdigitspec.sty')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2008-2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\NeedsTeXFormat{LaTeX2e}
+\ProvidesPackage{xepersian-mathsdigitspec}
+  [2009/04/22 v1.0.1 Unicode Persian maths digits in XeLaTeX (Author: Vafa Khalighi)]
+\@zf at mathfalse
+\def\@preamblecmds{}
+\newcommand\not at onlypreamble[1]{{%
+  \def\do##1{\ifx#1##1\else\noexpand\do\noexpand##1\fi}%
+  \xdef\@preamblecmds{\@preamblecmds}}}
+\def\gm at notprerr{ can be used only in preamble (\on at line)}
+\AtBeginDocument{%
+  \def\do#1{\noexpand\do\noexpand#1}%
+  \edef\@preamblecmds{%
+    \def\noexpand\do##1{%
+      \def##1{\noexpand\PackageError{gmutils/LaTeX}%
+        {\noexpand\string##1 \noexpand\gm at notprerr}\noexpand\@eha}}%
+    \@preamblecmds}}
+\def\nocite#1{%
+  \@bsphack{\setbox0=\hbox{\cite{#1}}}\@esphack}
+\newcommand\xepersian at PackageInfo[1]{\PackageInfo{xepersian-mathsdigitspec}{#1}}
+\newcommand\SetMathCode[4]{%
+  \XeTeXmathcode#1="\mathchar at type#2 \csname sym#3\endcsname #4\relax}
+\newcommand\SetMathCharDef[4]{%
+  \XeTeXmathchardef#1="\mathchar at type#2 \csname sym#3\endcsname #4\relax}
+\newcommand\setdigitfont[2][]{%
+  \let\glb at currsize\relax
+  \setkeys*[xepersian-mathsdigitspec]{options}{#1}%
+  \edef\@tempa{\noexpand\zf at fontspec{%
+    \XKV at rm}{#2}}\@tempa
+  \xepersian at PackageInfo{Defining the default Persian maths digits font as '#2'}
+  \DeclareSymbolFont{OPERATORS}   {EU1}{\zf at family} {m}{n}
+  \SetSymbolFont{OPERATORS}{bold}{EU1}{\zf at family} {bx}{n}
+  \DeclareMathAlphabet      {\mathit}{EU1}{\zf at family}{m}{it}
+  \DeclareSymbolFontAlphabet{\mathrm}    {OPERATORS}
+  \DeclareMathAlphabet      {\mathbf}{EU1}{\zf at family}{bx}{n}
+  \SetMathCode{`0}{\mathalpha}{OPERATORS}{"06F0}
+  \SetMathCode{`1}{\mathalpha}{OPERATORS}{"06F1}
+  \SetMathCode{`2}{\mathalpha}{OPERATORS}{"06F2}
+  \SetMathCode{`3}{\mathalpha}{OPERATORS}{"06F3}
+  \SetMathCode{`4}{\mathalpha}{OPERATORS}{"06F4}
+  \SetMathCode{`5}{\mathalpha}{OPERATORS}{"06F5}
+  \SetMathCode{`6}{\mathalpha}{OPERATORS}{"06F6}
+  \SetMathCode{`7}{\mathalpha}{OPERATORS}{"06F7}
+  \SetMathCode{`8}{\mathalpha}{OPERATORS}{"06F8}
+  \SetMathCode{`9}{\mathalpha}{OPERATORS}{"06F9}
+  \SetMathCharDef{\decimalseparator}{\mathpunct}{OPERATORS}{"066B}
+}
+\ifx\newcommand\undefined\else
+  \newcommand{\ZifferAn}{}
+\fi
+\mathchardef\ziffer at DotOri="013A
+{\ZifferAn
+ \catcode`\.=\active\gdef.{\begingroup\obeyspaces\futurelet\n\ziffer at dcheck}}
+\def\ziffer at dcheck{\ziffer at check\ZifferLeer\ziffer at DotOri}
+\def\ziffer at check#1#2{%
+  \ifx\n1\endgroup#1\else
+    \ifx\n2\endgroup#1\else
+      \ifx\n3\endgroup#1\else
+        \ifx\n4\endgroup#1\else
+          \ifx\n5\endgroup#1\else
+            \ifx\n6\endgroup#1\else
+              \ifx\n7\endgroup#1\else
+                \ifx\n8\endgroup#1\else
+                  \ifx\n9\endgroup#1\else
+                    \ifx\n0\endgroup#1\else
+                      \endgroup#2%
+                    \fi
+                  \fi
+                \fi
+              \fi
+            \fi
+          \fi
+        \fi
+      \fi
+    \fi
+  \fi}
+\mathcode`.="8000\relax
+\def\ZifferLeer{\ifx\decimalseparator\undefied .\else \decimalseparator\fi}
+%% 
+%% Copyright ?? 2008-2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `xepersian-mathsdigitspec.sty'.

Added: tags/texmf/tex/xelatex/xepersian/xepersian-multiplechoice.sty
===================================================================
--- tags/texmf/tex/xelatex/xepersian/xepersian-multiplechoice.sty	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/xepersian/xepersian-multiplechoice.sty	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,164 @@
+%%
+%% This is file `xepersian-multiplechoice.sty',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% xepersian.dtx  (with options: `xepersian-multiplechoice.sty')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2008-2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\NeedsTeXFormat{LaTeX2e}
+\ProvidesPackage{xepersian-multiplechoice}[2009/03/21 v0.1
+                    Multiple Choice Questionnaire class for Persian in XeLaTeX (Author: Vafa Khalighi)]
+\RequirePackage{pifont}
+\RequirePackage{fullpage}
+\RequirePackage{ifthen}
+\RequirePackage{calc}
+\RequirePackage{verbatim}
+\RequirePackage{fmultico}
+\def\@headerfont{\bfseries}
+\newcommand\headerfont[1]{\gdef\@headerfont{#1}}
+\def\@X{X}
+\newcommand\X[1]{\gdef\@X{#1}}
+\def\pbs#1{\let\tmp=\\#1\let\\=\tmp}
+\newcommand\makeform at nocorrection{%
+  \addtocontents{frm}{\protect\end{tabular}}
+  \@starttoc{frm}}
+\newcommand\makeform at correction{%
+  \addtocontents{frm}{\protect\end{tabular}}}
+\newcommand\makemask at nocorrection{%
+  \addtocontents{msk}{\protect\end{tabular}}
+  \@starttoc{msk}}
+\newcommand\makemask at correction{%
+  \addtocontents{msk}{\protect\end{tabular}}}
+\newlength\questionspace
+\setlength\questionspace{0pt}
+\newcommand\answerstitle[1]{\gdef\@answerstitle{#1}}
+\def\@answerstitlefont{\bfseries}
+\newcommand\answerstitlefont[1]{\gdef\@answerstitlefont{#1}}
+\def\@answernumberfont{\bfseries}
+\newcommand\answernumberfont[1]{\gdef\@answernumberfont{#1}}
+\newcounter{question}\stepcounter{question}
+\newcounter{@choice}
+\def\@initorcheck{%
+  \xdef\@choices{\the at choice}%
+  \setcounter{@choice}{1}%
+  \gdef\@arraydesc{|l||}%
+  \gdef\@headerline{}%
+  \whiledo{\not{\value{@choice}>\@choices}}{
+    \xdef\@arraydesc{\@arraydesc c|}
+    \def\@appendheader{\g at addto@macro\@headerline}
+    \@appendheader{&\protect\@headerfont}
+    \edef\@the at choice{{\alph{@choice}}}
+    \expandafter\@appendheader\@the at choice
+    \stepcounter{@choice}}%
+  \addtocontents{frm}{%
+    \protect\begin{tabular}{\@arraydesc}
+    \protect\hline
+    \@headerline\protect\\\protect\hline\protect\hline}%
+  \addtocontents{msk}{%
+    \protect\begin{tabular}{\@arraydesc}
+    \protect\hline
+    \@headerline\protect\\\protect\hline\protect\hline}%
+  \gdef\@initorcheck{%
+    \ifthenelse{\value{@choice} = \@choices}{}{%
+      \ClassError{xepersian-multiplechoice}{Question \thequestion: wrong number of choices
+        (\the at choice\space instead of \@choices)}{%
+        Questions must all have the same number of proposed answers.%
+        \MessageBreak
+        Type X <return> to quit, fix your MCQ (multiple choice question) and rerun XeLaTeX.}}}}
+\newenvironment{question}[1]{%
+  %% \begin{question}
+  \begin{minipage}{\textwidth}
+    \xdef\@formanswerline{\@questionheader}%
+    \xdef\@maskanswerline{\@questionheader}%
+    \fbox{\parbox[c]{\linewidth}{#1}}
+    \vspace\questionspace\par
+    {\@answerstitlefont\@answerstitle}
+\begin{multicols}{4}
+    \begin{list}{\@answernumberfont\alph{@choice})~}{\usecounter{@choice}}}{%
+  %% \end{question}
+    \end{list}
+\end{multicols}
+    \@initorcheck%
+    \addtocontents{frm}{\@formanswerline\protect\\\protect\hline}%
+    \addtocontents{msk}{\@maskanswerline\protect\\\protect\hline}%
+  \end{minipage}
+  \stepcounter{question}}
+\def\@truesymbol{\ding{52}~}
+\def\@falsesymbol{\ding{56}~}
+\newcommand\truesymbol[1]{\gdef\@truesymbol{#1}}
+\newcommand\falsesymbol[1]{\gdef\@falsesymbol{#1}}
+\def\@true at nocorrection{\item}
+\def\@false at nocorrection{\item}
+\def\@true at correction{\item[\@truesymbol\refstepcounter{@choice}]}
+\def\@false at correction{\item[\@falsesymbol\refstepcounter{@choice}]}
+\newcommand\true{%
+  \xdef\@formanswerline{\@formanswerline&}%
+  \xdef\@maskanswerline{\@maskanswerline&\@X}%
+  \@true}%
+\newcommand\false{%
+  \xdef\@formanswerline{\@formanswerline&}%
+  \xdef\@maskanswerline{\@maskanswerline&}%
+  \@false}%
+\def\@correctionstyle{\itshape}
+\newcommand\correctionstyle[1]{\gdef\@correctionstyle{#1}}
+\newenvironment{@correction}{\@correctionstyle}{}
+ \def\@questionheader{???????? \thequestion}
+  \answerstitle{?????????????? ????????:}
+\DeclareOption{nocorrection}{%
+  \let\@true\@true at nocorrection
+  \let\@false\@false at nocorrection
+  \let\correction\comment
+  \let\endcorrection\endcomment
+  \def\makeform{\makeform at nocorrection}
+  \def\makemask{\makemask at nocorrection}}
+\DeclareOption{correction}{%
+  \let\@true\@true at correction
+  \let\@false\@false at correction
+  \let\correction\@correction
+  \let\endcorrection\end at correction
+  \def\makeform{\makeform at correction}
+  \def\makemask{\makemask at correction}}
+\ExecuteOptions{nocorrection}
+\newcommand\questiontitle[1]{\gdef\@questiontitle{#1}}
+\def\@questiontitlefont{\bfseries}
+\newcommand\questiontitlefont[1]{\gdef\@questiontitlefont{#1}}
+\newlength\questiontitlespace
+\setlength\questiontitlespace{5pt}
+\newlength\questionsepspace
+\setlength\questionsepspace{20pt}
+\gdef\@questionsepspace{0pt}
+\let\old at question\question
+\let\old at endquestion\endquestion
+\renewenvironment{question}[1]{%
+  %% \begin{question}
+  \vspace\@questionsepspace
+  \fbox{\parbox[c]{0.25\linewidth}{\@questiontitlefont\@questiontitle}}
+  \nopagebreak\vspace\questiontitlespace\par
+  \old at question{#1}}{%
+  %% \end{question}
+  \old at endquestion
+  \gdef\@questionsepspace{\questionsepspace}}
+ \questiontitle{???????? \thequestion:}
+\ProcessOptions
+%% 
+%% Copyright ?? 2008-2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `xepersian-multiplechoice.sty'.

Added: tags/texmf/tex/xelatex/xepersian/xepersian-persiancal.sty
===================================================================
--- tags/texmf/tex/xelatex/xepersian/xepersian-persiancal.sty	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/xepersian/xepersian-persiancal.sty	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,197 @@
+%%
+%% This is file `xepersian-persiancal.sty',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% xepersian.dtx  (with options: `xepersian-persiancal.sty')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2008-2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\NeedsTeXFormat{LaTeX2e}
+\ProvidesPackage{xepersian-persiancal}
+
+\newif\ifXePersian at leap \newif\ifXePersian at kabiseh
+\newcount\XePersian at i  \newcount\XePersian at y  \newcount\XePersian at m  \newcount\XePersian at d
+\newcount\XePersian at latini    \newcount\XePersian at persiani
+\newcount\XePersian at latinii   \newcount\XePersian at persianii
+\newcount\XePersian at latiniii  \newcount\XePersian at persianiii
+\newcount\XePersian at latiniv   \newcount\XePersian at persianiv
+\newcount\XePersian at latinv    \newcount\XePersian at persianv
+\newcount\XePersian at latinvi   \newcount\XePersian at persianvi
+\newcount\XePersian at latinvii  \newcount\XePersian at persianvii
+\newcount\XePersian at latinviii \newcount\XePersian at persianviii
+\newcount\XePersian at latinix   \newcount\XePersian at persianix
+\newcount\XePersian at latinx    \newcount\XePersian at persianx
+\newcount\XePersian at latinxi   \newcount\XePersian at persianxi
+\newcount\XePersian at latinxii  \newcount\XePersian at persianxii
+                       \newcount\XePersian at persianxiii
+
+\newcount\XePersian at temp
+\newcount\XePersian at temptwo
+\newcount\XePersian at tempthree
+\newcount\XePersian at yModHundred
+\newcount\XePersian at thirtytwo
+\newcount\XePersian at dn
+\newcount\XePersian at sn
+\newcount\XePersian at mminusone
+
+\def\persiantoday{%
+\XePersian at y=\year \XePersian at m=\month \XePersian at d=\day
+\XePersian at temp=\XePersian at y
+\divide\XePersian at temp by 100\relax
+\multiply\XePersian at temp by 100\relax
+\XePersian at yModHundred=\XePersian at y
+\advance\XePersian at yModHundred by -\XePersian at temp\relax
+\ifodd\XePersian at yModHundred
+   \XePersian at leapfalse
+\else
+   \XePersian at temp=\XePersian at yModHundred
+   \divide\XePersian at temp by 2\relax
+   \ifodd\XePersian at temp\XePersian at leapfalse
+   \else
+      \ifnum\XePersian at yModHundred=0%
+         \XePersian at temp=\XePersian at y
+         \divide\XePersian at temp by 400\relax
+         \multiply\XePersian at temp by 400\relax
+         \ifnum\XePersian at y=\XePersian at temp\XePersian at leaptrue\else\XePersian at leapfalse\fi
+      \else\XePersian at leaptrue
+      \fi
+   \fi
+\fi
+\XePersian at latini=31\relax
+\ifXePersian at leap
+  \XePersian at latinii = 29\relax
+\else
+  \XePersian at latinii = 28\relax
+\fi
+\XePersian at latiniii = 31\relax
+\XePersian at latiniv  = 30\relax
+\XePersian at latinv = 31\relax
+\XePersian at latinvi = 30\relax
+\XePersian at latinvii = 31\relax
+\XePersian at latinviii = 31\relax
+\XePersian at latinix = 30\relax
+\XePersian at latinx = 31\relax
+\XePersian at latinxi = 30\relax
+\XePersian at latinxii = 31\relax
+\XePersian at thirtytwo=32\relax
+\XePersian at temp=\XePersian at y
+\advance\XePersian at temp by -17\relax
+\XePersian at temptwo=\XePersian at temp
+\divide\XePersian at temptwo by 33\relax
+\multiply\XePersian at temptwo by 33\relax
+\advance\XePersian at temp by -\XePersian at temptwo
+\ifnum\XePersian at temp=\XePersian at thirtytwo\XePersian at kabisehfalse
+\else
+   \XePersian at temptwo=\XePersian at temp
+   \divide\XePersian at temptwo by 4\relax
+   \multiply\XePersian at temptwo by 4\relax
+   \advance\XePersian at temp by -\XePersian at temptwo
+   \ifnum\XePersian at temp=\z@\XePersian at kabisehtrue\else\XePersian at kabisehfalse\fi
+\fi
+\XePersian at tempthree=\XePersian at y                 % Number of Leap years
+\advance\XePersian at tempthree by -1
+\XePersian at temp=\XePersian at tempthree              % T := (MY-1) div 4
+\divide\XePersian at temp by 4\relax
+\XePersian at temptwo=\XePersian at tempthree           % T := T - ((MY-1) div 100)
+\divide\XePersian at temptwo by 100\relax
+\advance\XePersian at temp by -\XePersian at temptwo
+\XePersian at temptwo=\XePersian at tempthree           % T := T + ((MY-1) div 400)
+\divide\XePersian at temptwo by 400\relax
+\advance\XePersian at temp by \XePersian at temptwo
+\advance\XePersian at tempthree by -611       % Number of Kabise years
+\XePersian at temptwo=\XePersian at tempthree           % T := T - ((SY+10) div 33) * 8
+\divide\XePersian at temptwo by 33\relax
+\multiply\XePersian at temptwo by 8\relax
+\advance\XePersian at temp by -\XePersian at temptwo
+\XePersian at temptwo=\XePersian at tempthree           %
+\divide\XePersian at temptwo by 33\relax
+\multiply\XePersian at temptwo by 33\relax
+\advance\XePersian at tempthree by -\XePersian at temptwo
+\ifnum\XePersian at tempthree=32\advance\XePersian at temp by 1\fi % if (SY+10) mod 33=32 then Inc(T);
+\divide\XePersian at tempthree by 4\relax     % T := T - ((SY+10) mod 33) div 4
+\advance\XePersian at temp by -\XePersian at tempthree
+\advance\XePersian at temp by -137            % T := T - 137  Adjust the value
+\XePersian at persiani=31
+\advance\XePersian at persiani by -\XePersian at temp                 % now 31 - T is the persiani
+\XePersian at persianii = 30\relax
+\ifXePersian at kabiseh
+  \XePersian at persianiii = 30\relax
+\else
+  \XePersian at persianiii = 29\relax
+\fi
+\XePersian at persianiv  = 31\relax
+\XePersian at persianv   = 31\relax
+\XePersian at persianvi  = 31\relax
+\XePersian at persianvii = 31\relax
+\XePersian at persianviii= 31\relax
+\XePersian at persianix  = 31\relax
+\XePersian at persianx   = 30\relax
+\XePersian at persianxi  = 30\relax
+\XePersian at persianxii = 30\relax
+\XePersian at persianxiii= 30\relax
+\XePersian at dn= 0\relax
+\XePersian at sn= 0\relax
+\XePersian at mminusone=\XePersian at m
+\advance\XePersian at mminusone by -1\relax
+\XePersian at i=0\relax
+\ifnum\XePersian at i < \XePersian at mminusone
+\loop
+\advance \XePersian at i by 1\relax
+\advance\XePersian at dn by \csname XePersian at latin\romannumeral\the\XePersian at i\endcsname
+\ifnum\XePersian at i<\XePersian at mminusone \repeat
+\fi
+\advance \XePersian at dn by \XePersian at d
+\XePersian at i=1\relax
+\XePersian at sn = \XePersian at persiani
+\ifnum \XePersian at sn<\XePersian at dn
+\loop
+\advance \XePersian at i by 1\relax
+\advance\XePersian at sn by \csname XePersian at persian\romannumeral\the\XePersian at i\endcsname
+\ifnum \XePersian at sn<\XePersian at dn \repeat
+\fi
+\ifnum \XePersian at i < 4
+   \XePersian at m = 9 \advance\XePersian at m by \XePersian at i
+   \advance \XePersian at y by -622\relax
+\else
+   \XePersian at m = \XePersian at i \advance \XePersian at m by -3\relax
+   \advance \XePersian at y by -621\relax
+\fi
+\advance\XePersian at sn by -\csname XePersian at persian\romannumeral\the\XePersian at i%
+\endcsname
+\ifnum\XePersian at i = 1
+  \XePersian at d = \XePersian at dn \advance \XePersian at d by 30 \advance\XePersian at d by -\XePersian at persiani
+\else
+  \XePersian at d = \XePersian at dn \advance \XePersian at d by -\XePersian at sn
+\fi
+\beginL\number\XePersian at d\endL\space%
+\persianmonth{\XePersian at m}\space\beginL\number\XePersian at y\endL%
+}
+\def\persianmonth#1{\ifcase#1\or ??????????????\or
+????????????????\or
+??????????\or ??????\or
+??????????\or
+????????????\or ??????\or
+????????\or ??????\or
+????\or ????????\or
+??????????\fi}
+%% 
+%% Copyright ?? 2008-2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `xepersian-persiancal.sty'.

Added: tags/texmf/tex/xelatex/xepersian/xepersian-thesis-xepersian.def
===================================================================
--- tags/texmf/tex/xelatex/xepersian/xepersian-thesis-xepersian.def	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/xepersian/xepersian-thesis-xepersian.def	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,36 @@
+%%
+%% This is file `xepersian-thesis-xepersian.def',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% xepersian.dtx  (with options: `xepersian-thesis-xepersian.def')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2008-2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\renewcommand \thepart {\@tartibi\c at part}
+\renewcommand\appendix{\par
+  \setcounter{chapter}{0}%
+  \setcounter{section}{0}%
+  \gdef\@chapapp{\appendixname}%
+  \gdef\thechapter{\@harfi\c at chapter}
+}%end appendix
+%% 
+%% Copyright ?? 2008-2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `xepersian-thesis-xepersian.def'.

Added: tags/texmf/tex/xelatex/xepersian/xepersian-thesis.cls
===================================================================
--- tags/texmf/tex/xelatex/xepersian/xepersian-thesis.cls	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/xepersian/xepersian-thesis.cls	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,173 @@
+%%
+%% This is file `xepersian-thesis.cls',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% xepersian.dtx  (with options: `xepersian-thesis.cls')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2008-2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\NeedsTeXFormat{LaTeX2e}
+\ProvidesClass{xepersian-thesis}
+              [2009/01/05 v0.1
+ Persian thesis document class in XeLaTeX]
+\DeclareOption*{\PassOptionsToClass{\CurrentOption}{report}}
+\ProcessOptions
+\LoadClass{report}
+\def\university#1{\gdef\@university{#1}}
+\def\department#1{\gdef\@department{#1}}
+\def\degree#1{\gdef\@degree{#1}}
+\def\thesisdate#1{\gdef\@thesisdate{#1}}
+\def\supervisor#1{\gdef\@supervisor{#1}}
+\def\city#1{\gdef\@city{#1}}
+
+\def\latintitle#1{\gdef\@latintitle{#1}}
+\def\latinauthor#1{\gdef\@latinauthor{#1}}
+\def\latindegree#1{\gdef\@latindegree{#1}}
+\def\latindepartment#1{\gdef\@latindepartment{#1}}
+\def\latinthesisdate#1{\gdef\@latinthesisdate{#1}}
+\def\latinsupervisor#1{\gdef\@latinsupervisor{#1}}
+\def\latincity#1{\gdef\@latincity{#1}}
+\def\latinuniversity#1{\gdef\@latinuniversity{#1}}
+
+\def\maketitle{\begin{titlepage}
+{\includegraphics{logo}}
+\vskip 1.5cm
+{\Huge\bfseries \@title}\par
+\vskip 1cm
+{\large%
+  \by}\par
+{\Large\bfseries \@author}\par
+\vskip 5mm
+{\large\bfseries\writtenfor
+\par
+\@degree}
+\par
+\vskip 1cm
+{\large
+  \undersupervision\par
+\Large\bfseries \@supervisor}
+\par
+\vskip 1cm
+{\large \@thesisdate}
+\par
+\vskip 1cm
+{\large\bfseries\departmentof\space\@department}
+\par
+{\large\bfseries\universityof\space\@university \par\@city}
+\vfill
+\end{titlepage}%
+}
+
+\def\abstractpage{\newpage
+\thispagestyle{empty}
+\vskip 15mm
+\begin{center}{\large{\bfseries \@title} \\}
+\end{center}
+\par
+\begin{abstract}}
+\def\endabstractpage{\end{abstract}
+\newpage
+}
+
+\def\latinabstract{\newpage
+\thispagestyle{empty}
+\vskip 15mm
+\begin{center}{\Large\bfseries \@latintitle \\[5mm]}
+{\bfseries Abstract}
+\end{center}
+\vspace{5mm}}
+
+\def\endlatinabstract{\newpage}
+
+\def\acknowledgementpage{\newpage
+\thispagestyle{empty}
+\centerline{\Large \bfseries\acknowledgementname}
+\vspace{1cm}
+\par\noindent}
+\def\endacknowledgementpage{\newpage}
+
+\def\titlepage{\newpage\centering
+  \thispagestyle{empty}
+  \parindent 0pt \parskip 10pt plus 1fil minus 1fil
+  \def\baselinestretch{1}\@normalsize\vbox to \vsize\bgroup\vbox to 9in\bgroup}
+\def\endtitlepage{\par\kern 0pt\egroup\vss\egroup\newpage}
+
+\def\signature#1#2{\par\noindent#1\dotfill\null\\*
+  {\raggedright #2\par}}
+\def\abstract{\subsection*{\abstractname}\small\def\baselinestretch{1}
+\@normalsize}
+\def\endabstract{\par}
+
+\pagenumbering{harfi}
+\let\ol at chapter\@chapter
+\def\@chapter{%
+  \ifnum\c at chapter=0 \pagenumbering{arabic}\setcounter{page}{1}\fi
+  \ol at chapter}
+
+\def\keywords#1{\par \vspace{5mm}
+{\textbf{????????????????? ??????????:}} {\textit{ #1}}}
+
+\def\latinkeywords#1{\par \vspace{5mm}
+\noindent {\textbf{Keywords:}} {\textit{ #1}}}
+
+\font\titlefont=cmssbx10 scaled 2074
+\font\supervisorfont=cmbxti10
+\def\makelatintitle{\begin{titlepage}
+{\includegraphics{logo}}
+\vskip 1.5cm
+\addtolength{\baselineskip}{5mm}
+{\titlefont \@latintitle} \par
+\addtolength{\baselineskip}{-5mm}
+\vskip 1cm
+{\bfseries\latinby}\par
+{\Large\bfseries \@latinauthor}\par
+\vskip 5mm
+{\latinwrittenfor\par
+\large\@latindegree}
+\par
+\vskip 1cm
+Under supervision of \\
+{\supervisorfont\@latinsupervisor}
+\par
+\vskip 1cm
+{\@latinthesisdate}
+\par
+\vskip 1cm
+\large\bfseries
+\@latindepartment\space Department
+\par
+\@latinuniversity \par\@latincity
+\vfill
+\end{titlepage}%
+}
+
+\def\acknowledgementname{??????????????}
+\def\by{????????}
+\def\writtenfor{  ???????????? ?????????? ?????? ???? ?????????? ???????? ???? ?????????????? ???????? ???????????? ??????????}
+\def\undersupervision{?????? ??????}
+\def\departmentof{????????????????}
+\def\universityof{??????????????}
+\def\latinby{by}
+\def\latinwrittenfor{Submitted in Partial Fulfillment\\ of the Requirements\\ for the Degree of}
+\def\latinundersupervision{Under supervision of}
+%% 
+%% Copyright ?? 2008-2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `xepersian-thesis.cls'.

Added: tags/texmf/tex/xelatex/xepersian/xepersian.sty
===================================================================
--- tags/texmf/tex/xelatex/xepersian/xepersian.sty	2009-07-06 02:13:50 UTC (rev 80)
+++ tags/texmf/tex/xelatex/xepersian/xepersian.sty	2009-07-06 13:43:59 UTC (rev 81)
@@ -0,0 +1,284 @@
+%%
+%% This is file `xepersian.sty',
+%% generated with the docstrip utility.
+%%
+%% The original source files were:
+%%
+%% xepersian.dtx  (with options: `xepersian.sty')
+%% 
+%%   __________________________________
+%%   Copyright ?? 2008-2009 Vafa Khalighi
+%% 
+%%   License information appended.
+%% 
+%% 
+\NeedsTeXFormat{LaTeX2e}
+\def\xepersianversion{v1.0.1}
+\def\xepersianrevision{revision 79}
+\def\xepersiandate{2009/07/15}
+\ProvidesPackage{xepersian}[\xepersiandate\space \xepersianversion\space <\xepersianrevision>
+Persian typesetting in XeLaTeX]
+\DeclareOption{Kashida}{\input{kashida-xepersian.def}}
+\DeclareOption{localise}{\input{localise-xepersian.def}}
+\DeclareOption*{\PassOptionsToPackage{\CurrentOption}{bidi}}
+\ProcessOptions\relax
+\newcommand\xepersian at isloaded[2][]{
+  \expandafter\ifx\csname if at xepersian@#2loaded@\endcsname\relax
+    \expandafter\newif\csname if at xepersian@#2loaded@\endcsname
+  \fi
+  \@ifpackageloaded{#2}
+    {\csname @xepersian@#2loaded at true\endcsname #1}
+    {\csname @xepersian@#2loaded at false\endcsname}}
+\xepersian at isloaded{xunicode}
+\AtBeginDocument{
+  \if at xepersian@xunicodeloaded@
+    \xepersian at isloaded[\PackageError{xepersian}{Oops! you have loaded package xunicode before xepersian package. Please load package xunicode after xepersian package, and then try to run xelatex on your document again}{}]{xunicode}
+  \fi%
+}
+\AtBeginDocument{\ifdefined\persianfont\relax\else%
+\PackageError{xepersian}{Oops! you have not specified any font for the main text of the document. Please specify a font for the main text of the document by using \settextfont\space CS, and then try to run xelatex on your document again}%
+\fi}
+\AtBeginDocument{\ifdefined\latinfont\relax\else%
+\PackageError{xepersian}{Oops! you have not specified any font for the Latin texts of the document. Please specify a font for the Latin texts of the document by using \setlatintextfont\space CS, and then try to run xelatex on your document again}%
+\fi}
+\AtBeginDocument{\ifdefined\decimalseparator\relax\else%
+\PackageWarning{xepersian}{???You have not specified any font for the digits in maths mode and so the digits in maths mode will appear Latin. If you would like to have Persian digits in maths mode, then please specify a font for the digits in maths mode by using \setdigitfont\space CS, and then try to run xelatex on your document again???}%
+\fi}
+\RequirePackage[RTLdocument]{bidi}
+\RequirePackage{fontspec}
+\RequirePackage{xepersian-persiancal}
+\RequirePackage{xepersian-mathsdigitspec}
+\RequirePackage{etoolbox}
+\AtBeginDocument{\special{pdf: docinfo <<
+/Creator (X???Persian \xepersianversion\space <\xepersianrevision> Copyright ?? 2008-2009 Vafa Khalighi)
+         >>}}
+\gdef\@latex at error#1#2{%
+   \GenericError{%
+      \space\space\space\@spaces\@spaces\@spaces
+   }{%
+      XePersian Error: #1%
+   }{%
+      Oops! either you have done something wrong or it is a xepersian bug. Please first produce a similar file without using XePersian package and then compile it with xelatex, if you got the same error, then please study the Persian translation of ???The not so Short Introduction to LaTeX??? by MEHDI OMIDALI, otherwise please report the error with a minimal tex file which shows the error to  the Author of XePersian.%
+   }{#2}%
+}
+\gdef\@latexbug{%
+  \@latex at error{This may be a XePersian bug}{Please inform the Author of XePersian}}
+\def\prq{??}
+\def\plq{??}
+\newfontscript{Persian}{arab}
+\newfontlanguage{Persian}{ARA}
+\newcommand*\settextfont[2][]{%
+\newfontfamily\persianfont[Script=Persian,Mapping=parsidigits,#1]{#2}
+\let\rmdefault\zf at family
+  \normalfont
+}
+\newcommand*\settxtmathfont[2][]{%
+\newfontfamily\TXTmath[Mapping=txt2maths,#1]{#2}
+}
+\newcommand*\setlatintextfont[2][]{%
+\newfontfamily\latinfont[Mapping=tex-text,#1]{#2}
+}
+\newcommand*\defpersianfont[1]{%
+  \@ifnextchar[{\defpersianfont at i#1}{\defpersianfont at i#1[]}}
+\def\defpersianfont at i#1[#2]#3{%
+  \zf at fontspec{Script=Persian,Mapping=parsidigits,#2}{#3}%
+  \edef\@tempa{%
+    \noexpand\DeclareRobustCommand\noexpand#1
+      {\noexpand\fontfamily{\zf at family}\noexpand\selectfont}}%
+  \@tempa}
+\newcommand*\deflatinfont[1]{%
+  \@ifnextchar[{\deflatinfont at i#1}{\deflatinfont at i#1[]}}
+\def\deflatinfont at i#1[#2]#3{%
+  \zf at fontspec{Mapping=tex-text,#2}{#3}%
+  \edef\@tempa{%
+    \noexpand\DeclareRobustCommand\noexpand#1
+      {\noexpand\fontfamily{\zf at family}\noexpand\selectfont}}%
+  \@tempa}
+\newcommand\persiansfdefault{}
+\newcommand\persianttdefault{}
+\newcommand\navardefault{}
+\newcommand\pookdefault{}
+\newcommand\sayehdefault{}
+\DeclareRobustCommand\persiansffamily
+        {\not at math@alphabet\persiansffamily\mathpersiansf
+         \fontfamily\persiansfdefault\selectfont}
+\DeclareRobustCommand\persianttfamily
+        {\not at math@alphabet\persianttfamily\mathpersiantt
+         \fontfamily\persianttdefault\selectfont}
+\DeclareRobustCommand\navarfamily
+        {\not at math@alphabet\navarfamily\mathnavar
+         \fontfamily\navardefault\selectfont}
+\DeclareRobustCommand\pookfamily
+        {\not at math@alphabet\pookfamily\mathpook
+         \fontfamily\pookdefault\selectfont}
+\DeclareRobustCommand\sayehfamily
+        {\not at math@alphabet\sayehfamily\mathsayeh
+         \fontfamily\sayehdefault\selectfont}
+\DeclareTextFontCommand{\textpersiansf}{\persiansffamily}
+\DeclareTextFontCommand{\textpersiantt}{\persianttfamily}
+\DeclareTextFontCommand{\textnavar}{\navarfamily}
+\DeclareTextFontCommand{\textpook}{\pookfamily}
+\DeclareTextFontCommand{\textsayeh}{\sayehfamily}
+\newcommand*\setpersiansansfont[2][]{%
+  \zf at fontspec{Script=Persian,Mapping=parsidigits,#1}{#2}%
+  \let\persiansfdefault\zf at family
+  \normalfont}
+\newcommand*\setpersianmonofont[2][]{%
+  \zf at fontspec{Script=Persian,Mapping=parsidigits,#1}{#2}%
+  \let\persianttdefault\zf at family
+  \normalfont}
+\newcommand*\setnavarfont[2][]{%
+  \zf at fontspec{Script=Persian,Mapping=parsidigits,#1}{#2}%
+  \let\navardefault\zf at family
+  \normalfont}
+\newcommand*\setpookfont[2][]{%
+  \zf at fontspec{Script=Persian,Mapping=parsidigits,#1}{#2}%
+  \let\pookdefault\zf at family
+  \normalfont}
+\newcommand*\setsayehfont[2][]{%
+  \zf at fontspec{Script=Persian,Mapping=parsidigits,#1}{#2}%
+  \let\sayehdefault\zf at family
+  \normalfont}
+\def\lr#1{\begingroup\beginL\latinfont#1\endL\endgroup}
+\def\rl#1{\begingroup\beginR\persianfont#1\endR\endgroup}
+\def\latin{\bgroup\LatinAlphs\par\@RTLfalse\@RTL at footnotefalse\latinfont}
+\def\endlatin{\par\egroup}
+\def\persian{\bgroup\PersianAlphs\par\@RTLtrue\@RTL at footnotetrue\persianfont}
+\def\endpersian{\par\egroup}
+\def\Latin{\if at RTL\par\LatinAlphs\@RTLfalse\@RTL at footnotefalse\latinfont\fi}
+\def\Persian{\if at RTL\relax\else\par\PersianAlphs\@RTLtrue\@RTL at footnotetrue\persianfont\fi}
+\let\originaltoday=\today
+\def\today{\lr{\originaltoday}}
+\let\latintoday\today
+\def\today{\rl{\persiantoday}}
+\newcommand\twocolumnstableofcontents{%
+  \begin{multicols}{2}[\section*{\contentsname}]%
+    \small
+    \@starttoc{toc}%
+  \end{multicols}}
+\def\XePersian{\lr{\leavevmode$\smash{\hbox{X\lower.5ex
+  \hbox{\kern-.125em\reflect{E}}Persian}}$}}
+\def\TeX{\lr{\@@TeX}}
+\def\LaTeX{\lr{\@@LaTeX}}
+\def\LaTeXe{\lr{\@@LaTeXe}}
+\let\origin at XeTeX\XeTeX
+\def\XeTeX{\lr{\origin at XeTeX}}
+\let\origin at XeLaTeX\XeLaTeX
+\def\XeLaTeX{\lr{\origin at XeLaTeX}}
+\def\figurename{\if at RTL ??????\else Figure\fi}
+\def\tablename{\if at RTL ????????\else Table\fi}
+\def\contentsname{\if at RTL ?????????? ??????????\else Contents\fi}
+\def\listfigurename{\if at RTL ???????? ????????????\else List of Figures\fi}
+\def\listtablename{\if at RTL ???????? ??????????\else List of Tables\fi}
+\def\appendixname{\if at RTL ??????????\else Appendix\fi}
+\def\indexname{\if at RTL ??????????\else Index\fi}
+\def\refname{\if at RTL ??????????\else References\fi}
+\def\abstractname{\if at RTL ??????????\else Abstract\fi}
+\def\partname{\if at RTL ??????\else Part\fi}
+\def\datename{\if at RTL ??????????:\else Date:\fi}
+\def\@@and{\if at RTL ??\else and\fi}
+\def\bibname{\if at RTL ???????????????????\else Bibliography\fi}
+\def\chaptername{\if at RTL ??????\else Chapter\fi}
+\def\ccname{\if at RTL ????????????\else cc\fi}
+\def\enclname{\if at RTL ??????????\else encl\fi}
+\def\pagename{\if at RTL ????????\else Page\fi}
+\def\headtoname{\if at RTL ????\else To\fi}
+\def\proofname{\if at RTL ??????????\else Proof\fi}
+\def\@harfi#1{\ifcase#1\or ??????\char"200D\or ??\or ??\or ??\or ??\or
+??\or ??\or ??\or ??\or ??\or ??\or ??\or ??\or ??\or ??\or ??\or ??\or ??\or ??\or
+??\or ??\or ??\or ??\or ??\or ??\or ??\or ??\or ??\or ??\else\@ctrerr\fi}
+\def\harfi#1{\expandafter\@harfi\csname c@#1\endcsname}
+\def\@adadi#1{\ifcase#1 \or ????\or ????\or ????\or ????????\or ??????\or ????\or ??????\or ??????\or ????\or ????\or ??????????\or ????????????\or ??????????\or ????????????\or ????????????\or ????????????\or ????????\or ????????\or ??????????\or ????????\else\@ctrerr\fi}
+\def\adadi#1{\expandafter\@adadi\csname c@#1\endcsname}
+\def\@tartibi#1{\ifcase#1 \or ?????? \or ?????? \or ?????? \or ?????????? \or ???????? \or ?????? \or ???????? \or ???????? \or ?????? \or ?????? \or ???????????? \or ?????????????? \or ???????????? \or ?????????????? \or ?????????????? \or ?????????????? \or ?????????? \or ?????????? \or ???????????? \or ??????????\else\@ctrerr\fi}
+\def\tartibi#1{\expandafter\@tartibi\csname c@#1\endcsname}
+\providecommand*{\xpg at warning}[1]{%
+   \PackageWarning{XePersian}%
+   {#1}}
+\ifcsdef{abjad}{}{%
+\def\abjad#1{%
+\ifnum#1>1999 \xpg at warning{Illegal value (#1) for abjad numeral} {#1}
+\else
+  \ifnum#1<\z@\space\xpg at warning{Illegal value (#1) for abjad numeral}%
+  \else
+    \ifnum#1<10\expandafter\abj at num@i\number#1%
+    \else
+      \ifnum#1<100\expandafter\abj at num@ii\number#1%
+      \else
+        \ifnum#1<\@m\expandafter\abj at num@iii\number#1%
+        \else
+          \ifnum#1<\@M\expandafter\abj at num@iv\number#1%since #1<2000, we must have 1000
+          \fi
+        \fi
+      \fi
+    \fi
+  \fi
+\fi
+}
+\def\abjad at zero{}
+\def\abj at num@i#1{%
+  \ifcase#1\or ??????\or ??\or ??\or ??%
+           \or ??\char"200D\or ??\or ??\or ??\or ??\fi
+  \ifnum#1=\z@\abjad at zero\fi}
+\def\abj at num@ii#1{%
+  \ifcase#1\or ??\or ??\or ??\or ??\or ??%
+           \or ??\or ??\or ??\or ??\fi
+  \ifnum#1=\z@\fi\abj at num@i}
+\def\abj at num@iii#1{%
+  \ifcase#1\or ??\or ??\or ??\or ??\or ??%
+            \or ??\or ??\or ??\or ??\fi
+  \ifnum#1=\z@\fi\abj at num@ii}
+\def\abj at num@iv#1{%
+  \ifcase#1\or ??\fi
+  \ifnum#1=\z@\fi\abj at num@iii}
+}
+   \let\@latinalph\@alph%
+   \let\@latinAlph\@Alph%
+\def\PersianAlphs{%
+   \let\@alph\abjad%
+   \let\@Alph\abjad%
+}
+\def\LatinAlphs{%
+   \let\@alph\@latinalph%
+   \let\@Alph\@latinAlph%
+}
+\PersianAlphs
+\@ifpackageloaded{listings}{\input{listings-xepersian.def}}{}
+\@ifpackageloaded{algorithmic}{\input{algorithmic-xepersian.def}}{}
+\@ifpackageloaded{algorithm}{\input{algorithm-xepersian.def}}{}
+\@ifpackageloaded{backref}{\input{backref-xepersian.def}}{}
+\@ifpackageloaded{bidi}{\input{footnote-bidi-xepersian.def}}{}
+\@ifpackageloaded{enumerate}{\input{enumerate-xepersian.def}}{}
+\@ifpackageloaded{minitoc}{\input{minitoc-xepersian.def}}{}
+\@ifpackageloaded{tocloft}{\input{tocloft-xepersian.def}}{}
+\@ifclassloaded{article}{\input{article-xepersian.def}}{}
+\@ifclassloaded{amsart}{\input{amsart-xepersian.def}}{}
+\@ifclassloaded{bidimoderncv}{\input{bidimoderncv-xepersian.def}}{}
+\@ifclassloaded{report}{\input{report-xepersian.def}}{}
+\@ifclassloaded{rapport3}{\input{rapport3-xepersian.def}}{}
+\@ifclassloaded{scrartcl}{\input{scrartcl-xepersian.def}}{}
+\@ifclassloaded{scrbook}{\input{scrbook-xepersian.def}}{}
+\@ifclassloaded{scrreprt}{\input{scrreprt-xepersian.def}}{}
+\@ifclassloaded{xepersian-thesis}{\input{xepersian-thesis-xepersian.def}}{}
+\@ifclassloaded{amsbook}{\input{amsbook-xepersian.def}}{}
+\@ifclassloaded{bookest}{\input{bookest-xepersian.def}}{}
+\@ifclassloaded{extbook}{\input{extbook-xepersian.def}}{}
+\@ifclassloaded{book}{\input{book-xepersian.def}}{}
+\@ifclassloaded{refrep}{\input{refrep-xepersian.def}}{}
+\@ifclassloaded{beamer}{\input{beamer-xepersian.def}}{}
+\@ifclassloaded{bidimemoir}{\input{bidimemoir-xepersian.def}}{}
+%% 
+%% Copyright ?? 2008-2009      by Vafa Khalighi     <vafa at users.berlios.de>
+%% 
+%% Distributable under the LaTeX Project Public License,
+%% version 1.3c or higher (your choice). The latest version of
+%% this license is at: http://www.latex-project.org/lppl.txt
+%% 
+%% This work is "maintained" (as per LPPL maintenance status)
+%% by Vafa Khalighi.
+%% 
+%% 
+%% 
+%% 
+%%
+%% End of file `xepersian.sty'.

Added: tags/texmf-TDS.zip
===================================================================
(Binary files differ)


Property changes on: tags/texmf-TDS.zip
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream



From vafa at mail.berlios.de  Tue Jul  7 07:56:39 2009
From: vafa at mail.berlios.de (vafa at mail.berlios.de)
Date: Tue, 7 Jul 2009 07:56:39 +0200
Subject: [Xepersian-development] r82 - tags
Message-ID: <200907070556.n675ud0M007922@sheep.berlios.de>

Author: vafa
Date: 2009-07-07 07:56:34 +0200 (Tue, 07 Jul 2009)
New Revision: 82

Removed:
   tags/texmf/
Log:




From vafa at mail.berlios.de  Wed Jul  8 12:33:40 2009
From: vafa at mail.berlios.de (vafa at mail.berlios.de)
Date: Wed, 8 Jul 2009 12:33:40 +0200
Subject: [Xepersian-development] r83 - tags trunk
Message-ID: <200907081033.n68AXeHk011601@sheep.berlios.de>

Author: vafa
Date: 2009-07-08 12:33:22 +0200 (Wed, 08 Jul 2009)
New Revision: 83

Removed:
   tags/texmf-TDS.zip
Modified:
   trunk/xepersian.dtx
Log:
required changes to match bidi changes

Deleted: tags/texmf-TDS.zip
===================================================================
(Binary files differ)

Modified: trunk/xepersian.dtx
===================================================================
--- trunk/xepersian.dtx	2009-07-07 05:56:34 UTC (rev 82)
+++ trunk/xepersian.dtx	2009-07-08 10:33:22 UTC (rev 83)
@@ -71,7 +71,7 @@
 \generate{\file{amsbook-xepersian.def}{\from{xepersian.dtx}{amsbook-xepersian.def}}}
 \generate{\file{article-xepersian.def}{\from{xepersian.dtx}{article-xepersian.def}}}
 \generate{\file{backref-xepersian.def}{\from{xepersian.dtx}{backref-xepersian.def}}}
-\generate{\file{beamer-xepersian.def}{\from{xepersian.dtx}{beamer-xepersian.def}}}
+\generate{\file{bidibeamer-xepersian.def}{\from{xepersian.dtx}{bidibeamer-xepersian.def}}}
 \generate{\file{bidimoderncv-xepersian.def}{\from{xepersian.dtx}{bidimoderncv-xepersian.def}}}
 \generate{\file{bookest-xepersian.def}{\from{xepersian.dtx}{bookest-xepersian.def}}}
 \generate{\file{book-xepersian.def}{\from{xepersian.dtx}{book-xepersian.def}}}
@@ -163,7 +163,7 @@
 %    \begin{macrocode}
 \NeedsTeXFormat{LaTeX2e}
 \def\xepersianversion{v1.0.1}
-\def\xepersianrevision{revision 79}
+\def\xepersianrevision{revision 84}
 \def\xepersiandate{2009/07/15}
 \ProvidesPackage{xepersian}[\xepersiandate\space \xepersianversion\space <\xepersianrevision>
 	Persian typesetting in XeLaTeX]
@@ -414,7 +414,7 @@
 \@ifclassloaded{extbook}{\input{extbook-xepersian.def}}{}
 \@ifclassloaded{book}{\input{book-xepersian.def}}{}
 \@ifclassloaded{refrep}{\input{refrep-xepersian.def}}{}
-\@ifclassloaded{beamer}{\input{beamer-xepersian.def}}{}
+\@ifclassloaded{bidibeamer}{\input{bidibeamer-xepersian.def}}{}
 \@ifclassloaded{bidimemoir}{\input{bidimemoir-xepersian.def}}{}
 %    \end{macrocode}
 % \iffalse
@@ -486,9 +486,9 @@
 %    \end{macrocode}
 % \iffalse
 %</backref-xepersian.def>
-%<*beamer-xepersian.def>
+%<*bidibeamer-xepersian.def>
 % \fi
-% \part{beamer-xepersian.def}
+% \part{bidibeamer-xepersian.def}
 %    \begin{macrocode}
 \def\familydefault{\rmdefault}
 \def\latin{\bgroup\LatinAlphs\par\raggedright\@RTLfalse\@RTL at footnotefalse\latinfont}
@@ -508,7 +508,7 @@
 \def\bidiproofname{?????}
 %    \end{macrocode}
 % \iffalse
-%</beamer-xepersian.def>
+%</bidibeamer-xepersian.def>
 %<*bidimoderncv-xepersian.def>
 % \fi
 % \part{bidimoderncv-xepersian.def}



From vafa at mail.berlios.de  Wed Jul  8 13:07:43 2009
From: vafa at mail.berlios.de (vafa at mail.berlios.de)
Date: Wed, 8 Jul 2009 13:07:43 +0200
Subject: [Xepersian-development] r84 - tags
Message-ID: <200907081107.n68B7hnU012761@sheep.berlios.de>

Author: vafa
Date: 2009-07-08 13:07:19 +0200 (Wed, 08 Jul 2009)
New Revision: 84

Added:
   tags/texmf-TDS.zip
Log:


Added: tags/texmf-TDS.zip
===================================================================
(Binary files differ)


Property changes on: tags/texmf-TDS.zip
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream



From vafa at mail.berlios.de  Thu Jul  9 01:55:27 2009
From: vafa at mail.berlios.de (vafa at mail.berlios.de)
Date: Thu, 9 Jul 2009 01:55:27 +0200
Subject: [Xepersian-development] r85 - trunk
Message-ID: <200907082355.n68NtRjL022106@sheep.berlios.de>

Author: vafa
Date: 2009-07-09 01:55:21 +0200 (Thu, 09 Jul 2009)
New Revision: 85

Added:
   trunk/ftxe-0.11.py
Removed:
   trunk/ftxe-0.10.py
Log:
new version of ftxe per Mostafa

Deleted: trunk/ftxe-0.10.py
===================================================================
--- trunk/ftxe-0.10.py	2009-07-08 11:07:19 UTC (rev 84)
+++ trunk/ftxe-0.10.py	2009-07-08 23:55:21 UTC (rev 85)
@@ -1,1040 +0,0 @@
-?#  This program is free software: you can redistribute it and/or modify
-#  it under the terms of the GNU General Public License as published by
-#  the Free Software Foundation, either version 3 of the License, or
-#  (at your option) any later version.
-#
-#  This program is distributed in the hope that it will be useful,
-#  but WITHOUT ANY WARRANTY; without even the implied warranty of
-#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-#  GNU General Public License for more details.
-#
-#  You should have received a copy of the GNU General Public License
-#  along with this program. If not, see <http://www.gnu.org/licenses>
-
-##################################################
-#  Author:      Mostafa Vahedi                   #
-#  Date:        05 July 2009                     #
-#  Version:     0.10                             # 
-#  Application: FarsiTeX to XePersian converter  #
-##################################################
-
-import codecs
-
-import sys
-import os
-
-ft_numerical = [
-chr(0xB9),	# 	Arabic Thoushads Seperator
-chr(0xBC)	#	ARABIC DECIMAL SEPARATOR
-]
-
-
-ft_vowels = [
-chr(0xB0),	#	ARABIC FATHA
-chr(0xB1),	#	ARABIC KASRA
-chr(0xB2),	#	ARABIC DAMMA
-chr(0xB3),	#	ARABIC FATHATAN
-chr(0xB4),	#	ARABIC SHADDA
-chr(0xBA),	#	ARABIC LETTER SUPERSCRIPT ALEF
-chr(0xBB),	#	ARABIC HAMZA ABOVE
-chr(0xC4) 	#	ARABIC SUKUN
-]
-
-ft_non_joiners = [
-chr(0x8F)	#	ARABIC LETTER HAMZA
-]
-
-ft_bidi_joiners_initial = [
-chr(0xE4),	#	ARABIC LETTER AIN, initial form
-chr(0xE8),	#	ARABIC LETTER GHAIN, initial form
-chr(0xFB) 	#	ARABIC LETTER HEH, initial form
-]
-
-ft_bidi_joiners_medial = [
-chr(0xE3),	#	ARABIC LETTER AIN, medial form
-chr(0xE7),	#	ARABIC LETTER GHAIN, medial form
-chr(0xFA) 	#	ARABIC LETTER HEH, medial form
-]
-
-ft_bidi_joiners_final = [
-chr(0xE2),	#	ARABIC LETTER AIN, final form
-chr(0xE6),	#	ARABIC LETTER GHAIN, final form
-chr(0xFC) 	#	ARABIC LETTER FARSI YEH, final form
-]
-
-ft_bidi_joiners_isolated = [
-chr(0xE1),	#	ARABIC LETTER AIN, isolated form
-chr(0xE5),	#	ARABIC LETTER GHAIN, isolated form
-chr(0xFD) 	#	ARABIC LETTER FARSI YEH, isolated form
-]
-
-ft_bidi_joiners_initial_medial = [
-chr(0x8B),	#	ARABIC TATWEEL
-chr(0x8E),	#	ARABIC LETTER YEH WITH HAMZA ABOVE, initial-medial form
-chr(0x93),	#	ARABIC LETTER BEH, initial-medial form
-chr(0x95),	#	ARABIC LETTER PEH, initial-medial form
-chr(0x97),	#	ARABIC LETTER TEH, initial-medial form
-chr(0x99),	#	ARABIC LETTER THEH, initial-medial form
-chr(0x9B),	#	ARABIC LETTER JEEM, initial-medial form
-chr(0x9D),	#	ARABIC LETTER TCHEH, initial-medial form
-chr(0x9F),	#	ARABIC LETTER HAH, initial-medial form
-chr(0xA1),	#	ARABIC LETTER KHAH, initial-medial form
-chr(0xA8),	#	ARABIC LETTER SEEN, initial-medial form
-chr(0xAA),	#	ARABIC LETTER SHEEN, initial-medial form
-chr(0xAC),	#	ARABIC LETTER SAD, initial-medial form
-chr(0xAE),	#	ARABIC LETTER DAD, initial-medial form
-chr(0xAF),	#	ARABIC LETTER TAH, initial-medial form
-chr(0xE0),	#	ARABIC LETTER ZAH, initial-medial form
-chr(0xEA),	#	ARABIC LETTER FEH, initial-medial form
-chr(0xEC),	#	ARABIC LETTER QAF, initial-medial form
-chr(0xEE),	#	ARABIC LETTER KEHEH, initial-medial form
-chr(0xF0),	#	ARABIC LETTER GAF, initial-medial form
-chr(0xF3),	#	ARABIC LETTER LAM, initial-medial form
-chr(0xF5),	#	ARABIC LETTER MEEM, initial-medial form
-chr(0xF7),	#	ARABIC LETTER NOON, initial-medial form
-chr(0xFE)	#	ARABIC LETTER FARSI YEH, initial-medial form
-]
-
-ft_bidi_joiners_final_isolated = [
-chr(0x92),	#	ARABIC LETTER BEH, final-isolated form
-chr(0x94),	#	ARABIC LETTER PEH, final-isolated form
-chr(0x96),	#	ARABIC LETTER TEH, final-isolated form
-chr(0x98),	#	ARABIC LETTER THEH, final-isolated form
-chr(0x9A),	#	ARABIC LETTER JEEM, final-isolated form
-chr(0x9C),	#	ARABIC LETTER TCHEH, final-isolated form
-chr(0x9E),	#	ARABIC LETTER HAH, final-isolated form
-chr(0xA0),	#	ARABIC LETTER KHAH, final-isolated form
-chr(0xA7),	#	ARABIC LETTER SEEN, final-isolated form
-chr(0xA9),	#	ARABIC LETTER SHEEN, final-isolated form
-chr(0xAB),	#	ARABIC LETTER SAD, final-isolated form
-chr(0xAD),	#	ARABIC LETTER DAD, final-isolated form
-chr(0xC1),	#	ARABIC LETTER TAH, final-isolated form
-chr(0xC2),	#	ARABIC LETTER ZAH, final-isolated form
-chr(0xE9),	#	ARABIC LETTER FEH, final-isolated form
-chr(0xEB),	#	ARABIC LETTER QAF, final-isolated form
-chr(0xED),	#	ARABIC LETTER KEHEH, final-isolated form
-chr(0xEF),	#	ARABIC LETTER GAF, final-isolated form
-chr(0xF1),	#	ARABIC LETTER LAM, final-isolated form
-chr(0xF4),	#	ARABIC LETTER MEEM, final-isolated form
-chr(0xF6),	#	ARABIC LETTER NOON, final-isolated form
-chr(0xF9) 	#	ARABIC LETTER HEH, final-isolated form
-]
-
-ft_right_joiners_final = [
-chr(0x91)	#	ARABIC LETTER ALEF, final form
-]
-
-ft_right_joiners_isolated = [
-chr(0x8D),	#	ARABIC LETTER ALEF WITH MADDA ABOVE, isolated form
-chr(0x90)	#	ARABIC LETTER ALEF, isolated form
-]
-
-ft_right_joiners_final_isolated = [
-chr(0xA2),	#	ARABIC LETTER DAL
-chr(0xA3),	#	ARABIC LETTER THAL
-chr(0xA4),	#	ARABIC LETTER REH
-chr(0xA5),	#	ARABIC LETTER ZAIN
-chr(0xA6),	#	ARABIC LETTER JEH
-chr(0xBF),	#	ARABIC LETTER TEH MARBUTAH
-chr(0xF2),	#	ARABIC LIGATURE LAM WITH ALEF
-chr(0xF8)	#	ARABIC LETTER WAW
-]
-
-
-table_FT_UN = {
-chr(0x80) : [u'\u06F0'],	#	EXTENDED ARABIC-INDIC DIGIT ZERO
-chr(0x81) : [u'\u06F1'],	#	EXTENDED ARABIC-INDIC DIGIT ONE
-chr(0x82) : [u'\u06F2'],	#	EXTENDED ARABIC-INDIC DIGIT TWO
-chr(0x83) : [u'\u06F3'],	#	EXTENDED ARABIC-INDIC DIGIT THREE
-chr(0x84) : [u'\u06F4'],	#	EXTENDED ARABIC-INDIC DIGIT FOUR
-chr(0x85) : [u'\u06F5'],	#	EXTENDED ARABIC-INDIC DIGIT FIVE
-chr(0x86) : [u'\u06F6'],	#	EXTENDED ARABIC-INDIC DIGIT SIX
-chr(0x87) : [u'\u06F7'],	#	EXTENDED ARABIC-INDIC DIGIT SEVEN
-chr(0x88) : [u'\u06F8'],	#	EXTENDED ARABIC-INDIC DIGIT EIGHT
-chr(0x89) : [u'\u06F9'],	#	EXTENDED ARABIC-INDIC DIGIT NINE
-chr(0x8A) : [u'\u060C'],	#	ARABIC COMMA
-chr(0x8B) : [u'\u0640'],	#	ARABIC TATWEEL
-chr(0x8C) : [u'\u061F'],	#	ARABIC QUESTION MARK
-chr(0x8D) : [u'\u0622'],	#	ARABIC LETTER ALEF WITH MADDA ABOVE, isolated form
-chr(0x8E) : [u'\u0626'],	#	ARABIC LETTER YEH WITH HAMZA ABOVE, initial-medial form
-chr(0x8F) : [u'\u0621'],	#	ARABIC LETTER HAMZA
-chr(0x90) : [u'\u0627'],	#	ARABIC LETTER ALEF, isolated form
-chr(0x91) : [u'\u0627'],	#	ARABIC LETTER ALEF, final form
-chr(0x92) : [u'\u0628'],	#	ARABIC LETTER BEH, final-isolated form
-chr(0x93) : [u'\u0628'],	#	ARABIC LETTER BEH, initial-medial form
-chr(0x94) : [u'\u067E'],	#	ARABIC LETTER PEH, final-isolated form
-chr(0x95) : [u'\u067E'],	#	ARABIC LETTER PEH, initial-medial form
-chr(0x96) : [u'\u062A'],	#	ARABIC LETTER TEH, final-isolated form
-chr(0x97) : [u'\u062A'],	#	ARABIC LETTER TEH, initial-medial form
-chr(0x98) : [u'\u062B'],	#	ARABIC LETTER THEH, final-isolated form
-chr(0x99) : [u'\u062B'],	#	ARABIC LETTER THEH, initial-medial form
-chr(0x9A) : [u'\u062C'],	#	ARABIC LETTER JEEM, final-isolated form
-chr(0x9B) : [u'\u062C'],	#	ARABIC LETTER JEEM, initial-medial form
-chr(0x9C) : [u'\u0686'],	#	ARABIC LETTER TCHEH, final-isolated form
-chr(0x9D) : [u'\u0686'],	#	ARABIC LETTER TCHEH, initial-medial form
-chr(0x9E) : [u'\u062D'],	#	ARABIC LETTER HAH, final-isolated form
-chr(0x9F) : [u'\u062D'],	#	ARABIC LETTER HAH, initial-medial form
-chr(0xA0) : [u'\u062E'],	#	ARABIC LETTER KHAH, final-isolated form
-chr(0xA1) : [u'\u062E'],	#	ARABIC LETTER KHAH, initial-medial form
-chr(0xA2) : [u'\u062F'],	#	ARABIC LETTER DAL
-chr(0xA3) : [u'\u0630'],	#	ARABIC LETTER THAL
-chr(0xA4) : [u'\u0631'],	#	ARABIC LETTER REH
-chr(0xA5) : [u'\u0632'],	#	ARABIC LETTER ZAIN
-chr(0xA6) : [u'\u0698'],	#	ARABIC LETTER JEH
-chr(0xA7) : [u'\u0633'],	#	ARABIC LETTER SEEN, final-isolated form
-chr(0xA8) : [u'\u0633'],	#	ARABIC LETTER SEEN, initial-medial form
-chr(0xA9) : [u'\u0634'],	#	ARABIC LETTER SHEEN, final-isolated form
-chr(0xAA) : [u'\u0634'],	#	ARABIC LETTER SHEEN, initial-medial form
-chr(0xAB) : [u'\u0635'],	#	ARABIC LETTER SAD, final-isolated form
-chr(0xAC) : [u'\u0635'],	#	ARABIC LETTER SAD, initial-medial form
-chr(0xAD) : [u'\u0636'],	#	ARABIC LETTER DAD, final-isolated form
-chr(0xAE) : [u'\u0636'],	#	ARABIC LETTER DAD, initial-medial form
-chr(0xAF) : [u'\u0637'],	#	ARABIC LETTER TAH, initial-medial form
-chr(0xB0) : [u'\u064E'],	#	ARABIC FATHA
-chr(0xB1) : [u'\u0650'],	#	ARABIC KASRA
-chr(0xB2) : [u'\u064F'],	#	ARABIC DAMMA
-chr(0xB3) : [u'\u064B'],	#	ARABIC FATHATAN
-chr(0xB4) : [u'\u0651'],	#	ARABIC SHADDA
-chr(0xB5) : [u'\u0023'],	# * #
-chr(0xB6) : [u'\u0024'],	# * $
-chr(0xB7) : [u'\u0025'],	# * %
-chr(0xB8) : [u'\u0026'],	# * &
-chr(0xB9) : [u'\u066C'],	# 	Arabic Thoushads Seperator
-chr(0xBA) : [u'\u0670'],	#	ARABIC LETTER SUPERSCRIPT ALEF
-chr(0xBB) : [u'\u0654'],	#	ARABIC HAMZA ABOVE
-chr(0xBC) : [u'\u066B'],	#	ARABIC DECIMAL SEPARATOR
-chr(0xBD) : [u'\u0029'],	# * RIGHT PARENTHESIS
-chr(0xBE) : [u'\u0028'],	# * LEFT PARENTHESIS
-chr(0xBF) : [u'\u0629'],	#	ARABIC LETTER TEH MARBUTAH
-chr(0xC0) : [u'\u00BB'],	#	RIGHT-POINTING DOUBLE ANGLE QUOTATION MARK
-chr(0xC1) : [u'\u0637'],	#	ARABIC LETTER TAH, final-isolated form
-chr(0xC2) : [u'\u0638'],	#	ARABIC LETTER ZAH, final-isolated form
-chr(0xC3) : [u'\u00AB'],	#	LEFT-POINTING DOUBLE ANGLE QUOTATION MARK
-chr(0xC4) : [u'\u0652'],	#	ARABIC SUKUN
-chr(0xC5) : [u'\u002D'],	# * -
-chr(0xC6) : [u'\u002E'],	# * FULL STOP
-chr(0xC7) : [u'\u002F'],	# * /
-chr(0xC8) : [u'\u002A'],	# * *
-chr(0xC9) : [u'\u007E'],	# * ~
-chr(0xCA) : [u'\u003A'],	# * COLON
-chr(0xCB) : [u'\u061B'],	# 	ARABIC SEMICOLON
-chr(0xCC) : [u'\u003E'],	# * GREATER-THAN SIGN
-chr(0xCD) : [u'\u002B'],	# * +
-chr(0xCE) : [u'\u003D'],	# * =
-chr(0xCF) : [u'\u003C'],	# * LESS-THAN SIGN
-# chr(0xD0) : [u'\u0040'],	# * @
-chr(0xD0) : [u''],	        # * @
-chr(0xD1) : [u'\u005D'],	# * [
-chr(0xD2) : [u'\u005C'],	# * \
-chr(0xD3) : [u'\u005B'],	# * ]
-chr(0xD4) : [u'\u005E'],	# * ^
-chr(0xD5) : [u'\u005F'],	# * _
-chr(0xD6) : [u'\u0060'],	# * `
-chr(0xD7) : [u'\u007D'],	# * {
-chr(0xD8) : [u'\u007C'],	# * |
-chr(0xDA) : [u'\u0020'],	# * SPACE
-chr(0xDD) : [u'\u0021'],	# * EXCLAMATION MARK
-chr(0xDE) : [u'\u007B'],	# * }
-chr(0xE0) : [u'\u0638'],	#	ARABIC LETTER ZAH, initial-medial form
-chr(0xE1) : [u'\u0639'],	#	ARABIC LETTER AIN, isolated form
-chr(0xE2) : [u'\u0639'],	#	ARABIC LETTER AIN, final form
-chr(0xE3) : [u'\u0639'],	#	ARABIC LETTER AIN, medial form
-chr(0xE4) : [u'\u0639'],	#	ARABIC LETTER AIN, initial form
-chr(0xE5) : [u'\u063A'],	#	ARABIC LETTER GHAIN, isolated form
-chr(0xE6) : [u'\u063A'],	#	ARABIC LETTER GHAIN, final form
-chr(0xE7) : [u'\u063A'],	#	ARABIC LETTER GHAIN, medial form
-chr(0xE8) : [u'\u063A'],	#	ARABIC LETTER GHAIN, initial form
-chr(0xE9) : [u'\u0641'],	#	ARABIC LETTER FEH, final-isolated form
-chr(0xEA) : [u'\u0641'],	#	ARABIC LETTER FEH, initial-medial form
-chr(0xEB) : [u'\u0642'],	#	ARABIC LETTER QAF, final-isolated form
-chr(0xEC) : [u'\u0642'],	#	ARABIC LETTER QAF, initial-medial form
-chr(0xED) : [u'\u06A9'],	#	ARABIC LETTER KEHEH, final-isolated form
-chr(0xEE) : [u'\u06A9'],	#	ARABIC LETTER KEHEH, initial-medial form
-chr(0xEF) : [u'\u06AF'],	#	ARABIC LETTER GAF, final-isolated form
-chr(0xF0) : [u'\u06AF'],	#	ARABIC LETTER GAF, initial-medial form
-chr(0xF1) : [u'\u0644'],	#	ARABIC LETTER LAM, final-isolated form
-chr(0xF2) : [u'\u0644\u0627'],	#	ARABIC LIGATURE LAM WITH ALEF
-chr(0xF3) : [u'\u0644'],	#	ARABIC LETTER LAM, initial-medial form
-chr(0xF4) : [u'\u0645'],	#	ARABIC LETTER MEEM, final-isolated form
-chr(0xF5) : [u'\u0645'],	#	ARABIC LETTER MEEM, initial-medial form
-chr(0xF6) : [u'\u0646'],	#	ARABIC LETTER NOON, final-isolated form
-chr(0xF7) : [u'\u0646'],	#	ARABIC LETTER NOON, initial-medial form
-chr(0xF8) : [u'\u0648'],	#	ARABIC LETTER WAW
-chr(0xF9) : [u'\u0647'],	#	ARABIC LETTER HEH, final-isolated form
-chr(0xFA) : [u'\u0647'],	#	ARABIC LETTER HEH, medial form
-chr(0xFB) : [u'\u0647'],	#	ARABIC LETTER HEH, initial form
-chr(0xFC) : [u'\u06CC'],	#	ARABIC LETTER FARSI YEH, final form
-chr(0xFD) : [u'\u06CC'],	#	ARABIC LETTER FARSI YEH, isolated form
-chr(0xFE) : [u'\u06CC']		#	ARABIC LETTER FARSI YEH, initial-medial form
-}
-
-F_PERCENT_SIGN = chr(0xB7)
-F_AT_SIGN = chr(0xD0)
-F_SLASH = chr(0xD2)
-F_SPACE = chr(0xDA)
-F_PRNT_OPEN = chr(0xDE)
-F_PRNT_CLOSE = chr(0xD7)
-
-# latex and farsitex commands whose first parameter does not need \lr{...}
-commands = [ 
-"begin", "end",
-"input", "include", "includeonly",
-"hspace", "vspace", "hspace*", "vspace*",
-"label", "ref", "cite", "bibitem",
-"bibliographystyle",
-"parbox",
-"newenvironment", "newtheorem",
-"persianmathdigitsfamily",
-"fontfamily", "fontseries", "fontshape",
-"rmdefault", "sfdefault", "ttdefault",
-"bfdefault", "itdefault", "sldefault", "scdefault",
-"pagenumbering", "pagestyle", "thispagestyle",
-"setcounter", "stepcounter", "setlength", "addtolength"
-]
-
-def ft_is_all_persian_space(next_part):
-	l = len(next_part)
-	i = 0
-	while (i < l):
-		if (next_part[i] != F_SPACE):
-			return 0
-		i += 1
-	return 1
-
-def ft_is_numeric(ch):
-	if ((ch in ft_numerical) or 
-	    ((ch >= chr(0x80)) and (ch <= chr(0x89))) ):
-		return 1
-	return 0
-
-def ft_can_join_left(ch):
-	if ((ch in ft_bidi_joiners_initial) or
-	    (ch in ft_bidi_joiners_medial) or
-	    (ch in ft_bidi_joiners_final) or
-	    (ch in ft_bidi_joiners_isolated) or
-	    (ch in ft_bidi_joiners_initial_medial) or
-	    (ch in ft_bidi_joiners_final_isolated)):
-    		return 1
-	return 0
-
-def ft_can_join_right(ch):
-	if (ft_can_join_left(ch) or 
-	    (ch in ft_right_joiners_final) or
-	    (ch in ft_right_joiners_isolated) or
-	    (ch in ft_right_joiners_final_isolated)):
-		return 1
-	return 0
-
-def ft_joining_left(ch):
-	if ((ch in ft_bidi_joiners_initial) or 
-	    (ch in ft_bidi_joiners_medial) or
-	    (ch in ft_bidi_joiners_initial_medial)):
-		return 1
-	return 0
-
-
-def ft_joining_right(ch):
-	if ((ch in ft_right_joiners_final) or
-	    (ch in ft_bidi_joiners_medial) or 
-	    (ch in ft_bidi_joiners_final)):
-		return 1
-	return 0
-
-def ft_not_right_joined(ch):
-	if ((ch in ft_bidi_joiners_initial) or
-	    (ch in ft_right_joiners_isolated) or
-	    (ch in ft_bidi_joiners_isolated)):
-		return 1
-	return 0
-
-def ft_adjust_shaping(text, i):
-	current = text[i]
-	u = u''
-	try:
-		u = table_FT_UN[current][0]
-	except KeyError:
-		return u''
-
-	#if you don't want shaping remove the following comment
-	#return u
-
-	if ((current in ft_vowels) or (ft_is_numeric(current))):
-		return u
-
-	#find next non-vowel character on the left
-	text_len = len(text)
-	next_index = i+1
-	while ((next_index < text_len) and (text[next_index] in ft_vowels)):
-		next_index += 1
-
-	if (next_index == text_len):
-		next = ''
-	else:
-		next = text[next_index]
-
-	# if current letter is joining from left but next letter is or can not joining
-	if (ft_joining_left(current)):
-		if (not ft_can_join_right(next)):
-			u += u'\u200D' #ZWJ
-		elif (ft_not_right_joined(next)):
-			u += u'\u200D\u200C' #ZWJ+ZWNJ
-	# if current letter can join but next letter is joining from right
-	elif (ft_can_join_left(current)):
-		if (ft_joining_right(next)):
-			u += u'\u200C\u200D' #ZWNJ+ZWJ
-		elif (ft_can_join_right(next)):
-			u += u'\u200C' #ZWNJ
-	return u
-
-def ft_adjust_number(text):
-	result = u''
-	i = len(text)-1
-	while (i >= 0):
-		result += ft_adjust_shaping(text, i)
-		i -= 1
-	return result
-
-
-def map_ft_unicode(text):
-	mapped_text = u''
-
-	i = 0
-	while (i < len(text)):
-		if (ft_is_numeric(text[i])):
-			next_index = i
-			while ((next_index+1 < len(text)) and
-			       (ft_is_numeric(text[next_index+1]))):
-				next_index += 1
-			mapped_text += ft_adjust_number(text[i:next_index+1])
-			i = next_index+1
-			continue
-
-		mapped_text += ft_adjust_shaping(text, i)
-		i += 1
-	return mapped_text
-
-# Finds next token all of the same language
-def ft_next_part(line, i, line_len):
-	global global_state
-	global recursive
-	global filenames
-	
-	j = i
-	language_flag = (line[j]<chr(0x80))
-	while ((j<line_len) and ((line[j]<chr(0x80)) == language_flag) ):
-		if ( (global_state == 0) and ( (line[j] == '%') or (line[j] == F_PERCENT_SIGN) ) and (line[j-1] != '\\') and (line[j-1] != F_SLASH) ):
-			global_state = 1
-		elif ((global_state == 0) and ((line[j:j+16] == '\\begin{verbatim}') or (line[j:j+17] == '\\begin{verbatim*}'))):
-			global_state = 2
-		elif ((global_state == 2) and ((line[j:j+14] == '\\end{verbatim}') or (line[j:j+15] == '\\end{verbatim*}'))):
-			global_state = 0
-		elif ((global_state == 0) and (line[j:j+6] == '\\verb*')):
-			next_index = line.find(line[j+6], j+7)
-			j = next_index
-		elif ((global_state == 0) and (line[j:j+5] == '\\verb')):
-			next_index = line.find(line[j+5], j+6)
-			j = next_index
-		elif (recursive == 1):
-			if ((global_state == 0) and (line[j:j+9] == '\\include{')):
-				next_index = line.find('}', j+9)
-				filename = line[j+10:next_index-1] + '.ftx'
-				if (os.path.exists(filename) and not filename in filenames):
-					filenames.append(filename)
-			elif ((global_state == 0) and (line[j:j+7] == '\\input{')):
-				next_index = line.find('}', j+7)
-				filename = line[j+8:next_index-1] + '.ftx'
-				if (os.path.exists(filename) and not filename in filenames):
-					filenames.append(filename)
-			elif ((global_state == 0) and (line[j:j+9] == F_SLASH + 'include' + F_PRNT_OPEN)):
-				next_index = line.find(F_PRNT_CLOSE, j+9)
-				if (line[j+9]!=F_AT_SIGN):
-					filename = line[j+9:next_index] + '.ftx'
-				else:
-					filename = line[j+10:next_index-1] + '.ftx'
-				if (os.path.exists(filename) and not filename in filenames):
-					filenames.append(filename)
-			elif ((global_state == 0) and (line[j:j+7] == F_SLASH + 'input' + F_PRNT_OPEN)):
-				next_index = line.find(F_PRNT_CLOSE, j+7)
-				if (line[j+7]!=F_AT_SIGN):
-					filename = line[j+7:next_index] + '.ftx'
-				else:
-					filename = line[j+8:next_index-1] + '.ftx'
-				if (os.path.exists(filename) and not filename in filenames):
-					filenames.append(filename)
-		j += 1
-	return j
-
-###############################################
-# from here all functions are used to translate
-# farsitex commands to xepersian commands
-###############################################
-
-def read_size(input,index,last_index):
-	dim_index = -1 
-	inch_index = input.find(u'in', index)
-	if (inch_index != -1):
-		dim_index = inch_index
-	mm_index = input.find(u'mm', index)
-	if (mm_index != -1):
-		if (dim_index == -1 or mm_index < index):
-			dim_index = mm_index
-	cm_index = input.find(u'cm', index)
-	if (cm_index != -1):
-		if (dim_index == -1 or cm_index < dim_index):
-			dim_index = cm_index
-	pt_index = input.find(u'pt', index)
-	if (pt_index != -1):
-		if (dim_index == -1 or pt_index < dim_index):
-			dim_index = pt_index
-	next_cmd = input.find(u'\\', index)
-	if (next_cmd == -1 and dim_index == -1):
-		print "Error in parsing \epsfxsize command at " + str(line_number) + "\n"
-		return -1
-	elif (next_cmd == -1 or (dim_index != -1 and next_cmd > dim_index)):
-		epsfxsize = input[index:dim_index+2]
-		return dim_index+2
-	elif (next_cmd != -1):
-		end_cmd = next_cmd+1
-		while (end_cmd < last_index and input[end_cmd].isalpha()):
-			end_cmd += 1
-		return end_cmd
-	else:
-		print "Error in parsing \epsfxsize command at " + str(line_number) + "\n"
-		return -1
-
-
-latex_options=[u'a4paper', u'a5paper', u'b5paper', 
-			   u'letterpaper', u'legalpaper', u'executivepaper', 
-			   u'landscape', u'10pt', u'11pt', u'12pt', 
-			   u'oneside', u'twoside', u'draft', 
-			   u'final', u'titlepage', u'notitlepage',
-			   u'onecolumn', u'twocolumn',
-			   u'leqno', u'fleqn']
-
-table_eq_packages = {
-u'poem'     : u'persianpoem',
-u'fmakeidx' : u'makeidx',
-u'ffancyhe' : u'fancyhdr',
-u'fmultico' : u'multicol'
-}
-
-farsitex_ignore_options = [u'persian', u'farsi', u'epsf', u'fgraphix', u'lotusfont']
-
-xepersian_packages = u'\n\\usepackage{url}\n%\\usepackage{fancyvrb}\n\\usepackage{setspace}\\doublespacing\n\\usepackage{graphicx} \n\\usepackage{amssymb}\n'
-xepersian_preamble = u'\\settextfont[Scale=1.2]{XB Zar}\n\\setlatintextfont[Scale=1.1]{Times New Roman}\n\\setdigitfont{XB Zar} \n\\SepMark{-}\n\\def\\nazok{\\normalfont\\normalsize} \n\\let\\iranic\\it\n\\let\\siah\\bf\n\\let\\khabide\\sl\n\\def\\siahir{\\siah\\iranic}\n\\def\\siahkh{\\siah\\khabide}\n\\setpookfont{XB Kayhan Pook} \n\\let\\tookhali\\pookfamily\n\\setsayehfont{XB Kayhan Sayeh}\\let\\sayedar\\sayehfamily\n\\let\\farsi\\Persian\n\\let\\english\\Latin \n\\let\\farmbox\\mbox\n\\newcommand{\\ftxepmatrix}[1]{\\begin{pmatrix}#1\\end{pmatrix}}\n\\def\\FarsiTeX{\\lr{FarsiTeX}}\n\\def\\????????{\\rl{?????????}}\n'
-thesis_preamble = u'\\university{\\lr{UniversityName}}\n\\city{\\lr{CityName}}\n\\latinuniversity{UniversityName}\n\\latincity{CityName} \n\\let\\englishtitle\\latintitle\n\\let\\englishauthor\\latinauthor\n\\let\\englishdegree\\latindegree\n\\let\\englishthesisdate\\latinthesisdate \n\\let\\englishsupervisor\\latinsupervisor\n\\let\\englishdepartment\\latindepartment\n\\let\\makeenglishtitle\\makelatintitle \n\\let\\englishkeywords\\latinkeywords\n\\newenvironment{englishabstract}{\\begin{latinabstract}}{\\end{latinabstract}}\n'
-
-def is_alpha_numeric_space(input):
-	input_len = len(input)
-	i = 0
-	while (i<input_len):
-		if (not (input[i].isalpha() or input[i].isdigit() or input[i]==u'.' or input[i]==u' ') ):
-			return 0
-		i+=1
-	return 1
-
-def is_alpha_numeric(input):
-	input_len = len(input)
-	i = 0
-	while (i<input_len):
-		if (not (input[i].isalpha() or input[i].isdigit() or input[i]=='.') ):
-			return 0
-		i+=1
-	return 1
-			
-def find_eq_cmd(keyword):
-	try:
-		eq_cmd = table_eq_packages[keyword]
-	except KeyError:
-		eq_cmd = u''
-	return eq_cmd
-
-def convert_persian_to_english(num):
-	result = u''
-	num_len = len(num)
-	index = 0
-	while (index < num_len):
-		if (ord(num[index]) >= ord(u'?') and ord(num[index]) <= ord(u'?')):
-			result += unichr(ord(num[index]) - ord(u'?') + ord(u'0'))
-		else:
-			result += num[index]
-		index += 1
-	return result
-
-def generate_farsitex_cmds_file(helper_filename,preamble):
-	try:
-		of = codecs.open(helper_filename, encoding='utf-8', mode='w')
-	except IOError:
-		print "Can not open the output file: " + helper_filename
-		exit(0)
-	of.write(preamble)
-	of.close
-
-
-# \verb|| -> \item[\verb||] or \section{\verb||}
-# \kasre{} \alef{} ...
-def translate_cmds(output_line):
-	global last_epsfxsize
-	global last_epsfxsize_line
-	global last_epsfysize
-	global last_epsfysize_line
-	global state
-	global filename
-
-	result = u''
-	line_len = len(output_line)
-	index = 0
-	if (state == 1): #\begin{verbatim}
-		end_verbatim = output_line.find('\\end{verbatim}')
-		if (end_verbatim == -1):
-			return output_line
-		result += output_line[0:end_verbatim+14]
-		index = end_verbatim+14
-		state = 0
-	elif (state == 2): #\begin{verbatim*}
-		end_verbatim = output_line.find('\\end{verbatim*}')
-		if (end_verbatim == -1):
-			return output_line
-		result += output_line[0:end_verbatim+15]
-		index = end_verbatim+15
-		state = 0
-	elif (output_line[0:14] == "\\documentstyle"):
-		result += u'\\documentclass'
-		#process options
-		last_index = output_line.find(u']')
-		index = 15
-		first_option = 1
-		preamble = xepersian_preamble
-		packages = xepersian_packages
-		xe_document_class = u''
-		while (index < last_index):
-			next_comma = output_line.find(u',',index,last_index)
-			if (next_comma == -1):
-				next_comma = last_index
-			first_of_option = index
-			while (output_line[first_of_option] == u' '):
-				first_of_option += 1
-			end_of_option = next_comma
-			while (output_line[end_of_option-1] == u' '):
-				end_of_option -= 1
-			option = output_line[first_of_option:end_of_option]
-			index = next_comma+1
-			eq_cmd = find_eq_cmd(option)
-			if (eq_cmd != u''):
-				packages += u'\\usepackage{' + eq_cmd + u'}\n'
-				continue
-			elif (option in farsitex_ignore_options):
-				continue
-			elif (option == u'sharifth'):
-				xe_document_class = u'xepersian-thesis'
-				preamble += thesis_preamble
-				continue
-			elif (not option in latex_options):
-				packages += u'\\usepackage{' + option + u'}\n'
-				continue
-	
-			if (first_option):
-				result += u'['
-			else:
-				result += u','
-			result += option
-			first_option = 0
-		#end while
-		if (not first_option):
-			result += u']'
-		# process document style into document class
-		index = output_line.find(u'}',last_index)
-		document_class = output_line[last_index+2:index]
-		if (xe_document_class != u''):
-			result += u'{' + xe_document_class + u'}'
-		elif (document_class == u'oldarticle'):
-			result += u'{article}'
-		elif (document_class == u'oldbook'):
-			result += u'{book}'
-		elif (document_class == u'oldreport'):
-			result += u'{report}'
-		else:
-			result += u'{' + document_class + u'}'
-		# I assume that nothing important is after
-		# \documentstyle[...]{...}, otherwise it may conflict
-		# with our preamble
-		if (index != -1):
-			result += output_line[index+1:]
-		result += packages + u'\\usepackage{xepersian}\n'
-		helper_filename = filename + '_farsitex_cmds_xepersian.tex'
-		generate_farsitex_cmds_file(helper_filename,preamble)
-		result += '\\input{' + helper_filename + '}\n'
-		return result
-	#end elif "documentstyle"
-
-	while (index < line_len):
-		next_index = output_line.find(u'\\', index)
-		comment_index = output_line.find(u'%', index)
-		if (next_index == -1):
-			result += output_line[index:]
-			break
-		elif (state == 1):
-			if (output_line[next_index:next_index+14] == u'\\end{verbatim}'):
-				result += output_line[index:next_index+14]
-				index = next_index+14
-				state = 0
-			else:
-				result += output_line[index:next_index+1]
-				index = next_index+1
-		elif (state == 2):
-			if (output_line[next_index:next_index+15] == u'\\end{verbatim*}'):
-				result += output_line[index:next_index+15]
-				index = next_index+15
-				state = 0
-			else:
-				result += output_line[index:next_index+1]
-				index = next_index+1
-		elif (comment_index != -1 and comment_index < next_index):
-			result += output_line[index:]
-			break
-		elif (output_line[next_index:next_index+14] == u"\\input{amssym}"):
-			result += u'\\usepackage{amssymb}'
-			index = next_index+14
-		elif (output_line[next_index:next_index+12] == u"\\input{epsf}"):
-			index = next_index+12
-		elif (output_line[next_index:next_index+15] == u"\\includeepspdf{"):
-			result += u'\\includegraphics{'
-			index = next_index+15
-		elif (output_line[next_index:next_index+16] == u"\\begin{verbatim}"):
-			result += output_line[index:next_index+16]
-			index = next_index+16
-			state = 1
-		elif (output_line[next_index:next_index+17] == u"\\begin{verbatim*}"):
-			result += output_line[index:next_index+17]
-			index = next_index+17
-			state = 2
-		elif (output_line[next_index:next_index+26] == u'\\setlength{\\headrulewidth}'):
-			end_cmd = output_line.find('}', next_index+26)
-			result += u'\\renewcommand{\\headrulewidth}' + output_line[next_index+26:end_cmd+1]
-			index = end_cmd+1
-		elif (output_line[next_index:next_index+26] == u'\\setlength{\\footrulewidth}'):
-			end_cmd = output_line.find('}', next_index+26)
-			result += u'\\renewcommand{\\footrulewidth}' + output_line[next_index+26:end_cmd+1]
-			index = end_cmd+1
-		elif (output_line[next_index:next_index+10] == u"\\epsffile{"):
-			result += output_line[index:next_index]
-			result += u'\\includegraphics'
-			size_options = u''
-			if (line_number - last_epsfxsize_line <= 3):
-				size_options = u'width=' + last_epsfxsize
-			if (line_number - last_epsfysize_line <= 3):
-				if (size_options != u''):
-					size_options += u','
-				size_options += u'height=' + last_epsfysize
-			if (size_options != u''):
-				result += u'[' + size_options + u']'
-			end_prn = output_line.find(u'.eps}', next_index+9)
-
-			if (end_prn != -1):
-				result += output_line[next_index+9:end_prn] + u'}'
-				index = end_prn+5
-			else:
-				end_prn = output_line.find(u'.ps}', next_index+9)
-				if (end_prn != -1):
-					result += output_line[next_index+9:end_prn] + u'}'
-					index = end_prn+4
-				else:
-					end_prn = output_line.find(u'}', next_index+9)
-					result += output_line[next_index+9:end_prn+1]
-					index = end_prn+1
-		# I assume all the parameter of \epsfxsize comes in one line
-		elif (output_line[next_index:next_index+11] == u"\\epsfxsize="):
-			end_size = read_size(output_line, next_index+11, line_len)
-			if (end_size != -1):
-				last_epsfxsize = output_line[next_index+11:end_size]
-				index = end_size
-			else:
-				index = next_index+11
-			last_epsfxsize_line = line_number
-		# I assume all the parameter of \epsfysize comes in one line
-		elif (output_line[next_index:next_index+11] == u"\\epsfysize="):
-			end_size = read_size(output_line, next_index+11, line_len)
-			if (end_size != -1):
-				last_epsfysize = output_line[next_index+11:end_size]
-				index = end_size
-			else:
-				index = next_index+11
-			last_epsfysize_line = line_number
-		elif (output_line[next_index:next_index+10] == u"\\LR{\\verb*"):
-			end_verb = output_line.find(output_line[next_index+10], next_index+11)
-			verb_param = output_line[next_index+11:end_verb]
-			if (is_alpha_numeric(verb_param)):
-				result += output_line[index:next_index]
-				result += u'\\lr{\\tt{}' + verb_param
-			else:
-				result += output_line[index:end_verb+1]
-			index = end_verb+1
-		elif (output_line[next_index:next_index+9] == u"\\LR{\\verb"):
-			end_verb = output_line.find(output_line[next_index+9], next_index+10)
-			verb_param = output_line[next_index+10:end_verb]
-			if (is_alpha_numeric_space(verb_param)):
-				result += output_line[index:next_index]
-				result += u'\\lr{\\tt{}' + verb_param
-			else:
-				result += output_line[index:end_verb+1]
-			index = end_verb+1
-		elif (output_line[next_index:next_index+6] == u"\\verb*"):
-			end_verb = output_line.find(output_line[next_index+6], next_index+7)
-			result += output_line[index:end_verb+1]
-			index = end_verb+1
-		elif (output_line[next_index:next_index+5] == u"\\verb"):
-			end_verb = output_line.find(output_line[next_index+5], next_index+6)
-			result += output_line[index:end_verb+1]
-			index = end_verb+1
-		elif (output_line[next_index:next_index+9] == u"\\pmatrix{"):
-			result += u'\\ftxepmatrix{'
-			index = next_index+9
-		elif (output_line[next_index:next_index+16] == u"\\begin{document}"):
-			result += u'\\begin{document}\n%\\VerbatimFootnotes'
-			index = next_index+16
-		elif (output_line[next_index:next_index+8] == u'\\label {'):
-			begin_param = next_index+8
-			end_param = output_line.find(u'}', begin_param)
-			param = convert_persian_to_english(output_line[begin_param:end_param])
-			result += output_line[index:begin_param-2]
-			result += u'{' + param + u'}'
-			index = end_param+1
-		elif (output_line[next_index:next_index+6] == u'\\ref {'):
-			begin_param = next_index+6
-			end_param = output_line.find(u'}', begin_param)
-			param = convert_persian_to_english(output_line[begin_param:end_param])
-			result += output_line[index:begin_param-2]
-			result += u'{' + param + u'}'
-			index = end_param+1
-		elif (output_line[next_index:next_index+7] == u'\\label{'):
-			begin_param = next_index+7
-			end_param = output_line.find(u'}', begin_param)
-			param = convert_persian_to_english(output_line[begin_param:end_param])
-			result += output_line[index:begin_param]
-			result += param + u'}'
-			index = end_param+1
-		elif (output_line[next_index:next_index+5] == u'\\ref{'):
-			begin_param = next_index+5
-			end_param = output_line.find(u'}', begin_param)
-			param = convert_persian_to_english(output_line[begin_param:end_param])
-			result += output_line[index:begin_param]
-			result += param + u'}'
-			index = end_param+1
-		elif (output_line[next_index:next_index+13] == u'\\multicolumn{'):
-			begin_param = next_index+13
-			end_param = output_line.find(u'}', begin_param)
-			param = convert_persian_to_english(output_line[begin_param:end_param])
-			result += output_line[index:begin_param]
-			result += param + u'}'
-			index = end_param+1
-		elif (output_line[next_index:next_index+12] == u'\\setcounter{'):
-			begin_num = output_line.find(u'{', next_index+12)
-			end_num = output_line.find(u'}', begin_num)
-			num = convert_persian_to_english(output_line[begin_num+1:end_num])
-			result += output_line[index:begin_num+1]
-			result += num + u'}'
-			index = end_num+1
-		elif (output_line[next_index:next_index+14] == u'\\addtocounter{'):
-			begin_num = output_line.find(u'{', next_index+14)
-			end_num = output_line.find(u'}', begin_num)
-			num = convert_persian_to_english(output_line[begin_num+1:end_num])
-			result += output_line[index:begin_num+1]
-			result += num + u'}'
-			index = end_num+1
-		else:
-			result += output_line[index:next_index+2]
-			index = next_index+2
-	#end while
-	return result
-
-###############################################
-# from here all functions are mainly used to
-# convert farsitex format to unicode
-###############################################
-
-def convert_file(f, of, convert_cmds):
-	global state
-	global line_number
-	global last_epsfysize_line
-	global last_epsfxsize_line
-	global last_epsfxsize
-	global last_epsfysize
-	global global_state
-
-	state = 0
-	line_number = 0
-	last_epsfysize_line = 0
-	last_epsfxsize_line = 0
-	last_epsfxsize = u''
-	last_epsfysize = u''
-
-	for line in f:
-		line_number += 1
-		print line_number,
-		output_line = u''
-		line_len = len(line)
-		
-		# remove new-line characters from end of line
-		if (line_len>1 and line[line_len-1] == '\n'):
-			line_len-=1
-		if (line_len>1 and line[line_len-1] == '\r'):
-			line_len-=1
-		
-		# check line-direction character
-		line_direction_rtl = (line[0] == '<')
-		if (line[0] != '>') and (line[0] != '<'):
-			print "FORMAT ERROR AT LINE: " + str(line_number)
-			exit(0)
-	
-		i = 1
-	
-		while (i<line_len):
-			next_part_index = ft_next_part(line, i, line_len)
-			next_part = line[i:next_part_index]
-			next_part_latin = (line[i]<chr(0x80))
-			
-			# see if we should put \lr{...} for the current english expression
-			if (global_state == 0):
-				if line_direction_rtl and next_part_latin:
-					is_command_rtl = (next_part_latin and (i>1) and (line[i-1]==F_SLASH) )
-					is_parameter_rtl = (next_part_latin and (i>1) and (next_part_index<line_len) and (line[i-1]==F_AT_SIGN) and (line[next_part_index]==F_AT_SIGN) )
-					is_math_rtl = (next_part_latin and (line[i]=="$") and (line[next_part_index-1]=="$") )
-					is_verb_parameter = ( (line[i-6:i] == F_SLASH+"verb") and not isalpha(line[i]))
-					is_verb = (next_part_latin and (line[i:i+5]=='\\verb' or line[i:i+6]==' \\verb'))
-					is_english = (next_part_latin and (line[i:i+8]=='\\english'))
-				
-					cmd_index = 0
-					while cmd_index < len(commands):
-						len_cmd = len(commands[cmd_index])+2
-						if ( (i > len_cmd) and (line[i-len_cmd:i] == F_SLASH+commands[cmd_index]+F_PRNT_OPEN) ):
-							break
-						elif ( (i > len_cmd+1) and (line[i-len_cmd-1:i] == F_SLASH+commands[cmd_index]+F_SPACE+F_PRNT_OPEN) ):
-							break
-						cmd_index += 1
-					is_commands_group = cmd_index < len(commands)
-					is_documentstyle_cmd = (line_len > 15) and (line[1:15] == F_SLASH+"documentstyle")
-	
-			if next_part_latin:
-				if (global_state == 0):
-					# whether we should put a \lr{ command
-					if ( line_direction_rtl and not (is_command_rtl or is_parameter_rtl or is_math_rtl or is_commands_group or is_documentstyle_cmd or is_verb_parameter or is_verb or is_english) ):
-						output_line += u'\\lr{'
-					if ( line_direction_rtl and is_verb):
-						output_line += u'\\LR{'
-				
-				# here is the main place that converting happens
-				output_line += next_part.encode( 'utf-8' )
-				
-				if (global_state == 0):
-					# check whether we already used a \lr command: then end it
-					if ( line_direction_rtl and not (is_command_rtl or is_parameter_rtl or is_math_rtl or is_commands_group or is_documentstyle_cmd or is_verb_parameter or is_verb or is_english) ):
-						output_line += u'}'
-					if ( line_direction_rtl and is_verb):
-						output_line += u'}'
-			else:
-				if (global_state == 0):
-					# whether we should put a \rl{} command
-					if ( not line_direction_rtl and not ft_is_all_persian_space(next_part)):
-						output_line += u'\\rl{'
-					
-				# here is the main place that converting happens
-				output_line += map_ft_unicode(next_part)
-				
-				if (global_state == 0):
-					# check whether we already used a \rl command: then end it
-					if (not line_direction_rtl and not ft_is_all_persian_space(next_part)):
-						output_line += u'}'
-					
-			i = next_part_index
-		# end of while			
-
-		#if there was a % commenting then we can return to normal situation
-		if (global_state == 1):
-			global_state = 0
-		
-		# convert some of the FarsiTeX commands to XePersian commands
-		# only if it is requested
-		if (convert_cmds):
-			result = translate_cmds(output_line) 
-		else:
-			result = output_line
-		output_line = result + u'\n'
-		# write the processed line
-		of.write(output_line)
-		# end of line processing
-	# end of file processing
-
-def print_usage():
-	print 'usage: python ftxe-0.9 [-r] [-s] [-x] [-u] in_filename1 in_filename2'
-	print '-r: (DEFAULT) recursively consider files included in the given files'
-	print '-s: do not recursively consider files'
-	print '-x: (DEFAULT) insert xepersian related commands'
-	print '-u: only convert to unicode'
-
-###################################
-# Begin of main body of the program
-###################################
-
-# global variables
-line_number = 0
-last_epsfxsize = u''
-last_epsfxsize_line = 0
-last_epsfysize = u''
-last_epsfysize_line = 0
-state = 0
-global_state = 0
-recursive = 1
-convert_xepersian = 1
-filename = ''
-
-if len(sys.argv) <= 1:
-	print_usage()
-	exit(0)
-
-#find options
-options_index = 1
-while (options_index < len(sys.argv) and sys.argv[options_index][0]=='-'):
-	if (sys.argv[options_index]=='-s'):
-		recursive = 0
-	elif (sys.argv[options_index]=='-u'):
-		convert_xepersian = 0
-	options_index += 1
-
-filenames = []
-while (options_index < len(sys.argv)):
-	filenames.append(sys.argv[options_index])
-	options_index += 1
-
-if (len(filenames) == 0):
-	print 'error: no input filename is specified!'
-	print_usage()
-	exit(0)
-	
-index = 0
-while (index < len(filenames)):
-	filename = filenames[index]
-	index += 1
-
-	outfile = ''
-	if (filename[-4:] != '.tex'):
-		outfile = filename[0:-3] + 'tex'
-	else: 
-		outfile = filename + '.tex'
-
-	print '\n\nConverting "' + filename + '" into "' + outfile + '"'
-	try:
-		f = open(filename, 'r')
-	except IOError:
-		print "Can not open the input file: " + filename
-		exit(0)
-
-	try:
-		of = codecs.open(outfile, encoding='utf-8', mode='w')
-	except IOError:
-		print "Can not open the output file: " + outfile
-		exit(0)
-
-	convert_file(f, of, convert_xepersian)
-
-	of.close()
-	f.close()	

Added: trunk/ftxe-0.11.py
===================================================================
--- trunk/ftxe-0.11.py	2009-07-08 11:07:19 UTC (rev 84)
+++ trunk/ftxe-0.11.py	2009-07-08 23:55:21 UTC (rev 85)
@@ -0,0 +1,1045 @@
+?#  This program is free software: you can redistribute it and/or modify
+#  it under the terms of the GNU General Public License as published by
+#  the Free Software Foundation, either version 3 of the License, or
+#  (at your option) any later version.
+#
+#  This program is distributed in the hope that it will be useful,
+#  but WITHOUT ANY WARRANTY; without even the implied warranty of
+#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+#  GNU General Public License for more details.
+#
+#  You should have received a copy of the GNU General Public License
+#  along with this program. If not, see <http://www.gnu.org/licenses>
+
+##################################################
+#  Author:      Mostafa Vahedi                   #
+#  Date:        06 July 2009                     #
+#  Version:     0-11                             # 
+#  Application: FarsiTeX to XePersian converter  #
+##################################################
+
+import codecs
+
+import sys
+import os
+
+ft_numerical = [
+chr(0xB9),	# 	Arabic Thoushads Seperator
+chr(0xBC)	#	ARABIC DECIMAL SEPARATOR
+]
+
+
+ft_vowels = [
+chr(0xB0),	#	ARABIC FATHA
+chr(0xB1),	#	ARABIC KASRA
+chr(0xB2),	#	ARABIC DAMMA
+chr(0xB3),	#	ARABIC FATHATAN
+chr(0xB4),	#	ARABIC SHADDA
+chr(0xBA),	#	ARABIC LETTER SUPERSCRIPT ALEF
+chr(0xBB),	#	ARABIC HAMZA ABOVE
+chr(0xC4) 	#	ARABIC SUKUN
+]
+
+ft_non_joiners = [
+chr(0x8F)	#	ARABIC LETTER HAMZA
+]
+
+ft_bidi_joiners_initial = [
+chr(0xE4),	#	ARABIC LETTER AIN, initial form
+chr(0xE8),	#	ARABIC LETTER GHAIN, initial form
+chr(0xFB) 	#	ARABIC LETTER HEH, initial form
+]
+
+ft_bidi_joiners_medial = [
+chr(0xE3),	#	ARABIC LETTER AIN, medial form
+chr(0xE7),	#	ARABIC LETTER GHAIN, medial form
+chr(0xFA) 	#	ARABIC LETTER HEH, medial form
+]
+
+ft_bidi_joiners_final = [
+chr(0xE2),	#	ARABIC LETTER AIN, final form
+chr(0xE6),	#	ARABIC LETTER GHAIN, final form
+chr(0xFC) 	#	ARABIC LETTER FARSI YEH, final form
+]
+
+ft_bidi_joiners_isolated = [
+chr(0xE1),	#	ARABIC LETTER AIN, isolated form
+chr(0xE5),	#	ARABIC LETTER GHAIN, isolated form
+chr(0xFD) 	#	ARABIC LETTER FARSI YEH, isolated form
+]
+
+ft_bidi_joiners_initial_medial = [
+chr(0x8B),	#	ARABIC TATWEEL
+chr(0x8E),	#	ARABIC LETTER YEH WITH HAMZA ABOVE, initial-medial form
+chr(0x93),	#	ARABIC LETTER BEH, initial-medial form
+chr(0x95),	#	ARABIC LETTER PEH, initial-medial form
+chr(0x97),	#	ARABIC LETTER TEH, initial-medial form
+chr(0x99),	#	ARABIC LETTER THEH, initial-medial form
+chr(0x9B),	#	ARABIC LETTER JEEM, initial-medial form
+chr(0x9D),	#	ARABIC LETTER TCHEH, initial-medial form
+chr(0x9F),	#	ARABIC LETTER HAH, initial-medial form
+chr(0xA1),	#	ARABIC LETTER KHAH, initial-medial form
+chr(0xA8),	#	ARABIC LETTER SEEN, initial-medial form
+chr(0xAA),	#	ARABIC LETTER SHEEN, initial-medial form
+chr(0xAC),	#	ARABIC LETTER SAD, initial-medial form
+chr(0xAE),	#	ARABIC LETTER DAD, initial-medial form
+chr(0xAF),	#	ARABIC LETTER TAH, initial-medial form
+chr(0xE0),	#	ARABIC LETTER ZAH, initial-medial form
+chr(0xEA),	#	ARABIC LETTER FEH, initial-medial form
+chr(0xEC),	#	ARABIC LETTER QAF, initial-medial form
+chr(0xEE),	#	ARABIC LETTER KEHEH, initial-medial form
+chr(0xF0),	#	ARABIC LETTER GAF, initial-medial form
+chr(0xF3),	#	ARABIC LETTER LAM, initial-medial form
+chr(0xF5),	#	ARABIC LETTER MEEM, initial-medial form
+chr(0xF7),	#	ARABIC LETTER NOON, initial-medial form
+chr(0xFE)	#	ARABIC LETTER FARSI YEH, initial-medial form
+]
+
+ft_bidi_joiners_final_isolated = [
+chr(0x92),	#	ARABIC LETTER BEH, final-isolated form
+chr(0x94),	#	ARABIC LETTER PEH, final-isolated form
+chr(0x96),	#	ARABIC LETTER TEH, final-isolated form
+chr(0x98),	#	ARABIC LETTER THEH, final-isolated form
+chr(0x9A),	#	ARABIC LETTER JEEM, final-isolated form
+chr(0x9C),	#	ARABIC LETTER TCHEH, final-isolated form
+chr(0x9E),	#	ARABIC LETTER HAH, final-isolated form
+chr(0xA0),	#	ARABIC LETTER KHAH, final-isolated form
+chr(0xA7),	#	ARABIC LETTER SEEN, final-isolated form
+chr(0xA9),	#	ARABIC LETTER SHEEN, final-isolated form
+chr(0xAB),	#	ARABIC LETTER SAD, final-isolated form
+chr(0xAD),	#	ARABIC LETTER DAD, final-isolated form
+chr(0xC1),	#	ARABIC LETTER TAH, final-isolated form
+chr(0xC2),	#	ARABIC LETTER ZAH, final-isolated form
+chr(0xE9),	#	ARABIC LETTER FEH, final-isolated form
+chr(0xEB),	#	ARABIC LETTER QAF, final-isolated form
+chr(0xED),	#	ARABIC LETTER KEHEH, final-isolated form
+chr(0xEF),	#	ARABIC LETTER GAF, final-isolated form
+chr(0xF1),	#	ARABIC LETTER LAM, final-isolated form
+chr(0xF4),	#	ARABIC LETTER MEEM, final-isolated form
+chr(0xF6),	#	ARABIC LETTER NOON, final-isolated form
+chr(0xF9) 	#	ARABIC LETTER HEH, final-isolated form
+]
+
+ft_right_joiners_final = [
+chr(0x91)	#	ARABIC LETTER ALEF, final form
+]
+
+ft_right_joiners_isolated = [
+chr(0x8D),	#	ARABIC LETTER ALEF WITH MADDA ABOVE, isolated form
+chr(0x90)	#	ARABIC LETTER ALEF, isolated form
+]
+
+ft_right_joiners_final_isolated = [
+chr(0xA2),	#	ARABIC LETTER DAL
+chr(0xA3),	#	ARABIC LETTER THAL
+chr(0xA4),	#	ARABIC LETTER REH
+chr(0xA5),	#	ARABIC LETTER ZAIN
+chr(0xA6),	#	ARABIC LETTER JEH
+chr(0xBF),	#	ARABIC LETTER TEH MARBUTAH
+chr(0xF2),	#	ARABIC LIGATURE LAM WITH ALEF
+chr(0xF8)	#	ARABIC LETTER WAW
+]
+
+
+table_FT_UN = {
+chr(0x80) : [u'\u06F0'],	#	EXTENDED ARABIC-INDIC DIGIT ZERO
+chr(0x81) : [u'\u06F1'],	#	EXTENDED ARABIC-INDIC DIGIT ONE
+chr(0x82) : [u'\u06F2'],	#	EXTENDED ARABIC-INDIC DIGIT TWO
+chr(0x83) : [u'\u06F3'],	#	EXTENDED ARABIC-INDIC DIGIT THREE
+chr(0x84) : [u'\u06F4'],	#	EXTENDED ARABIC-INDIC DIGIT FOUR
+chr(0x85) : [u'\u06F5'],	#	EXTENDED ARABIC-INDIC DIGIT FIVE
+chr(0x86) : [u'\u06F6'],	#	EXTENDED ARABIC-INDIC DIGIT SIX
+chr(0x87) : [u'\u06F7'],	#	EXTENDED ARABIC-INDIC DIGIT SEVEN
+chr(0x88) : [u'\u06F8'],	#	EXTENDED ARABIC-INDIC DIGIT EIGHT
+chr(0x89) : [u'\u06F9'],	#	EXTENDED ARABIC-INDIC DIGIT NINE
+chr(0x8A) : [u'\u060C'],	#	ARABIC COMMA
+chr(0x8B) : [u'\u0640'],	#	ARABIC TATWEEL
+chr(0x8C) : [u'\u061F'],	#	ARABIC QUESTION MARK
+chr(0x8D) : [u'\u0622'],	#	ARABIC LETTER ALEF WITH MADDA ABOVE, isolated form
+chr(0x8E) : [u'\u0626'],	#	ARABIC LETTER YEH WITH HAMZA ABOVE, initial-medial form
+chr(0x8F) : [u'\u0621'],	#	ARABIC LETTER HAMZA
+chr(0x90) : [u'\u0627'],	#	ARABIC LETTER ALEF, isolated form
+chr(0x91) : [u'\u0627'],	#	ARABIC LETTER ALEF, final form
+chr(0x92) : [u'\u0628'],	#	ARABIC LETTER BEH, final-isolated form
+chr(0x93) : [u'\u0628'],	#	ARABIC LETTER BEH, initial-medial form
+chr(0x94) : [u'\u067E'],	#	ARABIC LETTER PEH, final-isolated form
+chr(0x95) : [u'\u067E'],	#	ARABIC LETTER PEH, initial-medial form
+chr(0x96) : [u'\u062A'],	#	ARABIC LETTER TEH, final-isolated form
+chr(0x97) : [u'\u062A'],	#	ARABIC LETTER TEH, initial-medial form
+chr(0x98) : [u'\u062B'],	#	ARABIC LETTER THEH, final-isolated form
+chr(0x99) : [u'\u062B'],	#	ARABIC LETTER THEH, initial-medial form
+chr(0x9A) : [u'\u062C'],	#	ARABIC LETTER JEEM, final-isolated form
+chr(0x9B) : [u'\u062C'],	#	ARABIC LETTER JEEM, initial-medial form
+chr(0x9C) : [u'\u0686'],	#	ARABIC LETTER TCHEH, final-isolated form
+chr(0x9D) : [u'\u0686'],	#	ARABIC LETTER TCHEH, initial-medial form
+chr(0x9E) : [u'\u062D'],	#	ARABIC LETTER HAH, final-isolated form
+chr(0x9F) : [u'\u062D'],	#	ARABIC LETTER HAH, initial-medial form
+chr(0xA0) : [u'\u062E'],	#	ARABIC LETTER KHAH, final-isolated form
+chr(0xA1) : [u'\u062E'],	#	ARABIC LETTER KHAH, initial-medial form
+chr(0xA2) : [u'\u062F'],	#	ARABIC LETTER DAL
+chr(0xA3) : [u'\u0630'],	#	ARABIC LETTER THAL
+chr(0xA4) : [u'\u0631'],	#	ARABIC LETTER REH
+chr(0xA5) : [u'\u0632'],	#	ARABIC LETTER ZAIN
+chr(0xA6) : [u'\u0698'],	#	ARABIC LETTER JEH
+chr(0xA7) : [u'\u0633'],	#	ARABIC LETTER SEEN, final-isolated form
+chr(0xA8) : [u'\u0633'],	#	ARABIC LETTER SEEN, initial-medial form
+chr(0xA9) : [u'\u0634'],	#	ARABIC LETTER SHEEN, final-isolated form
+chr(0xAA) : [u'\u0634'],	#	ARABIC LETTER SHEEN, initial-medial form
+chr(0xAB) : [u'\u0635'],	#	ARABIC LETTER SAD, final-isolated form
+chr(0xAC) : [u'\u0635'],	#	ARABIC LETTER SAD, initial-medial form
+chr(0xAD) : [u'\u0636'],	#	ARABIC LETTER DAD, final-isolated form
+chr(0xAE) : [u'\u0636'],	#	ARABIC LETTER DAD, initial-medial form
+chr(0xAF) : [u'\u0637'],	#	ARABIC LETTER TAH, initial-medial form
+chr(0xB0) : [u'\u064E'],	#	ARABIC FATHA
+chr(0xB1) : [u'\u0650'],	#	ARABIC KASRA
+chr(0xB2) : [u'\u064F'],	#	ARABIC DAMMA
+chr(0xB3) : [u'\u064B'],	#	ARABIC FATHATAN
+chr(0xB4) : [u'\u0651'],	#	ARABIC SHADDA
+chr(0xB5) : [u'\u0023'],	# * #
+chr(0xB6) : [u'\u0024'],	# * $
+chr(0xB7) : [u'\u0025'],	# * %
+chr(0xB8) : [u'\u0026'],	# * &
+chr(0xB9) : [u'\u066C'],	# 	Arabic Thoushads Seperator
+chr(0xBA) : [u'\u0670'],	#	ARABIC LETTER SUPERSCRIPT ALEF
+chr(0xBB) : [u'\u0654'],	#	ARABIC HAMZA ABOVE
+chr(0xBC) : [u'\u066B'],	#	ARABIC DECIMAL SEPARATOR
+chr(0xBD) : [u'\u0029'],	# * RIGHT PARENTHESIS
+chr(0xBE) : [u'\u0028'],	# * LEFT PARENTHESIS
+chr(0xBF) : [u'\u0629'],	#	ARABIC LETTER TEH MARBUTAH
+chr(0xC0) : [u'\u00BB'],	#	RIGHT-POINTING DOUBLE ANGLE QUOTATION MARK
+chr(0xC1) : [u'\u0637'],	#	ARABIC LETTER TAH, final-isolated form
+chr(0xC2) : [u'\u0638'],	#	ARABIC LETTER ZAH, final-isolated form
+chr(0xC3) : [u'\u00AB'],	#	LEFT-POINTING DOUBLE ANGLE QUOTATION MARK
+chr(0xC4) : [u'\u0652'],	#	ARABIC SUKUN
+chr(0xC5) : [u'\u002D'],	# * -
+chr(0xC6) : [u'\u002E'],	# * FULL STOP
+chr(0xC7) : [u'\u002F'],	# * /
+chr(0xC8) : [u'\u002A'],	# * *
+chr(0xC9) : [u'\u007E'],	# * ~
+chr(0xCA) : [u'\u003A'],	# * COLON
+chr(0xCB) : [u'\u061B'],	# 	ARABIC SEMICOLON
+chr(0xCC) : [u'\u003E'],	# * GREATER-THAN SIGN
+chr(0xCD) : [u'\u002B'],	# * +
+chr(0xCE) : [u'\u003D'],	# * =
+chr(0xCF) : [u'\u003C'],	# * LESS-THAN SIGN
+# chr(0xD0) : [u'\u0040'],	# * @
+chr(0xD0) : [u''],	        # * @
+chr(0xD1) : [u'\u005D'],	# * [
+chr(0xD2) : [u'\u005C'],	# * \
+chr(0xD3) : [u'\u005B'],	# * ]
+chr(0xD4) : [u'\u005E'],	# * ^
+chr(0xD5) : [u'\u005F'],	# * _
+chr(0xD6) : [u'\u0060'],	# * `
+chr(0xD7) : [u'\u007D'],	# * {
+chr(0xD8) : [u'\u007C'],	# * |
+chr(0xDA) : [u'\u0020'],	# * SPACE
+chr(0xDD) : [u'\u0021'],	# * EXCLAMATION MARK
+chr(0xDE) : [u'\u007B'],	# * }
+chr(0xE0) : [u'\u0638'],	#	ARABIC LETTER ZAH, initial-medial form
+chr(0xE1) : [u'\u0639'],	#	ARABIC LETTER AIN, isolated form
+chr(0xE2) : [u'\u0639'],	#	ARABIC LETTER AIN, final form
+chr(0xE3) : [u'\u0639'],	#	ARABIC LETTER AIN, medial form
+chr(0xE4) : [u'\u0639'],	#	ARABIC LETTER AIN, initial form
+chr(0xE5) : [u'\u063A'],	#	ARABIC LETTER GHAIN, isolated form
+chr(0xE6) : [u'\u063A'],	#	ARABIC LETTER GHAIN, final form
+chr(0xE7) : [u'\u063A'],	#	ARABIC LETTER GHAIN, medial form
+chr(0xE8) : [u'\u063A'],	#	ARABIC LETTER GHAIN, initial form
+chr(0xE9) : [u'\u0641'],	#	ARABIC LETTER FEH, final-isolated form
+chr(0xEA) : [u'\u0641'],	#	ARABIC LETTER FEH, initial-medial form
+chr(0xEB) : [u'\u0642'],	#	ARABIC LETTER QAF, final-isolated form
+chr(0xEC) : [u'\u0642'],	#	ARABIC LETTER QAF, initial-medial form
+chr(0xED) : [u'\u06A9'],	#	ARABIC LETTER KEHEH, final-isolated form
+chr(0xEE) : [u'\u06A9'],	#	ARABIC LETTER KEHEH, initial-medial form
+chr(0xEF) : [u'\u06AF'],	#	ARABIC LETTER GAF, final-isolated form
+chr(0xF0) : [u'\u06AF'],	#	ARABIC LETTER GAF, initial-medial form
+chr(0xF1) : [u'\u0644'],	#	ARABIC LETTER LAM, final-isolated form
+chr(0xF2) : [u'\u0644\u0627'],	#	ARABIC LIGATURE LAM WITH ALEF
+chr(0xF3) : [u'\u0644'],	#	ARABIC LETTER LAM, initial-medial form
+chr(0xF4) : [u'\u0645'],	#	ARABIC LETTER MEEM, final-isolated form
+chr(0xF5) : [u'\u0645'],	#	ARABIC LETTER MEEM, initial-medial form
+chr(0xF6) : [u'\u0646'],	#	ARABIC LETTER NOON, final-isolated form
+chr(0xF7) : [u'\u0646'],	#	ARABIC LETTER NOON, initial-medial form
+chr(0xF8) : [u'\u0648'],	#	ARABIC LETTER WAW
+chr(0xF9) : [u'\u0647'],	#	ARABIC LETTER HEH, final-isolated form
+chr(0xFA) : [u'\u0647'],	#	ARABIC LETTER HEH, medial form
+chr(0xFB) : [u'\u0647'],	#	ARABIC LETTER HEH, initial form
+chr(0xFC) : [u'\u06CC'],	#	ARABIC LETTER FARSI YEH, final form
+chr(0xFD) : [u'\u06CC'],	#	ARABIC LETTER FARSI YEH, isolated form
+chr(0xFE) : [u'\u06CC']		#	ARABIC LETTER FARSI YEH, initial-medial form
+}
+
+F_PERCENT_SIGN = chr(0xB7)
+F_AT_SIGN = chr(0xD0)
+F_SLASH = chr(0xD2)
+F_SPACE = chr(0xDA)
+F_PRNT_OPEN = chr(0xDE)
+F_PRNT_CLOSE = chr(0xD7)
+
+# latex and farsitex commands whose first parameter does not need \lr{...}
+commands = [ 
+"begin", "end",
+"input", "include", "includeonly",
+"hspace", "vspace", "hspace*", "vspace*",
+"label", "ref", "cite", "bibitem",
+"bibliographystyle",
+"parbox",
+"newenvironment", "newtheorem",
+"persianmathdigitsfamily",
+"fontfamily", "fontseries", "fontshape",
+"rmdefault", "sfdefault", "ttdefault",
+"bfdefault", "itdefault", "sldefault", "scdefault",
+"pagenumbering", "pagestyle", "thispagestyle",
+"setcounter", "stepcounter", "setlength", "addtolength"
+]
+
+def ft_is_all_persian_space(next_part):
+	l = len(next_part)
+	i = 0
+	while (i < l):
+		if (next_part[i] != F_SPACE):
+			return 0
+		i += 1
+	return 1
+
+def ft_is_numeric(ch):
+	if ((ch in ft_numerical) or 
+	    ((ch >= chr(0x80)) and (ch <= chr(0x89))) ):
+		return 1
+	return 0
+
+def ft_can_join_left(ch):
+	if ((ch in ft_bidi_joiners_initial) or
+	    (ch in ft_bidi_joiners_medial) or
+	    (ch in ft_bidi_joiners_final) or
+	    (ch in ft_bidi_joiners_isolated) or
+	    (ch in ft_bidi_joiners_initial_medial) or
+	    (ch in ft_bidi_joiners_final_isolated)):
+    		return 1
+	return 0
+
+def ft_can_join_right(ch):
+	if (ft_can_join_left(ch) or 
+	    (ch in ft_right_joiners_final) or
+	    (ch in ft_right_joiners_isolated) or
+	    (ch in ft_right_joiners_final_isolated)):
+		return 1
+	return 0
+
+def ft_joining_left(ch):
+	if ((ch in ft_bidi_joiners_initial) or 
+	    (ch in ft_bidi_joiners_medial) or
+	    (ch in ft_bidi_joiners_initial_medial)):
+		return 1
+	return 0
+
+
+def ft_joining_right(ch):
+	if ((ch in ft_right_joiners_final) or
+	    (ch in ft_bidi_joiners_medial) or 
+	    (ch in ft_bidi_joiners_final)):
+		return 1
+	return 0
+
+def ft_not_right_joined(ch):
+	if ((ch in ft_bidi_joiners_initial) or
+	    (ch in ft_right_joiners_isolated) or
+	    (ch in ft_bidi_joiners_isolated)):
+		return 1
+	return 0
+
+def ft_adjust_shaping(text, i):
+	current = text[i]
+	u = u''
+	try:
+		u = table_FT_UN[current][0]
+	except KeyError:
+		return u''
+
+	#if you don't want shaping remove the following comment
+	#return u
+
+	if ((current in ft_vowels) or (ft_is_numeric(current))):
+		return u
+
+	#find next non-vowel character on the left
+	text_len = len(text)
+	next_index = i+1
+	while ((next_index < text_len) and (text[next_index] in ft_vowels)):
+		next_index += 1
+
+	if (next_index == text_len):
+		next = ''
+	else:
+		next = text[next_index]
+
+	# if current letter is joining from left but next letter is or can not joining
+	if (ft_joining_left(current)):
+		if (not ft_can_join_right(next)):
+			u += u'\u200D' #ZWJ
+		elif (ft_not_right_joined(next)):
+			u += u'\u200D\u200C' #ZWJ+ZWNJ
+	# if current letter can join but next letter is joining from right
+	elif (ft_can_join_left(current)):
+		if (ft_joining_right(next)):
+			u += u'\u200C\u200D' #ZWNJ+ZWJ
+		elif (ft_can_join_right(next)):
+			u += u'\u200C' #ZWNJ
+	return u
+
+def ft_adjust_number(text):
+	result = u''
+	i = len(text)-1
+	while (i >= 0):
+		result += ft_adjust_shaping(text, i)
+		i -= 1
+	return result
+
+
+def map_ft_unicode(text):
+	mapped_text = u''
+
+	i = 0
+	while (i < len(text)):
+		if (ft_is_numeric(text[i])):
+			next_index = i
+			while ((next_index+1 < len(text)) and
+			       (ft_is_numeric(text[next_index+1]))):
+				next_index += 1
+			mapped_text += ft_adjust_number(text[i:next_index+1])
+			i = next_index+1
+			continue
+
+		mapped_text += ft_adjust_shaping(text, i)
+		i += 1
+	return mapped_text
+
+# Finds next token all of the same language
+def ft_next_part(line, i, line_len):
+	global global_state
+	global recursive
+	global filenames
+	
+	j = i
+	language_flag = (line[j]<chr(0x80))
+	while ((j<line_len) and ((line[j]<chr(0x80)) == language_flag) ):
+		if ( (global_state == 0) and ( (line[j] == '%') or (line[j] == F_PERCENT_SIGN) ) and (line[j-1] != '\\') and (line[j-1] != F_SLASH) ):
+			global_state = 1
+		elif ((global_state == 0) and ((line[j:j+16] == '\\begin{verbatim}') or (line[j:j+17] == '\\begin{verbatim*}'))):
+			global_state = 2
+		elif ((global_state == 2) and ((line[j:j+14] == '\\end{verbatim}') or (line[j:j+15] == '\\end{verbatim*}'))):
+			global_state = 0
+		elif ((global_state == 0) and (line[j:j+6] == '\\verb*')):
+			next_index = line.find(line[j+6], j+7)
+			j = next_index
+		elif ((global_state == 0) and (line[j:j+5] == '\\verb')):
+			next_index = line.find(line[j+5], j+6)
+			j = next_index
+		elif (recursive == 1):
+			if ((global_state == 0) and (line[j:j+9] == '\\include{')):
+				next_index = line.find('}', j+9)
+				filename = line[j+10:next_index-1] + '.ftx'
+				if (os.path.exists(filename) and not filename in filenames):
+					filenames.append(filename)
+			elif ((global_state == 0) and (line[j:j+7] == '\\input{')):
+				next_index = line.find('}', j+7)
+				filename = line[j+8:next_index-1] + '.ftx'
+				if (os.path.exists(filename) and not filename in filenames):
+					filenames.append(filename)
+			elif ((global_state == 0) and (line[j:j+9] == F_SLASH + 'include' + F_PRNT_OPEN)):
+				next_index = line.find(F_PRNT_CLOSE, j+9)
+				if (line[j+9]!=F_AT_SIGN):
+					filename = line[j+9:next_index] + '.ftx'
+				else:
+					filename = line[j+10:next_index-1] + '.ftx'
+				if (os.path.exists(filename) and not filename in filenames):
+					filenames.append(filename)
+			elif ((global_state == 0) and (line[j:j+7] == F_SLASH + 'input' + F_PRNT_OPEN)):
+				next_index = line.find(F_PRNT_CLOSE, j+7)
+				if (line[j+7]!=F_AT_SIGN):
+					filename = line[j+7:next_index] + '.ftx'
+				else:
+					filename = line[j+8:next_index-1] + '.ftx'
+				if (os.path.exists(filename) and not filename in filenames):
+					filenames.append(filename)
+		j += 1
+	return j
+
+###############################################
+# from here all functions are used to translate
+# farsitex commands to xepersian commands
+###############################################
+
+def read_size(input,index,last_index):
+	dim_index = -1 
+	inch_index = input.find(u'in', index)
+	if (inch_index != -1):
+		dim_index = inch_index
+	mm_index = input.find(u'mm', index)
+	if (mm_index != -1):
+		if (dim_index == -1 or mm_index < index):
+			dim_index = mm_index
+	cm_index = input.find(u'cm', index)
+	if (cm_index != -1):
+		if (dim_index == -1 or cm_index < dim_index):
+			dim_index = cm_index
+	pt_index = input.find(u'pt', index)
+	if (pt_index != -1):
+		if (dim_index == -1 or pt_index < dim_index):
+			dim_index = pt_index
+	next_cmd = input.find(u'\\', index)
+	if (next_cmd == -1 and dim_index == -1):
+		print "Error in parsing \epsfxsize command at " + str(line_number) + "\n"
+		return -1
+	elif (next_cmd == -1 or (dim_index != -1 and next_cmd > dim_index)):
+		epsfxsize = input[index:dim_index+2]
+		return dim_index+2
+	elif (next_cmd != -1):
+		end_cmd = next_cmd+1
+		while (end_cmd < last_index and input[end_cmd].isalpha()):
+			end_cmd += 1
+		return end_cmd
+	else:
+		print "Error in parsing \epsfxsize command at " + str(line_number) + "\n"
+		return -1
+
+
+latex_options=[u'a4paper', u'a5paper', u'b5paper', 
+			   u'letterpaper', u'legalpaper', u'executivepaper', 
+			   u'landscape', u'10pt', u'11pt', u'12pt', 
+			   u'oneside', u'twoside', u'draft', 
+			   u'final', u'titlepage', u'notitlepage',
+			   u'onecolumn', u'twocolumn',
+			   u'leqno', u'fleqn']
+
+table_eq_packages = {
+u'poem'     : u'persianpoem',
+u'fmakeidx' : u'makeidx',
+u'ffancyhe' : u'fancyhdr',
+u'fmultico' : u'multicol'
+}
+
+farsitex_ignore_options = [u'persian', u'farsi', u'epsf', u'fgraphix', u'lotusfont']
+
+xepersian_packages = u'\n\\usepackage{url}\n%\\usepackage{fancyvrb}\n\\usepackage{setspace}\\doublespacing\n\\usepackage{graphicx} \n\\usepackage{amssymb}\n'
+
+xepersian_preamble = u'\\settextfont[Scale=1.2]{XB Zar}\n\\setlatintextfont[Scale=1.1]{Times New Roman}\n\\setdigitfont{XB Zar}\n\\setpookfont{XB Kayhan Pook}\n\\setsayehfont{XB Kayhan Sayeh}\n\\defpersianfont\\lotoos[Scale=1.2]{XB Roya}\n\\defpersianfont\elmi[Scale=1.2]{XB Roya} \n\\def\\nazok{\\normalfont\\normalsize}\n\\let\\iranic\\it\n\\let\\siah\\bf\n\\let\\khabide\\sl\n\\def\\siahir{\\siah\\iranic} \n\\def\\siahkh{\\siah\\khabide}\n\\let\\tookhali\\pookfamily\n\\let\\sayedar\\sayehfamily\n\\let\\farsi\\Persian\n\\let\\english\\Latin \n\\let\\farmbox\\mbox\n\\newcommand{\\ftxepmatrix}[1]{\\begin{pmatrix}#1\\end{pmatrix}}\n\\newcommand{\\ftxematrix}[1]{\\begin{matrix}#1\\end{matrix}} \n\\def\\FarsiTeX{\\lr{FarsiTeX}}\n\\def\\????????{\\rl{?????????}}\n\\def\\InE{\\begingroup\\beginL\\latinfont}\n\\def\\EnE{\\endL\\endgroup} \n\\def\\InF{\\begingroup\\beginR\\persianfont}\n\\def\\EnF{\\endR\\endgroup}\n\\newcommand{\\IE}[1]{\\lr{#1}}\n\\newcommand{\\!
 IP}[1]{\\rl{#1}} \n\\newcommand{\\IF}[1]{\\rl{#1}}\n\\def\\persiandash{\\rl{-}} \n\\def\\DeclareRobustBiCommand#1#2#3#4{\\DeclareRobustCommand#1{\\if at rl{}#4\\else{}#3\\fi}\\let#2=#1} \n\\catcode`\\?=3\n\\catcode`?=11\n\\newcommand\\dotsectionseparator{\\SepMark{.}}\n\\newcommand\\dashsectionseparator{\\SepMark{-}}\n'
+
+thesis_preamble = u'\\university{\\lr{UniversityName}}\n\\city{\\lr{CityName}}\n\\latinuniversity{UniversityName}\n\\latincity{CityName} \n\\let\\englishtitle\\latintitle\n\\let\\englishauthor\\latinauthor\n\\let\\englishdegree\\latindegree\n\\let\\englishthesisdate\\latinthesisdate \n\\let\\englishsupervisor\\latinsupervisor\n\\let\\englishdepartment\\latindepartment\n\\let\\makeenglishtitle\\makelatintitle \n\\let\\englishkeywords\\latinkeywords\n\\newenvironment{englishabstract}{\\begin{latinabstract}}{\\end{latinabstract}}\n'
+
+def is_alpha_numeric_space(input):
+	input_len = len(input)
+	i = 0
+	while (i<input_len):
+		if (not (input[i].isalpha() or input[i].isdigit() or input[i]==u'.' or input[i]==u' ') ):
+			return 0
+		i+=1
+	return 1
+
+def is_alpha_numeric(input):
+	input_len = len(input)
+	i = 0
+	while (i<input_len):
+		if (not (input[i].isalpha() or input[i].isdigit() or input[i]=='.') ):
+			return 0
+		i+=1
+	return 1
+			
+def find_eq_cmd(keyword):
+	try:
+		eq_cmd = table_eq_packages[keyword]
+	except KeyError:
+		eq_cmd = u''
+	return eq_cmd
+
+def convert_persian_to_english(num):
+	result = u''
+	num_len = len(num)
+	index = 0
+	while (index < num_len):
+		if (ord(num[index]) >= ord(u'?') and ord(num[index]) <= ord(u'?')):
+			result += unichr(ord(num[index]) - ord(u'?') + ord(u'0'))
+		else:
+			result += num[index]
+		index += 1
+	return result
+
+def generate_farsitex_cmds_file(helper_filename,preamble):
+	try:
+		of = codecs.open(helper_filename, encoding='utf-8', mode='w')
+	except IOError:
+		print "Can not open the output file: " + helper_filename
+		exit(0)
+	of.write(preamble)
+	of.close
+
+
+# \verb|| -> \item[\verb||] or \section{\verb||}
+# \kasre{} \alef{} ...
+def translate_cmds(output_line):
+	global last_epsfxsize
+	global last_epsfxsize_line
+	global last_epsfysize
+	global last_epsfysize_line
+	global state
+	global filename
+
+	result = u''
+	line_len = len(output_line)
+	index = 0
+	if (state == 1): #\begin{verbatim}
+		end_verbatim = output_line.find('\\end{verbatim}')
+		if (end_verbatim == -1):
+			return output_line
+		result += output_line[0:end_verbatim+14]
+		index = end_verbatim+14
+		state = 0
+	elif (state == 2): #\begin{verbatim*}
+		end_verbatim = output_line.find('\\end{verbatim*}')
+		if (end_verbatim == -1):
+			return output_line
+		result += output_line[0:end_verbatim+15]
+		index = end_verbatim+15
+		state = 0
+	elif (output_line[0:14] == "\\documentstyle"):
+		result += u'\\documentclass'
+		#process options
+		last_index = output_line.find(u']')
+		index = 15
+		first_option = 1
+		preamble = xepersian_preamble
+		packages = xepersian_packages
+		xe_document_class = u''
+		while (index < last_index):
+			next_comma = output_line.find(u',',index,last_index)
+			if (next_comma == -1):
+				next_comma = last_index
+			first_of_option = index
+			while (output_line[first_of_option] == u' '):
+				first_of_option += 1
+			end_of_option = next_comma
+			while (output_line[end_of_option-1] == u' '):
+				end_of_option -= 1
+			option = output_line[first_of_option:end_of_option]
+			index = next_comma+1
+			eq_cmd = find_eq_cmd(option)
+			if (eq_cmd != u''):
+				packages += u'\\usepackage{' + eq_cmd + u'}\n'
+				continue
+			elif (option in farsitex_ignore_options):
+				continue
+			elif (option == u'sharifth'):
+				xe_document_class = u'xepersian-thesis'
+				preamble += thesis_preamble
+				continue
+			elif (not option in latex_options):
+				packages += u'\\usepackage{' + option + u'}\n'
+				continue
+	
+			if (first_option):
+				result += u'['
+			else:
+				result += u','
+			result += option
+			first_option = 0
+		#end while
+		if (not first_option):
+			result += u']'
+		# process document style into document class
+		index = output_line.find(u'}',last_index)
+		document_class = output_line[last_index+2:index]
+		if (xe_document_class != u''):
+			result += u'{' + xe_document_class + u'}'
+		elif (document_class == u'oldarticle'):
+			result += u'{article}'
+		elif (document_class == u'oldbook'):
+			result += u'{book}'
+		elif (document_class == u'oldreport'):
+			result += u'{report}'
+		else:
+			result += u'{' + document_class + u'}'
+		# I assume that nothing important is after
+		# \documentstyle[...]{...}, otherwise it may conflict
+		# with our preamble
+		if (index != -1):
+			result += output_line[index+1:]
+		result += packages + u'\\usepackage{xepersian}\n'
+		helper_filename = filename + '_farsitex_cmds_xepersian.tex'
+		generate_farsitex_cmds_file(helper_filename,preamble)
+		result += '\\input{' + helper_filename + '}\n'
+		return result
+	#end elif "documentstyle"
+
+	while (index < line_len):
+		next_index = output_line.find(u'\\', index)
+		comment_index = output_line.find(u'%', index)
+		if (next_index == -1):
+			result += output_line[index:]
+			break
+		elif (state == 1):
+			if (output_line[next_index:next_index+14] == u'\\end{verbatim}'):
+				result += output_line[index:next_index+14]
+				index = next_index+14
+				state = 0
+			else:
+				result += output_line[index:next_index+1]
+				index = next_index+1
+		elif (state == 2):
+			if (output_line[next_index:next_index+15] == u'\\end{verbatim*}'):
+				result += output_line[index:next_index+15]
+				index = next_index+15
+				state = 0
+			else:
+				result += output_line[index:next_index+1]
+				index = next_index+1
+		elif (comment_index != -1 and comment_index < next_index):
+			result += output_line[index:]
+			break
+		elif (output_line[next_index:next_index+14] == u"\\input{amssym}"):
+			result += u'\\usepackage{amssymb}'
+			index = next_index+14
+		elif (output_line[next_index:next_index+12] == u"\\input{epsf}"):
+			index = next_index+12
+		elif (output_line[next_index:next_index+15] == u"\\includeepspdf{"):
+			result += u'\\includegraphics{'
+			index = next_index+15
+		elif (output_line[next_index:next_index+16] == u"\\begin{verbatim}"):
+			result += output_line[index:next_index+16]
+			index = next_index+16
+			state = 1
+		elif (output_line[next_index:next_index+17] == u"\\begin{verbatim*}"):
+			result += output_line[index:next_index+17]
+			index = next_index+17
+			state = 2
+		elif (output_line[next_index:next_index+26] == u'\\setlength{\\headrulewidth}'):
+			end_cmd = output_line.find('}', next_index+26)
+			result += u'\\renewcommand{\\headrulewidth}' + output_line[next_index+26:end_cmd+1]
+			index = end_cmd+1
+		elif (output_line[next_index:next_index+26] == u'\\setlength{\\footrulewidth}'):
+			end_cmd = output_line.find('}', next_index+26)
+			result += u'\\renewcommand{\\footrulewidth}' + output_line[next_index+26:end_cmd+1]
+			index = end_cmd+1
+		elif (output_line[next_index:next_index+10] == u"\\epsffile{"):
+			result += output_line[index:next_index]
+			result += u'\\includegraphics'
+			size_options = u''
+			if (line_number - last_epsfxsize_line <= 3):
+				size_options = u'width=' + last_epsfxsize
+			if (line_number - last_epsfysize_line <= 3):
+				if (size_options != u''):
+					size_options += u','
+				size_options += u'height=' + last_epsfysize
+			if (size_options != u''):
+				result += u'[' + size_options + u']'
+			end_prn = output_line.find(u'.eps}', next_index+9)
+
+			if (end_prn != -1):
+				result += output_line[next_index+9:end_prn] + u'}'
+				index = end_prn+5
+			else:
+				end_prn = output_line.find(u'.ps}', next_index+9)
+				if (end_prn != -1):
+					result += output_line[next_index+9:end_prn] + u'}'
+					index = end_prn+4
+				else:
+					end_prn = output_line.find(u'}', next_index+9)
+					result += output_line[next_index+9:end_prn+1]
+					index = end_prn+1
+		# I assume all the parameter of \epsfxsize comes in one line
+		elif (output_line[next_index:next_index+11] == u"\\epsfxsize="):
+			end_size = read_size(output_line, next_index+11, line_len)
+			if (end_size != -1):
+				last_epsfxsize = output_line[next_index+11:end_size]
+				index = end_size
+			else:
+				index = next_index+11
+			last_epsfxsize_line = line_number
+		# I assume all the parameter of \epsfysize comes in one line
+		elif (output_line[next_index:next_index+11] == u"\\epsfysize="):
+			end_size = read_size(output_line, next_index+11, line_len)
+			if (end_size != -1):
+				last_epsfysize = output_line[next_index+11:end_size]
+				index = end_size
+			else:
+				index = next_index+11
+			last_epsfysize_line = line_number
+		elif (output_line[next_index:next_index+10] == u"\\LR{\\verb*"):
+			end_verb = output_line.find(output_line[next_index+10], next_index+11)
+			verb_param = output_line[next_index+11:end_verb]
+			if (is_alpha_numeric(verb_param)):
+				result += output_line[index:next_index]
+				result += u'\\lr{\\tt{}' + verb_param
+			else:
+				result += output_line[index:end_verb+1]
+			index = end_verb+1
+		elif (output_line[next_index:next_index+9] == u"\\LR{\\verb"):
+			end_verb = output_line.find(output_line[next_index+9], next_index+10)
+			verb_param = output_line[next_index+10:end_verb]
+			if (is_alpha_numeric_space(verb_param)):
+				result += output_line[index:next_index]
+				result += u'\\lr{\\tt{}' + verb_param
+			else:
+				result += output_line[index:end_verb+1]
+			index = end_verb+1
+		elif (output_line[next_index:next_index+6] == u"\\verb*"):
+			end_verb = output_line.find(output_line[next_index+6], next_index+7)
+			result += output_line[index:end_verb+1]
+			index = end_verb+1
+		elif (output_line[next_index:next_index+5] == u"\\verb"):
+			end_verb = output_line.find(output_line[next_index+5], next_index+6)
+			result += output_line[index:end_verb+1]
+			index = end_verb+1
+		elif (output_line[next_index:next_index+9] == u"\\pmatrix{"):
+			result += u'\\ftxepmatrix{'
+			index = next_index+9
+		elif (output_line[next_index:next_index+8] == u"\\matrix{"):
+			result += u'\\ftxematrix{'
+			index = next_index+8
+		elif (output_line[next_index:next_index+16] == u"\\begin{document}"):
+			result += u'\\begin{document}\n%\\VerbatimFootnotes'
+			index = next_index+16
+		elif (output_line[next_index:next_index+8] == u'\\label {'):
+			begin_param = next_index+8
+			end_param = output_line.find(u'}', begin_param)
+			param = convert_persian_to_english(output_line[begin_param:end_param])
+			result += output_line[index:begin_param-2]
+			result += u'{' + param + u'}'
+			index = end_param+1
+		elif (output_line[next_index:next_index+6] == u'\\ref {'):
+			begin_param = next_index+6
+			end_param = output_line.find(u'}', begin_param)
+			param = convert_persian_to_english(output_line[begin_param:end_param])
+			result += output_line[index:begin_param-2]
+			result += u'{' + param + u'}'
+			index = end_param+1
+		elif (output_line[next_index:next_index+7] == u'\\label{'):
+			begin_param = next_index+7
+			end_param = output_line.find(u'}', begin_param)
+			param = convert_persian_to_english(output_line[begin_param:end_param])
+			result += output_line[index:begin_param]
+			result += param + u'}'
+			index = end_param+1
+		elif (output_line[next_index:next_index+5] == u'\\ref{'):
+			begin_param = next_index+5
+			end_param = output_line.find(u'}', begin_param)
+			param = convert_persian_to_english(output_line[begin_param:end_param])
+			result += output_line[index:begin_param]
+			result += param + u'}'
+			index = end_param+1
+		elif (output_line[next_index:next_index+13] == u'\\multicolumn{'):
+			begin_param = next_index+13
+			end_param = output_line.find(u'}', begin_param)
+			param = convert_persian_to_english(output_line[begin_param:end_param])
+			result += output_line[index:begin_param]
+			result += param + u'}'
+			index = end_param+1
+		elif (output_line[next_index:next_index+12] == u'\\setcounter{'):
+			begin_num = output_line.find(u'{', next_index+12)
+			end_num = output_line.find(u'}', begin_num)
+			num = convert_persian_to_english(output_line[begin_num+1:end_num])
+			result += output_line[index:begin_num+1]
+			result += num + u'}'
+			index = end_num+1
+		elif (output_line[next_index:next_index+14] == u'\\addtocounter{'):
+			begin_num = output_line.find(u'{', next_index+14)
+			end_num = output_line.find(u'}', begin_num)
+			num = convert_persian_to_english(output_line[begin_num+1:end_num])
+			result += output_line[index:begin_num+1]
+			result += num + u'}'
+			index = end_num+1
+		else:
+			result += output_line[index:next_index+2]
+			index = next_index+2
+	#end while
+	return result
+
+###############################################
+# from here all functions are mainly used to
+# convert farsitex format to unicode
+###############################################
+
+def convert_file(f, of, convert_cmds):
+	global state
+	global line_number
+	global last_epsfysize_line
+	global last_epsfxsize_line
+	global last_epsfxsize
+	global last_epsfysize
+	global global_state
+
+	state = 0
+	line_number = 0
+	last_epsfysize_line = 0
+	last_epsfxsize_line = 0
+	last_epsfxsize = u''
+	last_epsfysize = u''
+
+	for line in f:
+		line_number += 1
+		print line_number,
+		output_line = u''
+		line_len = len(line)
+		
+		# remove new-line characters from end of line
+		if (line_len>1 and line[line_len-1] == '\n'):
+			line_len-=1
+		if (line_len>1 and line[line_len-1] == '\r'):
+			line_len-=1
+		
+		# check line-direction character
+		line_direction_rtl = (line[0] == '<')
+		if (line[0] != '>') and (line[0] != '<'):
+			print "FORMAT ERROR AT LINE: " + str(line_number)
+			exit(0)
+	
+		i = 1
+	
+		while (i<line_len):
+			next_part_index = ft_next_part(line, i, line_len)
+			next_part = line[i:next_part_index]
+			next_part_latin = (line[i]<chr(0x80))
+			
+			# see if we should put \lr{...} for the current english expression
+			if (global_state == 0):
+				if line_direction_rtl and next_part_latin:
+					is_command_rtl = (next_part_latin and (i>1) and (line[i-1]==F_SLASH) )
+					is_parameter_rtl = (next_part_latin and (i>1) and (next_part_index<line_len) and (line[i-1]==F_AT_SIGN) and (line[next_part_index]==F_AT_SIGN) )
+					is_math_rtl = (next_part_latin and (line[i]=="$") and (line[next_part_index-1]=="$") )
+					is_verb_parameter = ( (line[i-6:i] == F_SLASH+"verb") and not isalpha(line[i]))
+					is_verb = (next_part_latin and (line[i:i+5]=='\\verb' or line[i:i+6]==' \\verb'))
+					is_english = (next_part_latin and (line[i:i+8]=='\\english'))
+				
+					cmd_index = 0
+					while cmd_index < len(commands):
+						len_cmd = len(commands[cmd_index])+2
+						if ( (i > len_cmd) and (line[i-len_cmd:i] == F_SLASH+commands[cmd_index]+F_PRNT_OPEN) ):
+							break
+						elif ( (i > len_cmd+1) and (line[i-len_cmd-1:i] == F_SLASH+commands[cmd_index]+F_SPACE+F_PRNT_OPEN) ):
+							break
+						cmd_index += 1
+					is_commands_group = cmd_index < len(commands)
+					is_documentstyle_cmd = (line_len > 15) and (line[1:15] == F_SLASH+"documentstyle")
+	
+			if next_part_latin:
+				if (global_state == 0):
+					# whether we should put a \lr{ command
+					if ( line_direction_rtl and not (is_command_rtl or is_parameter_rtl or is_math_rtl or is_commands_group or is_documentstyle_cmd or is_verb_parameter or is_verb or is_english) ):
+						output_line += u'\\lr{'
+					if ( line_direction_rtl and is_verb):
+						output_line += u'\\LR{'
+				
+				# here is the main place that converting happens
+				output_line += next_part.encode( 'utf-8' )
+				
+				if (global_state == 0):
+					# check whether we already used a \lr command: then end it
+					if ( line_direction_rtl and not (is_command_rtl or is_parameter_rtl or is_math_rtl or is_commands_group or is_documentstyle_cmd or is_verb_parameter or is_verb or is_english) ):
+						output_line += u'}'
+					if ( line_direction_rtl and is_verb):
+						output_line += u'}'
+			else:
+				if (global_state == 0):
+					# whether we should put a \rl{} command
+					if ( not line_direction_rtl and not ft_is_all_persian_space(next_part)):
+						output_line += u'\\rl{'
+					
+				# here is the main place that converting happens
+				output_line += map_ft_unicode(next_part)
+				
+				if (global_state == 0):
+					# check whether we already used a \rl command: then end it
+					if (not line_direction_rtl and not ft_is_all_persian_space(next_part)):
+						output_line += u'}'
+					
+			i = next_part_index
+		# end of while			
+
+		#if there was a % commenting then we can return to normal situation
+		if (global_state == 1):
+			global_state = 0
+		
+		# convert some of the FarsiTeX commands to XePersian commands
+		# only if it is requested
+		if (convert_cmds):
+			result = translate_cmds(output_line) 
+		else:
+			result = output_line
+		output_line = result + u'\n'
+		# write the processed line
+		of.write(output_line)
+		# end of line processing
+	# end of file processing
+
+def print_usage():
+	print 'usage: python ftxe-0-11 [-r] [-s] [-x] [-u] in_filename1 in_filename2'
+	print '-r: (DEFAULT) recursively consider files included in the given files'
+	print '-s: do not recursively consider files'
+	print '-x: (DEFAULT) insert xepersian related commands'
+	print '-u: only convert to unicode'
+
+###################################
+# Begin of main body of the program
+###################################
+
+# global variables
+line_number = 0
+last_epsfxsize = u''
+last_epsfxsize_line = 0
+last_epsfysize = u''
+last_epsfysize_line = 0
+state = 0
+global_state = 0
+recursive = 1
+convert_xepersian = 1
+filename = ''
+
+if len(sys.argv) <= 1:
+	print_usage()
+	exit(0)
+
+#find options
+options_index = 1
+while (options_index < len(sys.argv) and sys.argv[options_index][0]=='-'):
+	if (sys.argv[options_index]=='-s'):
+		recursive = 0
+	elif (sys.argv[options_index]=='-u'):
+		convert_xepersian = 0
+	options_index += 1
+
+filenames = []
+while (options_index < len(sys.argv)):
+	filenames.append(sys.argv[options_index])
+	options_index += 1
+
+if (len(filenames) == 0):
+	print 'error: no input filename is specified!'
+	print_usage()
+	exit(0)
+	
+index = 0
+while (index < len(filenames)):
+	filename = filenames[index]
+	index += 1
+
+	outfile = ''
+	if (filename[-4:] != '.tex'):
+		outfile = filename[0:-3] + 'tex'
+	else: 
+		outfile = filename + '.tex'
+
+	print '\n\nConverting "' + filename + '" into "' + outfile + '"'
+	try:
+		f = open(filename, 'r')
+	except IOError:
+		print "Can not open the input file: " + filename
+		exit(0)
+
+	try:
+		of = codecs.open(outfile, encoding='utf-8', mode='w')
+	except IOError:
+		print "Can not open the output file: " + outfile
+		exit(0)
+
+	convert_file(f, of, convert_xepersian)
+
+	of.close()
+	f.close()	



From vafa at mail.berlios.de  Tue Jul 14 02:41:41 2009
From: vafa at mail.berlios.de (vafa at mail.berlios.de)
Date: Tue, 14 Jul 2009 02:41:41 +0200
Subject: [Xepersian-development] r86 - trunk
Message-ID: <200907140041.n6E0ffnw027074@sheep.berlios.de>

Author: vafa
Date: 2009-07-14 02:41:28 +0200 (Tue, 14 Jul 2009)
New Revision: 86

Modified:
   trunk/xepersian.dtx
Log:
fixing abstract environment bug in xepersian-thesis.cls

Modified: trunk/xepersian.dtx
===================================================================
--- trunk/xepersian.dtx	2009-07-08 23:55:21 UTC (rev 85)
+++ trunk/xepersian.dtx	2009-07-14 00:41:28 UTC (rev 86)
@@ -163,7 +163,7 @@
 %    \begin{macrocode}
 \NeedsTeXFormat{LaTeX2e}
 \def\xepersianversion{v1.0.1}
-\def\xepersianrevision{revision 84}
+\def\xepersianrevision{revision 86}
 \def\xepersiandate{2009/07/15}
 \ProvidesPackage{xepersian}[\xepersiandate\space \xepersianversion\space <\xepersianrevision>
 	Persian typesetting in XeLaTeX]
@@ -3303,12 +3303,10 @@
 
 \def\signature#1#2{\par\noindent#1\dotfill\null\\*
   {\raggedright #2\par}}
-\def\abstract{\subsection*{\abstractname}\small\def\baselinestretch{1}
-\@normalsize}
-\def\endabstract{\par}
 
 
 
+
 \pagenumbering{harfi}
 \let\ol at chapter\@chapter
 \def\@chapter{%



From vafa at mail.berlios.de  Tue Jul 14 03:11:08 2009
From: vafa at mail.berlios.de (vafa at mail.berlios.de)
Date: Tue, 14 Jul 2009 03:11:08 +0200
Subject: [Xepersian-development] r87 - trunk
Message-ID: <200907140111.n6E1B8ZP031000@sheep.berlios.de>

Author: vafa
Date: 2009-07-14 03:11:03 +0200 (Tue, 14 Jul 2009)
New Revision: 87

Modified:
   trunk/xepersian.dtx
Log:
fixing the abstract environment bug in xepersian-thesis.cls

Modified: trunk/xepersian.dtx
===================================================================
--- trunk/xepersian.dtx	2009-07-14 00:41:28 UTC (rev 86)
+++ trunk/xepersian.dtx	2009-07-14 01:11:03 UTC (rev 87)
@@ -163,7 +163,7 @@
 %    \begin{macrocode}
 \NeedsTeXFormat{LaTeX2e}
 \def\xepersianversion{v1.0.1}
-\def\xepersianrevision{revision 86}
+\def\xepersianrevision{revision 87}
 \def\xepersiandate{2009/07/15}
 \ProvidesPackage{xepersian}[\xepersiandate\space \xepersianversion\space <\xepersianrevision>
 	Persian typesetting in XeLaTeX]
@@ -3304,9 +3304,10 @@
 \def\signature#1#2{\par\noindent#1\dotfill\null\\*
   {\raggedright #2\par}}
 
+\def\abstract{\subsection*{\abstractname}\small
+\@normalsize}
+\def\endabstract{\par}
 
-
-
 \pagenumbering{harfi}
 \let\ol at chapter\@chapter
 \def\@chapter{%



From vafa at mail.berlios.de  Tue Jul 14 11:49:27 2009
From: vafa at mail.berlios.de (vafa at mail.berlios.de)
Date: Tue, 14 Jul 2009 11:49:27 +0200
Subject: [Xepersian-development] r88 - trunk
Message-ID: <200907140949.n6E9nRaw000900@sheep.berlios.de>

Author: vafa
Date: 2009-07-14 11:48:53 +0200 (Tue, 14 Jul 2009)
New Revision: 88

Modified:
   trunk/xepersian.dtx
Log:
final

Modified: trunk/xepersian.dtx
===================================================================
--- trunk/xepersian.dtx	2009-07-14 01:11:03 UTC (rev 87)
+++ trunk/xepersian.dtx	2009-07-14 09:48:53 UTC (rev 88)
@@ -151,7 +151,6 @@
 %\author{Vafa Khalighi\\
 %\footnotesize\texttt{<vafa at users.berlios.de>}}
 %
-% \maketitle
 % \StopEventually{}
 % \section{Implementation}
 % \part{xepersian.sty}
@@ -163,7 +162,7 @@
 %    \begin{macrocode}
 \NeedsTeXFormat{LaTeX2e}
 \def\xepersianversion{v1.0.1}
-\def\xepersianrevision{revision 87}
+\def\xepersianrevision{revision 88}
 \def\xepersiandate{2009/07/15}
 \ProvidesPackage{xepersian}[\xepersiandate\space \xepersianversion\space <\xepersianrevision>
 	Persian typesetting in XeLaTeX]



From vafa at mail.berlios.de  Thu Jul 16 15:10:15 2009
From: vafa at mail.berlios.de (vafa at mail.berlios.de)
Date: Thu, 16 Jul 2009 15:10:15 +0200
Subject: [Xepersian-development] r89 - trunk
Message-ID: <200907161310.n6GDAFCD015310@sheep.berlios.de>

Author: vafa
Date: 2009-07-16 15:10:10 +0200 (Thu, 16 Jul 2009)
New Revision: 89

Modified:
   trunk/xepersian.dtx
Log:
fixed the latinfont bug due to Mehdi Omidali

Modified: trunk/xepersian.dtx
===================================================================
--- trunk/xepersian.dtx	2009-07-14 09:48:53 UTC (rev 88)
+++ trunk/xepersian.dtx	2009-07-16 13:10:10 UTC (rev 89)
@@ -5,7 +5,7 @@
 %<*readme>
 _________________
 The XePersian package
-v1.0.1
+v1.0.2
 
 XePersian is a package written for XeLaTeX that allows users to typeset
 Persian easily. The current version is 1.0.1 and it will be developed to
@@ -161,8 +161,8 @@
 %
 %    \begin{macrocode}
 \NeedsTeXFormat{LaTeX2e}
-\def\xepersianversion{v1.0.1}
-\def\xepersianrevision{revision 88}
+\def\xepersianversion{v1.0.2}
+\def\xepersianrevision{revision 89}
 \def\xepersiandate{2009/07/15}
 \ProvidesPackage{xepersian}[\xepersiandate\space \xepersianversion\space <\xepersianrevision>
 	Persian typesetting in XeLaTeX]
@@ -289,12 +289,12 @@
   \normalfont}
 \def\lr#1{\begingroup\beginL\latinfont#1\endL\endgroup}
 \def\rl#1{\begingroup\beginR\persianfont#1\endR\endgroup}
-\def\latin{\bgroup\LatinAlphs\par\@RTLfalse\@RTL at footnotefalse\latinfont}
+\def\latin{\bgroup\LatinAlphs\par\@RTLfalse\@RTL at footnotefalse\let\normalfont\latinfont}
 \def\endlatin{\par\egroup}
-\def\persian{\bgroup\PersianAlphs\par\@RTLtrue\@RTL at footnotetrue\persianfont}
+\def\persian{\bgroup\PersianAlphs\par\@RTLtrue\@RTL at footnotetrue\let\normalfont\persianfont}
 \def\endpersian{\par\egroup}
-\def\Latin{\if at RTL\par\LatinAlphs\@RTLfalse\@RTL at footnotefalse\latinfont\fi}
-\def\Persian{\if at RTL\relax\else\par\PersianAlphs\@RTLtrue\@RTL at footnotetrue\persianfont\fi}
+\def\Latin{\if at RTL\par\LatinAlphs\@RTLfalse\@RTL at footnotefalse\let\normalfont\latinfont\fi}
+\def\Persian{\if at RTL\relax\else\par\PersianAlphs\@RTLtrue\@RTL at footnotetrue\let\normalfont\persianfont\fi}
 \let\originaltoday=\today
 \def\today{\lr{\originaltoday}}
 \let\latintoday\today
@@ -490,9 +490,9 @@
 % \part{bidibeamer-xepersian.def}
 %    \begin{macrocode}
 \def\familydefault{\rmdefault}
-\def\latin{\bgroup\LatinAlphs\par\raggedright\@RTLfalse\@RTL at footnotefalse\latinfont}
+\def\latin{\bgroup\LatinAlphs\par\raggedright\@RTLfalse\@RTL at footnotefalse\let\normalfont\latinfont}
 \def\endlatin{\par\egroup}
-\def\persian{\bgroup\PersianAlphs\par\raggedleft\@RTLtrue\@RTL at footnotetrue\persianfont}
+\def\persian{\bgroup\PersianAlphs\par\raggedleft\@RTLtrue\@RTL at footnotetrue\let\normalfont\persianfont}
 \def\endpersian{\par\egroup}
 \def\biditheoremname{????}
 \def\bidicorollaryname{?????}



From vafa at mail.berlios.de  Fri Jul 17 04:54:07 2009
From: vafa at mail.berlios.de (vafa at mail.berlios.de)
Date: Fri, 17 Jul 2009 04:54:07 +0200
Subject: [Xepersian-development] r90 - trunk
Message-ID: <200907170254.n6H2s72s000985@sheep.berlios.de>

Author: vafa
Date: 2009-07-17 04:54:02 +0200 (Fri, 17 Jul 2009)
New Revision: 90

Modified:
   trunk/xepersian.dtx
Log:
fixed the latinfont issue

Modified: trunk/xepersian.dtx
===================================================================
--- trunk/xepersian.dtx	2009-07-16 13:10:10 UTC (rev 89)
+++ trunk/xepersian.dtx	2009-07-17 02:54:02 UTC (rev 90)
@@ -162,7 +162,7 @@
 %    \begin{macrocode}
 \NeedsTeXFormat{LaTeX2e}
 \def\xepersianversion{v1.0.2}
-\def\xepersianrevision{revision 89}
+\def\xepersianrevision{revision 90}
 \def\xepersiandate{2009/07/15}
 \ProvidesPackage{xepersian}[\xepersiandate\space \xepersianversion\space <\xepersianrevision>
 	Persian typesetting in XeLaTeX]
@@ -289,12 +289,12 @@
   \normalfont}
 \def\lr#1{\begingroup\beginL\latinfont#1\endL\endgroup}
 \def\rl#1{\begingroup\beginR\persianfont#1\endR\endgroup}
-\def\latin{\bgroup\LatinAlphs\par\@RTLfalse\@RTL at footnotefalse\let\normalfont\latinfont}
+\def\latin{\bgroup\LatinAlphs\par\@RTLfalse\@RTL at footnotefalse\let\normalfont\latinfont\latinfont}
 \def\endlatin{\par\egroup}
-\def\persian{\bgroup\PersianAlphs\par\@RTLtrue\@RTL at footnotetrue\let\normalfont\persianfont}
+\def\persian{\bgroup\PersianAlphs\par\@RTLtrue\@RTL at footnotetrue\let\normalfont\persianfont\persianfont}
 \def\endpersian{\par\egroup}
-\def\Latin{\if at RTL\par\LatinAlphs\@RTLfalse\@RTL at footnotefalse\let\normalfont\latinfont\fi}
-\def\Persian{\if at RTL\relax\else\par\PersianAlphs\@RTLtrue\@RTL at footnotetrue\let\normalfont\persianfont\fi}
+\def\Latin{\if at RTL\par\LatinAlphs\@RTLfalse\@RTL at footnotefalse\let\normalfont\latinfont\latinfont\fi}
+\def\Persian{\if at RTL\relax\else\par\PersianAlphs\@RTLtrue\@RTL at footnotetrue\let\normalfont\persianfont\persianfont\fi}
 \let\originaltoday=\today
 \def\today{\lr{\originaltoday}}
 \let\latintoday\today
@@ -490,9 +490,9 @@
 % \part{bidibeamer-xepersian.def}
 %    \begin{macrocode}
 \def\familydefault{\rmdefault}
-\def\latin{\bgroup\LatinAlphs\par\raggedright\@RTLfalse\@RTL at footnotefalse\let\normalfont\latinfont}
+\def\latin{\bgroup\LatinAlphs\par\raggedright\@RTLfalse\@RTL at footnotefalse\let\normalfont\latinfont\latinfont}
 \def\endlatin{\par\egroup}
-\def\persian{\bgroup\PersianAlphs\par\raggedleft\@RTLtrue\@RTL at footnotetrue\let\normalfont\persianfont}
+\def\persian{\bgroup\PersianAlphs\par\raggedleft\@RTLtrue\@RTL at footnotetrue\let\normalfont\persianfont\persianfont}
 \def\endpersian{\par\egroup}
 \def\biditheoremname{????}
 \def\bidicorollaryname{?????}



From vafa at mail.berlios.de  Mon Jul 20 11:39:09 2009
From: vafa at mail.berlios.de (vafa at mail.berlios.de)
Date: Mon, 20 Jul 2009 11:39:09 +0200
Subject: [Xepersian-development] r91 - tags
Message-ID: <200907200939.n6K9d95I013353@sheep.berlios.de>

Author: vafa
Date: 2009-07-20 11:39:04 +0200 (Mon, 20 Jul 2009)
New Revision: 91

Removed:
   tags/texmf-TDS.zip
Log:
cleaning up

Deleted: tags/texmf-TDS.zip
===================================================================
(Binary files differ)



From vafa at mail.berlios.de  Wed Jul 29 06:12:03 2009
From: vafa at mail.berlios.de (vafa at mail.berlios.de)
Date: Wed, 29 Jul 2009 06:12:03 +0200
Subject: [Xepersian-development] r92 - trunk
Message-ID: <200907290412.n6T4C3Tq029288@sheep.berlios.de>

Author: vafa
Date: 2009-07-29 06:11:58 +0200 (Wed, 29 Jul 2009)
New Revision: 92

Modified:
   trunk/xepersian.dtx
Log:
changed bidimemoir-xepersian.def to memoir-xepersian.def due to new chnages in the bidi package

Modified: trunk/xepersian.dtx
===================================================================
--- trunk/xepersian.dtx	2009-07-20 09:39:04 UTC (rev 91)
+++ trunk/xepersian.dtx	2009-07-29 04:11:58 UTC (rev 92)
@@ -5,7 +5,7 @@
 %<*readme>
 _________________
 The XePersian package
-v1.0.2
+v1.0.3
 
 XePersian is a package written for XeLaTeX that allows users to typeset
 Persian easily. The current version is 1.0.1 and it will be developed to
@@ -85,7 +85,7 @@
 \generate{\file{extbook-xepersian.def}{\from{xepersian.dtx}{extbook-xepersian.def}}}
 \generate{\file{kashida-xepersian.def}{\from{xepersian.dtx}{kashida-xepersian.def}}}
 \generate{\file{listings-xepersian.def}{\from{xepersian.dtx}{listings-xepersian.def}}}
-\generate{\file{bidimemoir-xepersian.def}{\from{xepersian.dtx}{bidimemoir-xepersian.def}}}
+\generate{\file{memoir-xepersian.def}{\from{xepersian.dtx}{memoir-xepersian.def}}}
 \generate{\file{minitoc-xepersian.def}{\from{xepersian.dtx}{minitoc-xepersian.def}}}
 \generate{\file{misccommandsenvironments-ltx.def}{\from{xepersian.dtx}{misccommandsenvironments-ltx.def}}}
 \generate{\file{refrep-xepersian.def}{\from{xepersian.dtx}{refrep-xepersian.def}}}
@@ -161,9 +161,9 @@
 %
 %    \begin{macrocode}
 \NeedsTeXFormat{LaTeX2e}
-\def\xepersianversion{v1.0.2}
-\def\xepersianrevision{revision 90}
-\def\xepersiandate{2009/07/15}
+\def\xepersianversion{v1.0.3}
+\def\xepersianrevision{revision 92}
+\def\xepersiandate{2009/08/09}
 \ProvidesPackage{xepersian}[\xepersiandate\space \xepersianversion\space <\xepersianrevision>
 	Persian typesetting in XeLaTeX]
 \DeclareOption{Kashida}{\input{kashida-xepersian.def}}
@@ -414,7 +414,7 @@
 \@ifclassloaded{book}{\input{book-xepersian.def}}{}
 \@ifclassloaded{refrep}{\input{refrep-xepersian.def}}{}
 \@ifclassloaded{bidibeamer}{\input{bidibeamer-xepersian.def}}{}
-\@ifclassloaded{bidimemoir}{\input{bidimemoir-xepersian.def}}{}
+\@ifclassloaded{memoir}{\input{memoir-xepersian.def}}{}
 %    \end{macrocode}
 % \iffalse
 %</xepersian.sty>
@@ -1699,9 +1699,9 @@
 %    \end{macrocode}
 % \iffalse
 %</listings-xepersian.def>
-%<*bidimemoir-xepersian.def>
+%<*memoir-xepersian.def>
 % \fi
-% \part{bidimemoir-xepersian.def}
+% \part{memoir-xepersian.def}
 %    \begin{macrocode}
 \renewcommand{\@memfront}{%
   \@smemfront\pagenumbering{harfi}}
@@ -1716,7 +1716,7 @@
   \anappendixtrue}
 %    \end{macrocode}
 % \iffalse
-%</bidimemoir-xepersian.def>
+%</memoir-xepersian.def>
 %<*misccommandsenvironments-ltx.def>
 % \fi
 % \part{misccommandsenvironments-ltx.def}



From vafa at mail.berlios.de  Wed Jul 29 14:57:32 2009
From: vafa at mail.berlios.de (vafa at mail.berlios.de)
Date: Wed, 29 Jul 2009 14:57:32 +0200
Subject: [Xepersian-development] r93 - trunk
Message-ID: <200907291257.n6TCvW1x019525@sheep.berlios.de>

Author: vafa
Date: 2009-07-29 14:57:27 +0200 (Wed, 29 Jul 2009)
New Revision: 93

Modified:
   trunk/xepersian.dtx
Log:
fixing tocloft loading

Modified: trunk/xepersian.dtx
===================================================================
--- trunk/xepersian.dtx	2009-07-29 04:11:58 UTC (rev 92)
+++ trunk/xepersian.dtx	2009-07-29 12:57:27 UTC (rev 93)
@@ -162,7 +162,7 @@
 %    \begin{macrocode}
 \NeedsTeXFormat{LaTeX2e}
 \def\xepersianversion{v1.0.3}
-\def\xepersianrevision{revision 92}
+\def\xepersianrevision{revision 93}
 \def\xepersiandate{2009/08/09}
 \ProvidesPackage{xepersian}[\xepersiandate\space \xepersianversion\space <\xepersianrevision>
 	Persian typesetting in XeLaTeX]
@@ -398,7 +398,7 @@
 \@ifpackageloaded{bidi}{\input{footnote-bidi-xepersian.def}}{}
 \@ifpackageloaded{enumerate}{\input{enumerate-xepersian.def}}{}
 \@ifpackageloaded{minitoc}{\input{minitoc-xepersian.def}}{}
-\@ifpackageloaded{tocloft}{\input{tocloft-xepersian.def}}{}
+\@ifpackageloaded{tocloft}{\@ifclassloaded{memoir}{}{\input{tocloft-xepersian.def}}}{}
 \@ifclassloaded{article}{\input{article-xepersian.def}}{}
 \@ifclassloaded{amsart}{\input{amsart-xepersian.def}}{}
 \@ifclassloaded{bidimoderncv}{\input{bidimoderncv-xepersian.def}}{}



From vafa at mail.berlios.de  Fri Jul 31 17:41:53 2009
From: vafa at mail.berlios.de (vafa at mail.berlios.de)
Date: Fri, 31 Jul 2009 17:41:53 +0200
Subject: [Xepersian-development] r94 - trunk
Message-ID: <200907311541.n6VFfrWf011475@sheep.berlios.de>

Author: vafa
Date: 2009-07-31 17:41:02 +0200 (Fri, 31 Jul 2009)
New Revision: 94

Modified:
   trunk/xepersian.dtx
Log:
fixed the typo in the current version number in README file

Modified: trunk/xepersian.dtx
===================================================================
--- trunk/xepersian.dtx	2009-07-29 12:57:27 UTC (rev 93)
+++ trunk/xepersian.dtx	2009-07-31 15:41:02 UTC (rev 94)
@@ -8,7 +8,7 @@
 v1.0.3
 
 XePersian is a package written for XeLaTeX that allows users to typeset
-Persian easily. The current version is 1.0.1 and it will be developed to
+Persian easily. The current version is 1.0.3 and it will be developed to
  meet the needs of Persian typesetting properly.
 
 The XePersian package is independent of any operating system, meaning it 
@@ -162,7 +162,7 @@
 %    \begin{macrocode}
 \NeedsTeXFormat{LaTeX2e}
 \def\xepersianversion{v1.0.3}
-\def\xepersianrevision{revision 93}
+\def\xepersianrevision{revision 94}
 \def\xepersiandate{2009/08/09}
 \ProvidesPackage{xepersian}[\xepersiandate\space \xepersianversion\space <\xepersianrevision>
 	Persian typesetting in XeLaTeX]



